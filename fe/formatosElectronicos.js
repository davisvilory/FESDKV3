(function ($) {
    "use strict";
    var defaultOptions = {
        version: "V3.1.7",
        versionnum: 3001007,
        id: "formElec_",
        jobj: {},
        rules: {},
        editor: "",
        plantilla: "",
        tabberpage: "",
        left: "",
        property: "",
        preview: "",
        modalEventEditor: "",
        modalParameterEditor: "",
        drawEditor: true,
        drawPreviewer: false,
        wizardtopublish: "",
        datatags: {
            elementAtt: [],
            elementEven: [],
            metadatos: [],
            catalogos: [],
            pdfFields: [],
            fieldsbypdf: {},
            tipodochijos: [],
            metadatoshijos: [],
            allitemscatalogs: {},
            plantillas: [],
            tareas: [],
            elementosPlantillas: {},
            componentsList: [],
            servicesList: []
        },
        datasend: {
            xml: "",
            guid: "",
            idPlantilla: 0,
            docId: 0,
            userName: "",
            tareatransito: "",
            urlref: "",
            tipoguardado: "publicacion",
            piidtarea: "",
            accion: 0,
            isUpdatepdf: !1,
            guidpdf: "",
            withdata: !1,
            urlGlobal: ""
        },
        infodataisact: false,
        infodata: {},
        queryModel: false,
        pageshowed: "",
        preGuardar: null,
        urlprefillpostguardar: {},
        postGuardar: function (result, datasend, idwizard, o) {
            if (result === !0 || result.Success || _.includes(["nada", "modoboton"], result)) {
                var urlref = DecriptURL(datasend.urlref), redirect = !0;
                urlref.toLowerCase().indexOf("wfrm_visor") !== -1 && (urlref = urlref.replace(/[Dd]oc[Ii]d=(\w)+&/, "DocId=" + o.datasend.docId + "&"));
                urlref = EncriptaUrl(urlref);
                if (idwizard === "") Exito(result.Titulo, result.Mensaje, urlref);
                else {
                    if (o.urlprefillpostguardar[idwizard]) {
                        var exefunc = o.urlprefillpostguardar[idwizard].func;
                        redirect = !o.urlprefillpostguardar[idwizard].avoidredirect;
                        delete o.urlprefillpostguardar[idwizard], exefunc();
                    }
                    redirect && result !== "modoboton" && (o.appvm[idwizard].autoredireccionar() || result === "nada" ? (!!result.Mensaje && Aviso(result.Titulo, result.Mensaje, "exito"),
                        urlref && urlref !== "" && (window.location = urlref)) : !!result.Mensaje && Exito(result.Titulo, result.Mensaje, urlref));
                }
            }
            else Error(result.Titulo, result.Mensaje);
        },
        savingInterval: null,
        closeMethod: null,
        deleteMethod: function (o) {
            Confirmacion("&iquest;Desea borrar la plantilla completa&quest; Recuerda que puedes exportar la plantilla ó descargar el XML para tener un respaldo.", function () {
                $.ajax({
                    url: 'FEConfigurador.aspx/EliminaPlantilla',
                    data: JSON.stringify(o.datasend),
                    success: function (j) {
                        j = j.d;
                        if (j.Success) Exito("Eliminado exitoso", "Se eliminó la plantilla.", o.datasend.urlref);
                        else Error(j.Titulo, j.Mensaje);
                    }
                });
            });
        },
        stylesadded: false,
        autosave: false,
        autosavetime: 5, //minutes
        timeoutAutosave: null,
        xtraModules: [], //modulos para jquery form validator
        childrenToLoad: [],
        elementsPlantillaToLoad: [],
        comboDataDynamic: {},
        codeqrexe: {},
        currentoperations: {},
        methodType: { drawHtml: 3, getParent: 4 },
        methodEventType: { drawHtmlEventEditor: 1, replaceContentWithFunctionality: 2, addActionElement: 3 },
        loading: '<div class="modal-backdrop in text-center" hidden id="loadingfe" style="z-index: 1160;">\
            <i class="fas fa-cog fa-spin fa-5x" style="color: rgb(221, 221, 221);"></i><br/>\
            <span id="spanloadingfe" style="font-size: 1.8rem; color: #fff;">Cargando, por favor, espere...</span>\
        </div>',
        plantillaAjax: { url: "", data: "" },
        appvm: null,
        loadeasyui: true,
        allloaded: false,
        uploadingAttachments: {},
        allattachmentsuploaded: "",
        jsonoptions: {
            attributeNamePrefix: "@",
            ignoreAttributes: false,
            ignoreNameSpace: true,
            parseNodeValue: true,
            parseAttributeValue: true,
            trimValues: true,
            parseTrueNumberOnly: true
        },
        xmloptions: {
            attributeNamePrefix: "@",
            attrNodeName: false,
            textNodeName: "#text",
            ignoreAttributes: false,
            cdataPositionChar: "\\c",
            format: false,
            indentBy: "  ",
            supressEmptyNode: false
        },
        iswebapp: !/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
        logger: "",
        mensajeGuardaPlantilla: "",
        sessionguid: "",
        coordenadas: { lat: "", lon: "", get: false },
        templateLabelTitulo: `<label class="no-margin py-1" data-bind="{
            html: $root[p().id()].titulo,
            style: { 
                textDecoration: $root[p().id()].decoraciontexto, 
                'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
            },
            attr: {
                hidden : $root[p().id()].ocultartitulo()
            },
            css: {
                errorMessage: $root[p().id()].haserror
            }
        }"></label>`,
        templateLabelSubtitulo: `<label style="display:block;" data-bind="{
            text: $root[p().id()].subtitulo,
            attr: {
                hidden : $root[p().id()].ocultarsubtitulo()
            },
            style: {
                textAlign: $root[p().id()].alineadotexto, 
                'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
            }
        }" ></label>`,
        templateAsterisk: `<label data-bind="{
            visible: $root[p().id()].requerido, 
            style: {
                'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
            }
        }" class="fas fa-asterisk float-left pt-1 pr-1"></label>`,
        templateErrorValidation: `<a style="cursor:pointer;font-size:1em" data-bind="{
            attr: {
                id: p().id() + '_errormessage', 
                hidden: $root[p().id()].validationerror().length <= 0
            },
            style: {
                'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
            }
        }" tabindex="0" class="fas fa-exclamation-triangle float-left pr-1 pt-1 color-fa-elements-error"></a>`,
        templateMascara: `<div class="text-muted pl-1" data-bind="{
            text: $root[p().id()].valor(),
            attr: {
                hidden: $root[p().id()].esqueletoformato ? !$root[p().id()].esqueletoformato().trim() : true
            }
        }"></div>`,
        ignmap: { 'ignore': ["__ko_mapping_v_"] },
        flexibleelement: ["codigobarras", "fecha", "hora", "lista", "logico", "rangofechas", "moneda", "numero", "texto", "textarea", "codigoqr", "comboboxtemporal", "leyenda", "deslizante", "combodinamico", "georeferencia"],
        errortable: [],
        servResponseBase: {
            "success": false, "error": "", "servicesuccess": false, "servicemessage": "", "showmessage": true, "messagetype": "notif",
            "rulesuccess": {}, "ruleerror": {}, "waittofinish": 500, "evaluaterules": !1, "zexecutekey": 0, "zexecutetimenumber": 0, "zexecutetimetype": "min"
        },
        TE: {
            Plantilla: "plantilla", Pagina: "pagina", Audio: "audio", Boton: "boton", CodigoBarras: "codigobarras", Deslizante: "deslizante",
            Fecha: "fecha", Georeferencia: "georeferencia", Hora: "hora", HuellaDigital: "huelladigital", Imagen: "imagen",
            Leyenda: "leyenda", Lista: "lista", ComboBoxTemporal: "comboboxtemporal", Logico: "logico", Logo: "logo", Mapa: "mapa",
            Moneda: "moneda", Numero: "numero", Password: "password", RangoFechas: "rangofechas", Seccion: "seccion", Tabla: "tabla",
            Texto: "texto", TextArea: "textarea", Video: "video", Wizard: "wizard", Tabber: "tabber", NFC: "NFC",
            Documento: "documento", CodigoQR: "codigoqr", FirmaFAD: "firmafad", ComboDinamico: "combodinamico",
            MarcadoDocumentos: "marcadodocumentos", OCR: "ocr", PDFOCR: "pdfocr"
        },
        reservedwords: ["log", "entero", "promedio", "min", "max", "redondear", "ln", "root"],
        xml: "",
        evaAfterRender: [],
        dynamicComboIntervals: {},
        logtimeline: [],
        LogTy: {
            Add: "add", Remove: "remove"
        },
        macro: "",
        MacroTy: {
            Macro: 1, Paso: 2, Accion: 3, Rule: 4, RuleAccion: 5
        },
        MacroAcc: {
            forward: "Avanzar", backward: "Regresar", finish: "Terminar"
        },
        logMacroRegex: /\{\{(\w*):([\w/\-:.\u00C0-\u024F\s()¿?,=>]*)\}\}/g,
        veridasocr: {
            "Nombre": "PD_Name_Out",
            "Apellido Paterno": "PD_LastName1_Out",
            "Apellido Materno": "PD_LastName2_Out",
            "Calle": "PD_AddressStreet_Out",
            "Estado": "PD_AddressState_Out",
            "Municipio": "PD_AddressMunicipality_Out",
            "Localidad": "PD_AddressDistrict_Out",
            "Seccion": "OD_Section_Out",
            "Dia de Nacimiento": "PD_BirthDate_Out",
            "Sexo": "PD_Sex_Out",
            "Nacionalidad": "PD_Nationality_Out",
            "CURP": "OD_CURP_Out",
            "OCR": "OD_OCRNumber_Out",
            "Clave de Elector": "PD_IdentificationNumber_Out",
            "IDMEX": "DD_DocumentNumber_Out",
            "Vigencia": "DD_ExpirationDate_Out",
            "Año de Emisión": "DD_ExpeditionDate_Out",
            "Año de Registro": "OD_RegistrationDate_Out",
            "Mes de Registro": "OD_EmissionNumber_Out",
            "FUAR": "OD_FUAR_Out"
        },
        veridasscore: {
            "Score del documento": "ScoreDocumentTotal",
            "Score de la Selfie": "ScoreSelfie",
            "Score de la Fotografía del Documento": "ScorePhotoId",
            "Score de la Prueba de vida": "ScoreLifeProof",
            "Score del Video": "ScoreVideo",
            "Score Global": "ScoreValidationGlobal"
        },
        veridaspepaml: {
            "ValidasScoreHitPEPTest": "ValidasScoreHitPEPTest1",
            "ValidasScoreHitSanctionTest": "ValidasScoreHitSanctionTest1",
            "ValidasScoreHitAdverseMediaTest": "ValidasScoreHitAdverseMediaTest1",
            "Nombre de la persona": "matchName1"
        },
        extraGlobalAttr: ["elementrendered", "executeonce", "bindcondition", "campocss", "validationerror", "haserror"],
        extraAttr: {},
        FEReporteEstadistico: { FechaComienzo: "", FechaTermino: "", Plataforma: "Web", VersionPlantilla: "", FechaPlantilla: "", Estadisticas: [], Historia: [], Macro: { Nombre: "", Acciones: [] } },
        CategoriaReporteEstadistico: { Regla: "Regla", Componente: "Componente", Servicio: "Servicio", Operacion: "Operación" },
        AccionesMacro: {
            //Visible: {name: "isvisible", desc: "Verificar si es visible", content: "Visible"},
            //Invisible: {name: "isnotvisible", desc: "Verificar si no es visible", content: "No Visible"},
            //Habilitado: {name: "isenable", desc: "Verificar si esta habilitado", content: "Habilitado"},
            //Deshabilitado: {name: "isnotenable", desc: "Verificar si no esta habilitado", content: "Deshabilitado"},
            LimpiarCampo: { name: "clean", desc: "Limpiar campo", content: "Limpiar" },
            ClickPagina: { name: "clickp", desc: "Dar click a Página", content: "Click" },
            ClickBoton: { name: "clickb", desc: "Dar click a Botón", content: "Click" },
            ClickWizardAvanzar: { name: "clickwfor", desc: "Dar click a Wizard avanzar", content: "Avanzar" },
            ClickWizardRegresar: { name: "clickwback", desc: "Dar click a Wizard regresar", content: "Regresar" },
            ClickWizardFinalizar: { name: "clickwfin", desc: "Dar click a Wizard finalizar", content: "Finalizar" },
            LlenarTexto: { name: "fillt", desc: "Introducir texto", content: "" },
            LlenarTextoRandom: { name: "filltran", desc: "Llenado aleatorio", content: "Dato aleatorio" },
            LlenarLista: { name: "fillc", desc: "Seleccionar items en lista", content: "" },
            LlenarListaRandom: { name: "fillcran", desc: "Seleccionar items aleatoriamente", content: "Dato aleatorio" },
            LlenarNumero: { name: "filln", desc: "Introducir número", content: "" },
            LlenarNumeroRandom: { name: "fillnran", desc: "Llenado aleatorio", content: "Dato aleatorio" },
            LlenarMoneda: { name: "fillm", desc: "Introducir moneda", content: "" },
            LlenarMonedaRandom: { name: "fillmran", desc: "Llenado aleatorio", content: "Dato aleatorio" },
            LlenarHora: { name: "fillh", desc: "Introducir hora", content: "" },
            LlenarHoraRandom: { name: "fillhran", desc: "Llenado aleatorio", content: "Dato aleatorio" },
            LlenarFecha: { name: "fillf", desc: "Introducir fecha", content: "" },
            LlenarFechaRandom: { name: "fillfran", desc: "Llenado aleatorio", content: "Dato aleatorio" },
            LlenarLogicoMarcado: { name: "filllt", desc: "Marcar lógico", content: "Marcar" },
            LlenarLogicoDesmarcado: { name: "filllf", desc: "Desmarcar lógico", content: "Desmarcar" },
            LlenarLogicoRandom: { name: "filllran", desc: "Marcado aleatorio", content: "Dato aleatorio" }
        },
        prevToast: null,
        changeLogs: []
    }, contglobal = null, savingIntervalDetection = 0;

    $.fn.formatosElectronicos = function (action, obj, prop, data) {
        contglobal = $(this);
        var o1, init = (cont, xmlt) => {
            var o = getOpts();
            showHideLoading(o);
            if (_.isEmpty(o.datasend.urlGlobal)) //Se asigna la carpeta actual del navegador
                o.datasend.urlGlobal = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf("/") + 1);

            moment.locale("es-mx");
            loadInit(cont, xmlt, o);
        };
        if ($.type(action) === "string") {
            switch (action) {
                case "getXml":
                case "getFormato":
                    return getXml();
                case "getXml2":
                    $("#debughiddenxml").remove();
                    $(this).parent().append('<div class="col-sm-12 col-12" id="debughiddenxml"><textarea cols="5" rows="10" class="form-control">' + getXml() + '</textarea><input type="button" class="btn btn-danger" value="X" onclick="$(\'#debughiddenxml\').remove();" /></div>');
                    $("#debughiddenxml textarea").format({ method: "xml" });
                    break;
                case "update":
                    update();
                    break;
                case "preview":
                    previewAll();
                    break;
                case "options":
                    if (getOpts()) updateOpts(obj);
                    break;
                case "destroy":
                    var o = getOpts();
                    if (o.timeoutAutosave) clearInterval(o.timeoutAutosave);
                    ko.cleanNode(o.appvm), updateOpts(null, true), contglobal.contents().remove();
                    break;
                case "getbyid":
                    var elem1 = getOpts().appvm[obj];
                    return elem1;
                case "setprop":
                    var elem2 = getOpts().appvm[obj];
                    if (elem2)
                        elem2[prop.toLowerCase()](data);
                    break;
                case "getprop":
                    var elem3 = getOpts().appvm[obj];
                    if (elem3)
                        return elem3[prop.toLowerCase()]();
                    return null;
                case "opfe":
                    return getOpts();
                case "updatasend":
                    var o5 = getOpts();
                    o5.datasend = obj;
                    updateOpts(o5, true);
                    break;
                case "showjsonbyid":
                    var jsonelem = getOpts().appvm[obj];
                    Alerta(jsonelem.titulo(), "<textarea rows=\"20\" style=\"width: 100%; border: 0px;\">" + JSON.stringify(ko.mapping.toJS(jsonelem), null, '\t') + "</textarea>");
                    break;
                case "showversion":
                    var o6 = getOpts();
                    o6.appvm.formElec_element0.mostrarversion(!0);
                    break;
                case "saveformat":
                    autoSaveForm();
                    break;
                case "loadingelem":
                    showElementLoading(getOpts(), !0, obj[0], obj[1]);
                    break;
                case "watchelement":
                    var o7 = getOpts();
                    o7.appvm[obj].valor && o7.appvm[obj].valor.subscribe((nv) => {
                        globalThis.console.log(`Nuevo cambio del elemento ${o7.appvm[obj].titulo()}--${obj} al nuevo valor: ${nv}---- y valormetadato ${o7.appvm[obj].valormetadato()}`);
                    });
                    o7.appvm[obj].valormetadato && o7.appvm[obj].valormetadato.subscribe((nv) => {
                        globalThis.console.log(`Nuevo cambio del elemento ${o7.appvm[obj].titulo()}--${obj} al nuevo valormetadato: ${nv}---- y valor ${o7.appvm[obj].valor()}`);
                    });
                    o7.appvm[obj].valormetadato && o7.appvm[obj].habilitado.subscribe((nv) => {
                        globalThis.console.log(`Nuevo cambio del elemento ${o7.appvm[obj].titulo()}--${obj} al nuevo estado de habilitado en: ${nv}`);
                    });
                    break;
                case "deleteanexomanual":
                    customActionElement(obj, ["delete"]);
                    break;
            }
            return this;
        }
        else {
            o1 = $.isPlainObject(action) || !action ? $.extend(true, {}, defaultOptions, action) : $.extend({}, defaultOptions);
            updateOpts(o1), window.onerror = function (msg, url, lineNo, _columnNo, error) {
                error = error || {}, msg = "Linea-" + lineNo + "-" + (error.message || msg) + (url.indexOf("formatosElectronicos") !== -1 ? "-" + url : ""), console.error(msg);
                var e2 = { mes: error.message, line: error.lineNumber, stack: error.stack };
                console.log(e2);
            };
            $(document).on("mousemove keyup", function (e) { savingIntervalDetection += 1; });
            return this.each(function () { init(this, action.xml); });
        }



        //ViewModel
        //Aqui se encuentra todos los html's de los elementos y algunas funciones especiales usadas por KO
        function appViewModel() {
            var $scope = this;
            $scope.isEditor = ko.observable(o1.drawEditor);
            $scope.isQuery = ko.observable(o1.queryModel);
            $scope.modalIsShown = ko.observable(!1);
            $scope.elementsList = ko.observableArray();
            $scope.elementsGeo = ko.observableArray();
            $scope.maxNumberId = ko.observable(0);
            $scope.counterElement = ko.observable(0);
            $scope.elementCopied = ko.observableArray();
            $scope.eventCopied = ko.observableArray();
            $scope.idPlantilla = ko.observable("formElec_element0");
            $scope.listAnexos = ko.observableArray([]);
            var element = {};
            element[$scope.idPlantilla()] = {};//{ titulo: "titulo", subtitulo: "subtitulo", tamanofuente: 12, tipofuente: "Arial" };
            ko.mapping.fromJS(element, {}, $scope);

            //#region diseño del los atributos de los elementos
            {
                ko.components.register("atributo-archivo", {
                    viewModel: componentViewModel,
                    template: '<div class="h-100 border-right px-1 d-inline-flex flex-column justify-content-around" data-bind="atributoLoaded: 1">\
                    <div class="d-flex justify-content-center">\
                        <span class="btn btn-file bg-primary text-white mr-1">\
                            <i class="fas fa-search"></i> Subir\
                            <input type="file" accept="image/*" data-bind="event: { change: archivo }" />\
                        </span>\
                        <span class="btn btn-light border" data-bind="click: cleararchivo"><i class="far fa-trash-alt"></i> Quitar</span>\
                    </div>\
                    <div style="width:150px;" class="text-center text-muted pt-1 font-italic" data-bind="attr:{id: \'attrarchivotitulo\' + p().id()}"></div>\
                    <div class="text-center text-muted pt-1 border-top" data-bind="html: p().titulo, tituloAtributo: 1"></div>\
                </div>',
                    synchronous: !1
                });

                ko.components.register("atributo-botones", {
                    viewModel: componentViewModel,
                    template: '<div class="h-100 border-right px-1 d-inline-flex flex-column justify-content-around" data-bind="atributoLoaded: 1">\
                    <div class="btn-group p-1 pb-2" role="group">\
                        <!-- ko foreach: p().options() -->\
                            <button class="btn btn-light border btn-sm mr-1" data-bind="attr: { title: $data.Nombre }, css: $parent.p().val() == $data.Valor() ? \'btn-info\' : \'btn-light\', click: function() { $parent.p().val($data.Valor()) }">\
                                <i data-bind="css: $data.Icono"></i>\
                            </button>\
                        <!-- /ko -->\
                    </div>\
                    <div class="text-center text-muted pt-1 border-top" data-bind="html: p().titulo, tituloAtributo: 1"></div>\
                </div>',
                    synchronous: !1
                });

                ko.components.register("atributo-cascadahijo", {
                    viewModel: componentViewModel,
                    template: '<div class="px-2 pb-1 d-inline-flex flex-column" style="width:200px;" data-bind="atributoLoaded: 1">\
                    <div class="text-muted py-1" data-bind="html: p().titulo, tituloAtributo: 1"></div>\
                    <div class="combolists" data-bind="attr:{id: p().id() + \'cascadahijo\'}"></div>\
                    <div class="btn btn-light btn-sm border p-0 float-right" style="font-size: 0.8em" data-bind="click: function(){event(9, p().id()); }"><i class="fas fa-bezier-curve p-1"></i> Configuraci&oacute;n</div>\
                </div>',
                    synchronous: !1
                });

                ko.components.register("atributo-color", {
                    viewModel: componentViewModel,
                    template: '<div class="border-right px-2 pb-1 flex-column text-center" style="white-space: normal;" data-bind="atributoLoaded: 1">\
                    <input data-bind="value: p().val" class="text-center border" style="font-size:0.8rem; height:50px; width:50px; border-radius:50%; cursor:pointer;outline:none;">\
                    <div class="text-center text-muted pt-1" style="font-size:0.9rem;width:90px;" data-bind="html: p().titulo, tituloAtributo: 1"></div>\
                </div>',
                    synchronous: !1
                });

                ko.components.register("atributo-configjson", {
                    viewModel: componentViewModel,
                    template: '<div class="border-right px-2 pb-1 d-inline-flex flex-column text-center" style="width:80px; white-space: normal;" data-bind="atributoLoaded: 1">\
                    <div class="btn btn-light border text-black bg-white btn-sm" data-bind="attr:{title: p().titulo}, click: function() { event(5, p().id()); }">\
                        <i class="fas fa-stream align-middle"></i>\
                    </div>\
                    <div class="text-muted col-sm-12 p-0" data-bind="html: p().titulo, tituloAtributo: 1"></div>\
                </div>',
                    synchronous: !1
                });

                ko.components.register("atributo-filtrarcatalogo", {
                    viewModel: componentViewModel,
                    template: '<div class="px-2 pb-1" style="width:210px" data-bind="atributoLoaded: 1">\
                    <div class="text-muted py-1" data-bind="html: p().titulo, tituloAtributo: 1"></div>\
                    <div class="bodyattr d-flex pb-2">\
                        <i style="cursor:pointer;" class="far fa-square filtdata pt-1 pr-2"></i>\
                        <div class="easyui-combobox"></div>\
                    </div>\
                </div> ',
                    synchronous: !1
                });

                ko.components.register("atributo-importartemplatetabla", {
                    viewModel: componentViewModel,
                    template: '<div class="h-100 border-right px-1 d-inline-flex flex-column justify-content-around" data-bind="atributoLoaded: 1">\
                    <div class="text-center d-inline-flex">\
                        <span data-bind="attr: { hidden: $root[p().id()].nombretemplatecarga().length === 0 }">\
                            <span class= "btn btn-sm bg-orange fas fa-cog" data-bind="event: {click: function()  { event(7, p().id(), [\'openconfig\']); } }"></span>\
                            <span class= "btn bg-danger fas fa-times text-white btn-sm" data-bind="event: {click: function() { event(8, p().id()); } }" ></span>\
                            <span data-bind="text: $root[p().id()].nombretemplatecarga" class="d-inline-block font-italic"></span>\
                        </span>\
                        <span class="btn btn-file fas fa-search bg-primary text-white mr-1" data-bind="attr: { hidden: $root[p().id()].nombretemplatecarga().length > 0 }">\
                            Examinar <input id="atrimptable" type="file" accept=".csv" data-bind="event: { change: function(_it, ev) { event(7, p().id(), [\'config\', ev.target]) }}">\
                        </span>\
                    </div>\
                    <div class="text-center text-muted pt-1 border-top" data-bind="html: p().titulo, tituloAtributo: 1"></div>\
                </div>',
                    synchronous: !1
                });

                ko.components.register("atributo-importararchivoestilos", {
                    viewModel: componentViewModel,
                    template: `<div class="border-right px-1" data-bind="atributoLoaded: 1" style="width: 170px;">
                    <span class="btn btn-file bg-primary text-white mr-1">
                        <i class="fas fa-search"></i> Subir CSS
                        <input type="file" accept=".css" data-bind="event: { change: archivo }" />
                    </span>
                    <div class="text-center text-muted pt-1 border-top" data-bind="html: p().titulo, tituloAtributo: 1" style="white-space: normal"></div>
                </div>`,
                    synchronous: !1
                });

                ko.components.register("atributo-logico", {
                    viewModel: componentViewModel,
                    template: '<div class="border-right px-2 pb-1 d-inline-flex flex-column text-center" style="width:110px; white-space: normal;" data-bind="atributoLoaded: 1">\
                    <div class="col-sm-12 text-center p-0" style="margin-top: 10px; margin-bottom: 10px;">\
                        <input type="text" data-bind="value: p().val, attr: { id: p().tipo }">\
                    </div>\
                    <div class="text-muted col-sm-12 p-0" data-bind="html: p().titulo, tituloAtributo: 1"></div>\
                </div>',
                    synchronous: !1
                });

                ko.components.register("atributo-mappingelements", {
                    viewModel: componentViewModel,
                    template: `<div class="border-right px-2 pb-1 d-inline-flex flex-column text-center" style="width:80px; white-space: normal;">
                    <div class="btn btn-light border text-black bg-white btn-sm" data-bind="attr:{title: p().titulo}, click: function() { event(p().event(), p().id()); }">
                        <i class="far fa-address-card align-middle"></i>
                    </div>
                    <div class="text-muted col-sm-12 p-0" data-bind="html: p().titulo, tituloAtributo: 1"></div>
                </div>`,
                    synchronous: !1
                });

                ko.components.register("atributo-resumen", {
                    viewModel: componentViewModel,
                    template: '<div class="border-right d-inline-flex flex-column pr-2" style="width:220px;" data-bind="atributoLoaded: 1">\
                    <div class="text-muted py-1" data-bind="html: p().titulo, tituloAtributo: 1"></div>\
                    <div style="max-height:100px; overflow:auto;"><table data-bind="attr: { id: p().tipo() + p().id()}" style="word-break: break-all; white-space: normal;" class="dataresumen table table-sm table-hover no-margin table-striped border rounded"></table></div>\
                </div>',
                    synchronous: !1
                });

                ko.components.register("atributo-resumen2", {
                    viewModel: componentViewModel,
                    template: `<div class="border-right px-2 pb-1 d-inline-flex flex-column text-center" style="width:80px; white-space: normal;">
                    <div class="btn btn-light border text-black bg-white btn-sm" data-bind="attr:{title: p().titulo}, click: function() { event(4, p().id()); }">
                        <i class="far fa-address-card align-middle"></i>
                    </div>
                    <div class="text-muted col-sm-12 p-0" data-bind="html: p().titulo, tituloAtributo: 1"></div>
                </div>`,
                    synchronous: !1
                });

                ko.components.register("atributo-select", {
                    viewModel: componentViewModel,
                    template: '<div class="border-right px-2 pb-1 d-inline-flex flex-column text-center" data-bind="style:{ width: p().tipo() === \'tipificacionpermitida\' ? \'350px\' : \'200px\'},atributoLoaded: 1" style="white-space: normal;">\
                    <select data-bind="options: p().options, optionsText: \'Nombre\', optionsValue: \'Valor\', value: p().val, attr: { id: p().tipo }" class="form-control"></select>\
                    <div class="text-muted col-sm-12 p-0" data-bind="html: p().titulo, tituloAtributo: 1"></div>\
                </div>',
                    synchronous: !1
                });

                ko.components.register("atributo-textarea", {
                    viewModel: componentViewModel,
                    template: '<div class="border-right px-2 pb-1 d-inline-flex flex-column text-center" style="width:180px; white-space: normal;" data-bind="atributoLoaded: 1">\
                    <textarea style="min-height: 90px;" data-bind="value: p().val, attr: { id: p().tipo() + p().id() }" class="form-control"></textarea>\
                    <div class="text-muted py-1" data-bind="html: p().titulo, tituloAtributo: 1"></div>\
                </div>',
                    synchronous: !1
                });

                ko.components.register("atributo-texto", {
                    viewModel: componentViewModel,
                    template: '<div class="border-right px-2 pb-1 d-inline-flex flex-column text-center" style="width:180px; white-space: normal;" data-bind="atributoLoaded: 1">\
                    <input type="text" data-bind="value: p().val, attr: { id: p().tipo() + p().id() }" class="form-control">\
                    <div class="text-muted py-1" data-bind="html: p().titulo, tituloAtributo: 1"></div>\
                </div>',
                    synchronous: !1
                });

                ko.components.register("atributo-tipificacionunica", {
                    viewModel: componentViewModel,
                    template: '<div class="px-2 pb-1 d-inline-flex flex-column" style="width:150px; white-space: normal;" data-bind="atributoLoaded: 1">\
                    <div class="text-muted py-1" data-bind="html: p().titulo, tituloAtributo: 1"></div>\
                    <div class="col-sm-12 text-center p-0" style="margin-top: 10px; margin-bottom: 10px;">\
                        <div class="checkuni"></div>\
                    </div>\
                    <div class="pt-1 capdoc" hidden>\
                        <div class="seldoc"></div>\
                    </div>\
                </div>',
                    synchronous: !1
                });

                ko.components.register("atributo-wysiwyg", {
                    viewModel: componentViewModel,
                    template: '<div class="border-right px-2 pb-1 d-inline-flex flex-column text-center" style="width:70px; white-space: normal;" data-bind="atributoLoaded: \'wysiwyg\'">\
                    <div class="btn btn-light border text-black bg-white btn-sm" data-bind="attr:{title: p().titulo}, click: function() { event(3, p().id(), [p().tipo()]); }">\
                        <i class="fas fa-code align-middle"></i>\
                    </div>\
                    <div class="text-muted col-sm-12 p-0" data-bind="html: p().titulo, tituloAtributo: 1"></div>\
                </div>',
                    synchronous: !1
                });
            }

            //#region diseño del los elementos
            {
                ko.components.register("elemento-generico", {
                    viewModel: componentViewModel,
                    template: htmlElementoGenerico(),
                    synchronous: !0
                });

                ko.components.register("elemento-audio", {
                    viewModel: componentViewModel,
                    template: htmlElementoAudio(),
                    synchronous: !0
                });

                ko.components.register("elemento-boton", {
                    viewModel: componentViewModel,
                    template: `<div style="width:100%" data-bind="{
                        style: { 
                            textAlign: $root[p().id()].alineadotexto
                        },
                        elementoLoaded: 1
                    }"><br/>
                    <div data-bind="{
                            designbuttonall: { 
                                t: $root[p().id()].valor(), 
                                ty: $root[p().id()].tipo(), 
                                c: $root[p().id()].colortexto(), 
                                bg: $root[p().id()].colorfondo()
                            }
                        }">
                        <div class="btn" data-bind="{
                                style: { pointerEvents: !$root[p().id()].habilitado() || $root.isQuery() ? 'none' : 'auto' },
                                click: $root[p().id()].click,
                                css: [
                                    p().id(),
                                    $root[p().id()].tamaniocss(),
                                    $root.isQuery() || !$root[p().id()].habilitado() ? 'disabled' : '',
                                    $root[$root.idPlantilla()].permitirsombrabotones() ? 'hasshadow' : '',
                                    $root[p().id()].ancho() === 'completo' ? 'btn-block' : ''
                                ].join(' ')
                            }">
                            <span class="pretext" data-bind="style: { 'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem' }"></span>
                            <i data-bind="{
                                    style: { 'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem' }, 
                                    css: [$root[p().id()].iconoagregar()].join(' '), 
                                    attr: { hidden: !$root[p().id()].vericonoagregar() }
                                }"></i>
                            <span class="posttext" data-bind="{
                                    style: { 
                                        'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                                    }
                                }"></span>
                        </div>
                        <br />
                        <span class="externtext text-bold" data-bind="{
                                style: {
                                    'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                                }
                            }"></span>
                    </div>
                </div>`,
                    synchronous: !0
                });

                ko.components.register("elemento-codigoqr", {
                    viewModel: componentViewModel,
                    template: `<div data-bind="{
                        style: {
                            textAlign: $root[p().id()].alineadotexto,
                            fontStyle: $root[p().id()].estilotexto,
                            fontWeight: $root[p().id()].grosortexto
                        },
                        elementoLoaded: 1
                    }">${o1.templateErrorValidation}${o1.templateAsterisk}${o1.templateLabelTitulo}${o1.templateLabelSubtitulo}
                    <div data-bind="{
                            designbuttonall: { 
                                t: $root[p().id()].texto(),
                                ty: $root[p().id()].tipo(),
                                c: $root[p().id()].colortexto(),
                                bg: $root[p().id()].colorfondo()
                            },
                            attr: {
                                hidden: !_.isEmpty($root[p().id()].prellenadomapeocampos()) ? true : !$root[p().id()].permisoescaner() ? true : $root[p().id()].scanmode()
                            },
                            style: {
                                display : $root[p().id()].ancho() === 'completo' ? 'block' : 'inline-block'
                            }
                        }">
                        <div class="btn" data-bind="{
                                click: function() { clickcustom('qrscan') },
                                css: { 
                                    disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(),
                                    hasshadow: $root[$root.idPlantilla()].permitirsombrabotones(),
                                    'btn-block' : $root[p().id()].ancho() === 'completo'
                                }
                            }">
                            <span class="pretext" data-bind="{
                                    style: { 
                                        'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                                    }
                                }"></span>
                            <i data-bind="{
                                    style: { 
                                        'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                                    },
                                    css: [$root[p().id()].iconoagregar()].join(' '),
                                    attr: {
                                        hidden: !$root[p().id()].vericonoagregar()
                                    }
                                }"></i>
                            <span class="posttext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                        </div>
                        <br />
                        <span class="externtext text-bold" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                    </div>
                    <textarea rows="4" class="form-control mt-2" style="border-radius: 5px" data-bind="
                        style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\', \'font-family\': $root[$root.idPlantilla()].tipofuente() },
                        css: { 'hasError' : $root[p().id()].haserror() },
                        attr: { placeholder: $root[p().id()].mascara, type: typeinput(), autocomplete: typeinput(), maxlength: $root[p().id()].longitudmaxima, hidden: !_.isEmpty($root[p().id()].prellenadomapeocampos()) || $root[p().id()].permitirprellenadoexterno() ? true : $root[p().id()].scanmode() },
                        disable: $root.isEditor() || $root.isQuery() ? true : !$root[p().id()].habilitado(),
                        value: $root[p().id()].valor"></textarea>
                    <div class="p-2" data-bind="attr:{id: p().id()+ 'qrcodeelem', hidden:$root[p().id()].scanmode() ? true : $root[p().id()].valor && $root[p().id()].valor().length === 0}, qrcode: $root[p().id()].valor()"></div>
                    <div data-bind="attr: {hidden: !$root[p().id()].scanmode()}">
                        <div data-bind="attr:{hidden:!$root[p().id()].scanmode(), id: 'qrscancancel_' + p().id()}" class="btn fas fa-times float-right" style="background-color: #ee4e21; color: #ffffff">Cancelar</div>
                        <video data-bind="attr:{id: p().id() + 'qrcodescanner'}" controls playsinline class="inactive w-100" id="preview" style="filter: none; transform: scaleX(-1);" autoplay="autoplay"></video>
                    </div>
                </div>`,
                    synchronous: !0
                });

                ko.components.register("elemento-combodinamico", {
                    viewModel: componentViewModel,
                    template: `<div class="docelem" data-bind="{
                        style: {
                            textAlign: $root[p().id()].alineadotexto,
                            fontStyle: $root[p().id()].estilotexto,
                            fontWeight: $root[p().id()].grosortexto
                        },
                        elementoLoaded: 1
                    }">${o1.templateErrorValidation}${o1.templateAsterisk}${o1.templateLabelTitulo}${o1.templateLabelSubtitulo}
                    <label class="h6" data-bind="{
                        text: $root[p().id()].valor
                    }"></label>
                    <div data-bind="{
                            if: $root[p().id()].tipolista() === 'combo'
                        }">
                        <select class="form-control rounded docelem" data-bind="{
                            attr: {
                                id: 'dynamiccombo'+ p().id()
                            },
                            disable: $root.isEditor()
                        }">
                            <option disabled selected>Seleccione...</option>
                        </select>
                    </div>
                    <div data-bind="{
                        if: $root[p().id()].tipolista() !== 'combo'
                    }">
                        <!-- ko component: {
                            name: "elemento-combodinamico-" + $root[p().id()].tipolista(),
                            params: {
                                id: p().id(), tipo: p().tipo()
                            }
                        } --><!-- /ko -->
                    </div>
                </div>`,
                    synchronous: !0
                });

                ko.components.register("elemento-combodinamico-checkbox", {
                    viewModel: componentViewModel,
                    template: '<!-- ko foreach: $root[p().id()].catalogodestino() -->\
                    <div class="no-padding d-inline-block" data-bind="css: $root[$parent.p().id()].orientacion">\
                        <div data-bind="ifnot: $root[$parent.p().id()].checkencasilla()"><label class="m-0 font-weight-normal">\
                            <input class="mr-2" type="checkbox" data-bind="checked: $root[$parent.p().id()].chosenitems, checkedValue: $data, disable: $root.isEditor() || $root.isQuery() ? true : !$root[$parent.p().id()].habilitado(), attr: { name: \'checkbox\' + $parent.p().id() }" /><span data-bind="text: $data.Nombre"></span>\
                        </label></div>\
                        <div data-bind="if: $root[$parent.p().id()].checkencasilla()">\
                            <input class="mr-2" type="checkbox" data-bind="checked: $root[$parent.p().id()].chosenitems, checkedValue: $data, disable: $root.isEditor() || $root.isQuery() ? true : !$root[$parent.p().id()].habilitado(), attr: { name: \'checkbox\' + $parent.p().id() }" /><span data-bind="text: $data.Nombre"></span>\
                        </div>\
                    </div>\
                <!-- /ko -->',
                    synchronous: !0
                });

                ko.components.register("elemento-combodinamico-radio", {
                    viewModel: componentViewModel,
                    template: '<!-- ko foreach: $root[p().id()].catalogodestino() -->\
                    <div class="no-padding d-inline-block" data-bind="css: $root[$parent.p().id()].orientacion">\
                        <div data-bind="ifnot: $root[$parent.p().id()].checkencasilla()"><label class="m-0 font-weight-normal">\
                            <input class="mr-2" type="radio" data-bind="checked: $root[$parent.p().id()].chosenitems, checkedValue: $data, disable: $root.isEditor() || $root.isQuery() ? true : !$root[$parent.p().id()].habilitado(), attr: { name: \'radio\' + $parent.p().id() }" /><span data-bind="text: $data.Nombre"></span>\
                        </label></div>\
                        <div data-bind="if: $root[$parent.p().id()].checkencasilla()">\
                            <input class="mr-2" type="radio" data-bind="checked: $root[$parent.p().id()].chosenitems, checkedValue: $data, disable: $root.isEditor() || $root.isQuery() ? true : !$root[$parent.p().id()].habilitado(), attr: { name: \'radio\' + $parent.p().id() }" /><span data-bind="text: $data.Nombre"></span>\
                        </div>\
                    </div>\
                <!-- /ko -->',
                    synchronous: !0
                });

                ko.components.register("elemento-comboboxtemporal", {
                    viewModel: componentViewModel,
                    template: `<div data-bind="{
                        style: {
                            textAlign: $root[p().id()].alineadotexto, 
                            fontStyle: $root[p().id()].estilotexto, 
                            fontWeight: $root[p().id()].grosortexto
                        },
                        elementoLoaded: 1
                    }">${o1.templateLabelTitulo}${o1.templateLabelSubtitulo}
                    <select name="" class="form-control" style="border-radius: 5px" data-bind="{
                        disable: $root.isEditor() || $root.isQuery() ? true : !$root[p().id()].habilitado(), 
                        options: $root[p().id()].catalogodestino(),
                        optionsText: $root[$parent.p().id()].atributocombomostrar() === 'val' ? 'Valor' : 'Descripcion',
                        optionsValue: 'Valor',
                        value: $root[$parent.p().id()].optiontempselected,
                        event: { keydown: disableKeyboardForCBTemporal }
                    }" />
                </div>`,
                    synchronous: !0
                });

                ko.components.register("elemento-deslizante", {
                    viewModel: componentViewModel,
                    template: '<div class="deslizante" style="padding: 0px 10px" data-bind="\
                    style: {\
                        textAlign: $root[p().id()].alineadotexto,\
                        fontStyle: $root[p().id()].estilotexto,\
                        fontWeight: $root[p().id()].grosortexto\
                    },\
                    elementoLoaded: 1">' + o1.templateErrorValidation + o1.templateAsterisk + o1.templateLabelTitulo + o1.templateLabelSubtitulo + '\
                    <div style="padding: 30px 0px;"><input class="slider" data-bind="attr:{id:\'slider_\'+p().id()}" style="text-align: center;"/>\
                    <div style="margin-top: 20px;"><input type="text" data-bind="event: { keydown: onKeyDownNumber }, value: $root[p().id()].valor, disable: $root.isEditor() || $root.isQuery() ? true : !$root[p().id()].habilitado()" class="form-control" style="border-radius: 5px; text-align:center;" /></div></div>\
                </div>',
                    synchronous: !0
                });

                ko.components.register("elemento-documento", {
                    viewModel: componentViewModel,
                    template: `<div data-bind="{
                        style: {
                            textAlign: $root[p().id()].alineadotexto,
                            fontStyle: $root[p().id()].estilotexto,
                            fontWeight: $root[p().id()].grosortexto
                        },
                        elementoLoaded: 1
                    }">${o1.templateErrorValidation}${o1.templateAsterisk}${o1.templateLabelTitulo}${o1.templateLabelSubtitulo}
                    <div>
                        <div class="btn adddocument" data-bind="{
                                css: {
                                    disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(),
                                    'btn-block' : $root[p().id()].ancho() === 'completo'
                                }, 
                                style: {
                                    backgroundColor: $root[p().id()].colortomarfoto(), 
                                    color: $root[p().id()].colortextotomarfoto(), 'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                                }
                            }">
                            <i data-bind="{
                                    style: { 
                                        'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem' 
                                    }, 
                                    css: [$root[p().id()].iconoagregar()].join(' '), 
                                    attr: { 
                                        hidden: !$root[p().id()].vericonoagregar() 
                                    }
                                }"></i>&nbsp;
                            <span class="posttext" data-bind="{
                                    style: {
                                        'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem' 
                                    }, 
                                    text: $root[p().id()].textoagregar()
                                }"></span>
                        </div>
                    </div>
                    <label class="no-margin py-1" data-bind="text: ($root[p().id()].minimodocumentos() > 0 ? 'Mínimo: ' + $root[p().id()].minimodocumentos() + '-' : '') + ($root[p().id()].maximodocumentos() > 0 ? 'Máximo: ' + $root[p().id()].maximodocumentos() : '')" style="text-decoration: none; float: right;"></label>
                    <label class="no-margin py-1 text-red" data-bind="hidden: _.isEmpty($root[p().id()].errormetadatos()), html: $root[p().id()].errormetadatos" style="text-decoration: none; float: left;"></label>
                    <div class="position-relative" data-bind="attr:{hidden: _.isEmpty($root[p().id()].anexo())}">
                        <div data-bind="attr:{id: p().id() + 'carousel'}" class="carousel slide" data-ride="carousel" data-interval="false" data-keyboard="true">
                            <div class="carousel-inner m-auto" style="width:15rem;" role="listbox" data-bind="foreach: { data: $root[p().id()].anexo(), as: 'an'}">
                                <div class="carousel-item card text-center" data-bind="css: {active: $index().toString() === '0'}, attr:{id:an.guidanexo+'itemcar'}">
                                    <div data-bind="if: _.includes(['png', 'gif', 'jpg', 'bmp', 'pdf', '.png', '.gif', '.jpg', '.bmp', '.pdf', 'jpeg', '.jpeg'], !!an.ext && an.ext.toString().toLowerCase())">
                                        <div class="position-relative border-bottom py-1 px-2" style="white-space: nowrap;text-overflow:ellipsis;overflow:hidden;" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }, text: an.origname"></div>
                                        <img class="col-12" style="max-height:25vh; height:25vh; cursor:pointer;" data-bind="attr: { src: 'data:image/png;base64,' + an.thumb, alt: an.filename, hidden: !an.thumb ? true : an.thumb.length <= 0 }, click: function() { $parent.clickcustom(['view', an.guidanexo], true) }" />
                                        <i class="fas fa-download col-12" style="cursor: pointer; font-size: 2.5rem;" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }, attr: { hidden: !an.filename || an.filename.length <= 0 || an.downloaded === true }, click: function() { $parent.clickcustom(['view', an.guidanexo], true) }"></i>
                                        <span style="font-size:.4rem;" data-bind="attr: { hidden: !an.filename || an.filename.length <= 0 }">Da click para visualizar</span>
                                    </div>
                                    <div data-bind="ifnot: _.includes(['png', 'gif', 'jpg', 'bmp', 'pdf', '.png', '.gif', '.jpg', '.bmp', '.pdf', 'jpeg', '.jpeg'], !!an.ext && an.ext.toString().toLowerCase())">
                                        <div class="position-relative border-bottom py-1 px-2" style="white-space: nowrap;text-overflow:ellipsis;overflow:hidden;" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }, text: an.origname"></div>
                                        <div class="card-img-top d-flex align-items-center justify-content-center" style="font-size:2rem;height:25vh;">
                                            <div class="justify-content-end">
                                                <i class="far" data-bind="css: { 'fa-file-word': _.includes(['doc','docx', '.doc','.docx'], !!an.ext && an.ext.toString().toLowerCase()), 'fa-file-excel': _.includes(['xlsx', 'xls'], !!an.ext && an.ext.toString().toLowerCase()), 'fa-file': !_.includes(['png', 'gif', 'jpg', 'bmp', 'xlsx', 'xls', 'pdf', 'csv', 'doc', 'docx', 'jpeg'], !!an.ext && an.ext.toString().toLowerCase()) }"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body border-top p-0">
                                        <div class="pt-1 px-1 justify-content-end">
                                            <div class="pr-1">
                                                <div class="btn btn-secondary px-2 py-1 text-white replacedocument" style="padding: .4rem;" data-bind="attr: { hidden: !(an.docid > 0 && !an.docidanexo && !$root.isQuery() && $root[$parent.p().id()].habilitado()) }, reemplazomenu: $parent.p().id()">Reemplazar Documento</div>
                                                <div class="btn btn-info px-2 py-1 text-white" style="padding: .4rem;" data-bind="attr: { hidden: !(an.docidanexo && !$root.isQuery() && $root[$parent.p().id()].habilitado()) }, click: function() { $parent.clickcustom(['cancelreplace', an.guidanexo]) }"><i style="cursor:pointer" class="fas fa-undo pl-1 pr-1"></i><br />Undo</div>
                                                <div class="btn btn-danger px-2 py-1 text-white" style="padding: .4rem;" data-bind="attr: { hidden: !(an.delete && !$root.isQuery() && $root[$parent.p().id()].habilitado()) }, click: function() { $parent.clickcustom(['delete', '', an.guidanexo]) }"><i style="cursor:pointer" class="fas fa-trash-alt pl-1 pr-1" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></i><span data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }">Borrar</span></div>
                                            </div>
                                        </div>
                                        <strong class="pr-1 docname"></strong>
                                        <div class="p-1 text-center border-bottom" data-bind="attr:{hidden: an.docid === 0 && !an.docidanexo ? !$root[$parent.p().id()].permisotipificar() : true}">
                                            <div data-bind="tipodoccombo:$parent.p().id()"></div>
                                        </div>
                                        <table class="table table-bordered table-condensed">
                                            <thead>
                                                <tr>
                                                    <th>
                                                        <span data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }">Metadatos</span>
                                                        <div class="btn btn-primary px-2 py-1 text-white float-right" style="padding: .4rem;" data-bind="attr: { hidden: !(!$root.isQuery() && $root[$parent.p().id()].habilitado()) }, click: function() { $parent.clickcustom(['setMetadata', an.guidanexo]) }">
                                                            <i style="cursor:pointer" class="far fa-edit pl-1 pr-1" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></i>
                                                            <br/>
                                                            <span data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }">Editar</span>
                                                        </div>
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody data-bind="infoMetadata: {id:$parent.p().id(),data:$root[$parent.p().id()].updatemetadata()}"></tbody>
                                        </table>
                                        <div class="py-1" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\'}, text: $index()+1 + ' de '+ $root[$parent.p().id()].anexo().length"></div>
                                    </div>
                                </div>
                            </div>
                            <div data-bind="attr:{hidden: $root[p().id()].anexo().length <= 1}">
                                <a class="carousel-control-prev text-black" role="button" data-slide="prev" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }, attr:{href: '#' + p().id() + 'carousel'}" >
                                    <span class="fas fa-chevron-left" aria-hidden="true"></span><span class="sr-only">Anterior</span>
                                </a>
                            </div>
                            <div data-bind="attr:{hidden: $root[p().id()].anexo().length <= 1}">
                                <a class="carousel-control-next text-black" role="button" data-slide="next" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }, attr:{href: '#' + p().id() + 'carousel'}" >
                                    <span class="fas fa-chevron-right" aria-hidden="true"></span><span class="sr-only">Siguiente</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>`,
                    synchronous: !0
                });

                ko.components.register("elemento-fecha", {
                    viewModel: componentViewModel,
                    template: '<div data-bind="\
                    style: {\
                        textAlign: $root[p().id()].alineadotexto,\
                        fontStyle: $root[p().id()].estilotexto,\
                        fontWeight: $root[p().id()].grosortexto\
                    },\
                    elementoLoaded: 1">' + o1.templateErrorValidation + o1.templateAsterisk + o1.templateLabelTitulo + o1.templateLabelSubtitulo + '\
                    <input type="text" class="form-control" style="border-radius: 5px" data-bind="\
                        css: { \'hasError\' : $root[p().id()].haserror() },\
                        attr: { placeholder: $root[p().id()].mascara },\
                        disable: $root.isEditor() || $root.isQuery() ? true : !$root[p().id()].habilitado(),\
                        value: $root[p().id()].valor" /><span data-bind="formatofecha: {formato: $root[p().id()].formato(), separador: $root[p().id()].separador()}, attr:{hidden: $root.isEditor() ? false : _.isEmpty($root[p().id()].valor())}"></span>\
                </div>',
                    synchronous: !0
                });

                ko.components.register("elemento-firmafad", {
                    viewModel: componentViewModel,
                    template: `<div data-bind="{
                        style: {
                            textAlign: $root[p().id()].alineadotexto,
                            fontStyle: $root[p().id()].estilotexto,
                            fontWeight: $root[p().id()].grosortexto
                        },
                        elementoLoaded: 1
                    }">${o1.templateErrorValidation}${o1.templateAsterisk}${o1.templateLabelTitulo}${o1.templateLabelSubtitulo}
                    <img data-bind="{
                            attr: { 
                                src: !!$root[p().id()].anexo().thumb ? 'data:image/png;base64,' + $root[p().id()].anexo().thumb : '', 
                                hidden: !$root[p().id()].anexo().thumb ? true : $root[p().id()].anexo().thumb.length <= 0 
                            },
                            click: function() { clickcustom('view') }
                        }" class="col-sm-4 col-4 img-thumbnail mx-auto mb-2" style="display:block; cursor:pointer;" />
                    <div style="text-align: center;">
                        <i class="fas fa-download img-thumbnail p-4 mb-2" style="font-size: 2.5em;" data-bind="
                            attr: { hidden: $root[p().id()].nombrearchivo().length <= 0 || $root[p().id()].anexo().downloaded === true }, click: function() { clickcustom('view') }"></i>
                        <div class="btn addfirma" data-bind="
                            style: {backgroundColor: $root[p().id()].colorfirma(), color: $root[p().id()].colortextofirma()},
                            click: function() { clickcustom('fad') },
                            css:{ disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()},
                            attr: { hidden: !$root[p().id()].permisofirmar() ? true : !!$root[p().id()].anexo() && !!$root[p().id()].anexo().guidanexo }">
                            <i class="fas fa-file-signature pr-2"></i>Firmar
                        </div>
                    </div>
                    <div class="btn viewsigned" data-bind="
                        style: {backgroundColor: $root[p().id()].colorvisualizar(), color: $root[p().id()].colortextovisualizar()},
                        click: function() { clickcustom('view') },
                        css:{ disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()},
                        attr:{ hidden: !($root[p().id()].anexo() && $root[p().id()].anexo().guidanexo) }">
                        <i class="fas fa-eye pr-2"></i>Firma
                    </div>
                    <div class="btn viewwitness" data-bind="
                        style: {backgroundColor: $root[p().id()].colorvisualizar(), color: $root[p().id()].colortextovisualizar()},
                        click: function() { clickcustom('fadtestigo') },
                        css:{ disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()},
                        attr:{ hidden: !($root[p().id()].anexo() && $root[p().id()].anexo().guidanexo) }">
                        <i class="fas fa-eye pr-2"></i>Testigo
                    </div>
                    <div class="btn viewtimestamp" data-bind="
                        style: {backgroundColor: $root[p().id()].colorvisualizar(), color: $root[p().id()].colortextovisualizar()},
                        click: function() { clickcustom('fadtimestamp') },
                        css:{ disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()},
                        attr:{ hidden: !($root[p().id()].anexo() && $root[p().id()].anexo().guidanexo) }">
                        <i class="fas fa-file-alt pr-2"></i>Timestamp
                    </div>
                    <div class="btn deletefad" data-bind="
                        style: {backgroundColor: $root[p().id()].colorborrar(), color: $root[p().id()].colortextoborrar()},
                        click: function() { clickcustom('delete') },
                        css:{ disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()},
                        attr:{ hidden: !($root[p().id()].anexo().delete && _.isEmpty($root[p().id()].anteriornombrearchivo())) }">
                        <i class="far fa-trash-alt pr-2"></i>Borrar
                    </div>
                    <div class="pt-2" data-bind="
                        attr: { hidden: $root.isEditor() ? true : $root[p().id()].anexo() && $root[p().id()].anexo().docid === 0 && _.isEmpty($root[p().id()].anteriornombrearchivo()) ? !$root[p().id()].permisotipificar() : true}">
                        <strong class="pr-1">Tipo de documento:</strong>
                        <div data-bind="tipodoccombo:p().id()"></div>
                    </div>
                </div>`,
                    synchronous: !0
                });

                ko.components.register("elemento-georeferencia", {
                    viewModel: componentViewModel,
                    template: '<div data-bind="\
                    style: {\
                        textAlign: $root[p().id()].alineadotexto,\
                        fontStyle: $root[p().id()].estilotexto,\
                        fontWeight: $root[p().id()].grosortexto\
                    },\
                    elementoLoaded: 1">' + o1.templateErrorValidation + o1.templateAsterisk + o1.templateLabelTitulo + o1.templateLabelSubtitulo + '\
                    <div class="btn btn-primary mr-4 px-2 py-1" style="background-color: #186bb1" data-bind="\
                        css: { disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones() },\
                        attr: {hidden: $root[p().id()].nombrearchivo().length > 0 },\
                        click: function() { clickcustom(\'gpsmap\')}"><i class="fas fa-search pr-2"></i>Localizar\
                    </div>\
                    <div class="btn btn-danger mr-4 px-2 py-1" data-bind="\
                        click: function() { clickcustom(\'delete\') },\
                        css:{ disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()},\
                        attr:{ hidden: !$root[p().id()].anexo().delete }">\
                        <i class="far fa-trash-alt pr-2"></i>Borrar\
                    </div>\
                    <input type="text" disabled class="form-control mt-2" style="border-radius: 5px" data-bind="value: $root[p().id()].valor" />\
                    <div class="position-absolute" style="z-index:-1000;top:-50%" data-bind="attr: { id: \'map\' + p().id() }" hidden></div>\
                    <img class="mt-2 w-100" data-bind="attr: { id: \'mapimage\' + p().id(), src: $root[p().id()].anexo().thumb, hidden: !$root[p().id()].anexo().thumb ? true : $root[p().id()].anexo().thumb.length <= 0 }"/>\
                    <div class="text-center mt-3" data-bind="attr: { hidden: $root[p().id()].nombrearchivo().length <= 0 || $root[p().id()].anexo().downloaded === true }"><i title="Visualizar" class="fas fa-download img-thumbnail p-4" style="font-size: 2.5em;cursor:pointer;" data-bind="click: function() { clickcustom(\'downloadatt\') }"></i></div>\
                    <div class="pt-2" data-bind="attr: { hidden: $root.isEditor() ? true : $root[p().id()].anexo() && $root[p().id()].anexo().docid === 0 ? !$root[p().id()].permisotipificar() : true}">\
                    <strong class="pr-1">Tipo de documento:</strong><div data-bind="tipodoccombo:p().id()"></div></div>\
                </div>',
                    synchronous: !0
                });

                ko.components.register("elemento-huelladigital", {
                    viewModel: componentViewModel,
                    template: '<div class="huelladigital" data-bind="\
                    style: {\
                        textAlign: $root[p().id()].alineadotexto,\
                        fontStyle: $root[p().id()].estilotexto,\
                        fontWeight: $root[p().id()].grosortexto\
                    },\
                    elementoLoaded: 1">' + o1.templateErrorValidation + o1.templateAsterisk + o1.templateLabelTitulo + o1.templateLabelSubtitulo + '\
                </div>',
                    synchronous: !0
                });

                ko.components.register("elemento-hora", {
                    viewModel: componentViewModel,
                    template: '<div data-bind="\
                    style: {\
                        textAlign: $root[p().id()].alineadotexto,\
                        fontStyle: $root[p().id()].estilotexto,\
                        fontWeight: $root[p().id()].grosortexto\
                    },\
                    elementoLoaded: 1">' + o1.templateErrorValidation + o1.templateAsterisk + o1.templateLabelTitulo + o1.templateLabelSubtitulo + '\
                    <input type="text" class="form-control" style="border-radius: 5px" data-bind="\
                        css: { \'hasError\' : $root[p().id()].haserror() },\
                        attr: { placeholder: $root[p().id()].mascara },\
                        disable: $root.isEditor() || $root.isQuery() ? true : !$root[p().id()].habilitado(),\
                        value: $root[p().id()].valor" /><span data-bind="text: $root[p().id()].hora() === \'H:i\' ? \'HH:mm\' : \'hh:mm AM\', attr:{hidden: $root.isEditor() ? false : _.isEmpty($root[p().id()].valor())}"></span>\
                </div>',
                    synchronous: !0
                });

                ko.components.register("elemento-imagen", {
                    viewModel: componentViewModel,
                    template: `<div data-bind="
                    style: {
                        textAlign: $root[p().id()].alineadotexto,
                        fontStyle: $root[p().id()].estilotexto,
                        fontWeight: $root[p().id()].grosortexto
                    },
                    elementoLoaded: 1">${o1.templateErrorValidation}${o1.templateAsterisk}${o1.templateLabelTitulo}${o1.templateLabelSubtitulo}
                    <div class="text-center">
                        <div data-bind="
                            designbuttonall: { t: 'Agregar', ty: $root[p().id()].tipo(), c: $root[p().id()].colortextotomarfoto(), bg: $root[p().id()].colortomarfoto() },
                            attr: { hidden: !!$root[p().id()].anexo() && !!$root[p().id()].anexo().guidanexo }">
                            <div class="btn addimagen" data-bind="
                                css: { disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones() }">
                                <span class="pretext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                                <i class="far fa-images" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></i>
                                <span class="posttext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                            </div>
                            <br />
                            <span class="externtext text-bold" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                        </div>
                    </div>
                    <img data-bind="
                        attr: { src: $root[p().id()].anexo().thumb, hidden: !$root[p().id()].anexo().thumb ? true : $root[p().id()].anexo().thumb.length <= 0 }, 
                        click: function() { clickcustom('view') }" 
                        class="col-sm-4 col-4 img-thumbnail mx-auto mb-2" style="display:block; cursor:pointer;" />
                    <div style="text-align: center;">
                        <i class="fas fa-download img-thumbnail p-4 mb-2" style="font-size: 2.5em; cursor: pointer;" data-bind="
                            style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' },
                            attr: { hidden: $root[p().id()].nombrearchivo().length <= 0 || $root[p().id()].anexo().downloaded === true },
                            click: function() { clickcustom('view') }"></i>
                    </div>
                    <div class="actiondelete" data-bind="
                        designbuttonall: { t: 'Borrar', ty: $root[p().id()].tipo(), c: $root[p().id()].colortextoborrar(), bg: $root[p().id()].colorborrar() },
                        attr:{ hidden: !($root[p().id()].anexo().delete && _.isEmpty($root[p().id()].anteriornombrearchivo())) }">
                        <div class="btn" data-bind="
                            click: function() { clickcustom('delete') },
                            css:{ disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()}">
                            <span class="pretext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                            <i class="far fa-trash-alt" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></i>
                            <span class="posttext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                        </div>
                        <br />
                        <span class="externtext text-bold" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                    </div>
                    <div class="actionview" data-bind="
                        designbuttonall: { t: 'Ver', ty: $root[p().id()].tipo(), c: $root[p().id()].colortextovisualizar(), bg: $root[p().id()].colorvisualizar() },
                        attr:{ hidden: !($root[p().id()].anexo() && $root[p().id()].anexo().guidanexo) }">
                        <div class="btn" data-bind="
                            click: function() { clickcustom('view') },
                            css:{ disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()}">
                            <span class="pretext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                            <i class="fas fa-eye" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></i>
                            <span class="posttext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                        </div>
                        <br />
                        <span class="externtext text-bold" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                    </div>
                    <div class="actionreplace" data-bind="
                        designbuttonall: { t: 'Reemplazar', ty: $root[p().id()].tipo(), c: $root[p().id()].colortextoreemplazar(), bg: $root[p().id()].colorreemplazar() },
                        attr:{ hidden: !($root[p().id()].anexo() && $root[p().id()].anexo().docid > 0) }">
                        <div class="btn" data-bind="
                            click: function() { clickcustom('replace') },
                            css:{disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()}">
                            <span class="pretext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                            <i class="fas fa-undo" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></i>
                            <span class="posttext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                        </div>
                        <br />
                        <span class="externtext text-bold" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                    </div>
                    <div class="actionreplace" data-bind="{
                        designbuttonall: { 
                            t: 'Historico', 
                            ty: $root[p().id()].tipo(), 
                            c: $root[p().id()].colortextovisualizar(), 
                            bg: $root[p().id()].colorvisualizar() 
                        },
                        attr: { 
                            hidden: !($root[p().id()].anexo() && $root[p().id()].anexo().docid > 0) 
                        }
                    }">
                        <div class="btn" data-bind="
                            click: function() { clickcustom('historico') },
                            css:{disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()}">
                            <span class="pretext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                            <i class="fas fa-history" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></i>
                            <span class="posttext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                        </div>
                        <br />
                        <span class="externtext text-bold" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                    </div>
                    <div class="actioncancelreplace" data-bind="
                        designbuttonall: { t: 'Cancelar Reemplazo', ty: $root[p().id()].tipo(), c: $root[p().id()].colortextoborrar(), bg: $root[p().id()].colorborrar() },
                        attr:{ hidden: _.isEmpty($root[p().id()].anteriornombrearchivo())}">
                        <div class="btn" data-bind="
                            click: function() { clickcustom('cancelreplace') },
                            css:{disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()}">
                            <span class="pretext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                            <i class="fas fa-times-circle" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></i>
                            <span class="posttext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                        </div>
                        <br />
                        <span class="externtext text-bold" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                    </div>
                    <div class="p-1 text-center" data-bind="{
                        attr: { 
                            hidden: $root.isEditor() ? true : 
                                        $root[p().id()].anexo() && $root[p().id()].anexo().docid === 0 && _.isEmpty($root[p().id()].anteriornombrearchivo()) ? 
                                        !$root[p().id()].permisotipificar() : true
                        }
                    }">
                        <strong class="pr-1">Tipo de documento:</strong>
                        <br/>
                        <div data-bind="tipodoccombo:p().id()"></div>
                    </div>
                    <div class="historicoanexos"></div>
                </div>`,
                    synchronous: !0
                });

                ko.components.register("elemento-leyenda", {
                    viewModel: componentViewModel,
                    template: '<div data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }, elementoLoaded: 1"></div>',
                    synchronous: !0
                });

                ko.components.register("elemento-lista", {
                    viewModel: componentViewModel,
                    template: '<div class="docelem" data-bind="\
                    style: {\
                        textAlign: $root[p().id()].alineadotexto,\
                        fontStyle: $root[p().id()].estilotexto, \
                        fontWeight: $root[p().id()].grosortexto\
                    },\
                    elementoLoaded: 1">' + o1.templateErrorValidation + o1.templateAsterisk + o1.templateLabelTitulo + o1.templateLabelSubtitulo + '\
                    <!-- ko component: { name: "elemento-lista-" + $root[p().id()].tipolista(), params: { id: p().id(), tipo: p().tipo() } } --><!-- /ko -->\
                </div>',
                    synchronous: !0
                });

                ko.components.register("elemento-lista-checkbox", {
                    viewModel: componentViewModel,
                    template: `<!-- ko foreach: $root[p().id()].catalogodestino() -->
                    <div class="no-padding d-inline-block" data-bind="css: $root[$parent.p().id()].orientacion">
                        <div data-bind="ifnot: $root[$parent.p().id()].checkencasilla()">
                            <label class="m-0 font-weight-normal row">
                                <input class="mr-2" type="checkbox" data-bind="checked: $root[$parent.p().id()].chosenitems, checkedValue: $data, disable: $root.isEditor() || $root.isQuery() ? true : !$root[$parent.p().id()].habilitado(), attr: { name: 'checkbox' + $parent.p().id() }" />
                                <div data-bind="if: $root[$parent.p().id()].imageposition() === 'up' || $root[$parent.p().id()].imageposition() === 'left'">
                                    <div data-bind="{ if: $data.HasImagenFE === !0 && ($data.ImagenFE.indexOf('http') >= 0 || $data.ImagenFE.indexOf('/') >= 0), style: { float: $root[$parent.p().id()].imageposition() === 'left' ? 'left' : 'none' } }">
                                        <img class="imgitemcatalogo" data-bind="attr: { src: $data.ImagenFE }" />
                                    </div>
                                    <div data-bind="{ if: $data.HasImagenFE === !0 && ($data.ImagenFE.indexOf('http') == -1 && $data.ImagenFE.indexOf('/') == -1), style: { float: $root[$parent.p().id()].imageposition() === 'left' ? 'left' : 'none' } }">
                                        <i class="iconitemcatalogo" data-bind="{ css: $data.ImagenFE }"></i>
                                    </div>
                                    <span data-bind="{ text: $data.Descripcion, style: { \'margin-left\': $root[$parent.p().id()].imageposition() === 'left' ? '.5rem' : '0' } }"></span>
                                </div>
                                <div data-bind="if: $root[$parent.p().id()].imageposition() === 'right' || $root[$parent.p().id()].imageposition() === 'down'">
                                    <span data-bind="{ text: $data.Descripcion, style: { \'margin-right\': $root[$parent.p().id()].imageposition() === 'right' ? '.5rem' : '0' } }"></span>
                                    <div data-bind="{ if: $data.HasImagenFE === !0 && ($data.ImagenFE.indexOf('http') >= 0 || $data.ImagenFE.indexOf('/') >= 0), style: { float: $root[$parent.p().id()].imageposition() === 'right' ? 'right' : 'none' } }">
                                        <img class="imgitemcatalogo" data-bind="attr: { src: $data.ImagenFE }" />
                                    </div>
                                    <div data-bind="{ if: $data.HasImagenFE === !0 && ($data.ImagenFE.indexOf('http') == -1 && $data.ImagenFE.indexOf('/') == -1), style: { float: $root[$parent.p().id()].imageposition() === 'right' ? 'right' : 'none' } }">
                                        <i class="iconitemcatalogo" data-bind="{ css: $data.ImagenFE }"></i>
                                    </div>
                                </div>
                            </label>
                        </div>
                        <div data-bind="if: $root[$parent.p().id()].checkencasilla()">
                            <input class="mr-2" type="checkbox" data-bind="checked: $root[$parent.p().id()].chosenitems, checkedValue: $data, disable: $root.isEditor() || $root.isQuery() ? true : !$root[$parent.p().id()].habilitado(), attr: { name: 'checkbox' + $parent.p().id() }" />
                            <div data-bind="if: $root[$parent.p().id()].imageposition() === 'up' || $root[$parent.p().id()].imageposition() === 'left'">
                                <div data-bind="{ if: $data.HasImagenFE === !0 && ($data.ImagenFE.indexOf('http') >= 0 || $data.ImagenFE.indexOf('/') >= 0), style: { float: $root[$parent.p().id()].imageposition() === 'left' ? 'left' : 'none' } }">
                                    <img class="imgitemcatalogo" data-bind="attr: { src: $data.ImagenFE }" />
                                </div>
                                <div data-bind="{ if: $data.HasImagenFE === !0 && ($data.ImagenFE.indexOf('http') == -1 && $data.ImagenFE.indexOf('/') == -1), style: { float: $root[$parent.p().id()].imageposition() === 'left' ? 'left' : 'none' } }">
                                    <i class="iconitemcatalogo" data-bind="{ css: $data.ImagenFE }"></i>
                                </div>
                                <span data-bind="{ text: $data.Descripcion, style: { \'margin-left\': $root[$parent.p().id()].imageposition() === 'left' ? '.5rem' : '0' } }"></span>
                            </div>
                            <div data-bind="if: $root[$parent.p().id()].imageposition() === 'right' || $root[$parent.p().id()].imageposition() === 'down'">
                                <span data-bind="{ text: $data.Descripcion, style: { \'margin-right\': $root[$parent.p().id()].imageposition() === 'right' ? '.5rem' : '0' } }"></span>
                                <div data-bind="{ if: $data.HasImagenFE === !0 && ($data.ImagenFE.indexOf('http') >= 0 || $data.ImagenFE.indexOf('/') >= 0), style: { float: $root[$parent.p().id()].imageposition() === 'right' ? 'right' : 'none' } }">
                                    <img class="imgitemcatalogo" data-bind="attr: { src: $data.ImagenFE }" />
                                </div>
                                <div data-bind="{ if: $data.HasImagenFE === !0 && ($data.ImagenFE.indexOf('http') == -1 && $data.ImagenFE.indexOf('/') == -1), style: { float: $root[$parent.p().id()].imageposition() === 'right' ? 'right' : 'none' } }">
                                    <i class="iconitemcatalogo" data-bind="{ css: $data.ImagenFE }"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                <!-- /ko -->`,
                    synchronous: !0
                });

                ko.components.register("elemento-lista-combo", {
                    viewModel: componentViewModel,
                    template: '<select class="form-control docelem" style="border-radius: 5px" data-bind="\
                    css: { \'hasError\' : $root[p().id()].haserror() },\
                    disable: $root.isEditor() || $root.isQuery() ? true : !$root[p().id()].habilitado(),\
                    options: $root[p().id()].catalogodestino(),\
                    optionsText: \'Descripcion\',\
                    optionsValue: \'Valor\',\
                    value: $root[$parent.p().id()].optionselected,\
                    comborendered: p().id() \
                " />',
                    synchronous: !0
                });

                ko.components.register("elemento-lista-radio", {
                    viewModel: componentViewModel,
                    template: `<!-- ko foreach: $root[p().id()].catalogodestino() -->
                    <div class="no-padding d-inline-block" data-bind="css: $root[$parent.p().id()].orientacion">
                        <div data-bind="ifnot: $root[$parent.p().id()].checkencasilla()">
                            <label class="m-0 font-weight-normal row">
                                <input class="mr-2" type="radio" data-bind="checked: $root[$parent.p().id()].chosenitems, checkedValue: $data, disable: $root.isEditor() || $root.isQuery() ? true : !$root[$parent.p().id()].habilitado(), attr: { name: 'radio' + $parent.p().id() }" />
                                <div data-bind="if: $root[$parent.p().id()].imageposition() === 'up' || $root[$parent.p().id()].imageposition() === 'left'">
                                    <div data-bind="{ if: $data.HasImagenFE === !0 && ($data.ImagenFE.indexOf('http') >= 0 || $data.ImagenFE.indexOf('/') >= 0), style: { float: $root[$parent.p().id()].imageposition() === 'left' ? 'left' : 'none' } }">
                                        <img class="imgitemcatalogo" data-bind="attr: { src: $data.ImagenFE }" />
                                    </div>
                                    <div data-bind="{ if: $data.HasImagenFE === !0 && ($data.ImagenFE.indexOf('http') == -1 && $data.ImagenFE.indexOf('/') == -1), style: { float: $root[$parent.p().id()].imageposition() === 'left' ? 'left' : 'none' } }">
                                        <i class="iconitemcatalogo" data-bind="{ css: $data.ImagenFE }"></i>
                                    </div>
                                    <span data-bind="{ text: $data.Descripcion, style: { \'margin-left\': $root[$parent.p().id()].imageposition() === 'left' ? '.5rem' : '0' } }"></span>
                                </div>
                                <div data-bind="if: $root[$parent.p().id()].imageposition() === 'right' || $root[$parent.p().id()].imageposition() === 'down'">
                                    <span data-bind="{ text: $data.Descripcion, style: { \'margin-right\': $root[$parent.p().id()].imageposition() === 'right' ? '.5rem' : '0' } }"></span>
                                    <div data-bind="{ if: $data.HasImagenFE === !0 && ($data.ImagenFE.indexOf('http') >= 0 || $data.ImagenFE.indexOf('/') >= 0), style: { float: $root[$parent.p().id()].imageposition() === 'right' ? 'right' : 'none' } }">
                                        <img class="imgitemcatalogo" data-bind="attr: { src: $data.ImagenFE }" />
                                    </div>
                                    <div data-bind="{ if: $data.HasImagenFE === !0 && ($data.ImagenFE.indexOf('http') == -1 && $data.ImagenFE.indexOf('/') == -1), style: { float: $root[$parent.p().id()].imageposition() === 'right' ? 'right' : 'none' } }">
                                        <i class="iconitemcatalogo" data-bind="{ css: $data.ImagenFE }"></i>
                                    </div>
                                </div>
                            </label>
                        </div>
                        <div class="row" data-bind="if: $root[$parent.p().id()].checkencasilla()">
                            <input class="mr-2" type="radio" data-bind="checked: $root[$parent.p().id()].chosenitems, checkedValue: $data, disable: $root.isEditor() || $root.isQuery() ? true : !$root[$parent.p().id()].habilitado(), attr: { name: 'radio' + $parent.p().id() }" />
                            <div data-bind="if: $root[$parent.p().id()].imageposition() === 'up' || $root[$parent.p().id()].imageposition() === 'left'">
                                <div data-bind="{ if: $data.HasImagenFE === !0 && ($data.ImagenFE.indexOf('http') >= 0 || $data.ImagenFE.indexOf('/') >= 0), style: { float: $root[$parent.p().id()].imageposition() === 'left' ? 'left' : 'none' } }">
                                    <img class="imgitemcatalogo" data-bind="attr: { src: $data.ImagenFE }" />
                                </div>
                                <div data-bind="{ if: $data.HasImagenFE === !0 && ($data.ImagenFE.indexOf('http') == -1 && $data.ImagenFE.indexOf('/') == -1), style: { float: $root[$parent.p().id()].imageposition() === 'left' ? 'left' : 'none' } }">
                                    <i class="iconitemcatalogo" data-bind="{ css: $data.ImagenFE }"></i>
                                </div>
                                <span data-bind="{ text: $data.Descripcion, style: { \'margin-left\': $root[$parent.p().id()].imageposition() === 'left' ? '.5rem' : '0' } }"></span>
                            </div>
                            <div data-bind="if: $root[$parent.p().id()].imageposition() === 'right' || $root[$parent.p().id()].imageposition() === 'down'">
                                <span data-bind="{ text: $data.Descripcion, style: { \'margin-right\': $root[$parent.p().id()].imageposition() === 'right' ? '.5rem' : '0' } }"></span>
                                <div data-bind="{ if: $data.HasImagenFE === !0 && ($data.ImagenFE.indexOf('http') >= 0 || $data.ImagenFE.indexOf('/') >= 0), style: { float: $root[$parent.p().id()].imageposition() === 'right' ? 'right' : 'none' } }">
                                    <img class="imgitemcatalogo" data-bind="attr: { src: $data.ImagenFE }" />
                                </div>
                                <div data-bind="{ if: $data.HasImagenFE === !0 && ($data.ImagenFE.indexOf('http') == -1 && $data.ImagenFE.indexOf('/') == -1), style: { float: $root[$parent.p().id()].imageposition() === 'right' ? 'right' : 'none' } }">
                                    <i class="iconitemcatalogo" data-bind="{ css: $data.ImagenFE }"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                <!-- /ko -->`,
                    synchronous: !0
                });

                ko.components.register("elemento-logico", {
                    viewModel: componentViewModel,
                    template: '<div data-bind="\
                    style: {\
                        textAlign: $root[p().id()].alineadotexto,\
                        fontStyle: $root[p().id()].estilotexto,\
                        fontWeight: $root[p().id()].grosortexto\
                    },\
                    elementoLoaded: 1">' + o1.templateErrorValidation + o1.templateAsterisk + o1.templateLabelTitulo + o1.templateLabelSubtitulo + '\
                    <div class="row">\
                        <div class="col-sm-2 col-2" data-bind="css: { \'float-right\': $root[p().id()].alineadotexto() === \'right\' }, style: { margin: $root[p().id()].alineadotexto() === \'center\' ? \'auto\' : \'\', float: $root[p().id()].alineadotexto() === \'center\' ? \'none\' : \'\' }">\
                            <div class="checkbox">\
                                <label><input type="checkbox" data-bind="disable: $root.isEditor() || $root.isQuery() ? true : !$root[p().id()].habilitado(), checked: $root[p().id()].valor" /></label>\
                            </div>\
                        </div>\
                        <div class="col-sm-10 col-10" data-bind="attr: { hidden: $root[p().id()].imagenlogico().length == 0 }, style: { margin: $root[p().id()].alineadotexto() === \'center\' ? \'auto\' : \'\', float: $root[p().id()].alineadotexto() === \'center\' ? \'none\' : \'\' }">\
                            <img style="width: 100%;" data-bind="attr: { src: $root[p().id()].imagenlogico, alt: $root[p().id()].titulo, title: $root[p().id()].titulo }" class="img-responsive img-thumbnail center-block float-right" />\
                        </div>\
                    </div>\
                </div>',
                    synchronous: !0
                });

                ko.components.register("elemento-logo", {
                    viewModel: componentViewModel,
                    template: `<div class="element sortable droppedin card no-padding bg-white align-top mb-2"
                        style="display:inline-table" data-bind="{
                            style: { 
                                marginRight: _.isEmpty($root[p().id()].margenderecho()) ? 0 : $root[p().id()].margenderecho(),
                                marginLeft: _.isEmpty($root[p().id()].margenizquierdo()) ? 0 : $root[p().id()].margenizquierdo()
                            },
                            css: [
                                $root[p().id()].csselementoglobal(), 
                                $root[p().id()].nombreestilopersonal(), 
                                $root[$root.idPlantilla()].bordeelementos() ? 'sortableborderwith' : 'no-border'
                            ].join(' '),
                            attr: {
                                id: p().id, 
                                hidden: $root.isEditor() ? false : !$root[p().id()].visible()
                            }
                        }">
                    <div class="card-body p-1">
                        <div>
                            <img data-bind="{
                                attr: { 
                                    src: $root[p().id()].archivo, 
                                    alt: $root[p().id()].titulo, 
                                    title: $root[p().id()].titulo, 
                                    hidden: $root[p().id()].archivo().length == 0 
                                }, 
                                style: { 
                                    width: $root[p().id()].ancho() + 'px', 
                                    height: $root[p().id()].alto() + 'px' 
                                }
                            }" class="img-responsive img-thumbnail center-block no-border" />
                            <i data-bind="{
                                attr: { 
                                    hidden: $root[p().id()].archivo().length > 0 
                                }
                            }" class="far fa-image" style="font-size: 50px;"></i>
                        </div>
                        <div class="actions no-padding text-right" data-bind="{
                                attr: { 
                                    hidden: !$root.isEditor() 
                                }
                            }">
                            <!-- ko component: { 
                                name: "actions", 
                                params: { 
                                    id: p().id(), 
                                    tipo: p().tipo() 
                                } 
                            } --><!-- /ko -->
                        </div>
                    </div>
                </div>`,
                    synchronous: !0
                });

                ko.components.register("elemento-mapa", {
                    viewModel: componentViewModel,
                    template: `<div data-bind="
                        style: {
                            textAlign: $root[p().id()].alineadotexto,
                            fontStyle: $root[p().id()].estilotexto,
                            fontWeight: $root[p().id()].grosortexto
                        }">${(o1.templateErrorValidation + o1.templateAsterisk + o1.templateLabelTitulo + o1.templateLabelSubtitulo)}
                        <div class="form-inline">
                            <div class="mb-3 row">
                                <label>Coordenadas:&nbsp;&nbsp;</label>
                                <input type="text" readonly class="form-control" data-bind="
                                    value: $root[p().id()].valor,
                                    attr:{disabled:$root.isQuery() ? true : !$root[p().id()].habilitado()}" />&nbsp;&nbsp;
                            </div>
                        </div>
                        <div data-bind="
                            attr: { id: 'map' + p().id() },
                            elementoLoaded: p().tipo()" class="map" style="height: 5px; width: 5px;"></div>
                        <img data-bind="attr: { src: $root[p().id()].nombrearchivo }" hidden />
                    </div>`,
                    synchronous: !0
                });

                ko.components.register("elemento-marcadodocumentos", {
                    viewModel: componentViewModel,
                    template: '<div data-bind="\
                    style: {\
                        textAlign: $root[p().id()].alineadotexto,\
                        fontStyle: $root[p().id()].estilotexto,\
                        fontWeight: $root[p().id()].grosortexto\
                    },\
                    elementoLoaded: 1">' + o1.templateErrorValidation + o1.templateLabelTitulo + o1.templateLabelSubtitulo + '\
                        <!--ko foreach: $root[p().id()].catalogodestino()-->\
                            <span class="no-padding d-inline-block" data-bind="css: $root[$parent.p().id()].orientacion()">\
                                <input class="mr-2" disabled style="cursor:default" type="checkbox" data-bind="checked: $root[$parent.p().id()].chosenitems, checkedValue: $data, attr: { name:\'checkbox\' + $parent.p().id() }"/>\
                                <span data-bind="text: $data.Descripcion"></span>\
                                <span class="fas fa-asterisk align-top" style="font-size: 7px;" data-bind="attr:{hidden: !($data.EsRequerido && $root[$parent.p().id()].requerido())}"></span>\
                            </span>\
                        <!--/ko -->\
                        <div class="docelem"><div class="cbOptionsDocs" data-bind="attr:{id:\'cbOptionsDocs\'+ p().id()}"></div></div>\
                    </div>',
                    synchronous: !0
                });

                ko.components.register("elemento-moneda", {
                    viewModel: componentViewModel,
                    template: '<div class="moneda" data-bind="\
                    style: {\
                        textAlign: $root[p().id()].alineadotexto,\
                        fontStyle: $root[p().id()].estilotexto,\
                        fontWeight: $root[p().id()].grosortexto\
                    },\
                    elementoLoaded: 1">' + o1.templateErrorValidation + o1.templateAsterisk + o1.templateLabelTitulo + o1.templateLabelSubtitulo + '\
                    <div class="input-group mb-3"><input class="form-control" style="border-radius: 5px" data-bind="\
                        style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\', \'font-family\': $root[$root.idPlantilla()].tipofuente() },\
                        css: { \'hasError\' : $root[p().id()].haserror() },\
                        attr: { placeholder: $root[p().id()].mascara, type: typeinput(), maxlength: $root[p().id()].longitudmaxima },\
                        disable: $root.isEditor() || $root.isQuery() ? true : !$root[p().id()].habilitado(),\
                        value: $root[p().id()].valor,\
                        event: { keydown: onKeyDownNumber }" /><span class="align-self-center" style="padding-left: 10px;" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\', \'font-family\': $root[$root.idPlantilla()].tipofuente() }, text: $root[p().id()].cultura()===\'es\' ? \'MXN\' : \'USD\'"></span>\
                </div></div>',
                    synchronous: !0
                });

                ko.components.register("elemento-nfc", {
                    viewModel: componentViewModel,
                    template: '<div data-bind="\
                    style: {\
                        textAlign: $root[p().id()].alineadotexto,\
                        fontStyle: $root[p().id()].estilotexto,\
                        fontWeight: $root[p().id()].grosortexto\
                    },\
                    elementoLoaded: 1">' + o1.templateErrorValidation + o1.templateAsterisk + o1.templateLabelTitulo + o1.templateLabelSubtitulo + '\
                     <div><div class="btn mr-2 mt-2 px-2 py-1" data-bind="\
                        style: {backgroundColor: $root[p().id()].colorescaner(), color: $root[p().id()].colortextoescaner()},\
                        css:{ disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()},\
                        attr: { hidden: !$root[p().id()].permisoescaner() }">\
                        <i class="fas fa-mobile-alt pr-2"></i>Esc&aacute;ner\
                    </div></div>\
                </div>',
                    synchronous: !0
                });

                ko.components.register("elemento-numero", {
                    viewModel: componentViewModel,
                    template: '<div data-bind="\
                    style: {\
                        textAlign: $root[p().id()].alineadotexto,\
                        fontStyle: $root[p().id()].estilotexto,\
                        fontWeight: $root[p().id()].grosortexto\
                    },\
                    elementoLoaded: 1">' + o1.templateErrorValidation + o1.templateAsterisk + o1.templateLabelTitulo + o1.templateLabelSubtitulo +
                        '<input class="form-control" style="border-radius: 5px; -webkit-appearance: none" data-bind="\
                        style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\', \'font-family\': $root[$root.idPlantilla()].tipofuente() },\
                        css: { \'hasError\' : $root[p().id()].haserror() },\
                        attr: { placeholder: $root[p().id()].mascara, type: typeinput() },\
                        disable: $root.isEditor() || $root.isQuery() ? true : !$root[p().id()].habilitado(),\
                        value: $root[p().id()].valor,\
                        event: { keydown: onKeyDownNumber }" >' + o1.templateMascara +
                        '</div>',
                    synchronous: !0
                });

                ko.components.register("elemento-ocr", {
                    viewModel: componentViewModel,
                    template: `<div data-bind="style: {
                        textAlign: $root[p().id()].alineadotexto,
                        fontStyle: $root[p().id()].estilotexto,
                        fontWeight: $root[p().id()].grosortexto
                    }, elementoLoaded: 1">
                    ${o1.templateErrorValidation}${o1.templateAsterisk}${o1.templateLabelTitulo + o1.templateLabelSubtitulo}
                    <div data-bind="
                        designbuttonall: { t: $root[p().id()].textoocr(), ty: $root[p().id()].tipo(), c: $root[p().id()].colortexto(), bg: $root[p().id()].colorfondo(), ancho: $root[p().id()].ancho() }">
                        <div class="btn" data-bind="
                            style: { pointerEvents: !$root[p().id()].habilitado() || $root.isQuery() ? 'none' : 'auto' },
                            click: function() { clickcustom('Veridas') },
                            css: [p().id(), $root[p().id()].ancho() === 'completo' ? 'btn-block' : '', $root[p().id()].tamaniocss(), !$root[p().id()].habilitado() || $root.isQuery()  ? 'disabled' : '', $root[$root.idPlantilla()].permitirsombrabotones() ? 'hasshadow' : ''].join(' ')">
                            <span class="pretext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                            <i class="fas fa-hand-point-up" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></i>
                            <span class="posttext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                        </div>
                        <br />
                        <span class="externtext text-bold" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                    </div>`,
                    synchronous: !0
                });

                ko.components.register("elemento-pagina", {
                    viewModel: componentViewModel,
                    template: `<div class="page row align-content-start" hidden style="min-height:300px;flex-direction:inherit" data-bind="
                    style: {
                        borderColor: $root[$root.idPlantilla()].colorbordeplantilla(),
                        borderStyle: 'solid',
                        borderWidth: $root[$root.idPlantilla()].grosorbordeplantilla() + 'px'
                	},
                    attr: { id: p().id },
                    css: [$root[p().id()].csselementoglobal(), $root[p().id()].nombreestilopersonal()].join(' '),
                    elementoLoaded: 1">
                </div>`,
                    synchronous: !0
                });

                ko.components.register("elemento-pagina-tab", {
                    viewModel: componentViewModel,
                    template: `<li class="nav-item" data-bind="
                    attr: {value: p().id, 'data-id': p().id(), hidden: !$root.isEditor() ? !$root[p().id()].visible() ||  !$root[p().id()].vertab() : false},
                    css: {disabled: !$root[p().id()].habilitado() },
                    click: function() { showpage(p().id(), !1); }">
                    <a href="#" data-bind="designtabs: $root[p().id()].habilitado() || $root[p().id()].activo() || $root[$root.idPlantilla()].estilotabs()" class="nav-link border d-flex d-sm-flex">
                        <span data-bind="style: {\'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\', \'font-family\': $root[$root.idPlantilla()].tipofuente() }, text: $root[p().id()].titulo" class="font-weight-bold py-1"></span>&nbsp;&nbsp;
                        <!-- ko if: $root.isEditor -->
                            <div class="d-flex d-sm-flex">
                                <!-- ko component: { name: "actions", params: { id: p().id(), tipo: p().tipo() } } --><!-- /ko -->
                            </div>
                        <!-- /ko -->
                    </a>
                </li>`,
                    synchronous: !1
                });

                ko.components.register("elemento-pdfocr", {
                    viewModel: componentViewModel,
                    template: `<div data-bind="
                    style: {
                        textAlign: $root[p().id()].alineadotexto,
                        fontStyle: $root[p().id()].estilotexto,
                        fontWeight: $root[p().id()].grosortexto
                    },
                    elementoLoaded: 1">${o1.templateErrorValidation}${o1.templateAsterisk}${o1.templateLabelTitulo}${o1.templateLabelSubtitulo}
                    <div class="text-center">
                        <div data-bind="
                            designbuttonall: { t: 'Agregar', ty: $root[p().id()].tipo(), c: $root[p().id()].colortextotomarfoto(), bg: $root[p().id()].colortomarfoto() },
                            attr: { hidden: !!$root[p().id()].anexo() && !!$root[p().id()].anexo().guidanexo }">
                            <div class="btn addpdf" data-bind="
                                css: { disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones() }">
                                <span class="pretext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                                <i class="far fa-images" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></i>
                                <span class="posttext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                            </div>
                            <br />
                            <span class="externtext text-bold" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                        </div>
                    </div>
                    <img data-bind="
                        attr: { src: $root[p().id()].anexo().thumb, hidden: !$root[p().id()].anexo().thumb ? true : $root[p().id()].anexo().thumb.length <= 0 }, 
                        click: function() { clickcustom('view') }" 
                        class="col-sm-4 col-4 img-thumbnail mx-auto mb-2" style="display:block; cursor:pointer;" />
                    <div style="text-align: center;">
                        <i class="fas fa-download img-thumbnail p-4 mb-2" style="font-size: 2.5em; cursor: pointer;" data-bind="
                            style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' },
                            attr: { hidden: $root[p().id()].nombrearchivo().length <= 0 || $root[p().id()].anexo().downloaded === true },
                            click: function() { clickcustom('view') }"></i>
                    </div>
                    <div class="actiondelete" data-bind="
                        designbuttonall: { t: 'Borrar', ty: $root[p().id()].tipo(), c: $root[p().id()].colortextoborrar(), bg: $root[p().id()].colorborrar() },
                        attr:{ hidden: !($root[p().id()].anexo().delete && _.isEmpty($root[p().id()].anteriornombrearchivo())) }">
                        <div class="btn" data-bind="
                            click: function() { clickcustom('delete') },
                            css:{ disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()}">
                            <span class="pretext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                            <i class="far fa-trash-alt" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></i>
                            <span class="posttext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                        </div>
                        <br />
                        <span class="externtext text-bold" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                    </div>
                    <div class="actionview" data-bind="
                        designbuttonall: { t: 'Ver', ty: $root[p().id()].tipo(), c: $root[p().id()].colortextovisualizar(), bg: $root[p().id()].colorvisualizar() },
                        attr:{ hidden: !($root[p().id()].anexo() && $root[p().id()].anexo().guidanexo) }">
                        <div class="btn" data-bind="
                            click: function() { clickcustom('view') },
                            css:{ disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()}">
                            <span class="pretext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                            <i class="fas fa-eye" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></i>
                            <span class="posttext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                        </div>
                        <br />
                        <span class="externtext text-bold" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                    </div>
                    <div class="actionreplace" data-bind="{
                        designbuttonall: { 
                            t: 'OCR', 
                            ty: $root[p().id()].tipo(), 
                            c: $root[p().id()].colortextovisualizar(), 
                            bg: $root[p().id()].colorvisualizar() 
                        },
                        attr: { 
                            hidden: !($root[p().id()].anexo() && $root[p().id()].anexo().guidanexo) || $root[p().id()].hasocrdata()
                        }
                    }">
                        <div class="btn" data-bind="
                            click: function() { clickcustom('ocrrecognizer') },
                            css:{disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()}">
                            <span class="pretext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                            <i class="fab fa-readme" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></i>
                            <span class="posttext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                        </div>
                        <br />
                        <span class="externtext text-bold" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                    </div>
                    <div class="actionreplace" data-bind="{
                        designbuttonall: { 
                            t: 'Mostrar resultados', 
                            ty: $root[p().id()].tipo(), 
                            c: $root[p().id()].colortextovisualizar(), 
                            bg: $root[p().id()].colorvisualizar() 
                        },
                        attr: { 
                            hidden: !$root[p().id()].hasocrdata()
                        }
                    }">
                        <div class="btn" data-bind="
                            click: function() { clickcustom('ocrresults') },
                            css:{disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()}">
                            <span class="pretext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                            <i class="fab fa-readme" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></i>
                            <span class="posttext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                        </div>
                        <br />
                        <span class="externtext text-bold" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                    </div>
                    <div class="actionreplace" data-bind="
                        designbuttonall: { t: 'Reemplazar', ty: $root[p().id()].tipo(), c: $root[p().id()].colortextoreemplazar(), bg: $root[p().id()].colorreemplazar() },
                        attr:{ hidden: !($root[p().id()].anexo() && $root[p().id()].anexo().docid > 0) }">
                        <div class="btn" data-bind="
                            click: function() { clickcustom('replace') },
                            css:{disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()}">
                            <span class="pretext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                            <i class="fas fa-undo" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></i>
                            <span class="posttext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                        </div>
                        <br />
                        <span class="externtext text-bold" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                    </div>
                    <div class="actioncancelreplace" data-bind="
                        designbuttonall: { t: 'Cancelar Reemplazo', ty: $root[p().id()].tipo(), c: $root[p().id()].colortextoborrar(), bg: $root[p().id()].colorborrar() },
                        attr:{ hidden: _.isEmpty($root[p().id()].anteriornombrearchivo())}">
                        <div class="btn" data-bind="
                            click: function() { clickcustom('cancelreplace') },
                            css:{disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()}">
                            <span class="pretext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                            <i class="fas fa-times-circle" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></i>
                            <span class="posttext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                        </div>
                        <br />
                        <span class="externtext text-bold" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></span>
                    </div>
                    <div class="p-1 text-center" data-bind="attr: { hidden: $root.isEditor() ? true : $root[p().id()].anexo() && $root[p().id()].anexo().docid === 0 && _.isEmpty($root[p().id()].anteriornombrearchivo()) ? !$root[p().id()].permisotipificar() : true}"><strong class="pr-1">Tipo de documento:</strong><br/><div data-bind="tipodoccombo:p().id()"></div></div>
                </div>`,
                    synchronous: !0
                });

                ko.components.register("elemento-rangofechas", {
                    viewModel: componentViewModel,
                    template: '<div data-bind="\
                    style: {\
                        textAlign: $root[p().id()].alineadotexto,\
                        fontStyle: $root[p().id()].estilotexto,\
                        fontWeight: $root[p().id()].grosortexto\
                    },\
                    elementoLoaded: 1">' + o1.templateErrorValidation + o1.templateAsterisk + o1.templateLabelTitulo + o1.templateLabelSubtitulo + '\
                    <input class="form-control" style="border-radius: 5px" data-bind="\
                        css: { \'hasError\' : $root[p().id()].haserror() },\
                        attr: { placeholder: $root[p().id()].mascara },\
                        disable: $root.isEditor() || $root.isQuery() ? true : !$root[p().id()].habilitado(),\
                        value: $root[p().id()].valormetadatorango" />\
                </div>',
                    synchronous: !0
                });

                ko.components.register("elemento-seccion", {
                    viewModel: componentViewModel,
                    template: `<div class="section droppedin sortable card mb-2 no-padding bg-white align-top" style="display:block;" data-bind="{
                        style: { 
                            marginRight: _.isEmpty($root[p().id()].margenderecho()) ? 0 : $root[p().id()].margenderecho(),
                            marginLeft: _.isEmpty($root[p().id()].margenizquierdo()) ? 0 : $root[p().id()].margenizquierdo()
                        },
                        css: [
                            $root[p().id()].csselementoglobal(), 
                            $root[p().id()].nombreestilopersonal()
                        ].join(' '),
                        attr: { 
                            id: p().id, 
                            hidden: $root.isEditor() ? 
                                ($root[p().id()].modotab() ? 
                                    ($root[p().id()].mostrar() ? false : true) : 
                                    false) : 
                                ($root[p().id()].modotab() ? 
                                    ($root[p().id()].mostrar() ? false : true) : 
                                    !$root[p().id()].visible()) 
                        },
                        elementoLoaded: 1,
                        style: {
                            borderColor: $root[p().id()].colorborde,
                            borderStyle: 'solid',
                            borderWidth: $root[p().id()].grosorborde() + 'px',
                        }
                    }">
                    <!-- ko if: !$root[p().id()].modotab() -->
                        <div class="card-header rounded-top" data-bind="
                            style: {
                                textAlign: $root[p().id()].alineadotexto,
                                backgroundColor: $root[p().id()].colorheader,
                                borderColor: $root[p().id()].colorheader,
                                color: $root[p().id()].colorheadertexto,
                                'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                            },
                            attr: { hidden : $root[p().id()].ocultartitulo() }">
                            <span data-bind="
                                text: $root[p().id()].titulo,
                                style: {
                                    fontStyle: $root[p().id()].estilotexto,
                                    fontWeight: $root[p().id()].grosortexto,
                                    textDecoration: $root[p().id()].decoraciontexto
                                }"></span>
                            <span class="float-right" style="cursor:pointer;">
                                <i data-bind="css: $root[p().id()].sectioncollapsed() ? 'fa fa-plus' : 'fa fa-minus', attr: {hidden: !$root[p().id()].permitecontraer()},
                                click: function(data, event) { $root[p().id()].sectioncollapsed(!$root[p().id()].sectioncollapsed()) }"></i>
                                <i class="fas fa-window-maximize" data-bind="attr: {hidden: $root.modalIsShown()||$root.isEditor()||!$root[p().id()].permitemodal()}, click:function() { clickcustom() }"  style="padding-left:10px"></i>
                            </span>
                        </div>
                        <!-- ko if: $parent.isEditor -->
                            <div class="actions no-padding text-right float-right">
                                <!-- ko component: { name: "actions", params: { id: p().id(), tipo: p().tipo() } } --><!-- /ko -->
                            </div>
                        <!-- /ko -->
                    <!-- /ko -->
                    <div class="row card-body section-body p-1" style="min-height:48px;" data-bind="attr: {hidden: $root[p().id()].sectioncollapsed}">
                    </div>
                </div>`,
                    synchronous: !0
                });

                ko.components.register("elemento-tabber", {
                    viewModel: componentViewModel,
                    template: '<div class="align-top tabber droppedin sortable card bg-white no-padding" data-bind="\
                    css: [ !$root.isEditor() ? \'no-border\' : \'\', $root[p().id()].csselementoglobal(), $root[p().id()].nombreestilopersonal()].join(\' \'),\
                    attr: { id: p().id, hidden: !$root.isEditor() ? !$root[p().id()].visible() : false },\
                    elementoLoaded: 1">\
                    <!-- ko if: $parent.isEditor -->\
                        <div class="card-header row">\
                            <span data-bind="text: he.decode($root[p().id()].titulo())"></span>\
                            <div class="actions no-padding text-right">\
                                <!-- ko component: { name: "actions", params: { id: p().id(), tipo: p().tipo() } } --><!-- /ko -->\
                            </div>\
                        </div>\
                    <!-- /ko -->\
                    <div class="card-body tabber-body row p-1">\
                        <ul class="nav nav-tabs navtabber" data-bind="attr: {hidden: _.isEmpty($root[p().id()].tabids())}">\
                            <!-- ko foreach: { data: $root[p().id()].tabids(), as: \'tab\' } -->\
                                <li class="nav-item" data-bind="\
                                    attr: {value: tab, \'data-id\': tab, hidden: $root.isEditor() ? false : !$root[tab].visible()  },\
                                    click: function() { $parent.showtab(tab); }">\
                                    <a class="nav-link border d-flex d-sm-flex" href="#" data-bind="\
                                        style: {\
                                            color: $root[tab].habilitado() ? ($root[tab].activo() ? $root[$root.idPlantilla()].colortabtextoactivo() : $root[$root.idPlantilla()].colortabtextonormal()) : $root[$root.idPlantilla()].colortabtextoinhabilitado(),\
                                            backgroundColor: $root[tab].habilitado() ? ($root[tab].activo() ? $root[$root.idPlantilla()].colortabactivo() : $root[$root.idPlantilla()].colortabnormal()) : $root[$root.idPlantilla()].colortabinhabilitado()\
                                        }">\
                                        <span class="font-weight-bold py-1" data-bind="\
                                            text: $root[tab].titulo,\
                                            attr: { hidden : $root[tab].ocultartitulo() }"></span>\
                                        <!-- ko if: $root.isEditor -->\
                                            <div style="display:inline-flex">\
                                                <!-- ko component: { name: "actions", params: { id: tab, tipo: $root[tab].tipo() } } --><!-- /ko -->\
                                            </div>\
                                        <!-- /ko -->\
                                    </a>\
                                </li>\
                            <!-- /ko -->\
                        </ul>\
                    </div>\
                </div>',
                    synchronous: !0
                });

                ko.components.register("elemento-tabla", {
                    viewModel: componentViewModel,
                    template: '<div class="tabla droppedin sortable card mb-2 no-padding bg-white align-top" style="display:block" data-bind="\
                    css: [$root[p().id()].csselementoglobal(), $root[p().id()].nombreestilopersonal()].join(\' \'),\
                    attr: { id: p().id, hidden: $root.isEditor() ? false : !$root[p().id()].visible() },\
                    elementoLoaded: 1,\
                    style: {\
                        marginRight: _.isEmpty($root[p().id()].margenderecho()) ? 0 : $root[p().id()].margenderecho(),\
                        marginLeft: _.isEmpty($root[p().id()].margenizquierdo()) ? 0 : $root[p().id()].margenizquierdo(),\
                        borderColor: $root[p().id()].colorborde,\
                        borderWidth: $root[p().id()].grosorborde() + \'px\',\
                    }">\
                    <div class="card-header rounded-top p-2" data-bind="\
                        style: {\
                            backgroundColor: $root[p().id()].colorheader,\
                            borderColor: $root[p().id()].colorheader,\
                            color: $root[p().id()].colorheadertexto\
                        }">\
                        <div data-bind="\
                            style: {\
                                textAlign: $root[p().id()].alineadoencabezadotabla,\
                                fontStyle: $root[p().id()].estilotexto,\
                                fontWeight: $root[p().id()].grosortexto}">'
                        + o1.templateErrorValidation + o1.templateAsterisk + '<i title="Filtrar tabla" class="fas fa-filter mx-2 text-muted btn no-padding mt-1 float-left" data-bind="filterLoaded: \'rowfilter\', attr: {hidden: $root.isEditor() ? true : !$root[p().id()].permisofiltrado()}"></i>' + o1.templateLabelTitulo + '\
                            <div data-bind="attr:{hidden: $root.isEditor()}, filterLoaded: \'tablestylefilter\'" class="position-relative float-right" title="Vistas"><div class="btn btn-light border btn-sm"><i class="fas fa-th-list"></i></div></div>\
                                <div class="btn btn-light btn-sm float-right no-border headertablebuttons my-0 mr-2" data-bind="\
                                    click: function() { clickcustom(\'tableshowadd\') },\
                                    css: { hasshadow: $root[$root.idPlantilla()].permitirsombrabotones(), disabled: $root.isQuery()},\
                                    attr: { hidden: !$root[p().id()].permisotablamostrar()},\
                                    style: { color: $root[p().id()].colorbotonnuevotexto(), backgroundColor: $root[p().id()].colorbotonnuevo() }">\
                                    <span data-bind="style: {\'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\', \'font-family\': $root[$root.idPlantilla()].tipofuente() }, text: $root[p().id()].botonnuevotexto()"></span>\
                                </div>\
                                <div class="btn btn-light btn-sm float-right no-border headertablebuttons my-0 mr-2" data-bind="\
                                    click: function() { if (!$root.isEditor()) clickcustom(\'multi\') },\
                                    css: { hasshadow: $root[$root.idPlantilla()].permitirsombrabotones(), disabled: $root.isQuery()},\
                                    attr: { hidden: $root[p().id()].permisotablamultiedicion() ? (!$root.isEditor() ? !_.filter($root[p().id()].valorjson(), function(f) { return f.Acciones.checked(); }).length : false) : true},\
                                    style: { color: $root[p().id()].colorbotonnuevotexto(), backgroundColor: $root[p().id()].colorbotonnuevo()}">\
                                    <span data-bind="style: {\'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\', \'font-family\': $root[$root.idPlantilla()].tipofuente() }">Multi-Edici&oacute;n</span>\
                                </div>\
                                <div class="btn btn-light btn-sm float-right no-border headertablebuttons btn-file my-0 mr-2" data-bind="\
                                    attr: { hidden: !$root[p().id()].permisotablaimportarr()},\
                                    style: {color: $root[p().id()].colorbotonnuevotexto(), backgroundColor: $root[p().id()].colorbotonnuevo()},\
                                    css: { hasshadow: $root[$root.idPlantilla()].permitirsombrabotones(), disabled: $root.isQuery()}">\
                                    <span data-bind="style: {\'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\', \'font-family\': $root[$root.idPlantilla()].tipofuente() }, text: $root[p().id()].botonimportartexto"></span>\
                                    <input id="atrimptable" type="file" accept=".csv" data-bind="event: {change: function(it,ev) { !$root.isEditor() && clickcustom([\'importTable\', ev.target])}}">\
                                </div>\
                        </div>\
                        <!-- ko if: $parent.isEditor -->\
                            <div class="actions no-padding text-right float-right">\
                                <!-- ko component: { name: "actions", params: { id: p().id(), tipo: p().tipo() } } --><!-- /ko -->\
                            </div>\
                        <!-- /ko -->\
                    </div>\
                    <div class="card-body tabla-content row text-center no-padding w-100" data-bind="attr: { hidden: $root.isEditor() }">'+ o1.templateLabelSubtitulo + '\
                        <div class="table-responsive">\
                            <table class="table table-striped table-bordered table-hover table-condensed tableelem" style="max-height: 100px;" data-bind="\
                                attr: {hidden : !$root[p().id()].valorjson().length}, \
                                css: [$root[p().id()].permisocuadricula() ? \'visiblegrid\' : \'\', $root[p().id()].alternarcolorfilas() ? \'alternatecolor\' : \'\',\
                                    $root[p().id()].modetable()].join(\' \')">\
                                <thead>\
                                    <tr data-bind="\
                                        attr: {\
                                            style : \'color: \' + $root[p().id()].colorencabezadotextotabla() + \'; background-color: \' + $root[p().id()].colorencabezadotabla() + \';\'\
                                        }">\
                                        <th class="text-center" style="width: 150px; border:1px solid lightgray" data-bind="attr:{hidden: !$root[p().id()].permisotablaseleccionarr() && !$root[p().id()].permisotablaeditarxfila() && !$root[p().id()].permisotablaeliminarr()}">\
                                            <input type="checkbox" data-bind="attr: {hidden: !$root[p().id()].permisotablaseleccionarr()}, disable: $root.isQuery(),\
                                                click: function(dd, evv) { event(6, p().id(), [\'checkall\', evv.target.checked]); return true; }" />&nbsp;&nbsp;&nbsp;Acciones</th>\
                                        <!-- ko if: $root[p().id()].mostrarconsecutivofila -->\
                                            <th class="text-center" style="min-width: 50px; border: 1px solid lightgray; max-width: 150px;">Consecutivo</th>\
                                        <!-- /ko -->\
                                        <!-- ko foreach: { data: _.takeRight($root[p().id()].nombrecolumnas(), $root[p().id()].nombrecolumnas().length - 1) } -->\
                                            <!--ko if: $root[$parent.p().id()].columnasvisualizar()[$data.id] -->\
                                                <th class="text-center" data-bind="text: $root[$data.id].titulo()" style="min-width: 50px; max-width: 150px; border:1px solid lightgray;"></th>\
                                            <!-- /ko -->\
                                        <!-- /ko -->\
                                    </tr>\
                                </thead>\
                                <tbody>\
                                    <!-- ko foreach: { data: $root[p().id()].valorjson, as: \'row\' } -->\
                                        <tr data-bind="\
                                            tableLoaded: \'row\',\
                                            attr: {hidden: row.Acciones.visible ? !row.Acciones.visible() : false },\
                                            style: {\
                                                backgroundColor: row.Acciones.id() === $root[$parent.p().id()].rowediting() ? \'lightblue\' : row.Acciones.checked() ? \'wheat\' : \'\',\
                                                textAlign: $root[$parent.p().id()].alineadotexto\
                                            }">\
                                            <td class="text-center" style="width:150px; white-space: nowrap;" \
                                                    data-bind="attr:{hidden: !$root[$parent.p().id()].permisotablaseleccionarr() && !$root[$parent.p().id()].permisotablaeditarxfila() && !$root[$parent.p().id()].permisotablaeliminarr()}">\
                                                <input type="checkbox" data-bind="\
                                                    attr: {hidden: $root[$parent.p().id()].permisotablaseleccionarr() ? !row.Acciones.allowselect() : true},\
                                                    checked: row.Acciones.checked,\
                                                    click: function(dd, evv) { $parent.event(6, $parent.p().id(), [\'check\', evv.target.checked, row.Acciones.id()]); return true; },\
                                                    disable: $root.isQuery()"/>\
                                                <div class="btn text-blue px-2 py-1 ml-3 border bg-white" data-bind="\
                                                    click: function() { if(!$root.isQuery()) $parent.event(6, $parent.p().id(), [\'editing\', row.Acciones.id()]); },\
                                                    attr:{disabled: $root.isQuery(), hidden : $root[$parent.p().id()].permisotablaeditarxfila() ? !row.Acciones.allowedit() : true }">\
                                                    <i class="fas fa-pencil-alt"></i></div>\
                                                <div class="btn text-red px-2 py-1 border bg-white" data-bind="\
                                                    click: function() { if(!$root.isQuery()) $parent.event(6, $parent.p().id(), [\'remove\', row.Acciones.id()]); },\
                                                    attr:{disabled: $root.isQuery(), hidden : $root[$parent.p().id()].permisotablaeliminarr() ? !row.Acciones.allowdelete() : true}">\
                                                    <i class="far fa-trash-alt"></i></div>\
                                            </td>\
                                            <!-- ko if: $root[$parent.p().id()].mostrarconsecutivofila -->\
                                                <td style="min-width: 50px; max-width: 150px;">\
                                                    <span data-bind="text: $index() + 1"></span>\
                                                </td>\
                                            <!-- /ko -->\
                                            <!-- ko foreach: { data: _.takeRight($root[$parent.p().id()].nombrecolumnas(), $root[$parent.p().id()].nombrecolumnas().length - 1), as: \'col\' } -->\
                                                <!--ko if: $root[$component.p().id()].columnasvisualizar()[col.id] -->\
                                                    <td class="px-2 position-relative" style="min-width: 50px; max-width: 200px;" data-bind="tableLoaded: \'col\', css: { \
                                                        hasError: row[col.id] ? row[col.id].haserror ? row[col.id].haserror().toString() === \'true\' ? true : false : false : false \
                                                    }, style: { \
                                                        visibility: row[col.id] ? \
                                                                        row[col.id].colvisible ? \
                                                                            row[col.id].colvisible() ? \
                                                                                !_.isEmpty(row[col.id].colvisible().toString()) ? \
                                                                                    row[col.id].colvisible().toString() === \'false\' ? \'hidden\'\
                                                                                    : \'visible\'\
                                                                                : \'visible\'\
                                                                            : \'visible\'\
                                                                        : \'visible\'\
                                                                    : \'visible\' \
                                                    }"></td>\
                                                <!-- /ko -->\
                                            <!-- /ko -->\
                                        </tr>\
                                    <!-- /ko -->\
                                </tbody>\
                                <tfoot class="font-weight-bold bg-gray" data-bind="if: $root[p().id()].vertotales()">\
                                    <tr>\
                                        <td>Total:</td>\
                                        <!-- ko foreach: { data: _.takeRight( $root[p().id()].nombrecolumnas(),  $root[p().id()].nombrecolumnas().length - 1), as: \'col\' } -->\
                                            <!--ko if: $root[$parent.p().id()].columnasvisualizar()[$data.id] -->\
                                                <td class="px-2 position-relative" style="min-width: 50px; max-width: 200px;" data-bind="text: $root[$parent.p().id()].sumatoriacolumnas()[col.id]"></td>\
                                            <!-- /ko -->\
                                        <!-- /ko -->\
                                    </tr>\
                                </tfoot>\
                            </table>\
                        </div>\
                    </div>\
                    <div class="card-body tabla-body row p-1 col-sm-12 col-12" style="min-height: 48px;" data-bind="attr: {hidden: !$root.isEditor() && !$root[p().id()].addrow()}">\
                    </div>\
                    <div class="card-body tabla-footer pt-0 px-2 pb-2 text-right" style="min-height:0px;" data-bind="attr:{hidden: !$root.isEditor() && !$root[p().id()].addrow()}">\
                        <div class="btn btn-light no-border mr-2 mt-2" data-bind="\
                            click: function() { clickcustom([\'closeclear\']); },\
                            attr: { disabled: $root.isQuery(), hidden: !$root[p().id()].permisotablacerrar()},\
                            css: { hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()},\
                            style: { color: $root[p().id()].colorbotoncerrartexto(), backgroundColor: $root[p().id()].colorbotoncerrar() }">\
                            <span data-bind="style: {\'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\', \'font-family\': $root[$root.idPlantilla()].tipofuente() }, text: $root[p().id()].botoncerrartexto()"></span>\
                        </div>\
                        <div class="btn btn-light no-border mr-2 mt-2" data-bind="\
                            click: function() { clickcustom([\'clear\']); },\
                            attr: { disabled: $root.isQuery(), hidden: !$root[p().id()].permisotablalimpiar() ? true : $root[p().id()].modeedit()},\
                            css: { hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()},\
                            style: { color: $root[p().id()].colorbotonlimpiartexto(), backgroundColor: $root[p().id()].colorbotonlimpiar() }">\
                            <span data-bind="style: {\'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\', \'font-family\': $root[$root.idPlantilla()].tipofuente() }, text: $root[p().id()].botonlimpiartexto()"></span>\
                        </div>\
                        <div class="btn btn-light no-border mr-2 mt-2" data-bind="\
                            click: function() { clickcustom([\'addclear\']); },\
                            attr: { disabled: $root.isQuery(), hidden: !$root[p().id()].permisotablaagregarcerrarr() ? true : $root[p().id()].modeedit()},\
                            css: { hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()},\
                            style: { color: $root[p().id()].colorbotonagregarcerrartexto(), backgroundColor: $root[p().id()].colorbotonagregarcerrar() }">\
                            <span data-bind="style: {\'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\', \'font-family\': $root[$root.idPlantilla()].tipofuente() }, text: $root[p().id()].botonagregarcerrartexto()"></span>\
                        </div>\
                        <div class="btn btn-light no-border mr-2 mt-2" data-bind="\
                            click: function() { clickcustom([\'tableadd\']); },\
                            attr: { disabled: $root.isQuery(), hidden: !$root[p().id()].permisotablaagregarr() ? true : $root[p().id()].modeedit()},\
                            css: { hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()},\
                            style: { color: $root[p().id()].colorbotonagregartexto(), backgroundColor: $root[p().id()].colorbotonagregar() }">\
                            <span data-bind="style: {\'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\', \'font-family\': $root[$root.idPlantilla()].tipofuente() }, text: $root[p().id()].botonagregartexto()"></span>\
                        </div>\
                        <div class="btn btn-light no-border mr-2 mt-2" data-bind="\
                            click: function() { clickcustom([\'edit\']); },\
                            attr: { disabled: $root.isQuery(), hidden: !$root[p().id()].permisotablaeditarr() ? true : !$root[p().id()].modeedit()},\
                            css: { hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()},\
                            style: { color: $root[p().id()].colorbotoneditartexto(), backgroundColor: $root[p().id()].colorbotoneditar() }">\
                            <span data-bind="style: {\'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\', \'font-family\': $root[$root.idPlantilla()].tipofuente() }, text: $root[p().id()].botoneditartexto()"></span>\
                        </div>\
                    </div>\
                </div>',
                    synchronous: !0
                });

                ko.components.register("elemento-textarea", {
                    viewModel: componentViewModel,
                    template: '<div data-bind="\
                    style: {\
                        textAlign: $root[p().id()].alineadotexto,\
                        fontStyle: $root[p().id()].estilotexto,\
                        fontWeight: $root[p().id()].grosortexto\
                    },\
                    elementoLoaded: 1">' + o1.templateErrorValidation + o1.templateAsterisk + o1.templateLabelTitulo + o1.templateLabelSubtitulo + '\
                    <textarea class="form-control" style="border-radius: 5px" data-bind="\
                        css: { \'hasError\' : $root[p().id()].haserror() },\
                        attr: { placeholder: $root[p().id()].mascara, maxlength: $root[p().id()].longitudmaxima && $root[p().id()].longitudmaxima() > 0 ? $root[p().id()].longitudmaxima() : \'\'  },\
                        style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\', \'font-family\': $root[$root.idPlantilla()].tipofuente(), height: $root[p().id()].alturacampo() + \'px\' },\
                        disable: $root.isEditor() || $root.isQuery() ? true : !$root[p().id()].habilitado(),\
                        value: $root[p().id()].valor"></textarea>\
                </div>',
                    synchronous: !0
                });

                ko.components.register("elemento-texto", {
                    viewModel: componentViewModel,
                    template: '<div data-bind="\
                    style: {\
                        textAlign: $root[p().id()].alineadotexto,\
                        fontStyle: $root[p().id()].estilotexto,\
                        fontWeight: $root[p().id()].grosortexto\
                    },\
                    elementoLoaded: 1">' + o1.templateErrorValidation + o1.templateAsterisk + o1.templateLabelTitulo + o1.templateLabelSubtitulo +
                        '<input class="form-control" style="border-radius: 5px" data-bind="\
                        style: {\'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\', \'font-family\': $root[$root.idPlantilla()].tipofuente() },\
                        css: { \'hasError\' : $root[p().id()].haserror() },\
                        attr: { placeholder: $root[p().id()].mascara, type: typeinput(), autocomplete: typeinput(), maxlength: $root[p().id()].longitudmaxima && $root[p().id()].longitudmaxima() > 0 ? $root[p().id()].longitudmaxima() : \'\' },\
                        disable: $root.isEditor() || $root.isQuery() ? true : !$root[p().id()].habilitado(),\
                        value: $root[p().id()].valormetadato" >' + o1.templateMascara +
                        '</div>',
                    synchronous: !0
                });

                ko.components.register("elemento-textogenerico", {
                    viewModel: componentViewModel,
                    template: '<div data-bind="\
                    style: {\
                        textAlign: $root[p().id()].alineadotexto,\
                        fontStyle: $root[p().id()].estilotexto,\
                        fontWeight: $root[p().id()].grosortexto\
                    },\
                    elementoLoaded: 1">' + o1.templateErrorValidation + o1.templateAsterisk + o1.templateLabelTitulo + o1.templateLabelSubtitulo +
                        '<div class="input-group"><input class="form-control" style="border-radius: 5px" data-bind="\
                        css: { \'hasError\' : $root[p().id()].haserror() },\
                        attr: { placeholder: $root[p().id()].mascara, type: typeinput(), autocomplete: typeinput(), maxlength: $root[p().id()].longitudmaxima && $root[p().id()].longitudmaxima() > 0 ? $root[p().id()].longitudmaxima() : \'\' },\
                        disable: $root.isEditor() || $root.isQuery() ? true : !$root[p().id()].habilitado(),\
                        value: $root[p().id()].valor" ><span class="mostrarpassword btn"></span>' + o1.templateMascara +
                        '</div></div>',
                    synchronous: !0
                });

                ko.components.register("elemento-video", {
                    viewModel: componentViewModel,
                    template: '<div data-bind="\
                    style: {\
                        textAlign: $root[p().id()].alineadotexto,\
                        fontStyle: $root[p().id()].estilotexto,\
                        fontWeight: $root[p().id()].grosortexto\
                    },\
                    elementoLoaded: 1">' + o1.templateErrorValidation + o1.templateAsterisk + o1.templateLabelTitulo + o1.templateLabelSubtitulo + '\
                    <div class="btn px-2 py-1" data-bind="\
                        style: {backgroundColor: $root[p().id()].colortomarvideo(), color: $root[p().id()].colortextotomarvideo()},\
                        click: function() { clickcustom(\'video\') },\
                        css:{ disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()},\
                        attr: { hidden: !$root[p().id()].permisocamara() ? true : !!$root[p().id()].anexo() && !!$root[p().id()].anexo().guidanexo }">\
                        <i class="fas fa-play pr-2" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></i>\
                        <span class="posttext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }">C&aacute;mara</span>\
                    </div>\
                    <div class="btn px-2 py-1" data-bind="\
                        style: {backgroundColor: $root[p().id()].colorimportar(), color: $root[p().id()].colortextoimportar()},\
                        click: function() { clickcustom(\'import\') },\
                        css:{ disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()},\
                        attr:{ hidden: !$root[p().id()].permisoimportar() ? true : !!$root[p().id()].anexo() && !!$root[p().id()].anexo().guidanexo }">\
                        <i class="fas fa-file-import pr-2" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></i>\
                        <span class="posttext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }">Importar</span>\
                    </div>\
                    <div class="btn px-2 py-1" data-bind="\
                        style: {backgroundColor: $root[p().id()].colorvisualizar(), color: $root[p().id()].colortextovisualizar()},\
                        click: function() { clickcustom(\'view\') },\
                        css:{ disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()},\
                        attr: { hidden: !($root[p().id()].anexo() && $root[p().id()].anexo().guidanexo)}">\
                        <i class="fas fa-eye pr-2" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></i>\
                        <span class="posttext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }">Reproducir</span>\
                    </div>\
                    <div class="btn px-2 py-1" data-bind="\
                        style: {backgroundColor: $root[p().id()].colorborrar(), color: $root[p().id()].colortextoborrar()},\
                        click: function() { clickcustom(\'delete\') },\
                        css:{ disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()},\
                        attr: { hidden: !($root[p().id()].anexo().delete && _.isEmpty($root[p().id()].anteriornombrearchivo())) }">\
                        <i class="far fa-trash-alt pr-2" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></i>\
                        <span class="posttext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }">Borrar</span>\
                    </div>\
                    <div class="btn px-2 py-1" data-bind="\
                        style: {backgroundColor: $root[p().id()].colorreemplazar(), color: $root[p().id()].colortextoreemplazar()},\
                        click: function() { clickcustom(\'replace\') },\
                        css:{disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()},\
                        attr: {hidden: !($root[p().id()].anexo() && $root[p().id()].anexo().docid > 0) }">\
                        <i class="fas fa-undo pr-2" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></i>\
                        <span class="posttext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }">Reemplazar</span>\
                    </div>\
                    <div class="btn px-2 py-1" data-bind="\
                        style: {backgroundColor: $root[p().id()].colorborrar(), color: $root[p().id()].colortextoborrar()},\
                        click: function() { clickcustom(\'cancelreplace\') },\
                        css:{disabled: $root.isQuery() ? true: !$root[p().id()].habilitado(), hasshadow: $root[$root.idPlantilla()].permitirsombrabotones()},\
                        attr: {hidden: _.isEmpty($root[p().id()].anteriornombrearchivo())}">\
                        <i class="fas fa-undo pr-2" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }"></i>\
                        <span class="posttext" data-bind="style: { \'font-size\': ($root[$root.idPlantilla()].tamanofuente() / 10) + \'rem\' }">Cancelar Reemplazo</span>\
                    </div><div class="p-1 text-center" data-bind="attr: { hidden: $root.isEditor() ? true : $root[p().id()].anexo() && $root[p().id()].anexo().docid === 0 ? !$root[p().id()].permisotipificar() : true}"><strong class="pr-1">Tipo de documento:</strong><br/><div data-bind="tipodoccombo:p().id()"></div></div>\
                </div>',
                    synchronous: !0
                });

                ko.components.register("elemento-wizard", {
                    viewModel: componentViewModel,
                    template: '<div class="d-flex" data-bind="elementoLoaded: 1,\
                        style: { justifyContent: $root[p().id()].alineadotexto, fontStyle: $root[p().id()].estilotexto, fontWeight: $root[p().id()].grosortexto }">' + o1.templateErrorValidation + o1.templateAsterisk +
                        '<div data-bind="style: { width: $root[p().id()].ancho() === \'completo\' ? \'100%\' : \'fit-content\'}" ><div class="prev btn no-border" data-bind="\
                        html: wizardtexto(1),\
                        css: {disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(),\
                              hasshadow: $root[$root.idPlantilla()].permitirsombrabotones(),\
                              \'btn-block mb-1\' : $root[p().id()].ancho ? $root[p().id()].ancho() === \'completo\' : false },\
                        attr: { hidden: !$root[p().id()].visibleregresar() },\
                        style: { color: $root[p().id()].colortextoregresar(), backgroundColor: $root[p().id()].colorfondoregresar()},\
                        click: function() { clickcustom(\'backward\'); }"></div>\
                    <div class="next btn no-border" data-bind="\
                        html: wizardtexto(2),\
                        css: {disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(),\
                              hasshadow: $root[$root.idPlantilla()].permitirsombrabotones(),\
                              \'btn-block mb-1\' : $root[p().id()].ancho ? $root[p().id()].ancho() === \'completo\' : false },\
                        attr: { hidden: !$root[p().id()].visibleavanzar() },\
                        style: { color: $root[p().id()].colortextoavanzar(), backgroundColor: $root[p().id()].colorfondoavanzar() },\
                        click: function() { clickcustom(\'forward\'); }"></div>\
                    <div class="finish btn no-border" data-bind="\
                        html: wizardtexto(3),\
                        css: {disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(),\
                              hasshadow: $root[$root.idPlantilla()].permitirsombrabotones(),\
                              \'btn-block mb-1\' : $root[p().id()].ancho ? $root[p().id()].ancho() === \'completo\' : false },\
                        attr: { hidden: !$root[p().id()].visiblefinalizar() },\
                        style: { color: $root[p().id()].colortextofinalizar(), backgroundColor: $root[p().id()].colorfondofinalizar() },\
                        click: function() { clickcustom(\'finish\'); }"></div>\
                   <div class="text-center pt-1" data-bind="attr:{hidden: !$root[p().id()].visiblepaginado()}, text: $root[p().id()].valinit() + \' de \' + $root[p().id()].valfin()"></div>\
                </div></div>',
                    synchronous: !0
                });
            }

            ko.components.register("actions", {
                viewModel: function (p) {
                    p.menu = function () { drawAttributes(this.id()); };
                    p.changerequired = function () { var o = getOpts(); o.appvm[this.id()].requerido && o.appvm[this.id()].requerido(!o.appvm[this.id()].requerido()); };
                    p.hasrequired = function () { var o = getOpts(); return _.isFunction(o.appvm[this.id()].requerido); };
                    p.changeenabled = function () { var o = getOpts(); o.appvm[this.id()].habilitado && o.appvm[this.id()].habilitado(!o.appvm[this.id()].habilitado()); };
                    p.hasenabled = function () { var o = getOpts(); return _.isFunction(o.appvm[this.id()].habilitado); };
                    p.changevisibility = function () { var o = getOpts(); o.appvm[this.id()].visible && o.appvm[this.id()].visible(!o.appvm[this.id()].visible()); };
                    p.hasvisibility = function () { var o = getOpts(); return _.isFunction(o.appvm[this.id()].visible); };
                    p.iconrequired = function () { var o = getOpts(); return (o.appvm[this.id()].requerido && o.appvm[this.id()].requerido() ? "fa-solid fa-asterisk" : "fa-solid fa-terminal"); };
                    p.iconenabled = function () { var o = getOpts(); return (o.appvm[this.id()].habilitado && o.appvm[this.id()].habilitado() ? "fas fa-toggle-on" : "fas fa-toggle-off"); };
                    p.iconvisible = function () { var o = getOpts(); return (o.appvm[this.id()].visible && o.appvm[this.id()].visible() ? "fa-solid fa-eye" : "fa-solid fa-eye-slash"); };
                    return ko.observable(ko.mapping.fromJS(p));
                },
                template: `<div data-bind="{
                        click: changerequired, 
                        clickBubble: false, 
                        attr: { 
                            hidden: !hasrequired()
                        }
                    }" class="btn btn-light bg-white border-0" title="requerido">
                    <i data-bind="{
                            css: [iconrequired()].join(' ')
                        }" class="fas " style="color: black;"></i>
                </div>
                <div data-bind="{
                        click: changeenabled, 
                        clickBubble: false, 
                        attr: { 
                            hidden: !hasenabled() 
                        }
                    }" class="btn btn-light bg-white border-0" title="habilitado">
                    <i data-bind="{
                            css: [iconenabled()].join(' ')
                        }" class="fas "></i>
                </div>
                <div data-bind="{
                        click: changevisibility, 
                        clickBubble: false, 
                        attr: { 
                            hidden: !hasvisibility() 
                        }
                    }" class="btn btn-light bg-white border-0" title="visibilidad">
                    <i data-bind="{
                            css: [iconvisible()].join(' ')
                        }" class="fas "></i>
                </div>
                <div data-bind="{
                        click: menu,
                        clickBubble: false
                    }" class="btn btn-light bg-purple border-0" title="acciones">
                    <i class="fas fa-ellipsis-v"></i>
                </div>`,
                synchronous: !0
            });

            //#region funciones especiales para KO
            {
                ko.bindingHandlers.formatofecha = {
                    init: function (ele, vacc, _allBindings, vm) {
                        var formato = vacc().formato, separador = vacc().separador;

                        if (formato === "d/m/Y") {
                            if (separador === "/") $(ele).text("dd/mm/yyyy");
                            else if (separador === "_") $(ele).text("dd_mm_yyyy");
                            else if (separador === ".") $(ele).text("dd.mm.yyyy");
                            else if (separador === "-") $(ele).text("dd-mm-yyyy");
                        }
                        else if (formato === "j/n/y") {
                            if (separador === "/") $(ele).text("d/m/yy");
                            else if (separador === "_") $(ele).text("d_m_yy");
                            else if (separador === ".") $(ele).text("d.m.yy");
                            else if (separador === "-") $(ele).text("d-m-yy");
                        }
                        else if (formato === "m/d/Y") {
                            if (separador === "/") $(ele).text("mm/dd/yyyy");
                            else if (separador === "_") $(ele).text("mm_dd_yyyy");
                            else if (separador === ".") $(ele).text("mm.dd.yyyy");
                            else if (separador === "-") $(ele).text("mm-dd-yyyy");
                        }
                        else if (formato === "n/j/y") {
                            if (separador === "/") $(ele).text("m/d/yy");
                            else if (separador === "_") $(ele).text("m_d_yy");
                            else if (separador === ".") $(ele).text("m.d.yy");
                            else if (separador === "-") $(ele).text("m-d-yy");
                        }
                        else if (formato === "Y/m/d") {
                            if (separador === "/") $(ele).text("yyyy/mm/dd");
                            else if (separador === "_") $(ele).text("yyyy_mm_dd");
                            else if (separador === ".") $(ele).text("yyyy.mm.dd");
                            else if (separador === "-") $(ele).text("yyyy-mm-dd");
                        }
                        else if (formato === "y/n/j") {
                            if (separador === "/") $(ele).text("yy/m/d");
                            else if (separador === "_") $(ele).text("yy_m_d");
                            else if (separador === ".") $(ele).text("yy.m.d");
                            else if (separador === "-") $(ele).text("yy-m-d");
                        }
                    },
                    update: function (ele, vacc, _allBindings, vm) {
                        var formato = vacc().formato, separador = vacc().separador;

                        if (formato === "d/m/Y") {
                            if (separador === "/") $(ele).text("dd/mm/yyyy");
                            else if (separador === "_") $(ele).text("dd_mm_yyyy");
                            else if (separador === ".") $(ele).text("dd.mm.yyyy");
                            else if (separador === "-") $(ele).text("dd-mm-yyyy");
                        }
                        else if (formato === "j/n/y") {
                            if (separador === "/") $(ele).text("d/m/yy");
                            else if (separador === "_") $(ele).text("d_m_yy");
                            else if (separador === ".") $(ele).text("d.m.yy");
                            else if (separador === "-") $(ele).text("d-m-yy");
                        }
                        else if (formato === "m/d/Y") {
                            if (separador === "/") $(ele).text("mm/dd/yyyy");
                            else if (separador === "_") $(ele).text("mm_dd_yyyy");
                            else if (separador === ".") $(ele).text("mm.dd.yyyy");
                            else if (separador === "-") $(ele).text("mm-dd-yyyy");
                        }
                        else if (formato === "n/j/y") {
                            if (separador === "/") $(ele).text("m/d/yy");
                            else if (separador === "_") $(ele).text("m_d_yy");
                            else if (separador === ".") $(ele).text("m.d.yy");
                            else if (separador === "-") $(ele).text("m-d-yy");
                        }
                        else if (formato === "Y/m/d") {
                            if (separador === "/") $(ele).text("yyyy/mm/dd");
                            else if (separador === "_") $(ele).text("yyyy_mm_dd");
                            else if (separador === ".") $(ele).text("yyyy.mm.dd");
                            else if (separador === "-") $(ele).text("yyyy-mm-dd");
                        }
                        else if (formato === "y/n/j") {
                            if (separador === "/") $(ele).text("yy/m/d");
                            else if (separador === "_") $(ele).text("yy_m_d");
                            else if (separador === ".") $(ele).text("yy.m.d");
                            else if (separador === "-") $(ele).text("yy-m-d");
                        }
                    }
                };

                ko.bindingHandlers.atributoLoaded = {
                    init: function (ele, _vacc, _allBindings, vm) {
                        if (!_.includes(["columnasmultieditar", "filtrarcatalogo", "resumen", "columnasvisualizar", "columnastotalizar", "tipificacionpermitida", "tipificacionunica", "contenidoestatico", "camposfiltros"], vm.p().tipo()))
                            !(_.includes(["valor", "contenidoestaticohtml"], vm.p().tipo()) && _vacc() === "wysiwyg") && (vm.p().val.subscribe(function () { saveValueXml(vm); }), vm.p().val.valueHasMutated());
                        renderExtraDomAtributo(vm, ele);
                    }
                };

                ko.bindingHandlers.tipodoccombo = {
                    init: function (ele, vacc, _allBindings, vm, parentbind) {
                        var o = getOpts(), id = vacc(), alloweddocs = o.datatags.tipodochijos;
                        if (!o.appvm.isEditor()) {
                            if (o.appvm[id].tipo() === o.TE.Documento) {
                                alloweddocs = _.filter(o.datatags.tipodochijos, function (dochijo) {
                                    return !o.appvm[id].tipificacionpermitida()["tipodoc_" + dochijo.Valor] || !!o.appvm[id].tipificacionpermitida()["tipodoc_" + dochijo.Valor] && o.appvm[id].tipificacionpermitida()["tipodoc_" + dochijo.Valor].enabled;
                                });
                            }
                            $(ele).combobox({
                                data: alloweddocs, valueField: 'Valor', textField: 'Nombre', prompt: 'Seleccione...', disabled: !o.appvm[id].habilitado() || o.appvm.isQuery(), multiple: o.appvm[id].tipo() === o.TE.FirmaFAD,
                                value: o.appvm[id].tipo() === o.TE.Documento ? o.appvm[id].tipodocjson()[vm.filename] : o.appvm[id].tipodoc().toString(), limitToList: !0, panelHeight: "auto", panelMaxHeight: 200,
                                formatter: function (row) {
                                    return '<span style="font-size: 12px">' + row.Nombre + '</span>';
                                },
                                onSelect: function (itemval) {
                                    if (o.appvm[id].tipo() === o.TE.Documento) {
                                        if (!o.appvm[id].ondelete()) {
                                            if (o.appvm[id].tipificacionpermitida()) {
                                                if (!o.appvm[id].tipificacionpermitida()["tipodoc_" + itemval.Valor]) {
                                                    var tipoobj = _.find(o.datatags.tipodochijos, function (elm) { return elm.Valor === itemval.Valor; });
                                                    if (tipoobj) {
                                                        var tp = o.appvm[id].tipificacionpermitida();
                                                        tp["tipodoc_" + itemval.Valor] = { enabled: !0, min: 0, max: 0 };
                                                        o.appvm[id].tipificacionpermitida(tp);
                                                    }
                                                }
                                                var objdoc = o.appvm[id].tipificacionpermitida()["tipodoc_" + itemval.Valor], datal = [];
                                                _.forEach(o.appvm[id].tipodocjson(), function (elm) { datal.push(elm); });
                                                var cantdoc = _.filter(datal, function (elm) { return elm === itemval.Valor; });
                                                if (objdoc.max > 0 && cantdoc.length === objdoc.max) {
                                                    toasty('', 'Se ha llegado al m&aacute;ximo de documentos de tipo ' + itemval.Nombre + ' subidos.', 'error'),
                                                        setTimeout(function () { $(ele).combobox("reset"); }, 5);
                                                    return;
                                                }
                                            }
                                            itemval.Valor.toString() !== o.appvm[id].tipodocjson()[vm.guidanexo] && itemval.Valor !== "" &&
                                                (o.appvm[id].metadatostipodocjson()[vm.guidanexo] = {},
                                                    _.forEach(_.map(_.filter(o.datatags.metadatoshijos, { TipoDoc: _.toNumber(itemval.Valor) }), 'Nombre'), function (keyval) {
                                                        o.appvm[id].metadatostipodocjson()[vm.guidanexo][keyval] = "";
                                                    }), o.appvm[id].metadatostipodoc(JSON.stringify(o.appvm[id].metadatostipodocjson())));
                                            o.appvm[id].tipodocjson()[vm.guidanexo] = itemval.Valor, o.appvm[id].tipodoc(JSON.stringify(o.appvm[id].tipodocjson()));
                                            vm.metadataisrequired = _.filter(o.datatags.metadatoshijos, { TipoDoc: itemval.Valor, Obligatorio: !0 }).length > 0;
                                            $(`#${vm.guidanexo}itemcar`).find(".docname").text('Tipo de Documento: ' + itemval.Nombre);
                                        }
                                    }
                                    else if (o.appvm[id].tipo() !== o.TE.FirmaFAD)
                                        o.appvm[id].tipodoc(itemval.Valor);
                                }, onUnselect: function (itemval) {
                                    if (o.appvm[id].tipo() === o.TE.Documento) {
                                        if (!o.appvm[id].ondelete()) {
                                            delete o.appvm[id].tipodocjson()[vm.guidanexo], o.appvm[id].tipodoc(JSON.stringify(o.appvm[id].tipodocjson()));
                                            delete o.appvm[id].metadatostipodocjson()[vm.guidanexo], o.appvm[id].metadatostipodoc(JSON.stringify(o.appvm[id].metadatostipodocjson())),
                                                vm.metadataisrequired = !1;
                                        }
                                    }
                                    else if (o.appvm[id].tipo() !== o.TE.FirmaFAD)
                                        o.appvm[id].tipodoc("");
                                }, onChange: function (nv, ov) {
                                    if (o.appvm[id].ondelete && !o.appvm[id].ondelete() || !o.appvm[id].ondelete) {
                                        var strfunc = (nv === "" ? "untypifyattach" : "typifyattach") + id;
                                        o[strfunc] = !0, evaluateConditions(o, id), o[strfunc] = !1;
                                        //accion para refrescado de metadatos en el documento
                                        o.appvm[id].updatemetadata(!0);
                                    }
                                    if (o.appvm[id].tipo() === o.TE.FirmaFAD) {
                                        o.appvm[id].tipodoc($(this).combobox("getValues").toString());
                                    }
                                }
                            });
                            if (o.appvm[id].tipo() === o.TE.Documento && !o.appvm[id].tipodocjson()[vm.guidanexo] && !!o.appvm[id].tipificacionunica() && o.appvm[id].tipificacionunica().enabled && !!o.appvm[id].tipificacionunica().idtype) {
                                var tipodoc = _.find(alloweddocs, { Valor: o.appvm[id].tipificacionunica().idtype.toString() });
                                var tipodocOrig = _.find(o.datatags.tipodochijos, { Valor: o.appvm[id].tipificacionunica().idtype.toString() });
                                tipodoc ? $(ele).combobox("setValue", o.appvm[id].tipificacionunica().idtype)
                                    : !!tipodocOrig && toasty('', 'Tipificación de tipo ' + tipodocOrig.Nombre + ' no permitida');
                            }
                        }
                    }
                };

                ko.bindingHandlers.qrcode = {
                    init: function (ele, vacc, _allBindings, vm) {
                        var o = getOpts();
                        !o.appvm.isEditor() && o.appvm[vm.p().id()].generarcodigoautomatico() && makeQR(o, vm.p().id());
                    }
                };

                ko.bindingHandlers.reemplazomenu = {
                    init: function (ele, id, _allBindings, vm) {
                        $(ele).on('click', (ob) => {
                            $("#mm").menu("destroy"), $(".menu:not('visible')").remove();
                            $("body").append('<div id="mm" class="easyui-menu" style="width: 180px;"></div>');
                            $("#mm").menu();
                            if (o.appvm[id()].permisocamara())
                                $("#mm").menu("appendItem", { text: o.appvm[id()].textobotontomarfoto(), onclick: function () { customActionElement(id(), [o.TE.Documento, 'replacecam', vm]); } });
                            if (o.appvm[id()].permisoimportar())
                                $("#mm").menu("appendItem", { text: o.appvm[id()].textobotonsubirarchivo(), onclick: function () { customActionElement(id(), [o.TE.Documento, 'replaceimp', vm]); } });
                            if (o.appvm[id()].permisoimportarvacio())
                                $("#mm").menu("appendItem", { text: "Documento vacío", onclick: function () { customActionElement(id(), [o.TE.Documento, 'replacenoimage', vm]); } });
                            $("#mm").menu("show", { left: ob.pageX - 100, top: ob.pageY + 10, hideOnUnhover: false });
                        });
                    }
                };

                ko.bindingHandlers.infoMetadata = {
                    init: function (ele, vacc, _allBindings, vm) {
                        var o = getOpts(), jss = vacc(), id = jss.id;
                        drawMetadata(o, id, ele, vm);
                    },
                    update: function (ele, vacc, _allBindings, vm, bc) {
                        var o = getOpts(), jss = vacc(), id = jss.id, upd = jss.data;
                        if (upd === !0) drawMetadata(o, id, ele, vm);
                        if (o.appvm[id].anexo().length - 1 === bc.$index()) o.appvm[id].updatemetadata.silentUpdate(!1);
                    }
                };

                ko.bindingHandlers.filterLoaded = {
                    init: function (ele, _vacc, _allBindings, vm) {
                        var o = getOpts();
                        if (!o.appvm.isEditor()) {
                            if (_vacc() === "rowfilter") {
                                var filtermodal = $('<div style="z-index:1001;max-width:20vw;max-height:30vh;font-weight:100; font-family: Arial;overflow:auto" class="p-1 pr-3 border position-absolute bg-white rounded text-left"><table style="cursor:default" class="datalistfilter table table-condensed no-margin"></table></div>'),
                                    data = _.map(_.keys(o.appvm[vm.p().id()].columnasvisualizar()), function (elm) {
                                        var elmobj = searchElementInJson(o, elm);
                                        return { id: elm, nombre: elmobj ? elmobj.atributos.titulo : elm };
                                    });
                                $(ele).append(filtermodal);
                                _.forEach(data, function (elerow) {
                                    var dataelmrow = $("<tr><td class='align-middle border-right' id='" + elerow.id + "'><input type='checkbox'></td><td class='pl-2'>" + elerow.nombre + "</td></tr>");
                                    $(ele).find("table").append(dataelmrow);
                                    $(dataelmrow.find("input")).prop("checked", o.appvm[vm.p().id()].columnasvisualizar()[elerow.id]).on("change", function (e) {
                                        o.appvm[vm.p().id()].columnasvisualizar()[elerow.id] = e.target.checked, o.appvm[vm.p().id()].columnasvisualizar.valueHasMutated();
                                    });
                                });
                                filtermodal.toggle();
                                $(ele).on("click", function (e) { $(e.target).hasClass("fa-filter") && filtermodal.toggle("slow"); });
                                filtermodal.on("click", function (e) { $(e.target).hasClass("fa-filter") && filtermodal.toggle("slow"); });
                            }
                            else if (_vacc() === "tablestylefilter") {
                                var stylestable = $('<div style="z-index:1001;font-weight:100; font-family: Arial;right:0;top:100%" class="text-black listtablestyles border position-absolute bg-white rounded text-left">\
                                <div class="pl-4 py-1 pr-2 border-bottom listoptstyle" tabindex="1">Compacto</div>\
                                <div class="pl-4 py-1 pr-2 border-bottom listoptstyle selected" tabindex="2">Normal</div>\
                                <div class="pl-4 py-1 pr-2 border-bottom listoptstyle" tabindex="3">Lineal</div>\
                            </div>');
                                $(ele).append(stylestable);
                                stylestable.toggle();
                                $(ele).on("click", function (e) { $(e.target).hasClass("fa-th-list") && stylestable.toggle("slow"); });
                                stylestable.find(".listoptstyle").on("click", function (e) {
                                    var modetable = $(e.target).attr("tabindex");
                                    switch (modetable) {
                                        case "1": o.appvm[vm.p().id()].modetable("compactmode"); break;
                                        case "2": o.appvm[vm.p().id()].modetable("normalmode"); break;
                                        case "3": o.appvm[vm.p().id()].modetable("linealmode"); break;
                                    }
                                    stylestable.find(".listoptstyle").removeClass("selected"), $(e.target).addClass("selected"), stylestable.toggle("slow");
                                });
                            }
                        }
                    }
                };

                ko.bindingHandlers.comborendered = {
                    init: function (ele, _vacc, _allBindings, vm) {
                        var o = getOpts(), id = _vacc();
                        if (o.appvm[id] && o.appvm[id].modobusqueda() && o.appvm[id].tipolista() === "combo" && !o.appvm.isEditor()) {
                            var copyCat = _.cloneDeep(o.appvm[id].catalogodestino()),
                                valData = o.appvm[id].tipoasociacion() === "idid" || o.appvm[id].tipoasociacion() === "descid" ? "Valor" : "Nombre";
                            _.remove(copyCat, { Valor: "" });
                            $(ele).css({ width: "95%" }).combobox({
                                data: copyCat, idField: valData, prompt: "Seleccione...", limitToList: !0, disabled: o.appvm.isQuery() ? true : !o.appvm[id].habilitado(),
                                valueField: valData, textField: "Descripcion", panelHeight: 'auto', panelMaxHeight: 200,
                                value: o.appvm[id].valor(),
                                onChange: function (item) {
                                    copyCat = _.cloneDeep(o.appvm[id].catalogodestino());
                                    _.remove(copyCat, { Valor: "" });
                                    var selItem = _.find(copyCat, function (elmcopycat) { return elmcopycat[valData] === item; });
                                    if (selItem) o.appvm[id].optionselected.silentUpdate(selItem.Valor);
                                    else o.appvm[id].optionselected.silentUpdate("");
                                    o.appvm[id].optionselected.valueHasMutated();
                                    if (item !== "" && o.appvm[id].valor() === "")
                                        $(this).combobox("setText", item);
                                }
                            });
                        }
                    }
                };

                ko.bindingHandlers.tituloAtributo = {
                    init: function (ele, _vacc, _allBindings, vm) {
                        if (vm.p().titulo().indexOf("{{ayuda}}") >= 0) {
                            var newtit = vm.p().titulo().replace("{{ayuda}}", '<a tabindex="0" class="popovericon fas fa-question-circle" style="cursor: pointer;"></a>');
                            $(ele).html(newtit);
                            var content = "";
                            switch (vm.p().tipo()) {
                                case "urllink":
                                    content = '<p class="m-0">Abre p&aacute;ginas fijas o con par&aacute;metros.<br />Ejemplos:</p>\
                                    <ul>\
                                        <li>Absoluta: <strong>http://pagina.com</strong></li>\
                                        <li>Relativa: <strong>/pagina.apsx</strong></li>\
                                        <li>Con par&aacute;metros: <strong>pagina.aspx?parametro1=valor1&amp;parametro2=valor2</strong></li>\
                                    </ul>\
                                    <p class="mb-0">Para especificar par&aacute;metros din&aacute;micos se deben usar<br />las "variables reservadas" encerradas entre {{...}}.<br />Ejemplos:</p>\
                                    <ul>\
                                        <li>pagina.aspx?parametro1=<strong>{{variable1}}</strong>&amp;<br />parametro2=<strong>{{variable2}}</strong></li>\
                                        <li>Si se quiere variables del querystring se debe<br />usar la variable reservada "query_" seguida del nombre del<br />par&aacute;metro del querystring: <strong>{{query_nombre}}</strong></li>\
                                        <li>Si se quiere usar valores de elementos (texto,<br />moneda, etc) se debe usar el id del elemento : <strong>{{formElec_element25}}</strong></li>\
                                        <li>Si se quiere usar los valores de las columnas<br />dentro de una tabla (por fila), el bot&oacute;n debe esta dentro de dicha tabla y se debe usar las letras "tb:" unidas al id del elemento hijo (<span class="font-italic">{{tb:idHijo}}</span>): <strong>{{tb:formElec_element67}}</strong></li>\
                                    </ul>\
                                    <p class="mb-0">Las variables reservadas son: flujoid, piid, proyid, expid,<br />docid, tipodocid, username, grupoid, query_<strong>nombre</strong>, elem_<strong>id</strong></p>';
                                    break;
                                case "fechamax":
                                    content = '<p>Para la fecha m&aacute;xima se pueden 3 configuraciones.</p>\
                                    <ul>\
                                        <li>Valor -9999 para infinito</li>\
                                        <li>Valor positivo para fechas futuras. Ejemplo si hoy es 20 de enero, al poner 4, la fecha m&aacute;xima ser&aacute; 24 de enero</li>\
                                        <li>Valor negativo para fecha pasadas. Ejemplo si hoy es 20 de enero, al poner -4, la fecha m&aacute;xima ser&aacute; 16 de enero</li>\
                                        <li>Valor 0 para indicar el d&iacute;a de hoy</li>\
                                    </ul>';
                                    break;
                                case "fechamin":
                                    content = '<p>Para la fecha m&iacute;nima se pueden 3 configuraciones.</p>\
                                    <ul>\
                                        <li>Valor -9999 para infinito</li>\
                                        <li>Valor positivo para fechas pasadas. Ejemplo si hoy es 20 de enero, al poner 4, la fecha m&iacute;nima ser&aacute; 16 de enero</li>\
                                        <li>Valor negativo para fecha futuras. Ejemplo si hoy es 20 de enero, al poner -4, la fecha m&iacute;nima ser&aacute; 24 de enero</li>\
                                        <li>Valor 0 para indicar el d&iacute;a de hoy</li>\
                                    </ul>';
                                    break;
                                case "textoconid":
                                    content = '<p>Se puede dar formato al texto de 3 formas.</p>\
                                    <ul>\
                                        <li>{t} = Se usa para mostrar la descripci&oacute;n del &iacute;tem.</li>\
                                        <li>{i} = se usa para mostrar el id del &iacute;tem.</li>\
                                        <li>{cv} = Se usa para mostrar la CveCatalogo del &iacute;tem.</li>\
                                    </ul>\
                                    <p>Ejemplo: {i} - {t}:{cv} -> 56 - M&eacute;xico:0056</p>';
                                    break;
                                case "filtrarcatalogo":
                                    content = 'Si activa esta casilla y deja en blanco el combo, significa ver todo.';
                                    break;
                                case "idunico":
                                    content = '<div style="max-width:10px"><p>Identificador usado para exportar/importar datos.</p>\
                                    Usos:\
                                    <ul>\
                                        <li><strong>Para mandar datos de una tabla a un servicio:</strong>\
                                            <ul><li>El ID &uacute;nico del elemento debe ser igual al par&aacute;metro de la clase a llenar.</li>\
                                            <li>El tipo de dato del par&aacute;metro de la clase se define en el JSON del servicio, por lo tanto es independiente al elemento que se use.</li></ul>\
                                        </li>\
                                    </ul></div>';
                                    break;
                                case "tiempoprioridadbaja": case "tiempoprioridadalta": case "tiempoprioridadmedia":
                                    content = '<p>Usar t para determinar el tiempo. No coloque espacios. Siga la nomenclatura para sustituir los operadores l&oacute;gicos:</p>\
                                            <p>+ sustituye >. Ej: t+3 (tiempo es mayor que 3)</p>\
                                            <p>- sustituye >. Ej: t-3 (tiempo es menor que 3)</p>\
                                            <p>+= sustituye >. Ej: t+=3 (tiempo es mayor o igual que 3)</p>\
                                            <p>-= sustituye >. Ej: t-=3 (tiempo es menor o igual que 3)</p>\
                                            <p>= queda igual. Ej: t=3 (tiempo es igual a 3)</p>\
                                            <p>Se puede usar &. Ej: t+=3&t-5 (tiempo es mayor o igual que 3 y menor que 5)</p>';
                                    break;
                                case "extensionespermitidas":
                                    content = '<p>Si no se selecciona ninguna extensi&oacute;n, por defecto se permitir&aacute; subir cualquier archivo.</p>';
                                    break;
                                case "atributodescripcion": case "atributovalor":
                                    content = 'Escriba el nombre del atributo tal y como aparece en su clase.';
                                    break;
                                case "todasopcionesrequeridas":
                                    content = "Trabaja en conjunto con la propiedad de requerido. El utilizar esta propiedad, anula la validaci&oacute;n de los atributos m&aacute;ximo y m&iacute;nimo a seleccionar.\
                                           <br /><strong>Solo aplicable a tipo de lista checkbox.</strong>";
                                    break;
                                case "tipificacionpermitida":
                                    content = "Columnas: <ol><li>Permitir tipo de documento</li><li>Nombre del tipo de documento</li><li>M&iacute;nimo de documentos</li>\
                                            <li>M&aacute;ximo de documentos (0 significa ilimitado)</li></ol><strong>Esta propiedad es indepediente de las propiedades m&aacute;ximo y m&iacute;nimo de documentos a subir.</strong>";
                                    break;
                                case "tipificacionunica":
                                    content = "Considere los <strong>Documentos permitidos</strong> ya que si no coinciden, no se tipificará.";
                                    break;
                                case "tipodoc":
                                    content = "La tipificación para cada uno corresponde de la siguiente manera: <ol><li>La firma</li><li>Para la foto del firmante o el video</li><li>Para el timestamp</li></ol>";
                                    break;
                                case "campobusqueda":
                                    content = "Compatible únicamente con tipo lista combo.";
                                    break;
                                case "acuerdofirma":
                                    content = "Si el usuario necesita utilizar información proveniente de otros campos, simplemente deberá colocar en llaves dobles el id del elemento del cual necesita obtener la información. Ejemplo:\
                                            <b>Yo {{formElec_element2}} estoy de acuerdo con los términos.</b>";
                                    break;
                                case "cantidadopciones":
                                    content = "Para obtener todo el universo de opciones, es necesario colocar en cero esta propiedad.";
                                    break;
                            }
                            $(ele).find("a").popover({
                                content: content.replace(/á/g, '&aacute;').replace(/é/g, '&eacute;').replace(/í/g, '&iacute;').replace(/ó/g, '&oacute;').replace(/ú/g, '&uacute;'),
                                html: true, trigger: "focus", placement: "bottom"
                            });
                        }
                    }
                };

                ko.bindingHandlers.elementoLoaded = { init: function (ele, vacc, _allBindings, vm) { renderExtraDomElemento(vm, ele, vacc); } };

                ko.bindingHandlers.tableLoaded = {
                    init: function (ele, val, _allBindings, vm, cont) {
                        var o = getOpts();
                        if (val() === "row") {
                            if (cont.$root[cont.$parent.p().id()].rowediting() === "") //repintado en modo edicion, no se anima de nuevo
                                $(ele).animate({ backgroundColor: 'yellow' }, 200).animate({ backgroundColor: 'white' }, 800);
                        }
                        else if (val() === "col" && cont.$parent[vm.id]) {
                            var infodot = "<a class='w-100 h-50 position-absolute text-black infodot' style='bottom:30%; right:0; z-index:1000;font-size:0.9rem; opacity:0.5' tabindex='0'></a>";
                            if (cont.$parent[vm.id].valormetadatorango && o.appvm[vm.id].tipo() === o.TE.RangoFechas)
                                $(ele).html(cont.$parent[vm.id].valormetadatorango()).append(infodot),
                                    $(ele).find("a").popover({ html: true, content: cont.$parent[vm.id].valormetadatorango(), trigger: "focus", position: "bottom" });
                            else if (o.appvm[vm.id].tipo() === o.TE.Wizard) {
                                o.appvm[vm.id].cantidadformatosabrircounter() !== -1 && (o.appvm[vm.id].cantidadformatosabrircounter()[cont.$parent.Acciones.id()] = o.appvm[vm.id].cantidadformatosabrir());
                                var icon = (o.appvm[vm.id].vericonos() ? '<i class="fas fa-check"></i>&nbsp;&nbsp;&nbsp;' : '') + o.appvm[vm.id].textofinalizar();
                                var elmwiz = '<div class="finish btn no-border ' + (o.appvm[vm.id].habilitado() && !o.appvm.isQuery() ? '' : 'disabled') + '" style="color:' + o.appvm[vm.id].colortextofinalizar() +
                                    ';background-color: ' + o.appvm[vm.id].colorfondofinalizar() + '; font-style:' +
                                    o.appvm[vm.id].estilotexto() + '">' + icon + '</div>';
                                $(ele).append(elmwiz);
                                $(ele).find(".finish").on("click", function () {
                                    if (o.appvm[o.appvm[cont.$data.id].elementopadre()].clickedrow() === -1)
                                        o.appvm[o.appvm[cont.$data.id].elementopadre()].clickedrow(cont.$parent.Acciones.id()), customClickButtonsElements(o.TE.Wizard, vm.id, 'finish'), o.appvm[o.appvm[cont.$data.id].elementopadre()].clickedrow(-1);
                                });
                            }
                            else if (o.appvm[vm.id].tipo() === o.TE.Boton) {
                                if (o.appvm[vm.id].vercomoregistro()) {
                                    o.appvm[vm.id].cantidadmaximacliccounter() !== -1 && (o.appvm[vm.id].cantidadmaximacliccounter()[cont.$parent.Acciones.id()] = o.appvm[vm.id].cantidadmaximaclic());
                                    var elmboton = '<div style="color: ' + o.appvm[vm.id].colortexto() + '; background-color: ' + o.appvm[vm.id].colorfondo() + '; pointer-events: ' + (o.appvm[vm.id].habilitado() && !o.appvm.isQuery() ? 'auto' : 'none') + '"\
                                class="btn px-2 py-1 no-border btnTable ' + o.appvm[vm.id].tamaniocss() + ' ' + (o.appvm[vm.id].ancho() === 'completo' ? 'btn-block' : '') + ' ' + (o.appvm[vm.id].habilitado() && !o.appvm.isQuery() ? '' : 'disabled') +
                                        (o.appvm[o.idPlantilla].permitirsombrabotones() ? 'hasshadow' : '') + '">' +
                                        o.appvm[vm.id].valor() + '</div>';
                                    $(ele).append(elmboton);
                                    $(ele).find(".btnTable").on("click", function () {
                                        if (o.appvm[o.appvm[cont.$data.id].elementopadre()].clickedrow() === -1)
                                            o.appvm[o.appvm[cont.$data.id].elementopadre()].clickedrow(cont.$parent.Acciones.id()), o.appvm[cont.$data.id].click(), o.appvm[o.appvm[cont.$data.id].elementopadre()].clickedrow(-1);
                                    });
                                }
                            }
                            else {
                                var texto = cont.$parent[vm.id].valor();
                                if (texto === "false" || texto === "true" || typeof texto === "boolean") {
                                    $(ele).html('<input type="checkbox" disabled="disabled" ' + (texto === "false" || texto === false ? "" : 'checked="checked"') + ' />').css({ "text-align": "center" });
                                }
                                else $(ele).html(texto), $(ele).append(infodot), $(ele).find("a").popover({ html: true, content: texto, trigger: "hover" });
                            }
                        }
                    }
                };

                ko.bindingHandlers.loadayuda = {
                    update: function (ele, vacc, _allBindings, vm) {
                        if (vacc()) {
                            $(ele).append("<a class='fas fa-question-circle position-absolute p-1' style='top:0;right:0;color:darkgray' tabindex='0'></a>");
                            $(ele).find("a").popover({ html: true, content: vacc(), trigger: "hover", placement: "top" });
                        }
                    }
                };

                ko.bindingHandlers.designtabs = {
                    init: function (ele, _vacc, _allBindings, vm) { updateStyleTabs(ele, vm); },
                    update: function (ele, _vacc, _allBindings, vm) { updateStyleTabs(ele, vm); }
                };

                ko.bindingHandlers.designcommands = {
                    init: function (ele, vacc) { updateStyleCommands(ele, vacc()); }, update: function (ele, vacc) { updateStyleCommands(ele, vacc()); }
                };

                ko.bindingHandlers.designbuttonall = {
                    init: function (ele, vacc, _allBindings, vm) { updateStyleButtonAll(ele, vacc(), vm); },
                    update: function (ele, vacc, _allBindings, vm) { updateStyleButtonAll(ele, vacc(), vm); }
                };
            }

            ko.extenders.upper = function (target) {
                target.subscribe(function (newValue) {
                    target.silentUpdate(!newValue ? "" : newValue.toString().toUpperCase()); //las mayusculas no deben ejecutar reglas ya que es un cambio estetico no real
                });
                return target;
            };

            ko.extenders.lower = function (target) {
                target.subscribe(function (newValue) {
                    target.silentUpdate(!newValue ? "" : newValue.toString().toLowerCase()); //las minusculas no deben ejecutar reglas ya que es un cambio estetico no real
                });
                return target;
            };

            ko.observable.fn.silentUpdate = function (value) {
                this.notifySubscribers = function () { };
                this(value);
                this.notifySubscribers = function () { ko.subscribable.fn.notifySubscribers.apply(this, arguments); };
            };
        }
        function componentViewModel(params) {
            var self = this;
            self.p = ko.observable(ko.mapping.fromJS(params));
            self.cleanid = ko.observable(params.id.replaceAll('_', ''));
            self.showpage = function (id, v, c) { showPage(id, v); };
            self.showtab = function (id) { showTab(id); };
            self.event = function (t, id, params) {
                if (t === 2) configuradorParametros(id, params[0]);
                else if (t === 3) wysiwyg(id);
                else if (t === 4) resumen2(id);
                else if (t === 5) configuradorEsquemaListas(id);
                else if (t === 6) actionRowTable(id, params);
                else if (t === 7) importTable(id, params);
                else if (t === 8) unloadFile(id, true);
                else if (t === 9) bindSonColumns(id);
                else if (t === 10) mappingocr(id);
                else if (t === 11) mappingscore(id);
                else if (t === 12) mappingpepaml(id);
            };
            self.archivo = function (_it, ev) { selectArchivo(ev.target, this.p().id(), this.p().tipo()); };
            self.cleararchivo = function () { clearArchivo(this.p().id(), this.p().tipo()); };
            self.typeinput = function () {
                if (this.p().tipo() === "password") return "password";
                else return "text";
            };
            self.wizardtexto = function (t) {
                return ko.computed({
                    read: function () {
                        var o = getOpts();
                        if (t === 1 && o.appvm[self.p().id()].textoregresar)
                            return (o.appvm[self.p().id()].vericonos() === true ? '<i class="fas fa-chevron-left" style="font-size: ' + (o.appvm[o.appvm.idPlantilla()].tamanofuente() / 10) + 'rem"></i>&nbsp;&nbsp;&nbsp;' : '') + '<span style="font-size : ' + (o.appvm[o.appvm.idPlantilla()].tamanofuente() / 10) + 'rem">' + o.appvm[self.p().id()].textoregresar() + '</span>'
                        else if (t === 2 && o.appvm[self.p().id()].textoavanzar)
                            return '<span style="font-size : ' + (o.appvm[o.appvm.idPlantilla()].tamanofuente() / 10) + 'rem">' + o.appvm[self.p().id()].textoavanzar() + '</span>' + (o.appvm[self.p().id()].vericonos() === true ? '&nbsp;&nbsp;&nbsp;<i class="fas fa-chevron-right" style="font-size: ' + (o.appvm[o.appvm.idPlantilla()].tamanofuente() / 10) + 'rem"></i>' : '');
                        else if (t === 3 && o.appvm[self.p().id()].textofinalizar)
                            return (o.appvm[self.p().id()].vericonos() === true ? '<i class="fas fa-check" style="font-size: ' + (o.appvm[o.appvm.idPlantilla()].tamanofuente() / 10) + 'rem"></i>&nbsp;&nbsp;&nbsp;' : '') + '<span style="font-size : ' + (o.appvm[o.appvm.idPlantilla()].tamanofuente() / 10) + 'rem">' + o.appvm[self.p().id()].textofinalizar() + '</span>'
                        return "";
                    }
                }, self);
            };
            self.onKeyDownNumber = function (d, e) { return checkNumberKey(getOpts(), d.p().id(), e); };
            self.clickcustom = function (p, forced) { customClickButtonsElements(this.p().tipo(), this.p().id(), p, forced); };
            self.disableKeyboardForCBTemporal = function (d, e) {
                var ev = e ? e : window.event;

                if (ev) {
                    if (ev.preventDefault) ev.preventDefault();
                    else ev.returnValue = false;
                }
            };
        }
        function saveValueXml(v) {
            var o = getOpts();
            var tipo = v.p().tipo(), id = v.p().id(), val = v.p().val(), oldval = o.appvm[id][tipo]();
            if (val === undefined || val === null) val = "";
            o.appvm[id][tipo](val);
            if (_.includes(["tipoescaneo", "formato", "hora", "tipolista", "tipoasociacion"], tipo)) {
                var sel = _.find(v.p().options(), function (n) { return n.Valor() === val; }) || v.p().options()[0];
                if (typeof o.appvm[id][tipo + "Object"].Nombre !== "function") {
                    o.appvm[id][tipo + "Object"] = ko.mapping.toJS(sel);
                    o.appvm[id][tipo + "Object"].Nombre = ko.observable(sel.Nombre());
                    o.appvm[id][tipo + "Object"].Valor = ko.observable(sel.Nombre());
                } else {
                    o.appvm[id][tipo + "Object"].Nombre(sel.Nombre());
                    o.appvm[id][tipo + "Object"].Valor(sel.Valor());
                }
                if (_.includes(["tipolista", "tipoasociacion"], tipo)) {
                    var valmetadato = o.appvm[id].metadato();
                    if (valmetadato !== "") {
                        var mett = _.find(o.datatags.metadatos, function (n) { return n.Nombre === valmetadato; });
                        if (mett) {
                            var result = checkMetadato(o, mett.TipoDatoId, o.appvm[id].tipo(), id, mett.Nombre, tipo);
                            if (result.valid === false) {
                                toasty(result.mensaje);
                                $("#metadato").parent()[0] && ko.contextFor($("#metadato").parent()[0]).$data.p().val("");
                            }
                        }
                    }
                    if (tipo === "tipolista") {
                        o.appvm[id].chosenitemsRule([]);
                        if (val === "combo") o.appvm[id].optionselectedRule("");
                    }
                }
            }
            else if (_.includes(["metadato", "metadatoinicial", "metadatofinal", "metadatorango"], tipo)) {
                if (val !== "") {
                    $.each(o.datatags.metadatos, function (j, m) {
                        if (m.Nombre === val) {
                            //validacion del tipo de metadato contra el elemento
                            var tipoe = o.appvm[id].tipo();
                            if (oldval !== val) { //mismometadato para evitar reemplazar lo guardado
                                var result1 = checkMetadato(o, m.TipoDatoId, tipoe, id, m.Nombre, tipo);
                                if (result1.valid) {
                                    if ($("#mascara").length)
                                        ko.contextFor($("#mascara").parent()[0]).$data.p().val(m["Mascara"]);
                                    if ($("#expresionregular").length)
                                        ko.contextFor($("#expresionregular").parent()[0]).$data.p().val(m["Expresion_Regular"]);
                                    if ($("#longitudmaxima").length)
                                        $("#longitudmaxima").numberspinner("setValue", m["Longitud_Maxima"]);
                                    if ($("#longitudminima").length)
                                        $("#longitudminima").numberspinner("setValue", m["Longitud_Minima"]);
                                    return;
                                }
                                toasty(result1.mensaje);
                                v.p().val("");
                            }
                            return;
                        }
                    });
                }
            }
            else if (tipo === "catalogoorigen") {
                if (val) {
                    var catori = _.filter(o.datatags.catalogos, function (it) { return it.Valor.toString() === val.toString(); });
                    o.appvm[id].tipo() === o.TE.Lista && o.appvm[id].tieneesquema(catori[0] ? catori[0].TieneEsquema : false);
                } else o.appvm[id].catalogodestino([]);
            }
            else if (tipo === "fuentedatos") {
                if (val === "catalogos") {
                    ko.contextFor($("#catalogoorigen" + id).parent()[0]).$data.p().visible(true);
                    if (oldval !== val) //se evita reasignacion desde page load
                        o.appvm[id].catalogossistema && o.appvm[id].catalogossistema() === true ?
                            $("#catalogoorigen" + id).combobox("loadData", o.datatags.catalogos) :
                            $("#catalogoorigen" + id).combobox("loadData", _.filter(o.datatags.catalogos, function (it) { return parseInt(it.Valor) > 20; }));
                } else if (val === "completez") {
                    ko.contextFor($("#catalogoorigen" + id).parent()[0]).$data.p().visible(false);
                } else if (val === "manual") {
                    ko.contextFor($("#catalogoorigen" + id).parent()[0]).$data.p().visible(false);
                }
            }
            else if (tipo === "catalogossistema") {
                var data = $("#catalogoorigen" + id).combobox("getData");
                if (val === true) {
                    if (data.length !== o.datatags.catalogos.length) //se evita reasignacion desde page load
                        $("#catalogoorigen" + id).combobox("loadData", o.datatags.catalogos);
                }
                else {
                    var filopt = _.filter(o.datatags.catalogos, function (it) { return parseInt(it.Valor) > 20; });
                    if (data.length !== filopt.length) //se evita reasignacion desde page load
                        $("#catalogoorigen" + id).combobox("loadData", filopt);
                }
            }
            else if (_.includes(["ordenitems", "textoconid"], tipo)) {
                o.appvm[id].catalogodestino(setDescriptionAndOrder(o, id, o.appvm[id].catalogodestino()));
            }
        }
        function renderExtraDomAtributo(v, e) {
            var tipo = v.p().tipo(), id = v.p().id(), o = getOpts(), selindex = [], selecteds = [], data = [], sel = "";
            !v.p().visible() && ($(e).html(""));
            if (tipo === "tamanofuente") {
                $(e).find("input:text").css({ width: 165 }).numberspinner({
                    max: 18, min: 8, increment: 1, editable: false, height: 30, value: v.p().val(), onChange: function (value) { v.p().val(value); }
                });
            }
            else if (tipo === "scoremin") {
                $(e).find("input:text").css({ width: 165 }).numberspinner({
                    max: 5, min: 1, increment: 1, editable: false, height: 30, value: v.p().val(), onChange: function (value) { v.p().val(value); }
                });
            }
            else if (tipo === "anchocapturador") {
                $(e).find("input:text").css({ width: 165 }).numberspinner({
                    max: 100, min: 60, increment: 5, editable: true, height: 30, value: v.p().val(), onChange: function (value) { v.p().val(value); }
                });
            }
            else if (tipo.indexOf("color") === 0) {
                var picker = new jscolor($(e).find("input")[0], { hash: true });
                var val = v.p().val().toString().length < 6 ? tipo.indexOf("fondo") >= 0 ? "3c8dbc" : "ffffff" : v.p().val();
                val.toString().indexOf("#") === -1 ? v.p().val("#" + val) : v.p().val(val); //reasignado por si cambio en la condicion de arriba
                picker.fromString(v.p().val());
            }
            else if (_.includes(["numeromaximo", "numerominimo"], tipo)) {
                $(e).find("input:text").css({ width: 165 }).numberbox({
                    max: null, min: 0, precision: o.appvm[id]["decimales"](), value: v.p().val(), onChange: function (value) { v.p().val(value); }
                });
            }
            else if (_.includes(["grosorbordeplantilla", "grosorborde", "maxopcionesseleccionar", "minopcionesseleccionar", "longitudmaxima", "longitudminima", "columnas", "filasmax",
                "filasmin", "alturacampo", "decimales", "cantidadmaximaclic", "divisionesrango", "maximodocumentos", "minimodocumentos", "intervalomaximo",
                "decimalesresultado", "maximporte", "minimporte", "intervaloimporte", "intervalomeses", "maxmes", "minmes", "tasanominalanual", "cantidadformatosabrir", "alto", "ancho", "lado"], tipo)
                || tipo === "valor" && _.includes([o.TE.Moneda, o.TE.Numero], o.appvm[id].tipo())) {
                let max = null, incr = 1;
                if (_.includes(["grosorbordeplantilla", "grosorborde"], tipo)) max = 9;
                if ("decimales" === tipo && o.appvm[id].tipo() === o.TE.Moneda) max = 2, incr = 2;
                $(e).find("input:text").css({ width: 165 }).numberspinner({
                    max: max, min: 0, increment: incr, editable: true, height: 30, value: v.p().val(), onChange: function (value) {
                        v.p().val(value);
                    }
                });
                _.includes(["grosorbordeplantilla", "grosorborde"], tipo) && $(e).find("input.textbox-text").attr("maxlength", 1);
            }
            else if (_.includes(["columnasmultieditar", "columnasvisualizar", "columnastotalizar"], tipo)) {
                data = [];
                var tabla = searchElementInJson(o, id),
                    m = o.appvm[id].nombrecolumnas() || [];
                tabla && m.length - 1 !== tabla.elementos.elemento.length && (m = [], m.push({ titulo: "Acciones", parent: "", id: "Acciones" }),
                    m = recursiveGetNameColumns(tabla.elementos.elemento, m, "", o), o.appvm[id].nombrecolumnas(m));
                for (sel = 0; sel < m.length; sel++)
                    o.appvm[m[sel].id] ?
                        (typeof o.appvm[id][tipo]()[m[sel].id] === "boolean" || (o.appvm[id][tipo]()[m[sel].id] = !0), o.appvm[id][tipo]()[m[sel].id] === !0 && selecteds.push(m[sel].id), data.push({ nombre: o.appvm[m[sel].id].titulo(), valor: m[sel].id })) :
                        delete o.appvm[id][tipo]()[m[sel].id];
                $(e).find("input").css({ width: 165, maxHeight: "70px" }).combobox({
                    data: data, textField: "nombre", idField: "valor", valueField: "valor", prompt: "Seleccione...", limitToList: !0,
                    panelHeight: "auto", panelMaxHeight: 200, multiple: !0, value: selecteds,
                    onChange: function () {
                        var sels = $(this).combobox("getValues");
                        for (sel in o.appvm[id][tipo]()) o.appvm[id][tipo]()[sel] = !1;
                        _.forEach(sels, function (sel) { o.appvm[id][tipo]()[sel] = !0; });
                    }
                });
            }
            else if (_.includes(["contenidoestatico", "resumen"], tipo)) {
                var acceptsummary = [o.TE.CodigoBarras, o.TE.Fecha, o.TE.Hora, o.TE.Lista, o.TE.Moneda, o.TE.Numero, o.TE.RangoFechas, o.TE.TextArea, o.TE.Texto], apdata = "";
                var fdata = [];
                _.forEach(_.keys(o.appvm[id][tipo]()), function (m) { !o.appvm[m] ? delete o.appvm[id][tipo]()[m] : fdata.push(m); });
                _.forEach(_.keys(o.appvm), function (v) {
                    v.indexOf('formElec_element') === 0 && _.includes(acceptsummary, o.appvm[v].tipo()) && !checkIfElementIsInParentsType(o, v, o.TE.Tabla)
                        && !_.includes(fdata, v) && fdata.push(v);
                });
                var actdata = function () { o.appvm[id][tipo]({}), _.forEach($(e).find('.dataresumen input:checked'), function (v) { o.appvm[id][tipo]()[v.id] = ""; }); };
                for (var w = 0; w < fdata.length; w++)
                    apdata += '<tr><td style="display:inline-grid; padding: 0px 10px;"><i style="cursor:pointer;min-height:10px" ',
                        w > 0 && (apdata += 'class="fas fa-angle-up"'), apdata += '></i><i style="cursor:pointer;min-height:10px" ',
                        w < fdata.length - 1 && (apdata += 'class="fas fa-angle-down"'), apdata += '></i></td><td field>' +
                        o.appvm[fdata[w]].titulo() + '</td><td><input id="' + fdata[w] + '" type="checkbox" ', o.appvm[id][tipo]()[fdata[w]] === "" && (apdata += ' checked'), apdata += '></td></tr>';
                $(e).find('.dataresumen').append(apdata);
                $(e).find('.fa-angle-down').on('click', function (e) {
                    var em = $($(e.target).closest("tr")).find('td:not(:first-child)'); var nem = $($(e.target).closest("tr")).next().find('td:not(:first-child)');
                    nem[0] && em.last().after(nem), $($(e.target).closest("tr")).next().find('td:nth-child(1)').after(em); actdata();
                });
                $(e).find('.fa-angle-up').on('click', function (e) {
                    var em = $($(e.target).closest("tr")).find('td:not(:first-child)'); var nem = $($(e.target).closest("tr")).prev().find('td:not(:first-child)');
                    nem[0] && em.last().after(nem), $($(e.target).closest("tr")).prev().find('td:nth-child(1)').after(em); actdata();
                });
                $(e).find('input[type=checkbox]').on('click', function () { actdata(); });
            }
            else if (tipo === "navegacion") {
                var apdata1 = "", fdata1 = [], valsel = "", actdata1, listvals = o.appvm[id][tipo]().split(",");
                _.forEach(listvals, function (m) { !o.appvm[m] || fdata1.push(m); });
                _.forEach(_.keys(o.appvm), function (v) { v.indexOf('formElec_element') === 0 && o.appvm[v].tipo() === o.TE.Pagina && !_.includes(fdata1, v) && fdata1.push(v); });
                actdata1 = function () {
                    listvals = [], _.forEach($(e).find('.dataresumen input:checked'), function (v) { listvals.push(v.id); });
                    o.appvm[id][tipo](listvals.join(","));
                };
                for (var w1 = 0; w1 < fdata1.length; w1++)
                    valsel = _.find(listvals, function (dve) { return dve === fdata1[w1]; }),
                        apdata1 += '<tr><td style="display:inline-grid; padding: 0px 10px;"><i style="cursor:pointer;min-height:10px" ',
                        w1 > 0 && (apdata1 += 'class="fas fa-angle-up"'), apdata1 += '></i><i style="cursor:pointer;min-height:10px" ',
                        w1 < fdata1.length - 1 && (apdata1 += 'class="fas fa-angle-down"'), apdata1 += '></i></td><td field>' +
                        o.appvm[fdata1[w1]].titulo() + '</td><td><input id="' + fdata1[w1] + '" type="checkbox" ', !valsel || (apdata1 += ' checked'), apdata1 += '></td></tr>';
                $(e).find('.dataresumen').append(apdata1);
                $(e).find('.fa-angle-down').on('click', function (e) {
                    var em = $($(e.target).closest("tr")).find('td:not(:first-child)'); var nem = $($(e.target).closest("tr")).next().find('td:not(:first-child)');
                    nem[0] && em.last().after(nem), $($(e.target).closest("tr")).next().find('td:nth-child(1)').after(em); actdata1();
                });
                $(e).find('.fa-angle-up').on('click', function (e) {
                    var em = $($(e.target).closest("tr")).find('td:not(:first-child)'); var nem = $($(e.target).closest("tr")).prev().find('td:not(:first-child)');
                    nem[0] && em.last().after(nem), $($(e.target).closest("tr")).prev().find('td:nth-child(1)').after(em); actdata1();
                });
                $(e).find('input[type=checkbox]').on('click', function () { actdata1(); });
            }
            else if (tipo === "cascadahijo") {
                data = _.compact(_.map(_.filter(o.appvm.elementsList(), function (z) { return z !== id; }), function (z) {
                    if (o.appvm[z]) return { Nombre: o.appvm[z].titulo(), Valor: z };
                    return false;
                }));
                $(e).find(".combolists").css({ width: 185 }).combobox({
                    limitToList: !0, panelHeight: "auto", panelMaxHeight: 200, data: data, idField: 'Valor', textField: "Nombre", valueField: "Valor", prompt: "Seleccione...",
                    onChange: function (val) { o.appvm[id].cascadahijo(val); }, value: v.p().val()
                });
            }
            else if (_.includes(["fechamin", "fechamax"], tipo)) {
                $(e).find("input:text").css({ width: 165 }).numberspinner({
                    increment: 1, editable: true, height: 30, value: v.p().val(), onChange: function (value) { v.p().val(value); }
                });
            }
            else if (_.includes(["plantillaabrir", "prellenadomapeocampos", "mapeopdfligar", "personafirma", "elementodocumento", "tipodoc", "imagenanverso", "imagenreverso", "imagenselfie", "videoselfie", "videodocumentosselfie", "tokenshared"], tipo)) {
                var container = tipo === "mapeopdfligar" ? "pdfmapping" : "prefilleddata", name = tipo === "mapeopdfligar" ? "customname" : "name";
                var basearr = [], faddoc = o.appvm[id].tipo() === o.TE.FirmaFAD && tipo === "tipodoc";
                if (tipo === "personafirma")
                    basearr = _.map(_.filter(_.keys(o.appvm), function (elm) { return elm.indexOf("formElec_element") >= 0 && o.appvm[elm].tipo() === o.TE.Texto && o.appvm[elm].elementopadre() && o.appvm[o.appvm[elm].elementopadre()] && o.appvm[o.appvm[elm].elementopadre()].tipo() !== o.TE.Tabla; }), function (ekey) { return { Valor: ekey, Nombre: o.appvm[ekey].titulo() }; });
                else if (tipo === "elementodocumento")
                    basearr = _.map(_.filter(_.keys(o.appvm), function (elm) { return elm.indexOf("formElec_element") >= 0 && o.appvm[elm].tipo() === o.TE.Documento; }), function (ekey) { return { Valor: ekey, Nombre: o.appvm[ekey].titulo() }; });
                else if (tipo === "tipodoc")
                    basearr = _.cloneDeep(o.datatags.tipodochijos);
                else if (tipo === "imagenanverso" || tipo === "imagenreverso" || tipo === "imagenselfie")
                    basearr = _.map(_.filter(_.keys(o.appvm), function (elm) { return elm.indexOf("formElec_element") >= 0 && _.includes([o.TE.Imagen, o.TE.Documento], o.appvm[elm].tipo()) && o.appvm[elm].elementopadre() && o.appvm[o.appvm[elm].elementopadre()] && o.appvm[o.appvm[elm].elementopadre()].tipo() !== o.TE.Tabla; }), function (ekey) { return { Valor: ekey, Nombre: o.appvm[ekey].titulo() }; });
                else if (tipo === "videoselfie" || tipo === "videodocumentosselfie")
                    basearr = _.map(_.filter(_.keys(o.appvm), function (elm) { return elm.indexOf("formElec_element") >= 0 && _.includes([o.TE.Video], o.appvm[elm].tipo()) && o.appvm[elm].elementopadre() && o.appvm[o.appvm[elm].elementopadre()] && o.appvm[o.appvm[elm].elementopadre()].tipo() !== o.TE.Tabla; }), function (ekey) { return { Valor: ekey, Nombre: o.appvm[ekey].titulo() }; });
                else if (tipo === "tokenshared")
                    basearr = _.map(_.filter(_.keys(o.appvm), function (elm) { return elm.indexOf("formElec_element") >= 0 && _.includes([o.TE.Texto], o.appvm[elm].tipo()) && o.appvm[elm].elementopadre() && o.appvm[o.appvm[elm].elementopadre()] && o.appvm[o.appvm[elm].elementopadre()].tipo() !== o.TE.Tabla; }), function (ekey) { return { Valor: ekey, Nombre: o.appvm[ekey].titulo() }; });
                else
                    basearr = _.map(_.keys(o.appvm[o.idPlantilla][container]()), function (vel) { return { Nombre: o.appvm[o.idPlantilla][container]()[vel][name], Valor: vel }; });
                var valact = faddoc ? elemsExist(basearr, v.p().val().toString().split(","), 'Valor') : elemsExist(basearr, v.p().val().toString(), 'Valor');
                $(e).find("input").css({ width: 165 }).combobox({
                    limitToList: !0, panelHeight: "auto", panelMaxHeight: 200, data: basearr, idField: 'Valor', textField: "Nombre", valueField: "Valor", prompt: "Seleccione...", value: valact, multiple: faddoc,
                    onChange: function (nv, ov) {
                        if (faddoc && nv.length > 3) {
                            $(this).combobox("setValues", _.take(nv, 3));
                            toasty('', 'Solo se permite seleccionar un máximo de tres tipos de documento.');
                        }
                        else
                            v.p().val(nv.toString());
                    }
                });
                v.p().val(valact.toString());
            }
            else if (tipo === "tipificacionpermitida") {
                selindex = [];
                var docs = [], currentvals = {}, origvals = o.appvm[id].tipificacionpermitida(),
                    typidoc = function (i, row) {
                        currentvals["tipodoc_" + row.Valor].enabled = !0, o.appvm[id].tipificacionpermitida.silentUpdate(currentvals);
                    },
                    untypidoc = function (i, row) { currentvals["tipodoc_" + row.Valor].enabled = !1, o.appvm[id].tipificacionpermitida.silentUpdate(currentvals); },
                    edittype = function (i, row, changes) {
                        var key = _.keys(changes);
                        if (key) currentvals["tipodoc_" + row.Valor][key] = changes[key];
                        o.appvm[id].tipificacionpermitida.silentUpdate(currentvals);
                    };
                _.forEach(o.datatags.tipodochijos, function (elm) {
                    var idtipo = "tipodoc_" + + elm.Valor;
                    currentvals[idtipo] = origvals[idtipo] ? origvals[idtipo] : { enabled: !1, min: 0, max: 0 };
                    docs.push({ Valor: elm.Valor, Nombre: elm.Nombre, max: currentvals[idtipo].max, min: currentvals[idtipo].min });
                });
                o.appvm[id].tipificacionpermitida.silentUpdate(currentvals);
                var dg = $(e).find("select").css({ width: 335, height: "90px", editorHeight: "90px" }).datalist({
                    data: docs, idField: 'Valor', valueField: 'Valor', textField: 'Nombre', striped: !0, collapsible: true,
                    singleSelect: !1, checkbox: !0, onEndEdit: edittype, nowrap: !1, onCheck: typidoc, onUncheck: untypidoc,
                    onSelect: function (f) { $(e).find(".datagrid-row-selected").removeClass("datagrid-row-selected"); },
                    columns: [[
                        {
                            field: 'Nombre', title: 'Tipo', formatter: function (value, row, index) {
                                currentvals["tipodoc_" + row.Valor] && currentvals["tipodoc_" + row.Valor].enabled && selindex.push(index);
                                return he.decode(value);
                            }
                        },
                        { field: 'min', title: 'Mín', editor: { type: 'numberbox' }, align: "right", width: 65 },
                        { field: 'max', title: 'Máx', editor: { type: 'numberbox' }, align: "right", width: 65 }
                    ]]
                });
                dg.datagrid('enableCellEditing').datagrid('gotoCell', { index: 0, field: 'Valor' });
                $.each(selindex, function (i, n) { $(e).find("select").datalist("checkRow", n); });
            }
            else if (tipo === "tipificacionunica") {
                var typuni = o.appvm[id].tipificacionunica() ? o.appvm[id].tipificacionunica() : { enabled: !1, idtype: '' };
                o.appvm[id].tipificacionunica(typuni);
                $(e).find(".checkuni").switchbutton({
                    checked: typuni.enabled, onChange: function (checked) {
                        o.appvm[id].tipificacionunica().enabled = checked;
                        checked ? $(e).find(".capdoc").removeAttr("hidden") : $(e).find(".capdoc").attr("hidden", "");
                    }
                });
                $(e).find(".seldoc").combobox({
                    data: o.datatags.tipodochijos, valueField: 'Valor', idField: 'Valor', textField: 'Nombre', value: typuni.idtype, limitToList: !0,
                    panelHeight: "auto", panelMaxHeight: 200, prompt: "Seleccione...", onChange: function (nv, ov) { o.appvm[id].tipificacionunica().idtype = nv; }
                });
                typuni.enabled && $(e).find(".capdoc").removeAttr("hidden");
            }
            else if ("filtrarcatalogo" === tipo && o.appvm[id].catalogoorigen && o.appvm[id].catalogoorigen() !== "") {
                if (o.datatags.allitemscatalogs["catalogos|" + o.appvm[id].catalogoorigen()]) {
                    var filtrarinf = function (nofilter) {
                        o.appvm[id].filtrarcatalogo({
                            filtrar: !(nofilter === !0),
                            idfiltrados: nofilter === !0 ? "" : $(e).find("div.easyui-combobox").combobox("getValues").join(","),
                            rangofiltrado: $(e).find('#sliceCat:input').val()
                        });
                    };
                    $(e).find("div.easyui-combobox").css({ width: 165 }).combobox({
                        value: o.appvm[id].filtrarcatalogo().idfiltrados ? o.appvm[id].filtrarcatalogo().idfiltrados.toString().split(",") : "", textField: "Nombre", valueField: "Valor", data: o.datatags.allitemscatalogs["catalogos|" + o.appvm[id].catalogoorigen()],
                        prompt: "Seleccione...", panelHeight: "auto", panelMaxHeight: 200, idField: "Valor", multiple: !0, onChange: filtrarinf
                    });

                    $(e).find(".filtdata").on("click", function () {
                        $(this).hasClass("fa-square") ? ($(this).removeClass("fa-square").addClass("fa-check-square"), $(e).find("div.easyui-combobox").combobox("enable"), $(e).find('#sliceCat:input').removeAttr("disabled"), filtrarinf()) :
                            ($(this).removeClass("fa-check-square").addClass("fa-square"), $(e).find("div.easyui-combobox").combobox("disable"), $(e).find('#sliceCat:input').attr("disabled", ""), filtrarinf(!0));
                    });
                    o.appvm[id].filtrarcatalogo().filtrar === !0 ? $(e).find(".fa-square").click() : $(e).find("div.easyui-combobox").combobox("disable");
                }
            }
            else if (_.includes(["cargaimportacion", "cargacamara", "opcionrequerida"], tipo)) {
                $(e).find("input").css({ width: 165 }).combobox({
                    value: o.appvm[id][tipo]().toString().split(","), textField: "Nombre", valueField: "Valor", data: o.datatags.allitemscatalogs[o.appvm[id].fuentedatos() + "|" + o.appvm[id].catalogoorigen()],
                    prompt: "Seleccione...", panelHeight: "auto", panelMaxHeight: 200, idField: "Valor", multiple: !0,
                    disabled: !o.datatags.allitemscatalogs["catalogos|" + o.appvm[id].catalogoorigen()],
                    onChange: function (e) {
                        o.appvm[id][tipo](_.filter($(this).combobox("getValues"), function (elm) { return elm !== ""; }).join(","));
                    }
                });
            }
            else if (tipo === "fuentedatos") v.p().val.valueHasMutated();
            else if (_.includes(["huellasacapturar", "acciones"], tipo)) {
                selindex = [], data = tipo === "acciones" ?
                    [{ Nombre: "Guiño", Valor: 1 }, { Nombre: "Boca abierta", Valor: 2 }, { Nombre: "Asiente lentamente", Valor: 3 }, { Nombre: "Sacude tu cabeza de izquierda a derecha", Valor: 4 }]
                    : [{ Nombre: "Pulgar Derecho", Valor: 1 }, { Nombre: "Indice Derecho", Valor: 2 }, { Nombre: "Medio Derecho", Valor: 3 },
                    { Nombre: "Anular Derecho", Valor: 4 }, { Nombre: "Me&ntilde;ique Derecho", Valor: 5 }, { Nombre: "Pulgar Izquierdo", Valor: 6 },
                    { Nombre: "Indice Izquierdo", Valor: 7 }, { Nombre: "Medio Izquierdo", Valor: 8 }, { Nombre: "Anular Izquierdo", Valor: 9 },
                    { Nombre: "Me&ntilde;ique Izquierdo", Valor: 10 }, { Nombre: "Palma Derecho", Valor: 11 }, { Nombre: "Palma Izquierdo", Valor: 12 },
                    { Nombre: "Pulgares", Valor: 13 }];

                $(e).find("input").css({ width: 165 }).combobox({
                    data: data, textField: "Nombre", idField: "Valor", value: v.p().val().toString(), prompt: "Seleccione...",
                    valueField: "Valor", multiple: !0, limitToList: !0, panelHeight: "auto", panelMaxHeight: 200,
                    onChange: function () { v.p().val($(this).combobox("getValues").join()); }
                });
            }
            else if (_.includes("catalogoorigen", tipo)) {
                data = [], o.appvm[id].catalogossistema && o.appvm[id].catalogossistema() === true ? data = o.datatags.catalogos :
                    data = _.filter(o.datatags.catalogos, function (it) { return parseInt(it.Valor) > 20; }),
                    o.appvm[id].catalogoorigen() || o.appvm[id].catalogoorigen(data.length > 0 ? data[0].Valor.toString() : "");
                $(e).find("input").css({ width: 165 }).combobox({
                    data: data, value: o.appvm[id].catalogoorigen(), prompt: "Seleccione...", limitToList: !0, panelHeight: "auto", panelMaxHeight: 200,
                    valueField: 'Valor', textField: 'Nombre', groupField: "Grupo", idField: "Valor", groupPosition: "sticky",
                    onChange: function (item) {
                        if (!isNaN(Number(item))) {
                            v.p().val(item);
                            if (item) {
                                if (o.datatags.allitemscatalogs[o.appvm[id].fuentedatos() + "|" + o.appvm[id].catalogoorigen()])
                                    checkTipoListaDefaultItemAndSet(o, id);
                                else {
                                    $.ajax({
                                        url: o.datasend.urlGlobal + "FEConfigurador.aspx/ObtieneItemCat",
                                        data: JSON.stringify({ fd: o.appvm[id].fuentedatos().charAt(0).toUpperCase() + o.appvm[id].fuentedatos().slice(1), proyid: o.datasend.proyid, catId: item, expid: o.datasend.expId }),
                                        success: function (j) {
                                            j = j.d;
                                            if (j.Success) {
                                                o = getOpts();
                                                o.datatags.allitemscatalogs[o.appvm[id].fuentedatos() + "|" + item] = j.ReturnedObject;
                                                checkTipoListaDefaultItemAndSet(o, id);
                                            } else Error(j.Titulo, j.Mensaje);
                                        },
                                        error: function (e) { errorFormElec(o, e); }
                                    });
                                }
                            }
                        }
                    }
                });
            }
            else if (tipo === "catalogofuente") {
                $(e).find("input").css({ width: 165 }).combobox({
                    data: o.datatags.catalogosdocumento, value: v.p().val(), valueField: 'Valor', textField: 'Nombre', prompt: "Seleccione...", limitToList: !0,
                    panelHeight: "auto", panelMaxHeight: 200,
                    onSelect: function (item) {
                        v.p().val(item.Valor);

                        //esquema: campos de salida
                        var camposSalida = !!item.Esquema && verifyJsonString(item.Esquema) ? JSON.parse(item.Esquema) : [];
                        if (camposSalida) {
                            $("#campobusqueda" + id).combobox("loadData", camposSalida);
                            $("#valordescripcion" + id).combobox("loadData", camposSalida);
                            $("#valorid" + id).combobox("loadData", camposSalida);
                        }
                        //catalogoid: campos filtro
                        var camposFiltro = !!item.CatalogoId && verifyJsonString(item.CatalogoId) ? JSON.parse(item.CatalogoId) : [];
                        if (camposFiltro.length) {
                            var datatable = [];
                            for (var elemc in o.appvm)
                                elemc !== id && elemc.indexOf("formElec_element") >= 0 && o.appvm[elemc].valor && datatable.push({ id: elemc, nom: o.appvm[elemc].titulo() });

                            $("#camposfiltros" + id).html("<thead><tr><th>Nombre<br/>campo</th><th></th><th>Elemento</th></tr></thead>");
                            _.forEach(camposFiltro, function (elm) {
                                elm.NombreCampo = elm.NombreCampo.replace(/\s/g, '');
                                $("#camposfiltros" + id).append("<tr><td>" + elm.Tabla.replace(/\./g, '') + "</td><td style='white-space:nowrap'>" + elm.Operador + "<td><div id=" + elm.Tabla.replace(/\./g, '') + "></div></td></tr>");
                                $("#camposfiltros" + id).find("#" + elm.Tabla.replace(/\./g, '')).css({ width: "100px" }).combobox({
                                    data: datatable, valueField: "id", textField: "nom", prompt: "Seleccione...", limitToList: !0,
                                    value: elemsExist(datatable, o.appvm[id].camposfiltros()[elm.NombreCampo], "id"),
                                    onChange: function () {
                                        if (!$(this).combobox("getValue")) delete o.appvm[id].camposfiltros()[elm.NombreCampo];
                                        else o.appvm[id].camposfiltros()[elm.NombreCampo] = $(this).combobox("getValue");
                                    }
                                });
                            });
                        }
                        else $("#camposfiltros" + id).html('<div class="text-muted p-1 text-center">No existe informaci&oacute;n</div>');
                    },
                    onUnselect: function () {
                        $("#campobusqueda" + id).combobox("loadData", []), $("#valordescripcion" + id).combobox("loadData", []), $("#valorid" + id).combobox("loadData", []);
                        $("#campobusqueda" + id).combobox("clear"), $("#valordescripcion" + id).combobox("clear"), $("#valorid" + id).combobox("clear");
                        $("#camposfiltros" + id).html('<div class="text-muted p-1 text-center">No existe informaci&oacute;n</div>');
                        o.appvm[id].campobusqueda(""), o.appvm[id].valordescripcion(""), o.appvm[id].valorid(""), v.p().val(""), o.appvm[id].camposfiltros({});
                    }
                });
            }
            else if (_.includes(["valordescripcion", "valorid", "campobusqueda"], tipo)) {
                var selval = _.find(o.datatags.catalogosdocumento, { Valor: o.appvm[id].catalogofuente() });
                data = !!selval && verifyJsonString(selval.Esquema) ? JSON.parse(selval.Esquema) : [];
                $(e).find("input").css({ width: 165 }).combobox({
                    data: data, value: v.p().val().toString().split(","), valueField: tipo === "campobusqueda" ? "Tabla" : 'Campo', textField: 'NombreCampo', limitToList: !0,
                    prompt: "Seleccione...", multiple: tipo === "valordescripcion", panelHeight: "auto", panelMaxHeight: 200,
                    onChange: function () { v.p().val(_.filter($(this).combobox("getValues"), function (elm) { return elm !== ""; }).join(",")); }
                });
            }
            else if (tipo === "camposfiltros") {
                var selfilter = _.find(o.datatags.catalogosdocumento, { Valor: o.appvm[id].catalogofuente() });
                var jsonfilter = !!selfilter && verifyJsonString(selfilter.CatalogoId) ? JSON.parse(selfilter.CatalogoId) : [];
                if (jsonfilter.length) {
                    data = [];
                    for (var elemc in o.appvm)
                        elemc !== id && elemc.indexOf("formElec_element") >= 0 && _.includes([o.TE.CodigoBarras, o.TE.CodigoQR, o.TE.Deslizante,
                        o.TE.Fecha, o.TE.Hora, o.TE.Lista, o.TE.ComboBoxTemporal, o.TE.ComboDinamico, o.TE.Logico, o.TE.Moneda, o.TE.Numero,
                        o.TE.Texto, o.TE.TextArea], o.appvm[elemc].tipo()) && data.push({ id: elemc, nom: o.appvm[elemc].titulo() });

                    $(e).find("table").html("<thead><tr><th>Nombre<br/>campo</th><th></th><th>Elemento</th></tr></thead>");
                    _.forEach(jsonfilter, function (elm) {
                        elm.NombreCampo = elm.NombreCampo.replace(/\s/g, '');
                        $(e).find("table").append("<tr><td>" + elm.Tabla.replace(/\./g, '') + "</td><td style='white-space:nowrap'>" + elm.Operador + "<td><div id=" + elm.Tabla.replace(/\./g, '') + "></div></td></tr>");
                        $(e).find("#" + elm.Tabla.replace(/\./g, '')).css({ width: "100px" }).combobox({
                            data: data, valueField: "id", textField: "nom", prompt: "Seleccione...", limitToList: !0,
                            value: elemsExist(data, o.appvm[id].camposfiltros()[elm.NombreCampo], "id"),
                            onChange: function () {
                                if (!$(this).combobox("getValue")) delete o.appvm[id].camposfiltros()[elm.NombreCampo];
                                else o.appvm[id].camposfiltros()[elm.NombreCampo] = $(this).combobox("getValue");
                            }
                        });
                    });
                }
                else $(e).find("table").html('<div class="text-muted p-1 text-center">No existe informaci&oacute;n</div>');
            }
            else if (_.includes("elementoavalidar", tipo)) {
                data = [];
                for (var elem in o.appvm)
                    elem.indexOf("formElec_element") >= 0 && _.includes([o.TE.Pagina, o.TE.Seccion], o.appvm[elem].tipo()) && data.push({
                        id: elem, nom: (o.idPlantilla === elem ? "Formato" : _.capitalize(o.appvm[elem].tipo())) + "-" + o.appvm[elem].titulo()
                    });
                $(e).find("input").css({ width: 165 }).combobox({
                    data: data, value: o.appvm[id].elementoavalidar(), valueField: 'id', prompt: "Seleccione...", limitToList: !0, panelHeight: "auto",
                    panelMaxHeight: 200, textField: 'nom', idField: "id", onSelect: function (item) { o.appvm[id].elementoavalidar(item.id); }
                });
            }
            else if (_.includes("tipocodigo", tipo)) {
                var isLoad = true;
                $(e).find("select").on("change", function (f) {
                    if (isLoad) {
                        $(f.target).val(v.p().val());
                        isLoad = false;
                    }
                    o = getOpts();
                    var selectedOpt = o.datatags[tipo][f.target.selectedIndex];
                    if (selectedOpt) {
                        o.appvm[id].ayuda(selectedOpt.Icono);
                        o.appvm[id].expresionregular(selectedOpt.CveCatalogo);
                        o.appvm[id].regexrerrormsg("Solo se aceptan: " + selectedOpt.Icono);
                        $('#' + id).find('.float-right').attr("data-original-title", he.decode(selectedOpt.Icono));
                    }

                });
            }
            else if (_.includes(["extensionespermitidas"], tipo)) {
                $(e).find("input").css({ width: 165 }).combobox({
                    data: o.datatags.catext, textField: "descripcion", idField: "descripcion", value: v.p().val(), prompt: "Seleccione...",
                    valueField: "descripcion", multiple: !0, limitToList: !0, panelHeight: "auto", panelMaxHeight: 200,
                    onChange: function () { v.p().val($(this).combobox("getValues").join()); }
                });
            }
            else if (tipo === "idelementovideo") {
                data = [];
                for (var elemv in o.appvm)
                    elemv.indexOf("formElec_element") >= 0 && o.appvm[elemv].tipo() === o.TE.Video && data.push({
                        id: elemv, nom: o.appvm[elemv].titulo()
                    });
                $(e).find("input").css({ width: 165 }).combobox({
                    data: data, value: v.p().val(), prompt: "Seleccione...", valueField: 'id', textField: 'nom', limitToList: !0,
                    onSelect: function (item) { v.p().val(item.id); }, onUnselect: function () { v.p().val(""); }
                });
            }
            else if (_.isFunction(v.p().val) && _.isBoolean(v.p().val())) {
                $(e).removeClass("col-sm-6 col-6").find("input").switchbutton({
                    checked: v.p().val() === true, onChange: function (checked) { v.p().val(checked); }
                });
                if (tipo === "catalogossistema") v.p().val.valueHasMutated();
            }
        }
        function renderExtraDomElemento(v, e, vacc) {
            var o = getOpts(), tipo = v.p ? v.p().tipo() : v.tipo(), id = v.p ? v.p().id() : v.id(), ele = $(e), valueNumber;
            if (_.includes([o.TE.Pagina, o.TE.Seccion, o.TE.Tabla, o.TE.Tabber], tipo)) {
                tipo === o.TE.Pagina && (o.appvm.isEditor() || o.appvm[id].visible()) && o.pageshowed === "" && (o.pageshowed = id);
                tipo === o.TE.Seccion && o.appvm[o.appvm[id].elementopadre()].tipo() === o.TE.Tabber && redrawSectionsOnTabber(o, id);
                if (tipo === o.TE.Tabla) {
                    verifyAttrsPerRow(o, id);
                    if (o.appvm[id].alternarcolorfilas())
                        insertRule(["table.alternatecolor tr:nth-child(2n)"], "background-color: " + o.appvm[id].colorpares()),
                            insertRule(["table.alternatecolor tr:nth-child(2n+1)"], "background-color: " + o.appvm[id].colorimpares());
                    o.appvm[id].modetable("normalmode");
                }
            }
            else if (tipo === o.TE.Mapa && vacc() === "mapa") {
                if (o.drawPreviewer && !o.queryModel && o.appvm[id].habilitado()) {
                    var mapsuccess = function () {
                        var lat = "19.4141106", lon = "-99.2031959";
                        if (o.coordenadas.get === !0) { //si ya hay coordenadas, se usan, sino harcode
                            lat = o.coordenadas.lat;
                            lon = o.coordenadas.lon;
                        } else if (!_.isEmpty(o.appvm[id].valor())) {
                            var cords = o.appvm[id].valor().split(",");
                            lat = cords[0].trim();
                            lon = cords[1].trim();
                        }
                        o.appvm[id].valor(lat + "," + lon), ele.css({ "height": 300, "width": ele.parent().outerWidth() - 10 });

                        var view = new ol.View({ center: ol.proj.fromLonLat([lon, lat]), zoom: 17 });
                        var mapgeolo = new ol.Map({ target: "map" + id, layers: [new ol.layer.Tile({ source: new ol.source.OSM() })], view: view });
                        var marker = new ol.Feature({ geometry: new ol.geom.Point(ol.proj.fromLonLat([lon, lat])) });
                        var geocoder = new Geocoder('nominatim', {
                            provider: 'osm',
                            targetType: 'glass-button',
                            lang: 'en-US',
                            autoComplete: !0,
                            placeholder: 'Buscar...',
                            limit: 5,
                            keepOpen: !0,
                        });
                        var styl = new ol.style.Style({
                            image: new ol.style.Circle({
                                radius: 5, fill: new ol.style.Fill({ color: 'rgba(0,0,0,1)' }),
                                stroke: new ol.style.Stroke({ color: 'rgba(0,0,0,1)', width: 14 })
                            })
                        });
                        var popup = new ol.Overlay.Popup();
                        marker.setStyle(styl);
                        var vect = new ol.layer.Vector({ source: new ol.source.Vector({ features: [marker] }) });
                        mapgeolo.addLayer(vect), mapgeolo.renderSync(), mapgeolo.on("singleclick", function (evt) {
                            var latLong = ol.proj.transform(evt.coordinate, 'EPSG:3857', 'EPSG:4326'),
                                lat2 = latLong[1], lon2 = latLong[0];

                            o.appvm[id].valor(lat2 + "," + lon2), mapgeolo.removeLayer(vect);
                            marker = new ol.Feature({ geometry: new ol.geom.Point(ol.proj.fromLonLat([lon2, lat2])) });
                            marker.setStyle(styl);
                            vect = new ol.layer.Vector({ source: new ol.source.Vector({ features: [marker] }) });
                            mapgeolo.addLayer(vect)
                            view.animate({
                                center: ol.proj.fromLonLat([lon2, lat2]),
                                duration: 500,
                            });
                            popup.hide(), removemarkers(!0);
                        });
                        mapgeolo.addControl(geocoder);
                        mapgeolo.addOverlay(popup);
                        geocoder.on('addresschosen', function (evt) {
                            setTimeout(function () {
                                popup.show(evt.coordinate, evt.address.formatted), removemarkers(!1);
                                o.appvm[id].valor(evt.place.lat + "," + evt.place.lon), mapgeolo.removeLayer(vect);
                                view.animate({
                                    center: ol.proj.fromLonLat([evt.place.lon, evt.place.lat]),
                                    duration: 500,
                                });
                            }, 1000);
                        });
                        var removemarkers = function (all) {
                            for (var i = 0; i < mapgeolo.getLayers().array_.length; i++) {
                                if (mapgeolo.getLayers().array_[i].values_.name && mapgeolo.getLayers().array_[i].values_.name.indexOf("geocode") >= 0) {
                                    var laysour = mapgeolo.getLayers().array_[i].getSource();
                                    var feat = laysour.getFeatures();
                                    var last = all === !0 ? 0 : 1;
                                    for (var w = 0; w < feat.length - last; w++) {
                                        laysour.removeFeature(feat[w]);
                                    }
                                }
                            }
                        };
                        updateOpts(o, true);
                    };
                    mapsuccess();//mapa sin coordenadas, ubicacion harcodeada mexico polanco
                }
            }
            else if (tipo === o.TE.Numero) {
                o.appvm[id].separadormiles().indexOf("\"") >= 0 && o.appvm[id].separadormiles("");
                o.appvm[id].valormetadato() === o.appvm[id].valor() && o.appvm[id].valor.valueHasMutated();
                if (o.appvm[id].convertirknob && o.appvm[id].convertirknob() === !0) {
                    ele.find("input:text").removeClass("form-control").knob({
                        readOnly: o.appvm[id].habilitado() === !1,
                        width: "30%",
                        displayInput: !0,
                        min: o.appvm[id].numerominimo(),
                        max: o.appvm[id].numeromaximo()
                    });
                }
                if (o.appvm[id].convertirtimer && o.appvm[id].convertirtimer() === !0) {
                    ele.find("input:text").removeClass("form-control").addClass("hidden");
                }
            }
            else if (tipo === o.TE.Deslizante) {
                //harcode ya que estas propiedades desapareceran
                o.appvm[id].prefijo(""), o.appvm[id].prefijo(""), o.appvm[id].decimales(0);

                o.appvm[id].valor() === "" && o.appvm[id].valor(0);
                o.appvm[id].valor() < o.appvm[id].numerominimo() && o.appvm[id].valor(o.appvm[id].numerominimo());
                o.appvm[id].valor() > o.appvm[id].numeromaximo() && o.appvm[id].valor(o.appvm[id].numeromaximo());
                o.appvm[id].valormetadato(o.appvm[id].valor());
                ele.find("input.slider").ionRangeSlider({
                    skin: o.appvm[id].estilos(), min: o.appvm[id].numerominimo(),
                    max: o.appvm[id].numeromaximo(), step: 1, from: o.appvm[id].valor(),
                    grid: o.appvm[id].mostrarrango(), grid_num: o.appvm[id].divisionesrango(),
                    block: o.appvm.isQuery() || o.appvm.isEditor() ? !0 : !o.appvm[id].habilitado(),
                    onChange: (data) => { o.appvm[id].valormetadato(data.from), o.appvm[id].valor(data.from); }
                });
            }
            else if (tipo === o.TE.Fecha || tipo === o.TE.RangoFechas) {
                var format = o.appvm[id].formatoObject.Valor().replace(/\/+/g, o.appvm[id].separador());
                if (o.appvm[id].fechamax && o.appvm[id].fechamax().toString().length === 0) o.appvm[id].fechamax(-9999);
                if (o.appvm[id].fechamin && o.appvm[id].fechamin().toString().length === 0) o.appvm[id].fechamin(-9999);
                o.appvm[id].valormetadatorango && !o.appvm[id].valormetadatorango() && o.appvm[id].valorinicial() && o.appvm[id].valorfinal() && o.appvm[id].valormetadatorango.silentUpdate(o.appvm[id].valorinicial() + " a " + o.appvm[id].valorfinal());
                ele.find("input:text").flatpickr({
                    dateFormat: format, "locale": "es", mode: o.appvm[id].tipo() === o.TE.RangoFechas ? "range" : "single",
                    maxDate: o.appvm[id].fechamax().toString() === "-9999" ? null : new Date().fp_incr(o.appvm[id].fechamax()),
                    minDate: o.appvm[id].fechamin().toString() === "-9999" ? null : new Date().fp_incr(-o.appvm[id].fechamin()),
                    defaultDate: o.appvm[id].tipo() === o.TE.RangoFechas ? [o.appvm[id].valorinicial(), o.appvm[id].valorfinal()] : o.appvm[id].valor(),
                    disableMobile: true
                });
                o.appvm[id].tipo() === o.TE.RangoFechas ?
                    !_.isEmpty(o.appvm[id].valormetadatorango()) && o.appvm[id].valormetadatorango.valueHasMutated() :
                    !_.isEmpty(o.appvm[id].valor().toString()) && o.appvm[id].valor.valueHasMutated();
            }
            else if (tipo === o.TE.Hora) {
                var optstime = {
                    autoclose: true, startView: 1, language: 'es', minuteStep: 15, maxView: 1,
                    format: o.appvm[id].horaObject.Nombre().indexOf("PM") >= 0 ? "HH:ii P" : "hh:ii",
                    showMeridian: o.appvm[id].horaObject.Nombre().indexOf("PM") >= 0
                };
                ele.find("input:text").datetimepickerfe(optstime);
                !_.isEmpty(o.appvm[id].valor()) && o.appvm[id].valor.valueHasMutated();
            }
            else if (tipo === o.TE.Wizard && !o.appvm.isEditor()) {
                if (!o.appvm.isEditor()) {
                    if (o.appvm[o.appvm[id].elementopadre()].tipo() === o.TE.Tabla) {
                        o.appvm[id].visible(!1), o.appvm[id].visibleavanzar(!1), o.appvm[id].visibleregresar(!1);
                        o.appvm[id].cantidadformatosabrir() > 0 && o.appvm[id].cantidadformatosabrircounter({});
                    }
                    else o.appvm[id].cantidadformatosabrir() > 0 && o.appvm[id].cantidadformatosabrircounter(o.appvm[id].cantidadformatosabrir());
                    o.appvm[id].valfin() === 0 && o.appvm[id].valfin(!o.appvm[id].paginaavanzar() ? 1 : 2);
                }
                if (o.appvm[id].navegacion() && !!o.appvm[id].navegacion()) {
                    var navlist = [];
                    _.forEach(o.appvm[id].navegacion().toString().split(","), function (snav) {
                        o.appvm[snav] && navlist.push(snav);
                    });
                    o.appvm[id].navegacion(navlist.join(",")), o.appvm[id].valfin(navlist.length);
                }
            }
            else if (tipo === o.TE.Moneda) o.appvm[id].valormetadato() === o.appvm[id].valor() && o.appvm[id].valor.valueHasMutated();
            else if (tipo === o.TE.Documento) {
                o.appvm[id].tipodocjson(!o.appvm[id].tipodoc() ? {} : JSON.parse(o.appvm[id].tipodoc())), o.appvm[id].metadatostipodocjson(!o.appvm[id].metadatostipodoc() ? {} : JSON.parse(o.appvm[id].metadatostipodoc()));
                if (o.drawPreviewer) {
                    $(e).find('.adddocument').on('click', (ob) => {
                        if ($(e).find('.adddocument').data("countclick")) return;
                        else $(e).find('.adddocument').data("countclick", true);
                        $("#mm").menu("destroy"), $(".menu:not('visible')").remove();
                        $("body").append('<div id="mm" class="easyui-menu" style="width: 180px;"></div>');
                        $("#mm").menu();
                        var countmenu = 0, indexmenu = 0;
                        if (o.appvm[id].permisocamara())
                            $("#mm").menu("appendItem", { text: o.appvm[id].textobotontomarfoto(), onclick: function () { customActionElement(id, [tipo, 'camera']); } }), indexmenu = 1, countmenu++;
                        if (o.appvm[id].permisoimportar())
                            $("#mm").menu("appendItem", { text: o.appvm[id].textobotonsubirarchivo(), onclick: function () { customActionElement(id, [tipo, 'import']); } }), indexmenu = 2, countmenu++;
                        if (o.appvm[id].permisoimportarvacio())
                            $("#mm").menu("appendItem", { text: "Sin documento", onclick: function () { customActionElement(id, [tipo, 'noimage']); } }), indexmenu = 3, countmenu++;
                        if (countmenu === 1 && indexmenu > 0) {
                            switch (indexmenu) {
                                case 1: customActionElement(id, [tipo, 'camera']); break;
                                case 2: customActionElement(id, [tipo, 'import']); break;
                                case 3: customActionElement(id, [tipo, 'noimage']); break;
                            }
                        }
                        else $("#mm").menu("show", { left: ob.pageX - 100, top: ob.pageY + 10, hideOnUnhover: false });
                        setTimeout(() => { $(e).find('.adddocument').removeData("countclick"); }, 2000);
                    });
                }
            }
            else if (tipo === o.TE.Audio) {
                if (o.drawPreviewer) {
                    $(e).find('.addaudio').on('click', (ob) => {
                        $("#mm").menu("destroy"), $(".menu:not('visible')").remove();
                        $("body").append('<div id="mm" class="easyui-menu" style="width: 180px;"></div>');
                        $("#mm").menu();
                        $("#mm").menu("appendItem", { text: "Micr&oacute;fono", disabled: !o.appvm[id].permisograbar(), onclick: function () { customActionElement(id, [tipo, 'mic']); } });
                        $("#mm").menu("appendItem", { text: "Importar", disabled: !o.appvm[id].permisoimportar(), onclick: function () { customActionElement(id, [tipo, 'import']); } });
                        $("#mm").menu("show", { left: ob.pageX - 100, top: ob.pageY + 10, hideOnUnhover: false });
                    });
                }
            }
            else if (tipo === o.TE.Imagen) {
                if (o.drawPreviewer) {
                    $(e).find('.addimagen').on('click', (ob) => {
                        $("#mm").menu("destroy"), $(".menu:not('visible')").remove();
                        $("body").append('<div id="mm" class="easyui-menu" style="width: 180px;"></div>');
                        $("#mm").menu();
                        $("#mm").menu("appendItem", { text: "C&aacute;mara", disabled: !o.appvm[id].permisocamara(), onclick: function () { customActionElement(id, [tipo, 'camera']); } });
                        $("#mm").menu("appendItem", { text: "Importar", disabled: !o.appvm[id].permisoimportar(), onclick: function () { customActionElement(id, [tipo, 'import']); } });
                        $("#mm").menu("show", { left: ob.pageX - 100, top: ob.pageY + 10, hideOnUnhover: false });
                    });
                }
            }
            else if (tipo === o.TE.PDFOCR) {
                o.drawPreviewer && $(e).find('.addpdf').on('click', () => { customActionElement(id, [tipo, 'import']); });
            }
            else if (tipo === o.TE.Boton) {
                if (o.appvm[o.appvm[id].elementopadre()].tipo() === o.TE.Tabla)
                    o.appvm[id].cantidadmaximaclic() > 0 && o.appvm[id].cantidadmaximacliccounter({});
                else o.appvm[id].cantidadmaximaclic() > 0 && o.appvm[id].cantidadmaximacliccounter(o.appvm[id].cantidadmaximaclic());
            }
            else if (tipo === o.TE.ComboDinamico) {
                if (o.appvm.isEditor()) {
                    o.appvm[id].catalogodestino([{ Valor: 1, Nombre: "Dato dummy 1" }, { Valor: 2, Nombre: "Dato dummy 2" }, { Valor: 3, Nombre: "Dato dummy 3" }]);
                }
                else {
                    var filtros = [], catori = _.find(o.datatags.catalogosdocumento, { Valor: o.appvm[id].catalogofuente().toString() });
                    if (catori && catori.CatalogoId && verifyJsonString(catori.CatalogoId)) {
                        var filtrosjson = JSON.parse(catori.CatalogoId);
                        _.forEach(filtrosjson, function (filtelm) {
                            filtelm.NombreCampo = filtelm.NombreCampo.replace(/\s/g, '');
                            var catfilt = o.appvm[o.appvm[id].camposfiltros()[filtelm.NombreCampo]], campval = catfilt && catfilt.valormetadato ? catfilt.valormetadato() : "";
                            filtros.push({ Operador: filtelm.Operador, Tabla: filtelm.Tabla, Valor: campval, ElementoId: o.appvm[id].camposfiltros()[filtelm.NombreCampo] });
                        });
                        if (o.appvm[id].valor().toString() && verifyJsonString(catori.Esquema) && o.appvm[id].tipolista() === "combo") {
                            var newcatori = JSON.parse(catori.Esquema), docbusqueda = _.find(newcatori, { Campo: o.appvm[id].valorid() });
                            !!docbusqueda && docbusqueda.Tabla && filtros.push({ Operador: "LIKE", Tabla: docbusqueda.Tabla, Valor: o.appvm[id].valormetadato(), ElementoId: id });
                        }
                    }
                    o.appvm[id].camposfiltrosjson = filtros;

                    if (o.appvm[id].tipolista() !== "combo") {
                        o.appvm[id].catalogodestino(loadRemoteData(o, id));
                        var valmet = o.appvm[id].valormetadato().toString().split(","), typemet = o.appvm[id].tipoasociacion() === "idid" || o.appvm[id].tipoasociacion() === "iddesc" ? "Valor" : "Nombre",
                            selecteds = _.filter(o.appvm[id].catalogodestino(), function (v) { return _.includes(valmet, v[typemet].toString()); });
                        o.appvm[id].tipolista() !== "checkbox" && (selecteds = _.head(selecteds));
                        o.appvm[id].chosenitems(selecteds);
                    }
                    else {
                        $(e).find("select").css({ width: "95%" }).combobox({
                            value: o.appvm[id].valormetadato().toString(), panelHeight: 'auto', disabled: !o.appvm.isQuery() ? !o.appvm[id].habilitado() : !0,
                            prompt: "Seleccione...", valueField: "Valor", textField: "Nombre", idField: "Valor",
                            selectOnNavigation: !1, delay: 500, limitToList: !0, panelMaxHeight: 200,
                            loader: function (param, success, error) {
                                var dataC = loadRemoteData(o, id);
                                success(dataC);
                                if (dataC.length === 1) {
                                    var setvalcombo = function () {
                                        $("#dynamiccombo" + id).combobox("setValue", dataC[0]["Valor"]), o.dynamicComboIntervals && o.dynamicComboIntervals[id] && clearInterval(o.dynamicComboIntervals[id]);
                                    };
                                    if (!$("#dynamiccombo" + id)[0]) {
                                        !o.dynamicComboIntervals && (o.dynamicComboIntervals = {});
                                        o.dynamicComboIntervals[id] = setInterval(function () {
                                            if ($("#dynamiccombo" + id)[0])
                                                setvalcombo();
                                        }, 100);
                                    }
                                    else setvalcombo();
                                }
                            },
                            onChange: function (nv) {
                                var valueSel = $(this).combobox("textbox").val(), selection = _.find($(this).combobox("getData"), function (itemcat) { return valueSel && valueSel !== "Seleccione..." ? itemcat["Nombre"] === valueSel : itemcat["Valor"] === nv; }), isSelection = !!selection;
                                if (!isSelection || !nv) {
                                    o.appvm[id].camposfiltrosjson.push({ Operador: "LIKE", Tabla: o.appvm[id].campobusqueda(), Valor: nv, ElementoId: id });
                                    $(this).combobox("reload");
                                }
                                valueSel = $(this).combobox("textbox").val(), selection = _.find($(this).combobox("getData"), function (itemcat) { return valueSel ? itemcat["Nombre"] === valueSel : itemcat["Valor"] === nv; }), isSelection = !!selection;
                                //se quita esto porque genera que no se pueda seleccionar por segunda vez
                                //o.appvm[id].valor(""), o.appvm[id].valormetadato("");
                                if (isSelection) {
                                    o.appvm[id].optionselected(selection);
                                    //nueva logica para poner el texto del objeto seleccionado y limpiar el combobox
                                    //$(this).combobox("clear");
                                } else o.appvm[id].valor(""), o.appvm[id].valormetadato("");
                            }
                        });
                    }
                }
            }
            else if (tipo === o.TE.Lista) checkTipoListaDefaultItemAndSet(o, id);
            else if (tipo === o.TE.MarcadoDocumentos) {
                checkTipoListaDefaultItemAndSet(o, id);
                $(e).find(".cbOptionsDocs").css({ minWidth: "100px", width: "95%" }).combobox({
                    data: o.appvm[id].catalogodestino(), panelHeight: 'auto', disabled: !o.appvm.isQuery() && !o.appvm.isEditor() ? !o.appvm[id].habilitado() : !0,
                    prompt: "Seleccione...", valueField: "Valor", textField: "Nombre", idField: "Valor", panelMaxHeight: 200, limitToList: !0,
                    onSelect: function (e) {
                        if (!!o.appvm[id].elementodocumento() && o.appvm[o.appvm[id].elementodocumento()] && o.appvm[o.appvm[id].elementodocumento()].tipo() === o.TE.Documento) {
                            var docHijo = _.head(_.filter(o.datatags.tipodochijos, { Valor: e.Valor.toString() }));
                            var docE = o.appvm[o.appvm[id].elementodocumento()];

                            docE.visible(docE.anexo().length > 0 || !!docHijo || !!e.Foto || !!e.Carga), docE.permisocamara(!!docHijo && !!e.Foto), docE.permisoimportar(!!docHijo && !!e.Carga);
                            docHijo ? docE.tipificacionunica({ enabled: !0, idtype: docHijo.Valor }) : docE.tipificacionunica({ enabled: !1, idtype: "" });
                            docE.permisotipificar(!1);
                        }
                        else { toasty('', 'No se ha relacionado un elemento documento', 'error'); }
                    },
                    onUnselect: function () {
                        if (!!o.appvm[id].elementodocumento() && o.appvm[o.appvm[id].elementodocumento()] && o.appvm[o.appvm[id].elementodocumento()].tipo() === o.TE.Documento) {
                            o.appvm[o.appvm[id].elementodocumento()].visible(o.appvm[o.appvm[id].elementodocumento()].anexo().length > 0);
                            o.appvm[o.appvm[id].elementodocumento()].permisocamara(!1);
                            o.appvm[o.appvm[id].elementodocumento()].permisoimportar(!1);
                        }
                    }
                });
                if (!o.appvm.isEditor() && !!o.appvm[id].elementodocumento() && o.appvm[o.appvm[id].elementodocumento()]) {
                    o.appvm[o.appvm[id].elementodocumento()].visible(o.appvm[o.appvm[id].elementodocumento()].anexo().length > 0);
                    o.appvm[o.appvm[id].elementodocumento()].permisocamara(!1);
                    o.appvm[o.appvm[id].elementodocumento()].permisoimportar(!1);
                    updateDocumentCheck(o, o.appvm[id].elementodocumento(), id);
                }
            }
            else if (tipo === o.TE.Texto) {
                !o.appvm[id].valormetadato() && !!o.appvm[id].valor && o.appvm[id].valormetadato.silentUpdate(!o.appvm[id].valormetadato() ? "" : o.appvm[id].valor());
                !!o.appvm[id].esqueletoformato().trim() && !!o.appvm[id].valormetadato() && esquemaTexto(o, id);
                if (!o.drawEditor && o.appvm[id].valormetadato().length === 0 && o.appvm[id].esqueletoformato().length > 0) {
                    o.appvm[id].valor.silentUpdate(o.appvm[id].esqueletoformato().replaceAll('D', '0'));
                }
            }
            else if (tipo === o.TE.Password) {
                var numeroCaracteres = o.appvm[id].valor().length, spanMostrar = ele.find("span.mostrarpassword");
                spanMostrar.html("Mostrar");
                numeroCaracteres > 0 ? spanMostrar.show() : spanMostrar.hide();
                spanMostrar.on("click", () => {
                    numeroCaracteres = o.appvm[id].valor().length;
                    if (ele.find("input[data-bind]")[0].type === "password" && numeroCaracteres > 0) {
                        ele.find("input[data-bind]")[0].type = "text";
                        spanMostrar.html("Ocultar");
                    }
                    else {
                        ele.find("input[data-bind]")[0].type = "password";
                        spanMostrar.html("Mostrar");
                    }
                });
            }
            else if (tipo === o.TE.Leyenda) {
                //primero se revisa si tiene formato especial sino se pinta como esta
                var htmlley = o.appvm[id].valor();
                var matches = htmlley.match(/\|\|\|[\w\.]+\|\|\|/g);
                if (matches && matches.length) {
                    matches = Array.from(matches);
                    var ekeys = _.filter(_.keys(o.appvm), function (elm) { return elm.indexOf("formElec_element") >= 0; });
                    _.forEach(ekeys, function (v) {
                        matches.forEach((m) => {
                            var iduni = m.replaceAll("|", "");
                            if (o.appvm[v].idunico && o.appvm[v].idunico().toString().toLowerCase().indexOf(iduni.toLowerCase()) >= 0) {
                                htmlley = htmlley.replaceAll(m, o.appvm[v].valor ? o.appvm[v].valor() : "");
                                return false;
                            }
                        });
                    });
                }
                ele.html(htmlley);
            }

            if (o.appvm[id].mayusculasminusculas && !!o.appvm[id].mayusculasminusculas() && o.appvm[id].mayusculasminusculas() !== "normal" && !!o.appvm[id].valor()) {
                if (o.appvm[id].mayusculasminusculas() === "upper")
                    o.appvm[id].valor.silentUpdate(o.appvm[id].valor().toString().toUpperCase());
                else if (o.appvm[id].mayusculasminusculas() === "lower")
                    o.appvm[id].valor.silentUpdate(o.appvm[id].valor().toString().toLowerCase());
                o.appvm[id].valormetadato.silentUpdate(o.appvm[id].valor());
            }

            o.evaAfterRender === null && (o.evaAfterRender = []);
            !_.find(o.evaAfterRender, id) && o.evaAfterRender.push(id);

            !_.includes([o.TE.Pagina], tipo) && o.appvm[id].elementrendered && o.appvm[id].elementrendered(!0),
                o.appvm[id].isRule && o.appvm[id].isRule(!1), o.appvm[o.idPlantilla].prevalidateall() && validateControl(o, id, !1, !0), updateOpts(o, true);
        }
        //Se crea el objeto para el viewmodel
        function createElementToView(o, jelem, element, evalall) {
            o.infodataisact = !1;
            var elemAttr = getElementTypeAttributes(o, jelem["@tipoelemento"]);
            if (elemAttr) {
                var id = jelem["@idelemento"], attrs = _.sortBy(_.keys(elemAttr.Atributos)), dictionarydata = {}, reevaldictionary = [];
                element[id] = { tipo: jelem["@tipoelemento"] };
                _.forEach(attrs, function (p) {
                    var tagname = p.toLowerCase().trim(), at = elemAttr.Atributos[p];
                    if (jelem.atributos[tagname] === undefined) {
                        var selectedarr = null;
                        if (at instanceof Object) {
                            if (at instanceof Array)
                                selectedarr = at[0] ? JSON.stringify(at[0]) : JSON.stringify(at);
                            else {
                                if (at.Valor instanceof Array)
                                    at.Valor.length ? selectedarr = tagname === "campo" ? "normal" : JSON.stringify(at.Valor[0]) : selectedarr = "";
                                else selectedarr = at.Valor;
                            }
                        }
                        var value = selectedarr !== null ? selectedarr : at;
                        tagname === "titulo" && (value = value + " " + parseInt(id.match(/\d+/g)));
                        jelem.atributos[tagname] = value;
                    }
                    if (tagname === "iscontainer" && jelem.atributos[tagname] === true && jelem.elementos === undefined)
                        jelem.elementos = { elemento: [] };
                    if (tagname === "margenizquierdo") {
                        //asignacion para viejas versiones
                        at.Valor.forEach((_a, ind) => {
                            if (_a.Valor === jelem.atributos[tagname]) {
                                if (ind === 0) element[id][tagname] = "0";
                                else if (ind === 1) jelem.atributos[tagname] = "8.333333%";
                                else if (ind === 2) jelem.atributos[tagname] = "16.666667%";
                                else if (ind === 3) jelem.atributos[tagname] = "25%";
                                else if (ind === 4) jelem.atributos[tagname] = "33.333333%";
                                else if (ind === 5) jelem.atributos[tagname] = "41.666667%";
                                else if (ind === 6) jelem.atributos[tagname] = "50%";
                                else if (ind === 7) jelem.atributos[tagname] = "58.333333%";
                                else if (ind === 8) jelem.atributos[tagname] = "66.666667%";
                                else if (ind === 9) jelem.atributos[tagname] = "75%";
                                else if (ind === 10) jelem.atributos[tagname] = "83.333333%";
                                else if (ind === 11) jelem.atributos[tagname] = "91.666667%";
                            }
                        });
                    }
                    if (tagname === "margenderecho") {
                        //asignacion para viejas versiones
                        at.Valor.forEach((_a, ind) => {
                            if (_a.Valor === jelem.atributos[tagname]) {
                                if (ind === 0) element[id][tagname] = "0";
                                else if (ind === 1) jelem.atributos[tagname] = "8.333333%";
                                else if (ind === 2) jelem.atributos[tagname] = "16.666667%";
                                else if (ind === 3) jelem.atributos[tagname] = "25%";
                                else if (ind === 4) jelem.atributos[tagname] = "33.333333%";
                                else if (ind === 5) jelem.atributos[tagname] = "41.666667%";
                                else if (ind === 6) jelem.atributos[tagname] = "50%";
                                else if (ind === 7) jelem.atributos[tagname] = "58.333333%";
                                else if (ind === 8) jelem.atributos[tagname] = "66.666667%";
                                else if (ind === 9) jelem.atributos[tagname] = "75%";
                                else if (ind === 10) jelem.atributos[tagname] = "83.333333%";
                                else if (ind === 11) jelem.atributos[tagname] = "91.666667%";
                            }
                        });
                    }
                    if (!_.includes(["nombrearchivo", "tipodoc", "metadatostipodoc", "expresionregular", "mascara", "parametrosentrada", "parametrossalida", "parametros", "urllink", "textoconid"], tagname)) {
                        if (tagname === "catalogoorigen") {
                            element[id][tagname] = extractJsonValue(jelem.atributos[tagname], tagname);
                        } else if (tagname === "fuentedatos") {
                            element[id][tagname] = extractJsonValue(jelem.atributos[tagname], tagname);
                        }
                        else {
                            if (tagname === "tipoescaneo" || tagname === "formato" || tagname === "hora" || tagname === "tipolista" || tagname === "tipoasociacion") {
                                var selvalue = jelem.atributos[tagname];
                                if (selvalue.indexOf("{") > -1) selvalue = extractJsonValue(selvalue, tagname);
                                var selobject = at.Valor[0];
                                selobject = _.find(at.Valor, function (a) { return a.Valor === selvalue; }) || selobject;
                                element[id][tagname + "Object"] = ko.mapping.fromJS(selobject);
                            }
                            if (tagname === "chosenitems")
                                element[id][tagname] = [];
                            else if (tagname === "visible" || tagname === "habilitado")
                                element[id][tagname] = extractJsonValue(jelem.atributos[tagname], tagname);
                            else if (tagname === "valor" && _.includes([o.TE.Numero, o.TE.Texto, o.TE.TextArea], element[id]["tipo"]) && o.drawEditor)
                                element[id][tagname] = "";
                            else
                                element[id][tagname] = extractJsonValue(jelem.atributos[tagname], tagname);
                        }
                    } else
                        element[id][tagname] = jelem.atributos[tagname];
                });
                element[id].elementrendered = !1, element[id].executeonce = !1, element[id].bindcondition = !1,
                    element[id].campo && (element[id].campocss = ""), element[id].validationerror = "", element[id].haserror = !1, element[id].finishloading = !0;
                if (element[id]["tipo"] === o.TE.Lista) {
                    element[id]["chosenitems"] = [], element[id]["optionselected"] = "", element[id]["chosenitemsRule"] = [], element[id]["isfreshly"] = !1, element[id]["optionselectedRule"] = "", element[id]["isRule"] = !0, //se prende porque es la carga inicial
                        element[id]["filtrarcatalogo"] !== "" && (dictionarydata["filtrarcatalogo"] = element[id]["filtrarcatalogo"], element[id]["filtrarcatalogo"] = ""),
                        o.appvm.elementsList.push(id), element[id]["seleccionaresquema"] = !element[id]["valor"];
                    o.appvm.isEditor() && (element[id].valor = "", element[id].valormetadato = "");
                }
                else if (element[id]["tipo"] === o.TE.ComboBoxTemporal) element[id]["optiontempselected"] = "", element[id]["catalogotemp"] = "", element[id]["catalogodestino"] !== "" && (dictionarydata["catalogodestino"] = JSON.parse(element[id]["catalogodestino"]), element[id]["catalogodestino"] = "");
                else if (element[id]["tipo"] === o.TE.Pagina) element[id]["activo"] = !1, element[id]["renderingpage"] = !1;
                else if (element[id]["tipo"] === o.TE.Boton)
                    element[id]["cantidadmaximacliccounter"] = -1, element[id]["click"] = "", element[id]["isclick"] = !1, element[id]["isclosemodal"] = !1;
                else if (_.includes([o.TE.Mapa, o.TE.Georeferencia], element[id]["tipo"])) o.appvm.elementsGeo.push(id), element[id]["map"] = "";
                else if (element[id]["tipo"] === o.TE.Plantilla) {
                    element[id].staticcontent = "", element[id].pdfanterior = "", element[id].prevalidateall = !1,
                        element[id].pagids = [], element[id].lastupdate = jelem["@fechaguardadoplantilla"];
                    !element[id]["contenidoestatico"] ? element[id]["contenidoestatico"] = "" : reevaldictionary.push({ id: id, variable: "contenidoestatico" });
                    !element[id]["resumen"] ? element[id]["resumen"] = "" : reevaldictionary.push({ id: id, variable: "resumen" });
                    !element[id]["resumen2"] ? element[id]["resumen2"] = "" : reevaldictionary.push({ id: id, variable: "resumen2" });
                    !element[id]["reglas"] ? (element[id]["reglas"] = "", reevaldictionary.push({ id: id, variable: "reglas" })) : dictionarydata["reglas"] = element[id]["reglas"];
                    !element[id]["servicios"] ? (element[id]["servicios"] = "", reevaldictionary.push({ id: id, variable: "servicios" })) : dictionarydata["servicios"] = element[id]["servicios"];
                    !element[id]["operacionesmatematicas"] ? (element[id]["operacionesmatematicas"] = "", reevaldictionary.push({ id: id, variable: "operacionesmatematicas" })) : dictionarydata["operacionesmatematicas"] = element[id]["operacionesmatematicas"];
                    !element[id]["components"] ? (element[id]["components"] = "", reevaldictionary.push({ id: id, variable: "components" })) : dictionarydata["components"] = element[id]["components"];
                    !element[id]["prefilleddata"] ? (element[id]["prefilleddata"] = "", reevaldictionary.push({ id: id, variable: "prefilleddata" })) : dictionarydata["prefilleddata"] = element[id]["prefilleddata"];
                    !element[id]["pdfmapping"] ? (element[id]["pdfmapping"] = "", reevaldictionary.push({ id: id, variable: "pdfmapping" })) : dictionarydata["pdfmapping"] = element[id]["pdfmapping"];
                    !element[id]["metadatamapping"] ? (element[id]["metadatamapping"] = "", reevaldictionary.push({ id: id, variable: "metadatamapping" })) : dictionarydata["metadatamapping"] = element[id]["metadatamapping"];
                    !element[id]["macros"] ? (element[id]["macros"] = "", reevaldictionary.push({ id: id, variable: "macros" })) : dictionarydata["macros"] = element[id]["macros"];
                    element[id]["contenidoestaticohtml"] && element[id]["contenidoestaticohtmlisencoded"] === !0 && (element[id]["contenidoestaticohtml"] = b64DecodeUnicode(element[id]["contenidoestaticohtml"]));
                    //dictionarydata["hojaestilos"] = element[id]["hojaestilos"], element[id]["hojaestilos"] = "";
                }
                else if (element[id]["tipo"] === o.TE.Logico) {
                    var oldval = element[id]["valor"];
                    typeof oldval !== "boolean" && (element[id]["valor"] = oldval === "1" || oldval === 1);
                }
                else if (element[id]["tipo"] === o.TE.Tabla) {
                    element[id]["rowonfocus"] = -1, element[id]["clickedrow"] = -1, element[id]["addrow"] = !1, element[id]["modeedit"] = !1, element[id]["rowediting"] = "",
                        element[id]["rowcheckeds"] = "", element[id]["lastrownumber"] = 0, element[id]["valorjson"] = [], element[id]["nombrecolumnas"] = "", element[id]["errorjson"] = [],
                        dictionarydata["columnasmultieditar"] = element[id]["columnasmultieditar"], element[id]["columnasmultieditar"] = "",
                        dictionarydata["columnastotalizar"] = element[id]["columnastotalizar"], element[id]["columnastotalizar"] = "",
                        dictionarydata["columnasvisualizar"] = element[id]["columnasvisualizar"], element[id]["columnasvisualizar"] = "",
                        dictionarydata["configuracioncargatabla"] = element[id]["configuracioncargatabla"], element[id]["modetable"] = "",
                        element[id]["configuracioncargatabla"] = "", element[id]["sumatoriacolumnas"] = "";
                }
                else if (element[id]["tipo"] === o.TE.Leyenda)
                    element[id]["isencoded"] && element[id]["isencoded"] === true && (element[id]["valor"] = b64DecodeUnicode(element[id]["valor"]));
                else if (element[id]["tipo"] === o.TE.Wizard)
                    element[id]["valinit"] = 1, element[id]["valfin"] = 0,
                        element[id]["cantidadformatosabrircounter"] = -1, element[id]["isforward"] = !1, element[id]["isbackward"] = !1, element[id]["isbeforefinish"] = !1, element[id]["isafterfinish"] = !1,
                        element[id]["prefilleddata"] !== "" && (dictionarydata["prefilleddata"] = element[id]["prefilleddata"], element[id]["prefilleddata"] = ""),
                        typeof element[id]["navegacion"] === "object" && (element[id]["navegacion"] = "");
                else if (element[id]["tipo"] === o.TE.Seccion) element[id]["modotab"] = !1, element[id]["activo"] = !1, element[id]["mostrar"] = !1, element[id]["sectioncollapsed"] = !1, element[id]["mostrarmodal"] = !0;
                else if (element[id]["tipo"] === o.TE.Tabber) element[id]["tabids"] = [];
                else if (_.includes([o.TE.Texto, o.TE.TextArea], element[id]["tipo"]) && element[id]["valor"].toString().indexOf("&") >= 0) element[id]["valor"] = he.decode(element[id]["valor"]);
                else if (element[id]["tipo"] === o.TE.CodigoQR) element[id]["scanmode"] = !1;
                else if (element[id]["tipo"] === o.TE.Documento) element[id].ondelete = !1, element[id].anexo = [], element[id].tipodocjson = "", element[id].metadatostipodocjson = "", element[id].anteriornombrearchivodoc = {}, element[id].errormetadatos = "", element[id].updatemetadata = !1,
                    element[id]["tipificacionpermitida"] !== "" && (dictionarydata["tipificacionpermitida"] = element[id]["tipificacionpermitida"], element[id]["tipificacionpermitida"] = ""),
                    element[id]["tipificacionunica"] !== "" && (dictionarydata["tipificacionunica"] = element[id]["tipificacionunica"], element[id]["tipificacionunica"] = "");
                else if (element[id]["tipo"] === o.TE.ComboDinamico) {
                    dictionarydata["camposfiltrosjson"] = [], dictionarydata["camposfiltros"] = element[id]["camposfiltros"], element[id]["camposfiltros"] = "", element[id]["isfreshly"] = !1, element[id]["seleccionaresquema"] = !element[id]["valor"],
                        element[id]["chosenitems"] = [], element[id]["optionselected"] = "", element[id]["chosenitemsRule"] = [], element[id]["optionselectedRule"] = "", element[id]["isRule"] = !0, element[id]["tieneesquema"] = !!element[id]["configjson"];
                }
                else if (element[id]["tipo"] === o.TE.MarcadoDocumentos) {
                    element[id]["catalogodestino"] = [], element[id]["fuentedatos"] = "catalogos", element[id]["tipoasociacion"] = "iddesc", element[id]["isfreshly"] = !1, element[id]["tipolista"] = "checkbox", element[id]["chosenitems"] = [],
                        element[id]["isRule"] = !0, element[id]["catalogoupdated"] = !1, element[id]["chosenitemsRule"] = [],
                        element[id]["filtrarcatalogo"] !== "" && (dictionarydata["filtrarcatalogo"] = element[id]["filtrarcatalogo"], element[id]["filtrarcatalogo"] = "");
                }
                else if (element[id]["tipo"] === o.TE.OCR) element[id]["idvalidation"] = "", dictionarydata["mappingocr"] = element[id]["mappingocr"], element[id]["mappingocr"] = "",
                    dictionarydata["mappingscore"] = element[id]["mappingscore"], element[id]["mappingscore"] = "",
                    dictionarydata["mappingpepaml"] = element[id]["mappingpepaml"], element[id]["mappingpepaml"] = "";
                else if (element[id]["tipo"] === o.TE.PDFOCR) element[id]["ocrrecognizer"] = "", element[id]["hasocrdata"] = !1;
                if (_.includes([o.TE.Audio, o.TE.FirmaFAD, o.TE.Georeferencia, o.TE.Mapa, o.TE.HuellaDigital, o.TE.Imagen, o.TE.Video, o.TE.PDFOCR], element[id]["tipo"])) element[id]["anexo"] = "";
                if (_.includes([o.TE.Boton, o.TE.OCR], element[id]["tipo"])) element[id]["tamaniocss"] = "";
                if (evalall) {
                    ko.mapping.fromJS(element, o.appvm);
                    reevaluateDictionaryData(o, reevaldictionary, dictionarydata, id);
                    !o.appvm.isEditor() && (initializeAttrByElems(o, id), checkRuleForElement(o));
                    setCustomSubscribes(o, id), updateOpts(o, true);
                }
                else {
                    //se agrega los diccionarios para aplicarlos mas tarde
                    element[id]["reevaldictionary"] = reevaldictionary;
                    element[id]["dictionarydata"] = dictionarydata;
                }
            }
            return element;
        }
        function reevaluateDictionaryData(o, dic, cme, id) {
            for (var v = 0; v < dic.length; v++ in dic) _.isEmpty(o.appvm[dic[v].id][dic[v].variable]()) ? o.appvm[dic[v].id][dic[v].variable]({}) : o.appvm[dic[v].id][dic[v].variable](ko.mapping.toJS(o.appvm[dic[v].id][dic[v].variable]()));
            for (var n in cme) o.appvm[id][n] && (_.isEmpty(cme[n]) ? o.appvm[id][n]({}) : o.appvm[id][n](cme[n]));
        }
        function resetSession(o) {
            showHideLoading(o, !1);
            var resetS = function () {
                showHideLoading(o, !0), $('#spanloadingfe').text("Se podrá proceder al editado del formato después de iniciar sesión...");
                var verifySession = setInterval(function () {
                    $.ajax({
                        url: o.datasend.urlGlobal + 'FECapturador.aspx/VerificarSesion', data: '', type: "POST", contentType: "application/json; charset=utf-8",
                        beforeSend: function () { },
                        success: function (j) {
                            j = j.d;
                            if (j.Success) {
                                showHideLoading(o, !1), clearInterval(verifySession);
                                delete o.appvm["nosession"];
                            }
                        }
                    });
                }, 1000);
                window.open('wfrm_contenido.aspx');
            }, closeS = function () { window.location = window.location.href; },
                mensajeC = 'El tiempo de su sesión ha caducado, ¿desea iniciar sesión nuevamente para continuar editando o guardar el formato?\
                            Si así lo desea, se abrirá una nueva pestaña para que inicie sesión; en caso contrario, se le redirigirá a la página principal \
                            y sus cambios no serán almacenados.';

            if (!o.appvm["nosession"]) {
                Modal('Sesión expirada', mensajeC, null, 'alerta', resetS, 'Iniciar sesión', 'Cerrar sesión', closeS);
                o.appvm["nosession"] = !0;
            }
        }



        //Metodos genericos
        function autosave() {
            var o = getOpts();
            if (o.drawEditor) {
                var hasO = true;
                if (!o) {
                    o = getOpts();
                    hasO = false;
                }
                if (o.autosave) {
                    o.timeoutAutosave = setInterval(function () { contglobal.find("#saveDoc").trigger("click.saveMethod"); }, o.autosavetime * 1000 * 60);
                    contglobal.find("i[name=autosave]").removeClass("fa-toggle-off").addClass("fa-toggle-on");
                } else {
                    clearInterval(o.timeoutAutosave);
                    contglobal.find("i[name=autosave]").removeClass("fa-toggle-on").addClass("fa-toggle-off");
                }
                o.autosave = !o.autosave;
                if (!hasO)
                    updateOpts(o, true);
            }
        }
        function addStylesForLibrary(o) {
            insertRule(["[class*='col-']"], "min-height: 25px;");
            insertRule([".checkbox", ".radio"], "margin-top: 3px; margin-bottom: 3px;");
            insertRule([".card-header"], "min-height: 35px; padding: 8px;");
            insertRule([".card-body"], "min-height: 30px;");
            insertRule(["div.properties input, div.properties select, div.properties textarea"], "font-size:12px");
            insertRule([".cursor-move"], "cursor: move;");
            insertRule([".cursor-pointer"], "cursor: pointer;");
            insertRule([".round-button"], "border-radius: 15px;");
            insertRule([".sortable"], "min-height: 50px; background-color: transparent;");
            insertRule([".sortableborderwith"], "border: 1px solid #ccc;");
            insertRule([".fa-asterisk"], "color: red;");
            insertRule([".far, .fas, .fa"], "font-size: 1.3em");
            insertRule(["#formElec_elementary .fas, #formElec_elementary .fa, #formElec_elementary .far"], "font-size: 1.3em;");
            insertRule([".btn-light, .btn-danger, .btn-info, .btn-success, .btn-primary, .btn-warning, .btn"], "font-size: 13px; border-radius: 4px;");
            insertRule(["[readonly].flatpickr-input"], "background-color: #fff;");
            insertRule(["[disabled].flatpickr-input"], "background-color: #eee; cursor: not-allowed");
            insertRule([".help-block.form-error"], "margin: 0;height:0;");
            insertRule([".form-control"], "height:32px;");
            insertRule([".actions"], "position: absolute; display: inline-flex; top: 5px; right: 20px;");
            insertRule([".card-heading"], "position:relative;");
            insertRule([".actions div.btn-light"], "font-size:10px; height:18px; padding:2px 3px;z-index:1;width:19px;");
            insertRule([".validatebox-disabled"], "cursor:not-allowed; background-color: #d2d6de; opacity: 0.8");
            insertRule([".errorMessage"], "color: #a94442; font-weight: bold;");
            insertRule([".errorMessageFloat"], "color: #fff; font-weight: bold; position: absolute; margin-top: 3px; margin-left: 3px; border: 1px solid #f24141; border-radius: 10px; background-color: #f24141; padding: 1px 5px; z-index: 999; top: 0px; right: 5px;");
            insertRule([".hasError"], "background-color: rgba(255,0,0,.09); border-color:#ff5555;");
            insertRule([".headertablebuttons"], "margin-top: 8px;");
            insertRule([".tabElementrulechoise"], "background-color: #e4e2cd;border-radius: 10px 10px 0px 0px;min-width: 80px;cursor: pointer;text-align: center; font-size:12px");
            insertRule([".tabElementrulechoiseSel"], "background-color: #ffcc3b;border-radius: 10px 10px 0px 0px;min-width: 80px;cursor: pointer;text-align: center; font-size:12px");
            insertRule([".calc-optionTab"], "cursor:pointer; color:black;font-size:14px;background-color:white;padding:5px 20px 5px 5px;border:1px solid lightgray;opacity:0.5");
            insertRule([".calc-optionTab i"], "background-color:white;padding:3px;border-radius:30px;color:black");
            insertRule([".calc-optionTab:hover"], "opacity:1");
            insertRule([".calc-optionTab.selected"], "opacity:1; border-width:2px");
            insertRule([".calc-optionTab.selected i"], "border: 1px solid lightgray");
            insertRule(["[disabled]"], "cursor: not-allowed");
            insertRule(["div.listtablestyles div.listoptstyle:hover"], "opacity:0.5;cursor:pointer");
            insertRule(["div.listtablestyles div.listoptstyle.selected"], "background-color: #e4e7e8;");
            insertRule([".btn.hasshadow"], "box-shadow: 2px 2px 7px black; margin-top: .25rem");
            insertRule([".menu-text"], "padding-left: 5px;");
            insertRule([".menu-line"], "border-left: 0px; border-right: 0px; left: 0; top: 0;");
            insertRule([".popover"], "z-index:1060;");
            insertRule([".hidden"], "display: none;");
            if (o.drawEditor) {
                insertRule(["li.nav-item a.nav-link div.btn-light"], 'font-size: 10px;padding: 3px 5px;height: 22px;width: 22px;');
                insertRule([".state-default-plantilla"], "background-color: #c8c8c8; background-color: rgba(200,200,200,.4); margin-bottom: 10px; font-size: 1rem;");
                insertRule([".state-default-plantilla-empty"], "border: 3px dashed #888888;");
                insertRule([".state-hover-plantilla"], "background-color: #f0e68c; background-color: rgba(240, 230, 140, .6); font-weight: normal;");
                insertRule([".state-default-puzzle"], "background-color: #e8e8e8; background-color: rgba(232, 232, 232,.4);");
                insertRule([".portlet-placeholder"], "border: 3px dashed #1e90ff; height: 65px;");
                insertRule([".configevent"], "min-width: 23px; min-height: 22px; font-size: 14px;");
                insertRule([".label"], "display: inline-block; font-size: 1rem; margin-top: 5px; margin-left: 5px;");
                insertRule([".twitter-typeahead"], "width: 100%;");
                insertRule([".tt-menu"], "width: 100%;");
                insertRule([".formula-wrapper"], "position: relative;");
                insertRule([".formula-wrapper div.badge"], "font-size:13px");
                insertRule([".formula-wrapper .formula-text"], "top: 0; width: 100%; height: 100%; right: 0; color: transparent; text-indent: -10000px; font-size: 0; position: absolute; z-index: 20; box-sizing: border-box; opacity: 0; -box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box;");
                insertRule([".formula-container"], "padding: 1.5em .3em .3rem; position: relative; cursor: text; background-color: #fff; line-height: 2;color:black;");
                insertRule([".formula-container .formula-cursor"], "width: 1px; height: 1.6rem; vertical-align: middle; display: inline-block; background-color: #000000; background-color: rgba(0, 0, 0, 0.6);");
                insertRule([".formula-container .formula-drag"], "padding: 1em 0.2rem; border-radius: 3px; vertical-align: middle; display: inline; background-color: #1a5eff; background-color: rgba(26, 94, 255, 0.15);");
                insertRule([".formula-container .list-group.intellibox"], "z-index: 99;");
                insertRule([".formula-container .list-group .list-group-item"], "padding: 4px 8px; line-height: 1.3;");
                insertRule([".datagrid tr:first-child td"], "background: none; color: inherit;");
                insertRule([".properties [class*='col-']"], "min-height: 36px;");
                insertRule([".preview"], "max-width: 72%;");
                insertRule([".popover"], "max-width: 500px;");
                insertRule([".enablecircle"], "width:18px;height:18px;float:left;border-radius:22px;border:2px solid white;cursor:pointer;margin-right:5px;");
                insertRule([".cenabled"], "background-color:#0da50d");
                insertRule([".clistrow"], "padding: 8px 10px;cursor: pointer; border-bottom: 2px solid lightgray;text-align:center;list-style-type: none");
                insertRule([".clistrow:hover"], "background-color: #0073b7;");
                insertRule([".clistrow.selected"], "background-color: #0073b7; font-weight: bold");
                insertRule([".clistrow:hover span, .clistrow.selected span"], "color:white;");
                insertRule([".clistrow-highlight"], "background-color:cadetblue; opacity:0.5");
                insertRule([".cdisabled"], "background-color:#cd0a0a;");
                insertRule([".searcherTab input:focus"], "box-shadow:0 0 0 1pt #277a95; outline:none;");
                insertRule([".searcherTab div.fa-search:hover"], "color:cornflowerblue;");
                insertRule([".btn.menuelem"], "margin-right: 5px; margin-top: 3px; border: 1px solid #acaaaa; opacity: 0.7; width:90px;height:45px;display:inline-flex;flex-direction:column;justify-content:center;background-color:white;");
                insertRule(["#nav-tab a.nav-item.active"], "background-color: #f3f3f3; border-bottom: 1px solid #f3f3f3");
                insertRule([".ql-formats button.disabled, .ql-formats span.disabled"], "pointer-events: none; cursor: not-allowed; opacity: 0.5;");
                insertRule([".clistrow i:hover"], "color:lightgray");
                insertRule([".combo-panel.panel-body.panel-body-noheader"], "font-weight: bold;");
                insertRule([".nav-tabs .nav-item.show .nav-link, .nav-tabs .nav-link.active"], "border-color: #2000ff #2000ff transparent; border-width: 2px;");
                insertRule([".ContentStart .flex-column .col-sm-12.p-0"], "font-weight: bold;");
            }
            if (o.drawPreviewer) {
                if (!o.drawEditor)
                    insertRule([".state-default-plantilla"], "border: 2px solid #aaaaaa;");
                insertRule([".preview"], "max-width: 80%; margin: auto;");
                insertRule([".capturable"], "min-height: 70px;");
                insertRule([".map"], "height: 250px; width: 100%;");
                insertRule(["blinkid-in-browser"], "--mb-component-border-width: 0; --mb-component-font-color:white;");
                insertRule([".ol-box"], "box-sizing: border-box; border-radius: 2px; border: 2px solid #00f");
                insertRule([".ol-mouse-position"], "top: 8px; right: 8px; position: absolute");
                insertRule([".ol-scale-line"], "background: rgba(0,60,136,.3); border-radius: 4px; bottom: 8px; left: 8px; padding: 2px; position: absolute");
                insertRule([".ol-scale-line-inner"], "border: 1px solid #eee; border-top: none; color: #eee; font-size: 10px; text-align: center; margin: 1px; will-change: contents,width; transition: all .25s");
                insertRule([".ol-scale-bar"], "position: absolute; bottom: 8px; left: 8px");
                insertRule([".ol-scale-step-marker"], "width: 1px; height: 15px; background-color: #000; float: right; z-Index: 10");
                insertRule([".ol-scale-step-text"], "position: absolute; bottom: -5px; font-size: 12px; z-Index: 11; color: #000; text-shadow: -2px 0 #fff,0 2px #fff,2px 0 #fff,0 -2px #fff");
                insertRule([".ol-scale-text"], "position: absolute; font-size: 14px; text-align: center; bottom: 25px; color: #000; text-shadow: -2px 0 #fff,0 2px #fff,2px 0 #fff,0 -2px #fff");
                insertRule([".ol-scale-singlebar"], "position: relative; height: 10px; z-Index: 9; box-sizing: border-box; border: 1px solid #000");
                insertRule([".ol-unsupported"], "display: none");
                insertRule([".ol-unselectable, .ol-viewport"], "-webkit-touch-callout: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent");
                insertRule([".ol-selectable"], "-webkit-touch-callout: default; -webkit-user-select: text; -moz-user-select: text; -ms-user-select: text; user-select: text");
                insertRule([".ol-grabbing"], "cursor: -webkit-grabbing; cursor: -moz-grabbing; cursor: grabbing");
                insertRule([".ol-grab"], "cursor: move; cursor: -webkit-grab; cursor: -moz-grab; cursor: grab");
                insertRule([".ol-control"], "position: absolute; background-color: rgba(255,255,255,.4); border-radius: 4px; padding: 2px");
                insertRule(["    .ol-control:hover"], "background-color: rgba(255,255,255,.6)");
                insertRule([".ol-zoom"], "top: .5rem; left: .5rem");
                insertRule([".ol-rotate"], "top: .5rem; right: .5rem; transition: opacity .25s linear,visibility 0s linear");
                insertRule(["    .ol-rotate.ol-hidden"], "opacity: 0; visibility: hidden; transition: opacity .25s linear,visibility 0s linear .25s");
                insertRule([".ol-zoom-extent"], "top: 4.643rem; left: .5em");
                insertRule([".ol-full-screen"], "right: .5rem; top: .5rem");
                insertRule([".ol-control button"], "display: block; margin: 1px; padding: 0; color: #fff; font-size: 1.14rem; font-weight: 700; text-decoration: none; text-align: center; height: 1.375rem; width: 1.375rem; line-height: .4rem; background-color: rgba(0,60,136,.5); border: none; border-radius: 2px");
                //insertRule(["    .ol-control button::-moz-focus-inner"], "border: none; padding: 0");
                insertRule([".ol-zoom-extent button"], "line-height: 1.4em");
                insertRule([".ol-compass"], "display: block; font-weight: 400; font-size: 1.2rem; will-change: transform");
                insertRule([".ol-touch .ol-control button"], "font-size: 1.5em");
                insertRule([".ol-touch .ol-zoom-extent"], "top: 5.5em");
                insertRule([".ol-control button:focus, .ol-control button:hover"], "text-decoration: none; background-color: rgba(0,60,136,.7)");
                insertRule([".ol-zoom .ol-zoom-in"], "border-radius: 2px 2px 0 0");
                insertRule([".ol-zoom .ol-zoom-out"], "border-radius: 0 0 2px 2px");
                insertRule([".ol-attribution"], "text-align: right; bottom: .5rem; right: .5rem; max-width: calc(100% - 1.3em)");
                insertRule(["    .ol-attribution ul"], "margin: 0; padding: 0 .5rem; color: #000; text-shadow: 0 0 2px #fff");
                insertRule(["    .ol-attribution li"], "display: inline; list-style: none");
                insertRule(["        .ol-attribution li:not(:last-child):after"], 'content: " "');
                insertRule(["    .ol-attribution img"], "max-height: 2rem; max-width: inherit; vertical-align: middle");
                insertRule(["    .ol-attribution button, .ol-attribution ul"], "display: inline-block");
                insertRule(["    .ol-attribution.ol-collapsed ul"], "display: none");
                insertRule(["    .ol-attribution:not(.ol-collapsed)"], "background: rgba(255,255,255,.8)");
                insertRule(["    .ol-attribution.ol-uncollapsible"], "bottom: 0; right: 0; border-radius: 4px 0 0");
                insertRule(["        .ol-attribution.ol-uncollapsible img"], "margin-top: -.2rem; max-height: 1.6em");
                insertRule(["        .ol-attribution.ol-uncollapsible button"], "display: none");
                insertRule([".ol-zoomslider"], "top: 4.5rem; left: .5rem; height: 200px");
                insertRule(["    .ol-zoomslider button"], "position: relative; height: 10px");
                insertRule([".ol-touch .ol-zoomslider"], "top: 5.5em");
                insertRule([".ol-overviewmap"], "left: .5rem; bottom: .5rem");
                insertRule(["    .ol-overviewmap.ol-uncollapsible"], "bottom: 0; left: 0; border-radius: 0 4px 0 0");
                insertRule(["    .ol-overviewmap .ol-overviewmap-map, .ol-overviewmap button"], "display: inline-block");
                insertRule(["    .ol-overviewmap .ol-overviewmap-map"], "border: 1px solid #7b98bc; height: 150px; margin: 2px; width: 150px");
                insertRule(["    .ol-overviewmap:not(.ol-collapsed) button"], "bottom: 1px; left: 2px; position: absolute");
                insertRule(["    .ol-overviewmap.ol-collapsed .ol-overviewmap-map, .ol-overviewmap.ol-uncollapsible button"], "display: none");
                insertRule(["    .ol-overviewmap:not(.ol-collapsed)"], "background: rgba(255,255,255,.8)");
                insertRule([".ol-overviewmap-box"], "border: 2px dotted rgba(0,60,136,.7)");
                insertRule([".ol-overviewmap .ol-overviewmap-box:hover"], "cursor: move");
                insertRule([".ol-touch .ol-control.gcd-gl-control button"], "font-size: 1.14em");
                insertRule([".ol-touch .ol-geocoder.gcd-gl-container"], "font-size: 1.1em");
                insertRule([".ol-geocoder.gcd-gl-container"], "position: absolute; top: 4.875rem; left: .5rem; box-sizing: border-box; font-size: .9em");
                insertRule(["    .ol-geocoder.gcd-gl-container *, .ol-geocoder.gcd-gl-container :after, .ol-geocoder.gcd-gl-container :before"], "box-sizing: inherit");
                insertRule([".ol-geocoder .gcd-gl-control"], "width: 2.1875rem; height: 2.1875rem; overflow: hidden; transition: width .2s,height .2s");
                insertRule([".ol-geocoder .gcd-gl-expanded"], "width: 15.625rem; height: 2.1875rem");
                insertRule([".ol-geocoder .gcd-gl-input"], "position: absolute; z-index: 99; top: .25rem; left: 2.5rem; width: 14.84375rem; padding: 5px; border: 1px solid #ccc; font-family: inherit; font-size: .875rem; background-color: #fff; color: #222");
                insertRule(["    .ol-geocoder .gcd-gl-input:focus"], "border: none; outline: none; box-shadow: inset 0 0 0 1px #4d90fe,inset 0 0 5px #4d90fe");
                insertRule([".ol-geocoder .gcd-gl-reset"], "position: absolute; z-index: 100; top: 0; right: 0; width: 1.5625rem; height: 100%; line-height: 1.4; border: none; background-color: transparent; display: inline-block; outline: 0; cursor: pointer");
                insertRule(["    .ol-geocoder .gcd-gl-reset:after"], 'content: "\\d7"; display: inline-block; color: #333; font-size: 1.5rem; cursor: pointer');
                insertRule([".ol-geocoder .gcd-gl-btn"], "position: absolute; width: 1.5625rem; height: 1.5625rem; top: .125rem; left: .125rem; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAPCAYAAAA71pVKAAABPUlEQVQoU41SwXHCQAzUHh58eoUOIBWEDkI6oAToIKkg7iAuwakgpAIowXRACcnrzp6BzchjMx4wE/S6kW5XK60gvQghzJIkmVoqSZI9gJ9+/fINS5Cc1HX9QXIlIr/tpwcRyb33b7cIGnAIYQdg4pxbjcfj0nJ1Xc+Px+PGObdN03Q9RIAQwgpAnqbp7FKmjQGgJLlU1d2V7BjjRkQO3vvXIXarkyxVNbsCm2QR2Q0V7XOMMReRmfd+OQQubN6hYgs22ZtbnRcAtiRfLueqqmpJ8ovko6oeBq0KIWQA3gFkzrlmMafTaUEyI/mpqmbhVTRWWbRdbClPbeobQNES5KPRqOxs7DBn8K1DsAOKMZYApiTXqlrcDe4d0XN7jWeCfzt351tVle2iGalTcBd4gGDvvZ/fDe4RmCOFLe8Pr7mvEP2N9PQAAAAASUVORK5CYII='); background-repeat: no-repeat; background-position: 50%");
                insertRule([".ol-geocoder ul.gcd-gl-result"], "position: absolute; top: 2.1875rem; left: 2rem; width: 16.25rem; max-height: 18.75rem; white-space: normal; list-style: none; padding: 0; margin: 0; background-color: #fff; border-radius: 4px; border-top: none; border-top-left-radius: 0; border-top-right-radius: 0; overflow-x: hidden; overflow-y: auto; box-shadow: 0 1px 7px rgba(0,0,0,.8); transition: max-height .3s ease-in");
                insertRule(["    .ol-geocoder ul.gcd-gl-result > li"], "width: 100%; overflow: hidden; border-bottom: 1px solid #eee; padding: 0; line-height: .875rem");
                insertRule(["        .ol-geocoder ul.gcd-gl-result > li > a"], "display: block; text-decoration: none; padding: 3px 5px");
                insertRule(["            .ol-geocoder ul.gcd-gl-result > li > a:hover"], "background-color: #d4d4d4");
                insertRule(["        .ol-geocoder ul.gcd-gl-result > li:nth-child(odd)"], "background-color: #e0ffe0");
                insertRule(["    .ol-geocoder ul.gcd-gl-result:empty"], "display: none");
                insertRule([".ol-geocoder.gcd-txt-container"], "position: absolute; width: 25rem; height: 4.375rem; top: .5rem; left: calc(50% - 12.5em); box-sizing: border-box");
                insertRule(["    .ol-geocoder.gcd-txt-container *, .ol-geocoder.gcd-txt-container :after, .ol-geocoder.gcd-txt-container :before"], "box-sizing: inherit");
                insertRule([".ol-geocoder .gcd-txt-control"], "position: relative; width: 100%; height: 4.375rem; border: 1px solid #ccc; background-color: #fff; overflow: hidden");
                insertRule([".ol-geocoder .gcd-txt-input"], "position: absolute; z-index: 99; top: 0; left: 0; width: 100%; height: 100%; padding: 5px 30px 5px 40px; border: none; text-indent: 6px; background-color: transparent; font-family: inherit; font-size: .875em");
                insertRule(["    .ol-geocoder .gcd-txt-input:focus"], "outline: none; box-shadow: inset 0 0 0 1px #4d90fe,inset 0 0 6px #4d90fe");
                insertRule([".ol-geocoder .gcd-txt-reset"], "position: absolute; z-index: 100; top: 0; right: 0; width: 2.5rem; height: 100%; line-height: 100%; border: none; background-color: transparent; display: inline-block; vertical-align: middle; outline: 0; cursor: pointer");
                insertRule(["    .ol-geocoder .gcd-txt-reset:after"], 'content: "\\d7"; display: inline-block; color: #333; font-size: 2rem; cursor: pointer');
                insertRule([".ol-geocoder .gcd-txt-glass"], "position: absolute; top: 0; left: 0; z-index: 100; display: inline-block; width: 2.5rem; height: 100%; background-size: 1.38889rem; background-image: url(\"data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32'%3E%3Cpath fill='%23333' d='M29.156 29.961l-.709.709a2.006 2.006 0 01-2.838 0l-5.676-5.674c-.656-.658-.729-1.644-.281-2.412l-3.104-3.102a9.975 9.975 0 01-5.965 1.979C5.043 21.461.552 16.97.552 11.43S5.043 1.398 10.583 1.398c5.541 0 10.031 4.491 10.031 10.032 0 2.579-.98 4.923-2.58 6.7l3.035 3.035c.768-.447 1.754-.375 2.41.283l5.676 5.674c.784.785.784 2.056.001 2.839zM18.088 11.389a7.524 7.524 0 00-7.524-7.523 7.523 7.523 0 10-.001 15.046 7.525 7.525 0 007.525-7.523z'/%3E%3C/svg%3E\"); background-repeat: no-repeat; background-position: 50%");
                insertRule([".ol-geocoder ul.gcd-txt-result"], "position: absolute; top: 4.575rem; left: 0; width: 25rem; max-height: 18.75rem; white-space: normal; list-style: none; padding: 0; margin: 0; background-color: #fff; border-radius: 4px; border-top: none; border-top-left-radius: 0; border-top-right-radius: 0; overflow-x: hidden; overflow-y: auto; box-shadow: 0 1px 7px rgba(0,0,0,.8); transition: max-height .3s ease-in");
                insertRule(["    .ol-geocoder ul.gcd-txt-result > li"], "width: 100%; overflow: hidden; border-bottom: 1px solid #eee; padding: 0; line-height: .875rem");
                insertRule(["        .ol-geocoder ul.gcd-txt-result > li > a"], "display: block; text-decoration: none; padding: 3px 5px");
                insertRule(["            .ol-geocoder ul.gcd-txt-result > li > a:hover"], "background-color: #d4d4d4");
                insertRule(["        .ol-geocoder ul.gcd-txt-result > li:nth-child(odd)"], "background-color: #e0ffe0");
                insertRule(["    .ol-geocoder ul.gcd-txt-result:empty"], "display: none");
                insertRule([".ol-geocoder .gcd-hidden"], "opacity: 0; visibility: hidden");
                insertRule([".ol-geocoder .gcd-pseudo-rotate:after"], "-webkit-animation: spin .7s linear infinite; animation: spin .7s linear infinite");
                insertRule([".gcd-address, .gcd-road"], "font-size: .875rem; font-weight: 500; color: #333");
                insertRule([".gcd-city"], "font-weight: 400");
                insertRule([".gcd-city, .gcd-country"], "font-size: .75rem; color: #333");
                insertRule([".gcd-country"], "font-weight: lighter");
                insertRule([".ol-popup"], "display: none; position: absolute; background-color: white; padding: 15px 25px 15px 15px; border: 1px solid #cccccc; bottom: 12px; left: -50px;");
                insertRule(["    .ol-popup:after, .ol-popup:before"], 'top: 100%; border: solid transparent; content: " "; height: 0; width: 0; position: absolute; pointer-events: none;');
                insertRule(["    .ol-popup:after"], "border-top-color: white; border-width: 10px; left: 48px; margin-left: -10px;");
                insertRule(["    .ol-popup:before"], "border-top-color: #cccccc; border-width: 11px; left: 48px; margin-left: -11px;");
                insertRule([".ol-popup-content"], "min-width: 170px; max-height: 200px; overflow-x: auto;");
                insertRule([".ol-popup-closer"], "position: absolute; top: 2px; right: 2px; font-size: 150%; padding: 0 4px; color: gray; text-decoration: none;");
                insertRule(["    .ol-popup-closer:after"], 'content: "\\2716";');
                insertRule([".ol-popup div.infoResult"], "min-width: 130px;");
                insertRule(["    .ol-popup div.infoResult p"], "padding: 0.1rem; margin: 0;");
                insertRule([".ol-popup-content h3"], "margin: 0.25em 0;");
                insertRule([".ol-popup.marker"], "margin-bottom: 30px;");
            }
        }
        //metodo que altera elementos existentes o crea nuevos elementos sin necesidad de alterar el filetransfer
        function alterNewElements(o) {
            //todos
            o.datatags.elementAtt = _.filter(o.datatags.elementAtt, (ee) => {
                return !(ee.NombreElemento === "Firma" || ee.NombreElemento === "Footer" ||
                    ee.NombreElemento === "Espacio" || ee.NombreElemento === "CalculadoraFinanciera" ||
                    ee.NombreElemento === "RostroVivo");
            });
            _.forEach(o.datatags.elementAtt, (tt) => {
                tt.Atributos.MostrarLoader && (delete tt.Atributos.MostrarLoader);
                tt.Atributos.VisibleContenido && (delete tt.Atributos.VisibleContenido);
                tt.Atributos.NombreEstiloPersonal = {
                    Descripcion: "Nombre de estilos para este elemento",
                    Valor: "",
                    Configurable: true
                };
                tt.Atributos.CssElementoGlobal = {
                    Descripcion: "",
                    Valor: tt.NombreElemento.toLowerCase() + "estiloglobal",
                    Configurable: false
                };
            });
            //#region => Plantilla
            {
                var plantilla = _.find(o.datatags.elementAtt, { NombreElemento: "Plantilla" });
                plantilla.Atributos.TiempoAutoguardado.Valor = 3;
                plantilla.Atributos.HojaEstilos = {
                    Descripcion: "Hoja de estilos CSS global (Para toda la plantilla)",
                    Valor: "",
                    Configurable: true
                };
                plantilla.Atributos.MostrarVersion = {
                    Descripcion: "Visualizar el número de versión a simplevista",
                    Valor: true,
                    Configurable: true
                };
                plantilla.Atributos.UrlEstilos = {
                    Descripcion: "Url de estilos CSS (separado por ;)",
                    Valor: "",
                    Configurable: true
                };
                delete plantilla.Atributos.VerPiePlantilla;
            }
            //#region => Audio 
            {
                var audio = _.find(o.datatags.elementAtt, { NombreElemento: "Audio" });
                audio.Atributos.IconoAgregar = {
                    Descripcion: "Tipo de icono (https://fontawesome.com/v5/search?m=free)",
                    Valor: "fas fa-file-audio",
                    Configurable: true
                };
                audio.Atributos.VerIconoAgregar = {
                    Descripcion: "¿Ver icono del botón agregar?",
                    Valor: true,
                    Configurable: true
                };
                audio.Atributos.TextoAgregar = {
                    Descripcion: "Texto del botón agregar",
                    Valor: "Agregar Audio",
                    Configurable: true
                };
                audio.Atributos.Ancho = {
                    Descripcion: "Ancho botón",
                    Valor: [
                        { Nombre: 'Normal', Valor: 'normal' },
                        { Nombre: 'Completo', Valor: 'completo' }],
                    Configurable: true
                };
            }
            //#region => Boton
            {
                var btn = _.find(o.datatags.elementAtt, { NombreElemento: "Boton" });
                btn.Atributos.IconoAgregar = {
                    Descripcion: "Tipo de icono (https://fontawesome.com/v5/search?m=free)",
                    Valor: "far fa-hand-pointer",
                    Configurable: true
                };
                btn.Atributos.VerIconoAgregar = {
                    Descripcion: "¿Ver icono del botón agregar?",
                    Valor: true,
                    Configurable: true
                };
                delete btn.Atributos.AlineadoVertical;
                btn.Atributos.AlineadoTexto.Valor = [
                    { Nombre: 'Izquierda', Valor: 'left', Icono: 'fas fa-align-left' },
                    { Nombre: 'Centrado', Valor: 'center', Icono: 'fas fa-align-center' },
                    { Nombre: 'Derecha', Valor: 'right', Icono: 'fas fa-align-right' }];
            }
            //#region => Comboboxtemporal
            {
                var cbt = _.find(o.datatags.elementAtt, { NombreElemento: "ComboBoxTemporal" });
                cbt.Atributos.OcultarSubtitulo = {
                    Descripcion: "Ocultar subtítulo",
                    Valor: false,
                    Configurable: true
                };
                cbt.Atributos.Subtitulo = {
                    Descripcion: "Subtitulo",
                    Valor: "",
                    Configurable: true
                };
            }
            //#region => Codigo QR
            {
                var qr = _.find(o.datatags.elementAtt, { NombreElemento: "CodigoQR" });
                qr.Atributos.IconoAgregar = {
                    Descripcion: "Tipo de icono (https://fontawesome.com/v5/search?m=free)",
                    Valor: "fas fa-qrcode",
                    Configurable: true
                };
                qr.Atributos.VerIconoAgregar = {
                    Descripcion: "¿Ver icono del botón?",
                    Valor: true,
                    Configurable: true
                };
                qr.Atributos.Texto = {
                    Descripcion: "Texto del botón",
                    Valor: "Escanear",
                    Configurable: true
                };
                qr.Atributos.Ancho = {
                    Descripcion: "Ancho botón",
                    Valor: [
                        { Nombre: 'Normal', Valor: 'normal' },
                        { Nombre: 'Completo', Valor: 'completo' }],
                    Configurable: true
                };
            }
            //#region => Documento
            {
                var doc = _.find(o.datatags.elementAtt, { NombreElemento: "Documento" });
                doc.Atributos.PermisoImportarVacio = {
                    Descripcion: "¿Puede importar imagen en blanco?",
                    Valor: true,
                    Configurable: true
                };
                doc.Atributos.TextoAgregar = {
                    Descripcion: "Texto del botón agregar",
                    Valor: "Agregar documentos",
                    Configurable: true
                };
                doc.Atributos.IconoAgregar = {
                    Descripcion: "Tipo de icono (https://fontawesome.com/v5/search?m=free)",
                    Valor: "fas fa-copy",
                    Configurable: true
                };
                doc.Atributos.VerIconoAgregar = {
                    Descripcion: "¿Ver icono del botón agregar?",
                    Valor: true,
                    Configurable: true
                };
                doc.Atributos.Ancho = {
                    Descripcion: "Ancho botón",
                    Valor: [
                        { Nombre: 'Normal', Valor: 'normal' },
                        { Nombre: 'Completo', Valor: 'completo' }],
                    Configurable: true
                };
            }
            //#region => Imagen
            var imagen = _.find(o.datatags.elementAtt, { NombreElemento: "Imagen" });
            delete imagen.Atributos.PermisoEscanear;
            //#region => OCR/Veridas
            {
                var veridas = _.find(o.datatags.elementAtt, { NombreElemento: "OCR" });
                //Edicion directa del ocr para no depender del idportal
                veridas.Atributos.Nombre.Valor = "Veridas";
                veridas.Atributos.Titulo.Valor = "Veridas";
                veridas.Atributos.TextoOCR.Descripcion = "Texto del botón";
                veridas.Atributos.TextoOCR.Valor = "Validar";
                veridas.Atributos.ImagenAnverso.Descripcion = "Elemento donde irá la imágen Anversa del documento";
                veridas.Atributos.ImagenReverso.Descripcion = "Elemento donde irá la imágen Reversa del documento";
                veridas.Atributos.FormasValidacion = {
                    Descripcion: "Formas de validación",
                    Valor: [
                        {
                            "Nombre": "Validación de documentos por fotografía",
                            "Valor": "documentos"
                        },
                        {
                            "Nombre": "Validación de prueba de vida",
                            "Valor": "selfie"
                        },
                        {
                            "Nombre": "Validación de documentos por video y prueba de vida",
                            "Valor": "video"
                        },
                        {
                            "Nombre": "Confirmar proceso ante Veri-das",
                            "Valor": "confirm"
                        },
                        {
                            "Nombre": "Cancelar proceso ante Veri-das",
                            "Valor": "cancel"
                        },
                        {
                            "Nombre": "Validación PEP-AML",
                            "Valor": "pepaml"
                        }
                    ],
                    Configurable: true
                };
                veridas.Atributos.PaisDocumentos = {
                    Descripcion: "Tipo de documento por País",
                    Valor: [
                        {
                            "Nombre": "México",
                            "Valor": "MX2_ID"
                        }
                    ],
                    Configurable: true
                };
                veridas.Atributos.ImagenSelfie = {
                    Descripcion: "Elemento donde irá la imágen de la prueba de vida",
                    Valor: "",
                    Configurable: true
                };
                veridas.Atributos.VideoSelfie = {
                    Descripcion: "Elemento donde irá el video de la prueba de vida",
                    Valor: "",
                    Configurable: true
                };
                veridas.Atributos.VideoDocumentosSelfie = {
                    Descripcion: "Elemento donde irá el video de los documentos y prueba de vida",
                    Valor: "",
                    Configurable: true
                };
                veridas.Atributos.MappingOCR = {
                    Descripcion: "Mapeo para el OCR",
                    Valor: "",
                    Configurable: true
                };
                veridas.Atributos.MappingScore = {
                    Descripcion: "Mapeo para el Score",
                    Valor: "",
                    Configurable: true
                };
                veridas.Atributos.MappingPEPAML = {
                    Descripcion: "Mapeo para los datos PEP-AML",
                    Valor: "",
                    Configurable: true
                };
                veridas.Atributos.TokenShared = {
                    Descripcion: "Elemento donde irá el token",
                    Valor: "",
                    Configurable: true
                };
                veridas.Atributos.Ancho = {
                    Descripcion: "Ancho del botón",
                    Valor: [
                        {
                            "Nombre": "Normal",
                            "Valor": "normal"
                        },
                        {
                            "Nombre": "Completo",
                            "Valor": "completo"
                        }
                    ],
                    Configurable: true
                };
                veridas.Atributos.Tamanio = {
                    Descripcion: "Tamaño del botón",
                    Valor: [
                        {
                            "Nombre": "Normal",
                            "Valor": "normal"
                        },
                        {
                            "Nombre": "Chico",
                            "Valor": "mini"
                        },
                        {
                            "Nombre": "Grande",
                            "Valor": "grande"
                        }
                    ],
                    Configurable: true
                };
                veridas.Atributos.ColorFondo = veridas.Atributos.ColorBotonOcr;
                veridas.Atributos.ColorFondo.Descripcion = "Color de fondo";
                veridas.Atributos.ColorTexto = veridas.Atributos.ColorBotonOcrTexto;
                veridas.Atributos.ColorTexto.Descripcion = "Color del texto";
                delete veridas.Atributos.ColorBotonOCR;
                delete veridas.Atributos.ColorBotonOCRTexto;
                delete veridas.Atributos.ColorBotonCorreccion;
                delete veridas.Atributos.ColorBotonCorreccionTexto;
                delete veridas.Atributos.Documents;
                delete veridas.Atributos.DocumentsMinimal;
                delete veridas.Atributos.DocumentsPaper;
                delete veridas.Atributos.PermitirCorreccion;
                delete veridas.Atributos.Passport;
                delete veridas.Atributos.AssemblyPath;
                delete veridas.Atributos.Prefijo;
                delete veridas.Atributos.TextoCorreccion;
                delete veridas.Atributos.Proveedor;
                delete veridas.Atributos.MappingMicroblink;
            }
            //Region => Marcado de documentos
            {
                var marc = _.find(o.datatags.elementAtt, { NombreElemento: "Numero" });
                delete marc.Atributos.TextoOpcionCatalogo;
            }
            //Region => Numero y nueva transformacion en knob o medidor
            {
                var numero = _.find(o.datatags.elementAtt, { NombreElemento: "Numero" });
                numero.Atributos.ConvertirKnob = {
                    Descripcion: "¿Convertir en medidor? (Grafica tipo pie de un solo valor)",
                    Valor: false,
                    Configurable: true
                };
                numero.Atributos.ConvertirTimer = {
                    Descripcion: "¿Convertir en temporizador? (Reloj en retroceso)",
                    Valor: false,
                    Configurable: true
                };
                numero.Atributos.TiempoRetroceso = {
                    Descripcion: "Tiempo inicial del temporizador (Segundos)",
                    Valor: 30,
                    Configurable: true
                };
            }
            //#region => FAD
            var fad = _.find(o.datatags.elementAtt, { NombreElemento: "FirmaFAD" });
            fad.Atributos.SinTerminos = {
                Descripcion: "No mostrar terminos",
                Valor: false,
                Configurable: true
            };
            //#region => Lista
            {
                var list = _.find(o.datatags.elementAtt, { NombreElemento: "Lista" });
                list.Atributos.ImagePosition = {
                    Descripcion: "Ubicación de la imágen si cuenta con Atributos el catalogo (ImagenFE)",
                    Valor: [
                        {
                            "Nombre": "Arriba",
                            "Valor": "up"
                        },
                        {
                            "Nombre": "Izquierda",
                            "Valor": "left"
                        },
                        {
                            "Nombre": "Derecha",
                            "Valor": "right"
                        },
                        {
                            "Nombre": "Abajo",
                            "Valor": "down"
                        }
                    ],
                    Configurable: true
                };
            }
            //#region => Wizard
            var wiz = _.find(o.datatags.elementAtt, { NombreElemento: "Wizard" });
            wiz.Atributos.ElementoAValidar.Valor = "";
            //#region => DocumentoPDFOCR
            {
                var pdfocr = _.find(o.datatags.elementAtt, { NombreElemento: "PDFOCR" });
                delete pdfocr.Atributos.IncluirEnPdf;
            }
        }
        function alterNewComponents(o) {
            o.datatags.catalogos.forEach((t) => {
                t.HasImagenFE = _.isEmpty(t.Esquema) ? !1 : t.Esquema.indexOf("ImagenFE") >= 0;
                o.datatags.allitemscatalogs["catalogos|" + t.CatalogoId] && o.datatags.allitemscatalogs["catalogos|" + t.CatalogoId].forEach((r) => {
                    r.HasImagenFE = _.isEmpty(r.Esquema) ? !1 : r.Esquema.indexOf("ImagenFE") >= 0;
                    r.ImagenFE = r.HasImagenFE ? _.find(JSON.parse(r.Esquema), { Campo: "ImagenFE" }).Valor : "";
                });
            });
        }
        function alterNewServices(o) {
            //parche para los servicios V1 ya que algunas cosas cambiaron
            var serv = _.find(o.datatags.servicesList, { id: 110 });
            if (serv) {
                serv.pin.method[1].options = ["imagen"];
                serv.pin.method[0].options = ["imagen"];
                serv.pin.system[0] = {
                    "name": "proyid",
                    "order": 4,
                    "datatype": "int",
                    "value": ""
                };
            }
        }
        function alterNewRules(o) {
            o.datatags.accionesreglas.push({
                Nombre: "Autodescarga de anexo (por si quieren que se visualice el anexo sin dar click)",
                Valor: "downloadanexo",
                Grupo: "Anexos"
            });
            o.datatags.accionesreglas.push({
                Nombre: "Pedir cámara de elemento imagen/documento (Por si por regla quieren automatizar la cámara teniendo oculto el elemento original)",
                Valor: "autocamara",
                Grupo: "Anexos"
            });
            o.datatags.accionesreglas.push({
                Nombre: "Borrar anexo (Por si quieren borrar un anexo)",
                Valor: "deleteanexo",
                Grupo: "Anexos"
            });
            o.datatags.accionesreglas.push({
                Nombre: "Usar ID Anexo como timestamp",
                Valor: "getguidanexo",
                Grupo: "Anexos"
            });
            o.datatags.accionesreglas.push({
                Nombre: "Clic boton Veri-Das",
                Valor: "clicveridas",
                Grupo: "OCR",
                Esquema: "La accion se configura en el elemento Veri-das"
            });
            o.datatags.accionesreglas.push({
                Nombre: "Seleccionar todos los items del catalogo",
                Valor: "selectall",
                Grupo: "Propiedades",
                TieneEsquema: !0,
                Esquema: "Sirve para siempre seleccionar todo de un catalogo y no tener que marcar uno por uno en las reglas"
            });
            o.datatags.condicionesReglas.push({
                Nombre: "Estamos visualizandola",
                Valor: "pageactive"
            });
            o.datatags.condicionesReglas.push({
                Nombre: "Al no usar navegadores soportados (Chrome/Edge/Firefox/Safari)",
                Valor: "browsersnotsupported"
            });
            o.datatags.condicionesReglas.push({
                Nombre: "¿Es valido el elemento?",
                Valor: "isvalidatedelement"
            });
            var showpage = _.find(o.datatags.condicionesReglas, { Valor: "showpage" });
            if (showpage)
                showpage.Nombre = "Al mostrarse";

            o.datatags.catext.push({ descripcion: "xml", sizemax: 10000 });
        }
        function b64EncodeUnicode(str) {
            return btoa(encodeURIComponent(str));
        }
        function b64DecodeUnicode(str) {
            try { str = atob(str); } catch (e) { console.error(e); }
            return str.indexOf("%3") >= 0 || str.indexOf("%2") >= 0 ? decodeURIComponent(str) : str;
        }
        function checkTipoListaDefaultItemAndSet(o, id) {
            var catori = _.clone(o.datatags.allitemscatalogs[o.appvm[id].fuentedatos() + "|" + o.appvm[id].catalogoorigen()]) || [];
            var valmet = o.appvm[id].valormetadato().toString(), rangos = [], filterdata = [], ta = o.appvm[id].tipoasociacion(),
                tl = o.appvm[id].tipolista(), typemet = ta === "idid" || ta === "iddesc" ? "Valor" : "Nombre", item, selecteds;
            //-------se tiene que ir
            var itemvacio = { Nombre: "--Seleccione--", Valor: "", CatalogoId: o.appvm[id].catalogoorigen(), CveCatalogo: "", CatalogoPId: 0 };
            catori && catori.length && tl === "combo" && (catori[catori.length] = itemvacio);
            //-------se tiene que ir
            o.appvm[id].filtrarcatalogo && o.appvm[id].filtrarcatalogo().filtrar === !0 && (
                o.appvm[id].filtrarcatalogo().rangofiltrado && o.appvm[id].filtrarcatalogo().rangofiltrado.length > 0 ?
                    (rangos = o.appvm[id].filtrarcatalogo().rangofiltrado.match(/{[0-9]+:[0-9]+}/g), rangos && rangos.length > 0 && _.forEach(rangos, function (nfdval) {
                        let rango = nfdval.match(/[0-9]+:[0-9]+/g); rango = rango[0].split(':');
                        catori = _.union(filterdata, _.slice(catori, rango[0] - 1, rango[1]));
                    })) : o.appvm[id].filtrarcatalogo().idfiltrados && (
                        catori = _.filter(catori, function (elfil) { return _.includes(o.appvm[id].filtrarcatalogo().idfiltrados.toString().split(','), elfil.Valor); })
                    ));
            !o.appvm.isEditor() && o.appvm[id].cascadahijo && o.appvm[o.appvm[id].cascadahijo()] && (o.appvm[o.appvm[id].cascadahijo()]["hascascadapadre"] = !0);
            !o.appvm[id].hascascadapadre && (o.appvm[id].catalogodestino(setDescriptionAndOrder(o, id, catori)),
                tl === "combo" ? (o.appvm.isEditor() ? valmet = "" : (item = _.find(catori, function (m) { return valmet === m[typemet]; }),
                    item && (valmet = item.Valor)), o.appvm[id].optionselected(valmet)) : (selecteds = _.filter(catori,
                        function (v) { return _.includes(_.map(valmet.toString().split(","), function (vmd) { return vmd.trim(); }), v[typemet]); }),
                        tl !== "checkbox" && (selecteds = _.head(selecteds)), o.appvm[id].chosenitems(selecteds)));
        }
        //Realiza la redireccion de la accion deseada por el tipo de elemento
        //tipo: el tipo de elemento
        //id: id del elemento
        //p: params a enviar al metodo final
        //forced: si es obligatorio realizarlo
        function customClickButtonsElements(tipo, id, p, forced) {
            let o = getOpts();
            if (forced || !o.appvm.isEditor() && !o.appvm.isQuery())
                switch (tipo) {
                    case o.TE.Tabla: actionRowTable(id, p instanceof Array ? p : [p]); break;
                    case o.TE.FirmaFAD: case o.TE.CodigoQR: case o.TE.Wizard: case o.TE.Audio: case o.TE.Georeferencia: case o.TE.HuellaDigital: case o.TE.Imagen: case o.TE.Video: case o.TE.OCR: case o.TE.PDFOCR: customActionElement(id, [tipo, p], forced); break;
                    case o.TE.Documento: typeof p === "string" ? customActionElement(id, [tipo, p], forced) : customActionElement(id, [tipo, p[0], p[1], p[2]], forced); break;
                    case o.TE.Seccion: showSectionAsModal(id); break;
                }
        }
        function customActionElement(id, params, forced) {
            var o = getOpts(), pag = "", strfunc, mediaSave, currentStream, ane, cammo, baseCamera, optsE, elemContainer, elemBaseCamVid, elemBaseAudio, elemBaseCamera,
                optsVideo, optsCamera, optMovCamera, elemVideo, elemCamera, timeIntervalVideo, videoLengthElem, isFront, ext, audiorecorder, totalseconds,
                throwError = function (e) { toasty('', e.message, 'error'); },
                streamWebCam = function (stream) {
                    if (stream) {
                        currentStream = stream;
                        if (_.includes(["video", "fad"], params[1])) {
                            var mimet = "video/webm", origmimet = "video";
                            mediaSave = new MediaRecorder(stream, { mimeType: mimet });
                            mediaSave.addEventListener('dataavailable', function (e) {
                                if (e.data.size > 0) {
                                    var reader = new window.FileReader();
                                    reader.readAsDataURL(e.data);
                                    reader.onloadend = function () {
                                        var base64 = reader.result.substr(reader.result.indexOf("base64,") + 7);
                                        if (elemContainer.find(origmimet)[0])
                                            elemContainer.find(origmimet)[0].src = "data:video/mp4;base64," + base64, elemContainer.find(origmimet)[0].load();
                                    };
                                }
                            });
                            mediaSave.start();
                        }
                        baseCamera.srcObject = stream, baseCamera.play();
                    }
                    else toasty('No se pudo acceder a la cámara', '', 'error');
                },
                initializeCamera = function (isFrontCamera) {
                    if (window.location.protocol === "https:") {
                        stopMedia();
                        var constraints = { video: _.includes(["camera", "video", "fad"], params[1]) ? !o.iswebapp && !isFrontCamera ? { facingMode: "environment" } : !0 : !1, audio: "video" === params[1] || (o.appvm[id].tipo() === o.TE.FirmaFAD && o.appvm[id].tipovalidacion() === "video") };
                        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) navigator.mediaDevices.getUserMedia(constraints).then(streamWebCam).catch(throwError);
                        else if (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.oGetUserMedia || navigator.msGetUserMedia)
                            navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.oGetUserMedia || navigator.msGetUserMedia, navigator.getUserMedia(constraints, streamWebCam, throwError);
                        else toasty('', 'No existe soporte de medios para este navegador', 'error');
                    } else toasty('Protocolo no seguro', 'El uso de la camara solo esta permitido en protocolo HTTPS');
                },
                stopMedia = function () { currentStream && currentStream.getTracks && (_.forEach(currentStream.getTracks(), function (tr) { tr.stop(); }), currentStream = null); },
                snapPhotoCamera = function (isDelete) {
                    if (isDelete) {
                        optsE.find("#deletemedia,#savemedia").attr("hidden", ""), optsE.find("#snapmedia,#reversecam").removeAttr("hidden");
                        elemContainer.attr("hidden", ""), $(baseCamera).removeAttr("hidden");
                    } else {
                        var canvas = elemContainer.find("canvas")[0], context = canvas.getContext("2d");
                        if (baseCamera.srcObject) {
                            canvas.width = baseCamera.clientWidth, canvas.height = baseCamera.clientHeight;
                            context.drawImage(baseCamera, 0, 0, canvas.width, canvas.height);
                            optsE.find("#snapmedia,#reversecam").attr("hidden", ""), optsE.find("#deletemedia,#savemedia").removeAttr("hidden");
                            $(baseCamera).attr("hidden", ""), elemContainer.removeAttr("hidden");
                        }
                        else toasty('No se pudo acceder a la cámara', '', 'error');
                    }
                },
                record = function (isRecord) {
                    if (isRecord) {
                        lengthVideo(!0), initializeCamera();
                        optsE.find("#stoprecordvideo").removeAttr("hidden"), optsE.find("#snapmedia,#deletemedia,#savemedia,#reversecam").attr("hidden", "");
                        $(baseCamera).removeAttr("hidden"), elemContainer.attr("hidden", "");
                    }
                    else {
                        lengthVideo(), mediaSave.stop(), stopMedia();
                        optsE.find("#stoprecordvideo,#reversecam").attr("hidden", ""), optsE.find("#deletemedia,#savemedia").removeAttr("hidden");
                        $(baseCamera).attr("hidden", ""), elemContainer.removeAttr("hidden");
                    }
                },
                recordaudio = function (isRecord) {
                    if (isRecord) {
                        lengthVideo(!0);
                        if (window.location.protocol === "https:") {
                            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                                navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
                                    audiorecorder = RecordRTC(stream, {
                                        type: 'audio', mimeType: 'audio/webm', recorderType: StereoAudioRecorder
                                    });
                                    audiorecorder.startRecording();
                                });
                            } else toasty('', 'No existe soporte de medios para este navegador', 'error');
                        } else toasty('Protocolo no seguro', 'El uso del micrófono solo esta permitido en protocolo HTTPS');
                        optsE.find("#stoprecordvideo").removeAttr("hidden"), optsE.find("#snapmedia,#deletemedia,#savemedia,#reversecam").attr("hidden", "");
                        elemContainer.attr("hidden", "");
                    }
                    else {
                        audiorecorder.stopRecording(() => {
                            var blob = audiorecorder.getBlob();
                            var file = new File([blob], 'demo.webm', {
                                type: 'audio/webm'
                            });
                            invokeSaveAsDialog(file);
                            // to fix video seeking issues
                            //getSeekableBlob(audiorecorder.getBlob(), function (seekableBlob) {
                            var reader = new FileReader();
                            reader.readAsDataURL(blob);
                            reader.onload = function (event) {
                                let vid = event.target.result.substring(event.target.result.indexOf(";base64,") + 8);
                                var audio = elemContainer.find("audio")[0];
                                audio.src = "data:audio/mpeg;base64," + vid, audio.load();
                                var ts = totalseconds;
                                audio.currentTime = totalseconds;
                                audio.addEventListener("ended", function (e) {
                                    audio.currentTime = totalseconds;
                                });
                                audiorecorder.destroy();
                            };
                            //});
                        });
                        optsE.find("#stoprecordvideo,#reversecam").attr("hidden", ""), optsE.find("#deletemedia,#savemedia").removeAttr("hidden");
                        elemContainer.removeAttr("hidden"), lengthVideo();
                    }
                },
                lengthVideo = function (init) {
                    var dateSeconds = new Date(null);
                    videoLengthElem.text("00:00:00");
                    !!timeIntervalVideo && clearInterval(timeIntervalVideo);
                    videoLengthElem.attr("hidden", "");
                    if (init === !0) {
                        videoLengthElem.removeAttr("hidden");
                        totalseconds = 0;
                        timeIntervalVideo = setInterval(function () {
                            totalseconds += 1;
                            dateSeconds = new Date(null);
                            dateSeconds.setSeconds(totalseconds);
                            videoLengthElem.text(dateSeconds.toISOString().substr(11, 8));
                        }, 1000);
                    }
                };

            if (o.drawPreviewer && (o.appvm[id] && (o.appvm[id].habilitado() || forced) || params[0] === "component")) {
                switch (params[1]) {
                    case "qrscan":
                        var scannerqr = new Instascan.Scanner({ video: document.getElementById(id + 'qrcodescanner') });
                        o.appvm[id].scanmode(!0);
                        scannerqr.addListener('scan', function (content) {
                            if (o.appvm[id].permitirprellenadoexterno()) {
                                content = content.replace(/\\"/g, "\"").replace(/"{/g, "{").replace(/}"/g, "}");
                                var prefillcontent = verifyJsonString(content) ? JSON.parse(content) : {}, newprefillcontent = [];
                                if (prefillcontent.length > 0)
                                    content = prefillcontent;
                                //_.forEach(_.keys(prefillcontent), function (pf) {
                                //    _.forEach(pf.toString().split("_"), function (pfs) {
                                //        newprefillcontent.push({ elementodestino: "formElec_element" + pfs, valor: prefillcontent[pf], metadato: prefillcontent[pf] });
                                //    });
                                //});
                                prefilldata(o, JSON.stringify(newprefillcontent));
                            }
                            o.appvm[id].valor(content), o.appvm[id].scanmode(!1), scannerqr.stop();
                        });
                        Instascan.Camera.getCameras().then(function (cameras) {
                            cameras.length > 0 ? scannerqr.start(cameras[0]) : console.error('No se detectaron c&aacute;maras.');
                        }).catch(function (e) {
                            toasty('', 'Navegador no compatible con esta funcionalidad', 'error'), o.appvm[id].scanmode(!1), scannerqr.stop();
                        });
                        $("#qrscancancel_" + id).on("click", function () { o.appvm[id].scanmode(!1), scannerqr.stop(); });
                        break;
                    case "camera": case "video": case "mic":
                        cammo = $('<div class="modal" style="display:block;overflow:auto">\
                            <div class="modal-dialog modal-lg modal-dialog-centered">\
                                <div id="camaramodal" class="modal-content rounded">\
                                    <div class="modal-header p-2 border-bottom border-dark bg-white">\
                                        <h5 class="modal-title text-dark">' + o.appvm[id].titulo() + '</h5>\
                                        <span id="camaraclose" title="Cancelar" class="btn btn-sm btn-outline-danger btn-lg border"><i style="font-size:16px" class="fas fa-times"></i></span>\
                                    </div>\
                                    <div class="modal-body p-2">\
                                        <div id="elemBaseContainer" class="no-padding rounded position-relative w-100">\
                                        </div>\
                                    </div>\
                                </div>\
                            </div>\
                        </div>'), elemBaseCamVid = `<div class="row">
                                <div class="col-12">
                                    <video id="recvideo" class="p-0 w-100" controls playsinline><source type="video/mp4"></source></video>
                                    <div id="elemToShow" class="no-padding rounded position-relative col-sm-12" hidden><video class="p-0 w-100" controls playsinline><source type="video/mp4"></source></video></div>
                                </div>
                                <div class="col-12">
                                    <div id="videolengthvid" class="p-2" style="font-size:1rem; text-align: right;">00:00:00</div>
                                    <div id="opts" class="btn-group" style="font-size:1.2rem;bottom: 0;position: absolute;">
                                        <div id="snapmedia" class="btn btn-primary"><i class="far fa-play-circle"></i> Grabar</div>
                                        <div id="deletemedia" class="btn btn-danger" hidden><i class="fas fa-trash-alt"></i> Borrar</div>
                                        <div id="stoprecordvideo" class="btn btn-secondary" hidden><i class="far fa-stop-circle"></i> Detener</div>
                                        <div id="savemedia" class="btn btn-success" hidden><i class="far fa-save"></i> Salvar</div>
                                    </div>
                                </div>
                            </div>`, elemBaseCamera = `<div class="row">
                                <div class="col-12">
                                    <video id="recvideo" class="p-0 w-100" controls playsinline><source type="video/mp4"></source></video>
                                    <div id="elemToShow" class="no-padding rounded position-relative col-sm-12" hidden><canvas class="p-0"></canvas></div>
                                </div>
                                <div class="col-12">
                                    <div id="opts">
                                        <div id="snapmedia" class="btn btn-primary btn-block"><i class="fas fa-camera-retro"></i>&nbsp;&nbsp;&nbsp;Tomar Foto</div>
                                        <div id="deletemedia" class="btn btn-danger btn-block" hidden><i class="far fa-trash-alt"></i>&nbsp;&nbsp;&nbsp;Reintentar</div>
                                        <div id="savemedia" class="btn btn-success btn-block" hidden><i class="far fa-save"></i>&nbsp;&nbsp;&nbsp;Aceptar</div>
                                    </div>
                                </div>
                            </div>`, elemBaseAudio = `<div class="row">
                                <div class="col-12">
                                    <textarea rows="5" cols="5" class="form-control"></textarea>
                                </div>
                                <div class="col-12">
                                    <div id="videolengthvid" class="p-2" style="font-size:1rem; text-align: right;">00:00:00</div>
                                    <div id="elemToShow" class="no-padding rounded position-relative col-sm-12" hidden><audio class="p-0 w-100" controls><source type="audio/mp3"></source></audio></div>
                                    <div id="opts" class="btn-group" style="font-size:1.2rem;bottom: 0;position: absolute;">
                                        <div id="snapmedia" class="btn btn-primary"><i class="far fa-play-circle"></i> Grabar</div>
                                        <div id="deletemedia" class="btn btn-danger" hidden><i class="fas fa-trash-alt"></i> Borrar</div>
                                        <div id="stoprecordvideo" class="btn btn-secondary" hidden><i class="far fa-stop-circle"></i> Detener</div>
                                        <div id="savemedia" class="btn btn-success" hidden><i class="far fa-save"></i> Salvar</div>
                                    </div>
                                </div>
                            </div>`, optMovCamera = '<div class="position-absolute p-3" style="top:0; right:0"><i id="reversecam" title="Cambiar c&aacute;mara" class="fas fa-retweet" style="cursor:pointer;"></i></div>',
                            timeIntervalVideo, videoLengthElem, isFront;

                        //Cámara, video y audio
                        var initializeMedia = function () {
                            cammo.find("#camaraclose").on("click", function () { lengthVideo(), stopMedia(), cammo.remove(); });
                            $("#elemBaseContainer").append(params[1] === "video" ? elemBaseCamVid : params[1] === "camera" ? elemBaseCamera : elemBaseAudio);
                            elemContainer = $("#elemToShow"), optsE = $("#opts");
                            optsE.find("#savemedia").on("click", function () { saveMedia(); });
                            if (params[1] === "mic") {
                                if (o.appvm[id].leyendaaudio && o.appvm[id].leyendaaudio().length)
                                    $("#elemBaseContainer").find("textarea").html(o.appvm[id].leyendaaudio());
                                else $("#elemBaseContainer").find("textarea").remove();
                            }
                            if (params[1] === "video")
                                optsE.find("#deletemedia,#snapmedia").on("click", function () { record(!0); }), optsE.find("#stoprecordvideo").on("click", function () { record(!1); });
                            else if (params[1] === "mic")
                                optsE.find("#deletemedia,#snapmedia").on("click", function () { recordaudio(!0); }), optsE.find("#stoprecordvideo").on("click", function () { recordaudio(!1); });
                            else if (params[1] === "camera")
                                optsE.find("#snapmedia").on("click", function () { snapPhotoCamera(!1); }), optsE.find("#deletemedia").on("click", function () { snapPhotoCamera(!0); });
                            baseCamera = document.getElementById("recvideo");
                            videoLengthElem = $("#videolengthvid");

                            _.includes(["camera", "video"], params[1]) && (initializeCamera(), !o.iswebapp && (isFront = !1, optsE.append(optMovCamera),
                                optsE.find("#reversecam").on("click", function () { isFront = !isFront, initializeCamera(isFront); })));
                        };
                        var saveMedia = function () {
                            var datatosave;
                            try {
                                if (params[1] === "video") datatosave = elemContainer.find("video")[0].src, ext = "mp4";
                                else if (params[1] === "camera") datatosave = elemContainer.find("canvas")[0].toDataURL("image/png"), ext = "png";
                                else if (params[1] === "mic") datatosave = elemContainer.find("audio")[0].src, ext = "mp3";
                                if (params[2] === "reemp" && params[3] !== "")
                                    o.appvm[id].ondelete(!0), params[3].Reemplazado = !0, createAttachment(o, id, ext, datatosave, params[3].DocID, !1, o.appvm[id].tipo() === o.TE.Documento);
                                else createAttachment(o, id, ext, datatosave, '', '', o.appvm[id].tipo() === o.TE.Documento);
                                stopMedia(), cammo.remove();
                            }
                            catch (e) { throwError(e), stopMedia(), toasty('', 'Error de medio. Intente nuevamente.', 'error'); }
                        };

                        $("body").append(cammo);
                        initializeMedia();
                        break;
                    case "import":
                        var exts, multiple = "", accept = "";
                        switch (o.appvm[id].tipo()) {
                            case o.TE.Imagen: exts = ['png', 'gif', 'jpg', 'jpeg', 'bmp']; accept = "image/*"; break;
                            case o.TE.Audio: exts = ['mp3']; accept = "audio/*"; break;
                            case o.TE.Video: exts = ['mp4']; accept = "video/*"; break;
                            case o.TE.PDFOCR: exts = ['pdf']; accept = "application/pdf"; break;
                            case o.TE.Documento:
                                exts = !o.appvm[id].extensionespermitidas() ? _.map(o.datatags.catext, function (cats) { return cats.descripcion.toLowerCase(); }) : o.appvm[id].extensionespermitidas().toString().toLowerCase().split(','),
                                    accept = !exts ? "*" : "." + exts.join(',.'),
                                    multiple = "multiple"; break;
                            default: accept = "*", exts = "*"; break;
                        }
                        cammo = $('<input type="file" accept="' + accept + '" ' + multiple + ' hidden>');
                        var upfiles = [];
                        cammo.on("change", function () {
                            _.forEach(cammo.get(0).files, function (file) {
                                var extf = file.name.substring(file.name.lastIndexOf(".") + 1).toLowerCase();
                                if (accept !== "*" && !_.includes(exts, extf)) {
                                    toasty("Solo se permiten extensiones de tipo " + exts), cammo.remove();
                                    return;
                                }
                                if (o.appvm[id].tipo() === o.TE.Documento) {
                                    var currext = _.find(o.datatags.catext, function (extelm) { return extelm.descripcion.toLowerCase() === extf; });
                                    var currekb = file.size / 1000;
                                    if (currext.sizemax < currekb) {
                                        toasty('', 'El archivo que intenta subir (' + currekb + ' kb) es mayor que el permitido (' + currext.sizemax + ' kb).', 'error');
                                        return;
                                    }
                                }
                                cammo.remove();
                                file && upfiles.push(file);
                            });
                            var count = 1;
                            _.forEach(upfiles, function (upfile) {
                                var reader = new FileReader(), extf = upfile.name.substring(upfile.name.lastIndexOf(".") + 1).toLowerCase();
                                reader.addEventListener("load", function (ev) {
                                    if (params[2] === "reemp" && params[3] !== "")
                                        o.appvm[id].ondelete(!0), params[3].Reemplazado = !0, createAttachment(o, id, extf, ev.target.result, params[3].DocID, !1, o.appvm[id].tipo() === o.TE.Documento, "", upfile.name);
                                    else createAttachment(o, id, extf, ev.target.result, "", count < upfiles.length, o.appvm[id].tipo() === o.TE.Documento, "", upfile.name);
                                    count++;
                                }, false);
                                reader.readAsDataURL(upfile);
                            });
                        });
                        $("body").append(cammo);
                        setTimeout(() => { cammo.click(); }, 500);
                        break;
                    case "noimage":
                        var extf = "png", noimage = "iVBORw0KGgoAAAANSUhEUgAAAFsAAABbCAYAAAAcNvmZAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAACxMAAAsTAQCanBgAAAsOSURBVHhe7ZsLUBXXGcd5CSJvFQF5aJBXEUVAtI5tbCeapPFJNDFtUzVEnE5Tk2lnrDZNNG3SdKbJNDNpZtqqsdWptaGaaNR0TOqMYtNORQGB+hYBQVQeCj54KfT3nbv3Dg/Re5VdmOn5zaz7nXN297L/8+13vnN2ddNoNBqNRqPRaDQajUaj0Wg0Go1Go9FoNBqNRqPR/F/ibuwHJeXl5WENDQ0zMaewje/s7Bzt7u4+mv1Q9rfZX6K+Fvs4+8N+fn55iYmJJ7AHJYNO7IsXL/pevnz52x0dHcvYpiGkl9F0XxDfzcPD4yTn/BnhNyL8ZaNpUDBoxL5w4YJPbW3tSwi8imK4rdaGIeIVzEq2KikjqDQNZxvDOTGUu90Lx7RwzoaAgIC3ExIS5AkYcAaF2IWFhTPu3LnzB8xEW42iFf3+jmA78dIDXl5eVbGxsXeMNgf19fXuN2/eHE64mc41ZiPy01SPtLUq0a95enqujo6O3hgaGtphVA8IAyo2IcPz0qVL6/DMn1H0sNW6NSLwe8OGDft9UlKSy2Hg7NmzvtevX38O4X9KMd5Wy426u++m05ZwzWtGleUMmNgMfkPr6upyMefaatw6EGSTr6/v6uTk5Aaj7oGhE4dUV1e/hGe/SdFf6rDP+vj4zJw4cWKFlK1mQMQ+f/68CP0p4s4yqmoJE8smTZr0mVHuN4qLi+NbW1v/ym+lSxnBK729vb+Rmpp6Xh1gIfZH1zJqamq8iLPbuwgtg997Zggt4MVneFq+jrlXyvxuTHt7+z9KSkoipWwlAyH2L9jNtpVsELPfOnr06DKj2O+kpKTcioqKykLonUZVLN7+FwZVp9PK/sBSsYuKimYh7GqjWMfNv85eMgQPHu8PCwoKXlAtJhAeHt7u7+//Hcx/2mrcHmXcWGvYlmCZ2AxWvrdv3/4dpvxmx5AhQ5ZmZGS8hZ0jZamnIzbi4aYJziSnmXj9HGadlKXjS0tLU8S2AsvEZlb4CrtxYuPRGxmgVIyePHnyJrzaITi2qYITw6sZjFcaRW/CyTuGbTqWZCPMDv0RuxxzBNvVoKCguPj4+G7pXX5+/ot0wnpM5fnYy/H8P27duvVbCDKZTlDH9QUTl5asrKx3ufa9DwTycLfTp08f4JozKHaSDk6fMGHCv22t5mGJ2MwQv88kQ0KIiLIuLS1NBsleIHg2Im/AdAguKWJFRcUXlNPkmL4gJLiFhIQ8s3jx4u1G1T0hfDza3Nx8kN+QbOij9PR0CS+mYkkYQQh7WGgJDg5Wot+NzMzMTexy8DhHSBk5cuT8mJiYWdgF4t0iqn2Tsn0T0W7cuPE62Y6nuth9YOp/CJGPiM21FpSVlYWoBhMx3bOZwETjneWIwb157MCDFhlNDiorKyP3799/mJs+ExERsWDUqFGyvtHVw3Nqa2t3MStcRc6cz3FlDHSjmpqaMhl0l1MeI9cRqL/E8Y41FOkIOuxHc+fO/ZtR5YAn7oc8cb8Vmzj+PLn+VtVgEqZ79tWrVx8TocVm/4mq7AGCDCEuj0a4GcT3fQgrx3UdNDeEhobOX7Zs2RqymC8RPNjPz+9yUlLS28T+BOp+JdcR2trawtlkbNjG9S5iR7L3s7V2JzAwcCfXlt8Q73ZMsszCijAyVf4RD2PwOqhq7s0UPF0JzjkrKDsEJ0vJRuhOPPwdnphC4u45jp2fnZ396rBhw9bKbwgMeL+hY1aReTyLiKrubowbN66Kp61MbM5Vf6eZmC42N6HyWG7qIo/qRVV5fzJFcMLPDuxuHk6IeWrMmDGPc72jCDn21q1bH23evPmFOXPm/BIP/4+czHR8Sl5eXigdMpunSar6hHYVt7n2I8T7uz4B/YUVnj3a2Jcx0PXtZr3JJF38ieTh2N3ycATPkkGT8hHEcm9paXn/5MmToQEBAe/S7kYcnnnixIkrhLAP7ic2nJV/OM+HcCMvI0zDCrHVgg83XatKTiKiMb0+vGfPnoj6+npZROoq+HpieFZ0dPTjlPPZ/M+cObMgOTn5AL9zm7LCCaEFNZsUGhsbTV2csiKM2Bd77jvZ6IqITU5egZdOJC3bfeXKlV6Dpnh4VFTUE5TzEXZsSkpKHeHlFmWn4Tz1tEnH8FtDVKVJmC62/WbENPZOg3Ajhw4dKp6XSZbyuSG4GjS5rvztG8LCwsTDnyDl+5JQEkAn+FDvNByv/i7p3C5/qylYIbY9fLg0+CC0PNZTExISihj4qqmabAj+MbbDw9mUhzNz3HPq1Kk0vNMlsUG9xRFIJ+WlsmlYEUbsb7bjjL3TkCPnILgXXvtjriPiiuBfkBbKunQ3wWVtheNK6CSJ4a6gFseggwHWpXHFVazwbPmARuLhI1VVVcGq0kk4J6aoqOiNJUuW5BJOllPVxJZBWvg5aeFOru0QHFsNmmQpKoazOQWdqNZc6KRqcnVTXwabLjYcln8Qw52sYrqqcQFmlmu2bNnyWmpq6p/INsYheg7b3oaGhmkZGRmbugrOJjNNpwWvqKgIRuwJRjGf7McwzcF0sfGWgzL4CHhqt9dhzsLE5c0jR478iydjBoLvWrp06br09PRDubm5MxBdXhz3ElwGTWzV0X1BHi6po8qW8GxnZrcPheliR0RElCCGmhIz41vEVHuoargLHHfXTQZLOuyrxO/tBQUFNevXr29khliL0AeYJcpMcxfHSZhxCG5PCzmvT8Hp/OdlzzGdOMWnqtJEXE7HHgQE+jlCq/d9xicLm1WDAY9zwKFDh15GsAf6ewgr/124cOEn8oYH3TZSJYJ3YK+gQ3bIIte8efPU2GGHzCWuqanpBD/pRWfm8aTIiwRTsURsbiySGzvHjfmwnY6NjU0JCQlpN5r7lbsInmOsk3cDB9iEA6h1dhzgGRzAqZcOD4PpYURITEysxnu2iM3NJ/Do/0A1mIC8SqNDHSEFW9LCbNVocOzYsckIvcQoHg8PD7d/4mAqlogtMNK/we662NzoWyUlJS7n3c4igtO53QRngFWCM2b4tLe3i6d70vFuTJhWI7ZjPcVMLAkjdnh0VyL0+0ax0NfX92vjx493aS3DFXqGFLYVCD9VQou0Y39MxywU2wosFZs826O8vHw3N/uUlLnZzyIjIxfIBzTqABPoIXhXqgIDA9MSEhIcq35mY1kYEUaMGNHh5+f3PW7+nJRF9Orq6tzjx4/7qgNMwIjhL2J2XXVs9vT0fNZKoQVLxRaSkpIafHx8HsOU/0Uggi+4efPmPqblUVLub2pqamRhahqb/SluQ+in09LSTP9OpCeWhpGukBGMZaDajxlrq3GrQ4SXEWGbUX5oCgsLM5m4fIhpn5I3M3BmkVPvM8qWMmBiC8XFxRFtbW3y+cA3bTUqjud5e3uvZcqdRyx36YWDHcJSQktLy6sMxjJDVN+R8ARVkk8vojNdXRXsNwZUbEE+2yXvXoMYr1FUa9HYMkUvwNwSFBS0Ky4uTj5duydcY/i1a9eeRODvcr6sizg+1qEDtzEYroyPj683qgaEARfbDl6eSFj5NULNoegYSyh3IryIXYBosr+AoGq9BOQF7VgOSaPuK7T3/N66CG9ew+xwQMJGTwaN2HZKS0szWltbX0FA+SrK5U8LOK+DjthP/P8gIiJib1hYWK//YTZQDDqx7RAWAhsbG+Xj+ScRMJMtjq2X+HhzO+JeoO0w+zxSy12kdM5+n2Ipg1bsnlRUVMjSbBADn3ym5oOwd/z9/WsoNxKL1TKARqPRaDQajUaj0Wg0Go1Go9FoNBqNRqPRaDQajcZJ3Nz+B+KyFeLVV5d2AAAAAElFTkSuQmCC";
                        createAttachment(o, id, extf, noimage, "", !1, o.appvm[id].tipo() === o.TE.Documento, "", "Sin imagen.png");
                        break;
                    case "view": case "downloadatt": case "fadtestigo":
                        if (o.appvm[id].tipo() === o.TE.Documento)
                            ane = _.find(o.appvm.listAnexos(), { ElementoId: id, GuidAnexo: params[2] })
                        else if (o.appvm[id].tipo() === o.TE.FirmaFAD) {
                            if (params[1] === "view")
                                ane = _.find(o.appvm.listAnexos(), { ElementoId: id, GuidAnexo: o.appvm[id].anexo() ? o.appvm[id].anexo().guidanexo : "" });
                            else {
                                var onlyone = _.filter(o.appvm.listAnexos(), { ElementoId: id });
                                _.forEach(onlyone, function (aa) {
                                    if (aa.FileName.indexOf("_2_") >= 0 || aa.FileName.indexOf("_3_") >= 0)
                                        ane = aa;
                                });
                            }
                        }
                        else
                            ane = _.find(o.appvm.listAnexos(), { ElementoId: id, GuidAnexo: o.appvm[id].anexo() ? o.appvm[id].anexo().guidanexo : "" });
                        if (ane) {
                            showHideLoading(o, !0);
                            if (params[1] === "view" || params[1] === "fadtestigo") {
                                cammo = $('<div class="modal" style="display:block">\
                                    <div class="modal-dialog modal-lg modal-dialog-centered">\
                                        <div id="camaramodal" class="modal-content rounded">\
                                            <div class="modal-header p-2 border-bottom border-dark bg-white" style="cursor: move;">\
                                                <h5 class="modal-title text-dark">' + o.appvm[id].titulo() + '</h5>\
                                                <span id="camaraclose" title="Cerrar" class="btn btn-sm btn-outline-danger btn-lg border"><i style="font-size:16px" class="fas fa-times"></i></span>\
                                            </div>\
                                            <div class="modal-body p-2" style="height:100%">\
                                                <div class="col-12 col-sm-12 p-0" style="max-height:100%;">\
                                                <div class="rounded bg-gray contenttopreview"></div>\
                                                <div class="rounded border align-items-center justify-content-center text-muted bg-gray noview" style="height:50vh; font-size:2rem;display:flex;opacity:0.5">Vista previa no disponible</div>\
                                            </div>\
                                            </div>\
                                        </div>\
                                    </div>\
                                </div>');
                                cammo.find("#camaraclose").on("click", function () { cammo.remove(); });
                                $("body").append(cammo);
                            }
                            $.ajax({
                                url: o.datasend.urlGlobal + 'FECapturador.aspx/InvokeMethodWcf', type: "POST", contentType: "application/json; charset=utf-8",
                                data: JSON.stringify({ method: "ConsultaAnexo", consulta: JSON.stringify(ane), proyid: o.datasend.proyid }),
                                beforeSend: function () { },
                                success: function (j) {
                                    j = j.d;
                                    if (j.Success) {
                                        var json = JSON.parse(j.ReturnedObject),
                                            ane2 = o.appvm[id].tipo() === o.TE.Documento ? _.find(o.appvm.listAnexos(), { ElementoId: id, GuidAnexo: params[2] }) :
                                                (o.appvm[id].tipo() === o.TE.FirmaFAD && params[1] === "fadtestigo") ? ane : _.find(o.appvm.listAnexos(), { ElementoId: id, Reemplazado: !1 });
                                        if (o.appvm[id].tipo() === o.TE.Georeferencia) updateAnexo(o, ane2, !1, json.datos);
                                        else if (o.appvm[id].tipo() === o.TE.FirmaFAD) { if (params[1] === "view") updateAnexo(o, ane2, !1, json.thumb); }
                                        else updateAnexo(o, ane2, !1, json.thumb);
                                        if (params[1] === "view" || params[1] === "fadtestigo") {
                                            cammo.find(".noview").hide();
                                            switch (o.appvm[id].tipo()) {
                                                case o.TE.Imagen:
                                                    cammo.find("div.contenttopreview").append('<div style="max-height:75vh; overflow:auto"><img src="data:image/png;base64,' + json.datos + '" class="col-12 col-sm-12 p-0"/></div>');
                                                    break;
                                                case o.TE.FirmaFAD:
                                                    if (params[1] === "view")
                                                        cammo.find("div.contenttopreview").append('<div style="max-height:75vh; overflow:auto"><img src="data:image/png;base64,' + json.datos + '" class="col-12 col-sm-12 p-0"/></div>');
                                                    else if (params[1] === "fadtestigo") {
                                                        if (ane2.FileName.indexOf("_2_") >= 0) // video
                                                            cammo.find("div.contenttopreview").append('<div style="max-height:75vh; overflow:auto"><video class="p-0 w-100" src="data:video/mp4;base64,' + json.datos + '" controls playsinline><source type="video/mp4"></source></video></div>');
                                                        if (ane2.FileName.indexOf("_3_") >= 0) // foto
                                                            cammo.find("div.contenttopreview").append('<div style="max-height:75vh; overflow:auto"><img src="data:image/png;base64,' + json.datos + '" class="col-12 col-sm-12 p-0"/></div>');
                                                    }
                                                    break;
                                                case o.TE.Audio:
                                                    cammo.find("div.contenttopreview").append('<audio controls class="col-12 col-sm-12 p-0">\
                                                        <source src="data:audio/mp3;base64,' + json.datos + '" type="audio/mpeg">\
                                                    El navegador no soporta la extensi&oacute;n del audio, solo se puede reproducir mp3.</audio>');
                                                    break;
                                                case o.TE.Video:
                                                    cammo.find("div.contenttopreview").append('<div style="max-height:75vh; overflow:auto"><video controls playsinline class="col-12 col-sm-12 p-0">\
                                                        <source src="data:video/mp4;base64,' + json.datos + '" type="video/mp4">\
                                                    El navegador no soporta la extensi&oacute;n del video, solo se puede reproducir mp4.</video></div>');
                                                    break;
                                                case o.TE.Documento: case o.TE.PDFOCR:
                                                    if (_.includes(['png', 'gif', 'jpg', 'bmp', '.png', '.gif', '.jpg', '.bmp', 'jpeg', '.jpeg'], ane2.Extension.toLowerCase()))
                                                        cammo.find("div.contenttopreview").append('<div style="max-height:75vh; overflow:auto"><img src="data:image/png;base64,' + json.datos + '" class="col-12 col-sm-12 p-0"/></div>');
                                                    else if (_.includes(['pdf', '.pdf'], ane2.Extension.toLowerCase())) {
                                                        var byteCharacters = window.atob(json.datos), byteArrays = [], sliceSize = 512;
                                                        for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                                                            var slice = byteCharacters.slice(offset, offset + sliceSize), byteNumbers = new Array(slice.length);
                                                            for (var i = 0; i < slice.length; i++) byteNumbers[i] = slice.charCodeAt(i);
                                                            var byteArray = new Uint8Array(byteNumbers);
                                                            byteArrays.push(byteArray);
                                                        }

                                                        cammo.find("div.contenttopreview").append("<object style='min-height:80vh' class='w-100' type='application/pdf' data='" + window.URL.createObjectURL(new Blob(byteArrays, { type: "application/pdf" })) + "' download='" + ane.NombreOriginal + "'><embed type='application/pdf' data='" + window.URL.createObjectURL(new Blob(byteArrays, { type: "application/pdf" })) + "'/></object>");
                                                    }
                                                    break;
                                            }
                                        }
                                    } else toasty('', j.Mensaje, 'error');
                                    showHideLoading(o, !1);
                                },
                                error: function () { showHideLoading(o, !1); }
                            });
                        }
                        break;
                    case "delete":
                        if (o.appvm[id].tipo() === o.TE.Documento) {
                            if (_.isEmpty(params[3])) {//conseguir primer anexo del elemento
                                ane = _.filter(o.appvm.listAnexos(), { ElementoId: id });
                                ane = ane.length ? [ane[0]] : [];
                                ane.length && (params[3] = ane[0].GuidAnexo)
                            }
                            else ane = _.filter(o.appvm.listAnexos(), { ElementoId: id, GuidAnexo: params[3] });
                        }
                        else if (o.appvm[id].tipo() === o.TE.HuellaDigital || o.appvm[id].tipo() === o.TE.FirmaFAD)
                            ane = _.filter(o.appvm.listAnexos(), function (elmanex) { return elmanex.ElementoId === id; });
                        else ane = _.filter(o.appvm.listAnexos(), function (elmanex) { return elmanex.ElementoId === id && elmanex.GuidAnexo === o.appvm[id].anexo().guidanexo; });
                        if (ane.length)
                            showElementLoading(o, !0, id, "Eliminando archivo"), $.ajax({
                                url: o.datasend.urlGlobal + 'FECapturador.aspx/InvokeMethodWcf', type: "POST", contentType: "application/json; charset=utf-8",
                                data: JSON.stringify({ method: "BorraAnexo", consulta: JSON.stringify({ guid: o.datasend.guid, anexos: ane, proyid: o.datasend.proyid }), proyid: o.datasend.proyid }),
                                beforeSend: function () { },
                                success: function (j) {
                                    j = j.d;
                                    if (j.Success) {
                                        for (var i = 0; i < o.appvm.listAnexos().length; i++)
                                            for (var y = 0; y < ane.length; y++)
                                                if (o.appvm.listAnexos()[i].GuidAnexo === ane[y].GuidAnexo) o.appvm.listAnexos.splice(i, 1);
                                        if (o.appvm[id].tipo() === o.TE.Documento) {
                                            o.appvm[id].ondelete(!0);
                                            var olddata = _.filter(o.appvm[id].anexo(), function (el) { return el.guidanexo !== params[3]; });
                                            o.appvm[id].anexo([]), o.appvm[id].anexo(olddata), delete o.appvm[id].tipodocjson()[params[3]],
                                                o.appvm[id].tipodoc(JSON.stringify(o.appvm[id].tipodocjson())), delete o.appvm[id].metadatostipodocjson()[params[3]],
                                                o.appvm[id].metadatostipodoc(JSON.stringify(o.appvm[id].metadatostipodocjson()));
                                            o.appvm[id].ondelete(!1);
                                        }
                                        else o.appvm[id].nombrearchivo(""), o.appvm[id].anexo({}), o.appvm[id].tipo() === o.TE.Georeferencia && o.appvm[id].valor("");
                                        if (o.appvm[id].tipo() === o.TE.HuellaDigital)
                                            o.appvm[id].cantidadhuellas(_.filter(o.appvm.listAnexos(), { ElementoId: id }).length);
                                        if (o.appvm[id].tipo() === o.TE.FirmaFAD) {
                                            o.appvm[id].nombrefirmante(""), o.appvm[id].fecha(""), o.appvm[id].dispositivo("");
                                            o.appvm[id].hash(""), o.appvm[id].georeferencia(""), o.appvm[id].guidtimestamp("");
                                        }
                                        if (params[2] && typeof params[2] === "function") params[2]();//callback
                                        o.appvm[id].tipo() === o.TE.Documento && !!o.documentCheck && !!o.documentCheck[id] && o.appvm[o.documentCheck[id]] && o.appvm[o.documentCheck[id]].catalogodestino().length > 0 &&
                                            updateDocumentCheck(o, id, o.documentCheck[id]);
                                        toasty('', 'Anexo borrado exitosamente.', 'exito');
                                    }
                                    else toasty('', j.Mensaje, 'error');
                                }
                            }).done(function () { showElementLoading(o, !1, id); });
                        else {
                            if (params[2] && typeof params[2] === "function") params[2]();//callback
                            //Permite llamar al subscribeTemporalOnFinishLoad
                            (showElementLoading(o, !0, id), showElementLoading(o, !1, id));
                        }
                        strfunc = "removeanexo" + id;
                        o[strfunc] = !0, evaluateConditions(o, id), o[strfunc] = !1;
                        break;
                    case "replace": case "replacecam": case "replaceimp":
                        var aner;
                        if (params[1] === "replacecam") {
                            aner = _.find(o.appvm.listAnexos(), function (ane) { return ane.GuidAnexo === params[2].guidanexo; });
                            customActionElement(id, [o.appvm[id].tipo(), "camera", "reemp", aner]);
                        }
                        else if (params[1] === "replaceimp") {
                            aner = _.find(o.appvm.listAnexos(), function (ane) { return ane.GuidAnexo === params[2].guidanexo; });
                            customActionElement(id, [o.appvm[id].tipo(), "import", "reemp", aner]);
                        }
                        else if (params[1] === "replace") {
                            aner = _.find(o.appvm.listAnexos(), function (ane) { return ane.GuidAnexo === o.appvm[id].anexo().guidanexo; });
                            aner && (aner.Reemplazado = !0, o.appvm[id].anteriornombrearchivo(aner.GuidAnexo), o.appvm[id].nombrearchivo(""), o.appvm[id].anexo({}));
                        }
                        strfunc = "replaceanexo" + id, o[strfunc] = !0, evaluateConditions(o, id), o[strfunc] = !1;
                        break;
                    case "cancelreplace":
                        if (o.appvm[id].tipo() === o.TE.Documento) {
                            var anexc = _.find(o.appvm[id].anexo(), { guidanexo: params[2] });
                            if (anexc) {
                                var prevanex = _.find(o.appvm.listAnexos(), { DocID: anexc.docidanexo });
                                if (prevanex) {
                                    o.appvm[id].tipodocjson()[prevanex.GuidAnexo] = o.appvm[id].tipodocjson()[anexc.guidanexo];
                                    delete o.appvm[id].tipodocjson()[anexc.guidanexo];
                                    o.appvm[id].tipodoc(JSON.stringify(o.appvm[id].tipodocjson()));
                                    o.appvm[id].metadatostipodocjson()[prevanex.GuidAnexo] = o.appvm[id].metadatostipodoc()[anexc.guidanexo];
                                    delete o.appvm[id].metadatostipodocjson()[anexc.guidanexo];
                                    o.appvm[id].metadatostipodoc(JSON.stringify(o.appvm[id].metadatostipodocjson()));
                                    customActionElement(id, [o.appvm[id].tipo(), "delete", function () { uploadAnexoAndSaveBorrador(o, id, !0); }, params[2]]);
                                }
                            }
                        }
                        else {
                            var cancelreplace = function () { o.appvm[id].anteriornombrearchivo(""), uploadAnexoAndSaveBorrador(o, id, !0); };
                            !_.isEmpty(o.appvm[id].anexo()) ? customActionElement(id, [o.appvm[id].tipo(), "delete", cancelreplace]) : cancelreplace();
                        }
                        break;
                    case "historico":
                        if (o.appvm[id].tipo() === o.TE.Documento)
                            ane = _.find(o.appvm.listAnexos(), { ElementoId: id, GuidAnexo: params[2] })
                        else
                            ane = _.find(o.appvm.listAnexos(), { ElementoId: id, GuidAnexo: o.appvm[id].anexo() ? o.appvm[id].anexo().guidanexo : "" });
                        if (ane) {
                            showElementLoading(o, !0, id, "Obteniendo historico de anexos");
                            var clonedata = _.cloneDeep(o.datasend);
                            clonedata["xml"] && delete clonedata["xml"];
                            clonedata["estadistica"] && delete clonedata["estadistica"];
                            clonedata["prevData"] && delete clonedata["prevData"];
                            $.ajax({
                                url: o.datasend.urlGlobal + "FECapturador.aspx/EjecutaServicio",
                                data: JSON.stringify({
                                    json: JSON.stringify({
                                        initialmethod: "ServiciosDigipro.ServicioFEExtern.HistoricoAnexo",
                                        assemblypath: "..\\..\\wcfservicios\\bin\\ServiciosDigipro.dll",
                                        data: { docidanexo: ane.DocID, showlog: true }
                                    }),
                                    datasend: JSON.stringify(clonedata)
                                })
                            }).done((j) => {
                                j = j.d;
                                console.log(j.data.log);
                                if (j.response.success && j.response.servicesuccess && j.data.Historico.length > 0) {
                                    var hist = $("#" + id + " .historicoanexos").empty();
                                    hist.append("<h6>Anexos reemplazados</h6>");
                                    var htmltable = '';
                                    j.data.Historico.forEach((it) => {
                                        htmltable += `<tr><td>${it.Descripcion}</td><td><i class="fas fa-eye" style="cursor: pointer;" data-docid="${it.DocID}" data-expid="${it.ExpID}" data-ext="${it.Extension}"></i></td></tr>`;
                                    });
                                    hist.append(`<table class="table table-striped table-bordered table-sm">${htmltable}</table>`);
                                    hist.find("table i").on("click", function () { viewAnexoHistorico(id, $(this).data().docid, $(this).data().expid, $(this).data().ext); });
                                } else toasty(j.response.servicemessage, "", "error");
                            }).always(() => { showElementLoading(o, !1, id); });
                        }
                        break;
                    case "ocrrecognizer": ocrRecognizerAnalyze(o, id); break;
                    case "ocrresults": ocrRecognizerShowResults(o, id); break;
                    case "gpsmap":
                        var mapsuccess = function () {
                            o = getOpts(), o.appvm[id].valor(o.coordenadas.lat + "," + o.coordenadas.lon);
                            //en caso de tener anexo se borra ya que solo puede tener un anexo
                            //customActionElement(id, [o.appvm[id].tipo(), "delete"]);
                            if (o.appvm[id].pedirmapa && o.appvm[id].pedirmapa() === !0) {
                                $("#map" + id).removeAttr("hidden").css({ "height": 300, "width": $("#map" + id).parent().outerWidth() - 10 });
                                var mapgeolo = new ol.Map({
                                    target: "map" + id, layers: [new ol.layer.Tile({ source: new ol.source.OSM() })],
                                    view: new ol.View({ center: ol.proj.fromLonLat([o.coordenadas.lon, o.coordenadas.lat]), zoom: 17 })
                                });
                                var marker = new ol.Feature({ geometry: new ol.geom.Point(ol.proj.fromLonLat([o.coordenadas.lon, o.coordenadas.lat])) });
                                marker.setStyle(new ol.style.Style({
                                    image: new ol.style.Circle({
                                        radius: 5, fill: new ol.style.Fill({ color: 'rgba(0,0,0,1)' }),
                                        stroke: new ol.style.Stroke({ color: 'rgba(0,0,0,1)', width: 14 })
                                    })
                                })), mapgeolo.addLayer(new ol.layer.Vector({
                                    source: new ol.source.Vector({ features: [marker] })
                                })), mapgeolo.once('rendercomplete', function (event) {
                                    var dataURL;
                                    var mapCanvas = document.createElement('canvas');
                                    var size = mapgeolo.getSize();
                                    mapCanvas.width = size[0];
                                    mapCanvas.height = size[1];
                                    var mapContext = mapCanvas.getContext('2d');
                                    Array.prototype.forEach.call(
                                        document.querySelectorAll("#map" + id + ' .ol-layer canvas'),
                                        function (canvas) {
                                            if (canvas.width > 0) {
                                                var opacity = canvas.parentNode.style.opacity;
                                                mapContext.globalAlpha = opacity === '' ? 1 : Number(opacity);
                                                var transform = canvas.style.transform;
                                                // Get the transform parameters from the style's transform matrix
                                                var matrix = transform
                                                    .match(/^matrix\(([^(]*)\)$/)[1]
                                                    .split(',')
                                                    .map(Number);
                                                // Apply the transform to the export map context
                                                CanvasRenderingContext2D.prototype.setTransform.apply(
                                                    mapContext,
                                                    matrix
                                                );
                                                mapContext.drawImage(canvas, 0, 0);
                                            }
                                        }
                                    );
                                    dataURL = mapCanvas.toDataURL('image/png');
                                    $("#map" + id).attr("hidden", ""), createAttachment(o, id, "png", dataURL);
                                }), mapgeolo.renderSync();
                            }
                            updateOpts(o, !0), o.coordenadas.get = !1;
                        };
                        o.coordenadas.get === !0 ? mapsuccess() : (o.appvm[id].valor(""), o.appvm[id].valormetadato(""), obtenerCoordenadas(o, function () { mapsuccess(); }));
                        break;
                    case "backward":
                        if (!o.appvm[id].navegacion()) !!o.appvm[id].paginaregresar() && (pag = o.appvm[id].paginaregresar(), o.appvm[id].valinit(1));
                        else {
                            var actPage = "";
                            for (let i = 0; i < o.jobj.elemento.elementos.elemento.length; i++) {
                                let pageid = o.jobj.elemento.elementos.elemento[i]["@idelemento"];
                                if (o.appvm[pageid].tipo() === o.TE.Pagina && o.appvm[pageid].activo()) {
                                    actPage = pageid;
                                    break;
                                }
                            }
                            var lstNav = o.appvm[id].navegacion().toString().split(",");
                            var indexNav = _.indexOf(lstNav, actPage);
                            pag = lstNav[indexNav === 0 ? 0 : indexNav - 1];
                        }
                        addEstadisticaReporteEstadistico(o, id, "Regresar a Página" + o.appvm[pag].titulo());
                        o.appvm[id]["is" + params[1]](!0), evaluateConditions(o, id), o.appvm[id]["is" + params[1]](!1);
                        o.appvm[pag] && (o.appvm[pag].visible(!0), showPage(pag));
                        break;
                    case "forward":
                        var validated = !0;
                        if (o.appvm[id].validacion() === !0 && o.appvm[id].elementoavalidar && !_.isEmpty(o.appvm[id].elementoavalidar()))
                            validated = validateCustomElements(o, o.appvm[id].elementoavalidar());
                        if (validated) {//si es valido, se ejecutan reglas y se avanza avanzar
                            !!o.appvm[id].paginaavanzar() && (pag = o.appvm[id].paginaavanzar(), o.appvm[id].valinit(2));
                            addEstadisticaReporteEstadistico(o, id, "Avanzar a Página" + (o.appvm[pag] && o.appvm[pag].titulo()));
                            o.appvm[id]["is" + params[1]](!0), evaluateConditions(o, id), o.appvm[id]["is" + params[1]](!1);
                            o.appvm[pag] && (o.appvm[pag].visible(!0), showPage(pag));
                        }
                        break;
                    case "finish":
                        o.appvm[id].clicked(!0);
                        switch (o.appvm[id].tipoguardado()) {
                            case "publicacion": case "metadatos": case "borrador": case "modoboton": case "remplazametadatosehijos":
                                o.wizardtopublish = id;
                                var functlink = nextPageIsFormat(o, id);
                                if (typeof functlink !== !1) o.urlprefillpostguardar[id] = functlink;

                                var antesfinalizar = () => {
                                    addEstadisticaReporteEstadistico(o, id, `Finalizar con modo de guardado: ${o.appvm[id].tipoguardado()}${(_.isEmpty(o.appvm[id].tareafinalizar()) ? "" : (" con la Tarea a publicar: " + o.appvm[id].tareafinalizar()))}`);
                                    o.appvm[id]["isbefore" + params[1]](!0), evaluateConditions(o, id), o.appvm[id]["isbefore" + params[1]](!1);
                                    if (o.appvm[id].tipoguardado() === "modoboton")
                                        o.cancelsave = !0, goPublish(2), o.postGuardar(o.appvm[id].tipoguardado(), o.datasend, id, o);
                                    else {
                                        o.savingInterval && clearInterval(o.savingInterval);
                                        goPublish(2);
                                    }
                                };
                                if (o.appvm[id].validacion() === !0 && o.appvm[id].elementoavalidar && !_.isEmpty(o.appvm[id].elementoavalidar())) {
                                    //validacion por un solo elemento
                                    if (validateCustomElements(o, o.appvm[id].elementoavalidar()) === !0)
                                        antesfinalizar();
                                    else
                                        o.allvalid = !1, o.needValidate = !1, o.tabToValidate = 0, o.cancelvalidate = !1, o.cancelsave = !1, updateOpts(o, !0);
                                } else antesfinalizar();
                                break;
                            case "nada":
                                o.savingInterval && clearInterval(o.savingInterval);
                                o.postGuardar(o.appvm[id].tipoguardado(), o.datasend, id, o);
                                break;
                            case "borradorSinSalir": autoSaveForm(); break;
                        }
                        break;
                    case "setMetadata":
                        o.appvm[id].tipo() === o.TE.Documento && (ane = _.find(o.appvm.listAnexos(), { ElementoId: id, GuidAnexo: params[2] }));
                        if (ane) {
                            if (o.appvm[id].tipodocjson()[ane.GuidAnexo]) {
                                var metadataorig = _.filter(o.datatags.metadatoshijos, { TipoDoc: Number(o.appvm[id].tipodocjson()[ane.GuidAnexo]) }),
                                    metadatabase = !o.appvm[id].metadatostipodocjson()[ane.GuidAnexo] ? {} : o.appvm[id].metadatostipodocjson()[ane.GuidAnexo],
                                    changedobj = {};
                                if (metadataorig.length > 0) {
                                    var metamodal = $('<div class="modal" style="display:block">\
                                        <div class="modal-dialog modal-sm modal-dialog-centered">\
                                            <div class="modal-content rounded">\
                                                <div class="modal-header p-1 border-bottom border-dark bg-white align-items-center">\
                                                    <h5 class="modal-title text-dark" style="font-size:1rem; margin: auto;">Metadatos</h5>\
                                                    <span title="Cerrar" class="btn btn-sm text-red border btncancel"><i style="font-size:1rem" class="fas fa-times"></i></span>\
                                                </div>\
                                                <div class="modal-body p-2">\
                                                    <div class="col-12 col-sm-12 p-0" style="overflow: auto;max-height:70vh">\
                                                        <table class="table table-bordered table-striped table-condensed"><thead><tr><th>Metadato</th><th>Valor</th></tr></thead></table>' +
                                        (ane.DocID === 0 ? "<div class='btn btn-sm btn-success mr-2 btnsave float-right'>Guardar</div>" : '') +
                                        '</div>\
                                                </div>\
                                            </div>\
                                        </div>\
                                    </div>');
                                    var setinputfieldbymeta = function (meta, origval, disabled) {
                                        changedobj[meta.Nombre] = origval;
                                        var inputmeta = $("<tr><td class='position-relative'>" + (meta.Obligatorio ? "<i class='fas fa-asterisk text-red position-absolute' style='font-size:0.5em;top:calc(25%);right:calc(10%);'></i>" : "") + meta.NombreCampo + "</td><td><div class='fieldorig'></div></td></tr>");
                                        switch (meta.TipoDatoId) {
                                            case 1: case 9: case 10: case 13: case 7: case 8: //7,8 varchar // 1, 9, 10: int, 13: number
                                                var inputnumber = $("<input " + (disabled || !meta.EsEditable ? "disabled" : "") + ' class="form-control input-sm" placeholder="' + meta.Mascara + '" ' + (_.includes([1, 9, 10, 13], meta.TipoDatoId) ? ' type="number"' : "") + '>');
                                                !origval || inputnumber.val(origval);
                                                inputnumber.on("change", function (e) {
                                                    if (meta.EsEditable) {
                                                        var rgx, mreg = meta.Expresion_Regular === "*" ? "\\w" : meta.Expresion_Regular;
                                                        try { rgx = new RegExp(mreg); }
                                                        catch (ex) {
                                                            toasty('', 'La expresi&oacute;n regular del campo ' + meta.NombreCampo + ' no es legible. Por lo tanto, no se validar&aacute;.');
                                                        }
                                                        if (e.target.value.length < meta.Longitud_Minima || e.target.value.length > meta.Longitud_Maxima)
                                                            toasty('', 'La longitud m&aacute;xima del campo ' + meta.NombreCampo + ' es de ' + meta.Longitud_Maxima + ' car&aacute;cteres y la longitud m&iacute;nima es de ' + meta.Longitud_Minima + ' car&aacute;cteres.'), e.target.value = changedobj[meta.Nombre];
                                                        else if (!!rgx && !e.target.value.match(rgx))
                                                            toasty('', 'El campo ' + meta.NombreCampo + ' no cumple con la expresi&oacute;n regular ' + meta.Expresion_Regular + '.'), e.target.value = changedobj[meta.Nombre];
                                                        else changedobj[meta.Nombre] = e.target.value;
                                                    }
                                                });
                                                inputmeta.find(".fieldorig").append(inputnumber);
                                                break;
                                            case 2: case 3: case 4: case 5: case 6: //2, 3: dateddmmaaaaDiag // 4: dateaaammddDiag // 5: dateddmmaaaaGuion // 6: dateaaammddGuion
                                                var dateformat = _.includes([2, 3], meta.TipoDatoId) ? "d/m/Y" : meta.TipoDatoId === 4 ? "Y/m/d" : meta.TipoDatoId === 5 ? "d-m-Y" : "Y-m-d";
                                                inputmeta.find(".fieldorig").append("<input class='form-control input-sm' placeholder=" + meta.Mascara + ">");
                                                inputmeta.find("input").flatpickr({ dateFormat: dateformat, defaultDate: origval, onChange: function (sd, ds) { meta.EsEditable && (changedobj[meta.Nombre] = ds); }, disableMobile: true });
                                                (disabled || !meta.EsEditable) && inputmeta.find("input").attr("disabled", "");
                                                break;
                                            case 11: //bool
                                                var inputbool = $("<input " + (disabled || !meta.EsEditable ? "disabled" : "") + " type='checkbox' " + (origval ? "checked" : "") + ">");
                                                inputbool.on("change", function (e) { meta.EsEditable && (changedobj[meta.Nombre] = e.target.checked); });
                                                inputmeta.find(".fieldorig").append(inputbool);
                                                break;
                                            case 12: //cat
                                                var getcat = meta.Accion.match(/[[0-9]+$/g);
                                                if (getcat) {
                                                    var catid = getcat[0];
                                                    getcat = "catalogos|" + getcat[0];
                                                    var updatefield = function () {
                                                        inputmeta.find(".fieldorig").css({ width: '100%' }).combobox({
                                                            data: o.datatags.allitemscatalogs[getcat], prompt: 'Seleccione...', value: changedobj[meta.Nombre], panelMaxHeight: 150,
                                                            valueField: 'Valor', textField: 'Nombre', idField: 'Valor', disabled: !meta.EsEditable, limitToList: !0,
                                                            onSelect: function (rec) { changedobj[meta.Nombre] = rec.Valor; changedobj[meta.Nombre + "_Desc"] = rec.Nombre; },
                                                            onUnselect: function (rec) { changedobj[meta.Nombre] = ""; }
                                                        });
                                                    };
                                                    if (!o.datatags.allitemscatalogs[getcat]) {
                                                        $.ajax({
                                                            url: o.datasend.urlGlobal + "FEConfigurador.aspx/ObtieneItemCat",
                                                            data: JSON.stringify({ fd: "Catalogos", proyid: o.datasend.proyid, catId: catid, expid: o.datasend.expId }),
                                                            success: function (j) {
                                                                j = j.d;
                                                                if (j.Success) {
                                                                    o = getOpts(), console.log("Se obtuvo el catalogo:" + catid);
                                                                    o.datatags.allitemscatalogs[getcat] = j.ReturnedObject, updatefield();
                                                                } else Error(j.Titulo, j.Mensaje);
                                                            },
                                                            error: function (e) { errorFormElec(o, e); }
                                                        });
                                                    }
                                                    else updatefield();
                                                }
                                                break;
                                        }
                                        return inputmeta;
                                    };
                                    var requiredMetaIsValid = function () {
                                        var result = true, reqdata = _.map(_.filter(metadataorig, { Obligatorio: !0 }), 'Nombre');
                                        _.forEach(reqdata, function (reqelem) { result = result && !!o.appvm[id].metadatostipodocjson()[ane.GuidAnexo][reqelem]; });
                                        _.forEach(o.appvm[id].anexo(), function (anex) { anex.guidanexo === ane.GuidAnexo && (anex.metadataisrequired = !result); });
                                        return result;
                                    };
                                    var closedata = function (cancelifinvalid) {
                                        o.appvm[id].metadatostipodocjson()[ane.GuidAnexo] = metadatabase, o.appvm[id].metadatostipodoc(JSON.stringify(o.appvm[id].metadatostipodocjson()));
                                        !requiredMetaIsValid() && cancelifinvalid ? toasty('', 'Verifique los campos obligatorios', 'error') : (metamodal.remove(), $('.flatpickr-calendar animate').remove());
                                        //accion para refrescado de metadatos en el documento
                                        o.appvm[id].updatemetadata(!0);
                                    };
                                    metamodal.find("table tbody").children().remove(), _.forEach(metadataorig, function (keyme) {
                                        metamodal.find("table").append(setinputfieldbymeta(keyme, metadatabase[keyme.Nombre], ane.DocID > 0));
                                    });
                                    metamodal.find(".btnsave").on("click", function () { metadatabase = _.clone(changedobj), closedata(!0); });
                                    metamodal.find(".btncancel").on("click", function () { closedata(); });
                                    $('body').append(metamodal);
                                }
                                else toasty('', 'No existen metadatos asociados a este tipo de documento.');
                            }
                            else toasty('', 'Es necesario seleccionar un tipo de documento para mapear los metadatos.');
                        }
                        break;
                    case "Veridas":
                        var funcexe, destroyfunc, challenge = "", doctype = "", loadSDKScript = (src, onloadMSG, errorMSG) => {
                            let script = document.createElement('script');
                            script.setAttribute('src', src);
                            script.setAttribute('type', 'application/javascript');
                            if (onloadMSG) script.addEventListener('load', () => { onloadMSG(); });
                            if (errorMSG) script.addEventListener('error', () => { errorMSG() });
                            document.head.appendChild(script);
                        }, dynamicurl = window.location.pathname.substring(0, window.location.pathname.lastIndexOf("/")),
                            cammo = $(`<div class="modal" style="display:block;overflow:auto">
                                <div class="modal-dialog modal-dialog-centered modal-lg">
                                    <div id="ocrModal" class="modal-content rounded" style="background-color:#6c757d; box-shadow: none;">
                                        <div style="position:absolute; right: 0; z-index: 10000">
                                            <span id="ocrModalClose" title="Cancelar" class="btn btn-sm btn-outline-light btn-lg">
                                                <i style="font-size:16px" class="fas fa-times"></i>
                                            </span>
                                        </div>
                                        <div id="documentCaptureVeridas" style="height:75vh;"></div>
                                    </div>
                                </div>
                            </div>`), appendModal = () => {
                                $("body").append(cammo);
                                $("#ocrModalClose").on("click", () => { !!destroyfunc && destroyfunc(); });
                                try { !!funcexe && funcexe(); }
                                catch (ex) { console.error(ex.message); }
                            },
                            getToken = (o, id, callback) => {
                                showElementLoading(o, !0, id, "Generando token"),
                                    o.appvm[id].imagenanverso() && showElementLoading(o, !0, o.appvm[id].imagenanverso(), "Esperando Validación"),
                                    o.appvm[id].imagenreverso() && showElementLoading(o, !0, o.appvm[id].imagenreverso(), "Esperando Validación"),
                                    o.appvm[id].imagenselfie() && showElementLoading(o, !0, o.appvm[id].imagenselfie(), "Esperando Validación");
                                var clonedata = _.clone(o.datasend);
                                clonedata["xml"] && delete clonedata["xml"];
                                clonedata["estadistica"] && delete clonedata["estadistica"];
                                clonedata["prevData"] && delete clonedata["prevData"];
                                $.ajax({
                                    url: o.datasend.urlGlobal + "FECapturador.aspx/EjecutaServicio",
                                    data: JSON.stringify({
                                        json: JSON.stringify({
                                            initialmethod: "ServiciosDigipro.ServicioVeridas.GetToken",
                                            assemblypath: "..\\..\\wcfservicios\\bin\\ServiciosDigipro.dll",
                                            data: { showlog: !0 }
                                        }),
                                        datasend: JSON.stringify(clonedata)
                                    })
                                }).done((j) => {
                                    j = j.d;
                                    console.log(j.data.log);
                                    if (j.response.success && j.response.servicesuccess)
                                        o.appvm[o.appvm[id].tokenshared()].valor(j.data.tokenid);
                                    else toasty("Error al generar el token", j.response.servicemessage, "error");
                                }).always((j) => {
                                    j = j.d, showElementLoading(o, !1, id),
                                        o.appvm[id].imagenanverso() && showElementLoading(o, !1, o.appvm[id].imagenanverso()),
                                        o.appvm[id].imagenreverso() && showElementLoading(o, !1, o.appvm[id].imagenreverso()),
                                        o.appvm[id].imagenselfie() && showElementLoading(o, !1, o.appvm[id].imagenselfie());
                                    (j.response.success && j.response.servicesuccess && callback && callback());
                                });
                            }, uploadDocuments = (o, id, doctype, callback) => {
                                showElementLoading(o, !0, id, "Analizando imagenes"),
                                    o.appvm[id].imagenanverso() && showElementLoading(o, !0, o.appvm[id].imagenanverso(), "Esperando Validación"),
                                    o.appvm[id].imagenreverso() && showElementLoading(o, !0, o.appvm[id].imagenreverso(), "Esperando Validación");
                                var clonedata = _.clone(o.datasend);
                                clonedata["xml"] && delete clonedata["xml"];
                                clonedata["estadistica"] && delete clonedata["estadistica"];
                                clonedata["prevData"] && delete clonedata["prevData"];
                                $.ajax({
                                    url: o.datasend.urlGlobal + "FECapturador.aspx/EjecutaServicio",
                                    data: JSON.stringify({
                                        json: JSON.stringify({
                                            initialmethod: "ServiciosDigipro.ServicioVeridas.UploadDocuments",
                                            assemblypath: "..\\..\\wcfservicios\\bin\\ServiciosDigipro.dll",
                                            data: {
                                                tokenid: o.appvm[o.appvm[id].tokenshared()].valor(),
                                                doctype: o.veridasdoctype,
                                                base64anverso: o.appvm[o.appvm[id].imagenanverso()].anexo().guidanexo,
                                                base64reverso: o.appvm[o.appvm[id].imagenreverso()].anexo().guidanexo,
                                                jsondata: JSON.stringify({
                                                    FEVersion: o.version,
                                                    OSName: Modernizr.desktop ? (Modernizr.windows ? "windows" : "otro") : (Modernizr.android ? "android" : "otro"),
                                                    proyectoid: o.datasend.proyid,
                                                    sitio: o.datasend.urlGlobal,
                                                    usuario: o.datasend.userName,
                                                    stats_tenant: btoa(pako.deflate(`${o.datasend.urlGlobal}${o.datasend.proyid}`, { to: 'string', raw: true }))
                                                }),
                                                showlog: !0
                                            }
                                        }),
                                        datasend: JSON.stringify(clonedata)
                                    })
                                }).done((j) => {
                                    j = j.d;
                                    console.log(j.data.log);
                                    if (j.response.success && j.response.servicesuccess) { }
                                    else toasty("Error al validar los documentos", j.response.servicemessage, "error");
                                }).always((j) => {
                                    j = j.d, showElementLoading(o, !1, id),
                                        o.appvm[id].imagenanverso() && showElementLoading(o, !1, o.appvm[id].imagenanverso()),
                                        o.appvm[id].imagenreverso() && showElementLoading(o, !1, o.appvm[id].imagenreverso());
                                    (j.response.success && j.response.servicesuccess && callback && callback());
                                });
                            }, getOCR = (o, id, callback) => {
                                showElementLoading(o, !0, id, "Generando OCR"),
                                    o.appvm[id].imagenanverso() && showElementLoading(o, !0, o.appvm[id].imagenanverso(), "Esperando Validación"),
                                    o.appvm[id].imagenreverso() && showElementLoading(o, !0, o.appvm[id].imagenreverso(), "Esperando Validación");
                                var clonedata = _.clone(o.datasend);
                                clonedata["xml"] && delete clonedata["xml"];
                                clonedata["estadistica"] && delete clonedata["estadistica"];
                                clonedata["prevData"] && delete clonedata["prevData"];
                                $.ajax({
                                    url: o.datasend.urlGlobal + "FECapturador.aspx/EjecutaServicio",
                                    data: JSON.stringify({
                                        json: JSON.stringify({
                                            initialmethod: "ServiciosDigipro.ServicioVeridas.Validation",
                                            assemblypath: "..\\..\\wcfservicios\\bin\\ServiciosDigipro.dll",
                                            data: {
                                                tokenid: o.appvm[o.appvm[id].tokenshared()].valor(),
                                                showlog: !0
                                            }
                                        }),
                                        datasend: JSON.stringify(clonedata)
                                    })
                                }).done((j) => {
                                    j = j.d;
                                    console.log(j.data.log);
                                    if (j.response.success && j.response.servicesuccess) {
                                        //futuro reemplazo de imagenes
                                        //futuro obtencion de firma, huella, selfie
                                        var mapp = o.appvm[id].mappingocr();
                                        _.forEach(_.keys(mapp), (v) => {
                                            switch (v) {
                                                //case "PD_BirthDate_Out":
                                                //    break;
                                                //case "DD_ExpirationDate_Out":
                                                //    break;
                                                default:
                                                    mapp[v] && o.appvm[mapp[v]] && (o.appvm[mapp[v]].valor && o.appvm[mapp[v]].valor(j.data[v]));
                                                    break;
                                            }
                                        });
                                        var mapp = o.appvm[id].mappingscore();
                                        _.forEach(_.keys(mapp), (v) => {
                                            mapp[v] && o.appvm[mapp[v]] && (o.appvm[mapp[v]].valor && o.appvm[mapp[v]].valor(j.data[v]));
                                        });
                                        callback && callback();
                                    }
                                    else toasty("Error al generar el OCR", j.response.servicemessage, "error");
                                }).always((j) => {
                                    j = j.d, showElementLoading(o, !1, id),
                                        o.appvm[id].imagenanverso() && showElementLoading(o, !1, o.appvm[id].imagenanverso()),
                                        o.appvm[id].imagenreverso() && showElementLoading(o, !1, o.appvm[id].imagenreverso());
                                    (j.response.success && j.response.servicesuccess && callback && callback());
                                });
                            }, getChallenge = (o, id, callback) => {
                                showElementLoading(o, !0, id, "Obteniendo reto"),
                                    o.appvm[id].imagenselfie() && showElementLoading(o, !0, o.appvm[id].imagenselfie(), "Esperando Validación");
                                var clonedata = _.clone(o.datasend);
                                clonedata["xml"] && delete clonedata["xml"];
                                clonedata["estadistica"] && delete clonedata["estadistica"];
                                clonedata["prevData"] && delete clonedata["prevData"];
                                $.ajax({
                                    url: o.datasend.urlGlobal + "FECapturador.aspx/EjecutaServicio",
                                    data: JSON.stringify({
                                        json: JSON.stringify({
                                            initialmethod: "ServiciosDigipro.ServicioVeridas.GetChallengeSelfie",
                                            assemblypath: "..\\..\\wcfservicios\\bin\\ServiciosDigipro.dll",
                                            data: {
                                                tokenid: o.appvm[o.appvm[id].tokenshared()].valor(),
                                                showlog: !0
                                            }
                                        }),
                                        datasend: JSON.stringify(clonedata)
                                    })
                                }).done((j) => {
                                    j = j.d;
                                    console.log(j.data.log);
                                    if (j.response.success && j.response.servicesuccess)
                                        challenge = j.data.challenge;
                                    else toasty("Error al obtener el reto", j.response.servicemessage, "error");
                                }).always((j) => {
                                    j = j.d, showElementLoading(o, !1, id),
                                        o.appvm[id].imagenselfie() && showElementLoading(o, !1, o.appvm[id].imagenselfie());
                                    (j.response.success && j.response.servicesuccess && callback && callback());
                                });
                            }, uploadSelfie = (o, id, vtt, callback) => {
                                showElementLoading(o, !0, id, "Analizando imagen"),
                                    o.appvm[id].imagenselfie() && showElementLoading(o, !0, o.appvm[id].imagenselfie(), "Esperando Validación"),
                                    o.appvm[id].videoselfie() && showElementLoading(o, !0, o.appvm[id].videoselfie(), "Esperando Validación");
                                var clonedata = _.clone(o.datasend);
                                clonedata["xml"] && delete clonedata["xml"];
                                clonedata["estadistica"] && delete clonedata["estadistica"];
                                clonedata["prevData"] && delete clonedata["prevData"];
                                $.ajax({
                                    url: o.datasend.urlGlobal + "FECapturador.aspx/EjecutaServicio",
                                    data: JSON.stringify({
                                        json: JSON.stringify({
                                            initialmethod: "ServiciosDigipro.ServicioVeridas.UploadSelfie",
                                            assemblypath: "..\\..\\wcfservicios\\bin\\ServiciosDigipro.dll",
                                            data: {
                                                tokenid: o.appvm[o.appvm[id].tokenshared()].valor(),
                                                selfie: o.appvm[o.appvm[id].imagenselfie()].anexo().guidanexo,
                                                video: o.appvm[o.appvm[id].videoselfie()].anexo().guidanexo,
                                                vtt: vtt,
                                                showlog: !0
                                            }
                                        }),
                                        datasend: JSON.stringify(clonedata)
                                    })
                                }).done((j) => {
                                    j = j.d;
                                    console.log(j.data.log);
                                    if (j.response.success && j.response.servicesuccess) { }
                                    else toasty("Error al validar la selfie", j.response.servicemessage, "error");
                                }).always((j) => {
                                    j = j.d, showElementLoading(o, !1, id),
                                        o.appvm[id].imagenselfie() && showElementLoading(o, !1, o.appvm[id].imagenselfie()),
                                        o.appvm[id].videoselfie() && showElementLoading(o, !1, o.appvm[id].videoselfie());
                                    (j.response.success && j.response.servicesuccess && callback && callback());
                                });
                            }, uploadVideo = (o, id, callback) => {
                                showElementLoading(o, !0, id, "Analizando video"),
                                    o.appvm[id].videodocumentosselfie() && showElementLoading(o, !0, o.appvm[id].videodocumentosselfie(), "Esperando Validación");
                                var clonedata = _.clone(o.datasend);
                                clonedata["xml"] && delete clonedata["xml"];
                                clonedata["estadistica"] && delete clonedata["estadistica"];
                                clonedata["prevData"] && delete clonedata["prevData"];
                                $.ajax({
                                    url: o.datasend.urlGlobal + "FECapturador.aspx/EjecutaServicio",
                                    data: JSON.stringify({
                                        json: JSON.stringify({
                                            initialmethod: "ServiciosDigipro.ServicioVeridas.UploadVideo",
                                            assemblypath: "..\\..\\wcfservicios\\bin\\ServiciosDigipro.dll",
                                            data: {
                                                tokenid: o.appvm[o.appvm[id].tokenshared()].valor(),
                                                video: o.appvm[o.appvm[id].videodocumentosselfie()].anexo().guidanexo,
                                                showlog: !0
                                            }
                                        }),
                                        datasend: JSON.stringify(clonedata)
                                    })
                                }).done((j) => {
                                    j = j.d;
                                    console.log(j.data.log);
                                    if (j.response.success && j.response.servicesuccess) { }
                                    else toasty("Error al validar el video", j.response.servicemessage, "error");
                                }).always((j) => {
                                    j = j.d, showElementLoading(o, !1, id),
                                        o.appvm[id].videodocumentosselfie() && showElementLoading(o, !1, o.appvm[id].videodocumentosselfie());
                                    (j.response.success && j.response.servicesuccess && callback && callback());
                                });
                            };
                        switch (o.appvm[id].formasvalidacion()) {
                            case "video": //veri-das video
                                funcexe = () => {
                                    var initVideo = () => {
                                        var vdvideoOpts = {
                                            targetSelector: "#documentCaptureVeridas",
                                            logEventsToConsole: true,
                                            recordingTimeStates: [6000, 6000, 6000],
                                            faceDetectionTime: 5000,
                                            videoRecordingMaxTime: 20000,
                                            faceWarningDelayTime: 5000,
                                            obverseDocumentWarningDelayTime: 5000,
                                            reverseDocumentWarningDelayTime: 5000,
                                            webrtcUnsupportedText: "Navegador no compatible. Debe repetir el proceso: Si está en un iPhone debe emplear el navegador Safari. En el resto de casos puede usar Chrome, Firefox u Opera.",
                                            infoFaceRecording: "Diga su NOMBRE y APELLIDOS",
                                            infoAlertVideoSelfie: "Video Selfie: tenga su documento cerca y siga las instrucciones.",
                                            infoReverseRecording: "Y ahora la parte TRASERA",
                                            //infoFaceRecordingRandomNumber : "",
                                            infoObverseRecording: "Muestre la parte DELANTERA del documento",
                                            setLandscapeDeviceMessage: "Por favor, ponga el dispositivo horizontal",
                                            setPortraitDeviceMessage: "Por favor, ponga el dispositivo vertical",
                                            continueText: "CONTINUAR",
                                            infoUserSliderButtonText: "Empezar",
                                            infoUserVideoTitle: `1. Diga su NOMBRE y APELLIDOS cuando se le solicite 
                                            2. Muestra la parte DELANTERA de su documento
                                            3. Muestra la parte TRASERA de su documento`,
                                            videoErrorNotFound: "Por favor, compruebe que el dispositivo dispone de cámara",
                                            videoErrorUnavailable: "Por favor, compruebe que la cámara del dispositivo no está siendo usada por otro programa",
                                            videoErrorPermission: "Por favor, permita a la página acceso a la cámara",
                                            videoErrorExternalInput: "Por favor, compruebe que no tiene ningún software simulando la cámara",
                                            videoErrorDefault: "Lo sentimos, se ha producido un error iniciando la cámara",
                                            videoErrorConstraint: "Por favor, compruebe que el dispositivo dispone de cámara de resolución mínima 640 x 480",
                                            videoErrorConstraintActionLabel: "Reintentar",
                                            videoErrorUnavailableActionLabel: "Reintentar",
                                            videoErrorExternalInputLabel: "Reintentar",
                                            videoErrorPermissionActionLabel: "Reintentar",
                                            errorBoxTitle: "Ha ocurrido un error",
                                            obverseDocumentErrorBoxSubTitle: "Debe mostrar su documento de identidad por delante acercándose a cámara.",
                                            faceErrorBoxSubTitle: "Ha dejado de mirar la cámara y el proceso se ha detenido. Por favor, empiece de nuevo.",
                                            reverseDocumentErrorBoxSubTitle: "Debe mostrar su documento de identidad por detrás acercándose a cámara.",
                                            resetVideoBoxSubTitle: "No ha mostrado el documento o el documento estaba muy lejos y el proceso se ha detenido. Por favor, empiece de nuevo.",
                                            errorBoxButtonText: "CONTINUAR"
                                        };

                                        var doc = o.appvm[id].paisdocumentos();
                                        vdvideoOpts.documents = [o.veridasdoctype || doc];

                                        const VDVideo = makeVDVideoWidget();
                                        VDVideo(vdvideoOpts);

                                        $("#documentCaptureVeridas").on("VDVideo_standardVideoOutput", (fdet) => {
                                            $("#ocrModalClose")[0] && $("#ocrModalClose").click();
                                            if (o.appvm[o.appvm[id].videodocumentosselfie()]) {
                                                if (o.appvm[o.appvm[id].videodocumentosselfie()].tipo() === o.TE.Video) {
                                                    showElementLoading(o, !0, id, "Guardando video");
                                                    var reader = new FileReader();
                                                    reader.readAsDataURL(fdet.detail.recording.video);
                                                    reader.onloadend = () => {
                                                        //Temporal handler after finish delete video
                                                        subscribeTemporalOnFinishLoad(o, o.appvm[id].videodocumentosselfie(), () => {
                                                            //Temporal handler after finish video
                                                            subscribeTemporalOnFinishLoad(o, o.appvm[id].videodocumentosselfie(), () => {
                                                                if (_.isEmpty(o.appvm[id].tokenshared()))
                                                                    toasty("No se especifico el campo del token", "", "error");
                                                                else {
                                                                    if (_.isEmpty(o.appvm[o.appvm[id].tokenshared()].valor()))
                                                                        toasty("Aun no valida los documentos, no es posible validar video sin empezar por la validacion de documentos", "", "error", 7000);
                                                                    else {
                                                                        //usar el token existente
                                                                        //Se sube el video
                                                                        uploadVideo(o, id, () => {
                                                                            //Ocr y score
                                                                            getOCR(o, id);
                                                                        });
                                                                    }
                                                                }
                                                            });
                                                            //se respalda el video
                                                            createAttachment(o, o.appvm[id].videodocumentosselfie(), "mp4", reader.result, "", false, false);
                                                        });
                                                        //primero se borra (en caso de ser documento revisar mas adelante)
                                                        customActionElement(o.appvm[id].videodocumentosselfie(), [o.appvm[o.appvm[id].videodocumentosselfie()].tipo(), "delete"]);
                                                    };
                                                }
                                                else toasty("No se puede adicionar el video", "El elemento no es de tipo video");
                                            }
                                        });
                                        $("#documentCaptureVeridas").on("VDVideo_detectionTimeout", () => {
                                            $("#ocrModalClose")[0] && $("#ocrModalClose").click();
                                            toasty("Tiempo excedido", "Favor de realizar las validaciones lo mas rápido posible.");
                                        });
                                        $("#documentCaptureVeridas").on("VDVideo_unmounted", function (fdet) {
                                            console.log("desmontado");
                                            _.forEach($("#documentCaptureVeridas video"), (v) => {
                                                v.srcObject.getTracks().forEach((track) => {
                                                    if (track.enabled) track.stop(), track.enabled = false;
                                                });
                                            }), cammo.remove();
                                        });
                                    };
                                    if (!o.vdDocScript) {
                                        loadSDKScript('Scripts/Veridas/VideoCapture/VDVideo.js', () => {
                                            console.log("VDVideo cargado");
                                            loadSDKScript('Scripts/Veridas/VideoCapture/opencv/cv.js', () => {
                                                console.log("cv_video cargado"), o.vdDocScript = !0, updateOpts(o);
                                                if (window.cv) {
                                                    if (window.cv instanceof Promise)
                                                        window.cv.then((target) => { window.cv = target, initVideo(); });
                                                    else initVideo();
                                                } showHideLoading(o, !1), toasty("Error al cargar la libreria", 'No se pudo cargar cv_video');
                                            }, () => { toasty("Error al cargar la libreria", 'No se pudo cargar cv_video'), showHideLoading(o, !1); });
                                        }, () => { toasty("Error al cargar la libreria", 'No se pudo cargar VDVideo'), showHideLoading(o, !1); });
                                    }
                                    else initVideo();
                                }
                                destroyfunc = () => { try { destroyVDVideoWidget(); } catch (ex) { cammo.remove(); } }, appendModal();
                                break;
                            case "documentos": //veri-das document        (opcional configuracion de edad minima), contextual, bajar los recortes, inventar regla que de click al elemento veridas
                                funcexe = () => {
                                    var docuScan = () => {
                                        showHideLoading(o, !1);
                                        var vdDocOpts = {
                                            targetSelector: "#documentCaptureVeridas",
                                            infoUserDocumentBackgroundColorTop: "rgb(0, 40, 56)", //fondo superior
                                            infoUserDocumentTitle: `1. CENTRE su documento en el marco
                                            2. Asegúrese de que su documento NO muestra brillos o sombras.
                                            3. La fotografía se capturará de forma AUTOMÁTICA`, //texto informativo
                                            infoUserDocumentBackgroundColor: "#E4F6F6", //fondo inferior
                                            infoUserDocumentBackgroundColorButton: "#26BAB8", //boton inicial
                                            infoUserSliderButtonText: "Empezar",
                                            infoReviewImageText: "Comprueba que la foto es legible y está bien enfocada",
                                            infoReviewBlurImageText: "Parece que la foto está borrosa. Por favor, repita el proceso",
                                            infoAlertTwoSidedDocument: "Se fotografiará el anverso y reverso",
                                            infoAlertSingleSidedDocument: "Se tomará una foto del anverso",
                                            continueText: "CONTINUAR",
                                            displayErrors: !0,
                                            logEventsToConsole: !0,
                                            docLibHelperPath: dynamicurl + '/Scripts/Veridas/DocumentCapture/docLibHelper',
                                            manualCaptureText: "Haga CLICK AQUÍ para capturar",
                                            manualCaptureTextMobile: "Toque la imagen para capturar",
                                            obverseNotFoundText: "Enfoque la parte DELANTERA",
                                            reverseNotFoundText: "Enfoque la parte TRASERA",
                                            passportNotFoundText: "Encaje la página del pasaporte",
                                            passportMRZError: "Comprueba que las dos líneas de texto inferiores son totalmente visibles",
                                            confirmationColorTick: "#157900",//color de la paloma
                                            tooCloseText: "Demasiado Cerca",
                                            tooFarText: "Demasiado Lejos",
                                            videoErrorUnavailableActionLabel: "Reintentar",
                                            videoErrorUnavailable: "Por favor, compruebe que la cámara del dispositivo no está siendo usada por otro programa",
                                            videoErrorPermissionActionLabel: "Reintentar",
                                            videoErrorPermission: "Por favor, permita a la página acceso a la cámara",
                                            videoErrorNotFoundActionLabel: "Reintentar",
                                            videoErrorNotFound: "Por favor, compruebe que el dispositivo dispone de cámara",
                                            videoErrorDefaultActionLabel: "Reintentar",
                                            videoErrorDefault: "Lo sentimos, se ha producido un error iniciando la cámara",
                                            videoErrorConstraintActionLabel: "Reintentar",
                                            videoErrorConstraint: "Por favor, compruebe que el dispositivo dispone de cámara de resolución mínima 640 x 480.",
                                            permissionRefused: "Se necesita tener acceso a la cámara del dispositivo para la captura y verificación del documento y del usuario",
                                            repeatText: "QUIERO REPETIR"
                                        };

                                        var doc = o.appvm[id].paisdocumentos();
                                        switch (doc) {
                                            case "MX2_ID": vdDocOpts.documents = [doc]; break;
                                            //case "prueba1": vdDocOpts.documentsMinimal = [doc]; break;
                                            //case "prueba2": vdDocOpts.documentsPaper = [doc]; break;
                                            //case "prueba3": vdDocOpts.passport = [doc]; break;
                                            default: vdDocOpts.documents = ["MX2_ID"]; break;
                                        }

                                        const VDDocument = makeVDDocumentWidget();
                                        VDDocument(vdDocOpts);

                                        $("#documentCaptureVeridas").on("VDDocument_obverseDetection", (fdet) => {
                                            if (o.appvm[o.appvm[id].imagenanverso()]) {
                                                if (_.includes([o.TE.Documento, o.TE.Imagen], o.appvm[o.appvm[id].imagenanverso()].tipo())) {
                                                    //Temporal handler after finish delete image
                                                    subscribeTemporalOnFinishLoad(o, o.appvm[id].imagenanverso(), () => {
                                                        //se guarda la imagen anversa
                                                        createAttachment(o, o.appvm[id].imagenanverso(), "jpeg", fdet.detail, "", false, false);
                                                    });
                                                    //primero se borra (en caso de ser documento revisar mas adelante)
                                                    customActionElement(o.appvm[id].imagenanverso(), [o.appvm[o.appvm[id].imagenanverso()].tipo(), "delete"]);
                                                }
                                                else
                                                    toasty("No se puede adicionar la imagen de anverso", "El elemento no es de tipo imagen");
                                            }
                                        });
                                        $("#documentCaptureVeridas").on("VDDocument_obverseDetection_type", (fdet) => {
                                            o.veridasdoctype = fdet.detail.length ? fdet.detail[0] : "MX2_ID";
                                        });
                                        $("#documentCaptureVeridas").on("VDDocument_reverseDetection_type", (fdet) => {
                                            o.veridasdoctype = fdet.detail.length ? fdet.detail[0] : "MX2_ID";
                                        });
                                        $("#documentCaptureVeridas").on("VDDocument_reverseDetection", (fdet) => {
                                            $("#ocrModalClose")[0] && $("#ocrModalClose").click();
                                            if (o.appvm[o.appvm[id].imagenreverso()]) {
                                                if (_.includes([o.TE.Documento, o.TE.Imagen], o.appvm[o.appvm[id].imagenreverso()].tipo())) {
                                                    showElementLoading(o, !0, id, "Guardando imagenes");
                                                    //Temporal handler after finish delete image
                                                    subscribeTemporalOnFinishLoad(o, o.appvm[id].imagenreverso(), () => {
                                                        //Temporal handler after finish reverse image
                                                        subscribeTemporalOnFinishLoad(o, o.appvm[id].imagenreverso(), () => {
                                                            if (_.isEmpty(o.appvm[id].tokenshared()))
                                                                toasty("No se especifico el campo del token", "", "error");
                                                            else {
                                                                //Los documentos siempre generan nuevo token
                                                                getToken(o, id, () => {
                                                                    //Se suben los documentos a veridas
                                                                    uploadDocuments(o, id, doctype, () => {
                                                                        //OCR y Score
                                                                        getOCR(o, id);
                                                                    });
                                                                });
                                                            }
                                                        });
                                                        //se guarda la imagen del reverso
                                                        createAttachment(o, o.appvm[id].imagenreverso(), "jpeg", fdet.detail, "", false, false);
                                                    });
                                                    //primero se borra (en caso de ser documento revisar mas adelante)
                                                    customActionElement(o.appvm[id].imagenreverso(), [o.appvm[o.appvm[id].imagenreverso()].tipo(), "delete"]);
                                                }
                                                else toasty("No se puede adicionar la imagen de reverso", "El elemento no es de tipo imagen");
                                            }
                                        });
                                        $("#documentCaptureVeridas").on("VDDocument_unmounted", function (fdet) {
                                            console.log("desmontado");
                                            _.forEach($("#documentCaptureVeridas video"), (v) => {
                                                v.srcObject.getTracks().forEach((track) => {
                                                    if (track.enabled) track.stop(), track.enabled = false;
                                                });
                                            }), cammo.remove();
                                        });
                                    };

                                    if (!o.vdCaptScript) {
                                        showHideLoading(o, !0, "Descargando archivos...");
                                        loadSDKScript('Scripts/Veridas/DocumentCapture/VDDocument.js', () => {
                                            console.log("VDDocument cargado");
                                            loadSDKScript('Scripts/Veridas/DocumentCapture/opencv/cv.js', () => {
                                                console.log("cv_document cargado"), o.vdCaptScript = !0, updateOpts(o);
                                                if (window.cv) {
                                                    if (window.cv instanceof Promise)
                                                        window.cv.then((target) => { window.cv = target, docuScan(); });
                                                    else docuScan();
                                                } else showHideLoading(o, !1), toasty("Error al cargar la libreria", 'No se pudo cargar cv_document');
                                            }, () => { toasty("Error al cargar la libreria", 'No se pudo cargar cv_document'), showHideLoading(o, !1); });
                                        }, () => { toasty("Error al cargar la libreria", 'No se pudo cargar VDDocument'), showHideLoading(o, !1); });
                                    } else docuScan();
                                }
                                destroyfunc = () => { try { destroyVDDocumentWidget(); } catch (ex) { cammo.remove(); } }, appendModal();
                                break;
                            case "selfie": //veri-das alive
                                funcexe = () => {
                                    var initChallenge = (callback) => {
                                        if (_.isEmpty(o.appvm[id].tokenshared()))
                                            toasty("No se especifico el campo del token", "", "error");
                                        else {
                                            if (_.isEmpty(o.appvm[o.appvm[id].tokenshared()].valor()))
                                                toasty("Aun no valida los documentos, no es posible validar prueba de vida sin empezar por la validacion de documentos", "", "error", 7000);
                                            else getChallenge(o, id, () => { callback && callback(); });
                                        }
                                    }, initFace = () => {
                                        const VDAlive = makeVDAliveWidget();
                                        let gif = 'VDAlive_Challenge.gif';
                                        VDAlive({
                                            targetSelector: "#documentCaptureVeridas",
                                            pathModels: dynamicurl + '/Scripts/Veridas/PhotoSelfieCapture/models/',
                                            infoUserShow: false,
                                            logEventsToConsole: true,
                                            ngas_images_path: dynamicurl + '/Scripts/Veridas/PhotoSelfieCapture/gifs/',
                                            aliveChallenge: challenge,
                                            continueText: "Siguiente",
                                            infoUserAliveMedia: gif,
                                            repeatText: "Repetir",
                                            smileRequestSmile: "Sonría",
                                            infoReviewImageText: "Revisa que la cara se ve completa y con una expresión natural",
                                            stepChallenge: "Paso",
                                            smileRequestSerious: "No sonría",
                                            stepOfChallenge: "de",
                                            setLandscapeDeviceMessage: "Por favor, ponga el dispositivo horizontal",
                                            fitYourFace: "Ahora, encaja tu cara en el marco y mantente estable mientras tomamos una foto",
                                            setPortraitDeviceMessage: "Por favor, ponga el dispositivo vertical",
                                            repeatText: "REPETIR",
                                            continueText: "CONTINUAR",
                                            message_middle_center: "¡Bien! Vuelve al centro",
                                            message_finish_challenge: "¡Bien!",
                                            message_alive_bold: "LENTAMENTE",
                                            message_alive_light: "Mueva la cabeza",
                                            restartingErrorText: "No se ha podido completar el proceso. Por favor, repita la validación.",
                                            infoUserAliveTitle: "Sigue las instrucciones de movimiento",
                                            infoUserAliveSubTitle: `1. Encaja la cara en el marco y espera a la cuenta atrás. 
                                            2. Mueva la cabeza ligeramente en la dirección que te indiquen las flechas.
                                            3. Cuando la pantalla te indique que lo has hecho correctamente, vuelve a mirar al centro.
                                            4. Repite el proceso 2 veces.`,
                                            infoUserAliveNextButtonText: "Siguiente",
                                            infoUserAliveButtonText: "COMENZAR EL PROCESO",
                                            videoErrorUnavailable: "Por favor, compruebe que la cámara del dispositivo no está siendo usada por otro programa",
                                            videoErrorNotFound: "Por favor, compruebe que el dispositivo dispone de cámara",
                                            videoErrorConstraint: "Por favor, compruebe que el dispositivo dispone de cámara de resolución mínima 640 x 480",
                                            videoErrorExternalInput: "Por favor, compruebe que no tiene ningún software simulando la cámara",
                                            videoErrorDefault: "Lo sentimos, se ha producido un error iniciando la cámara",
                                            videoErrorPermission: "Por favor, permita a la página acceso a la cámara",
                                            videoErrorUnavailableActionLabel: "Reintentar",
                                            videoErrorConstraintActionLabel: "Reintentar",
                                            videoErrorPermissionActionLabel: "Reintentar",
                                            videoErrorExternalInputLabel: "Reintentar",
                                            not_move: "Mantente estable",
                                            center_face: "Centra su cara",
                                            webrtcUnsupportedText: "Navegador no compatible. Debe repetir el proceso: Si está en un iPhone debe emplear el navegador Safari. En el resto de casos puede usar Chrome, Firefox u Opera."
                                        });

                                        $("#documentCaptureVeridas").on("VDAlive_faceDetection", (fdet) => {
                                            $("#ocrModalClose")[0] && $("#ocrModalClose").click();
                                            if (o.appvm[o.appvm[id].imagenselfie()]) {
                                                if (_.includes([o.TE.Documento, o.TE.Imagen], o.appvm[o.appvm[id].imagenselfie()].tipo())) {
                                                    showElementLoading(o, !0, id, "Guardando imagen");
                                                    //Temporal handler after finish delete image
                                                    subscribeTemporalOnFinishLoad(o, o.appvm[id].imagenselfie(), () => {
                                                        //Temporal handler after finish upload image
                                                        subscribeTemporalOnFinishLoad(o, o.appvm[id].imagenselfie(), () => {
                                                            //tratamiento al video para sacarlo en base64
                                                            var readervideo = new FileReader();
                                                            readervideo.readAsDataURL(fdet.detail.image_alive);
                                                            readervideo.onloadend = () => {
                                                                //Temporal handler after finish delete image
                                                                subscribeTemporalOnFinishLoad(o, o.appvm[id].videoselfie(), () => {
                                                                    //Temporal handler after finish selfie image
                                                                    subscribeTemporalOnFinishLoad(o, o.appvm[id].videoselfie(), () => {
                                                                        if (_.isEmpty(o.appvm[id].tokenshared()))
                                                                            toasty("No se especifico el campo del token", "", "error");
                                                                        else {
                                                                            //Se sube la selfie, video y vtt
                                                                            uploadSelfie(o, id, fdet.detail.webVTT, () => {
                                                                                //Ocr y score
                                                                                getOCR(o, id);
                                                                            });
                                                                        }
                                                                    });
                                                                    //se guarda el video
                                                                    createAttachment(o, o.appvm[id].videoselfie(), "mp4", readervideo.result, "", false, false);
                                                                });
                                                                //primero se borra el video (en caso de ser documento revisar mas adelante)
                                                                customActionElement(o.appvm[id].videoselfie(), [o.appvm[o.appvm[id].videoselfie()].tipo(), "delete"]);
                                                            }
                                                        });
                                                        //se guarda la selfie
                                                        createAttachment(o, o.appvm[id].imagenselfie(), "jpeg", fdet.detail.image, "", false, false);
                                                    });
                                                    //primero se borra la selfie (en caso de ser documento revisar mas adelante)
                                                    customActionElement(o.appvm[id].imagenselfie(), [o.appvm[o.appvm[id].imagenselfie()].tipo(), "delete"]);
                                                }
                                                else
                                                    toasty("No se puede adicionar la selfie", "El elemento no es de tipo imagen");
                                            }
                                        });
                                        $("#documentCaptureVeridas").on("VDAlive_unmounted", (fdet) => {
                                            console.log("desmontado");
                                            _.forEach($("#documentCaptureVeridas video"), (v) => {
                                                v.srcObject.getTracks().forEach((track) => {
                                                    if (track.enabled) track.stop(), track.enabled = false;
                                                });
                                            }), cammo.remove();
                                        });
                                        $("#documentCaptureVeridas").on("VDAlive_repeatClicked", (fdet) => {
                                            initChallenge(() => { window.restartChallenge(challenge); });
                                        });
                                    };
                                    if (!o.vdSelfieScript) {
                                        loadSDKScript('Scripts/Veridas/PhotoSelfieCapture/VDAlive.js', () => {
                                            console.log("VDAlive cargado");
                                            loadSDKScript('Scripts/Veridas/PhotoSelfieCapture/opencv/cv_alive.js', () => {
                                                console.log("cv_alive cargado"), o.vdSelfieScript = !0, updateOpts(o);
                                                if (window.cv) {
                                                    if (window.cv instanceof Promise) window.cv.then((target) => { window.cv = target, initChallenge(() => { initFace(); }); });
                                                    else initChallenge(() => { initFace(); });
                                                } else showHideLoading(o, !1), toasty("Error al cargar la libreria", 'No se pudo cargar cv_alive');
                                            }, () => { toasty("Error al cargar la libreria", 'No se pudo cargar cv_alive'), showHideLoading(o, !1); });
                                        }, () => { toasty("Error al cargar la libreria", 'No se pudo cargar VDAlive'), showHideLoading(o, !1); });
                                    }
                                    else initChallenge(() => { initFace(); });
                                }
                                destroyfunc = function () { try { destroyVDAliveWidget(); } catch (ex) { cammo.remove(); } }, appendModal();
                                break;
                            case "confirm":
                                if (_.isEmpty(o.appvm[id].tokenshared()))
                                    toasty("No se especifico el campo del token", "", "error");
                                else {
                                    if (_.isEmpty(o.appvm[o.appvm[id].tokenshared()].valor()))
                                        toasty("No se ha creado un token", "", "error");
                                    else //usar el token existente
                                    {
                                        showElementLoading(o, !0, id, "Confirmando proceso");
                                        var clonedata = _.clone(o.datasend);
                                        clonedata["xml"] && delete clonedata["xml"];
                                        clonedata["estadistica"] && delete clonedata["estadistica"];
                                        clonedata["prevData"] && delete clonedata["prevData"];
                                        $.ajax({
                                            url: o.datasend.urlGlobal + "FECapturador.aspx/EjecutaServicio",
                                            data: JSON.stringify({
                                                json: JSON.stringify({
                                                    initialmethod: "ServiciosDigipro.ServicioVeridas.ConfirmValidation",
                                                    assemblypath: "..\\..\\wcfservicios\\bin\\ServiciosDigipro.dll",
                                                    data: {
                                                        tokenid: o.appvm[o.appvm[id].tokenshared()].valor(),
                                                        showlog: !0
                                                    }
                                                }),
                                                datasend: JSON.stringify(clonedata)
                                            })
                                        }).done((j) => {
                                            j = j.d;
                                            console.log(j.data.log);
                                            if (j.response.success && j.response.servicesuccess) {
                                                toasty("Documentos confirmados", "Ya fueron validados y confirmados los documentos.", "exito");
                                            }
                                            else toasty("Error al generar el OCR", j.response.servicemessage, "error");
                                        }).always((j) => {
                                            j = j.d, showElementLoading(o, !1, id);
                                        });
                                    }
                                }
                                break;
                            case "cancel":
                                if (_.isEmpty(o.appvm[id].tokenshared()))
                                    toasty("No se especifico el campo del token", "", "error");
                                else {
                                    if (_.isEmpty(o.appvm[o.appvm[id].tokenshared()].valor()))
                                        toasty("No se ha creado un token", "", "error");
                                    else //usar el token existente
                                    {
                                        showElementLoading(o, !0, id, "Cancelando proceso");
                                        var clonedata = _.clone(o.datasend);
                                        clonedata["xml"] && delete clonedata["xml"];
                                        clonedata["estadistica"] && delete clonedata["estadistica"];
                                        clonedata["prevData"] && delete clonedata["prevData"];
                                        $.ajax({
                                            url: o.datasend.urlGlobal + "FECapturador.aspx/EjecutaServicio",
                                            data: JSON.stringify({
                                                json: JSON.stringify({
                                                    initialmethod: "ServiciosDigipro.ServicioVeridas.CancelValidation",
                                                    assemblypath: "..\\..\\wcfservicios\\bin\\ServiciosDigipro.dll",
                                                    data: {
                                                        tokenid: o.appvm[o.appvm[id].tokenshared()].valor(),
                                                        showlog: !0
                                                    }
                                                }),
                                                datasend: JSON.stringify(clonedata)
                                            })
                                        }).done((j) => {
                                            j = j.d;
                                            console.log(j.data.log);
                                            if (j.response.success && j.response.servicesuccess) {
                                                toasty("Documentos cancelados", "Se canceló el proceso ante Veri-das.", "exito");
                                            }
                                            else toasty("Error al generar el OCR", j.response.servicemessage, "error");
                                        }).always((j) => {
                                            j = j.d, showElementLoading(o, !1, id);
                                        });
                                    }
                                }
                                break;
                            case "pepaml":
                                if (_.isEmpty(o.appvm[id].tokenshared()))
                                    toasty("No se especifico el campo del token", "", "error");
                                else {
                                    if (_.isEmpty(o.appvm[o.appvm[id].tokenshared()].valor()))
                                        toasty("No se ha creado un token", "", "error");
                                    else //usar el token existente
                                    {
                                        showElementLoading(o, !0, id, "Datos PEP-AML");
                                        var clonedata = _.clone(o.datasend);
                                        clonedata["xml"] && delete clonedata["xml"];
                                        clonedata["estadistica"] && delete clonedata["estadistica"];
                                        clonedata["prevData"] && delete clonedata["prevData"];
                                        $.ajax({
                                            url: o.datasend.urlGlobal + "FECapturador.aspx/EjecutaServicio",
                                            data: JSON.stringify({
                                                json: JSON.stringify({
                                                    initialmethod: "ServiciosDigipro.ServicioVeridas.PEPAML",
                                                    assemblypath: "..\\..\\wcfservicios\\bin\\ServiciosDigipro.dll",
                                                    data: {
                                                        tokenid: o.appvm[o.appvm[id].tokenshared()].valor(),
                                                        showlog: !0
                                                    }
                                                }),
                                                datasend: JSON.stringify(clonedata)
                                            })
                                        }).done((j) => {
                                            j = j.d;
                                            console.log(j.data.log);
                                            var mapp = o.appvm[id].mappingpepaml();
                                            _.forEach(_.keys(mapp), (v) => {
                                                mapp[v] && o.appvm[mapp[v]] && (o.appvm[mapp[v]].valor && o.appvm[mapp[v]].valor(j.data[v]));
                                            });
                                            if (j.response.success && j.response.servicesuccess)
                                                toasty(j.response.servicemessage, "", "exito");
                                            else toasty("Error al obtener los datos PEP-AML", j.response.servicemessage, "error");
                                        }).always((j) => {
                                            j = j.d, showElementLoading(o, !1, id);
                                        });
                                    }
                                }
                                break;
                        }
                        break;
                    case "fad":
                        cammo = $(`<div class="modal" style="display:block;overflow:auto">
                            <div class="modal-dialog modal-dialog-centered modal-lg">
                                <div id="camaramodal" class="modal-content rounded">
                                    <div class="modal-header p-2 border-bottom border-dark bg-white">
                                        <h5 class="modal-title text-dark">Firma Autógrafa Digital</h5>
                                        <span id="camaraclose" style="color: #fff; background-color: #dc3545;" class="btn btn-sm btn-outline-danger btn-lg border"><i style="font-size:16px" class="fas fa-times"></i></span>
                                    </div>
                                    <div class="modal-body p-2">
                                        <div id="elemBaseContainer" class="no-padding rounded position-relative w-100">
                                            ${(!o.appvm[id].sinterminos() ? `<div class="text-center">
                                                <strong class="h6">Terminos y Condiciones</strong><br/>
                                                <textarea style="width: 60%;" rows="4"; disabled=true>${o.appvm[id].acuerdofirma()}</textarea>
                                                <div class="form-check" id="checkterminos">
                                                    <input class="form-check-input" type="checkbox" id="fadaccepted" />
                                                    <label class="form-check-label" for="fadaccepted">He leido y acepto los terminos descritos</label>
                                                </div>
                                            </div>` : "")}
                                            <div id="showfadaccepted" style="${(!o.appvm[id].sinterminos() ? "display: none;" : "")}">
                                                <div class="row justify-content-md-center">
                                                    <div id="fadContainer" class="col-sm-12 col-md-6" style="text-align: center;">
                                                        <span id="fadtitletestigo" class="text-bold"></span>
                                                        <div id="elemToShow" hidden></div>
                                                        <div id="videolengthvid" hidden></div>
                                                        <div id="fadopts"></div>
                                                    </div>
                                                    <div class="col-sm-12 col-md-6" style="text-align: center;">
                                                        <span id="fadtitlesign" class="text-bold">Favor de firmar</span>
                                                        <canvas style="border: gray 2px solid;" id="fadsignature"></canvas>
                                                        <div id="fadclear" class="btn btn-danger btn-block"><i class="fas fa-eraser"></i> Borrar todo</div>
                                                        <div id="fadundo" class="btn btn btn-warning text-white btn-block"><i class="fas fa-undo"></i> Deshacer ultimo trazo</div>
                                                        <div id="fadsave" class="btn btn-success btn-block"><i class="fas fa-check"></i> Aceptar firma</div>
                                                    </div>
                                                </div>
                                                <hr/>
                                                <p class="h6 text-center"><strong>${(o.appvm[o.appvm[id].personafirma()] ? o.appvm[o.appvm[id].personafirma()].valor() : "")}</strong></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`), elemBaseCamVid = '<video id="recvideo" class="p-0 w-100" controls playsinline><source type="video/mp4"></source></video>',
                            optsVideo = `<div class="text-center">
                                <div id="snapmedia" style="background-color: #3c8dbc; color: white;" class="btn px-2 py-1"><i class="far fa-play-circle"></i> Grabar</div>
                                <div id="deletemedia" class="btn btn-danger px-2 py-1" hidden><i class="fas fa-trash-alt"></i> Borrar y volver a grabar</div>
                                <div id="stoprecordvideo" class="btn btn-secondary px-2 py-1" hidden><i class="far fa-stop-circle"></i> Detener</div>
                            </div>`,
                            optsCamera = `<div class="text-center">
                                <div id="snapmedia" style="background-color: #3c8dbc; color: white;" class="btn px-2 py-1"><i class="fas fa-camera-retro"></i> Tomar Foto</div>
                                <div id="deletemedia" class="btn btn-danger px-2 py-1" hidden><i class="far fa-trash-alt"></i> Borrar</div>
                            </div>`,
                            optMovCamera = '<div class="position-absolute p-3" style="top:0; right:0"><i id="reversecam" title="Cambiar c&aacute;mara" class="fas fa-retweet" style="cursor:pointer;"></i></div>',
                            elemVideo = '<video class="p-0 w-100" controls playsinline><source type="video/mp4"></source></video>', elemCamera = '<canvas class="p-0"></canvas>';

                        $("body").append(cammo);
                        cammo.find("#camaraclose").on("click", function () { stopMedia(), cammo.remove(); });
                        var initFadCanvas = () => {
                            $("#showfadaccepted").show(), $("#checkterminos").hide();
                            elemContainer = $("#elemToShow"), optsE = $("#fadopts");
                            var fadsignature = $("#fadsignature");
                            var signaturePad = new SignaturePad(fadsignature[0]);
                            signaturePad.backgroundColor = 'rgb(239, 239, 239)';

                            fadsignature[0].width = $("#fadContainer").outerWidth() - 30;
                            fadsignature[0].height = 300;
                            signaturePad.clear();

                            $("#fadclear").on("click", function () { signaturePad.clear(); });
                            $("#fadundo").on("click", function () {
                                var data = signaturePad.toData();
                                if (data) {
                                    data.pop(); // remove the last dot or line
                                    signaturePad.fromData(data);
                                }
                            });
                            $("#fadsave").on("click", function () {
                                var foto = "", video = "", cansave = !0;
                                if (o.appvm[id].tipovalidacion() === "video") {
                                    video = elemContainer.find("video")[0].src;
                                    if (_.isEmpty(video) || $("#stoprecordvideo").is(":visible")) {
                                        $("#fadtitletestigo").addClass("text-red").effect("shake", {}, 500);
                                        cansave = !1;
                                    }
                                }
                                if (o.appvm[id].tipovalidacion() === "testigo") {
                                    foto = elemContainer.find("canvas")[0].toDataURL("image/png");
                                    if (_.isEmpty(foto) || foto.length < 500 || foto.indexOf("AAAAAAAAAA") >= 0) {
                                        $("#fadtitletestigo").addClass("text-red").effect("shake", {}, 500);
                                        cansave = !1;
                                    }
                                }
                                if (signaturePad.isEmpty()) {
                                    $("#fadtitlesign").addClass("text-red").effect("shake", {}, 500);
                                    cansave = !1;
                                }
                                if (cansave) {
                                    //anexo de firma
                                    createAttachment(o, id, "png", signaturePad.toDataURL(), '', !0, !0, createAttachmentName(o, id, '', 1));
                                    //anexo de video
                                    if (o.appvm[id].tipovalidacion() === "video")
                                        createAttachment(o, id, "mp4", video, '', !0, !0, createAttachmentName(o, id, '', 2));
                                    //anexo de foto
                                    if (o.appvm[id].tipovalidacion() === "testigo")
                                        createAttachment(o, id, "png", foto, '', !0, !0, createAttachmentName(o, id, '', 3));
                                    o.appvm[id].nombrefirmante(o.appvm[o.appvm[id].personafirma()] ? o.appvm[o.appvm[id].personafirma()].valor() : "");
                                    o.appvm[id].fecha(moment(new Date()).format("DD/MM/YYYY HH:mm:ss"));
                                    o.appvm[id].dispositivo(navigator.userAgent);
                                    o.appvm[id].georeferencia("geo");
                                    var jsonfad = {
                                        acuerdofirma: o.appvm[id].acuerdofirma(),
                                        dispositivo: o.appvm[id].dispositivo(),
                                        fecha: o.appvm[id].fecha(),
                                        nombrefirmante: o.appvm[id].nombrefirmante(),
                                        georeferencia: "9.436446643,-7.43546464",
                                        guidtimestamp: "",
                                        hash: ""
                                    };
                                    jsonfad.hash = CryptoJS.SHA512(JSON.stringify(jsonfad)).toString(CryptoJS.enc.Hex);
                                    o.appvm[id].hash(jsonfad.hash);
                                    stopMedia(), cammo.remove();
                                    if (o.appvm[id].obtenerhash() === !0) {
                                        //ir al servicio para certificar y al terminar guardar anexo json
                                        var clonedata = _.clone(o.datasend);
                                        clonedata["xml"] && delete clonedata["xml"];
                                        clonedata["estadistica"] && delete clonedata["estadistica"];
                                        clonedata["prevData"] && delete clonedata["prevData"];
                                        $.ajax({
                                            url: o.datasend.urlGlobal + "FECapturador.aspx/EjecutaServicio",
                                            data: JSON.stringify({
                                                json: JSON.stringify({
                                                    initialmethod: "ServiciosDigipro.ServicioSelladoTiempo.SolicitayDescargaSellado",
                                                    assemblypath: "..\\..\\wcfservicios\\bin\\ServiciosDigipro.dll",
                                                    data: { hash: jsonfad.hash, tipo: o.appvm[id].proveedor() }
                                                }), datasend: JSON.stringify(clonedata)
                                            }),
                                            beforeSend: () => { showHideLoading(o, !0, "Certificando la firma"); },
                                            success: (j) => {
                                                j = j.d, o = getOpts();
                                                if (j.response.success && j.response.servicesuccess) {
                                                    var datahash = JSON.parse(j.data.JSON);
                                                    jsonfad.guidtimestamp = datahash.value, o.appvm[id].guidtimestamp(jsonfad.guidtimestamp);
                                                }
                                                console.log(`FIN de certificado de FAD para elemento${id} ${moment().format("DD - MM - YYYY HH: mm: ss.SSS")}`);
                                                //anexo de json
                                                createAttachment(o, id, "txt", btoa(JSON.stringify(jsonfad)), '', !1, !0, createAttachmentName(o, id, '', 4));
                                            }
                                        });
                                    } else {
                                        //anexo de json
                                        createAttachment(o, id, "txt", btoa(JSON.stringify(jsonfad)), '', !1, !0, createAttachmentName(o, id, '', 4));
                                    }
                                    //if (params[2] === "reemp" && params[3] !== "")
                                    //    o.appvm[id].ondelete(!0), params[3].Reemplazado = !0, createAttachment(o, id, ext, datatosave, params[3].DocID, !1, o.appvm[id].tipo() === o.TE.Documento);
                                    //else createAttachment(o, id, ext, datatosave, '', '', o.appvm[id].tipo() === o.TE.Documento), cammo.remove(), stopMedia();
                                }
                            });
                            if (o.appvm[id].tipovalidacion() === "video") {
                                $("#fadtitletestigo").text("Favor de grabar mientras firma ó lee los terminos");
                                optsE.append(optsVideo), elemContainer.append(elemVideo);
                                optsE.find("#deletemedia,#snapmedia").on("click", function () { record(!0); }), optsE.find("#stoprecordvideo").on("click", function () { record(!1); });
                            }
                            else if (o.appvm[id].tipovalidacion() === "testigo") {
                                $("#fadtitletestigo").text("Favor de tomarse una foto");
                                optsE.append(optsCamera), elemContainer.append(elemCamera);
                                optsE.find("#snapmedia").on("click", function () { snapPhotoCamera(!1); }), optsE.find("#deletemedia").on("click", function () { snapPhotoCamera(!0); });
                            }
                            if (o.appvm[id].tipovalidacion() !== "ninguna") {
                                optsE.find("#savemedia").on("click", function () { saveMedia(); });
                                $(elemBaseCamVid).insertBefore(optsE);
                                baseCamera = $("#recvideo")[0], videoLengthElem = $("#videolengthvid");
                                baseCamera.width = $("#fadContainer").outerWidth() - 30;
                                elemContainer[0].width = $("#fadContainer").outerWidth() - 30;
                                initializeCamera(), !o.iswebapp && (isFront = !1, optsE.append(optMovCamera),
                                    optsE.find("#reversecam").on("click", function () { isFront = !isFront, initializeCamera(isFront); }));
                            }
                            else $("#fadContainer").hide();
                        };
                        $("#fadaccepted").on("change", e => {
                            if (e.target.checked) initFadCanvas();
                        });
                        //si no quieren terminos se inicializa el canvas
                        o.appvm[id].sinterminos() === !0 && initFadCanvas();
                        break;
                    case "fadtimestamp":
                        cammo = $('<div class="modal" style="display:block;overflow:auto">\
                            <div class="modal-dialog modal-dialog-centered">\
                                <div class="modal-content rounded">\
                                    <div class="modal-header p-2 border-bottom border-dark bg-white">\
                                        <h5 class="modal-title text-dark">Firma Autógrafa Digital Timestamp</h5>\
                                        <span id="camaraclose" title="Cancelar" class="btn btn-sm btn-outline-danger btn-lg border"><i style="font-size:16px" class="fas fa-times"></i></span>\
                                    </div>\
                                    <div class="modal-body p-2">\
                                        <div class="no-padding rounded position-relative w-100">\
                                            <p class="h6 text-left">\
                                                <strong>Terminos de la firma:</strong> '+ o.appvm[id].acuerdofirma() + '<br/>\
                                                <strong>Nombre del Firmante:</strong> '+ o.appvm[id].nombrefirmante() + '<br/>\
                                                <strong>Dispositivo:</strong> '+ o.appvm[id].dispositivo() + '<br/>\
                                                <strong>Fecha:</strong> '+ o.appvm[id].fecha() + '<br/>\
                                                <strong>Coordenadas:</strong> '+ o.appvm[id].georeferencia() + '<br/>\
                                                <strong>Id de Certificado:</strong> '+ o.appvm[id].guidtimestamp() + '<br/>\
                                                <strong>Hash de Timestamp:</strong><textarea rows="4" class="form-control" disabled>'+ o.appvm[id].hash() + ' </textarea>\
                                            </p>\
                                        </div>\
                                    </div>\
                                </div>\
                            </div>\
                        </div>');
                        $("body").append(cammo);
                        cammo.find("#camaraclose").on("click", function () { cammo.remove(); });
                        break;
                }
                updateOpts(o, true);
            }
        }
        function checkIfElementIsInParents(o, child, parentToFind) {
            var parent = o.appvm[child].elementopadre();
            if (_.isEmpty(parent)) return false;
            if (parent === parentToFind) return true;
            return checkIfElementIsInParents(o, parent, parentToFind);
        }
        function checkIfElementIsInParentsType(o, child, type) {
            var parent = o.appvm[child].elementopadre();
            if (_.isEmpty(parent)) return false;
            if (o.appvm[parent].tipo() === type) return true;
            return checkIfElementIsInParents(o, parent, type);
        }
        function checkNumberKey(o, id, e) {
            var numbers = [48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105], specialChars = [8, 37, 39, 16, 36, 9, 17], copypaste = [67, 86];
            var val = $(e.currentTarget).val().toString(), dec = val.indexOf(".") > -1 ? val.substring(val.indexOf(".") + 1) : "";
            return (o.appvm[id].decimales() === 0 || o.appvm[id].decimales() > dec.length || e.currentTarget.selectionStart <= val.indexOf("."))
                && _.includes(numbers, e.keyCode) || _.includes(specialChars, e.keyCode) || e.keyCode === 190 && val.indexOf(".") === -1 || (e.ctrlKey === !0 && _.includes(copypaste, e.keyCode));
        }
        //Crea un modal generico para que se agregue el body a placer
        //titulo: El titulo a mostrar del modal
        function customModal(titulo) {
            const mod = $("<div>", { class: "modal", style: "display:block;overflow:auto" })
                .append($("<div>", { class: "modal-dialog modal-dialog-centered", style: "width: 90%; max-width: 90%;" })
                    .append($("<div>", { class: "modal-content rounded" })
                        .append($("<div>", { class: "modal-header p-2 border-bottom border-dark bg-white" })
                            .append($("<h5>", { class: "modal-title text-dark" }).text(titulo))
                            .append($("<span>", { title: 'Cancelar', class: "modalclose btn btn-sm btn-outline-danger btn-lg border" })
                                .append($("<i>", { class: "fas fa-times", style: 'font-size:16px' }))))
                        .append($("<div>", { class: "modal-body p-2" }))));
            $("body").append(mod), mod.modal({ keyboard: !1, backdrop: "static", show: !0 });
            mod.find(".modalclose").on("click", () => { mod.modal("hide"), mod.remove(); });
            return mod;
        }
        function editChosenItems(nv, id) {
            var o = getOpts(), ta = o.appvm[id].tipoasociacion(), tl = o.appvm[id].tipolista();
            tl === "checkbox" && o.appvm[id].todasopcionesrequeridas && !o.appvm[id].todasopcionesrequeridas() && o.appvm[id].maxopcionesseleccionar() > 0 && o.appvm[id].maxopcionesseleccionar() < nv.length && nv.pop();
            !(nv instanceof Array) && (nv = [nv]);
            if (o.appvm[id].cascadahijo && o.appvm[o.appvm[id].cascadahijo()]) {
                var idhijo = o.appvm[id].cascadahijo(), tlhijo = o.appvm[idhijo].tipolista(),
                    modoBusquedaHijo = o.appvm[idhijo].modobusqueda(),
                    elemSelCombo = $("#" + o.appvm[id].cascadahijo() + " select.docelem");
                if (nv) {
                    let dicconfigdata = {}, newitems = [], sval, tahijo = o.appvm[idhijo].tipoasociacion(),
                        typemethijo = tahijo === "idid" || tahijo === "iddesc" ? "Valor" : "Nombre";

                    _.forEach(o.appvm[id].configuracioncascada().toString().split(';'), function (v) { sval = v.toString().split(':'); sval.length > 1 && (dicconfigdata[sval[0]] = sval[1]); });
                    _.forEach(nv, function (v) {
                        (o.appvm[id].cascadapadre() || dicconfigdata[v.Valor]) && (newitems = _.union(newitems, _.filter(o.datatags.allitemscatalogs["catalogos|" + o.appvm[idhijo].catalogoorigen()],
                            function (sv) { return dicconfigdata[v.Valor] && _.includes(dicconfigdata[v.Valor].toString().split(','), sv.Valor) || o.appvm[id].cascadapadre() && sv.CatalogoPId === v.CveCatalogo; })));
                    });
                    o.appvm[idhijo].catalogodestino(setDescriptionAndOrder(o, idhijo, newitems));
                    var valmethijo = o.appvm[idhijo].valormetadato().toString();
                    if (tlhijo === "combo") {
                        var item;
                        o.appvm.isEditor() ? valmethijo = "" : (item = _.find(newitems, function (m) { return valmethijo === m[typemethijo]; }),
                            item && (valmethijo = item.Valor));
                        o.appvm[idhijo].optionselectedRule(valmethijo);

                    } else {
                        var selecteds = _.filter(newitems, function (v) { return _.includes(valmethijo.toString().split(","), v[typemethijo]); });
                        tlhijo !== "checkbox" && (selecteds = _.head(selecteds));
                        setTimeout(function () { o.appvm[idhijo].chosenitemsRule(selecteds); }, 1);
                    }
                }
                else {
                    o.appvm[idhijo].catalogodestino([]);
                    tl === "combo" ? o.appvm[idhijo].optionselectedRule("") : o.appvm[idhijo].chosenitemsRule([]);
                }

                if (modoBusquedaHijo && elemSelCombo[0])
                    elemSelCombo.combobox("loadData", o.appvm[o.appvm[id].cascadahijo()].catalogodestino());
            }

            var vameta, typemet = ta === "idid" || ta === "iddesc" ? "Valor" : "Nombre",
                typeval = ta === "descdesc" || ta === "iddesc" ? "Nombre" : "Valor";
            vameta = _.filter(_.map(nv, function (n) { return n[typemet]; }), function (n) { return n !== ""; }).join(),
                nv = _.filter(_.map(nv, function (n) { return n[typeval]; }), function (n) { return n !== ""; }).join();
            o.appvm[id].valormetadato(vameta), o.appvm[id].valor(nv);

            if (o.appvm[id].tieneesquema && o.appvm[id].tieneesquema() === true && o.appvm[id].tipolista() !== "checkbox") seleccionaEsquema(o, id);
        }
        function extractJsonValue(j, _attr) {
            if (j === undefined) return "";
            else {
                if (typeof j === "string") {
                    if (j.indexOf("{") !== -1 && j.indexOf("}") !== -1 && j.indexOf("{{") === -1) {
                        if (_attr === "hojaestilos") return j;
                        if (j.indexOf("[") !== -1 && j.indexOf("]") !== -1) return j; //probablemente tabla
                        var regex = new RegExp('\{.*\:.*\}.*'), results = regex.exec(j);
                        if (results === null) return j; //metieron algo que no es json
                        var newj = ko.utils.parseJson(j);
                        if (newj[0]) j = newj[0].Valor;
                        else if (newj.Valor) j = newj.Valor;
                        else return j; //metieron json dentro de un texto o textarea
                    }
                    if (j === undefined) return "";
                    switch (j.toLowerCase().trim()) {
                        case "true": return true;
                        case "false": return false;
                        default: return j;
                    }
                }
                else return j;
            }
        }
        function errorFormElec(o, ex) {
            showHideLoading(o, false);
            var text = ex ? ex.responseText ? ex.responseText : ex.statusText ? ex.statusText : ex : "";
            console.error(text), toasty(`Error de Formatos Electronicos`, text, 'error');
        }
        function esquemaTexto(o, id) {
            var esFo = o.appvm[id].esqueletoformato(), formattedMask = "", oriStrPos = 0, noFormattedMask = "";
            var nv = o.appvm[id].valormetadato().toString();
            if (_.includes(["DD/DD/DDDD", "DD-DD-DDDD", "DD LLL DDDD"], esFo)) {
                var day = nv.substr(0, 2), month = nv.substr(2, 2), year = nv.substr(4, 4), dayF = new Date(year, month - 1, day);
                if (day < 32 && month < 13) {
                    noFormattedMask = ("0" + dayF.getDate()).slice(-2) + ("0" + (dayF.getMonth() + 1)).slice(-2) + dayF.getFullYear();
                    switch (esFo) {
                        case "DD/DD/DDDD":
                            formattedMask = ("0" + dayF.getDate()).slice(-2) + "/" + ("0" + (dayF.getMonth() + 1)).slice(-2) + "/" + dayF.getFullYear();
                            break;
                        case "DD-DD-DDDD":
                            formattedMask = ("0" + dayF.getDate()).slice(-2) + "-" + ("0" + (dayF.getMonth() + 1)).slice(-2) + "-" + dayF.getFullYear();
                            break;
                    }
                }
            }
            else {
                for (var ef = 0; ef < esFo.length; ef++) {
                    switch (esFo[ef]) {
                        case "D": //Digito
                            if (nv[oriStrPos]) {
                                if (!isNaN(nv[oriStrPos])) {
                                    formattedMask += nv[oriStrPos].toString();
                                    noFormattedMask += nv[oriStrPos].toString();
                                }
                                else ef--;
                            }
                            else formattedMask += " ";
                            oriStrPos++;
                            break;
                        case "L": //Letra
                            if (nv[oriStrPos]) {
                                formattedMask += nv[oriStrPos].toString();
                                noFormattedMask += nv[oriStrPos].toString();
                            }
                            else formattedMask += " ";
                            oriStrPos++;
                            break;
                        default: formattedMask += esFo[ef].toString(); break;
                    }
                }
            }
            !noFormattedMask && (formattedMask = "");
            o.appvm[id].valor.silentUpdate(formattedMask);
        }
        function executeJsonModule(s, isService) {
            var o = getOpts(), varattr = isService ? "servicios" : "components", defaultlist = isService ? o.datatags.servicesList : o.datatags.componentsList;
            if (o.appvm[o.idPlantilla][varattr]()[s] && (o.appvm[o.idPlantilla][varattr]()[s].enabled || o.appvm[o.idPlantilla][varattr]()[s].enabled === undefined)) {
                var oriObj = o.appvm[o.idPlantilla][varattr]()[s], sb;
                if (!_.isEmpty(oriObj.initialmethod)) { //primero se pregunta de v2 y despues v1
                    sb = _.clone(oriObj);
                    extractInnerDataForService2(sb, o), sendServiceRequest2(o, oriObj, sb);
                }
                else if (!_.isEmpty(oriObj.pin) || !_.isEmpty(oriObj.pout)) {
                    sb = _.find(defaultlist, { id: oriObj.id });
                    if (sb) {
                        for (var e in sb.pin.method) {
                            var order = sb.pin.method[e].order, idorder = "order_" + order, idelem = oriObj.pin[idorder].idelem;
                            if (sb.pin.method[e].controltype === "elem" && o.appvm[idelem]) {
                                if (!!sb.pin.method[e].attr && o.appvm[idelem][sb.pin.method[e].attr.trim()])
                                    sb.pin.method[e].value = o.appvm[idelem][sb.pin.method[e].attr.trim()]();
                                else if (o.appvm[idelem].tipo() === o.TE.Tabla) {
                                    var jparam = [];
                                    for (var k = 0; k < o.appvm[idelem].valorjson().length; k++) {
                                        var row = o.appvm[idelem].valorjson()[k], jr = {};
                                        for (var r in row)
                                            if (r.indexOf("formElec_") >= 0 && o.appvm[r].idunico && !!o.appvm[r].idunico() && row[r].valormetadato)
                                                jr[o.appvm[r].idunico()] = row[r].valormetadato();
                                        !_.isEmpty(jr) && jparam.push(jr);
                                    }
                                    sb.pin.method[e].value = JSON.stringify(jparam);
                                }
                                else if (o.appvm[idelem].tipo() === o.TE.Imagen) {
                                    !!o.appvm[idelem].anexo && !!o.appvm[idelem].anexo() && (sb.pin.method[e].value = o.appvm[idelem].anexo().guidanexo);
                                    !sb.pin.method[e].value && (sb.pin.method[e].value = "");
                                }
                                else if (_.includes([o.TE.HuellaDigital, o.TE.Documento], o.appvm[idelem].tipo())) {
                                    var guids = [];
                                    for (var i = 0; i < o.appvm.listAnexos().length; i++)
                                        if (o.appvm.listAnexos()[i].ElementoId === idelem && o.appvm.listAnexos()[i].Extension === "wsq")
                                            guids.push(o.appvm.listAnexos()[i].GuidAnexo);
                                    sb.pin.method[e].value = guids.join(",");
                                }
                                else if (o.appvm[idelem].valormetadato)
                                    sb.pin.method[e].value = o.appvm[idelem].valormetadato();
                            }
                            else sb.pin.method[e].value = oriObj.pin[idorder].value;
                        }
                        isService ? sendServiceRequest2(o, oriObj, sb) : executeComponentRequest(o, oriObj, s);
                    }
                    oriObj.pin === undefined && console.log(he.decode("Imposible ejecutar " + oriObj.id + ". Configure par&aacute;metros de entrada."));
                    oriObj.pout === undefined && console.log(he.decode("Imposible ejecutar " + oriObj.id + ". Configure par&aacute;metros de salida."));
                }
                else {
                    toasty('', 'No fue posible ejecutar el servicio, falta configuraci&oacute;n.', 'error');
                }
            }
        }
        function exportfe(view) {
            var o = getOpts();
            showHideLoading(o, true);
            var xml = "";
            if (view === true) {
                xml = xmlToString(o, true);
                if (xml !== null)
                    Modal("Plantilla Xml", "<textarea rows=\"20\" style=\"width: 100%; border: 0px;\">" + xml + "</textarea>");
            }
            else {
                xml = xmlToString(o);
                if (xml !== null) {
                    var blobdata = new Blob([xml], { type: "text/plain; charset=UTF-8" });
                    var titulo = o.appvm[o.appvm.idPlantilla()].titulo();
                    if (!titulo.length) titulo = "Plantilla";
                    if (window.navigator.msSaveOrOpenBlob) {
                        window.navigator.msSaveBlob(blobdata, titulo + ".xml");
                    }
                    else {
                        var elem = window.document.createElement("a");
                        elem.href = window.URL.createObjectURL(blobdata);
                        elem.download = titulo + ".xml";
                        document.body.appendChild(elem);
                        elem.click();
                        document.body.removeChild(elem);
                    }
                }
            }
            showHideLoading(o, false);
        }
        function extractInnerDataForService2(sb, o) {
            for (var id in o.appvm) {
                if (id.indexOf("formElec_element") > -1) {
                    var idu = o.appvm[id].idunico();
                    if (!_.isEmpty(idu) && idu.indexOf(sb.prefijoentrada) >= 0) {
                        var tipo = o.appvm[id].tipo(), fv = "";
                        idu = idu.replace(sb.prefijoentrada, "");
                        if (tipo === o.TE.Tabla) {
                            var jparam = [];
                            for (var k = 0; k < o.appvm[id].valorjson().length; k++) {
                                var row = o.appvm[id].valorjson()[k], jr = {};
                                for (var r in row)
                                    if (r.indexOf("formElec_") >= 0 && o.appvm[r] && o.appvm[r].idunico && !!o.appvm[r].idunico() && row[r].valormetadato)
                                        jr[o.appvm[r].idunico()] = row[r].valormetadato();
                                !_.isEmpty(jr) && jparam.push(jr);
                            }
                            fv = JSON.stringify(jparam);
                        }
                        else if (tipo === o.TE.Imagen)
                            !!o.appvm[id].anexo && !!o.appvm[id].anexo() && (fv = o.appvm[id].anexo().guidanexo);
                        else if (_.includes([o.TE.HuellaDigital, o.TE.Documento], tipo)) {
                            var guids = [];
                            for (var i = 0; i < o.appvm.listAnexos().length; i++)
                                //if (o.appvm.listAnexos()[i].ElementoId === id && o.appvm.listAnexos()[i].Extension === "wsq")
                                guids.push(o.appvm.listAnexos()[i].GuidAnexo);
                            fv = guids.join(",");
                        }
                        else if (o.appvm[id].valormetadato)
                            fv = o.appvm[id].valormetadato();
                        sb.data || (sb.data = {});
                        sb.data[idu] = fv;
                    }
                }
            }
        }
        function extractOutterDataForService2(sb, o) {
            for (var id in o.appvm) {
                if (id.indexOf("formElec_element") > -1) {
                    var idu = o.appvm[id].idunico();
                    if (!_.isEmpty(idu) && idu.indexOf(sb.prefijosalida) >= 0) {
                        var tipo = o.appvm[id].tipo();
                        idu = idu.replace(sb.prefijosalida, "");
                        if (sb.data[idu] !== undefined) {
                            var fv = sb.data[idu];
                            if (tipo === o.TE.ComboBoxTemporal) o.appvm[id].catalogotemp(fv);
                            else if (tipo === o.TE.Lista) {
                                fv = !fv ? [] : fv.toString().split(","); var selopts = [];
                                fv.length > 0 && (selopts = _.filter(o.datatags.allitemscatalogs[o.appvm[id].fuentedatos() + "|" + o.appvm[id].catalogoorigen()], function (elm) {
                                    return _.includes(fv, elm.Valor);
                                }));
                                o.appvm[id].chosenitemsRule(o.appvm[id].tipolista() === "checkbox" ? selopts : selopts[0]);
                                if (o.appvm[id].tipolista() === "combo" && !!selopts[0]) o.appvm[id].optionselectedRule(selopts[0].Valor);
                            }
                            else if (tipo === o.TE.Tabla) {
                                var mat = !_.isEmpty(fv) ? fv instanceof Array ? fv : JSON.parse(fv) : [];
                                actionRowTable(id, ['serviceimport', mat]);
                            }
                            else if (tipo === o.TE.OCR) {
                                o.appvm[id].idvalidation(fv);
                            }
                            else if (tipo === o.TE.Imagen) {
                                !!fv && setTimeout(createAttachment(o, id, "jpg", fv, "", false, false), 500);
                            }
                            else o.appvm[id].valor && o.appvm[id].valor(fv);
                        }
                    }
                }
            }
        }
        //metodo que quita el render de un elemento para evitar tener tanto control en el browser
        function elementUnrender(id, o) {
            for (var i = 0; i < o.jobj.elemento.elementos.elemento.length; i++) {
                var pageid = o.jobj.elemento.elementos.elemento[i]["@idelemento"];
                if (id === pageid) {
                    if (o.jobj.elemento.elementos.elemento[i].elementos && o.jobj.elemento.elementos.elemento[i].elementos.elemento)
                        for (var j = 0; j < o.jobj.elemento.elementos.elemento[i].elementos.elemento.length; j++)
                            elementRecursiveUnrender(o.jobj.elemento.elementos.elemento[i].elementos.elemento[j], o);
                    break;
                }
            }
        }
        function elementRecursiveUnrender(jelem, o) {
            o.appvm[jelem["@idelemento"]] && o.appvm[jelem["@idelemento"]].elementrendered && o.appvm[jelem["@idelemento"]].elementrendered(!1);
            if (jelem.elementos && jelem.elementos.elemento)
                for (var i = 0; i < jelem.elementos.elemento.length; i++)
                    elementRecursiveUnrender(jelem.elementos.elemento[i], o);
        }
        //Descomprime los datos del servidor y llena el modelo
        //data: datos comprimidos del servidor
        function fillMetadatosXml(data) {
            console.log("fillMetadatosXml"), showHideLoading(o, !1);
            o = getOpts();
            var alldata = JSON.parse(pako.inflate(atob(data), { to: "string", raw: true }));
            o.datatags.elementAtt = alldata.elementAtt,
                o.datatags.reglasInfoDocUsr = alldata.modulos.Reglas.VariablesReglas,
                o.datatags.condicionesReglas = alldata.modulos.Reglas.Condiciones,
                o.datatags.accionesreglas = alldata.modulos.Reglas.Acciones,
                o.datatags.componentsList = getComponentsList(),
                o.datatags.servicesList = JSON.parse(alldata.modulos.Servicios),
                o.datatags.catext = alldata.catext,
                o.datatags.metadatos = alldata.metadatos,
                o.datatags.plantillas = alldata.plantillas,
                o.datatags.catalogos = alldata.catalogos,
                o.datatags.catalogosdocumento = alldata.catalogosdocumento,
                o.datatags.tipodochijos = alldata.tipodochijos,
                o.datatags.metadatoshijos = alldata.metadatoshijos,
                o.datatags.tareas = alldata.tareas,
                o.datatags.permisos = alldata.permisos,
                o.datatags.flujosR = alldata.flujosR,
                o.datatags.ticket = alldata.ticket,
                o.datatags.allitemscatalogs = alldata.itemCatalogos,
                o.datatags.allitemscatalogs["catalogos|9999"] = alldata.tipodochijos;

            alterNewElements(o), alterNewServices(o), alterNewComponents(o), alterNewRules(o);

            updatePlantillaTag(o);
            if (o.datasend.obtieneConfigurador) {
                drawInsertElements(o), drawStyles(o), showHideLoading(o, false);
                o.datasend.idPlantilla = alldata.plantillaData.idPlantilla ? alldata.plantillaData.idPlantilla : 0;
                o.datatags.fieldsbypdf = alldata.pdfCampos;
                if (alldata.plantillaData.Plantilla && alldata.plantillaData.Plantilla.length && _.startsWith(alldata.plantillaData.Plantilla, '<elemento')) {
                    var oldj = o.jobj;
                    o.jobj = parser.parse(alldata.plantillaData.Plantilla.replace(/&amp;/g, '&'), o.jsonoptions);
                    !o.jobj && (o.jobj = oldj);
                    o.xml = alldata.plantillaData.Plantilla; //guardado del xml lineal para hacer busqueda
                }
                if (o.jobj.elemento["@versionguardadoplantilla"] && o.jobj.elemento["@versionguardadoplantilla"] > o.versionnum)
                    Error("Plantila mas actualizada", "No es posible cargar esta plantilla porque la version de esta plantilla es: " + o.jobj.elemento["@versionguardadoplantilla"] + " y la version del js de Formatos es: " + o.versionnum + " si esta intentanto cargar una plantilla configurada en una version mas nueva de otro portal, primero actualice su portal porque puede hacer que se pierdan las configuraciones de su plantilla."), showHideLoading(o, false);
                else
                    revaluateDataJson(o), update(o);
            }
            else {
                o.finishload = !1;
                o.datasend.guid = alldata.formatoData.Guid ? alldata.formatoData.Guid : o.datasend.guid;
                o.datasend.docId = alldata.formatoData.DocID ? alldata.formatoData.DocID : o.datasend.docId;
                o.datasend.instanciaId = alldata.formatoData.InstanciaId ? alldata.formatoData.InstanciaId : 0;
                _.forEach(o.datatags.reglasInfoDocUsr, function (rif) {
                    rif.Valor.toLowerCase() === "guidformato" && o.datasend.guid && (rif.Esquema = o.datasend.guid);
                });
                alldata.formatoData.Xml = alldata.formatoData.Xml.replace(/&amp;/g, '&');
                console.log("Parsing xml");
                o.jobj = parser.parse(alldata.formatoData.Xml, o.jsonoptions);
                o.xml = alldata.formatoData.Xml; //guardado del xml lineal para hacer busqueda
                console.log("Parsed xml");
                o.appvm.listAnexos(alldata.formatoData.Anexos ? alldata.formatoData.Anexos : []);
                revaluateDataJson(o, alldata.formatoData.JsonDatos);
                if (o.jobj) previewAll(o);
                else Error("No se encontr&oacute; el formato electr&oacute;nico", "Hubo un error al obtener el formato electr&oacute;nico, favor de intentar m&aacute;s tarde.");
                updateOpts(o, true);
            }
            console.log("Termino ObtieneMetadatos");
        }
        function findMethodByElementType(o, jelem, enumMethodType, params) {
            var tipo = jelem["@tipoelemento"], finded, idparent, parentjson;
            if (tipo === "metodo") return;
            if (tipo === o.TE.Pagina) {
                if (enumMethodType === o.methodType.drawHtml) {
                    var pagids = o.appvm[o.idPlantilla].pagids();
                    pagids.push(params[2]);
                    o.appvm[o.idPlantilla].pagids(pagids);
                    params[1][0].nodeValue = 'ko component: { name: "elemento-' + tipo + '", params: { id: "' + params[2] + '", tipo: "' + tipo + '" } }';
                    params[1].appendTo(params[0]);
                    ko.applyBindings(o.appvm, params[1][0]);
                    if (!params[3]) {
                        if (!o.appvm[params[2]].elementopadre().length) o.appvm[params[2]].elementopadre(o.jobj.elemento["@idelemento"]);
                        if (o.jobj.elemento.elementos === undefined || o.jobj.elemento.elementos.elemento === undefined)
                            o.jobj.elemento.elementos = { elemento: [] };
                        o.jobj.elemento.elementos.elemento.push(jelem);
                        //primer pagina a pintar para mostrar desde el principio en modo configurador
                        if (o.jobj.elemento.elementos.elemento.length === 1)
                            showPage(params[2]);
                    }
                    return true;
                }
                if (enumMethodType === o.methodType.getParent)
                    return o.plantilla;
            }
            else if (_.includes([o.TE.Seccion, o.TE.Tabla, o.TE.Tabber], tipo)) {
                if (enumMethodType === o.methodType.drawHtml) {
                    finded = !1, idparent = "";
                    if (params[0].length === 2) {
                        idparent = params[0][0].nodeValue.match(/id:\s*"\w+"/g);
                        if (idparent.length) {
                            idparent = idparent[0];
                            idparent = idparent.substring(idparent.indexOf("\"") + 1, idparent.lastIndexOf("\""));
                            o.appvm[idparent] && (finded = !0, params[0][0] = $(params[0][0]), params[0][1] = $(params[0][1]));
                        }
                    } else {
                        idparent = params[0].attr("id");
                        if (o.appvm[idparent])
                            finded = true;
                    }
                    if (finded === true) {
                        params[1][0].nodeValue = 'ko component: { name: "elemento-' + tipo + '", params: { id: "' + params[2] + '", tipo: "' + tipo + '" } }';
                        if (params[0].length === 2)
                            params[0][1].before($('<div class="childko" data-id="' + idparent + '"></div>').append(params[1]));
                        else
                            params[1].appendTo(findContainerParent(params[0], o));
                        if (!params[3]) {
                            if (!o.appvm[params[2]].elementopadre().length) o.appvm[params[2]].elementopadre(idparent);
                            parentjson = searchElementInJson(o, idparent);
                            if (parentjson.elementos === undefined || typeof parentjson.elementos === "string")
                                parentjson.elementos = { elemento: [] };
                            if (parentjson.elementos.elemento === undefined)
                                parentjson.elementos.elemento = [];
                            parentjson.elementos.elemento.push(jelem);
                            ko.applyBindings(o.appvm, params[1][0]);
                        }
                    } else {
                        toasty("", "Debe agregar o seleccionar una p&aacute;gina antes de agregar elementos");
                        return !0;
                    }
                    return !0;
                }
            }

            //Seccion para todos los elementos
            if (enumMethodType === o.methodType.drawHtml) {
                finded = false;
                idparent = "";
                if (params[0].length === 2) {
                    idparent = params[0][0].nodeValue.match(/["]*id["]*:\s*"\w+"/g);
                    if (idparent.length) {
                        idparent = idparent[0];
                        idparent = idparent.match(/formElec_\w+/g);
                        if (idparent.length) {
                            idparent = idparent[0];
                            if (o.appvm[idparent]) {
                                finded = true;
                                params[0][0] = $(params[0][0]);
                                params[0][1] = $(params[0][1]);
                            }
                        }
                    }
                } else {
                    idparent = $(params[0]).attr("id");
                    if (o.appvm[idparent])
                        finded = true;
                }
                if (finded === true) {
                    if (o.appvm[params[2]]) {
                        var p = { tipo: tipo, id: params[2], subelement: "elemento-" + tipo };
                        if (_.includes([o.TE.Moneda, o.TE.Password, o.TE.CodigoBarras], tipo)) p.subelement = "elemento-textogenerico";
                        if (_.includes([o.TE.Moneda], tipo)) p.subelement = "elemento-moneda";
                        params[1][0].nodeValue = 'ko component: { name: "elemento-generico", params: ' + JSON.stringify(p) + " }";
                        if (_.includes([o.TE.Logo], tipo))
                            params[1][0].nodeValue = 'ko component: { name: "elemento-' + tipo + '", params: ' + JSON.stringify(p) + " }";
                        if (params[0].length === 2)
                            params[0][1].before($('<div class="childko" data-id="' + idparent + '"></div>').append(params[1]));
                        else params[1].appendTo(findContainerParent(params[0], o));
                        if (!params[3]) {
                            if (!o.appvm[params[2]].elementopadre().length) o.appvm[params[2]].elementopadre(idparent);
                            parentjson = searchElementInJson(o, idparent);
                            if (parentjson.elementos === undefined || typeof parentjson.elementos === "string")
                                parentjson.elementos = { elemento: [] };
                            if (parentjson.elementos.elemento === undefined)
                                parentjson.elementos.elemento = [];
                            parentjson.elementos.elemento.push(jelem);
                            ko.applyBindings(o.appvm, params[1][0]);
                        }
                    } else removeElement(params[2]);
                } else {
                    toasty("", "Debe agregar o seleccionar una p&aacute;gina antes de agregar elementos");
                }
                return true;
            }
            if (enumMethodType === o.methodType.getParent) {
                if (!params[0]) {
                    if (o.appvm[jelem["@idelemento"]]) {
                        var parentid = o.appvm[jelem["@idelemento"]].elementopadre();
                        var parent = o.plantilla.find("[id='" + parentid + "']");

                        if (parent.length) return parent;
                        else return findNodeKoParent($("div#" + getElementByTypeByParents(o, parentid, o.TE.Pagina)), parentid);
                    }
                    return $("<div></div>");
                } else
                    return $(params[0]);
            }
            return true;
        }
        function findNodeKoParent(node, id) {
            var koparent = [];
            var finded = false;
            node.each(function (i, objNode) {
                var objChildNode = objNode.firstChild;

                while (objChildNode) {
                    if (objChildNode.nodeType === 8 && objChildNode.nodeValue.indexOf("\"" + id + "\"") !== -1) { //initial ko
                        koparent.push(objChildNode);
                        finded = true;
                    } else if (objChildNode.nodeType === 8 && finded === true) { //ending ko
                        koparent.push(objChildNode);
                        return;
                    } else if (objChildNode.nodeType === 1 && koparent.length === 0) {
                        koparent = findNodeKoParent($(objChildNode), id);
                        if (koparent.length === 2)
                            return;
                    }
                    objChildNode = objChildNode.nextSibling;
                }
            });
            return koparent;
        }
        function findContainerParent(parent, o) {
            if (parent.is(".section")) return parent.find(" > .section-body");
            else if (parent.is(".tabla")) return parent.find(" > .tabla-body");
            else if (parent.is(".tabber")) return parent.find(" > .tabber-body");
            return parent;
        }
        function findParentContainer(parent) {
            if (parent.is(".section-body")) return parent.parent(".section");
            else if (parent.is(".tabla-body")) return parent.parent(".tabla");
            else if (parent.is(".tabber-body")) return parent.parent(".tabber");
            return parent;
        }
        function getOpts() {
            var o = contglobal.data("editor_opts_beteam");
            return o ? o : null;
        }
        function getComponentsList() {
            var xx = [o.TE.Audio, o.TE.Boton, o.TE.CodigoBarras, o.TE.Deslizante, o.TE.Fecha, o.TE.FirmaFAD, o.TE.Hora, o.TE.HuellaDigital,
            o.TE.Imagen, o.TE.Leyenda, o.TE.Lista, o.TE.ComboBoxTemporal, o.TE.Logico, o.TE.Moneda, o.TE.Numero, o.TE.Password, o.TE.RangoFechas,
            o.TE.Tabla, o.TE.Texto, o.TE.TextArea, o.TE.Video, o.TE.Wizard, o.TE.Documento, o.TE.CodigoQR, o.TE.ComboDinamico]
            var list = [
                //Encriptar
                {
                    "id": 1,
                    "name": "Encriptador de texto (Sirve para encriptar texto a Sha-512 hacia un campo del formato)",
                    "pin": {
                        "method": [
                            {
                                "order": 1,
                                "name": "Texto a encriptar",
                                "controltype": "elem",
                                "options": [o.TE.Fecha, o.TE.Hora, o.TE.Leyenda, o.TE.Lista, o.TE.ComboBoxTemporal, o.TE.Logico, o.TE.Moneda, o.TE.Numero, o.TE.Password, o.TE.RangoFechas, o.TE.Texto, o.TE.TextArea, o.TE.CodigoQR, o.TE.ComboDinamico],
                                "value": ""
                            },
                            {
                                "order": 2,
                                "name": "Tipo de encriptaci&oacute;n",
                                "controltype": "selector",
                                "options": { "SHA512": "SHA 512" },
                                "value": ""
                            }
                        ]
                    },
                    "pout": [
                        {
                            "order": 1,
                            "name": "Texto encriptado",
                            "controltype": "elem",
                            "options": [o.TE.Password, o.TE.Texto, o.TE.TextArea],
                            "value": ""
                        }
                    ]
                },
                //Validación documentos
                {
                    "id": 2,
                    "name": "Validador de documento INE OBSOLETO YA NO SIRVE",
                    "pin": {
                        "method": []
                    },
                    "pout": [
                        {
                            "order": "Nombres",
                            "name": "Nombre(s)",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": "ApellidoPaterno",
                            "name": "Apellido paterno",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": "ApellidoMaterno",
                            "name": "Apellido materno",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": "CURP",
                            "name": "CURP",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": "ClaveElector",
                            "name": "Clave electoral",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": "NumeroEmisionCredencial",
                            "name": "N&uacute;mero emisi&oacute;n credencial",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea, o.TE.Numero],
                            "value": ""
                        },
                        {
                            "order": "OCR",
                            "name": "OCR",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": "CIC",
                            "name": "CIC",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": "CveEstado",
                            "name": "Cve estado",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea, o.TE.Numero],
                            "value": ""
                        },
                        {
                            "order": "NombreEstado",
                            "name": "Estado",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": "Calle",
                            "name": "Calle",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": "NoExterior",
                            "name": "No. exterior",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea, o.TE.Numero],
                            "value": ""
                        },
                        {
                            "order": "NoInterior",
                            "name": "No. interior",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea, o.TE.Numero],
                            "value": ""
                        },
                        {
                            "order": "NombreMunicipio",
                            "name": "Municipio",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": "NombreLocalidad",
                            "name": "Localidad",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": "CP",
                            "name": "C&oacute;digo postal",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea, o.TE.Numero],
                            "value": ""
                        },
                        {
                            "order": "NombrePais",
                            "name": "Pa&iacute;s",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": "ImagenIneAnverso",
                            "name": "Im&aacute;gen INE Anverso",
                            "controltype": "elem",
                            "options": [o.TE.Imagen, o.TE.Documento],
                            "value": ""
                        },
                        {
                            "order": "ImagenIneReverso",
                            "name": "Im&aacute;gen INE Reverso",
                            "controltype": "elem",
                            "options": [o.TE.Imagen, o.TE.Documento],
                            "value": ""
                        }
                    ]
                },
                //OCR
                {
                    "id": 3,
                    "name": "OCR AT&T OBSOLETO YA NO SIRVE",
                    "pin": {
                        "method": []
                    },
                    "pout": [
                        {
                            "order": 1,
                            "name": "folio",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea, o.TE.Numero],
                            "value": ""
                        },
                        {
                            "order": 2,
                            "name": "numcuenta",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea, o.TE.Numero],
                            "value": ""
                        },
                        {
                            "order": 3,
                            "name": "destinatario",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 4,
                            "name": "cliente",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 5,
                            "name": "numvision",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 6,
                            "name": "totalradios",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 7,
                            "name": "calle",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 8,
                            "name": "colonia",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 9,
                            "name": "delegacion",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 10,
                            "name": "ciudad",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 11,
                            "name": "cp",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 12,
                            "name": "imagenanverso",
                            "controltype": "elem",
                            "options": [o.TE.Imagen, o.TE.Documento],
                            "value": ""
                        },
                        {
                            "order": 13,
                            "name": "imagenreverso",
                            "controltype": "elem",
                            "options": [o.TE.Imagen, o.TE.Documento],
                            "value": ""
                        }
                    ]
                },
                //OCR
                {
                    "id": 4,
                    "name": "OCR INE OBSOLETO YA NO SIRVE",
                    "pin": {
                        "method": [
                            {
                                "order": 1,
                                "name": "Ancla para detectar nombre",
                                "controltype": "text",
                                "value": "Nombre"
                            },
                            {
                                "order": 2,
                                "name": "Ancla para detectar domicilio",
                                "controltype": "text",
                                "value": "Domicilio"
                            },
                            {
                                "order": 3,
                                "name": "Ancla para detectar CURP",
                                "controltype": "text",
                                "value": "CURP"
                            },
                            {
                                "order": 4,
                                "name": "Ancla para detectar secci&oacute;n",
                                "controltype": "text",
                                "value": "Seccion"
                            },
                            {
                                "order": 5,
                                "name": "Ancla para detectar clave electoral",
                                "controltype": "text",
                                "value": "Clave de Elector"
                            },
                            {
                                "order": 6,
                                "name": "Ancla para detectar vigencia",
                                "controltype": "text",
                                "value": "Vigencia"
                            },
                            {
                                "order": 7,
                                "name": "Ancla para detectar sexo",
                                "controltype": "text",
                                "value": "Sexo"
                            },
                            {
                                "order": 8,
                                "name": "Ancla para detectar folio",
                                "controltype": "text",
                                "value": "Folio"
                            },
                            {
                                "order": 9,
                                "name": "Ancla para detectar emisi&oacute;n",
                                "controltype": "text",
                                "value": "Emision"
                            },
                            {
                                "order": 10,
                                "name": "Ancla para detectar registro",
                                "controltype": "text",
                                "value": "Registro"
                            },
                            {
                                "order": 11,
                                "name": "Ancla para detectar municipio",
                                "controltype": "text",
                                "value": "Municipio"
                            },
                            {
                                "order": 12,
                                "name": "Ancla para detectar localidad",
                                "controltype": "text",
                                "value": "Localidad"
                            },
                            {
                                "order": 13,
                                "name": "Ancla para detectar estado",
                                "controltype": "text",
                                "value": "Estado"
                            },
                            {
                                "order": 14,
                                "name": "Ancla para detectar CIC",
                                "controltype": "text",
                                "value": "CIC"
                            }
                        ]
                    },
                    "pout": [
                        {
                            "order": 1,
                            "name": "nombre",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 2,
                            "name": "apellidopaterno",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 3,
                            "name": "apellidomaterno",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 4,
                            "name": "calle",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 5,
                            "name": "colonia",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 6,
                            "name": "delegacion",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 7,
                            "name": "ciudad",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 8,
                            "name": "codigopostal",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 9,
                            "name": "curp",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 10,
                            "name": "rfc",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 11,
                            "name": "seccion",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 12,
                            "name": "claveelectoral",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 13,
                            "name": "vigencia",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 14,
                            "name": "fechanacimiento",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 15,
                            "name": "edad",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 16,
                            "name": "sexo",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 17,
                            "name": "folio",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 18,
                            "name": "registro",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 19,
                            "name": "municipio",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 20,
                            "name": "localidad",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 21,
                            "name": "reposicion",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 22,
                            "name": "emision",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 23,
                            "name": "estado",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 24,
                            "name": "cic",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 25,
                            "name": "numeroocr",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 26,
                            "name": "imagenanverso",
                            "controltype": "elem",
                            "options": [o.TE.Imagen, o.TE.Documento],
                            "value": ""
                        },
                        {
                            "order": 27,
                            "name": "imagenreverso",
                            "controltype": "elem",
                            "options": [o.TE.Imagen, o.TE.Documento],
                            "value": ""
                        }
                    ]
                },
                //OCR
                {
                    "id": 5,
                    "name": "OCR CFE OBSOLETO YA NO SIRVE",
                    "pin": {
                        "method": [
                            {
                                "order": 1,
                                "name": "Ancla para detectar documento",
                                "controltype": "text",
                                "value": "Nombre"
                            }
                        ]
                    },
                    "pout": [
                        {
                            "order": 1,
                            "name": "nombre",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 2,
                            "name": "calle",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 3,
                            "name": "delegacion",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 4,
                            "name": "ciudad",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 5,
                            "name": "imagenanverso",
                            "controltype": "elem",
                            "options": [o.TE.Imagen, o.TE.Documento],
                            "value": ""
                        },
                        {
                            "order": 6,
                            "name": "imagenreverso",
                            "controltype": "elem",
                            "options": [o.TE.Imagen, o.TE.Documento],
                            "value": ""
                        }
                    ]
                },
                //OCR
                {
                    "id": 6,
                    "name": "OCR CEA OBSOLETO YA NO SIRVE",
                    "pin": {
                        "method": [
                            {
                                "order": 1,
                                "name": "Ancla para detectar orden de servicio",
                                "controltype": "text",
                                "value": "Nombre"
                            },
                            {
                                "order": 2,
                                "name": "Ancla para detectar datos generales registrados",
                                "controltype": "text",
                                "value": "Nombre"
                            },
                            {
                                "order": 3,
                                "name": "Ancla para detectar datos de medidor",
                                "controltype": "text",
                                "value": "Nombre"
                            },
                            {
                                "order": 4,
                                "name": "Ancla para detectar solicitud",
                                "controltype": "text",
                                "value": "Nombre"
                            }
                        ]
                    },
                    "pout": [
                        {
                            "order": 1,
                            "name": "ordennumero",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 2,
                            "name": "ordenfecha",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 3,
                            "name": "origen",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 4,
                            "name": "nombre",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 5,
                            "name": "contrato",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 6,
                            "name": "grupo",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 7,
                            "name": "uso",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 8,
                            "name": "generaldiametro",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 9,
                            "name": "metros",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 10,
                            "name": "localizacion",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 12,
                            "name": "domicilio",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 13,
                            "name": "ultimopago",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 14,
                            "name": "adeudo",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 15,
                            "name": "mesesadeudo",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 16,
                            "name": "normalidad",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 17,
                            "name": "informativopredio",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 18,
                            "name": "formalimitacion",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 19,
                            "name": "numero",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 20,
                            "name": "marca",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 21,
                            "name": "medidordiametro",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 22,
                            "name": "tipomedidor",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 23,
                            "name": "tipolectura",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 24,
                            "name": "digitos",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 25,
                            "name": "tipoproteccion",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 26,
                            "name": "revisiones",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 27,
                            "name": "ubicacion",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 28,
                            "name": "fechainstalacion",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 29,
                            "name": "formainstalacion",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 30,
                            "name": "fechaultimoservicio",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 31,
                            "name": "sello",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 32,
                            "name": "ultimalimitacion",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 33,
                            "name": "matcalle",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 34,
                            "name": "matbanqueta",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 35,
                            "name": "solicitudnumero",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 36,
                            "name": "solicitudfecha",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 37,
                            "name": "imagenanverso",
                            "controltype": "elem",
                            "options": [o.TE.Imagen, o.TE.Documento],
                            "value": ""
                        },
                        {
                            "order": 38,
                            "name": "imagenreverso",
                            "controltype": "elem",
                            "options": [o.TE.Imagen, o.TE.Documento],
                            "value": ""
                        }
                    ]
                },
                //OCR
                {
                    "id": 7,
                    "name": "OCR Telmex OBSOLETO YA NO SIRVE",
                    "pin": {
                        "method": [
                            {
                                "order": 1,
                                "name": "Ancla para detectar nombre",
                                "controltype": "text",
                                "value": "Nombre"
                            }
                        ]
                    },
                    "pout": [
                        {
                            "order": 1,
                            "name": "nombre",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 2,
                            "name": "apellidopaterno",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 3,
                            "name": "apellidomaterno",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 4,
                            "name": "calle",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 5,
                            "name": "colonia",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 6,
                            "name": "delegacion",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 7,
                            "name": "imagenanverso",
                            "controltype": "elem",
                            "options": [o.TE.Imagen, o.TE.Documento],
                            "value": ""
                        },
                        {
                            "order": 8,
                            "name": "imagenreverso",
                            "controltype": "elem",
                            "options": [o.TE.Imagen, o.TE.Documento],
                            "value": ""
                        }
                    ]
                },
                //OCR
                {
                    "id": 12,
                    "name": "OCR Visa OBSOLETO YA NO SIRVE",
                    "pin": {
                        "method": []
                    },
                    "pout": [
                        {
                            "order": 1,
                            "name": "clasevisa",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 2,
                            "name": "tipovisa",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 3,
                            "name": "apellidopaterno",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 4,
                            "name": "apellidomaterno",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 5,
                            "name": "nombre",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 6,
                            "name": "fechanacimiento",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 7,
                            "name": "nacionalidad",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 8,
                            "name": "sexo",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 9,
                            "name": "fechaexpedicion",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 10,
                            "name": "expira",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 11,
                            "name": "imagenanverso",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 12,
                            "name": "imagenreverso",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        }
                    ]
                },
                //OCR
                {
                    "id": 13,
                    "name": "OCR Pasaporte OBSOLETO YA NO SIRVE",
                    "pin": {
                        "method": []
                    },
                    "pout": [
                        {
                            "order": 1,
                            "name": "pais",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 2,
                            "name": "numero",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 3,
                            "name": "apellidopaterno",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 4,
                            "name": "apellidomaterno",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 5,
                            "name": "nombre",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 6,
                            "name": "nacionalidad",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 8,
                            "name": "fechanacimiento",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 10,
                            "name": "sexo",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 13,
                            "name": "caducidad",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 14,
                            "name": "imagenanverso",
                            "controltype": "elem",
                            "options": [o.TE.Imagen, o.TE.Documento],
                            "value": ""
                        },
                        {
                            "order": 15,
                            "name": "imagenreverso",
                            "controltype": "elem",
                            "options": [o.TE.Imagen, o.TE.Documento],
                            "value": ""
                        }
                    ]
                },
                //Datos CURP
                {
                    "id": 8,
                    "name": "Obtener datos CURP (Sirve para extraer de la CURP ciertos datos y ponerlos en el formato)",
                    "pin": {
                        "method": [
                            {
                                "order": 1,
                                "name": "CURP",
                                "controltype": "elem",
                                "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                                "value": ""
                            }
                        ]
                    },
                    "pout": [
                        {
                            "order": 1,
                            "name": "Fecha de nacimiento",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 2,
                            "name": "G&eacute;nero",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 3,
                            "name": "Entidad de nacimiento",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 4,
                            "name": "Homoclave",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        }
                    ]
                },
                //Datos RFC
                {
                    "id": 9,
                    "name": "Obtener datos RFC (Sirve para extraer del RFC ciertos datos y ponerlos en el formato)",
                    "pin": {
                        "method": [
                            {
                                "order": 1,
                                "name": "RFC",
                                "controltype": "elem",
                                "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                                "value": ""
                            }
                        ]
                    },
                    "pout": [
                        {
                            "order": 1,
                            "name": "Fecha de nacimiento",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        },
                        {
                            "order": 2,
                            "name": "Homoclave",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                            "value": ""
                        }
                    ]
                },
                //Marcar documentos
                {
                    "id": 10,
                    "name": "Marcar documentos en checkbox (Quien sabe para que sirve)",
                    "pin": {
                        "method": [
                            {
                                "order": 1,
                                "name": "Documentos",
                                "controltype": "elem",
                                "options": [o.TE.Lista, o.TE.Documento],
                                "value": ""
                            }
                        ]
                    },
                    "pout": [
                        {
                            "order": 1,
                            "name": "Lista de documentos",
                            "controltype": "elem",
                            "options": [o.TE.Lista, o.TE.Documento],
                            "value": ""
                        }
                    ]
                },
                //Relación filas de tablas con tipo de documento
                {
                    "id": 11,
                    "name": "Relacionar tablas con tipos de documento en elemento documento (Quien sabe para que sirve)",
                    "pin": {
                        "method": [
                            {
                                "order": 1,
                                "name": "Configuraci&oacute;n",
                                "controltype": "text",
                                "options": xx,
                                "value": ""
                            },
                            {
                                "order": 2,
                                "name": "Documento",
                                "controltype": "elem",
                                "options": [o.TE.Documento],
                                "value": ""
                            }
                        ]
                    },
                    "pout": ""
                },
                //Aumentar/disminuir fecha
                {
                    "id": 14,
                    "name": "Aumentar/disminuir fecha (Puede cambiar la fecha y ponerla en otro campo)",
                    "pin": {
                        "method": [
                            {
                                "order": 1,
                                "name": "Fecha",
                                "options": [o.TE.Fecha],
                                "value": ""
                            },
                            {
                                "order": 2,
                                "name": "Aumentar/disminuir",
                                "controltype": "selector",
                                "options": {
                                    "aum": "Aumentar",
                                    "dism": "Disminuir"
                                },
                                "value": ""
                            },
                            {
                                "order": 3,
                                "name": "Años",
                                "controltype": "number",
                                "value": "0"
                            },
                            {
                                "order": 4,
                                "name": "Meses",
                                "controltype": "number",
                                "value": "0"
                            },
                            {
                                "order": 5,
                                "name": "D&iacute;as",
                                "controltype": "number",
                                "value": "0"
                            }
                        ]
                    },
                    "pout": [
                        {
                            "order": 1,
                            "name": "Fecha",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.TextArea, o.TE.Fecha],
                            "value": ""
                        }
                    ]
                },
                //Validación de CURP
                {
                    "id": 15,
                    "name": "Validación de CURP (Sirve para comparar los datos de una persona con el CURP capturado y ver si son correctos)",
                    "pin": {
                        "method": [
                            {
                                "order": 1,
                                "name": "Primer Nombre",
                                "controltype": "elem",
                                "options": [o.TE.Password, o.TE.Texto, o.TE.TextArea],
                                "value": ""
                            },
                            {
                                "order": 2,
                                "name": "Segundo Nombre",
                                "controltype": "elem",
                                "options": [o.TE.Password, o.TE.Texto, o.TE.TextArea],
                                "value": ""
                            },
                            {
                                "order": 3,
                                "name": "Apellido Paterno",
                                "controltype": "elem",
                                "options": [o.TE.Password, o.TE.Texto, o.TE.TextArea],
                                "value": ""
                            },
                            {
                                "order": 4,
                                "name": "Apellido Materno",
                                "controltype": "elem",
                                "options": [o.TE.Password, o.TE.Texto, o.TE.TextArea],
                                "value": ""
                            },
                            {
                                "order": 5,
                                "name": "Fecha de Nacimiento",
                                "controltype": "elem",
                                "options": [o.TE.Password, o.TE.Texto, o.TE.TextArea, o.TE.Fecha],
                                "value": ""
                            },
                            {
                                "order": 6,
                                "name": "G&eacute;nero",
                                "controltype": "elem",
                                "options": [o.TE.Password, o.TE.Texto, o.TE.TextArea, o.TE.Lista],
                                "value": ""
                            },
                            {
                                "order": 7,
                                "name": "Entidad de Nacimiento",
                                "controltype": "elem",
                                "options": [o.TE.Password, o.TE.Texto, o.TE.TextArea, o.TE.Lista],
                                "value": ""
                            },
                            {
                                "order": 8,
                                "name": "CURP",
                                "controltype": "elem",
                                "options": [o.TE.Password, o.TE.Texto, o.TE.TextArea],
                                "value": ""
                            }
                        ]
                    },
                    "pout": [
                        {
                            "order": 1,
                            "name": "¿CURP v&aacute;lida?",
                            "controltype": "elem",
                            "options": [o.TE.Password, o.TE.Texto, o.TE.TextArea, o.TE.Logico],
                            "value": ""
                        }
                    ]
                },
                //Convertir de base64 a archivo
                {
                    "id": 16,
                    "name": "Genera Archivo de Base64 (Sirve para utilizar un Base64 recibido por servicio o capturado y convertirlo a la extensión especificada)",
                    "pin": {
                        "method": [
                            {
                                "order": 1,
                                "name": "Base64",
                                "controltype": "elem",
                                "options": [o.TE.Password, o.TE.Texto, o.TE.TextArea, o.TE.Leyenda],
                                "value": ""
                            },
                            {
                                "order": 2,
                                "name": "Extension (sin punto)",
                                "controltype": "text",
                                "options": [o.TE.Password, o.TE.Texto, o.TE.TextArea],
                                "value": ""
                            },
                            {
                                "order": 3,
                                "name": "Nombre Archivo",
                                "controltype": "elem",
                                "options": [o.TE.Password, o.TE.Texto, o.TE.TextArea],
                                "value": ""
                            }
                        ]
                    },
                    "pout": []
                },
                //Descomponer fecha
                {
                    "id": 17,
                    "name": "Descomponer fecha (Descompone la fecha y la coloca en los campos especificados)",
                    "pin": {
                        "method": [
                            {
                                "order": 1,
                                "controltype": "elem",
                                "name": "Fecha",
                                "options": [o.TE.Password, o.TE.Texto, o.TE.TextArea, o.TE.Fecha],
                                "value": ""
                            },
                            {
                                "order": 2,
                                "controltype": "selector",
                                "options": {
                                    "dd": "Con cero",
                                    "d": "Sin cero"
                                },
                                "name": "Formato día"
                            },
                            {
                                "order": 3,
                                "controltype": "selector",
                                "options": {
                                    "mm": "Con cero",
                                    "m": "Sin cero",
                                    "ss": "Con letras",
                                    "s": "Abreviado"
                                },
                                "name": "Formato mes"
                            },
                            {
                                "order": 4,
                                "controltype": "selector",
                                "options": {
                                    "yy": "Cuatro dígitos",
                                    "y": "Dos dígitos"
                                },
                                "name": "Formato año"
                            }
                        ]
                    },
                    "pout": [
                        {
                            "order": 1,
                            "controltype": "elem",
                            "name": "Día",
                            "options": [o.TE.Password, o.TE.Texto, o.TE.TextArea, o.TE.Numero],
                            "value": ""
                        },
                        {
                            "order": 2,
                            "controltype": "elem",
                            "name": "Mes",
                            "options": [o.TE.Password, o.TE.Texto, o.TE.TextArea, o.TE.Numero],
                            "value": ""
                        },
                        {
                            "order": 3,
                            "controltype": "elem",
                            "name": "Año",
                            "options": [o.TE.Password, o.TE.Texto, o.TE.TextArea, o.TE.Numero],
                            "value": ""
                        }
                    ]
                },
                //Validacion por video veri-das
                {
                    "id": 18,
                    "name": "Validación de rostro vivo y documentación con veri-das OBSOLETO YA NO SIRVE",
                    "pin": {
                        "method": [
                            {
                                "order": 1,
                                "name": "Documento a validar",
                                "controltype": "selector",
                                "options": {
                                    "MX2_ID": "INE (Ambos lados)"
                                },
                                "value": ""
                            },
                            {
                                "order": 2,
                                "controltype": "textarea",
                                "name": "Texto para que el usuario diga",
                                "value": "Diga su nombre y apellidos"
                            }
                        ]
                    },
                    "pout": [
                        {
                            "order": 1,
                            "name": "Video grabado",
                            "controltype": "elem",
                            "options": [o.TE.Video, o.TE.Documento],
                            "value": ""
                        }
                    ]
                },
                //Validacion de documentos veri-das
                {
                    "id": 19,
                    "name": "Validación de documentos con veri-das OBSOLETO YA NO SIRVE",
                    "pin": {
                        "method": [
                            {
                                "order": 1,
                                "name": "Documento a validar",
                                "controltype": "selector",
                                "options": {
                                    "MX2_ID": "INE (Ambos lados)"
                                },
                                "value": ""
                            }
                        ]
                    },
                    "pout": [
                        {
                            "order": 1,
                            "name": "Fotografía del Anverso",
                            "controltype": "elem",
                            "options": [o.TE.Imagen, o.TE.Documento]
                        },
                        {
                            "order": 2,
                            "name": "Fotografía del Reverso (si aplica)",
                            "controltype": "elem",
                            "options": [o.TE.Imagen, o.TE.Documento]
                        }
                    ]
                },
                //Validacion de rostro veri-das
                {
                    "id": 20,
                    "name": "Validación de rostro vivo con veri-das OBSOLETO YA NO SIRVE",
                    "pin": {
                        "method": []
                    },
                    "pout": [
                        {
                            "order": 1,
                            "name": "Fotografía del rostro validado",
                            "controltype": "elem",
                            "options": [o.TE.Imagen, o.TE.Documento],
                            "value": ""
                        }
                    ]
                },
                //NetPay
                {
                    "id": 21,
                    "name": "Netpay (Puede realizar pagos con tarjetas) NO FUNCIONA EN WEB",
                    "pin": {
                        "method": [
                            {
                                "order": 1,
                                "name": "Monto a cobrar",
                                "controltype": "elem",
                                "options": [o.TE.Moneda, o.TE.Numero],
                                "value": ""
                            },
                            {
                                "order": 2,
                                "name": "Descripción del cargo",
                                "controltype": "elem",
                                "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                                "value": ""
                            },
                            {
                                "order": 3,
                                "name": "Nombre de la persona",
                                "controltype": "elem",
                                "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                                "value": ""
                            },
                            {
                                "order": 4,
                                "name": "Apellido(s) de la persona",
                                "controltype": "elem",
                                "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                                "value": ""
                            },
                            {
                                "order": 5,
                                "name": "Correo de la persona (por el momento no se esta usando el correo mapeado, sino uno de prueba para los pagos)",
                                "controltype": "elem",
                                "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                                "value": ""
                            },
                            {
                                "order": 6,
                                "name": "Teléfono de la persona (Opcional)",
                                "controltype": "elem",
                                "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                                "value": ""
                            },
                            {
                                "order": 7,
                                "name": "Ciudad",
                                "controltype": "elem",
                                "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                                "value": ""
                            },
                            {
                                "order": 8,
                                "name": "Codigo Postal",
                                "controltype": "elem",
                                "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                                "value": ""
                            },
                            {
                                "order": 9,
                                "name": "Estado",
                                "controltype": "elem",
                                "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                                "value": ""
                            },
                            {
                                "order": 10,
                                "name": "Calle",
                                "controltype": "elem",
                                "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                                "value": ""
                            },
                            {
                                "order": 11,
                                "name": "Folio de transacción (Puede usa el folio del formato o escribir alguno, sino se obtiene un folio, se generará uno",
                                "controltype": "elem",
                                "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea],
                                "value": ""
                            }
                        ]
                    },
                    "pout": [
                        {
                            "order": 1,
                            "name": "Referencia de pago",
                            "controltype": "elem",
                            "options": [o.TE.Texto, o.TE.Password, o.TE.TextArea, o.TE.Numero],
                            "value": ""
                        }
                    ]
                },
                //Ejecutor de RegEx
                {
                    "id": 22,
                    "name": "Ejecutor de expresiones regulares, sirve para limpiar datos de otros campos",
                    "pin": {
                        "method": [
                            {
                                "order": 1,
                                "name": "Expresión Regular",
                                "controltype": "textarea",
                                "value": ""
                            },
                            {
                                "order": 2,
                                "name": "Campo para optener el texto (Opcional si piensa usar el campo de arriba)",
                                "controltype": "elem",
                                "options": xx,
                                "value": ""
                            }
                            // ,
                            // {
                            //     "order": 3,
                            //     "name": "Campo abierto (Opcional si piensa usar un elemento, uselo para probar su expresión)",
                            //     "controltype": "textarea",
                            //     "value": ""
                            // },
                            // {
                            //     "order": 4,
                            //     "name": "Resultado (Solo es para probar su expresión)",
                            //     "controltype": "textarea",
                            //     "value": ""
                            // }
                        ]
                    },
                    "pout": [
                        {
                            "order": 1,
                            "name": "Campo donde ira el resultado",
                            "controltype": "elem",
                            "options": xx,
                            "value": ""
                        }
                    ]
                }
            ];
            return list;
        }
        function getElementTypeAttributes(o, type) {
            for (var i = 0; i < o.datatags.elementAtt.length; i++)
                if (o.datatags.elementAtt[i].NombreElemento.toLowerCase() === type.toLowerCase())
                    return o.datatags.elementAtt[i];
            return null;
        }
        function getElementsPlantilla(idplan, redo) {
            var o = getOpts();
            o.elementsPlantillaToLoad = _.filter(o.elementsPlantillaToLoad, function (f) { return f !== idplan; });
            $.ajax({
                url: o.datasend.urlGlobal + "FEConfigurador.aspx/ObtieneElementsPlantilla",
                data: JSON.stringify({ proyid: o.datasend.proyid, plantid: idplan }),
                success: function (j) {
                    j = j.d;
                    if (j.Success) {
                        o = getOpts();
                        o.datatags.elementosPlantillas[j.ReturnedObject.plantid] = j.ReturnedObject.elementosPlantillas;
                        _.forEach(o.datatags.elementosPlantillas[j.ReturnedObject.plantid], function (n) {
                            _.forEach(o.datatags.plantillas, function (m) {
                                if (j.ReturnedObject.plantid === m.Valor)
                                    n.CatalogoId = m.Nombre;
                            });
                        });
                        updateOpts(o, true);
                        if (redo)
                            o.elementsPlantillaToLoad.length <= 0 ? setAllLoad(o) : getElementsPlantilla(o.elementsPlantillaToLoad[0], true);
                    } else Error(j.Titulo, j.Mensaje);
                },
                error: function (e) { o = getOpts(); errorFormElec(o, e); }
            });
        }
        function getElementByTypeByParents(o, id, tipo) {
            return id ? o.appvm[id].tipo() === o.TE.Plantilla ? "" :
                o.appvm[id].tipo() === tipo ? id :
                    getElementByTypeByParents(o, o.appvm[id].elementopadre(), tipo) : "";
        }
        function getMaxElementByType(o) {
            var max = 1;
            if (o.jobj.elemento.elementos && o.jobj.elemento.elementos.elemento)
                for (var j = 0; j < o.jobj.elemento.elementos.elemento.length; j++) {
                    var currmax = getMaxElementByTypeRecursive(o.jobj.elemento.elementos.elemento[j]);
                    max = currmax > max ? currmax : max;
                }
            return max;
        }
        function getMaxElementByTypeRecursive(elem, typ) {
            var max = 0;
            if (typ && elem["@tipoelemento"] === typ) {
                var t = parseInt(elem["@idelemento"].match(/\d+/g)); max = t > max ? t : max;
            } //mismo tipoelemento se suma
            else {
                var t = parseInt(elem["@idelemento"].match(/\d+/g)); max = t > max ? t : max;
            } //como no se especifico tipoelemento se suma
            if (elem.elementos && elem.elementos.elemento)
                for (var j = 0; j < elem.elementos.elemento.length; j++) {
                    var currmax = getMaxElementByTypeRecursive(elem.elementos.elemento[j], typ);
                    max = currmax > max ? currmax : max;
                }
            return max;
        }
        function getScripts(o, callback) {
            if (o.appvm.isEditor() === true) {
                $.getScript({ url: o.datasend.urlGlobal + "Scripts/FE/quill.js", cache: true });//editor html
            }
            //carga de scripts para creacion de words en macros, firmafad y netpay
            var img = o.xml.match(new RegExp('tipoelemento="imagen'));
            if (o.appvm.isEditor() === false && (img && img.length)) {
                $.getScript({ url: o.datasend.urlGlobal + "Scripts/VC/RecordRTC.js", cache: false });//conexion con docscan
            }
            var hue = o.xml.match(new RegExp('tipoelemento="huelladigital'));
            //var doc = o.xml.match(new RegExp('tipoelemento="documento'));
            if (o.appvm.isEditor() === false && (hue && hue.length)) {
                $.getScript({ url: o.datasend.urlGlobal + "Scripts/FE/signalR.js", cache: true });//conexion con docscan
            }
            var cqr = o.xml.match(new RegExp('tipoelemento="codigoqr'));
            if (cqr && cqr.length) {
                $.getScript({ url: o.datasend.urlGlobal + "Scripts/FE/instascan.min.js", cache: true });//lector de qr
            }
            callback();
        }
        function getParameterQueryByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return '';
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }
        function getTicksOfTime(d) { return ((d.getTime() * 10000) + 621355968000000000) - (d.getTimezoneOffset() * 600000000); }
        //Se obtiene los objetos del servidor para cargar el FE
        //o: el modelo
        function getDataAjax(o) {
            console.log("ObtieneMetadatos"), showHideLoading(o, !0, "Obteniendo datos de la plantilla, por favor espere.");
            o.datasend.obtieneConfigurador = o.drawEditor, o.datasend.withdata = o.drawPreviewer;
            genericAjax("/ConnectService?handler=DoToken", JSON.stringify({})).then((t) => {
                t.token ? genericAjax("/ConnectService?handler=DoGenericService", JSON.stringify({
                    Token: t.token,
                    Request: {
                        initialmethod: "ServiciosDigipro.ServicioFEExtern.FEMetadata",
                        assemblypath: "ServiciosDigipro.dll",
                        data: JSON.stringify({
                            exp: o.datasend.expId,
                            tipodoc: o.datasend.tipoDocId,
                            docid: o.datasend.docId,
                            guid: o.datasend.guid,
                            proy: o.datasend.proyid,
                            user: o.datasend.userId,
                            withconfig: o.datasend.obtieneConfigurador,
                            withdata: o.datasend.withdata,
                            showlog: !0
                        })
                    }
                })).then((rr) => {
                    rr = JSON.parse(rr);
                    console.log(rr.data.log);
                    if (rr.response.success && rr.response.servicesuccess)
                        fillMetadatosXml(rr.data.alldata);
                    else toasty('', rr.response.servicemessage, 'error');
                }) : toasty('', t, 'error');
            });
        }
        function guid() {
            var lut = []; for (var i = 0; i < 256; i++) { lut[i] = (i < 16 ? "0" : "") + (i).toString(16); }

            var d0 = Math.random() * 0xffffffff | 0;
            var d1 = Math.random() * 0xffffffff | 0;
            var d2 = Math.random() * 0xffffffff | 0;
            var d3 = Math.random() * 0xffffffff | 0;
            return lut[d0 & 0xff] + lut[d0 >> 8 & 0xff] + lut[d0 >> 16 & 0xff] + lut[d0 >> 24 & 0xff] + "-" +
                lut[d1 & 0xff] + lut[d1 >> 8 & 0xff] + "-" + lut[d1 >> 16 & 0x0f | 0x40] + lut[d1 >> 24 & 0xff] + "-" +
                lut[d2 & 0x3f | 0x80] + lut[d2 >> 8 & 0xff] + "-" + lut[d2 >> 16 & 0xff] + lut[d2 >> 24 & 0xff] +
                lut[d3 & 0xff] + lut[d3 >> 8 & 0xff] + lut[d3 >> 16 & 0xff] + lut[d3 >> 24 & 0xff];
        }
        function historicalFE() {
            var o = getOpts();
            var ajaxHistorico = function (guidH, mode) {
                $.ajax({
                    url: o.datasend.urlGlobal + "FEConfigurador.aspx/CrudHistorico",
                    data: JSON.stringify({ guidH: guidH, expid: o.datasend.expId, tipodocid: o.datasend.tipoDocId, modo: mode }),
                    success: function (j) {
                        j = j.d;
                        if (j.Success) {
                            switch (mode) {
                                case 1: //consulta lista
                                    drawHistorical(j.ReturnedObject);
                                    break;
                                case 3: //descargar xml
                                    var byteCharacters = window.atob(j.ReturnedObject), byteArrays = [], sliceSize = 512;
                                    for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                                        var slice = byteCharacters.slice(offset, offset + sliceSize), byteNumbers = new Array(slice.length);
                                        for (var i = 0; i < slice.length; i++) byteNumbers[i] = slice.charCodeAt(i);
                                        var byteArray = new Uint8Array(byteNumbers);
                                        byteArrays.push(byteArray);
                                    }
                                    var blobdata = new Blob(byteArrays, { type: "application/txt" });
                                    var titulo = guidH + ".txt";
                                    if (window.navigator.msSaveOrOpenBlob) window.navigator.msSaveOrOpenBlob(blobdata, titulo);
                                    else {
                                        var elem = window.document.createElement("a");
                                        elem.href = window.URL.createObjectURL(blobdata);
                                        elem.download = titulo;
                                        document.body.appendChild(elem), elem.click(), document.body.removeChild(elem);
                                    }
                                    break;
                                case 4: //actualizar plantilla con la seleccionada
                                    importfedata(j.ReturnedObject, o.appvm[o.idPlantilla].titulo());
                                    break;
                                case 5: //eliminar plantilla
                                    toasty('', 'Histórico eliminado exitosamente', 'exito');
                                    o.configModal.find(".noconfiglist").attr("hidden", o.configModal.find(".configlist li").length > 0);
                                    break;
                            }
                        }
                        else Error(j.Titulo, j.Mensaje);
                    },
                    error: function (e) { errorFormElec(o, e); }
                });
            };

            var drawHistorical = function (jsonHist) {
                let count = jsonHist.count, lstH = jsonHist.list;
                var drawHistoricalInList = function (k, val) {
                    var mo = $("<li class='clistrow elem" + k + "' idtag='" + k + "'>\
                        <span class='elelistname w-70 d-inline-block'>" + val + "</span>\
                        <span>\
                            <i class='far fa-trash-alt float-right pl-1' title='Eliminar'></i>\
                            <i class='fas fa-check-double float-right pl-1' title='Actualizar plantilla'></i>\
                            <i class='fas fa-download float-right pl-1' title='Descargar'></i>\
                        </span>\
                    </li>");

                    mo.find(".fa-trash-alt").on("click", function (e) { e.stopPropagation(), Confirmacion('¿Seguro desea eliminar: ' + val + '?', function () { mo.remove(), o.configModal.find("div.collectionelements div[id='elem" + k + "']").remove(), ajaxHistorico(k, 5); }); });
                    mo.find(".fa-upload").on("click", function (e) { e.stopPropagation(), Confirmacion('¿Seguro desea actualizar su plantilla a la del día: ' + val + '? (se recargará la página automáticamente al terminar)', function () { ajaxHistorico(k, 4); }); });
                    mo.find(".fa-download").on("click", function (e) { e.stopPropagation(), ajaxHistorico(k, 3); });
                    mo.on("click", function () {
                        o.configModal.find(".clistrow.selected").removeClass("selected"), mo.addClass("selected"), o.configModal.find("div.collectionelements div[id^='elem']").remove();
                    });
                    o.configModal.find(".configlist").append(mo[0]);
                };
                var filterHistoricalList = function (word, lst) {
                    var filter = !1, ekeys = _.keys(lst);
                    o.configModal.find("div.collectionelements div[id^='elem']").remove();
                    !!word && (filter = !0); o.configModal.find(".clistrow").remove();
                    _.forEach(ekeys, function (v) { (!filter || lst[v].toLowerCase().indexOf(word.toLowerCase()) >= 0) && drawHistoricalInList(v, lst[v]); });
                };
                var lstHKeys = _.keys(lstH), looktime, attrDescr = "<ul>\
                    <li>Para eliminar un hist&oacute;rico, dar clic en el <strong>botón de basura</strong>.</li>\
                    <li>Para regresar a una versi&oacute;n anterior, dar clic en el <strong>botón de flecha arriba</strong>.</li>\
                    <li>Para descargar un XML, dar clic en el <strong>botón de flecha abajo</strong>.</li>\
                    <li style='color: red;'><strong>Es recomendable antes de regresar a una versi&oacute;n anterior, guardar los cambios en la plantilla actual para la generaci&oacute;n \
                    del hist&oacute;rico.</strong></li>\
                    <li style='color: red;'><strong>IMPORTANTE: </strong> el hist&oacute;rico no guarda los archivos subidos en el m&oacute;dulo de Mapeo de Archivos.</li>\
                    <li style='color: red;'>Se recomienda NO tener mas de 100 históricos ya que generan peso y puede que tengan demasiada antigüedad.</li>\
                </ul> ";
                o.configModal = $('<div class="modal">\
                <div class="modal-dialog modal-xl" style="width: 95%; max-width: 95%;">\
                    <div class="modal-content rounded">\
                        <div class="modal-body no-padding row">\
                            <div class="col-md-6 col-sm-12 no-padding">\
                                <div class="col-sm-12 col-12 p-2 d-flex searcherTab">\
                                    <input class="col-sm-12 col-12 rounded-pill border" id="searcherList" placeholder="Buscar...">\
                                    <div class="fas fa-search position-absolute" id="searcherIconList" style="right:6%;cursor:pointer;bottom:30%"></div>\
                                </div>\
                                <div class="py-5 text-center text-muted border-top noconfiglist">Aun no hay guardados anteriores de esta plantilla</div>\
                                <ul class="configlist p-0" style="max-height:75vh; overflow:auto"></ul>\
                            </div>\
                            <div class="col-md-6 col-sm-12">\
                                <h5 class="col-12 py-2 px-0 border-bottom">Hist&oacute;rico de guardados ('+ count + ')</h5>\
                                <div class="pt-2" style="display:inline-flex;">\
                                    <div class="rounded p-2 infotext border text-muted" style="background-color: #f6f8fa;">' + attrDescr + '</div>\
                                </div>\
                            </div>\
                        </div>\
                        <div class="modal-footer p-2 no-border"><div class="modalclose btn btn-light border ml-2 btn-sm">Cerrar</div></div></div>\
                    </div>\
                </div>');
                $("body").append(o.configModal), o.configModal.modal({ keyboard: !1, backdrop: "static", show: !0 });

                o.configModal.find(".noconfiglist").attr("hidden", !_.isEmpty(lstHKeys));
                o.configModal.find(".modalclose").on("click", function () { o.configModal.modal("hide"), o.configModal.remove(), clearInterval(looktime); });
                o.configModal.find("#searcherList").on("keyup", function (e) {
                    clearInterval(looktime);
                    if (e.keyCode === 13) filterHistoricalList(e.target.value.toString(), lstH);
                    else looktime = setInterval(function () { filterHistoricalList(e.target.value.toString(), lstH), clearInterval(looktime); }, 1500);
                });
                o.configModal.find("#searcherIconList").on("click", function (e) {
                    clearInterval(looktime), filterHistoricalList(e.target.value.toString(), lstH);
                });
                o.configModal.find(".infobutton").on("click", function (e) { o.configModal.find(".infotext").slideToggle("fast"); });
                _.forEach(lstHKeys, function (v) { drawHistoricalInList(v, lstH[v]); });
            };

            ajaxHistorico(0, 1);
        }
        function initializeAttrByElems(o, id) {
            var tipo = o.appvm[id].tipo();
            if (tipo === o.TE.Plantilla) {
                //Operaciones matemáticas
                var elem, opelem, opsbyid = [], identiftra = {}; o.clonedoperacionesmatematicas = {};
                for (elem in o.appvm[o.idPlantilla].operacionesmatematicas()) {
                    opelem = o.appvm[o.idPlantilla].operacionesmatematicas()[elem];
                    identiftra = {};
                    o.clonedoperacionesmatematicas[elem] = { customname: opelem.customname, formula: opelem.formula, enabled: opelem.enabled, isconcat: opelem.stringConcat };
                    _.forEach(opelem.identifiers, function (vo) {
                        identiftra[vo.identif] = vo.idelem, opsbyid.push({ ke: vo.idelem, oke: elem });
                    });
                    o.clonedoperacionesmatematicas[elem].identifiers = identiftra;
                    o.clonedoperacionesmatematicas[elem].inexecution = !1;
                }
                o.currentoperations = _.groupBy(opsbyid, 'ke');

                //Reglas
                o.currentrules = {};
                _.forEach(_.keys(o.appvm[o.idPlantilla].reglas()), function (elmkey) {
                    _.forEach(_.keys(o.appvm[o.idPlantilla].reglas()[elmkey].conditions), function (elmkeycond) {
                        _.forEach(_.keys(o.appvm[o.idPlantilla].reglas()[elmkey].conditions[elmkeycond].subject), function (elmkeycondsub) {
                            var subjt = o.appvm[o.idPlantilla].reglas()[elmkey].conditions[elmkeycond].subject[elmkeycondsub].subject;
                            !!subjt && _.forEach(subjt.toString().split(","), function (subjsp) {
                                !o.currentrules[subjsp] && (o.currentrules[subjsp] = []);
                                !_.includes(o.currentrules[subjsp], elmkey) && o.currentrules[subjsp].push(elmkey);
                            });
                        });
                    });
                });
            }
            else if (tipo === o.TE.CodigoQR) {
                o.codeqrexe = !o.codeqrexe ? {} : o.codeqrexe;
                //Generación de codigosqr
                if (o.appvm[id].prellenadomapeocampos()) {
                    var preda = o.appvm[o.idPlantilla].prefilleddata()[o.appvm[id].prellenadomapeocampos()];
                    if (preda !== undefined) {
                        _.forEach(_.keys(preda.mapeo), function (codemapkey) {
                            if (preda.mapeo[codemapkey].tipoRel === "iselem") {
                                _.forEach(_.keys(preda.mapeo[codemapkey].mapeoHijos), function (codemapkeyson) {
                                    var idcodelem = preda.mapeo[codemapkey].mapeoHijos[codemapkeyson].idelem, iddestelem = preda.mapeo[codemapkey].mapeoHijos[codemapkeyson].destination;
                                    !o.codeqrexe[idcodelem] && (o.codeqrexe[idcodelem] = []), !_.find(o.codeqrexe[idcodelem], { codeqrid: id, destelem: iddestelem }) && o.codeqrexe[idcodelem].push({ codeqrid: id, destelem: iddestelem });
                                });
                            }
                        });
                    }
                }
            }
            else if (tipo === o.TE.ComboDinamico) {
                o.comboDataDynamic = !o.comboDataDynamic ? {} : o.comboDataDynamic;
                if (o.appvm[id].camposfiltros()) {
                    _.forEach(_.keys(o.appvm[id].camposfiltros()), function (keyelm) {
                        var keyComboElem = o.appvm[id].camposfiltros()[keyelm];
                        if (keyComboElem !== id)
                            !o.comboDataDynamic[keyComboElem] && (o.comboDataDynamic[keyComboElem] = []), !_.find(o.comboDataDynamic[keyComboElem], id) && o.comboDataDynamic[keyComboElem].push(id);
                    });
                }
            }
            else if (tipo === o.TE.MarcadoDocumentos) {
                o.documentCheck = !o.documentCheck ? {} : o.documentCheck;
                if (o.appvm[id].elementodocumento())
                    o.documentCheck[o.appvm[id].elementodocumento()] = id;
            }
            else if (tipo === o.TE.Wizard && !!o.appvm[id].navegacion()) {
                o.wizardnavigation = !o.wizardnavigation ? {} : o.wizardnavigation;
                _.forEach(o.appvm[id].navegacion().toString().split(","), function (page) {
                    !o.wizardnavigation[page] && (o.wizardnavigation[page] = []);
                    o.wizardnavigation[page].push(id);
                });
            }
        }
        function insertRule(selector, rul, contxt) {
            var context = contxt || document, stylesheet;

            if (typeof context.styleSheets === "object") {
                if (!context.styleSheets.length) {
                    if (context.createStyleSheet) stylesheet = context.createStyleSheet();
                    else context.getElementsByTagName("head")[0].appendChild(context.createElement("style"));
                }
                stylesheet = context.styleSheets[context.styleSheets.length - 1];
                if (stylesheet) {
                    if (stylesheet.addRule) for (var i = 0; i < selector.length; ++i) stylesheet.addRule(selector[i], rul);
                    else stylesheet.insertRule(selector.join(",") + "{" + rul + "}", stylesheet.cssRules.length);
                }
            }
        }
        function importfe() {
            var o = getOpts();
            Confirmacion("Si sube un XML perder&aacute; todos sus cambios, &iquest;Est&aacute; seguro de querer continuar&quest;", function () {
                var fileinput = $('<input type="file" accept="text/plain">');
                $("body").append(fileinput);
                fileinput.on("change", function () {
                    fileinput = $(this);
                    var file = fileinput.get(0).files[0],
                        label = fileinput.val().replace(/\\/g, "/").replace(/.*\//, ""),
                        ext = label.substring(label.lastIndexOf(".") + 1).toLowerCase();
                    if (!_.includes(["txt", "xml"], ext)) {
                        toasty("Solo se permiten extensiones de tipo txt ó xml");
                        fileinput.remove();
                        return;
                    }
                    var reader = new FileReader();
                    reader.addEventListener("load", function () {
                        importfedata(reader.result, o.jobj.elemento.atributos.titulo);
                        fileinput.remove();
                    }, false);
                    if (file) reader.readAsText(file);
                    else fileinput.remove();
                });
                fileinput.click();
            });
        }
        function importfedata(xmlData, titleN) {
            var o = getOpts();
            showHideLoading(o, !0, "Cargando plantilla");
            $.ajax({
                url: o.datasend.urlGlobal + 'FEConfigurador.aspx/EliminaPlantilla',
                data: JSON.stringify(o.datasend),
                success: function (j) {
                    j = j.d;
                    if (j.Success) {
                        o.datasend.xml = xmlData;
                        o.datasend.nombre = titleN;
                        o.datasend.estructplan = "";
                        $.ajax({
                            url: o.datasend.urlGlobal + "FEConfigurador.aspx/GuardaPlantilla",
                            data: JSON.stringify(o.datasend),
                            success: function (j) {
                                j = j.d;
                                if (j.Success) {
                                    window.location.href = window.location;
                                }
                                else Error(j.Titulo, j.Mensaje);
                            }
                        });
                    }
                    else Error(j.Titulo, j.Mensaje);
                }
            });
        }
        function loadInit(cont, xmlt, o) {
            console.log(`Dibujando esqueleto en modo ${(o.drawEditor ? "configurador" : "capturador")} ${moment().format("DD-MM-YYYY HH:mm:ss.SSS")}`);
            o.idPlantilla = o.id + "element0", o.sessionguid = guid();
            if (!xmlt) o.jobj = { "elemento": { "@idelemento": o.idPlantilla, "@tipoelemento": o.TE.Plantilla, "atributos": {} } };
            var container = $(cont);
            o.tabberpage = $('<ul class="nav nav-tabs" id="' + o.id + 'tabberpage" style="overflow-x: auto; overflow-y: hidden; flex-wrap: unset; white-space: nowrap;" data-bind="attr: { hidden: !$root.isEditor() ? !' + o.idPlantilla + '.vertabspaginas() : false}, foreach: { data:' + o.idPlantilla + '.pagids(), as: \'pag\'}">\
                <!-- ko component: { name: "elemento-pagina-tab", params: { id: pag, tipo: "' + o.TE.Pagina + '", index: $index(), idplantilla: "' + o.idPlantilla + '" } } --><!-- /ko -->\
            </ul>');
            addStylesForLibrary(o), drawlogpanel(o);
            if (o.drawEditor) {
                var menuOptions = [
                    { id: "file", desc: "Archivo" },
                    { id: "elementary", desc: "Elementos" },
                    { id: "styles", desc: "Estilos" },
                    { id: "themes", desc: "Temas" },
                    { id: "props", desc: "Propiedades" }
                ], ribbonmenu = $('<div class="position-absolute" style="right:0"><div title="Guardar plantilla" class="saveplant btn btn-success m-1 p-0" style="border: 0.5px solid #979797; opacity:0.7;"><i class="far fa-hdd p-1"></i></div></div>\
                                    <div class="mb-1 border-bottom"><nav><div class="nav nav-tabs" id="nav-tab" role="tablist"></div></nav>\
                                    <div class="tab-content p-1" id="nav-tabContent" style="background-color: #f3f3f3;"></div></div>');
                ribbonmenu.find(".saveplant").on("click", () => { validateAndSavePlantilla(); });
                for (var i = 0; i < menuOptions.length; i++) {
                    var mode = menuOptions[i];
                    mode.id = o.id + mode.id;
                    ribbonmenu.find("#nav-tab").append('<a class="nav-item nav-link text-black' + (i === 0 ? ' active' : '') + '" id="nav-' + mode.id + '-tab" data-toggle="tab" href="#nav-' + mode.id + '" role="tab" aria-controls="nav-' + mode.id + '" aria-selected="true" ' + (mode.id === o.id + "props" ? "hidden" : "") + '>' + mode.desc + '</a>');
                    var tabContent = $('<div class="tab-pane fade' + (i === 0 ? ' show active' : '') + '" id="nav-' + mode.id + '" role="tabpanel" aria-labelledby="nav-' + mode.id + '-tab" style="height:' + (mode.id === o.id + "props" ? 190 : 150) + 'px;overflow-x: auto;overflow-y: hidden;white-space: nowrap;text-align: center;"></div>');
                    switch (mode.id) {
                        case o.id + "file":
                            tabContent.append($('<div class="btn btn-light p-1 menuelem">Plantilla<i class="fas fa-bars"></i></div>').on("click", () => { drawAttributes(o.idPlantilla); }))
                                .append($('<div class="btn btn-light p-1 menuelem">Exportar<i class="fas fa-download"></i></div>').on("click", exportfe))
                                .append($('<div class="btn btn-light p-1 menuelem">Importar<i class="fas fa-upload"></i></div>').on("click", importfe))
                                .append($('<div class="btn btn-light p-1 menuelem">Hist&oacute;rico FE<i class="fas fa-box-open"></i></div>').on("click", historicalFE))
                                .append($('<div class="btn btn-light p-1 menuelem">Ver XML<i class="fas fa-eye"></i></div>').on("click", () => { exportfe(true); }))
                                .append($('<div class="btn btn-light p-1 menuelem text-white" style="background-color: #059e05;"><i class="far fa-hdd"> <small>Guardar</small></i>(Ctrl+s)</div>').on("click", () => { validateAndSavePlantilla(); }))
                                .append($('<div class="btn btn-light p-1 menuelem text-white" style="background-color: #ff7800;">Cerrar<i class="far fa-times-circle"></i></div>').on("click", () => { if (o.closeMethod) o.closeMethod(); }))
                                .append($('<div class="btn btn-light p-1 menuelem text-white" style="background-color: #d90000;">Borrar<i class="fas fa-minus-circle"></i></div>').on("click", () => { var o = getOpts(); if (o.deleteMethod) o.deleteMethod(o); }))
                                //.append($('<div class="btn btn-light p-1 menuelem" style="background-color: #ffc5e6;">Autoguardar<i class="fas fa-toggle-off" name=autosave></i></div>').on("click", autosave))
                                .append($('<div class="btn btn-light p-1 menuelem" style="background-color: #ffbf00;">Pruebas<i class="fas fa-laptop-code"></i></div>').on("click", () => { testrun(o); }))
                                .append('<br/>')
                                .append($('<div class="btn btn-light p-1 menuelem" style="background-color: #a896ff;">Editor<i class="far fa-newspaper"></i></div>').on("click", () => { infoModElements(o.idPlantilla); }))
                                .append($('<div class="btn btn-light p-1 menuelem" style="background-color: #a896ff;">Macros<i class="fas fa-cogs"></i></div>').on("click", () => { configInterface('macros'); }))
                                .append($('<div class="btn btn-light p-1 menuelem" style="background-color: #98eeff;"><i class="fas fa-code-branch"><small> Reglas</small></i> (Ctrl+Alt+r)</div>').on("click", () => { configInterface('reglas'); }))
                                .append($('<div class="btn btn-light p-1 menuelem" style="background-color: #98eeff;"><i class="fas fa-cloud"><small> Servicios</small></i> (Ctrl+Alt+s)</div>').on("click", () => { configInterface('servicios'); }))
                                .append($('<div class="btn btn-light p-1 menuelem" style="background-color: #98eeff; width: 100px;"><i class="fas fa-network-wired"><small> Componentes</small></i> (Ctrl+Alt+c)</div>').on("click", () => { configInterface('components'); }))
                                .append($('<div class="btn btn-light p-1 menuelem" style="background-color: #98eeff; width: 100px;"><i class="fas fa-calculator"><small> Operaciones</small></i> (Ctrl+Alt+o)</div>').on("click", () => { configInterface('operacionesmatematicas'); }))
                                .append($('<div class="btn btn-light p-1 menuelem text-white" style="background-color: #0064ff;">Prellenado<i class="fas fa-file-signature"></i></div>').on("click", () => { configInterface('prefilleddata'); }))
                                .append($('<div class="btn btn-light p-1 menuelem text-white" style="background-color: #0064ff;">Archivos<i class="far fa-file"></i></div>').on("click", () => { configInterface('pdfmapping'); }))
                                .append($('<div class="btn btn-light p-1 menuelem text-white" style="background-color: #0064ff;">DocHijos<i class="fas fa-database"></i></div>').on("click", () => { configInterface('metadatamapping'); }))
                                .append($('<div class="btn btn-light p-1 menuelem text-white" style="background-color: #0064ff;">Almacén<i class="far fa-images"></i></div>').on("click", imagesUploader))
                                .append($('<div></div>').append('<span id="versiondetail" style="cursor: pointer;" class="badge badge-pill badge-light">Versi&oacute;n ' + o.version + '</span>')
                                    .append('<span id="updatedetail" class="badge badge-pill badge-dark" data-bind="text: \'Ultima actualizacion \' + ' + o.idPlantilla + '.lastupdate()"></span>')
                                    .append('&nbsp;<span class="badge badge-pill bg-yellow" data-bind="text: \'elementos \' + ($root.counterElement() - 2)"></span>'));
                            break;
                        case o.id + "elementary": break;
                        case o.id + "props":
                            tabContent.append('<ul class="nav nav-tabs">\
                                <li class="nav-item li-info text-black">\
                                    <a class="nav-link active text-black" id="nav-info-tab" style="background-color: #f0c416;" data-toggle="tab" href="#nav-info" role="tab" aria-controls="nav-info" aria-selected="true">Info</a>\
                                </li>\
                                <li class="nav-item li-inicio text-black">\
                                    <a class="nav-link text-black" id="nav-inicio-tab" style="background-color: #ccf9fe;" data-toggle="tab" href="#nav-inicio" role="tab" aria-controls="nav-inicio" aria-selected="true">General</a>\
                                </li>\
                                <li class="nav-item li-colors text-black">\
                                    <a class="nav-link text-black" id="nav-colors-tab" style="background-color: #e0a9ff;" data-toggle="tab" href="#nav-colors" role="tab" aria-disenio="nav-colors" aria-selected="false">Diseño</a>\
                                </li>\
                                <li class="nav-item li-plus text-black">\
                                    <a class="nav-link text-black" id="nav-plus-tab" style="background-color: #a9b2ff;" data-toggle="tab" href="#nav-plus" role="tab" aria-controls="nav-plus" aria-selected="false">Especiales</a>\
                                </li>\
                            </ul>\
                            <div class="tab-content">\
                                <div class="tab-pane fade show active p-1" id="nav-info" role="tabpanel" aria-labelledby="nav-info-tab">\
                                    <div class="border bg-white rounded d-inline-flex w-100 ContentIn" style="height:153px; overflow-x:auto; overflow-y:hidden;">\
                                        <div class="d-inline-flex ContentStart">\
                                        </div>\
                                    </div>\
                                </div>\
                                <div class="tab-pane fade p-1" id="nav-inicio" role="tabpanel" aria-labelledby="nav-inicio-tab">\
                                    <div class="border bg-white rounded d-inline-flex w-100 ContentIn" style="height:153px; overflow-x:auto; overflow-y:hidden;">\
                                        <div class="d-inline-flex ContentStart">\
                                        </div>\
                                        <div class="d-inline-flex w-100 ContentEnd">\
                                        </div>\
                                    </div>\
                                </div>\
                                <div class="tab-pane fade p-1" id="nav-colors" role="tabpanel" aria-labelledby="nav-colors-tab">\
                                    <div class="border bg-white rounded d-inline-flex w-100 ContentIn" style="height:153px; overflow-x:auto; overflow-y:hidden;">\
                                        <div class="d-inline-flex ContentStart">\
                                        </div>\
                                        <div class="d-inline-flex w-100 ContentEnd">\
                                        </div>\
                                    </div>\
                                </div>\
                                <div class="tab-pane fade p-1" id="nav-plus" role="tabpanel" aria-labelledby="nav-plus-tab">\
                                    <div class="border bg-white rounded d-inline-flex w-100 ContentIn" style="height:153px; overflow-x:auto; overflow-y:hidden;">\
                                        <div class="d-inline-flex ContentStart">\
                                        </div>\
                                        <div class="d-inline-flex w-100 ContentEnd">\
                                        </div>\
                                    </div>\
                                </div>\
                            </div>');
                            tabContent.find('li > a[id="nav-plus-tab"]').on('shown.bs.tab', (event) => {
                                tabContent.find("#nav-plus div.ContentIn div.datagrid.datalist select").datagrid('resize');
                            });
                            break;
                        case o.id + "styles": break;
                        case o.id + "themes": break;
                        default: tabContent.append("No disponible"); break;
                    }
                    ribbonmenu.find("#nav-tabContent").append(tabContent);
                }

                o.plantilla = $(`<div style="width:100%;min-height: 300px;" id="${o.id}plantilla" 
                    data-bind="
                        style: { fontFamily: ${o.idPlantilla}.tipofuente },
                        css: [${o.idPlantilla}.csselementoglobal(), ${o.idPlantilla}.nombreestilopersonal()].join(' ')"
                    class="state-default-plantilla state-default-plantilla-empty">
                </div>`);
                var clipboard = '<div id="clipboard" data-bind="attr: { hidden: elementCopied().length <= 0}" class="card box-warning" style="position: fixed; bottom: 10px; right: 20px; z-index: 10;">\
                    <div class="card-header with-border no-padding text-center bg-gray align-items-center d-flex">\
                        <i class="fas fa-angle-down px-1" style="cursor:pointer" onclick="if($(\'#clipboard ul\').is(\':visible\')) $(\'#clipboard ul\').hide(), $(this).removeClass(\'fa-angle-down\'), $(this).addClass(\'fa-angle-up\'); else $(\'#clipboard ul\').show(), $(this).removeClass(\'fa-angle-up\'), $(this).addClass(\'fa-angle-down\');"></i>\
                        <h5 class="no-margin p-1">Elementos copiados<span id="clipboardtotal" class="border bg-white badge-pill ml-2" data-bind="text: elementCopied().length"></span></h5>\
                        <i title="Vaciar elementos" class="far fa-trash-alt px-1" style="cursor:pointer" data-bind="click: function() { elementCopied([])}"></i>\
                    </div>\
                    <ul class="no-margin py-2" style="max-height:15vh;overflow:auto" data-bind="foreach:{data:elementCopied, as: \'an\'}"><li data-bind="text: $root[an] && $root[an].titulo ? $root[an].titulo() : an"></li></ul>\
                </div>';
                container.append(ribbonmenu)
                    .append($('<div id="' + o.id + 'editor" class="col-12 col-sm-12 no-padding" style="max-height: 68vh; overflow: auto;"></div>')
                        .append('<div class="TituloFormato" data-bind="attr:{hidden: ' + o.idPlantilla + '.ocultartitulo || ' + o.idPlantilla + '.ocultarsubtitulo}" ></div>')
                        .append('<h1 class="no-margin" data-bind="text: ' + o.idPlantilla + '.titulo, attr:{ hidden: ' + o.idPlantilla + '.ocultartitulo}, style: {color: ' + o.idPlantilla + '.colortextotitulo}" ></h1>')
                        .append('<h5 class="no-margin" data-bind="text: ' + o.idPlantilla + '.subtitulo, attr:{hidden: ' + o.idPlantilla + '.ocultarsubtitulo}, style: {color: ' + o.idPlantilla + '.colortextosubtitulo}"></h5>')
                        .append($('<div id="captplantilla' + o.id + '"></div>')
                            .append(o.tabberpage)
                            .append(o.plantilla)))
                    .append(o.logger)
                    .append(clipboard);

                //Comandos de acceso rapido
                $(document).on("keydown", (e) => {
                    if (e.ctrlKey && e.altKey && e.key === "j") // Ver JSON del elemento actual
                        verJsonElemento(), e.preventDefault();
                    if (e.ctrlKey && e.key === "s") //salvar la plantilla
                        validateAndSavePlantilla(), e.preventDefault();
                    if (e.ctrlKey && e.altKey && e.key === "r") //Acceso directo a reglas
                        configInterface('reglas'), e.preventDefault();
                    if (e.ctrlKey && e.altKey && e.key === "s") //Acceso directo a servicios
                        configInterface('servicios'), e.preventDefault();
                    if (e.ctrlKey && e.altKey && e.key === "c") //Acceso directo a componentes
                        configInterface('componentes'), e.preventDefault();
                    if (e.ctrlKey && e.altKey && e.key === "o") //Acceso directo a operacionesmatematicas
                        configInterface('operacionesmatematicas'), e.preventDefault();
                });
            }
            if (o.drawPreviewer) {
                o.plantilla = $('<div id="' + o.id + 'plantilla" style="margin: auto;" data-bind="style: { fontFamily: ' + o.idPlantilla + '.tipofuente }"></div>');
                o.preview = $('<div id="' + o.id + 'preview"></div>')
                    .append($('<div id="staticcontent" style="margin:0 auto;" class="card mb-2 staticcontent p-2" data-bind="style: {width: ' + o.idPlantilla + '.anchocapturador() + \'%\'}, attr:{hidden: !' + o.idPlantilla + '.staticcontent()}, html: ' + o.idPlantilla + '.staticcontent"></div>'))
                    .append(o.tabberpage.css({ "margin": "auto" }))
                    .append(o.plantilla);
                container.append($('<div class="TituloFormato" data-bind="attr:{hidden: ' + o.idPlantilla + '.ocultartitulo || ' + o.idPlantilla + '.ocultarsubtitulo}" ></div>')
                    .append('<h1 class="no-margin" data-bind="text: ' + o.idPlantilla + '.titulo, attr:{ hidden: ' + o.idPlantilla + '.ocultartitulo}, style: {color: ' + o.idPlantilla + '.colortextotitulo}" ></h1>')
                    .append('<h5 class="no-margin" data-bind="text: ' + o.idPlantilla + '.subtitulo, attr:{hidden: ' + o.idPlantilla + '.ocultarsubtitulo}, style: {color: ' + o.idPlantilla + '.colortextosubtitulo}"></h5>'))
                    .append(o.preview)
                    .append(o.logger)
                    .append($('<span class="badge badge-pill badge-secondary mt-3" style="font-size:100%" data-bind="attr:{hidden: !' + o.idPlantilla + '.mostrarversion()}">Version ' + o.version + "</span>").on("click.changelogs", () => { showElementsLogs() }));
                drawLogMacro(o);
            }
            contglobal = container;
            o.extraAttr[o.TE.Pagina] = _.concat(o.extraGlobalAttr, "staticcontent", "pdfanterior", "prevalidateall", "pagids", "lastupdate");
            o.extraAttr["All"] = _.concat(o.extraGlobalAttr,
                /*Documento*/"ondelete", "anexo", "tipodocjson", "metadatostipodocjson", "anteriornombrearchivodoc", "errormetadatos", "updatemetadata");
            updateOpts(o, !0), autosave(o), getDataAjax(o);
            $(document).bind("contextmenu", (e) => { e.preventDefault(); });
        }
        function loadRemoteData(o, idElem) {
            var dataToLoad = [];
            if (o.appvm[idElem].catalogofuente()) {
                $.ajax({
                    url: o.datasend.urlGlobal + 'FECapturador.aspx/CargaCatalogoRemoto',
                    type: 'POST', beforeSend: () => { }, async: !1, contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({ filtros: JSON.stringify(o.appvm[idElem].camposfiltrosjson), catDocId: o.appvm[idElem].catalogofuente(), proyid: o.datasend.proyid, top: o.appvm[idElem].cantidadopciones() }),
                    success: function (j) {
                        if (j.d.Success) {
                            var table = JSON.parse(j.d.ReturnedObject);
                            if (table) {
                                //Se formatean los datos para poner como llaves a Valor y Nombre
                                for (var i = 0; i < table.Table.length; i++) {
                                    var valdesc = [], vald = o.appvm[idElem].valordescripcion().toString().split(",");
                                    for (var m = 0; m < vald.length; m++)
                                        table.Table[i][vald[m]] && valdesc.push(table.Table[i][vald[m]]);
                                    dataToLoad.push({ Valor: table.Table[i][o.appvm[idElem].valorid()], Nombre: valdesc.join(" "), DataObj: JSON.stringify(table.Table[i]) });
                                }
                                if (dataToLoad.length === 1 && o.appvm[idElem].tipolista() === "radio")
                                    o.appvm[idElem].chosenitems(dataToLoad[0]);
                            }
                            else dataToLoad = [];
                        }
                        else toasty('Error al cargar los datos de ' + o.appvm[idElem].titulo(), j.Mensaje, 'error');
                        _.remove(o.appvm[idElem].camposfiltrosjson, { ElementoId: idElem });
                    },
                    error: function (j) {
                        errorFormElec(o, j.Mensaje);
                    }
                });
            }
            return dataToLoad;
        }
        function mapElementToQR(o, id) {
            if (o.codeqrexe && o.codeqrexe[id]) {
                var elementsincluded = o.codeqrexe[id];
                _.forEach(elementsincluded, function (codeqr) {
                    var codeqrval, codeqrvaljson, idnum = codeqr.destelem.toString().match(/[0-9]+/g).join('_');
                    o.appvm[codeqr.codeqrid].tipo() === o.TE.CodigoQR && (codeqrval = o.appvm[codeqr.codeqrid].valor(),
                        codeqrvaljson = verifyJsonString(codeqrval) ? JSON.parse(codeqrval) : {},
                        codeqrvaljson[idnum] = o.appvm[id].valor(), o.appvm[codeqr.codeqrid].valor(JSON.stringify(codeqrvaljson)));
                });
            }
        }
        function obtenerCoordenadas(o, callback) {
            if (Modernizr.geolocation) {
                var geosuccess = function (lat, lon) {
                    o = getOpts();
                    o.coordenadas.get = true;
                    o.coordenadas.lat = lat;
                    o.coordenadas.lon = lon;
                    updateOpts(o, true);
                    if (callback) callback();
                };

                navigator.geolocation.getCurrentPosition(function (pos) { geosuccess(pos.coords.latitude, pos.coords.longitude); }, function (err) {
                    if (o.coordenadas.get === !0)
                        geosuccess(o.coordenadas.lat, o.coordenadas.lon);
                    else {
                        var mes = err.message || err;
                        if (mes.indexOf("Only secure origins") !== -1 || mes.indexOf("User denied geolocation") !== -1)
                            toasty("La ubicacion no se puede obtener debido al uso de VPN o redes inseguras");
                        else
                            toasty("Georeferencia no soportada en este navegador, favor de actualizar o usar otro navegador. " + err.message + ":" + err.code);
                    }
                });
            } else {
                toasty("Georeferencia no soportada en este navegador, favor de actualizar o usar otro navegador.");
            }
        }
        function renderPlantillaAttributes(o) {
            if (o.appvm.isEditor()) {
                o.appvm[o.idPlantilla].servicios().length > 0 && _.forEach(_.keys(o.appvm[o.idPlantilla].servicios()), function (skey) {
                    if (o.appvm[o.idPlantilla].servicios()[skey].response) delete o.appvm[o.idPlantilla].servicios()[skey].response.execopts;
                });
            }
            else {
                o.appvm[o.idPlantilla].tiempoautoguardado() > 0 && !o.appvm.isQuery() && (o.savingInterval = setInterval(function () {
                    if (savingIntervalDetection > 0) {
                        console.log(`Se realiza autoguardado. al detectar movimiento de ${savingIntervalDetection} teclas`);
                        autoSaveForm(), savingIntervalDetection = 0;
                    }
                    else console.log("No se realiza autoguardado. por no detectar movimientos de teclas");
                }, o.appvm[o.idPlantilla].tiempoautoguardado() * 1000 * 60));
                prefilldata(o, o.datasend.prevData);
                updateStaticContent(o);
                insertRule([".color-elements-error"], "background-color: " + o.appvm[o.idPlantilla].colorfondoerrorelemento() + "; color: " + o.appvm[o.idPlantilla].colortextoerrorelemento() + ";");
                insertRule([".color-fa-elements-error"], "color: " + o.appvm[o.idPlantilla].colorfondoerrorelemento() + ";");
            }
        }
        function salirFormato() {
            o = getOpts();
            $("body").append('<div class="modal" tabindex="-1" id="FESalirDialog" role="dialog">\
                                <div class="modal-dialog" role="document">\
                                    <div class="modal-content rounded">\
                                        <div class="modal-header rounded-top p-1 border-bottom">\
                                            <h5 class="modal-title">' + o.appvm[o.idPlantilla].textosalirtitulo() + '</h5>\
                                            <div id="FESalirCancel" class="btn btn-light px-2"><i class="fas fa-times"></i></div>\
                                        </div>\
                                        <div class="modal-body">' + o.appvm[o.idPlantilla].textosalirmensaje() + '</div>\
                                        <div class="modal-footer p-1">\
                                            <div id="FESalirNo" class="btn btn-danger"><i class="fas fa-ban"></i>  No</div>\
                                            <div id="FESalirSi" class="btn btn-success"><i class="fas fa-check"></i>  S&iacute;</div>\
                                        </div>\
                                    </div>\
                                </div>\
                            </div>');
            $("#FESalirNo").off("click").on("click", function () {
                $("#FESalirDialog").modal("hide");
                if (o.closeMethod) o.closeMethod(o.datasend);
            });
            $("#FESalirSi").off("click").on("click", function () {
                $("#FESalirDialog").modal("hide");
                goPublish(1);
            });
            $("#FESalirCancel").off("click").on("click", function () {
                $("#FESalirDialog").modal("hide");
            });
            AvisoCustom("FESalirDialog");
        }
        function searchElementInJson(o, id) {
            var newel = null;
            if (o.jobj.elemento["@idelemento"] === id) return o.jobj.elemento;
            if (o.jobj.elemento.elementos && o.jobj.elemento.elementos.elemento)
                for (var j = 0; j < o.jobj.elemento.elementos.elemento.length; j++) {
                    newel = searchElementRecursive(o.jobj.elemento.elementos.elemento[j], id);
                    if (newel != null) return newel;
                }
            return newel;
        }
        function searchElementRecursive(elem, id) {
            if (elem["@idelemento"] === id) return elem;
            var newel = null;
            if (elem.elementos && elem.elementos.elemento)
                for (var j = 0; j < elem.elementos.elemento.length; j++) {
                    newel = searchElementRecursive(elem.elementos.elemento[j], id);
                    if (newel != null) return newel;
                }
            return newel;
        }
        function setAllLoad(o) {
            console.log("setallload"), showHideLoading(o, false);
            if (o.allloaded = !0, o.drawPreviewer === !0) {
                setAnexosToElementos(o);
            }
            //se revisa que haya una pagina dibujada despues de las reglas, si no hay pagina se muestra la primera
            var pageactive = !1, firstpage = "";
            for (var i = 0; i < o.jobj.elemento.elementos.elemento.length; i++) {
                firstpage = o.jobj.elemento.elementos.elemento[i]["@idelemento"];
                if (o.appvm[firstpage].tipo() === o.TE.Pagina) {
                    //ya esta activa y ya no se muestra mas paginas
                    if (o.appvm[firstpage].activo() === !0) {
                        pageactive = !0;
                        break;
                    }
                    else if (o.appvm[firstpage].habilitado() && o.appvm[firstpage].visible()) {
                        pageactive = !1;
                        break;
                    }
                }
            }
            //mostrar si no se encontro pagina activa
            if (pageactive === !1) showPage(firstpage);
            renderPlantillaAttributes(o), updateOpts(o, !0);
        }
        function setAnexosToElementos(o) {
            for (var i = 0; i < o.appvm.listAnexos().length; i++) {
                var id = o.appvm.listAnexos()[i].ElementoId;
                o.appvm.listAnexos()[i].allowCam = !0, o.appvm.listAnexos()[i].allowImp = !0;

                if (id && o.appvm[id] && o.appvm[id].tipo() === o.TE.Documento) {
                    if (!!o.documentCheck && o.documentCheck[id]) {
                        o.appvm.listAnexos()[i].allowCam = _.includes(o.appvm[o.documentCheck[id]].cargacamara().toString().split(","), o.appvm.listAnexos()[i].TipoDocID.toString());
                        o.appvm.listAnexos()[i].allowImp = _.includes(o.appvm[o.documentCheck[id]].cargaimportacion().toString().split(","), o.appvm.listAnexos()[i].TipoDocID.toString());
                    }
                    else o.appvm.listAnexos()[i].allowCam = o.appvm[id].permisocamara(), o.appvm.listAnexos()[i].allowImp = o.appvm[id].permisoimportar();
                }
                updateAnexo(o, o.appvm.listAnexos()[i], !0, "");
            }
        }
        function setDescriptionAndOrder(o, id, its) {
            var oi = o.appvm[id].ordenitems ? o.appvm[id].ordenitems() : "alphaasc";
            var tci = o.appvm[id].textoconid ? o.appvm[id].textoconid() : "";
            if (!tci.length) tci = "{t}";
            _.forEach(its, function (it) {
                it.ValorInt = _.toNumber(it.Valor);
                it.Descripcion = tci.indexOf("{i}") >= 0 ? tci.replace("{i}", it.Valor) : tci;
                it.Descripcion = it.Descripcion.indexOf("{t}") >= 0 ? it.Descripcion.replace("{t}", it.Nombre) : it.Descripcion;
                it.Descripcion = it.Descripcion.indexOf("{cv}") >= 0 ? it.Descripcion.replace("{cv}", it.CveCatalogo) : it.Descripcion;
            });
            return _.orderBy(its, [oi.indexOf("id") >= 0 ? "ValorInt" : "Nombre"], [oi.indexOf("desc") >= 0 ? "desc" : "asc"]);
        }
        //Metodo que asigna cada evento de los atributos de los elementos
        function setCustomSubscribes(o, id) {
            var tipo = o.appvm[id].tipo();
            if (o.appvm.isEditor()) {
                //Solo configurador
                o.appvm[id].numerominimo && o.appvm[id].numerominimo.subscribe(function (nv) {
                    o.appvm[id].tipo() === o.TE.Deslizante && o.appvm[id].valor(nv);
                });
                o.appvm[id].permitirprellenadoexterno && o.appvm[id].permitirprellenadoexterno.subscribe(function (nv) {
                    !!o.appvm[id].prellenadomapeocampos && o.appvm[id].prellenadomapeocampos.length > 0 && nv === !0 && (toasty('', 'No se permite encender esta configuraci&oacute;n si el elemento tiene un prellenado asociado.'),
                        o.appvm[id].permitirprellenadoexterno(!1), $('#propertypan').find("#permitirprellenadoexterno").switchbutton("check"));
                });
            } else {
                //Solo capturador
                o.appvm[id].mayusculasminusculas && o.appvm[id].valor && o.appvm[id].valormetadato && (o.appvm[id].mayusculasminusculas() === "upper" && (o.appvm[id].valormetadato.extend({ upper: true }), o.appvm[id].valor.extend({ upper: true })),
                    o.appvm[id].mayusculasminusculas() === "lower" && (o.appvm[id].valormetadato.extend({ lower: true }), o.appvm[id].valor.extend({ lower: true })));
                o.appvm[id].validationerror && o.appvm[id].validationerror.subscribe(function (nv) {
                    $("a#" + id + "_errormessage").popover("dispose");
                    if (!!nv && nv.length > 0) {
                        $("a#" + id + "_errormessage").popover({
                            html: true, content: nv, placement: "top", trigger: "focus",
                            template: '<div class="popover" role="tooltip"><div class="arrow"></div><h3 class="popover-header"></h3><div class="popover-body color-elements-error"></div></div>'
                        });
                        setTimeout(() => {
                            $("a#" + id + "_errormessage").is(':visible') && $("a#" + id + "_errormessage").popover("show");
                            setTimeout(() => {
                                $("a#" + id + "_errormessage").popover("dispose");
                            }, 1000 * 10); //10 segundos despues se quitan
                        }, 500);
                    }
                });
                tipo === o.TE.MarcadoDocumentos && o.appvm[id].catalogodestino && o.appvm[id].catalogodestino.subscribe(function (nv) {
                    if (o.appvm[id].catalogoupdated() === !1) {
                        var nvClone = _.cloneDeep(nv), req = o.appvm[id].opcionrequerida().toString().split(","), cam = o.appvm[id].cargacamara().toString().split(","),
                            carga = o.appvm[id].cargaimportacion().toString().split(",");
                        (req.length > 0 || cam.length > 0 || carga.length > 0) && (_.forEach(nvClone, function (ol) {
                            ol["EsRequerido"] = _.includes(req, ol.Valor), ol["Foto"] = _.includes(cam, ol.Valor), ol["Carga"] = _.includes(carga, ol.Valor);
                        }), o.appvm[id].catalogoupdated(!0), o.appvm[id].catalogodestino(nvClone));
                    }
                    else o.appvm[id].catalogoupdated(!1);
                });
                tipo === o.TE.ComboBoxTemporal && o.appvm[id].catalogotemp && o.appvm[id].catalogotemp.subscribe(function (nv) {
                    var listcbt = [];
                    if (typeof nv === "string" && !!nv) {
                        if (verifyJsonString(nv)) {
                            var parsestr = JSON.parse(nv);
                            if (!!o.appvm[id].atributovalor() && !!o.appvm[id].atributodescripcion() && !!o.appvm[id].atributocombomostrar())
                                listcbt = _.map(parsestr, function (v) { return { Valor: v[o.appvm[id].atributovalor()], Descripcion: v[o.appvm[id].atributodescripcion()] }; });
                        }
                        else listcbt = _.map(nv.toString().split(","), function (v) { return { Valor: v, Descripcion: v }; });
                    } else if (nv instanceof Array) {
                        if (!!o.appvm[id].atributovalor() && !!o.appvm[id].atributodescripcion() && !!o.appvm[id].atributocombomostrar())
                            listcbt = _.map(nv, function (v) { return { Valor: v[o.appvm[id].atributovalor()], Descripcion: v[o.appvm[id].atributodescripcion()] }; });
                    } else if (o.appvm[id].catalogodestino().length > 0) { //por si tiene catalogo y nv viene vacio
                        console.info("combobox no cambia catalogo de" + o.appvm[id].titulo());
                        listcbt = o.appvm[id].catalogodestino(); //por si ya es coleccion
                    }
                    console.info("combobox se lleno catalogo de " + o.appvm[id].titulo() + ": " + JSON.stringify(listcbt));
                    //se revisa si tiene valormetadato para reasignar
                    var valmet = o.appvm[id].valormetadato();
                    console.info("combobox reasignacion de " + o.appvm[id].titulo() + ": " + valmet);
                    o.appvm[id].catalogodestino(listcbt), valmet && o.appvm[id].optiontempselected(valmet);
                }) && o.appvm[id].catalogotemp.valueHasMutated(); //por si tiene catalogo de un borrador
                tipo === o.TE.ComboBoxTemporal && o.appvm[id].optiontempselected && o.appvm[id].optiontempselected.subscribe(function (v) {
                    console.info("combobox asignando valor de " + o.appvm[id].titulo() + ": " + v);
                    if (v === undefined || v === "") {
                        console.info("limpiando valor de " + o.appvm[id].titulo());
                        o.appvm[id].valor(""), o.appvm[id].valormetadato("");
                        return;
                    } //se evita limpiar si es recuperacion o si servicio no trae nada que se limpie por regla
                    var cat = o.appvm[id].catalogodestino() || [], it = v && _.find(cat, { Valor: v }); it = it || { Descripcion: "" };
                    o.appvm[o.appvm[id].elementoligado()] && o.appvm[o.appvm[id].elementoligado()].valor(it.Descripcion);
                    o.appvm[id].valor(it.Descripcion), o.appvm[id].valormetadato(v), o.appvm[id]["isactionchange"] = !0, evaluateConditions(o, id), o.appvm[id]["isactionchange"] = !1;
                    console.info("combobox se asigno desc de " + o.appvm[id].titulo() + ": " + it.Descripcion);
                });
                o.appvm[id].valorjson && o.appvm[id].valorjson.subscribe(function (nv) {
                    setTimeout(function () {
                        //redibujado de tabla despues del render
                        var tabl = $('#' + id).find("table.tableelem")[0];
                        tabl && resizableGrid(tabl);
                    }, 5);
                    o.appvm[id].vertotales() && columnSummatory(o, id);
                    evaluateConditions(o, id);
                });
                o.appvm[id].valormetadatorango && o.appvm[id].valormetadatorango.subscribe(function (nv) {
                    var mask = o.appvm[id].formatoObject.Nombre().replace(/\/+/g, o.appvm[id].separador());
                    var dates = nv.toString().split(" a ");
                    var withoutformatinicial = "", withoutformatfinal = "", bd = !0;
                    if (dates[0]) withoutformatinicial = dateToUniversal(o, id, dates[0]);
                    if (dates[1]) withoutformatfinal = dateToUniversal(o, id, dates[1]);
                    var withformatinicial = moment(withoutformatinicial, withoutformatinicial.length === 6 ? "YYMMDD" : "YYYYMMDD").format(mask.toUpperCase());
                    var withformatfinal = moment(withoutformatfinal, withoutformatfinal.length === 6 ? "YYMMDD" : "YYYYMMDD").format(mask.toUpperCase());
                    withformatinicial.toLowerCase().indexOf("invalid date") >= 0 ?
                        (o.appvm[id].valormetadatoinicial(""), o.appvm[id].valorinicial(""), withoutformatinicial = "", bd = !1) :
                        withoutformatinicial.trim().length &&
                        (o.appvm[id].valormetadatoinicial(withoutformatinicial), o.appvm[id].valorinicial.silentUpdate(withformatinicial)); //aqui es para mostrar el rango
                    withformatfinal.toLowerCase().indexOf("invalid date") >= 0 ?
                        (o.appvm[id].valormetadatofinal(""), o.appvm[id].valorfinal(""), withformatfinal = "", bd = !1) :
                        withoutformatfinal.trim().length &&
                        (o.appvm[id].valormetadatofinal(withoutformatfinal), o.appvm[id].valorfinal.silentUpdate(withformatfinal));
                    if (bd === !0) {//validacion para que solo se ejecute una sola vez las reglas y la asignacion despues de escojer ambas fechas
                        o.appvm[id].valormetadatorango(withformatinicial + " a " + withformatfinal);
                        evaluateConditions(o, id), validateControl(o, id);
                    }
                });
                tipo === o.TE.Texto && o.appvm[id].valormetadato && o.appvm[id].valormetadato.subscribe(function (nv) { o.appvm[id].valor() !== nv && o.appvm[id].valor(nv); });
                !_.includes([o.TE.Boton, o.TE.Lista, o.TE.MarcadoDocumentos, o.TE.ComboBoxTemporal], tipo) && o.appvm[id].valor && o.appvm[id].valor.subscribe(function (nv) {
                    var withformat, withoutformat, fmnumber, isnumber, dd;
                    console.log("se detecto cambio de " + id + " tipo " + tipo + " valor " + nv);
                    //se revisa bandera de render, si aun no esta encendida, significa que el elemento aun se esta dibujando y puede que alguna libreria lo desperto y no es captura real, asi que no se loguea en estadisticas
                    o.appvm[id].elementrendered() && addEstadisticaReporteEstadistico(o, id, nv);
                    if (tipo === o.TE.Moneda) {
                        fmnumber = !!nv || nv === 0 ? nv.toString().match(/[-]?[0-9]+(\.[0-9]+){0,1}/g) : undefined, fmnumber = !fmnumber ? "" : fmnumber.join(''), isnumber = !!fmnumber && fmnumber.length > 0 && !isNaN(Number(fmnumber));
                        if (isnumber && (!!nv || nv === 0)) {
                            withformat = Number(fmnumber).toFixed(o.appvm[id].decimales()).toString();
                            dd = withformat.split(".");
                            //validacion para decimales, sino tiene decimales se mete separador
                            if (dd.length > 1) withformat = dd[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",") + "." + dd[1];
                            else withformat = dd[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                            //formatos basados en Intl.NumberFormat en en-US
                            if (withformat) {
                                switch (o.appvm[id].cultura()) {
                                    case "es": withformat = "$" + withformat; break; //MXN
                                    case "en": withformat = "$" + withformat; break; // USD
                                    case "ja": withformat = "¥" + withformat; break; //JPY
                                    case "cs": withformat = "CZK " + withformat; break; //CZK
                                    case "en-gb": withformat = "£" + withformat; break; //GBP
                                    case "fr": withformat = "€" + withformat; break; //EUR
                                    case "th": withformat = "THB " + withformat; break; //THB
                                    case "pt-br": withformat = "R$" + withformat; break; //BRL
                                    case "ru": withformat = "RUB " + withformat; break; //RUB
                                }
                            }
                            withoutformat = withformat.toString().match(/[-]?[0-9]+(\.[0-9]+){0,1}/g).join(''), o.appvm[id].valor.silentUpdate(withformat), o.appvm[id].valormetadato(withoutformat);
                        }
                        else o.appvm[id].valormetadato(""), o.appvm[id].valor.silentUpdate("");
                    }
                    else if (tipo === o.TE.Numero) {
                        fmnumber = !!nv || nv === 0 ? _.toString(nv).match(/[-]?[0-9]+(\.[0-9]+){0,1}/g) : undefined, fmnumber = !fmnumber ? "" : fmnumber.join(''), isnumber = !!fmnumber && fmnumber.length > 0 && !isNaN(Number(fmnumber));
                        if (isnumber && (!!nv || nv === 0)) {
                            withformat = Number(fmnumber).toFixed(o.appvm[id].decimales()).toString();
                            if (o.appvm[id].separadormiles()) {
                                dd = withformat.split(".");
                                //validacion para decimales, sino tiene decimales se mete separador
                                if (dd.length > 1) withformat = dd[0].replace(/\B(?=(\d{3})+(?!\d))/g, o.appvm[id].separadormiles()) + "." + dd[1];
                                else withformat = dd[0].replace(/\B(?=(\d{3})+(?!\d))/g, o.appvm[id].separadormiles());
                            }
                            withoutformat = withformat.toString().match(/[-]?[0-9]+(\.[0-9]+){0,1}/g).join(''), o.appvm[id].valor.silentUpdate(withformat), o.appvm[id].valormetadato(withoutformat);
                            if (o.appvm[id].convertirknob && o.appvm[id].convertirknob() === !0)
                                $("#" + id + " input").val(withoutformat).trigger("change"); //actualizacion del knob
                        }
                        else o.appvm[id].valormetadato(''), o.appvm[id].valor.silentUpdate('');
                    }
                    else if (tipo === o.TE.Fecha) {
                        var mask;
                        mask = o.appvm[id].formatoObject.Nombre().replace(/\/+/g, o.appvm[id].separador());
                        withoutformat = dateToUniversal(o, id, nv.toString());
                        withformat = moment(withoutformat, withoutformat.length === 6 ? "YYMMDD" : "YYYYMMDD").format(mask.toUpperCase());
                        withformat.toLowerCase().indexOf("invalid date") >= 0 ?
                            (o.appvm[id].valormetadato(""), o.appvm[id].valor.silentUpdate("")) :
                            nv.toString().trim().length && (o.appvm[id].valormetadato(withoutformat), o.appvm[id].valor.silentUpdate(withformat));
                    }
                    else if (tipo === o.TE.Hora) {
                        var ftime = o.appvm[id].horaObject.Nombre().indexOf("PM") !== -1 ? "hh:mm A" : "HH:mm";
                        withoutformat = timeToUniversal(o, id, nv.toString()), withformat = moment(withoutformat, "HH:mm").format(ftime);
                        if (nv.toString().trim().length && withformat !== "Invalid date")
                            o.appvm[id].valormetadato(withoutformat), o.appvm[id].valor.silentUpdate(withformat);
                        else o.appvm[id].valormetadato("00:00"), o.appvm[id].valor.silentUpdate(moment("00:00", "HH:mm").format(ftime));
                    }
                    else if (tipo === o.TE.CodigoQR) o.appvm[id].generarcodigoautomatico() && makeQR(o, id);
                    else if (tipo === o.TE.Deslizante) {
                        if (o.appvm[id].valor() !== o.appvm[id].valormetadato()) {
                            !!$("#slider_" + id).data("ionRangeSlider") && $("#slider_" + id).data("ionRangeSlider").update({ from: nv });
                            o.appvm[id].valormetadato(Number(nv));
                        }
                    }
                    else if (tipo === o.TE.Texto) {
                        (!_.isEmpty(o.appvm[id].esqueletoformato().trim()) && !_.isEmpty(o.appvm[id].valormetadato())) ? esquemaTexto(o, id)
                            : o.appvm[id].valormetadato() !== o.appvm[id].valor() && o.appvm[id].valormetadato(nv);
                        //por si cambio por regla el valormetadato y hay que actualizar el esqueleto del valor
                        if (!_.isEmpty(o.appvm[id].valormetadato()) && !_.isEmpty(o.appvm[id].esqueletoformato().trim())) {
                            o.appvm[id].valor.silentUpdate(o.appvm[id].esqueletoformato().replaceAll('D', '0'));
                        }
                    }
                    else if (tipo === o.TE.ComboDinamico && o.appvm[id].tipolista() === "combo") {
                        var setValDynamic = function () {
                            var sData = _.find($('#dynamiccombo' + id).combobox("getData"), function (valElem) { return valElem["Valor"].toString() === o.appvm[id].valormetadato(); });
                            sData ? $('#dynamiccombo' + id).combobox("setValue", sData["Valor"]) : $('#dynamiccombo' + id).combobox("setValue", "");
                        };
                        if (!$('#dynamiccombo' + id)[0]) {
                            if (o.appvm[id])
                                var setValDynamicInterval = setInterval(function () {
                                    if ($('#dynamiccombo' + id)[0] && o.appvm[id])
                                        clearInterval(setValDynamicInterval), setValDynamic();
                                }, 500);
                        }
                        else setValDynamic();
                    }
                    else if (tipo === o.TE.Password) nv === "" ? $("span.mostrarpassword").hide() : $("span.mostrarpassword").show();
                    else if (!_.includes([o.TE.Leyenda], tipo)) o.appvm[id].valormetadato(nv);
                    if (_.includes([o.TE.Numero, o.TE.Deslizante, o.TE.Moneda, o.TE.TextArea, o.TE.Texto], tipo) && !!o.currentoperations && !!o.currentoperations[id])
                        for (var op = 0; op < o.currentoperations[id].length; op++) {
                            var oper = o.clonedoperacionesmatematicas[o.currentoperations[id][op].oke];
                            !oper.inexecution && oper.enabled && assignValueToElem(oper, oper.formula, oper.identifiers, id);
                        }

                    if (o.comboDataDynamic && o.comboDataDynamic[id]) {
                        _.forEach(o.comboDataDynamic[id], function (comboData) {
                            if (o.appvm[comboData].camposfiltrosjson) {
                                _.forEach(o.appvm[comboData].camposfiltrosjson, function (campjson) {
                                    if (campjson.ElementoId === id)
                                        campjson.Valor = o.appvm[id].valormetadato();
                                });
                            }
                            if (o.appvm[comboData].tipolista() === "combo") {
                                $("#dynamiccombo" + comboData).combobox("clear");
                                $("#dynamiccombo" + comboData).combobox("reload");
                            }
                            else {
                                o.appvm[comboData].chosenitems(o.appvm[comboData].tipolista() === "radio" ? {} : []);
                                o.appvm[comboData].catalogodestino(loadRemoteData(o, comboData));
                            }
                        });
                    }
                    validateControl(o, id);
                    //tipo === o.TE.Logico ? executeEventWithStats(id, "aldarclick", true) : executeEventWithStats(id, "alcambiar", true);
                    tipo !== o.TE.Tabla && evaluateConditions(o, id), mapElementToQR(o, id);
                    o.appvm[o.idPlantilla].contenidoestatico()[id] === "" && updateStaticContent(o);
                    updateOpts(o, true);
                });
                o.appvm[id].chosenitemsRule && o.appvm[id].chosenitemsRule.subscribe(function (nv) {
                    o.appvm[id].isRule(!0), o.appvm[id].chosenitems(nv); //redireccion para reglas
                });
                o.appvm[id].chosenitems && o.appvm[id].chosenitems.subscribe(function (nv) {
                    nv === undefined && (nv = "");
                    if (nv === "") $("#dynamiccombo" + id).combobox("clear"); //la logica del combobox vuelve a invocar este metodo.
                    else if (!o.appvm[id].isfreshly()) { //si no ha sido actualizado en el ultimo medio segundo (problemas de doble o triple asignacion)
                        !(nv instanceof Array) && (nv = [nv]);
                        nv = _.compact(nv);
                        var forlog = _.map(nv, (ff) => { return nv.Nombre || ""; }).join(", ");
                        console.log("se detecto cambio de " + id + " tipo " + tipo + " valor " + forlog);
                        //se revisa bandera de render, si aun no esta encendida, significa que el elemento aun se esta dibujando y puede que alguna libreria lo desperto y no es captura real, asi que no se loguea en estadisticas
                        o.appvm[id].elementrendered() && addEstadisticaReporteEstadistico(o, id, forlog);
                        o.appvm[id].isfreshly(!0) && (setTimeout(() => { o.appvm[id].isfreshly(!1); }, 500)); //se asigna bandera de que es recien actualizado y no se deja volverle a asignar valor en el proximo medio segundo
                        editChosenItems(nv, id), validateControl(o, id), updateStaticContent(o);
                        o.appvm[id]["isactionchange"] = o.appvm[id].isRule() === !1, evaluateConditions(o, id);
                        //executeEventWithStats(id, "alcambiar", true);
                        o.appvm[id]["isactionchange"] = !1, o.appvm[id].isRule(!1);
                        if (o.comboDataDynamic && o.comboDataDynamic[id] && o.appvm[id].tipo() !== o.TE.ComboDinamico) {
                            _.forEach(o.comboDataDynamic[id], function (comboData) {
                                if (o.appvm[comboData].camposfiltrosjson) {
                                    _.forEach(o.appvm[comboData].camposfiltrosjson, function (campjson) {
                                        if (campjson.ElementoId === id)
                                            campjson.Valor = o.appvm[id].valor();
                                    });
                                }
                                if (o.appvm[comboData].tipolista() === "combo") {
                                    $("#dynamiccombo" + comboData).combobox("clear");
                                    $("#dynamiccombo" + comboData).combobox("reload");
                                }
                                else o.appvm[comboData].catalogodestino(loadRemoteData(o, comboData));
                            });
                        }

                        if (o.appvm[id].modobusqueda && o.appvm[id].modobusqueda()) {
                            var elemSelComboN = $("#" + id + " select.docelem");
                            if (!!elemSelComboN[0] && elemSelComboN[0].className.indexOf("textbox") >= 0 && o.appvm[id].valor() !== elemSelComboN.combobox("getValue")) {
                                elemSelComboN.combobox("setValue", o.appvm[id].valor());
                            }
                        }
                    }
                });
            }

            //Configurador y capturador
            o.appvm[id].campo && (o.appvm[id].campo.subscribe(function (nv) {
                o = getOpts();
                if (nv === "obsoleto") { }
                else { //viejas versiones
                    o.appvm[id].campo.silentUpdate("obsoleto");
                    var css = "";
                    if (nv === "nano") css = "col-sm-1 col-12";
                    else if (nv === "micro") css = "col-sm-2 col-12";
                    else if (nv === "mini") css = " col-sm-3 col-12";
                    else if (nv === "small") css = "col-sm-4 col-12";
                    else if (nv === "normal") css = "col-sm-6 col-12";
                    else if (nv === "big") css = "col-sm-12 col-12";
                    o.appvm[id].nombreestilopersonal(o.appvm[id].nombreestilopersonal() + " " + css);
                }
            }), o.appvm[id].campo.valueHasMutated());
            o.appvm[id].filtrarcatalogo && o.appvm[id].filtrarcatalogo.subscribe(function (nv) {
                var filt = o.appvm[id].filtrarcatalogo(), cat = o.datatags.allitemscatalogs["catalogos|" + o.appvm[id].catalogoorigen()],
                    copycat = [];
                filt === "" && (filt = { filtrar: !1, idfiltrados: "", rangofiltrado: "" });
                if (filt.filtrar) {
                    if (filt.idfiltrados) cat = _.filter(cat, function (ve) { return _.includes(filt.idfiltrados.toString().split(','), ve.Valor); });
                    if (filt.rangofiltrado) {
                        filt.rangofiltrado = filt.rangofiltrado.match(/{[0-9]+:[0-9]+}/g);
                        filt.rangofiltrado && filt.rangofiltrado.length > 0 ? (_.forEach(filt.rangofiltrado, function (nfdval) {
                            let rango = nfdval.match(/[0-9]+:[0-9]+/g); rango = rango[0].toString().split(':');
                            copycat = _.union(copycat, _.slice(cat, rango[0] - 1, rango[1]));
                        }), cat = copycat) : filt.rangofiltrado = "";
                    }
                }
                o.appvm[id].catalogodestino(setDescriptionAndOrder(o, id, cat)), o.appvm[id].filtrarcatalogo.silentUpdate(filt);
            });
            o.appvm[id].hojaestilos && o.appvm[id].hojaestilos.subscribe((nv) => {
                var styleTag = $("#hojaestilosplantilla")[0];
                if (!styleTag) $("head").append('<style id="hojaestilosplantilla"></style>'), styleTag = $("#hojaestilosplantilla")[0];
                var sheet = styleTag.sheet ? styleTag.sheet : styleTag.styleSheet;
                if (sheet.cssRules) styleTag.textContent = nv.replaceAll("&gt;", ">");
            });
            o.appvm[id].urlestilos && o.appvm[id].urlestilos.subscribe((nv) => {
                $("link[id^='urlestilosplantilla_']").remove();
                var urls = nv.split(';');
                urls.forEach((u) => {
                    !_.isEmpty(u) && $("head").append(`<link id="urlestilosplantilla_${_.random(999)}" href="${u}" rel="stylesheet" />`);
                });
            });

            //Verificar
            o.appvm[id].mostrar && o.appvm[id].mostrar.subscribe(function () { evaluateConditions(o, id); });
            o.appvm[id].visible && o.appvm[id].visible.subscribe(function () { evaluateConditions(o, id); });
            o.appvm[id].habilitado && o.appvm[id].habilitado.subscribe(function (nv) {
                if (!o.appvm.isEditor()) {
                    console.log("se detecto cambio del estado habilitado " + id + " tipo " + tipo + " habilitado " + nv);
                    if (o.appvm[id].tipo() === o.TE.ComboDinamico) {
                        var setValDynamic = function () { $('#dynamiccombo' + id).combobox(nv ? "enable" : "disable"); };
                        if (!$('#dynamiccombo' + id)[0]) {
                            if (o.appvm[id])
                                var setValDynamicInterval = setInterval(function () {
                                    if ($('#dynamiccombo' + id)[0] && o.appvm[id])
                                        clearInterval(setValDynamicInterval), setValDynamic();
                                }, 500);
                        }
                        else setValDynamic();
                    }
                    else if (o.appvm[id].tipo() === o.TE.Lista && o.appvm[id].modobusqueda()) {
                        var enablelist = function () { $('.element#' + id + ' select').combobox(nv ? "enable" : "disable"); };
                        if (!$('.element#' + id + ' select')[0]) {
                            if (o.appvm[id])
                                var enablelistinter = setInterval(function () {
                                    if ($('.element#' + id + ' select')[0] && o.appvm[id])
                                        clearInterval(enablelistinter), enablelist();
                                }, 500);
                        }
                        else enablelist();
                    }
                    evaluateConditions(o, id);
                }
            });
            o.appvm[id].requerido && o.appvm[id].requerido.subscribe(function () { evaluateConditions(o, id); });
            o.appvm[id].optionselectedRule && o.appvm[id].optionselectedRule.subscribe(function (nv) {
                o.appvm[id].isRule(!0), o.appvm[id].optionselected.silentUpdate(nv), o.appvm[id].optionselected.valueHasMutated(); //se fuerza el cambio para las reglas

            });
            o.appvm[id].optionselected && o.appvm[id].optionselected.subscribe(function (nv) {
                o.appvm[id].optionselectedRule.silentUpdate(null); //se limpia para que siempre piense que cambio
                if (o.appvm[id].tipo() === o.TE.Lista)
                    nv = _.find(o.datatags.allitemscatalogs["catalogos|" + o.appvm[id].catalogoorigen()], function (c) { return c.Valor === nv; });
                o.appvm[id].chosenitems(nv);
            });
            o.appvm[id].expresionregular && o.appvm[id].expresionregular.subscribe(function (nv) {
                try {
                    if (nv === "*") {
                        o.appvm[id].regexrerror(true);
                        o.appvm[id].regexconfigmsg("* no es una expresion valida, substituya por \\w");
                    } else {
                        var regExp = new RegExp(nv);
                        if (nv.indexOf("&") >= 0) {
                            o.appvm[id].regexrerror(true);
                            o.appvm[id].regexconfigmsg("No debe contener \"&\", substituya por \\<xmp>x26</xmp>");
                        }
                        else {
                            o.appvm[id].regexrerror(false);
                            o.appvm[id].regexconfigmsg("");
                        }
                    }
                } catch (error1) {
                    o.appvm[id].regexrerror(true);
                    o.appvm[id].regexconfigmsg("Expresion invalida");
                }
            });
            o.appvm[id].tasanominalanual && o.appvm[id].tasanominalanual.subscribe(function (v) {
                o.appvm[id].tasaefectivaanual(formatOperation(o.appvm[id].formulatea(), id, 8));
                o.appvm[id].tasaefectivamensual(formatOperation(o.appvm[id].formulatem(), id, 8));
            });

            if (o.appvm[id].valorjson) {
                var tabla = searchElementInJson(o, id), m = o.appvm[id].nombrecolumnas() || [], js = ko.utils.parseJson(o.appvm[id].valor()) || [];

                if (tabla) {
                    m.length || (m.push({ titulo: "Acciones", parent: "", id: "Acciones" }),
                        m = recursiveGetNameColumns(tabla.elementos.elemento, m, "", o), o.appvm[id].nombrecolumnas(m));
                    for (var k = 0; k < js.length; k++) {
                        for (var elej in js[k]) elej !== "Acciones" && !js[k][elej]["haserror"] && (js[k][elej]["haserror"] = !1);
                        js[k].Acciones.checked = !1, js[k] = ko.mapping.fromJS(js[k]);
                    }
                    o.appvm[id].valorjson(js);
                    _.forEach(o.appvm[id].nombrecolumnas(), function (elmdat) { elmdat.id.indexOf("Acciones") < 0 && o.appvm[id].columnasvisualizar()[elmdat.id] === undefined && (o.appvm[id].columnasvisualizar()[elmdat.id] = true); });
                    var filteredcolumns = {};
                    _.forEach(_.keys(o.appvm[id].columnasvisualizar()), function (elmkey) {
                        if (_.find(o.appvm[id].nombrecolumnas(), function (elmkeycol) { return elmkeycol.id === elmkey; }))
                            filteredcolumns[elmkey] = o.appvm[id].columnasvisualizar()[elmkey];
                    });
                    o.appvm[id].columnasvisualizar(filteredcolumns);
                }
            }
            o.appvm[id].tamanio && (o.appvm[id].tamanio.subscribe(function (nv) {
                o.appvm[id].tamaniocss(nv === "chico" ? "btn-sm" : nv === "grande" ? "btn-lg" : "");
            }), o.appvm[id].tamanio.valueHasMutated());
            o.appvm[id].nombrearchivo && o.appvm[id].nombrearchivo.subscribe(function () {
                o = getOpts(), validateControl(o, id);
                evaluateConditions(o, id);
            });
            o.appvm[id].autoredirectalguardar && (o.datasend.autoredirectalguardar = o.appvm[id].autoredirectalguardar());
            o.appvm[id].click && (o.appvm[id].click = function () {
                if (o.drawPreviewer) {
                    o.appvm[id].isclick(!0);
                    if (o.appvm[o.appvm[id].elementopadre()].tipo() === o.TE.Tabla) {
                        if (o.appvm[id].cantidadmaximacliccounter()[o.appvm[o.appvm[id].elementopadre()].clickedrow()] === 0) {
                            toasty('', 'El m&aacute;ximo de clics permitidos ha sido alcanzado', 'error'), o.appvm[id].isclick(!1);
                            return false;
                        }
                        else if (o.appvm[id].cantidadmaximacliccounter()[o.appvm[o.appvm[id].elementopadre()].clickedrow()] > 0)
                            o.appvm[id].cantidadmaximacliccounter()[o.appvm[o.appvm[id].elementopadre()].clickedrow()]--;
                        evaluateConditions(o, o.appvm[id].elementopadre());
                    }
                    else {
                        if (o.appvm[id].cantidadmaximacliccounter() === 0) {
                            toasty('', 'El m&aacute;ximo de clics permitidos ha sido alcanzado', 'error');
                            return false;
                        }
                        else if (o.appvm[id].cantidadmaximacliccounter() > 0) o.appvm[id].cantidadmaximacliccounter(o.appvm[id].cantidadmaximacliccounter() - 1);
                    }
                    evaluateConditions(o, id), o.appvm[id].isclick(!1);
                    updateOpts(o, true);

                    //ejecucion del urllink
                    if (o.appvm[id].urllink && o.appvm[id].urllink().length) {
                        var link = o.appvm[id].urllink();
                        if (link.indexOf("{{") >= 0)
                            link = link.replace(/{{(tb:)?\w+}}/g, function (mat, ind, ori) {
                                var vari = mat.replace("{{", "").replace("}}", "").toLowerCase();
                                if (_.includes(["flujoid", "piid", "proyid", "expid", "docid", "tipodocid", "username", "grupoid"], vari)) {
                                    switch (vari) {
                                        case "flujoid": case "piid": case "proyid": return o.datasend[vari];
                                        case "expid": return o.datasend.expId;
                                        case "docid": return o.datasend.docId;
                                        case "tipodocid": return o.datasend.tipoDocId;
                                        case "username": return o.datasend.userName;
                                        case "grupoid": return o.datasend.grupoId;
                                    }
                                }
                                else if (vari.indexOf("tb:") >= 0) {
                                    var parenttable, rowtable;
                                    vari = mat.replace("{{tb:", "").replace("}}", "");
                                    o.appvm[vari] && o.appvm[vari].elementopadre && (parenttable = o.appvm[o.appvm[vari].elementopadre()]);
                                    if (parenttable && _.includes([o.TE.Tabla], parenttable.tipo()) && parenttable.clickedrow() > 0) {
                                        rowtable = _.find(parenttable.valorjson(), function (elm) { return elm.Acciones.id() === parenttable.clickedrow(); });
                                        rowtable && rowtable[vari] && (vari = rowtable[vari].valor());
                                    }
                                }
                                else if (vari.indexOf("query_") >= 0) {
                                    vari = mat.replace("{{", "").replace("}}", "");
                                    return getParameterQueryByName(vari.replace("query_", ""));
                                }
                                else if (mat.indexOf("formElec_element") >= 0) {
                                    vari = mat.replace("{{", "").replace("}}", "");
                                    return o.appvm[vari].valor();
                                }
                                return vari;
                            });
                        link = EncriptaUrl(link);
                        switch (o.appvm[id].urlnuevapagina()) {
                            case "true": case true:
                                var openp = window.open(link, "_blank");
                                openp && openp.focus();
                                break;
                            case "false": case false:
                                window.location = link;
                                break;
                            case "modal":
                                var modalBtn = $('<div class="modal modalBtn' + id + '">\
                                                        <div class="modal-dialog modal-xl" style="width: 95%; max-width: 95%;">\
                                                            <div class="modal-content rounded">\
                                                                <div class="modal-body no-padding row"><iframe class="w-100" style="min-height: 80vh;" src="' + link + '"></iframe></div>\
                                                                <div class="modal-footer p-2">\
                                                                    <div class="modalclose btn btn-light border btn-sm">Cerrar</div>\
                                                                </div>\
                                                            </div>\
                                                        </div>\
                                                    </div>');
                                $("body").append(modalBtn), $(".modalBtn" + id).modal({ keyboard: !1, backdrop: "static", show: !0 });
                                $(".modalBtn" + id).find(".modalclose").on("click", function (e) {
                                    $(".modalBtn" + id).modal("hide"), $(".modalBtn" + id).remove(), o.appvm[id].isclosemodal(!0), evaluateConditions(o, id), o.appvm[id].isclosemodal(!1);
                                });
                                break;
                        }
                    }
                }
            });
        }
        function sleep(t) { return new Promise((r) => setTimeout(r, t)); }
        function showHideLoading(o, show, text) {
            $("#loadingfe").remove();
            if (show === !0) {
                $(o.loading).removeAttr("hidden").css("padding-top", $(window).outerHeight() / 2.2).appendTo($("body"));
                if (!_.isEmpty(text)) $("body").find("#spanloadingfe").text(text);
            }
        }
        //Actualiza la configuracion guardada del plugin
        function updateOpts(o, getted) {
            if (getted === !0) contglobal.data("editor_opts_beteam", o);
            else {
                var o1 = getOpts();
                contglobal.data("editor_opts_beteam", $.isPlainObject(o) || !o ? $.extend(true, {}, o1, o) : $.extend({}, o1));
            }
        }
        function updateAnexo(o, ane, silent, thumb, docidanexoreplace) {
            thumb = thumb || "";
            if (o.appvm[ane.ElementoId] && o.appvm[ane.ElementoId].anexo && ane.Reemplazado !== !0) {
                if (_.includes([o.TE.Imagen, o.TE.Georeferencia, o.TE.PDFOCR], o.appvm[ane.ElementoId].tipo())) {
                    if (thumb.length) thumb = "data:image/png;base64," + thumb;
                }
                var ann = { docid: ane.DocID, delete: ane.DocID === 0, guidanexo: ane.GuidAnexo, thumb: thumb, downloaded: thumb.length > 0, filename: ane.GuidAnexo, ext: ane.Extension, origname: ane.NombreOriginal, guidanexoanterior: "", tipodocname: "", allowCam: ane.allowCam, allowImp: ane.allowImp };
                if (o.appvm[ane.ElementoId].tipo() === o.TE.Documento) {
                    //Actualizar valores de allowcam y allowimp al cancelar el reemplazo
                    if (!!o.documentCheck && o.documentCheck[ane.ElementoId]) {
                        if (o.appvm[ane.ElementoId].tipodocjson()[ann.guidanexo]) {
                            ann.allowCam = _.includes(o.appvm[o.documentCheck[ane.ElementoId]].cargacamara().toString().split(","), o.appvm[ane.ElementoId].tipodocjson()[ann.guidanexo].toString());
                            ann.allowImp = _.includes(o.appvm[o.documentCheck[ane.ElementoId]].cargaimportacion().toString().split(","), o.appvm[ane.ElementoId].tipodocjson()[ann.guidanexo].toString());
                        }
                    }
                    else ann.allowCam = o.appvm[ane.ElementoId].permisocamara(), ann.allowImp = o.appvm[ane.ElementoId].permisoimportar();

                    if (docidanexoreplace) {
                        var anex = _.find(o.appvm[ane.ElementoId].anexo(), { docid: docidanexoreplace });
                        if (anex) {
                            //se actualizan tipodoc y metadatos de anexo reemplazado, y se pasan actualizan valores del anexo en el elemento
                            o.appvm[ane.ElementoId].tipodocjson()[ann.guidanexo] = o.appvm[ane.ElementoId].tipodocjson()[anex.guidanexo];
                            delete o.appvm[ane.ElementoId].tipodocjson()[anex.guidanexo];
                            o.appvm[ane.ElementoId].tipodoc(JSON.stringify(o.appvm[ane.ElementoId].tipodocjson()));
                            o.appvm[ane.ElementoId].metadatostipodocjson()[ann.guidanexo] = o.appvm[ane.ElementoId].metadatostipodoc()[anex.guidanexo];
                            delete o.appvm[ane.ElementoId].metadatostipodocjson()[anex.guidanexo];
                            o.appvm[ane.ElementoId].metadatostipodoc(JSON.stringify(o.appvm[ane.ElementoId].metadatostipodocjson()));
                            anex.downloaded = ann.downloaded, anex.ext = ann.ext, anex.filename = ann.filename, anex.guidanexo = ann.guidanexo, anex.origname = ann.origname, anex.thumb = ann.thumb, anex.docidanexo = docidanexoreplace;
                            var curan = o.appvm[ane.ElementoId].anexo();
                            o.appvm[ane.ElementoId].anexo({}), o.appvm[ane.ElementoId].anexo(curan);
                        }
                    }
                    else {
                        var findelem = _.find(o.appvm[ane.ElementoId].anexo(), { guidanexo: ann.guidanexo, filename: ann.filename, origname: ann.origname });
                        if (!findelem) o.appvm[ane.ElementoId].anexo.push(ann);
                        else if (thumb && !findelem.thumb) {
                            var copyanex = [];
                            _.forEach(o.appvm[ane.ElementoId].anexo(), function (anexhijo) {
                                if (anexhijo.guidanexo === ann.guidanexo && anexhijo.filename === ann.filename && anexhijo.origname === ann.origname)
                                    anexhijo = ann;
                                copyanex.push(anexhijo);
                            });
                            o.appvm[ane.ElementoId].anexo([]), o.appvm[ane.ElementoId].anexo(copyanex);
                        }
                    }
                    !!o.documentCheck && !!o.documentCheck[ane.ElementoId] && o.appvm[o.documentCheck[ane.ElementoId]] && o.appvm[o.documentCheck[ane.ElementoId]].catalogodestino().length > 0 &&
                        updateDocumentCheck(o, ane.ElementoId, o.documentCheck[ane.ElementoId]);
                    o.appvm[ane.ElementoId].ondelete(!1);
                }
                else if (o.appvm[ane.ElementoId].tipo() === o.TE.FirmaFAD) {
                    if (ane.FileName.indexOf(ane.ElementoId + "_1_") != -1) { //solo se asigna como anexo principal el grafo en la FAD
                        o.appvm[ane.ElementoId].anexo(ann);
                        silent ? o.appvm[ane.ElementoId].nombrearchivo.silentUpdate(ane.FileName) : o.appvm[ane.ElementoId].nombrearchivo(ane.FileName);
                    }
                }
                else {
                    o.appvm[ane.ElementoId].anexo(ann);
                    silent ? o.appvm[ane.ElementoId].nombrearchivo.silentUpdate(ane.FileName) : o.appvm[ane.ElementoId].nombrearchivo(ane.FileName);
                    if (o.appvm[ane.ElementoId].tipo() === o.TE.HuellaDigital)
                        o.appvm[ane.ElementoId].cantidadhuellas(_.filter(o.appvm.listAnexos(), { ElementoId: ane.ElementoId }).length);
                }
            }
        }
        function updateStaticContent(o) {
            var txt = "";
            if (o.appvm[o.idPlantilla].contenidoestaticohtml()) {
                txt = he.decode(o.appvm[o.idPlantilla].contenidoestaticohtml());
                var elms = txt.match(/\{[0-9]+(t)?\}/g), cs = _.keys(o.appvm[o.idPlantilla].contenidoestatico());
                _.forEach(elms, function (elmkey) {
                    var num = elmkey.match(/[0-9]+/g);
                    num > 0 && (num = num - 1);
                    if (cs[num] && o.appvm[cs[num]] && o.appvm[cs[num]].valor)
                        txt = txt.replace(elmkey, elmkey.indexOf("t") >= 0 ? o.appvm[cs[num]].titulo() : o.appvm[cs[num]].valor());
                });
            }
            else {
                _.forEach(_.keys(o.appvm[o.idPlantilla].contenidoestatico()), function (elmkey) {
                    o.appvm[elmkey] && o.appvm[elmkey].valor &&
                        (txt += "<span><strong>" + o.appvm[elmkey].titulo() + ":</strong> " + o.appvm[elmkey].valor() + "</span>");
                });
            }
            o.appvm[o.idPlantilla].staticcontent(txt);
        }
        function updateStyleTabs(ele, vm) {
            var o = getOpts(), bg, color;
            if (o.appvm[vm.p().id()].habilitado()) {
                if (o.appvm[vm.p().id()].activo())
                    color = o.appvm[o.idPlantilla].colortabtextoactivo(), bg = o.appvm[o.idPlantilla].colortabactivo();
                else color = o.appvm[o.idPlantilla].colortabtextonormal(), bg = o.appvm[o.idPlantilla].colortabnormal();
            } else color = o.appvm[o.idPlantilla].colortabtextoinhabilitado(), bg = o.appvm[o.idPlantilla].colortabinhabilitado();
            if (o.appvm[o.idPlantilla].estilotabs() === "fondo") $(ele).attr("style", `color: ${color}; background-color: ${bg}; border: 0;`);
            else if (o.appvm[o.idPlantilla].estilotabs() === "borde") $(ele).attr("style", `color: ${color}; background-color: #fff; border: 4px solid ${bg};`);
            else $(ele).attr('style', `color: ${color}; background-color: #fff; border-top: 0px solid #fff; border-right: 0px solid #fff; border-left: 0px solid #fff; border-bottom: 7px solid ${bg};`);
        }
        function updateStyleButtonAll(ele, data) {
            var o = getOpts(), color = data.c, bg = data.bg,
                sty = data.ty === o.TE.Audio ? o.appvm[o.idPlantilla].estilobotonesaudio() :
                    data.ty === o.TE.Imagen ? o.appvm[o.idPlantilla].estilobotonesimagen() :
                        data.ty === o.TE.Boton ? o.appvm[o.idPlantilla].estilobotonesboton() :
                            data.ty === o.TE.CodigoQR ? o.appvm[o.idPlantilla].estilobotonescodigoqr() :
                                o.appvm[o.idPlantilla].estilobotonescodigobarras();
            $(ele).find(".pretext,.posttext,.externtext").html("");
            $(ele).find(".externtext").attr("style", `color: ${color};`);
            if (sty === "circulofondo") {
                $(ele).find("div.btn").attr("style", `color: ${color}; background-color: ${bg}; border-radius: 25px;`);
                $(ele).find(".externtext").html(data.t);
            }
            else if (sty === "circuloborde") {
                $(ele).find("div.btn").attr("style", `color: ${color}; background-color: #fff; border: 4px solid ${bg}; border-radius: 25px;`);
                $(ele).find(".externtext").html(data.t);
            }
            else if (sty === "rectangulointernofondo") {
                $(ele).find("div.btn").attr("style", `color: ${color}; background-color: ${bg};`);
                $(ele).find(".posttext").html("&nbsp;&nbsp;" + data.t);
            }
            else if (sty === "rectangulointernoborde") {
                $(ele).find("div.btn").attr("style", `color: ${color}; background-color: #fff; border: 4px solid ${bg};`);
                $(ele).find(".posttext").html("&nbsp;&nbsp;" + data.t);
            }
            else if (sty === "rectanguloexternofondo") {
                $(ele).find("div.btn").attr("style", `color: ${color}; background-color: ${bg};`);
                $(ele).find(".externtext").html(data.t);
                $(ele).find(".pretext").html("&nbsp;&nbsp;&nbsp;");
                $(ele).find(".posttext").html("&nbsp;&nbsp;&nbsp;");
            }
            else if (sty === "rectanguloexternoborde") {
                $(ele).find("div.btn").attr("style", `color: ${color}; background-color: #fff; border: 4px solid ${bg};`);
                $(ele).find(".externtext").html(data.t);
                $(ele).find(".pretext").html("&nbsp;&nbsp;&nbsp;");
                $(ele).find(".posttext").html("&nbsp;&nbsp;&nbsp;");
            }
            else if (sty === "ovalointernofondo") {
                $(ele).find("div.btn").attr("style", `color: ${color}; background-color: ${bg}; border-radius: 25px;`);
                $(ele).find(".posttext").html("&nbsp;&nbsp;" + data.t);
            }
            else if (sty === "ovalointernoborde") {
                $(ele).find("div.btn").attr("style", `color: ${color}; background-color: #fff; border: 4px solid ${bg}; border-radius: 25px;`);
                $(ele).find(".posttext").html("&nbsp;&nbsp;" + data.t);
            }
            else if (sty === "ovaloexternofondo") {
                $(ele).find("div.btn").attr("style", `color: ${color}; background-color: ${bg}; border-radius: 25px;`);
                $(ele).find(".externtext").html(data.t);
                $(ele).find(".pretext").html("&nbsp;&nbsp;&nbsp;");
                $(ele).find(".posttext").html("&nbsp;&nbsp;&nbsp;");
            }
            else if (sty === "ovaloexternoborde") {
                $(ele).find("div.btn").attr("style", `color: ${color}; background-color: #fff; border: 4px solid ${bg}; border-radius: 25px;`);
                $(ele).find(".externtext").html(data.t);
                $(ele).find(".pretext").html("&nbsp;&nbsp;&nbsp;");
                $(ele).find(".posttext").html("&nbsp;&nbsp;&nbsp;");
            }
        }
        function updateStyleCommands(ele, data) {
            var o = getOpts(), bg = data.t === 'G' ? o.appvm[o.idPlantilla].colorguardarplantilla() : o.appvm[o.idPlantilla].colorcancelarplantilla(),
                color = data.t === 'G' ? o.appvm[o.idPlantilla].colorguardartextoplantilla() : o.appvm[o.idPlantilla].colorcancelartextoplantilla(),
                text = data.t === 'G' ? o.appvm[o.idPlantilla].textoguardarplantilla() : o.appvm[o.idPlantilla].textocancelarplantilla(),
                html = data.t === 'G' ? '<i class="fas fa-check"></i>' : '<i class="fa fa-arrow-left"></i>';
            $(ele).html(html), text = '&nbsp;<label style="margin: 0;">' + text + '</label>';
            if (o.appvm[o.idPlantilla].estilocomandos() === "fondo")
                $(ele).attr("style", `padding: .5rem .75rem; color: ${color}; background-color: ${bg}; border: 0;`);
            else if (o.appvm[o.idPlantilla].estilocomandos() === "fondotexto")
                $(ele).attr("style", `padding: .5rem .75rem; color: ${color}; background-color: ${bg}; border: 0;`), $(ele).html(html + text);
            else if (o.appvm[o.idPlantilla].estilocomandos() === "borde")
                $(ele).attr("style", `padding: .5rem .75rem; color: ${color}; background-color: transparent; border: 3px solid ${bg};`);
            else if (o.appvm[o.idPlantilla].estilocomandos() === "bordetexto")
                $(ele).attr("style", `padding: .5rem .75rem; color: ${color}; background-color: transparent; border: 3px solid ${bg};`), $(ele).html(html + text);
            else $(ele).attr('style', `padding: 0; color: ${color}; background-color: ${bg}; border: 0;`),
                $(ele).html(html + text).find('i').attr('style', `padding: .5rem; border: 3px solid ${bg}; background: #fff; color: ${bg};`).end().
                    find('label').attr('style', 'margin: 0 .5rem 0 0;');
        }
        function verifyJsonString(jsonstring) {
            try {
                JSON.parse(jsonstring);
            } catch (e) {
                return false;
            }
            return true;
        }
        function viewAnexoHistorico(id, docid, expid, ext) {
            showHideLoading(o, !0);
            var cammo = $('<div class="modal" style="display:block">\
                <div class="modal-dialog modal-lg modal-dialog-centered">\
                    <div id="camaramodal" class="modal-content rounded">\
                        <div class="modal-header p-2 border-bottom border-dark bg-white" style="cursor: move;">\
                            <h5 class="modal-title text-dark">' + o.appvm[id].titulo() + '</h5>\
                            <span id="camaraclose" title="Cerrar" class="btn btn-sm btn-outline-danger btn-lg border"><i style="font-size:16px" class="fas fa-times"></i></span>\
                        </div>\
                        <div class="modal-body p-2" style="height:100%">\
                            <div class="col-12 col-sm-12 p-0" style="max-height:100%;">\
                            <div class="rounded bg-gray contenttopreview"></div>\
                            <div class="rounded border align-items-center justify-content-center text-muted bg-gray noview" style="height:50vh; font-size:2rem;display:flex;opacity:0.5">Vista previa no disponible</div>\
                        </div>\
                        </div>\
                    </div>\
                </div>\
            </div>');
            cammo.find("#camaraclose").on("click", function () { cammo.remove(); });
            $("body").append(cammo);
            $.ajax({
                url: o.datasend.urlGlobal + 'FECapturador.aspx/InvokeMethodWcf', type: "POST", contentType: "application/json; charset=utf-8",
                data: JSON.stringify({ method: "ConsultaAnexo", consulta: JSON.stringify({ DocID: docid, ExpID: expid, Extension: ext }), proyid: o.datasend.proyid }),
            }).done((j) => {
                j = j.d;
                if (j.Success) {
                    var json = JSON.parse(j.ReturnedObject);
                    cammo.find(".noview").hide();
                    switch (o.appvm[id].tipo()) {
                        case o.TE.Imagen:
                            cammo.find("div.contenttopreview").append('<div style="max-height:75vh; overflow:auto"><img src="data:image/png;base64,' + json.datos + '" class="col-12 col-sm-12 p-0"/></div>');
                            break;
                        case o.TE.Audio:
                            cammo.find("div.contenttopreview").append('<audio controls class="col-12 col-sm-12 p-0">\
                                        <source src="data:audio/mp3;base64,' + json.datos + '" type="audio/mpeg">\
                                    El navegador no soporta la extensi&oacute;n del audio, solo se puede reproducir mp3.</audio>');
                            break;
                        case o.TE.Video:
                            cammo.find("div.contenttopreview").append('<div style="max-height:75vh; overflow:auto"><video controls playsinline class="col-12 col-sm-12 p-0">\
                                        <source src="data:video/mp4;base64,' + json.datos + '" type="video/mp4">\
                                    El navegador no soporta la extensi&oacute;n del video, solo se puede reproducir mp4.</video></div>');
                            break;
                        case o.TE.Documento:
                            if (_.includes(['png', 'gif', 'jpg', 'bmp', '.png', '.gif', '.jpg', '.bmp', 'jpeg', '.jpeg'], ane2.Extension.toLowerCase()))
                                cammo.find("div.contenttopreview").append('<div style="max-height:75vh; overflow:auto"><img src="data:image/png;base64,' + json.datos + '" class="col-12 col-sm-12 p-0"/></div>');
                            else if (_.includes(['pdf', '.pdf'], ane2.Extension.toLowerCase())) {
                                var byteCharacters = window.atob(json.datos), byteArrays = [], sliceSize = 512;
                                for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                                    var slice = byteCharacters.slice(offset, offset + sliceSize), byteNumbers = new Array(slice.length);
                                    for (var i = 0; i < slice.length; i++) byteNumbers[i] = slice.charCodeAt(i);
                                    var byteArray = new Uint8Array(byteNumbers);
                                    byteArrays.push(byteArray);
                                }

                                if (json.thumb) {
                                    if (window.navigator.userAgent.indexOf("MSIE") > 0 || window.navigator.userAgent.indexOf("Trident") > 0) {
                                        //Es Internet Explorer
                                        var pagActual = 0, totalPags = json.numPags, fileModule = '<div>\
                                                                            <div class="p-2 row justify-content-between rounded" style="background-color: #dedddd;"><i class="fas fa-chevron-left btn p-0 ' + (pagActual === 0 ? "disabled" : "") + '" style="cursor:pointer;"></i><span><span class="actPage">1</span>/' + json.numPags + '</span><i class="fas fa-chevron-right btn p-0 ' + (pagActual === totalPags - 1 ? "disabled" : "") + '" style="cursor:pointer;"></i></div>\
                                                                            <div class="imgsReel" style="max-height:75vh; overflow:auto"></div>\
                                                                            </div>', showPageFile = function (numactpage, totalpages) {
                                                cammo.find(".actPage").text(numactpage + 1);
                                                $(".imgsReel").children("img").attr("hidden", true);
                                                $(".imgsReel").find(".imgtoshow" + numactpage).removeAttr("hidden");
                                                cammo.find(".fa-chevron-right")[numactpage === totalpages - 1 ? "addClass" : "removeClass"]("disabled");
                                                cammo.find(".fa-chevron-left")[numactpage === 0 ? "addClass" : "removeClass"]("disabled");
                                            };

                                        cammo.find("div.contenttopreview").append(fileModule);
                                        cammo.find(".imgsReel").append('<img src="data:image/png;base64,' + json.thumb + '" class="col-12 col-sm-12 p-0 imgtoshow0"/>');
                                        cammo.find(".fa-chevron-right").on("click", function () {
                                            if (pagActual < totalPags) {
                                                pagActual = pagActual + 1;
                                                if ($(".imgsReel").find(".imgtoshow" + pagActual)[0])
                                                    showPageFile(pagActual, totalPags);
                                                else {
                                                    $.ajax({
                                                        url: o.datasend.urlGlobal + "FECapturador.aspx/GetPageImage",
                                                        data: JSON.stringify({ base64: json.datos, pageNum: pagActual }),
                                                        success: function (j) {
                                                            j = j.d;
                                                            if (j.Success) {
                                                                var jpage = j.ReturnedObject ? JSON.parse(j.ReturnedObject) : [], fpage = jpage.length > 0 ? jpage[0] : "";
                                                                cammo.find(".imgsReel").append('<img hidden src="data:image/png;base64,' + fpage + '" class="col-12 col-sm-12 p-0 imgtoshow' + pagActual + '"/>');
                                                                showPageFile(pagActual, totalPags);
                                                            }
                                                            else Error(j.Titulo, j.Mensaje);
                                                        },
                                                        error: function (e) { errorFormElec(o, e); }
                                                    });
                                                }
                                            }
                                        });
                                        cammo.find(".fa-chevron-left").on("click", function () {
                                            if (pagActual > 0) {
                                                if ($(".imgsReel").find(".imgtoshow" + (pagActual - 1).toString())[0]) {
                                                    pagActual = pagActual - 1;
                                                    showPageFile(pagActual, totalPags);
                                                }
                                            }
                                        });
                                    }
                                    else
                                        cammo.find("div.contenttopreview").append("<object style='min-height:80vh' class='w-100' type='application/pdf' data='" + window.URL.createObjectURL(new Blob(byteArrays, { type: "application/pdf" })) + "' download='" + ane.NombreOriginal + "'><embed type='application/pdf' data='" + window.URL.createObjectURL(new Blob(byteArrays, { type: "application/pdf" })) + "'/></object>");
                                }
                            }
                            break;
                    }
                } else toasty('', j.Mensaje, 'error');
            }).always(() => { showHideLoading(o, !1); });
        }
        function wcfFileTransferInvoke(o, id, ane, text) {
            return new Promise((r) => {
                showElementLoading(o, !0, id, text); //primero me aseguro de mostrar el loading
                sleep(500).then(() => {
                    $.ajax({
                        url: o.datasend.urlGlobal + 'FECapturador.aspx/InvokeMethodWcf',
                        data: JSON.stringify({ method: "ConsultaAnexo", consulta: JSON.stringify(ane), proyid: o.datasend.proyid })
                    }).done((j) => {
                        j = j.d;
                        showElementLoading(o, !1, id);
                        j.Success ? r(j.ReturnedObject) : toasty('', j.Mensaje, 'error');
                    });
                });
            });
        }
        function wcfServicioGenerico(o, id, text, method, data, token) {
            return new Promise((r) => {
                showElementLoading(o, !0, id, text); //primero me aseguro de mostrar el loading
                sleep(500).then(() => {
                    var url = o.datasend.urlGlobal.substring(0, o.datasend.urlGlobal.lastIndexOf("/"));
                    url = url.substring(0, url.lastIndexOf("/"));
                    url = url + "/WcfServicios/WcfServicios.svc/json/ServicioGenericoRest";
                    !!data.showlog && (data.showlog = !0);
                    $.ajax({
                        url: url,
                        headers: { Authorization: "Bearer " + token },
                        data: JSON.stringify(
                            JSON.stringify({ initialmethod: method, assemblypath: "ServiciosDigipro.dll", data: data })
                        )
                    }).done((j) => {
                        j = JSON.parse(j);
                        showElementLoading(o, !1, id);
                        (j.response.success && j.response.servicesuccess) ? r(j.data) :
                            toasty(j.response.servicemessage, "", "error"), console.log(j);
                    });
                });
            });
        }
        function wcfServicioToken(o, id) {
            return new Promise((r) => {
                showElementLoading(o, !0, id, "Generando token"); //primero me aseguro de mostrar el loading
                sleep(500).then(() => {
                    var url = o.datasend.urlGlobal.substring(0, o.datasend.urlGlobal.lastIndexOf("/"));
                    url = url.substring(0, url.lastIndexOf("/"));
                    url = url + "/WcfServicios/WcfServicios.svc/json/GeneraToken";
                    $.ajax({
                        url: url,
                        data: JSON.stringify(o.datasend.userName)
                    }).done((j) => {
                        j = JSON.parse(j);
                        showElementLoading(o, !1, id);
                        j.Token ? r(j.Token) : toasty(j.response.servicemessage, "", "error");
                    });
                });
            });
        }



        //Configurador de Documentos Electronicos        
        function clearArchivo(id, tipo) {
            var o = getOpts();
            if (o.appvm[id]) {
                tipo === "archivo" && $("#attrarchivotitulo" + id).text("");
                o.appvm[id][tipo](""), updateOpts(o, true);
            }
        }
        function checkMetadato(o, tdid, tipo, id, nommeta, attr) {
            //bigint    	1
            //datetime  	2
            //DD/MM/AAAA	3
            //AAAA/MM/DD	4
            //DD-MM-AAAA	5
            //AAAA-MM-DD	6
            //VarChar   	7
            //Char      	8
            //Int       	9
            //Tinyint   	10
            //bit       	11
            //Catalogo  	12
            //Money     	13
            //varchar combo 14
            //json     	    15
            var accep = [];
            var result = { valid: false, mensaje: "El metadato " + nommeta + " no es compatible." };
            var tl = o.appvm[id].tipolista ? o.appvm[id].tipolista() : "", ta = o.appvm[id].tipoasociacionObject;
            if (tdid === 14 && o.appvm[id].tipo() === o.TE.ComboDinamico) {
                result.valid = true;
                return result;
            }
            if (tdid === 7 || tdid === 8 || tdid === 15) {
                if (ta) {
                    if (ta.Valor() === "idid" && tl !== "checkbox") {
                        result.mensaje = "El metadato " + nommeta + " no es compatible, ya que la asociacion '" + ta.Nombre() + "' solo puede ser relacionado con un metadato entero.";
                        return result;
                    }
                    result.valid = true;
                    return result;
                } else {
                    result.valid = true;
                    return result;
                }
            }
            if (tdid === 1 || tdid === 9 || tdid === 10 || tdid === 13) {
                if (ta) {
                    if (ta.Valor() !== "idid" && ta.Valor() !== "iddesc") {
                        result.mensaje = "El metadato " + nommeta + " no es compatible, ya que la asociacion '" + ta.Nombre() + "' solo puede ser relacionado con un metadato caracter.";
                        return result;
                    }
                    result.valid = true;
                    return result;
                } else {
                    result.valid = _.includes([o.TE.Numero, o.TE.Moneda], tipo);
                    return result;
                }
            }
            if (tdid === 2 || tdid === 3 || tdid === 4 || tdid === 5 || tdid === 6) {
                if (tipo === o.TE.RangoFechas && attr === "metadatorango") {
                    result.mensaje = "El metadato " + nommeta + " no es compatible, ya que el Rango solo puede ser relacionado con un metadato caracter.";
                    return result;
                }
                accep = [o.TE.Fecha, o.TE.RangoFechas];
                result.valid = $.inArray(tipo, accep) !== -1;
                return result;
            }
            if (tdid === 11) {
                accep = [o.TE.Logico];
                result.valid = $.inArray(tipo, accep) !== -1;
                return result;
            }
            if (tdid === 12) {
                if (ta) {
                    tl === "checkbox" ? result.mensaje = "El metadato " + nommeta + " no es compatible, ya que la lista '" + tl + "' solo puede ser relacionado con un metadato caracter."
                        : (ta.Valor() !== "idid" && ta.Valor() !== "iddesc" && (result.mensaje = "El metadato " + nommeta + " no es compatible, ya que la asociacion '" +
                            ta.Nombre() + "' solo puede ser relacionado con un metadato entero o catalogo."));
                    result.valid = true;
                    return result;
                }
                result.mensaje = "El metadato " + nommeta + " no es compatible, ya que el metadato catalogo solo es compatible con el elemento lista.";
                return result;
            }
            return result;
        }
        function deleteComments(nod, id) {
            var toDelete = false;

            nod.each(function (i, objNode) {
                var objChildNode = objNode.firstChild;

                while (objChildNode) {
                    if (objChildNode.nodeType === 8 && objChildNode.nodeValue.indexOf(id) !== -1) { //initial ko
                        toDelete = true;
                    } else if (objChildNode.nodeType === 8 && toDelete === true) { //ending ko
                        objNode.removeChild(objChildNode);
                        toDelete = false;
                        return;
                    } else if (objChildNode.nodeType === 1) {
                        deleteComments($(objChildNode), id);
                    }
                    if (objChildNode.nodeType === 8 && toDelete === true) {
                        objNode.removeChild(objChildNode);
                        objChildNode = objNode.firstChild;
                    } else {
                        objChildNode = objChildNode.nextSibling;
                    }
                }
            });
        }
        function drawHtml(jelem, parent, drawed, o) {
            var masive = parent === null, elemid = jelem["@idelemento"], elemDom = $("<!-- ko --><!-- /ko -->");
            createElementToView(o, jelem, {}, !0);
            parent = findMethodByElementType(o, jelem, o.methodType.getParent, [parent]);
            findMethodByElementType(o, jelem, o.methodType.drawHtml, [parent, elemDom, elemid, drawed]);
            if (!masive) {//validacion para saber que es pintado masivo asi se ahorra milisegundos
                o.plantilla.removeClass("state-default-plantilla-empty");
                o.plantilla.find(".state-hover-plantilla").removeClass("state-hover-plantilla");
                revaluateDataJson(o);
                updateOpts(o, true);
                var tt = o.appvm[o.appvm[elemid].elementopadre()].titulo ? o.appvm[o.appvm[elemid].elementopadre()].titulo() : "Plantilla";
                addTimelineRow(o, 'Elemento "' + elemid + '" agregado a "' + tt + "-" + o.appvm[elemid].elementopadre() + '"', o.LogTy.Add);
            }
        }
        function drawAttributes(id) {
            var o = getOpts();
            $("#nav-tab a#nav-" + o.id + "props-tab").removeAttr("hidden").tab('show');
            $("#nav-info-tab").tab('show');
            if (o.appvm[id]) {
                showHideLoading(o, !0, "Dibujando atributos del elemento");
                o.elementoatributosdibujar = id;
                $("#nav-" + o.id + "props").find(".ContentStart,.ContentEnd").empty();
                var elemAttr = getElementTypeAttributes(o, o.appvm[id].tipo());
                var attrs = _.map(_.orderBy(_.map(_.keys(elemAttr.Atributos), function (val) { return { key: val, desc: elemAttr.Atributos[val].Descripcion }; }), 'desc'), 'key');
                for (var a = 0; a < attrs.length; a++) {
                    if (elemAttr.Atributos[attrs[a]].Configurable === true) {
                        var tagname = "", resetjsval = {}, compat = "";
                        elemAttr.Atributos[attrs[a]] instanceof Object && !(elemAttr.Atributos[attrs[a]] instanceof Array) && (tagname = elemAttr.Atributos[attrs[a]].Descripcion);
                        tagname.length < 1 && (tagname = attrs[a].toLowerCase());

                        var tipo = attrs[a].toLowerCase(), t,
                            p = { tipo: tipo, id: id, titulo: tagname, val: o.appvm[id][tipo](), options: [], visible: !0 };

                        if ("margenizquierdo" === tipo) {
                            elemAttr.Atributos[attrs[a]].Valor.forEach((_a, ind) => {
                                if (ind === 0) _a.Valor = "0";
                                else if (ind === 1) _a.Valor = "8.333333%";
                                else if (ind === 2) _a.Valor = "16.666667%";
                                else if (ind === 3) _a.Valor = "25%";
                                else if (ind === 4) _a.Valor = "33.333333%";
                                else if (ind === 5) _a.Valor = "41.666667%";
                                else if (ind === 6) _a.Valor = "50%";
                                else if (ind === 7) _a.Valor = "58.333333%";
                                else if (ind === 8) _a.Valor = "66.666667%";
                                else if (ind === 9) _a.Valor = "75%";
                                else if (ind === 10) _a.Valor = "83.333333%";
                                else if (ind === 11) _a.Valor = "91.666667%";
                            });
                        }
                        if ("margenderecho" == tipo) {
                            elemAttr.Atributos[attrs[a]].Valor.forEach((_a, ind) => {
                                if (ind === 0) _a.Valor = "0";
                                else if (ind === 1) _a.Valor = "8.333333%";
                                else if (ind === 2) _a.Valor = "16.666667%";
                                else if (ind === 3) _a.Valor = "25%";
                                else if (ind === 4) _a.Valor = "33.333333%";
                                else if (ind === 5) _a.Valor = "41.666667%";
                                else if (ind === 6) _a.Valor = "50%";
                                else if (ind === 7) _a.Valor = "58.333333%";
                                else if (ind === 8) _a.Valor = "66.666667%";
                                else if (ind === 9) _a.Valor = "75%";
                                else if (ind === 10) _a.Valor = "83.333333%";
                                else if (ind === 11) _a.Valor = "91.666667%";
                            });
                        }
                        if (o.appvm[id].tipo() === o.TE.OCR && _.includes(["prefijo", "textocorreccion"], tipo)) continue;
                        if (_.includes(["campo"], tipo)) continue;

                        if (tipo === "valor" && o.appvm[id].tipo() === o.TE.Leyenda)
                            p.val = "", t = $("<atributo-wysiwyg params='" + JSON.stringify(p) + "'></atributo-wysiwyg>");
                        else
                            switch (tipo) {
                                case "configjson": case "importartemplatetabla": case "cascadahijo": case "resumen2": case "importararchivoestilos":
                                    t = $("<atributo-" + tipo + " params='" + JSON.stringify(p) + "'></atributo-" + tipo + ">");
                                    break;
                                case "mappingocr": case "mappingscore": case "mappingpepaml":
                                    switch (tipo) {
                                        case "mappingocr": p.event = 10; break;
                                        case "mappingscore": p.event = 11; break;
                                        case "mappingpepaml": p.event = 12; break;
                                    }
                                    t = $("<atributo-mappingelements params='" + JSON.stringify(p) + "'></atributo-" + tipo + ">");
                                    break;
                                case "alineadotexto": case "decoraciontexto": case "estilotexto": case "grosortexto": case "alineadoencabezadotabla":
                                    p.options = elemAttr.Atributos[attrs[a]].Valor;
                                    t = $("<atributo-botones params='" + JSON.stringify(p) + "'></atributo-botones>");
                                    break;
                                case "archivo": case "imagenlogico":
                                    t = $("<atributo-archivo params='" + JSON.stringify(p) + "'></atributo-archivo>");
                                    break;
                                case "titulo": case "subtitulo": case "mascara": case "leyendavideo": case "leyendaaudio":
                                case "acuerdofirma": case "regexrerrormsg": case "urllink": case "ayuda": case "idunico": case "valor":
                                case "textoopcioncatalogo": case "expresionregular": case "hojaestilos": case "nombreestilopersonal": case "urlestilos":
                                    t = $("<atributo-textarea params='" + JSON.stringify(p) + "'></atributo-textarea>");
                                    break;
                                case "contenidoestaticohtml":
                                    p.val = "",
                                        t = $("<atributo-wysiwyg params='" + JSON.stringify(p) + "'></atributo-wysiwyg>");
                                    break;
                                case "filtrarcatalogo": case "tipificacionunica": case "resumen": case "camposfiltros":
                                case "contenidoestatico": case "tipificacionpermitida": case "navegacion":
                                    if (tipo !== "navegacion") resetjsval[tipo] = p.val, p.val = "";
                                    t = $("<atributo-" + (_.includes(["contenidoestatico", "camposfiltros", "navegacion"], tipo) ? "resumen" : tipo === "tipificacionpermitida" ? "select" : tipo) + " params='" + JSON.stringify(p) + "'></atributo-" + (_.includes(["contenidoestatico", "camposfiltros", "navegacion"], tipo) ? "resumen" : tipo === "tipificacionpermitida" ? "select" : tipo) + ">");
                                    break;
                                default:
                                    if (tipo.indexOf("color") === 0)
                                        t = $("<atributo-color params='" + JSON.stringify(p) + "'></atributo-color>");
                                    else if (elemAttr.Atributos[attrs[a]].Valor instanceof Array
                                        || _.includes(["metadato", "metadatoinicial", "metadatofinal", "metadatorango"], tipo)) {
                                        p.options = _.clone(elemAttr.Atributos[attrs[a]].Valor);
                                        switch (tipo) {
                                            case "metadato": case "metadatoinicial": case "metadatofinal": case "metadatorango":
                                                var copymetadata = [];
                                                _.forEach(o.datatags.metadatos, function (valmetadato) {
                                                    copymetadata.push({ Nombre: valmetadato.NombreCampo.replace(/\'/g, '') + ' (' + valmetadato.TipoDato.toLowerCase().trim() + ')', Valor: valmetadato.Nombre });
                                                });
                                                p.options = copymetadata;
                                                break;
                                            case "usarcoordenadas":
                                                p.options = _.compact(_.map(o.appvm.elementsGeo(), function (z) {
                                                    if (o.appvm[z]) return { Nombre: o.appvm[z].titulo(), Valor: z };
                                                    return false;
                                                }));
                                                p.options.splice(0, 0, { Nombre: "Coordenadas plantilla", Valor: "0" });
                                                p.options.splice(0, 0, { Nombre: "--Seleccione--", Valor: "-1" });
                                                break;
                                            case "tipocodigo":
                                                o.datatags[tipo] = p.options;
                                                break;
                                            case "elementoligado":
                                                p.options = [{ Valor: "", Nombre: "--Seleccione--" }];
                                                p.options = p.options.concat(_.map(_.filter(Object.getOwnPropertyNames(o.appvm), function (v) { if (_.startsWith(v, "formElec_element") && o.appvm[v] && _.includes([o.TE.TextArea, o.TE.Texto], o.appvm[v].tipo && o.appvm[v].tipo())) return v; }), function (v) { return { Valor: v, Nombre: o.appvm[v].titulo() }; }));
                                                break;
                                            case "paginaavanzar": case "paginaregresar":
                                                var pags = [];
                                                pags.push({ Nombre: '--- Seleccione ---', Valor: '' });
                                                for (var el in o.appvm) {
                                                    if (el.indexOf("formElec_") > -1) {
                                                        var tipoel = o.appvm[el].tipo();
                                                        tipoel === o.TE.Pagina && pags.push({ Nombre: o.appvm[el].titulo(), Valor: el });
                                                    }
                                                }
                                                p.options = pags;
                                                break;
                                            case "tareafinalizar":
                                                if (o.datatags.tareas) {
                                                    p.options = _.clone(o.datatags.tareas);
                                                    p.options.splice(0, 0, { Nombre: "Seleccione", Valor: "" });
                                                }
                                                break;
                                            case "proveedor":
                                                if (o.appvm[id].tipo() === o.TE.OCR) p.options.splice(0, 1);
                                                break;
                                        }
                                        p.val = p.val.toString();
                                        t = $("<atributo-select params='" + JSON.stringify(p) + "'></atributo-select>");
                                    }
                                    else if (typeof elemAttr.Atributos[attrs[a]].Valor === "boolean")
                                        t = $("<atributo-logico params='" + JSON.stringify(p) + "'></atributo-logico>");
                                    else if (typeof elemAttr.Atributos[attrs[a]].Valor === "string" || typeof elemAttr.Atributos[attrs[a]].Valor === "number")
                                        t = $("<atributo-texto params='" + JSON.stringify(p) + "'></atributo-texto>");
                                    break;
                            }

                        if (_.includes(["colortabactivo", "colortabinhabilitado", "colortabnormal", "colortabtextoactivo", "colortabtextoinhabilitado", "colortabtextonormal"], tipo)) continue;
                        //estilos de tabs que se pasaron a estilos globales
                        if (_.includes(["subtitulo", "titulo", "idunico", "nombreestilopersonal"], tipo))
                            $("#nav-inicio .ContentStart").prepend(t);
                        else if (_.includes(["valor", "longitudmaxima", "longitudminima", "urlestilos", "hojaestilos"], tipo))
                            $("#nav-inicio .ContentStart").append(t);
                        else if (typeof elemAttr.Atributos[attrs[a]].Valor === "boolean")
                            $("#nav-inicio .ContentEnd").append(t);
                        else if (_.includes(["alineadoencabezadotabla", "anchocapturador", "grosorbordeplantilla", "tamanofuente", "tipofuente",
                            "margenizquierdo", "margenderecho", "tamanio", "ancho", "grosorborde", "alturacampo", "alto", "orientacion", "ayuda",
                            "estilobotonesaudio", "estilobotonesboton", "estilobotonescodigoqr", "estilobotonescodigobarras", "estilobotonesimagen", "estilocomandos", "estilotabs"], tipo))
                            $("#nav-colors .ContentStart").prepend(t);
                        else if (_.includes(["alineadotexto", "decoraciontexto", "estilotexto", "grosortexto"], tipo))
                            $("#nav-colors .ContentStart").append(t);
                        else if (tipo.indexOf("color") === 0)
                            $("#nav-colors .ContentEnd").append(t);
                        else if (_.includes(["tipodoc", "metadato", "cantidadmaximaclic", "urlnuevapagina", "textoopcioncatalogo"], tipo))
                            $("#nav-plus .ContentStart").append(t);
                        else
                            $("#nav-plus .ContentEnd").append(t);

                        ko.applyBindings(o.appvm, t[0]);
                        resetjsval[tipo] && o.appvm[id][tipo](resetjsval[tipo]);
                    }
                }

                //Seccion de Info
                drawAttributeInformativeForMenu("", `<div>Titulo: <span class="text-bold">${o.appvm[id].titulo()}</span></div>
                <div>Tipo: <span class="text-bold">${elemAttr.Atributos.Nombre.Valor}</span></div>
                <div>ID: <span class="text-bold">${id}</span></div>
                <div>CSS: <span class="text-bold">${o.appvm[id].csselementoglobal()}</span></div>`, 230, "ace4ff");
                if (!_.includes([o.TE.Plantilla], o.appvm[id].tipo())) {
                    //se consiguen los nombre de las macros
                    let items = [], macro = 0, macronames = [], regl = 0, reglanames = [], comp = 0, compnames = [], serv = 0, servnames = [], oper = 0, opernames = [];
                    _.forEach(_.keys(o.appvm[o.idPlantilla].macros()), function (v) {
                        items.push({ T: o.appvm[o.idPlantilla].macros()[v].name, It: getStepsForElement(o, id, v) });
                        //conseguir numero de veces mencionado en macros
                        let count = _.filter(o.appvm[o.idPlantilla].macros()[v].steps, { who: id }).length;
                        if (count > 0) macro += count, macronames.push({ T: o.appvm[o.idPlantilla].macros()[v].name, C: () => { } });
                    });
                    //conseguir numero de veces mencionado en reglas
                    _.forEach(_.keys(o.appvm[o.idPlantilla].reglas()), function (v) {
                        _.forEach(_.keys(o.appvm[o.idPlantilla].reglas()[v].actions), function (elmkeyact) {
                            _.forEach(_.keys(o.appvm[o.idPlantilla].reglas()[v].actions[elmkeyact].subject), function (elmkeyactsub) {
                                !!elmkeyactsub && _.forEach(elmkeyactsub.split(","), function (subjsp) {
                                    if (subjsp === id) regl++, reglanames.push({ T: o.appvm[o.idPlantilla].reglas()[v].name, C: () => { } });
                                });
                            });
                        });
                        _.forEach(_.keys(o.appvm[o.idPlantilla].reglas()[v].conditions), function (elmkeycond) {
                            _.forEach(_.keys(o.appvm[o.idPlantilla].reglas()[v].conditions[elmkeycond].subject), function (elmkeycondsub) {
                                var subjt = o.appvm[o.idPlantilla].reglas()[v].conditions[elmkeycond].subject[elmkeycondsub].subject;
                                !!subjt && _.forEach(subjt.split(","), function (subjsp) {
                                    if (subjsp === id) regl++, !_.includes(_.map(reglanames, (f) => { return f.T; }), o.appvm[o.idPlantilla].reglas()[v].name) && reglanames.push({ T: o.appvm[o.idPlantilla].reglas()[v].name, C: () => { } });
                                });
                            });
                        });
                    });
                    //conseguir numero de veces mencionado en servicios
                    _.forEach(_.keys(o.appvm[o.idPlantilla].servicios()), function (v) {
                        if (!_.isEmpty(o.appvm[o.idPlantilla].servicios()[v].prefijoentrada) && !_.isEmpty(o.appvm[o.idPlantilla].servicios()[v].prefijosalida))
                            if (o.appvm[id].idunico && !_.isEmpty(o.appvm[id].idunico()))
                                if (_.startsWith(o.appvm[id].idunico(), o.appvm[o.idPlantilla].servicios()[v].prefijoentrada) || _.startsWith(o.appvm[id].idunico(), o.appvm[o.idPlantilla].servicios()[v].prefijosalida))
                                    serv++, servnames.push({ T: o.appvm[o.idPlantilla].servicios()[v].customname, C: () => { } });
                    });
                    //conseguir numero de veces mencionado en componentes
                    _.forEach(_.keys(o.appvm[o.idPlantilla].components()), function (v) {
                        _.forEach(_.keys(o.appvm[o.idPlantilla].components()[v].pin), function (elmkeypinsub) {
                            var subjt = o.appvm[o.idPlantilla].components()[v].pin[elmkeypinsub].idelem;
                            !!subjt && _.forEach(subjt.split(","), function (subjsp) {
                                if (subjsp === id) comp++, compnames.push({ T: o.appvm[o.idPlantilla].components()[v].customname, C: () => { } });
                            });
                        });
                        _.forEach(_.keys(o.appvm[o.idPlantilla].components()[v].pout), function (elmkeypinsub) {
                            var subjt = o.appvm[o.idPlantilla].components()[v].pout[elmkeypinsub].idelem;
                            !!subjt && _.forEach(subjt.split(","), function (subjsp) {
                                if (subjsp === id) comp++, !_.includes(_.map(compnames, (f) => { return f.T; }), o.appvm[o.idPlantilla].components()[v].customname) && compnames.push({ T: o.appvm[o.idPlantilla].components()[v].customname, C: () => { } });
                            });
                        });
                    });
                    //conseguir numero de veces mencionado en operaciones matematicas
                    _.forEach(_.keys(o.appvm[o.idPlantilla].operacionesmatematicas()), function (v) {
                        _.forEach(o.appvm[o.idPlantilla].operacionesmatematicas()[v].identifiers, function (keyidmat) {
                            if (_.includes(keyidmat.idelem, id)) oper++, opernames.push({ T: o.appvm[o.idPlantilla].operacionesmatematicas()[v].customname, C: () => { } });
                        });
                    });

                    drawAttributeInformativeForMenu("", `<div>Usado en Macros: <span class="text-bold" style="font-size: .9rem;" id="countactionmacro">${macro}</span>&nbsp;<i id="watchmacro" class="fas fa-caret-square-down" style="cursor: pointer;"></i></div>
                    <div>Usado en Reglas: <span class="text-bold" style="font-size: 1.1rem;" id="countusedreglas">${regl}</span>&nbsp;<i id="watchregla" class="fas fa-caret-square-down" style="cursor: pointer;"></i></div>
                    <div>Usado en Servicios: <span class="text-bold" style="font-size: 1.1rem;" id="countusedserv">${serv}</span>&nbsp;<i id="watchserv" class="fas fa-caret-square-down" style="cursor: pointer;"></i></div>
                    <div>Usado en Componentes: <span class="text-bold" style="font-size: 1.1rem;" id="countusedcomp">${comp}</span>&nbsp;<i id="watchcomp" class="fas fa-caret-square-down" style="cursor: pointer;"></i></div>
                    <div>Usado en Operaciones: <span class="text-bold" style="font-size: 1.1rem;" id="countusedoper">${oper}</span>&nbsp;<i id="watchoper" class="fas fa-caret-square-down" style="cursor: pointer;"></i></div>`, 230, "ffcbf4");
                    drawMenuInnerObject("watchmacro", macronames);
                    drawMenuInnerObject("watchregla", reglanames);
                    drawMenuInnerObject("watchserv", servnames);
                    drawMenuInnerObject("watchcomp", compnames);
                    drawMenuInnerObject("watchoper", opernames);
                    items.push({ T: `Agregar nueva macro`, C: () => { createNewMacroName(o, id); } });
                    drawAttributeIconWithMenuForMenu("Agregar paso en macro", "fas fa-cogs", "bd21ca", items);
                    drawAttributeIconForMenu("Ver todo lo que afecta al elemento", "fab fa-elementor", "ff7a39", () => { infoModElements(id); });
                    drawAttributeIconForMenu("Todo a la izquierda", "fas fa-angle-double-left", "0073b7", () => { updateSortXml(o, id, o.appvm[id].elementopadre(), !0, "allleft"); });
                    drawAttributeIconForMenu("Uno a la izquierda", "fas fa-chevron-left", "0073b7", () => { updateSortXml(o, id, o.appvm[id].elementopadre(), !0, "left"); });
                    drawAttributeIconForMenu("Uno a la derecha", "fas fa-chevron-right", "0073b7", () => { updateSortXml(o, id, o.appvm[id].elementopadre(), !0, "right"); });
                    drawAttributeIconForMenu("Todo a la derecha", "fas fa-angle-double-right", "0073b7", () => { updateSortXml(o, id, o.appvm[id].elementopadre(), !0, "allright"); });
                    drawAttributeIconForMenu("Copiar elemento", "fas fa-copy", "f39c12", () => { !_.includes(o.appvm.elementCopied(), id) && o.appvm.elementCopied.push(id); });
                    drawAttributeIconForMenu("Borrar elemento", "fas fa-trash", "dd4b39", () => { infoModElements(id, !0); });
                }

                if (!_.includes([o.TE.Pagina, o.TE.Plantilla], o.appvm[id].tipo())) {
                    drawAttributeIconForMenu("Mover dentro de...", "fas fa-long-arrow-alt-down", "000000", (e) => {
                        $("#mm").menu("destroy"), $(".menu:not('visible')").remove();
                        $("body").append('<div id="mm" class="easyui-menu" style="width:180px;"></div>');
                        $("#mm").menu();

                        var appenditemm = function (v, mp) {
                            $("#mm").menu("appendItem", {
                                parent: mp ? mp.target : null,
                                text: o.appvm[v].titulo() + " (" + o.appvm[v].tipo() + ")",
                                onclick: function () {
                                    if (o.appvm[v]) {
                                        var candraw = true;
                                        //si el padre es tabber, solo secciones
                                        if (o.TE.Tabber === o.appvm[v].tipo() && o.TE.Seccion !== o.appvm[id].tipo()) candraw = false;
                                        //si el padre es tabla, solo ciertos elementos
                                        if (_.includes([o.TE.Wizard, o.TE.Audio, o.TE.CodigoQR, o.TE.Imagen, o.TE.FirmaFAD, o.TE.Georeferencia, o.TE.HuellaDigital,
                                        o.TE.Documento, o.TE.MarcadoDocumentos, o.TE.Logo, o.TE.Video, o.TE.Tabber,
                                        o.TE.Seccion, o.TE.Deslizante, o.TE.Password, o.TE.Tabla], o.appvm[id].tipo()) && o.appvm[v].tipo() === o.TE.Tabla) candraw = false;
                                        //si el padre es el mismo que ya esta actualmente
                                        if (v === o.appvm[id].elementopadre()) candraw = false;
                                        if (candraw === true) {
                                            //si el padre esta dibujado, ya que en la V2 no se dibujan todas las paginas
                                            if (o.appvm[v].elementrendered() === !0) {
                                                updateSortXml(o, id, v, !0);
                                            }
                                            else {
                                                //como no esta dibujado, solo se hace el sort en el xml
                                                updateSortXml(o, id, v, !1);
                                            }
                                            $("#mm").menu("hide");
                                        }
                                    }
                                }
                            });
                        };
                        var finditemm = function (v) {
                            var submenup = $("#mm").menu("findItem", o.appvm[o.appvm[v].elementopadre()].titulo() + " (" + o.appvm[o.appvm[v].elementopadre()].tipo() + ")");
                            appenditemm(v, submenup);
                        };
                        var evaluatedraw = function (v) {
                            if (o.appvm[v]) {
                                //Los elementos container siempre se pintan
                                if (o.TE.Pagina === o.appvm[v].tipo())
                                    appenditemm(v);
                                else if (_.includes([o.TE.Tabber, o.TE.Tabla, o.TE.Seccion], o.appvm[v].tipo()))
                                    finditemm(v);
                                //si el elemento a dibujar es tabla, que no sea el mismo del menu y que no viva dentro del mismo padre
                                else if (v !== id && o.appvm[id].elementopadre() !== v && o.TE.Tabla === o.appvm[v].tipo()) {
                                    //si el elemento actual es de la lista de abajo no se pinta
                                    if (!_.includes([o.TE.Wizard, o.TE.Audio, o.TE.CodigoQR, o.TE.Imagen, o.TE.FirmaFAD, o.TE.Georeferencia,
                                    o.TE.HuellaDigital, o.TE.Documento, o.TE.Logo, o.TE.Video,
                                    o.TE.Tabber, o.TE.Seccion, o.TE.Deslizante, o.TE.Password, o.TE.Tabla], o.appvm[id].tipo()))
                                        finditemm(v);
                                }
                            }
                        };
                        var recursive = function (elem) {
                            evaluatedraw(elem["@idelemento"]);
                            if (elem.atributos.iscontainer && elem.atributos.iscontainer === true) {
                                for (var i = 0; i < elem.elementos.elemento.length; i++) {
                                    recursive(elem.elementos.elemento[i]);
                                }
                            }
                        };
                        //paginas, se dibuja por orden jerarquico para evitar errores de dibujado
                        for (var i = 0; i < o.jobj.elemento.elementos.elemento.length; i++) {
                            recursive(o.jobj.elemento.elementos.elemento[i]);
                        }

                        $("#mm").menu("show", { left: e.pageX - 100, top: e.pageY + 10, hideOnUnhover: false });
                    });
                }

                if (_.includes(o.flexibleelement, o.appvm[id].tipo())) {
                    drawAttributeIconForMenu("Transformar elemento a otro", "fas fa-retweet", "0073b7", (e) => {
                        $("#mm").menu("destroy"), $(".menu:not('visible')").remove();
                        $("body").append('<div id="mm" class="easyui-menu" style="width:180px;"></div>');
                        $("#mm").menu();
                        o.flexibleelement.forEach(v => {
                            $("#mm").menu("appendItem", {
                                text: v.substr(0, 1).toUpperCase() + v.substr(1),
                                onclick: function () {
                                    if (_.includes(o.flexibleelement, o.appvm[id].tipo()) && _.includes(o.flexibleelement, v)) {
                                        $("#nav-tab a#nav-" + o.id + "props-tab").attr("hidden", true);
                                        $("#nav-tab a#nav-" + o.id + "file-tab").tab("show");

                                        var toTrans = $("div#" + id), parentE = findParentContainer(toTrans.parent()), oldelem = _.cloneDeep(o.appvm[id]),
                                            indextrans = $(parentE).find(".element[id^='formElec_element']").index(toTrans), oldelemkeys = _.keys(oldelem),
                                            jelem = { "elemento": { "@idelemento": id, "@tipoelemento": v, "atributos": {} } };
                                        removeElement(id), drawHtml(jelem.elemento, parentE, !1, o);
                                        var elemsparent = $(parentE).find(".element[id^='formElec_element']");
                                        insertAtIndexXml(indextrans, oldelem.elementopadre(), id, o);
                                        $("div.card#" + id).insertBefore(elemsparent[indextrans]);

                                        //Actualizar attrs del old al nuevo
                                        for (var olddata = 0; olddata < oldelemkeys.length; olddata++) {
                                            if (!_.includes(["id", "tipo", "valor", "valormetadato"], oldelemkeys[olddata]) && o.appvm[id][oldelemkeys[olddata]]) {
                                                if (typeof o.appvm[id][oldelemkeys[olddata]] === "function")
                                                    o.appvm[id][oldelemkeys[olddata]](oldelem[oldelemkeys[olddata]]());
                                                else {
                                                    o.appvm[id][oldelemkeys[olddata]] = oldelem[oldelemkeys[olddata]];
                                                }
                                            }
                                        }
                                    }
                                }
                            });
                        });
                        $("#mm").menu("show", { left: e.pageX - 100, top: e.pageY + 10, hideOnUnhover: false });
                    });
                }

                if (_.includes([o.TE.Pagina, o.TE.Seccion], o.appvm[id].tipo()) && o.appvm.elementCopied().length > 0) {
                    drawAttributeIconForMenu("Pegar elemento(s)", "fas fa-paste", "0073b7", (e) => {
                        var drawpasted = function (tocopyid, topasteid, fromsingle, copyoriginal) {
                            var drawed = drawElement(o.appvm[tocopyid].tipo(), $('div#' + topasteid));
                            if (drawed === !0) {
                                var elemid = o.id + "element" + o.appvm.maxNumberId();
                                for (var attr in o.appvm[tocopyid]) {
                                    if (o.appvm[tocopyid].hasOwnProperty(attr))
                                        if (attr.indexOf("elementopadre") >= 0)
                                            o.appvm[elemid][attr](topasteid);
                                        else if (attr.indexOf("elementrendered") >= 0 && o.appvm[elemid][attr]())
                                            continue;
                                        else if (typeof o.appvm[elemid][attr] === "function")
                                            o.appvm[elemid][attr](o.appvm[tocopyid][attr]());
                                        else
                                            o.appvm[elemid][attr] = o.appvm[tocopyid][attr];
                                }
                                if (fromsingle === true)
                                    o.appvm.elementCopied(_.filter(o.appvm.elementCopied(), function (f) { return f !== tocopyid; }));
                                else {
                                    var parentjson = searchElementInJson(o, tocopyid);
                                    tocopyid === topasteid && (copyoriginal = parentjson.elementos.elemento[parentjson.elementos.elemento.length - 1]["@idelemento"]);
                                    if (parentjson.elementos && parentjson.elementos.elemento)
                                        for (var i = 0; i < parentjson.elementos.elemento.length; i++) {
                                            if (copyoriginal === parentjson.elementos.elemento[i]["@idelemento"]) return;
                                            drawpasted(parentjson.elementos.elemento[i]["@idelemento"], elemid, false, copyoriginal);
                                        }
                                }
                            }
                        }, paste = function (tocopyid, topasteid, fromsingle) {
                            topasteid = o.appvm[tocopyid].tipo() === o.TE.Pagina ? o.idPlantilla : topasteid;
                            if (o.appvm[tocopyid].tipo() === o.TE.Pagina || o.appvm[tocopyid].tipo() === o.TE.Seccion) {
                                drawpasted(tocopyid, topasteid, false);
                                o.appvm.elementCopied(_.filter(o.appvm.elementCopied(), function (f) { return f !== tocopyid; }));
                            } else drawpasted(tocopyid, topasteid, fromsingle);
                        };

                        $("#mm").menu("destroy"), $(".menu:not('visible')").remove();
                        $("body").append('<div id="mm" class="easyui-menu" style="width:180px;"></div>');
                        $("#mm").menu();
                        _.forEach(o.appvm.elementCopied(), function (v) {
                            $("#mm").menu("appendItem", {
                                text: o.appvm[v].titulo(),
                                onclick: function () { paste(v, id, true); }
                            });
                        });
                        if (o.appvm.elementCopied().length > 0) //por si ya pego todo y no refresco el menu
                            $("#mm").menu("appendItem", {
                                text: "Todo",
                                onclick: function () { _.forEach(o.appvm.elementCopied(), function (v) { paste(v, id, true); }); }
                            });
                        $("#mm").menu("show", { left: e.pageX - 100, top: e.pageY + 10, hideOnUnhover: false });
                    });
                }

                //Nueva funcionalidad de exportar elementos a otra plantilla
                if (_.includes([o.TE.Pagina, o.TE.Seccion], o.appvm[id].tipo())) {
                    drawAttributeIconForMenu("Exportar elemento (XML)", "fas fa-copy", "f39c12", () => {
                        var xml = xmlToString(o, !0, id);
                        if (xml !== null) {
                            var blobdata = new Blob([xml], { type: "text/plain; charset=UTF-8" });
                            var titulo = o.appvm[id].titulo();
                            if (!titulo.length) titulo = "Elemento sin titulo";
                            if (window.navigator.msSaveOrOpenBlob) {
                                window.navigator.msSaveBlob(blobdata, titulo + ".xml");
                            }
                            else {
                                var elem = window.document.createElement("a");
                                elem.href = window.URL.createObjectURL(blobdata);
                                elem.download = titulo + ".xml";
                                document.body.appendChild(elem);
                                elem.click();
                                document.body.removeChild(elem);
                            }
                        }
                    });
                }
                //Nueva funcionalidad de importar elementos a otra plantilla
                if (_.includes([o.TE.Pagina], o.appvm[id].tipo())) {
                    drawAttributeIconForMenu("Importar elemento (XML)", "fas fa-copy", "f39c12", () => {
                        var fileinput = $('<input type="file" accept="text/xml">');
                        $("body").append(fileinput);
                        fileinput.on("change", function () {
                            fileinput = $(this);
                            var file = fileinput.get(0).files[0],
                                label = fileinput.val().replace(/\\/g, "/").replace(/.*\//, ""),
                                ext = label.substring(label.lastIndexOf(".") + 1).toLowerCase();
                            if (!_.includes(["txt", "xml"], ext)) {
                                toasty("Solo se permiten extensiones de tipo txt ó xml");
                                fileinput.remove();
                                return;
                            }
                            var reader = new FileReader();
                            reader.addEventListener("load", () => {
                                var json = parser.parse(reader.result, o.jsonoptions), newelement;
                                var searchJson = function (json, elem, id) {
                                    var newel = null;
                                    if (json.elemento["@idelemento"] === id) return json.elemento;
                                    if (json.elemento.elementos && json.elemento.elementos.elemento)
                                        for (var j = 0; j < json.elemento.elementos.elemento.length; j++) {
                                            newel = searchJsonRecursive(json.elemento.elementos.elemento[j], id);
                                            if (newel != null) return newel;
                                        }
                                    return newel;
                                };
                                var searchJsonRecursive = function (elem, id) {
                                    if (elem["@idelemento"] === id) return elem;
                                    var newel = null;
                                    if (elem.elementos && elem.elementos.elemento)
                                        for (var j = 0; j < elem.elementos.elemento.length; j++) {
                                            newel = searchElementRecursive(elem.elementos.elemento[j], id);
                                            if (newel != null) return newel;
                                        }
                                    return newel;
                                };
                                var drawpasted = function (tocopyid, topasteid) {
                                    var drawed = drawElement(newelement["@tipoelemento"], $('div#' + topasteid));
                                    if (drawed === !0) {
                                        var elemid = o.id + "element" + o.appvm.maxNumberId();
                                        for (var attr in newelement.atributos) {
                                            if (attr.indexOf("elementopadre") >= 0)
                                                o.appvm[elemid][attr](topasteid);
                                            else if (attr.indexOf("elementrendered") >= 0 && o.appvm[elemid][attr]())
                                                continue;
                                            else if (typeof o.appvm[elemid][attr] === "function")
                                                o.appvm[elemid][attr](newelement.atributos[attr]);
                                            else
                                                o.appvm[elemid][attr] = newelement.atributos[attr];
                                        }

                                        var parentjson = searchJson(json, o, tocopyid);
                                        //tocopyid === topasteid && (copyoriginal = parentjson.elementos.elemento[parentjson.elementos.elemento.length - 1]["@idelemento"]);
                                        if (parentjson.elementos && parentjson.elementos.elemento)
                                            for (var i = 0; i < parentjson.elementos.elemento.length; i++) {
                                                //if (copyoriginal === parentjson.elementos.elemento[i]["@idelemento"]) return;
                                                newelement = parentjson.elementos.elemento[i];
                                                drawpasted(parentjson.elementos.elemento[i]["@idelemento"], elemid);
                                            }
                                    }
                                };
                                fileinput.remove(), (newelement = json.elemento), drawpasted(json.elemento["@idelemento"], id, !1),
                                    (o.datasend.xml = xmlToString(o, !1), savePlantilla(o, () => { window.location = window.location.href; }));
                            }, !1);
                            if (file) reader.readAsText(file);
                            else fileinput.remove();
                        });
                        fileinput.click();
                    });
                }

                drawAttributeIconForMenu("Ver json (CTRL + ALT/⌥ + J)", "far fa-question-circle", "", () => { verJsonElemento(o, id); });
                //Termina seccion de info

                $("#nav-tab a#nav-" + o.id + "props-tab").html("Atributos del elemento <strong>" + o.appvm[id].titulo() + "</strong>");
                if ($("#nav-colors .ContentStart").html().length > 0 || $("#nav-colors .ContentEnd").html().length > 0) $('li.li-colors').show();
                else $('li.li-colors').hide();
                if ($("#nav-plus .ContentStart").html().length > 0 || $("#nav-plus .ContentEnd").html().length > 0) $('li.li-plus').show();
                else $('li.li-plus').hide();
                $("body").resize();
                showHideLoading(o, !1);
            }
        }
        function drawAttributeInformativeForMenu(text, content, width, bg) {
            let w = width || 80, backg = bg || "transparent";
            var gen = $(`<div class="border-right px-2 pb-1 d-inline-flex flex-column text-center" style="width:${w}px; white-space: normal;">
                <div style="font-size: .9rem;white-space: normal;background-color: #${backg}">${content}</div>
                <div class="col-sm-12 p-0">${text}</div>
            </div>`);
            $("#nav-info .ContentStart").append(gen);
        }
        function drawAttributeIconForMenu(text, icon, color, callback) {
            let c = color || "19bfd0";
            var gen = $(`<div class="border-right px-2 pb-1 d-inline-flex flex-column text-center" style="width:80px; white-space: normal;">
                <div class="btn btn-light border">
                    <i class="${icon} align-middle" style="font-size: 1.5rem; color: #${c};"></i>
                </div>
                <div class="col-sm-12 p-0">${text}</div>
            </div>`);
            callback && gen.find(".btn").on("click", function (e) { callback(e); }), $("#nav-info .ContentStart").append(gen);
        }
        function drawAttributeIconWithMenuForMenu(text, icon, color, items) {
            let c = color || "19bfd0";
            var gen = $(`<div class="border-right px-2 pb-1 d-inline-flex flex-column text-center" style="width:80px; white-space: normal;">
                <div class="dropdown">
                    <div class="btn btn-light dropdown-toggle">
                        <i class="${icon} align-middle" style="font-size: 1.5rem; color: #${c};"></i>
                    </div>
                </div>
                <div class="col-sm-12 p-0">${text}</div>
            </div>`);
            gen.find(".btn").on("click", function (e) {
                $("#mm").menu("destroy"), $(".menu:not('visible')").remove();
                $("body").append('<div id="mm" class="easyui-menu" style="width:180px;"></div>');
                $("#mm").menu();

                let recursive = (n) => {
                    if (n.It) {
                        n.It.forEach((m) => {
                            var sub = $("#mm").menu("findItem", n.T);
                            sub.target && ($("#mm").menu("appendItem", { parent: sub.target, text: m.T, onclick: () => { m.C && m.C(); } }), recursive(m));
                        });
                    }
                };

                items.forEach((n) => {
                    $("#mm").menu("appendItem", { text: n.T, onclick: () => { n.C && n.C(); } });
                    recursive(n);
                });

                $("#mm").menu("show", { left: e.pageX - 100, top: e.pageY + 10, hideOnUnhover: !1 });
            }), $("#nav-info .ContentStart").append(gen);
        }
        function drawMenuInnerObject(object, items) {
            if (!items.length) $("#" + object).hide();
            else $("#" + object).on("click", (e) => {
                $("#mm").menu("destroy"), $(".menu:not('visible')").remove();
                $("body").append('<div id="mm" class="easyui-menu" style="width:180px;"></div>');
                $("#mm").menu();

                let recursive = (n) => {
                    if (n.It) {
                        n.It.forEach((m) => {
                            var sub = $("#mm").menu("findItem", n.T);
                            sub.target && ($("#mm").menu("appendItem", { parent: sub.target, text: m.T, onclick: () => { m.C && m.C(); } }), recursive(m));
                        });
                    }
                };

                items.forEach((n) => {
                    $("#mm").menu("appendItem", { text: n.T, onclick: () => { n.C && n.C(); } });
                    recursive(n);
                });

                $("#mm").menu("show", { left: e.pageX - 100, top: e.pageY + 10, hideOnUnhover: !1 });
            });
        }
        //metodo que inserta un nuevo elemento a la plantilla
        function drawElement(type, parent) {
            var o = getOpts();
            var active = !1;
            if (!parent) { //posiblemente nueva funcionalidad de click de elemento
                if (type.toLowerCase() !== o.TE.Pagina)
                    for (var i = 0; i < o.jobj.elemento.elementos.elemento.length; i++) {
                        var pageid = o.jobj.elemento.elementos.elemento[i]["@idelemento"];
                        if (o.appvm[pageid].tipo() === o.TE.Pagina && o.appvm[pageid].activo() == !0) { active = !0; parent = o.plantilla.find("[id='" + pageid + "']"); break; }
                    }
                else if (type.toLowerCase() === o.TE.Pagina) active = !0;
            }
            else active = !0;
            if (active == !1) { toasty("", "Active una pagina para poder agregar elementos"); return false; }
            else {
                o.appvm.maxNumberId(o.appvm.maxNumberId() + 1);
                o.appvm.counterElement(o.appvm.counterElement() + 1);
                var elemid = o.id + "element" + o.appvm.maxNumberId();
                var jelem = { "elemento": { "@idelemento": elemid, "@tipoelemento": type.toLowerCase(), "atributos": {} } };
                drawHtml(jelem.elemento, parent, false, o);
            }
            return true;
        }
        //Metodo que pinta los elementos a insertar en la plantilla para el configurador
        function drawInsertElements(o) {
            $("#nav-" + o.id + "elementary").append('<p style="margin-left: 10px; margin-bottom: 0px; font-weight: bold;">Para agregar un elemento solo de click</p>');
            var sorted = _.sortBy(_.map(o.datatags.elementAtt, "Atributos.Nombre.Valor"));
            var coun = 0;
            for (var j = 0; j < sorted.length; j++) {
                var findd = _.find(o.datatags.elementAtt, ['Atributos.Nombre.Valor', sorted[j]]);
                //Salto de linea para version minibrowser
                var tipo = findd.NombreElemento;
                //mientras no sean la lista de elementos muertos o la plantilla
                if (!_.includes([o.TE.Plantilla], tipo.toLowerCase())) {
                    if (coun === 18) $("#nav-" + o.id + "elementary").append("<br/>");
                    var bb = $('<div style="width: 85px; height: 50px; white-space: normal; font-size: 12px;" class="btn btn-light p-1 menuelem" data-tipo="' + tipo + '">\
                        '+ findd.Atributos.Nombre.Valor + '<i style="font-size: 1.5rem;" class="' + findd.Atributos.Icono.Valor + '"></i>\
                    </div>');
                    $("#nav-" + o.id + "elementary").append(bb.on("click", function () { drawElement($(this).data("tipo")); }));
                    coun++;
                }
            }
        }
        function drawStyles(o) {
            var elforstyles = [o.TE.Plantilla, o.TE.Audio, o.TE.Boton, o.TE.CodigoBarras, o.TE.CodigoQR, o.TE.Documento, o.TE.FirmaFAD, o.TE.HuellaDigital, o.TE.Imagen, o.TE.OCR, o.TE.Tabla, o.TE.Video, o.TE.Wizard];
            $("#nav-" + o.id + "styles").append(`<div class="border bg-white rounded d-inline-flex w-100 p-1 AllStyles" style="height:153px; overflow-x:auto; overflow-y:hidden;"></div>`);
            elforstyles.forEach((tipo) => {
                var attr = getElementTypeAttributes(o, tipo);
                var name = tipo === o.TE.Plantilla ? 'Página' : attr.NombreElemento;
                $("#nav-" + o.id + "styles div.AllStyles").append(`<div style="border-right-width: 3px;" class="border-right text-center Styles${tipo}">
                    <p style="margin-bottom: .5rem;font-weight: bold;">Estilos para Elemento ${name}</p>
                </div>`);
                getPropsForStyles(tipo).forEach((prop) => {
                    _.keys(attr.Atributos).forEach((k) => {
                        if (k.toLowerCase() === prop) {
                            var colorp = $(`<div class="px-1 d-inline-flex flex-column" style="white-space: normal;">
                                <div class="btn btn-light border text-black bg-white btn-sm" style="width: 95px; padding: .20rem .3rem;">
                                    <input class="text-center border roundcolor" style="font-size:0.8rem; height:50px; width:50px; border-radius:50%; cursor:pointer;outline:none;">
                                    <div class="text-center text-muted pt-1" style="font-size:0.9rem;">${attr.Atributos[k].Descripcion}</div>
                                </div>
                            </div>`);
                            $("#nav-" + o.id + "styles div.AllStyles div.Styles" + tipo).append(colorp);
                            var cp = colorp.find("input");
                            var picker = new jscolor(cp[0], { hash: true });
                            picker.fromString(attr.Atributos[k].Valor);
                            cp.on("change", () => {
                                globalThis.console.log(cp.val());
                                _.keys(o.appvm).forEach((v) => {
                                    if (v.indexOf("formElec_element") === 0 && _.includes(tipo, o.appvm[v].tipo()))
                                        o.appvm[v][prop] && o.appvm[v][prop](cp.val());
                                });
                            });
                        }
                    });
                });
            });

            $("#nav-" + o.id + "themes").append(`<div class="border bg-white rounded d-inline-flex w-100 p-1 Themes" style="height:153px; overflow-x:auto; overflow-y:hidden;"></div>`);
            [{ id: "Red", n: "Rojo", bg: "#de0a0a", tx: "#ffffff" },
            { id: "BlueLight", n: "Azul claro", bg: "#add8e6", tx: "#333333" },
            { id: "Blue", n: "Azul", bg: "#0000FF", tx: "#ffffff" },
            { id: "Navy", n: "Azul obscuro", bg: "#00008b", tx: "#ffffff" }].forEach((c) => {
                var pp = $(`<div style="border-right-width: 3px;" class="border-right text-center Theme${c.id}">
                    <p style="margin-bottom: .5rem;font-weight: bold;">Tema ${c.n}</p>
                    <div class="px-1 d-inline-flex flex-column" style="white-space: normal;">
                        <div class="btn btn-light border text-black bg-white btn-sm Palette" style="width: 95px; padding: .20rem .3rem;">
                            <i class="fas fa-palette" style="font-size: 48px; color: ${c.bg};"></i>
                            <h6><span class="badge bg-light">${c.bg}</span></h6>
                        </div>
                    </div>
                </div>`);
                $("#nav-" + o.id + "themes div.Themes").append(pp);
                var cp = pp.find(".Palette");
                cp.on("click", () => {
                    globalThis.console.log(cp.val());
                    elforstyles.forEach((tt) => {
                        _.keys(o.appvm).forEach((v) => {
                            if (v.indexOf("formElec_element") === 0 && _.includes(tt, o.appvm[v].tipo())) {
                                getPropsForStyles(tt).forEach((prop) => {
                                    if (prop.indexOf("texto") >= 0) o.appvm[v][prop] && o.appvm[v][prop](c.tx);
                                    else o.appvm[v][prop] && o.appvm[v][prop](c.bg);
                                });
                            }
                        });
                    });
                });
            });

            var pp2 = $(`<div style="border-right-width: 3px;" class="border-right text-center ThemeCustom">
                <p style="margin-bottom: .5rem;font-weight: bold;">Custom</p>
                <div class="px-1 d-inline-flex flex-column" style="white-space: normal;">
                    <div class="btn btn-light border text-black bg-white btn-sm" style="width: 95px; padding: .20rem .3rem;">
                        <input class="text-center border roundcolor bgAll" style="font-size:0.8rem; height:50px; width:50px; border-radius:50%; cursor:pointer;outline:none;">
                        <div class="text-center text-muted pt-1" style="font-size:0.9rem;">Fondo</div>
                    </div>
                </div>
                <div class="px-1 d-inline-flex flex-column" style="white-space: normal;">
                    <div class="btn btn-light border text-black bg-white btn-sm" style="width: 95px; padding: .20rem .3rem;">
                        <input class="text-center border roundcolor txtAll" style="font-size:0.8rem; height:50px; width:50px; border-radius:50%; cursor:pointer;outline:none;">
                        <div class="text-center text-muted pt-1" style="font-size:0.9rem;">Texto</div>
                    </div>
                </div>
            </div>`);
            $("#nav-" + o.id + "themes div.Themes").append(pp2);
            var cp2 = pp2.find("input.bgAll");
            var picker = new jscolor(cp2[0], { hash: true });
            picker.fromString("aaaaaa");
            cp2.on("change", () => {
                globalThis.console.log(cp2.val());
                elforstyles.forEach((tt) => {
                    _.keys(o.appvm).forEach((v) => {
                        if (v.indexOf("formElec_element") === 0 && _.includes(tt, o.appvm[v].tipo())) {
                            getPropsForStyles(tt).forEach((prop) => {
                                if (prop.indexOf("texto") >= 0) { /*no se hace nada*/ }
                                else o.appvm[v][prop] && o.appvm[v][prop](cp2.val());
                            });
                        }
                    });
                });
            });
            var cp3 = pp2.find("input.txtAll");
            var picker2 = new jscolor(cp3[0], { hash: true });
            picker2.fromString("000000");
            cp3.on("change", () => {
                globalThis.console.log(cp3.val());
                elforstyles.forEach((tt) => {
                    _.keys(o.appvm).forEach((v) => {
                        if (v.indexOf("formElec_element") === 0 && _.includes(tt, o.appvm[v].tipo())) {
                            getPropsForStyles(tt).forEach((prop) => {
                                if (prop.indexOf("texto") >= 0) o.appvm[v][prop] && o.appvm[v][prop](cp3.val());
                                else { /*no se hace nada*/ }
                            });
                        }
                    });
                });
            });
        }
        //Obtiene la configuracion guardada del plugin
        function getXml() {
            var o = getOpts(), xxml;
            return showHideLoading(o), xxml = o.appvm.isEditor() ? xmlToString(o) : xmlToJson(o), showHideLoading(o, false), xxml;
        }
        function getPropsForStyles(tipo) {
            var props = [];
            if (o.TE.Plantilla === tipo) props = ["colortabactivo", "colortabtextoactivo", "colortabinhabilitado", "colortabtextoinhabilitado", "colortabnormal", "colortabtextonormal"];
            else if (o.TE.Audio === tipo) props = ["colorborrar", "colortextoborrar", "coloraudio", "colortextoaudio", "colorimportar", "colortextoimportar", "colorreemplazar", "colortextoreemplazar", "colorvisualizar", "colortextovisualizar"];
            else if (o.TE.Boton === tipo) props = ["colorfondo", "colortexto"];
            else if (o.TE.Documento === tipo) props = ["colortomarfoto", "colortextotomarfoto"];
            else if (o.TE.FirmaFAD === tipo) props = ["colorborrar", "colortextoborrar", "colorfirma", "colortextofirma", "colorvisualizar", "colortextovisualizar"];
            else if (o.TE.HuellaDigital === tipo) props = ["colorbotoneliminar", "colortextobotoneliminar", "colorbotonescanear", "colortextobotonescanear"];
            else if (o.TE.Imagen === tipo) props = ["colorborrar", "colortextoborrar", "colorescaner", "colortextoescaner", "colorimportar", "colortextoimportar", "colorreemplazar", "colortextoreemplazar", "colortomarfoto", "colortextotomarfoto", "colorvisualizar", "colortextovisualizar"];
            else if (o.TE.OCR === tipo) props = ["colorbotonocr", "colorbotonocrtexto"];
            else if (o.TE.Tabla === tipo) props = ["colorbotonagregar", "colorbotonagregartexto", "colorbotonagregarcerrar", "colorbotonagregarcerrartexto", "colorbotoncerrar", "colorbotoncerrartexto", "colorbotoneditar", "colorbotoneditartexto", "colorbotonlimpiar", "colorbotonlimpiartexto", "colorbotonnuevo", "colorbotonnuevotexto", "colorheader", "colorheadertexto", "colorencabezadotabla", "colorencabezadotextotabla"];
            else if (o.TE.Video === tipo) props = ["colorborrar", "colortextoborrar", "colorimportar", "colortextoimportar", "colorreemplazar", "colortextoreemplazar", "colortomarvideo", "colortextotomarvideo", "colorvisualizar", "colortextovisualizar"];
            else if (o.TE.Wizard === tipo) props = ["colorfondoavanzar", "colortextoavanzar", "colorfondofinalizar", "colortextofinalizar", "colorfondoregresar", "colortextoregresar"];
            return props;
        }
        function insertAtIndexXml(indextoinsert, jelemparentid, jelemid, o) {
            var parentofdelete = searchElementInJson(o, o.appvm[jelemid].elementopadre());
            for (var i = 0; i < parentofdelete.elementos.elemento.length; i++) {
                if (parentofdelete.elementos.elemento[i]["@idelemento"] === jelemid) {
                    //se clona para insertar despues
                    var cutandpaste = _.clone(parentofdelete.elementos.elemento[i]);
                    //se borra el hijo
                    parentofdelete.elementos.elemento.splice(i, 1);
                    if (jelemparentid === parentofdelete["@idelemento"]) { //mismo padre, se inserta en el indice correcto
                        parentofdelete.elementos.elemento.splice(indextoinsert, 0, cutandpaste);
                    }
                    else { //diferente padre
                        var parentofpaste = searchElementInJson(o, jelemparentid);
                        parentofpaste.elementos.elemento.splice(indextoinsert, 0, cutandpaste);

                        if (parentofpaste["@tipoelemento"] === o.TE.Tabber && o.appvm[jelemid].modotab) //si se esta arrastrando dentro de un tabber
                            redrawSectionsOnTabber(o, jelemid, parentofpaste);
                        else if (o.appvm[jelemid].modotab)//si es seccion y no esta dentro de tabber
                            removeSectionFromTabber(o, jelemid);
                        if (o.appvm[o.appvm[jelemid].elementopadre()].tipo() === o.TE.Tabber && o.appvm[jelemid].modotab)//si el padre de donde viene es tabber
                            redrawSectionsOnTabber(o, jelemid);
                        o.appvm[jelemid].elementopadre(jelemparentid);
                    }
                    break;
                }
            }
        }
        function mappingocr(id) {
            var o = getOpts();
            initializeDataByAttr(o, "components");
            o.mapmicro = $(`<div class="modal">
                <div class="modal-dialog modal-xl" style="width: 95%; max-width: 95%;">
                    <div class="modal-content rounded">
                        <div class="modal-body no-padding row">
                            <div class="col-md-12 col-sm-12">
                                <h5 class="col-12 py-2 px-0 border-bottom">Mapeo de campos para el OCR</h5>
                                <div class="collectionelements row"></div>
                            </div>
                        </div>
                        <div class="modal-footer p-2 justify-content-between no-border">
                            <div class="modalclose btn btn-light border ml-2 btn-sm">Cerrar</div>
                        </div>
                    </div>
                </div>
            </div>`);
            $("body").append(o.mapmicro), o.mapmicro.modal({ keyboard: !1, backdrop: "static", show: !0 });
            o.mapmicro.find(".modalclose").on("click", function () {
                o.initializedData = [], o.mapmicro.modal("hide"), o.mapmicro.remove();
                $("body .panel.combo-p:not('visible')").remove(); //se quitan todos los combos de easyui escondidos que generan alentamiento en la pagina
            });
            o.mapmicro.find(".infobutton").on("click", function (e) { o.mapmicro.find(".infotext").slideToggle("fast"); });
            o.mapmicro.find(".infobutton").effect("pulsate", 2000).effect("highlight", 1000);
            var data = [];
            [o.TE.Texto, o.TE.TextArea, o.TE.Password, o.TE.Lista, o.TE.Numero, o.TE.Moneda, o.TE.Imagen, o.TE.Documento, o.TE.Fecha].forEach(vol => {
                data = _.union(data, o.initializedData.aggroupeddata[vol]);
            });
            if (typeof o.appvm[id].mappingocr() !== "object") o.appvm[id].mappingocr({});
            var keys = _.keys(o.veridasocr);
            keys.forEach(v => {
                var f = o.veridasocr[v];
                var y = f.replaceAll('.', '');
                var combo = $(`<div class="col-md-6 col-sm-12">
                    <label class="form-label">${v}</label>
                    <input id="micro${y}">
                </div>`);
                o.mapmicro.find(".collectionelements").append(combo);
                $(`#micro${y}`).css({ width: "100%" }).combobox({
                    data: _.sortBy(data, ["parentpage"]), valueField: 'id', textField: 'nombre', prompt: 'Seleccione...', groupField: "parentpage", groupPosition: "sticky",
                    value: o.appvm[id].mappingocr()[f] || "", limitToList: !0, onSelect: function (sv) { o.appvm[id].mappingocr()[f] = sv.id; },
                    onUnselect: function () { o.appvm[id].mappingocr()[f] = ""; }
                });
            });
        }
        function mappingscore(id) {
            var o = getOpts();
            initializeDataByAttr(o, "components");
            o.mapmicro = $(`<div class="modal">
                <div class="modal-dialog modal-xl" style="width: 95%; max-width: 95%;">
                    <div class="modal-content rounded">
                        <div class="modal-body no-padding row">
                            <div class="col-md-12 col-sm-12">
                                <h5 class="col-12 py-2 px-0 border-bottom">Mapeo de campos para el OCR</h5>
                                <div class="collectionelements row"></div>
                            </div>
                        </div>
                        <div class="modal-footer p-2 justify-content-between no-border">
                            <div class="modalclose btn btn-light border ml-2 btn-sm">Cerrar</div>
                        </div>
                    </div>
                </div>
            </div>`);
            $("body").append(o.mapmicro), o.mapmicro.modal({ keyboard: !1, backdrop: "static", show: !0 });
            o.mapmicro.find(".modalclose").on("click", function () {
                o.initializedData = [], o.mapmicro.modal("hide"), o.mapmicro.remove();
                $("body .panel.combo-p:not('visible')").remove(); //se quitan todos los combos de easyui escondidos que generan alentamiento en la pagina
            });
            o.mapmicro.find(".infobutton").on("click", function (e) { o.mapmicro.find(".infotext").slideToggle("fast"); });
            o.mapmicro.find(".infobutton").effect("pulsate", 2000).effect("highlight", 1000);
            var data = [];
            [o.TE.Texto, o.TE.TextArea, o.TE.Password, o.TE.Lista, o.TE.Numero, o.TE.Moneda, o.TE.Imagen, o.TE.Documento, o.TE.Fecha].forEach(vol => {
                data = _.union(data, o.initializedData.aggroupeddata[vol]);
            });
            if (typeof o.appvm[id].mappingscore() !== "object") o.appvm[id].mappingscore({});
            var keys = _.keys(o.veridasscore);
            keys.forEach(v => {
                var f = o.veridasscore[v];
                var y = f.replaceAll('.', '');
                var combo = $(`<div class="col-md-6 col-sm-12">
                    <label class="form-label">${v}</label>
                    <input id="micro${y}">
                </div>`);
                o.mapmicro.find(".collectionelements").append(combo);
                $(`#micro${y}`).css({ width: "100%" }).combobox({
                    data: _.sortBy(data, ["parentpage"]), valueField: 'id', textField: 'nombre', prompt: 'Seleccione...', groupField: "parentpage", groupPosition: "sticky",
                    value: o.appvm[id].mappingscore()[f] || "", limitToList: !0, onSelect: function (sv) { o.appvm[id].mappingscore()[f] = sv.id; },
                    onUnselect: function () { o.appvm[id].mappingscore()[f] = ""; }
                });
            });
        }
        function mappingpepaml(id) {
            var o = getOpts();
            initializeDataByAttr(o, "components");
            o.mapmicro = $(`<div class="modal">
                <div class="modal-dialog modal-xl" style="width: 95%; max-width: 95%;">
                    <div class="modal-content rounded">
                        <div class="modal-body no-padding row">
                            <div class="col-md-12 col-sm-12">
                                <h5 class="col-12 py-2 px-0 border-bottom">Mapeo de campos PEP y AML</h5>
                                <div class="collectionelements row"></div>
                            </div>
                        </div>
                        <div class="modal-footer p-2 justify-content-between no-border">
                            <div class="modalclose btn btn-light border ml-2 btn-sm">Cerrar</div>
                        </div>
                    </div>
                </div>
            </div>`);
            $("body").append(o.mapmicro), o.mapmicro.modal({ keyboard: !1, backdrop: "static", show: !0 });
            o.mapmicro.find(".modalclose").on("click", function () {
                o.initializedData = [], o.mapmicro.modal("hide"), o.mapmicro.remove();
                $("body .panel.combo-p:not('visible')").remove(); //se quitan todos los combos de easyui escondidos que generan alentamiento en la pagina
            });
            o.mapmicro.find(".infobutton").on("click", function (e) { o.mapmicro.find(".infotext").slideToggle("fast"); });
            o.mapmicro.find(".infobutton").effect("pulsate", 2000).effect("highlight", 1000);
            var data = [];
            [o.TE.Texto, o.TE.TextArea, o.TE.Password, o.TE.Lista, o.TE.Numero, o.TE.Moneda, o.TE.Imagen, o.TE.Documento, o.TE.Fecha].forEach(vol => {
                data = _.union(data, o.initializedData.aggroupeddata[vol]);
            });
            if (typeof o.appvm[id].mappingpepaml() !== "object") o.appvm[id].mappingpepaml({});
            var keys = _.keys(o.veridaspepaml);
            keys.forEach(v => {
                var f = o.veridaspepaml[v];
                var y = f.replaceAll('.', '');
                var combo = $(`<div class="col-md-6 col-sm-12">
                    <label class="form-label">${v}</label>
                    <input id="micro${y}">
                </div>`);
                o.mapmicro.find(".collectionelements").append(combo);
                $(`#micro${y}`).css({ width: "100%" }).combobox({
                    data: _.sortBy(data, ["parentpage"]), valueField: 'id', textField: 'nombre', prompt: 'Seleccione...', groupField: "parentpage", groupPosition: "sticky",
                    value: o.appvm[id].mappingpepaml()[f] || "", limitToList: !0, onSelect: function (sv) { o.appvm[id].mappingpepaml()[f] = sv.id; },
                    onUnselect: function () { o.appvm[id].mappingpepaml()[f] = ""; }
                });
            });
        }
        function plantillaIsLoaded(o) {
            o.elementsPlantillaToLoad.length === 0 ? setAllLoad(o) : (pla = o.elementsPlantillaToLoad[0], getElementsPlantilla(pla, true));
        }
        function prefilldata(o, dataprefilled) {
            if (dataprefilled) {
                typeof dataprefilled === "string" && (dataprefilled = dataprefilled.replace(/\"\[/g, '[').replace(/\]\"/g, ']'), dataprefilled = JSON.parse(dataprefilled));
                for (var el = 0; el < dataprefilled.length; el++) {
                    var elm = dataprefilled[el], currentelements = elm.elementodestino.toString().split(',');
                    for (var elin = 0; elin < currentelements.length; elin++) {
                        if (o.appvm[currentelements[elin]]) {
                            switch (o.appvm[currentelements[elin]].tipo()) {
                                case o.TE.Lista:
                                    var m, e,
                                        tam = o.appvm[currentelements[elin]].tipoasociacion() === "iddesc" || o.appvm[currentelements[elin]].tipoasociacion() === "idid" ? "Valor" : "Nombre",
                                        tav = o.appvm[currentelements[elin]].tipoasociacion() === "iddesc" || o.appvm[currentelements[elin]].tipoasociacion() === "descdesc" ? "Nombre" : "Valor";
                                    if (elm.chosenitems)
                                        m = [], elm.chosenitems.length ? _.forEach(elm.chosenitems, function (x) {
                                            if (x)
                                                _.forEach(o.datatags.allitemscatalogs[o.appvm[currentelements[elin]].fuentedatos() + "|" + o.appvm[currentelements[elin]].catalogoorigen()], function (xv) { xv.Valor === x.Valor && xv.Nombre === x.Nombre && m.push(xv); });
                                        }) : (e = _.find(o.datatags.allitemscatalogs[o.appvm[currentelements[elin]].fuentedatos() + "|" + o.appvm[currentelements[elin]].catalogoorigen()], function (xv) { return xv.Valor === elm.chosenitems.Valor && xv.Nombre === elm.chosenitems.Nombre; }), e && m.push(e));
                                    else if (elm.metadato && elm.metadato.length > 0)
                                        m = _.filter(o.datatags.allitemscatalogs[o.appvm[currentelements[elin]].fuentedatos() + "|" + o.appvm[currentelements[elin]].catalogoorigen()], function (xv) { return elm.valor === xv[tav] && elm.metadato === xv[tam]; });
                                    m && m.length > 0 && (o.appvm[currentelements[elin]].tipolista() === "checkbox" ? o.appvm[currentelements[elin]].chosenitemsRule(m) :
                                        o.appvm[currentelements[elin]].tipolista() === "combo" ? o.appvm[currentelements[elin]].optionselectedRule(m[0].Valor) : o.appvm[currentelements[elin]].chosenitemsRule(m[0]));
                                    break;
                                case o.TE.CodigoBarras: case o.TE.Texto: case o.TE.TextArea: case o.TE.Numero: case o.TE.Logico: case o.TE.Fecha: case o.TE.Moneda: case o.TE.Deslizante:
                                    o.appvm[currentelements[elin]].tipo() === o.TE.Logico && (elm.valor = elm.valor === "true" || elm.valor === true || elm.valor === 1 ||
                                        elm.valor === "1" || elm.valor === "Si" || elm.valor === "si" ? true : false);
                                    _.includes([o.TE.Fecha, o.TE.Moneda, o.TE.Numero], o.appvm[currentelements[elin]].tipo()) && (elm.valor =
                                        !isNaN(elm.metadato) && elm.metadato !== "" ? elm.metadato : !isNaN(elm.valor) ? elm.valor : "");
                                    o.appvm[currentelements[elin]].tipo() === o.TE.Texto ? o.appvm[currentelements[elin]].valormetadato(elm.valor) : o.appvm[currentelements[elin]].valor(elm.valor);
                                    break;
                                case o.TE.RangoFechas:
                                    o.appvm[currentelements[elin]].valormetadatorango(elm.valor);
                                    break;
                                case o.TE.Hora:
                                    elm.valor.indexOf("m") > 0 && (elm.valor = moment(elm.valor, "h:mm a").format("HH:mm"));
                                    o.appvm[currentelements[elin]].valor.silentUpdate(elm.valor);
                                    break;
                                case o.TE.ComboDinamico:
                                    var idelem = currentelements[elin], selValue = elm.metadato;
                                    var setValDynamic = function () {
                                        var sData = _.find($('#dynamiccombo' + idelem).combobox("getData"), function (valElem) { return valElem[o.appvm[idelem].valorid()] === selValue; });
                                        !!sData && $('#dynamiccombo' + idelem).combobox("setValue", sData[o.appvm[idelem].valorid()]);
                                        //sData ? $('#dynamiccombo' + id).combobox("setValue", sData["Valor"]) : $('#dynamiccombo' + id).combobox("setValue", "");
                                    };
                                    if (!$('#dynamiccombo' + idelem)[0]) {
                                        if (o.appvm[idelem])
                                            var setValDynamicInterval = setInterval(function () {
                                                if ($('#dynamiccombo' + idelem)[0] && o.appvm[idelem])
                                                    clearInterval(setValDynamicInterval), setValDynamic();
                                            }, 500);
                                    }
                                    else setValDynamic();
                                    break;
                                case o.TE.Tabla:
                                    _.forEach(elm.valorestabla, function (rowval) {
                                        actionRowTable(currentelements[elin], ['clear']);
                                        _.forEach(_.keys(rowval), function (rowvalelem) {
                                            o.appvm[rowvalelem] && o.appvm[rowvalelem].valor &&
                                                (o.appvm[rowvalelem].valor(rowval[rowvalelem].valor), o.appvm[rowvalelem].valormetadato(rowval[rowvalelem].valormetadato));
                                        });
                                        actionRowTable(currentelements[elin], ['addclear']);
                                    });
                                    break;
                            }
                        }
                    }
                }
            }
        }
        function recursiveDraw(jelem, o, withchild) {
            var elemid = jelem["@idelemento"], elemDom = $("<!-- ko --><!-- /ko -->");
            var parent = findMethodByElementType(o, jelem, o.methodType.getParent, [null]);
            findMethodByElementType(o, jelem, o.methodType.drawHtml, [parent, elemDom, elemid, true]);
            if (withchild)
                if (jelem.elementos && jelem.elementos.elemento)
                    for (var i = 0; i < jelem.elementos.elemento.length; i++)
                        recursiveDraw(jelem.elementos.elemento[i], o, withchild);
        }
        function recursiveElementToModel(jelem, o, element) {
            element = element || {};
            element = createElementToView(o, jelem, element, false);
            if (jelem.elementos && jelem.elementos.elemento)
                for (var i = 0; i < jelem.elementos.elemento.length; i++)
                    element = recursiveElementToModel(jelem.elementos.elemento[i], o, element);
            return element;
        }
        function removeElement(id) {
            var o = getOpts(), tipo = o.appvm[id].tipo(); o.infodataisact = !1;
            var parentofdelete = searchElementInJson(o, o.appvm[id].elementopadre());
            for (var i = 0; i < parentofdelete.elementos.elemento.length; i++) {
                if (parentofdelete.elementos.elemento[i]["@idelemento"] === id) {
                    //se borran todos los hijos internos del que se pidio borrar
                    if (o.appvm[id] && o.appvm[id].iscontainer && o.appvm[id].iscontainer() === true) {
                        for (var j = 0; j < parentofdelete.elementos.elemento[i].elementos.elemento.length; j++)
                            recursiveDelete(o, parentofdelete.elementos.elemento[i].elementos.elemento[j]);
                    }
                    parentofdelete.elementos.elemento.splice(i, 1);
                    if (parentofdelete["@tipoelemento"] === o.TE.Tabber)
                        redrawSectionsOnTabber(o, id, parentofdelete);
                    else if (parentofdelete["@tipoelemento"] === o.TE.Plantilla) {
                        o.appvm[o.idPlantilla].pagids([]);
                        for (var i = 0; i < o.jobj.elemento.elementos.elemento.length; i++) {
                            var pageid = o.jobj.elemento.elementos.elemento[i]["@idelemento"];
                            if (o.appvm[pageid].tipo() === o.TE.Pagina) o.appvm[o.idPlantilla].pagids.push(pageid);
                        }
                    }
                    break;
                }
            }

            if (contglobal.find) {
                deleteComments(o.plantilla, id), contglobal.find("[id='" + id + "']").remove(); //se busca el parent porque ese es el KO component
                o.jobj.elemento.elementos.elemento.length > 0 ? o.plantilla.removeClass("state-default-plantilla-empty") : o.plantilla.addClass("state-default-plantilla-empty");
                $('[data-toggle="tooltip"], .tooltip').tooltip("hide");
                if (tipo === o.TE.Pagina) {
                    var kofinded2 = false;
                    o.tabberpage.find("li[value='" + id + "']").parent().contents().filter(function () {
                        if (this.nodeType === 8 && this.nodeValue.indexOf(id) !== -1) {
                            kofinded2 = true;
                            return true;
                        }
                        if (this.nodeType === 8 && kofinded2 === true) {
                            kofinded2 = false;
                            return true;
                        }
                        return false;
                    }).each(function (i, e) { $(e).remove(); });
                    o.tabberpage.find("li[value='" + id + "']").remove();
                }
                tipo === o.TE.Lista && o.appvm.elementsList(_.filter(o.appvm.elementsList(), function (z) { return z.Valor !== id; }));
                var parentid = o.appvm[id].elementopadre();
                delete o.appvm[id];
                o.appvm.counterElement(o.appvm.counterElement() - 1);
                var tt = o.appvm[parentid].titulo ? o.appvm[parentid].titulo() : "Plantilla";
                addTimelineRow(o, 'Elemento "' + id + '" borrado de "' + tt + "-" + parentid + '"', o.LogTy.Remove);
            }
            updateOpts(o, true);
            if ($("#nav-tab a#nav-" + o.id + "props-tab").is(".active"))
                $("#nav-tab a#nav-" + o.id + "file-tab").tab('show'), $("#nav-tab a#nav-" + o.id + "props-tab").attr("hidden", "true");
        }
        function recursiveDelete(o, jelem) {
            if (o.appvm[jelem["@idelemento"]].iscontainer && o.appvm[jelem["@idelemento"]].iscontainer() === true) {
                for (var j = 0; j < jelem.elementos.elemento.length; j++)
                    recursiveDelete(o, jelem.elementos.elemento[j]);
            }
            delete o.appvm[jelem["@idelemento"]];
            o.appvm.counterElement(o.appvm.counterElement() - 1);
        }
        function renderElement(node, o) {
            var rendered = false;
            var childsko = node.find("div.childko").clone(true);
            node.each(function (i, objNode) {
                var objChildNode = objNode.firstChild;

                while (objChildNode) {
                    if (objChildNode.nodeType === 8 && rendered === false &&
                        (objChildNode.nodeValue.indexOf("subelement()") === -1 && objChildNode.nodeValue.indexOf("actions") === -1 &&
                            objChildNode.nodeValue.indexOf("-lista-") === -1 && objChildNode.nodeValue.indexOf("if:") === -1 &&
                            objChildNode.nodeValue.indexOf("foreach:") === -1 &&
                            (objChildNode.nodeValue.match(/_/g) || []).length === 1 /*si tiene mas de una ocurrencia es hijo de tabla*/)) { //initial ko
                        var idko = objChildNode.nodeValue.match(/formElec_\w+/g);
                        if (idko.length) {
                            idko = idko[0];
                            if (o.appvm[idko].elementrendered() === false)  //ya esta bindeado
                                ko.applyBindings(o.appvm, objChildNode);
                            rendered = true;
                        }
                    } else if (objChildNode.nodeType === 8 && rendered === true) { //ending ko
                        rendered = false;
                    } else if (objChildNode.nodeType === 1) {
                        renderElement($(objChildNode), o);
                    }
                    objChildNode = objChildNode.nextSibling;
                }
            });

            if (childsko.length) {
                childsko.each(function (i, chlNode) {
                    var idparent = $(chlNode).data("id");
                    var objChildNode = chlNode.firstChild;

                    while (objChildNode) {
                        if (objChildNode.nodeType === 8 && rendered === false &&
                            (objChildNode.nodeValue.indexOf("subelement()") === -1 && objChildNode.nodeValue.indexOf("actions") === -1 &&
                                objChildNode.nodeValue.indexOf("-lista-") === -1 && objChildNode.nodeValue.indexOf("if:") === -1)) { //initial ko
                            var parent = o.plantilla.find(".card[id='" + idparent + "']");
                            findContainerParent(parent, o).append(objChildNode).append("<!-- /ko -->");
                            ko.applyBindings(o.appvm, objChildNode);
                            rendered = true;
                        } else if (objChildNode.nodeType === 8 && rendered === true) { //ending ko
                            rendered = false;
                        } else if (objChildNode.nodeType === 1) {
                            renderElement($(objChildNode), o);
                        }
                        objChildNode = objChildNode.nextSibling;
                    }
                });
            }
        }
        //Se analiza si el objeto convertido de xml a json no le falto algo en su estructura, y se recibe el jsondatos original para mapear campos que en filetransfer no estan por defecto o que son datos ocultos
        function revaluateDataJson(o, jsondatos) {
            var jjson = _.isEmpty(jsondatos) ? {} : JSON.parse(jsondatos);
            void 0 !== o.jobj.elemento && "string" !== typeof o.jobj.elemento || (o.jobj.elemento = []),
                void 0 !== o.jobj.elemento.elementos && "string" !== typeof o.jobj.elemento.elementos || (o.jobj.elemento.elementos = { elemento: [] }),
                void 0 !== o.jobj.elemento.elementos.elemento && "string" !== typeof o.jobj.elemento.elementos.elemento || (o.jobj.elemento.elementos.elemento = []),
                void 0 === o.jobj.elemento.elementos.elemento.push && (o.jobj.elemento.elementos.elemento = [o.jobj.elemento.elementos.elemento]);

            //revisar coleccion de acciones en macros
            for (var mm in o.jobj.elemento.atributos.macros)
                if (typeof o.jobj.elemento.atributos.macros[mm].steps === "object") {
                    if (!o.jobj.elemento.atributos.macros[mm].steps.push)
                        o.jobj.elemento.atributos.macros[mm].steps = [o.jobj.elemento.atributos.macros[mm].steps];
                    o.jobj.elemento.atributos.macros[mm].steps = _.filter(o.jobj.elemento.atributos.macros[mm].steps, (o) => { return !_.isEmpty(o.action) });
                }

            //se excluye el antiguo footer
            o.jobj.elemento.elementos.elemento = _.filter(o.jobj.elemento.elementos.elemento, (ee) => { return ee["@tipoelemento"] !== "footer"; })
            //paginas
            for (var i = 0; i < o.jobj.elemento.elementos.elemento.length; i++) {
                revaluateChildDataJson(o.jobj.elemento.elementos.elemento[i], o.jobj.elemento["@idelemento"], i, o, jjson);
            }
        }
        //De igual manera los hijos no falte nada en su estructura
        function revaluateChildDataJson(jelem, idpadre, index, o, jjson) {
            //cualquier elemento
            //asignarle el id del padre
            jelem.atributos.elementopadre = idpadre;
            jelem.atributos.ordencampo = index + 1;
            if (jelem["@tipoelemento"] === o.TE.FirmaFAD) {
                for (var attt in jjson[jelem["@idelemento"]]) {
                    jelem.atributos[attt] = jjson[jelem["@idelemento"]][attt];
                }
            }
            //Transformacion del viejo elemento firma a FAD
            if (jelem["@tipoelemento"] === "firma") {
                jelem["@tipoelemento"] = o.TE.FirmaFAD;
            }
            //Transformacion del viejo elemento rostrovivo a Imagen
            if (jelem["@tipoelemento"] === "rostrovivo") {
                jelem["@tipoelemento"] = o.TE.Imagen;
            }
            if (!_.includes([o.TE.Leyenda, o.TE.OCR, o.TE.Imagen], jelem["@tipoelemento"])) {
                var v = _.has(jelem.atributos, 'valor') ? jelem.atributos.valor : _.has(jelem.atributos, 'valorinicial') ? (jelem.atributos.valorinicial + " " + jelem.atributos.valorfinal) : '', vm = _.has(jelem.atributos, 'valormetadato') ? jelem.atributos.valormetadato : _.has(jelem.atributos, 'valormetadatorango') ? jelem.atributos.valormetadatorango : '';
                o.changeLogs.push(`Valor inicial del elemento ${jelem["@idelemento"]} con titulo ${jelem.atributos.titulo}: valor: ${v}, valormetadato: ${vm}`);
            }
            if (_.includes([o.TE.Wizard], jelem["@tipoelemento"])) {
                //reasignacion de toda la plantilla al elemento pagina de este wizard
                if (jelem.atributos.elementoavalidar === o.idPlantilla) {
                    jelem.atributos.elementoavalidar = idpadre;
                    globalThis.console.log(`${jelem["@idelemento"]} => Reasignacion de validar toda la plantilla a solo el padre ${idpadre}`);
                }
            }
            if (jelem.atributos.iscontainer && jelem.atributos.iscontainer === true) {
                if (jelem.elementos === undefined || typeof jelem.elementos === "string")
                    jelem.elementos = { elemento: [] };
                if (jelem.elementos.elemento === undefined || typeof jelem.elementos.elemento === "string")
                    jelem.elementos.elemento = [];
                if (jelem.elementos.elemento.push === undefined)
                    jelem.elementos.elemento = [jelem.elementos.elemento];
                for (var i = 0; i < jelem.elementos.elemento.length; i++) {
                    revaluateChildDataJson(jelem.elementos.elemento[i], jelem["@idelemento"], i, o, jjson);
                }
            } else {
                if (jelem.elementos)
                    delete jelem.elementos;
            }
        }
        function savePlantilla(o, callback) {
            if (validateTablesNotEmpty(o)) {
                if (o.datasend.xml) {
                    $.ajax({
                        url: o.datasend.urlGlobal + 'FEConfigurador.aspx/GuardaPlantilla',
                        data: JSON.stringify(o.datasend),
                        success: function (j) {
                            j = j.d;
                            if (j.Success) {
                                toasty("&Eacute;xito", j.Mensaje, "exito");
                                o.datasend.idPlantilla = j.ReturnedObject.idPlantilla;
                                updateOpts(o, true), callback && callback();
                            }
                            else Error(j.Titulo, j.Mensaje);
                            showHideLoading(o, false);
                        }
                    });
                }
            }
        }
        function selectArchivo(input, id, tipo) {
            var o = getOpts();
            input = $(input);
            var file = input.get(0).files[0],
                label = input.val().replace(/\\/g, "/").replace(/.*\//, ""),
                ext = label.substring(label.lastIndexOf(".") + 1).toLowerCase();
            if ($.inArray(ext, ["png", "jpeg", "jpg", "bmp", "gif", "svg", "tiff", "dds", "wdp", "emf", "ico", "wmf", "jpe", "jfif"]) === -1) {
                toasty("Solo se permiten extensiones de tipo imagen");
                return;
            }
            label = label.substring(0, label.indexOf("."));
            var reader = new FileReader();
            reader.addEventListener("load", function () {
                if (tipo === "archivo") $("#attrarchivotitulo" + id).text(label);
                o.appvm[id][tipo](reader.result);
                updateOpts(o, true);
                input.replaceWith(input.clone(true));
            }, false);
            if (file) reader.readAsDataURL(file);
        }
        function showTab(id) {
            var o = getOpts();
            if (o.appvm.isEditor() || o.appvm[id].habilitado() && o.appvm[id].visible()) {
                var renderEls = setInterval(function () {
                    if (o.appvm[id].elementrendered() !== false) {
                        clearInterval(renderEls);
                        var jparent = searchElementInJson(o, o.appvm[id].elementopadre());
                        for (var i = 0; i < jparent.elementos.elemento.length; i++)
                            o.appvm[jparent.elementos.elemento[i]["@idelemento"]].mostrar(!1), o.appvm[jparent.elementos.elemento[i]["@idelemento"]].activo(!1);
                        o.appvm[id].mostrar(!0), o.appvm[id].activo(!0), $("body").resize();
                    }
                }, 5);
            }
        }
        function showPage(id, tovalidate) {
            var o = getOpts();
            o.appvm[o.idPlantilla].prevalidateall(!tovalidate);

            if (o.drawEditor || (o.drawPreviewer && o.appvm[id].habilitado() && o.appvm[id].visible())) {
                showHideLoading(o), o.pageshowed = "", updateOpts(o, !0), console.log("Pintando pagina: " + id);
                o.plantilla.find(".page").attr("hidden", ""), o.plantilla.find(".page[id='" + id + "']").removeAttr("hidden");

                if (o.appvm[id].activo() === !1)//validacion para saber si estan dando click a la misma pestaña y no volverla a cargar
                    for (var i = 0; i < o.jobj.elemento.elementos.elemento.length; i++) {
                        var pageid = o.jobj.elemento.elementos.elemento[i]["@idelemento"];
                        o.appvm[pageid].tipo() === o.TE.Pagina && o.appvm[pageid].activo(!1);
                        o.plantilla.find(".page[id='" + pageid + "']").empty(), elementUnrender(pageid, o), o.appvm[id].elementrendered(!1);
                    }
                o.appvm[id].activo(!0), o.tabberpage.find("li").removeClass("activo"),
                    o.tabberpage.find("li[value='" + id + "']").addClass("activo");
                if (o.appvm[id].elementrendered() === !1 && o.appvm[id].renderingpage() === !1) {
                    //destruccion de popovers para evitar que queden volando
                    $(".popover.show").remove();
                    o.appvm[id].renderingpage(!0);//bandera y validacion para evitar llamados multiples de reglas o clicks extremadamente rapidos
                    setTimeout(function () {
                        //se mandan dibujar cada ko de elemento al mostrar una pagina
                        for (var i = 0; i < o.jobj.elemento.elementos.elemento.length; i++) {
                            var pageid = o.jobj.elemento.elementos.elemento[i]["@idelemento"];
                            if (id === pageid) {
                                if (o.jobj.elemento.elementos.elemento[i].elementos && o.jobj.elemento.elementos.elemento[i].elementos.elemento)
                                    for (var j = 0; j < o.jobj.elemento.elementos.elemento[i].elementos.elemento.length; j++)
                                        recursiveDraw(o.jobj.elemento.elementos.elemento[i].elementos.elemento[j], o, true);
                                break;
                            }
                        }

                        renderElement(o.plantilla.find(".page[id='" + id + "']"), o), o.appvm[id].elementrendered(!0),
                            o.appvm[id].renderingpage(!1), console.log("Se pinto pagina: " + id), showHideLoading(o, !1),
                            o.plantillaAjax.callback && (o.plantillaAjax.callback(), console.log("Se llamo al callback"));

                        //Se hace render de elementos easyui
                        if (!o.appvm.isEditor()) {
                            var intentosEasy = -1, renderEasyUi = setInterval(function () {
                                intentosEasy++;
                                var o = getOpts();
                                if (o.preview.is(":visible")) {
                                    $("body").resize();
                                    clearInterval(renderEasyUi);
                                }
                                else if (intentosEasy === 20) {
                                    console.error("EASYUI: No se ha cargado en tiempo la plantilla");
                                    clearInterval(renderEasyUi);
                                }
                            }, 100);
                            !tovalidate && circularTab(o);
                        }
                        if (!o.appvm.isEditor() && o.evaAfterRender !== null && o.evaAfterRender.length > 0) {
                            for (let i = 0; i < o.evaAfterRender.length; i++)
                                evaluateConditions(o, o.evaAfterRender[i]);
                            o.evaAfterRender = [];
                        }
                        if (o.finishload === !1) { o.finishload = !0, evaluateConditions(o, o.idPlantilla), runmacro(o), delete o.finishload; }//ahora "Al cargar" se ejecuta al terminar de pintar todo
                    }, 5);
                } else showHideLoading(o, !1), validateCustomElements(o, id, !1, !0);
            }
            var pageshownid = "pageisshowing" + id;
            o[pageshownid] = !0, evaluateConditions(o, id), o[pageshownid] = !1;//reglas cargar pagina

            if (!o.appvm.isEditor() && !!o.wizardnavigation && o.wizardnavigation[id]) updateNavigationWizard(o, o.wizardnavigation[id], id);
        }
        function updateNavigationWizard(o, idWizList, idPage) {
            for (var i = 0; i < idWizList.length; i++) {
                if (o.appvm[idWizList[i]] && !!o.appvm[idWizList[i]].navegacion()) {
                    var lstNav = o.appvm[idWizList[i]].navegacion().toString().split(","), indexNav = _.indexOf(lstNav, idPage);
                    o.appvm[idWizList[i]].visibleregresar(indexNav > 0), o.appvm[idWizList[i]].visibleavanzar(indexNav < lstNav.length - 1),
                        o.appvm[idWizList[i]].valinit(indexNav + 1), o.appvm[idWizList[i]].valfin(lstNav.length),
                        o.appvm[idWizList[i]].visiblefinalizar(indexNav === lstNav.length - 1);
                }
            }
        }
        function updateDocumentCheck(o, idDoc, idCheck) {
            if (o.appvm[idDoc] && o.appvm[idCheck]) {
                var selitems = [], tipodocjson = verifyJsonString(o.appvm[idDoc].tipodoc()) ? JSON.parse(o.appvm[idDoc].tipodoc()) : {};
                var guidanex = _.map(o.appvm[idDoc].anexo(), function (an) { return an.guidanexo; });
                var anexdoc = _.filter(_.keys(tipodocjson), function (dc) { return _.includes(guidanex, dc); });
                _.forEach(anexdoc, function (andoc) {
                    var selit = _.find(o.appvm[idCheck].catalogodestino(), { Valor: tipodocjson[andoc] });
                    selit && selitems.push(selit);
                });
                o.appvm[idCheck].chosenitems(selitems);
            }
        }
        function update(o) {
            if (!o) o = getOpts();
            o.plantilla.empty(), o.tabberpage.empty();
            getScripts(o, function () {
                var max = getMaxElementByType(o);
                var countelem = o.xml.match(new RegExp('idelemento=', 'g')); //contador de elementos
                var maxcount = countelem !== null ? countelem.length : 1;
                o.appvm.maxNumberId(max), o.appvm.counterElement(maxcount);
                max > 1 ? o.plantilla.removeClass("state-default-plantilla-empty") : o.plantilla.addClass("state-default-plantilla-empty");
                //se agrega la plantilla al modelo
                createElementToView(o, o.jobj.elemento, {}, !0);

                //Se recorren las paginas para obtener el modelo completo antes del mapping
                var element = {};
                if (o.jobj.elemento.elementos && o.jobj.elemento.elementos.elemento)
                    for (var j = 0; j < o.jobj.elemento.elementos.elemento.length; j++) element = recursiveElementToModel(o.jobj.elemento.elementos.elemento[j], o, element);

                //Se extrae por cada element los diccionarios
                var dicts = {}, ee;
                for (ee in element) {
                    dicts[ee] = { reevaldictionary: element[ee]["reevaldictionary"], dictionarydata: element[ee]["dictionarydata"] };
                    delete element[ee]["reevaldictionary"];
                    delete element[ee]["dictionarydata"];
                }

                ko.mapping.fromJS(element, o.appvm);

                for (ee in dicts) {
                    reevaluateDictionaryData(o, dicts[ee]["reevaldictionary"], dicts[ee]["dictionarydata"], ee);
                    !o.appvm.isEditor() && (initializeAttrByElems(o, ee), checkRuleForElement(o));
                    setCustomSubscribes(o, ee);
                }

                if (o.jobj.elemento.elementos && o.jobj.elemento.elementos.elemento)
                    for (var j = 0; j < o.jobj.elemento.elementos.elemento.length; j++) recursiveDraw(o.jobj.elemento.elementos.elemento[j], o);

                plantillaIsLoaded(o), updateOpts(o, true);
            });
        }
        function updateSortXml(o, id, parentid, rendered, dir) {
            if (rendered) {
                //si hay direccion significa que es izquierda o derecha
                if (dir) {
                    var toMove = $('div#' + id), parent = $('div#' + parentid);
                    //puede ser la plantilla
                    if (!parent.length) parent = $('div#formElec_plantilla');
                    var contparent = findContainerParent(parent, o), children = contparent.children().filter("[id^=formElec]"),
                        index = children.index(toMove);
                    //validacion de indices para saber si ya esta en ese lugar o no
                    switch (dir) {
                        case "allleft": if (index === 0) return; index = 0; break;
                        case "left": if (index === 0) return; index += -1; break;
                        case "right": if (index === children.size() - 1) return; index += 1; break;
                        case "allright": if (index === children.size() - 1) return; index = children.size() - 1; break;
                    }
                    switch (o.appvm[parentid].tipo()) {
                        case o.TE.Tabber: case o.TE.Plantilla:
                            var almattr = o.appvm[parentid].tipo() === o.TE.Tabber ? "tabids" : "pagids",
                                tabids = o.appvm[parentid][almattr](), elmindx = tabids.indexOf(id);
                            tabids.splice(elmindx, 1), tabids.splice(index, 0, id);
                            o.appvm[parentid][almattr](tabids);
                            break;
                    }
                    var sib;
                    if (dir === "allleft") {
                        contparent.prepend(toMove);
                    }
                    else if (dir === "left") {
                        sib = toMove[0].previousElementSibling;
                        toMove.insertBefore(sib);
                    }
                    else if (dir === "right") {
                        sib = toMove[0].nextElementSibling;
                        toMove.insertAfter(sib);
                    }
                    else if (dir === "allright") {
                        contparent.append(toMove);
                    }
                    insertAtIndexXml(index, parentid, id, o);
                }
                //no hay direccion entonces es mover elemento a otro elemento
                else {
                    var parent = $('div#' + parentid);
                    var parentcontent = findContainerParent(parent, o);
                    insertAtIndexXml(parentcontent.children().filter("[id^=formElec]").size(), parentid, id, o);
                    parentcontent.append($('div#' + id));
                }
            }
            else {
                //no esta rendereado, solo se actualiza json
                var newparent = searchElementInJson(o, parentid);
                insertAtIndexXml(newparent.elementos.elemento.length, parentid, id, o);
                $('div#' + id).remove();
            }
            updateOpts(o, true);
        }
        function updatePlantillaTag(o) {
            for (var i = 0; i < o.datatags.elementAtt.length; i++)
                if (o.datatags.elementAtt[i].NombreElemento.toLowerCase() === o.jobj.elemento["@tipoelemento"].toLowerCase()) {
                    var element = o.datatags.elementAtt[i], names = [], value;
                    for (var p in element.Atributos) element.Atributos.hasOwnProperty(p) && names.push(p);
                    names = names.sort();
                    for (var a = 0; a < names.length; a++) {
                        if (element.Atributos[names[a]] instanceof Object)
                            value = element.Atributos[names[a]].Valor instanceof Array ? JSON.stringify(element.Atributos[names[a]].Valor[0]) : element.Atributos[names[a]].Valor;
                        else if (element.Atributos[names[a]] instanceof Array)
                            value = JSON.stringify(element.Atributos[names[a]]);
                        else value = element.Atributos[names[a]];
                        o.jobj.elemento.atributos[names[a].toLowerCase()] = value;
                    }
                    o.jobj.elemento.atributos.iscontainer && o.jobj.elemento.atributos.iscontainer === !0 && (o.jobj.elemento.elementos = {});
                    o.appvm = new appViewModel();
                    createElementToView(o, o.jobj.elemento, {}, !0);
                    ko.applyBindings(o.appvm);
                    updateOpts(o, true);
                    break;
                }
        }
        //Acordarme de pasar esto dentro del armado del xml en vez de que este despues del armado del xml
        function validateTablesNotEmpty(o) {
            var txtmessage = "", resultempty = !0;
            _.forEach(_.keys(o.appvm), function (valele) {
                if (valele.indexOf("formElec_element") === 0 && o.appvm[valele].tipo() === o.TE.Tabla) {
                    var tabla = searchElementInJson(o, valele);
                    tabla.elementos.elemento.length < 1 && (txtmessage += o.appvm[valele].titulo() + ",");
                }
            });
            txtmessage.length > 0 && (toasty('TABLAS VAC&Iacute;AS', 'Verifique: ' + txtmessage, 'error'), resultempty = !1);
            return resultempty;
        }
        function validateAndSavePlantilla() {
            var o = getOpts();
            showHideLoading(o, true), o.datasend.xml = getXml(), !o.mensajeGuardaPlantilla.length && savePlantilla(o);
        }
        function wysiwyg(id) {
            var o = getOpts(), attr, attrencoded, extrainfo = "", ishtmltext = "";
            switch (o.appvm[id].tipo()) {
                case o.TE.Plantilla:
                    attr = "contenidoestaticohtml";
                    attrencoded = "contenidoestaticohtmlisencoded";
                    extrainfo = "Para utilizar el contenido est&aacute;tico con HTML, se debe de poner la posici&oacute;n en la cual se encuentra el elemento en la lista de contenido est&aacute;tico\
                                    entre llaves(en caso de querer usar el t&iacute;tulo, colocar una t al lado).Por ejemplo: <ul><li>{1} (para usar el valor)</li><li>{1t} (para usar el t&iacute;tulo)</li></ul>";
                    break;
                case o.TE.Leyenda:
                    attr = "valor";
                    attrencoded = "isencoded";
                    extrainfo = "Escriba el contenido del elemento leyenda. Puede copiar y pegar de editores de texto.";
                    ishtmltext = '<div class="pb-2"><input ' + (o.appvm[id].eshtml() ? 'checked' : '') + ' type="checkbox"><span class="ml-2">Texto HTML</span></div>';
                    break;
            }
            var wyg = $('<div class="modal" tabindex="-1" id="FEwysiwyg" role="dialog">\
                <div class="modal-dialog modal-lg" role="document">\
                    <div class="modal-content rounded">\
                        <div class="modal-header border-bottom">\
                            <h5 class="modal-title">Contenido del elemento '+ o.appvm[id].titulo() + '</h5>\
                        </div>\
                        <div class="modal-body">\
                            <div class="pb-2">' + extrainfo + '</div>'
                + ishtmltext +
                '<div><div id="FEwysiwygwysihtml5" style="overflow:auto; max-height:50vh;"></div></div>\
                        </div>\
                        <div class="modal-footer">\
                            <div class="btn btn-light border FEFEwysiwygCerrar px-2 py-1"><i class="fas fa-times mr-2"></i>Cerrar</div>\
                        </div>\
                    </div>\
                </div>\
            </div>');
            $("body").append(wyg);
            AvisoCustom("FEwysiwyg");

            var quill = new Quill('#FEwysiwygwysihtml5', {
                theme: 'snow',
                placeholder: "Inserte leyenda...",
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline', 'strike'], ['blockquote', 'code-block'], [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        [{ 'script': 'sub' }, { 'script': 'super' }], [{ 'indent': '-1' }, { 'indent': '+1' }], [{ 'direction': 'rtl' }],
                        [{ 'size': ['small', 'medium', 'large', 'huge'] }], [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                        [{ 'color': [] }, { 'background': [] }], [{ 'font': [] }], [{ 'align': [] }], ['clean']
                    ]
                }
            });

            if (o.appvm[id].tipo() === o.TE.Leyenda) {
                wyg.find("input[type=checkbox]").on("change", function (e) {
                    o.appvm[id].eshtml(e.target.checked);
                    $('.ql-editor').html("");
                    $(".ql-toolbar .ql-formats button, .ql-toolbar .ql-formats span")[o.appvm[id].eshtml() ? "addClass" : "removeClass"]("disabled");
                });
                if (o.appvm[id].eshtml())
                    $(".ql-toolbar .ql-formats button, .ql-toolbar .ql-formats span").addClass("disabled");
                $('.ql-editor')[o.appvm[id].eshtml() ? "text" : "html"](o.appvm[id][attr]());
            }
            else $('.ql-editor').text(o.appvm[id][attr]());

            wyg.find(".FEFEwysiwygCerrar").on("click", function () {
                var qleditor = $('.ql-editor');
                o.appvm[id][attr](o.appvm[id].eshtml && o.appvm[id].eshtml() || !o.appvm[id].eshtml ? qleditor.text() : qleditor.html()), o.appvm[id][attrencoded](!0), $("#FEwysiwyg").modal("hide").remove();
                o.appvm[id][attr]() === "<br />" && o.appvm[id][attr]("");
            });
        }
        function xmlToString(o, format, customid) {
            var warning = "", duplicatedMetadata = {}, duplicatedIdUnico = {}, rl;
            o.mensajeGuardaPlantilla = "",
                o.datasend.estructplan = { usarcoordenadas: "", catalogos: { "completez": [], "catalogos": [] }, verexpres: !0, vertipodocres: !0, vernuevacapturamovil: !0 },
                o.datasend.estructplan.vernuevacapturamovil = o.appvm[o.appvm.idPlantilla()]["vernuevacapturamovil"] ? o.appvm[o.appvm.idPlantilla()]["vernuevacapturamovil"]() : !0; //si aun no existe esa propiedad se manda true
            //se transforma los visiblecontenido en visible
            for (rl in o.appvm[o.idPlantilla].reglas()) {
                for (var at in o.appvm[o.idPlantilla].reglas()[rl].actions) {
                    if (o.appvm[o.idPlantilla].reglas()[rl].actions[at].verb) {
                        if (o.appvm[o.idPlantilla].reglas()[rl].actions[at].verb === "visiblecontenido") o.appvm[o.idPlantilla].reglas()[rl].actions[at].verb = "visible";
                        if (o.appvm[o.idPlantilla].reglas()[rl].actions[at].verb === "notvisiblecontenido") o.appvm[o.idPlantilla].reglas()[rl].actions[at].verb = "notvisible";
                        if (o.appvm[o.idPlantilla].reglas()[rl].actions[at].verb === "showLoaderOnElement") delete o.appvm[o.idPlantilla].reglas()[rl].actions[at];
                    }
                }
                for (var co in o.appvm[o.idPlantilla].reglas()[rl].conditions) {
                    for (var su in o.appvm[o.idPlantilla].reglas()[rl].conditions[co].subject) {
                        if (o.appvm[o.idPlantilla].reglas()[rl].conditions[co].subject[su].verb) {
                            if (o.appvm[o.idPlantilla].reglas()[rl].conditions[co].subject[su].verb === "visiblecontenido") o.appvm[o.idPlantilla].reglas()[rl].conditions[co].subject[su].verb = "visible";
                            if (o.appvm[o.idPlantilla].reglas()[rl].conditions[co].subject[su].verb === "notvisiblecontenido") o.appvm[o.idPlantilla].reglas()[rl].conditions[co].subject[su].verb = "notvisible";
                        }
                    }
                }
            }
            for (rl in o.appvm[o.idPlantilla].servicios()) {
                if (!_.isEmpty(o.appvm[o.idPlantilla].servicios()[rl].pin)) {
                    o.mensajeGuardaPlantilla += `<li>El servicio <strong>${o.appvm[o.idPlantilla].servicios()[rl].customname}</strong> es obsoleto, <strong style="color: red;">Migrelo a Servicios Versión 2</strong>.</li>`;
                }
            }
            if (o.appvm[o.idPlantilla].tiempoautoguardado() > 0 && o.appvm[o.idPlantilla].tiempoautoguardado() <= 2) {
                o.mensajeGuardaPlantilla += `<li>El tiempo de autoguardado en la captura es muy corto (${o.appvm[o.idPlantilla].tiempoautoguardado()}), Poner minimó 3 minutos.</li>`;
            }

            var keys = _.keys(o.appvm[o.idPlantilla].reglas());
            var ruleok = function (o, r, co, chs, chv, chp) {
                if (o.appvm[o.idPlantilla].reglas()[r].conditions[co].subject) {
                    for (var co2 in o.appvm[o.idPlantilla].reglas()[r].conditions[co].subject) {
                        if (chs && _.isEmpty(o.appvm[o.idPlantilla].reglas()[r].conditions[co].subject[co2].subject)) return false;
                        else if (chv && _.isEmpty(o.appvm[o.idPlantilla].reglas()[r].conditions[co].subject[co2].verb)) return false;
                        else if (chp && o.appvm[o.idPlantilla].reglas()[r].conditions[co].subject[co2].predicate) {
                            if (o.appvm[o.idPlantilla].reglas()[r].conditions[co].subject[co2].predicate.mode === "element" && _.isEmpty(o.appvm[o.idPlantilla].reglas()[r].conditions[co].subject[co2].predicate.value))
                                return false;
                            else if (o.appvm[o.idPlantilla].reglas()[r].conditions[co].subject[co2].predicate.mode === "varusr" && _.isEmpty(o.appvm[o.idPlantilla].reglas()[r].conditions[co].subject[co2].predicate.value))
                                return false;
                        }
                    }
                } else return false;
                return true;
            };
            _.forEach(keys, function (r) { //revision de reglas vacias
                var msj = "", rn = o.appvm[o.idPlantilla].reglas()[r].name, co;
                if (o.appvm[o.idPlantilla].reglas()[r] && o.appvm[o.idPlantilla].reglas()[r].enabled) {
                    if (o.appvm[o.idPlantilla].reglas()[r].conditions)
                        for (co in o.appvm[o.idPlantilla].reglas()[r].conditions) {
                            if (o.appvm[o.idPlantilla].reglas()[r].conditions[co].category === "elementid") { //en categoria de elementos no debe estar vacio el elemento
                                msj = `<li>La regla <strong>${rn}</strong> en la condición de categoría <strong>Elementos</strong> está vacío el sujeto, verbo o predicado.</li>`;
                                if (!ruleok(o, r, co, !0, !0, !0)) warning += msj;
                            }
                            else if (o.appvm[o.idPlantilla].reglas()[r].conditions[co].category === "document") { //en categoria de flujos no debe estar vacio el flujo
                                msj = `<li>La regla <strong>${rn}</strong> en la condición de categoría <strong>Flujos</strong> está vacío el flujo.</li>`;
                                if (!ruleok(o, r, co, !0)) warning += msj;
                            }
                            else if (o.appvm[o.idPlantilla].reglas()[r].conditions[co].category === "permissions") { //en categoria de permisos no debe estar vacio el grupo
                                msj = `<li>La regla <strong>${rn}</strong> en la condición de categoría <strong>Permisos</strong> está vacío el grupo.</li>`;
                                if (!ruleok(o, r, co, !0)) warning += msj;
                            }
                            else if (o.appvm[o.idPlantilla].reglas()[r].conditions[co].category === "table") { //en categoria de tablas por columnas no debe estar vacio el sujeto
                                msj = `<li>La regla <strong>${rn}</strong> en la condición de categoría <strong>Tablas por Columna</strong> está vacío el sujeto, verbo o predicado.</li>`;
                                if (!ruleok(o, r, co, !0, !0, !0)) warning += msj;
                            }
                            else if (o.appvm[o.idPlantilla].reglas()[r].conditions[co].category === "bytable") { //en categoria de tablas por filas no debe estar vacio el sujeto
                                msj = `<li>La regla <strong>${rn}</strong> en la condición de categoría <strong>Tablas por filas</strong> está vacío la tabla, fila, sujeto, verbo o predicado.</li>`;
                                if (_.isEmpty(o.appvm[o.idPlantilla].reglas()[r].conditions[co].tableidelem)) { warning += msj; continue; }
                                else if (_.isEmpty(o.appvm[o.idPlantilla].reglas()[r].conditions[co].rowtype)) { warning += msj; continue; }
                                else if (!ruleok(o, r, co, !0, !0, !0)) warning += msj;
                            }
                            else if (o.appvm[o.idPlantilla].reglas()[r].conditions[co].category === "withoutcondition") { //categoria sin condiciones
                                //no se evalua
                            }
                        }
                    if (o.appvm[o.idPlantilla].reglas()[r] && o.appvm[o.idPlantilla].reglas()[r].actions)
                        for (co in o.appvm[o.idPlantilla].reglas()[r].actions) {
                            if (_.isEmpty(o.appvm[o.idPlantilla].reglas()[r].actions[co].verb)) { //en categoria de elementos no debe estar vacio el elemento
                                warning += "<li>La regla <strong>{0}</strong> en una acción está vacío el verbo.</li>".format(rn);
                            }
                            else if (_.isEmpty(o.appvm[o.idPlantilla].reglas()[r].actions[co].subject)) {
                                warning += "<li>La regla <strong>{0}</strong> en una acción está vacío el sujeto.</li>".format(rn);
                            }
                            else if (o.appvm[o.idPlantilla].reglas()[r].actions[co].predicate && o.appvm[o.idPlantilla].reglas()[r].actions[co].verb.toString().indexOf("value") >= 0) {
                                msj = "<li>La regla <strong>{0}</strong> en una acción está vacío el predicado de tipo Elemento o Variable.</li>".format(rn);
                                if (o.appvm[o.idPlantilla].reglas()[r].actions[co].predicate.mode === "element" && o.appvm[o.idPlantilla].reglas()[r].actions[co].predicate.value && _.isEmpty(o.appvm[o.idPlantilla].reglas()[r].actions[co].predicate.value.toString()))
                                    warning += msj;
                                else if (o.appvm[o.idPlantilla].reglas()[r].actions[co].predicate.mode === "varusr" && o.appvm[o.idPlantilla].reglas()[r].actions[co].predicate.value && _.isEmpty(o.appvm[o.idPlantilla].reglas()[r].actions[co].predicate.value.toString()))
                                    warning += msj;
                            }
                        }
                }
            });

            //nueva validacion para saber si existe resumen ya que ningun plantilla puede ser guardada sin resumen
            if (_.isEmpty(o.appvm[o.appvm.idPlantilla()].resumen2().texto) &&
                _.isEmpty(o.appvm[o.appvm.idPlantilla()].resumen2().imagen) &&
                _.isEmpty(o.appvm[o.appvm.idPlantilla()].resumen2().tabla) &&
                _.isEmpty(o.appvm[o.appvm.idPlantilla()].resumen()))
                o.mensajeGuardaPlantilla += "<li>La plantilla no tiene Resumen configurado, favor de configurar un resumen.</li>";
            if (_.isEmpty(o.appvm[o.appvm.idPlantilla()].resumen2()) && !_.isEmpty(o.appvm[o.appvm.idPlantilla()].resumen()))
                warning += "<li>Resumen V1 obsoleto, se recomienda usar el Resumen V2.</li>";

            for (var id in o.appvm) {
                if (id.indexOf("formElec_element") > -1) {
                    var thiselem = searchElementInJson(o, id);
                    if (thiselem) {
                        delete thiselem.atributos["eventos"];

                        for (var attr in o.appvm[id]) {
                            if (id === o.appvm.idPlantilla()) { //plantilla
                                if (o.extraAttr[o.TE.Pagina].includes(attr)) delete thiselem.atributos[attr];
                                else {
                                    if ("titulo" === attr) (_.isEmpty(o.appvm[id][attr]()) || o.appvm[id][attr]().toLowerCase() === "plantilla") &&
                                        (o.mensajeGuardaPlantilla += "<li>La plantilla no tiene t&iacute;tulo, es obligatorio que tenga un t&iacute;tulo.</li>");

                                    thiselem["@versionguardadoplantilla"] = o.versionnum;
                                    thiselem["@version"] = o.version;
                                    thiselem["@fechaguardadoplantilla"] = moment().format("DD-MM-YYYY HH:mm:ss");
                                    o.appvm[id]["lastupdate"](thiselem["@fechaguardadoplantilla"]);
                                    thiselem.atributos[attr] = o.appvm[id][attr]();
                                    if (attr === "contenidoestaticohtml" && o.appvm[id].contenidoestaticohtmlisencoded()) thiselem.atributos[attr] = b64EncodeUnicode(o.appvm[id][attr]());
                                    _.includes(["usarcoordenadas", "verexpres", "vertipodocres"], attr) && (o.datasend.estructplan[attr] = o.appvm[id][attr]());
                                }
                            } else { //elementos hijos
                                if (o.extraAttr["All"].includes(attr)) delete thiselem.atributos[attr];
                                else {
                                    if (attr === "titulo") _.isEmpty(o.appvm[id][attr]().toString()) &&
                                        (o.mensajeGuardaPlantilla += "<li>El elemento <strong>{0}</strong> no tiene t&iacute;tulo, es obligatorio que tenga t&iacute;tulo.</li>".format(id));
                                    if (["catalogodestino", "anteriornombrearchivo"].includes(attr)) thiselem.atributos[attr] = "";
                                    else if (typeof o.appvm[id][attr] === "function") {
                                        if ("valor" === attr && thiselem["@tipoelemento"] === o.TE.Leyenda && o.appvm[id].isencoded() === true)
                                            thiselem.atributos[attr] = b64EncodeUnicode(o.appvm[id][attr]());
                                        else if ("catalogoorigen" === attr)
                                            thiselem.atributos[attr] = o.appvm[id][attr](),
                                                o.datasend.estructplan.catalogos[o.appvm[id].fuentedatos()].push(o.appvm[id][attr]());
                                        else thiselem.atributos[attr] = o.appvm[id][attr]();
                                        //busqueda de metadato para revisar duplicidad
                                        if (_.includes(["metadato", "metadatofinal", "metadatoinicial", "metadatorango"], attr)) {
                                            if (o.appvm[id][attr]()) {
                                                if (duplicatedMetadata[o.appvm[id][attr]()]) duplicatedMetadata[o.appvm[id][attr]()].push(id);
                                                else duplicatedMetadata[o.appvm[id][attr]()] = [id];
                                            }
                                        }
                                        //busqueda de idunicos para revisar duplicidad
                                        if (attr === "idunico") {
                                            if (o.appvm[id][attr]()) {
                                                if (duplicatedIdUnico[o.appvm[id][attr]()]) duplicatedIdUnico[o.appvm[id][attr]()].push(id);
                                                else duplicatedIdUnico[o.appvm[id][attr]()] = [id];
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            if (!_.isEmpty(warning)) {
                Modal("Funcionalidad obsoleta ó con errores. Corriga lo más pronto posible", '<ol style="font-size: 1.2rem;">' + warning + '</ol>', "", "error");
            }
            var txtmeta = "", zz, yy;
            for (zz in duplicatedMetadata)
                if (duplicatedMetadata[zz].length > 1)
                    for (yy in duplicatedMetadata[zz])
                        txtmeta += "<br/>" + o.appvm[duplicatedMetadata[zz][yy]].titulo() + " <strong>(" + o.appvm[duplicatedMetadata[zz][yy]]["metadato"]() + ")</strong>";
            txtmeta.length && (o.mensajeGuardaPlantilla += "<li>Los siguientes elementos tienen metadatos repetidos: " + txtmeta + ".</li>");
            txtmeta = "";
            for (zz in duplicatedIdUnico)
                if (duplicatedIdUnico[zz].length > 1)
                    for (yy in duplicatedIdUnico[zz])
                        txtmeta += "<li>" + o.appvm[duplicatedIdUnico[zz][yy]].titulo() + " <strong>(" + o.appvm[duplicatedIdUnico[zz][yy]]["idunico"]() + ")</strong></li>";
            if (txtmeta.length) {
                Error("Existen elementos con IDUnico repetido, no deberia de existir duplicidad. <ul>" + txtmeta + "</ul>");
            }
            o.datasend.nombre = o.jobj.elemento.atributos.titulo;
            o.datasend.estructplan = JSON.stringify(o.datasend.estructplan);
            o.xmloptions.format = format === true;
            var newxml = "";
            if (!_.isEmpty(customid)) {//nueva logica para solo buscar el idpadre enespecifico y convertirlo a xml
                var specifielement = { elemento: searchElementInJson(o, customid) };
                newxml = new parser.j2xParser(o.xmloptions).parse(specifielement);
            } else newxml = new parser.j2xParser(o.xmloptions).parse(o.jobj);
            newxml = newxml.replace(/&amp;/g, '&').replace(/&/g, '&amp;');
            var validated = parser.validate(newxml);
            if (validated !== true) {
                o.mensajeGuardaPlantilla += "<li>Ocurri&oacute; un error al leer el xml: '{0}', El mensaje es: '{1}', Por favor revise los elementos relacionados.</li>".format(validated.err.code, he.encode(validated.err.msg));
            }

            var wiz = newxml.match(new RegExp('tipoelemento="' + o.TE.Wizard, 'g'));
            if (!wiz && _.isEmpty(customid)) {
                o.mensajeGuardaPlantilla += "<li>No agregó ningun wizard a la plantilla, Los wizards son la unica manera de poder publicar su formato, agregue uno para salir y otro para guardar.</li>";
            }

            if (o.mensajeGuardaPlantilla.length > 0) {
                o.mensajeGuardaPlantilla = '<ol style="font-size: 1.2rem;">{0}</ol>'.format(o.mensajeGuardaPlantilla);
                Mensaje("Para guardar la plantilla debe corregir lo siguiente: ", o.mensajeGuardaPlantilla);
                if (format !== true) newxml = null;
            }
            return newxml;
        }



        //Capturador de documentos electronicos
        function asignaChosenItemsPorValor(valor, id, o) {
            var ta = o.appvm[id].tipoasociacion(), tl = o.appvm[id].tipolista(), valmet = ta === "iddesc" || ta === "idid" ? "Valor" : "Nombre", nv;
            if (tl === "checkbox") nv = [], valor.toString().split(",").forEach((r) => { var tt = _.find(o.datatags.allitemscatalogs["catalogos|" + o.appvm[id].catalogoorigen()], function (c) { return c[valmet].toLowerCase() === r.toLowerCase(); }); tt && nv.push(tt); });
            else nv = _.find(o.datatags.allitemscatalogs["catalogos|" + o.appvm[id].catalogoorigen()], function (c) { return c[valmet].toLowerCase() === valor.toString().toLowerCase(); });
            nv && (tl === "combo" ? o.appvm[id].optionselectedRule(nv.Valor) : o.appvm[id].chosenitemsRule(nv));
        }
        function circularTab(o) {
            var allcontrols = o.preview.find("div.sortable").find("input:text,textarea,select");//,input:checkbox,input:radio,div.btn");
            if (allcontrols.length) {
                allcontrols[0].focus();
                $.each(allcontrols, function (i, c) { c.tabIndex = i + 1; });
                $(window).on("keyup", function (e) {
                    if (e.which === 9) { //Tab
                        if (e.target.tabIndex === 0 || e.target.tabIndex > allcontrols.length) {
                            e.preventDefault();
                            allcontrols[0].focus();
                        }
                    }
                });
            }
        }
        function createAttachmentName(o, id, docidreemp, num) {
            num = num || 1;
            var guidAnexo = moment(new Date()).format("YYYYMMDDHHmmssSSS"),
                fname = o.datasend.guid + "_" + id + (!docidreemp ? "" : "R" + docidreemp) + "_" + num + "_" + guidAnexo + ".ane";
            console.log("guid creado: " + guidAnexo);
            !!_.find(o.appvm.listAnexos(), { FileName: fname }) && (fname = createAttachmentName(o, id, docidreemp, num));
            return fname;
        }
        function createAttachment(o, id, ext, data64, docidanexoreplace, multiupload, multiadd, filename, rname) {
            var maxachieved = !1;
            if (!docidanexoreplace && o.appvm[id].tipo() === o.TE.Documento && o.appvm[id].maximodocumentos() > 0 &&
                _.filter(o.appvm.listAnexos(), { ElementoId: id }).length === o.appvm[id].maximodocumentos()) {
                toasty('', 'S&oacute;lo se permiten cargar ' + o.appvm[id].maximodocumentos() + ' documentos.');
                if (o.appvm[id].anexo().length === _.filter(o.appvm.listAnexos(), { ElementoId: id }).length) return;
                else maxachieved = !0, multiupload = !1;
            }
            if (o.appvm[id].tipo() !== o.TE.Documento && !!o.appvm[id].anteriornombrearchivo()) {
                var file = _.find(o.appvm.listAnexos(), { GuidAnexo: o.appvm[id].anteriornombrearchivo() });
                file && (docidanexoreplace = file.DocID);
            }
            filename = filename || createAttachmentName(o, id, docidanexoreplace, 1);
            if (data64.indexOf(";base64,") >= 0) data64 = data64.substring(data64.indexOf(";base64,") + 8);
            rname = rname || moment(new Date()).format("MMDDHHx") + "." + ext;
            //Se crea el objeto nuevo
            var anexo = { FileName: filename, ElementoId: id, Datos: data64, Extension: ext, NombreOriginal: rname };
            //Si no es elemento documento o huellas entonces se borra para solo tener uno a la vez
            if (!multiadd) {
                for (var i = 0; i < o.appvm.listAnexos().length; i++) {
                    if (o.appvm.listAnexos()[i].ElementoId === id && o.appvm.listAnexos()[i].Reemplazado === !1)
                        o.appvm.listAnexos.splice(i, 1);
                }
            }
            //Se añade a la lista global
            !maxachieved && o.appvm.listAnexos.push(anexo);
            if (!multiupload)
                uploadAnexoAndSaveBorrador(o, id, "", "", "", docidanexoreplace);
            var strfunc = "addanexo" + id;
            o[strfunc] = !0, evaluateConditions(o, id), o[strfunc] = !1;
        }
        function nextPageIsFormat(o, idwiz, plantid) {
            if (!!idwiz && o.appvm[idwiz].plantillaabrir()) {
                if (o.appvm[o.appvm[idwiz].elementopadre()].tipo() === o.TE.Tabla) {
                    if (o.appvm[idwiz].cantidadformatosabrircounter()[o.appvm[o.appvm[idwiz].elementopadre()].clickedrow()] === 0) {
                        toasty('', 'El l&iacute;mite de formatos a abrir ha sido alcanzado', 'error');
                        return false;
                    }
                    else if (o.appvm[idwiz].cantidadformatosabrircounter()[o.appvm[o.appvm[idwiz].elementopadre()].clickedrow()] > 0)
                        o.appvm[idwiz].cantidadformatosabrircounter()[o.appvm[o.appvm[idwiz].elementopadre()].clickedrow()]--;
                }
                else {
                    if (o.appvm[idwiz].cantidadformatosabrircounter() === 0) {
                        toasty('', 'El l&iacute;mite de formatos a abrir ha sido alcanzado', 'error');
                        return false;
                    }
                    else if (o.appvm[idwiz].cantidadformatosabrircounter() > 0) o.appvm[idwiz].cantidadformatosabrircounter(o.appvm[idwiz].cantidadformatosabrircounter() - 1);
                }
            }
            if (plantid || o.appvm[idwiz].plantillaabrir()) {
                var configplant = idwiz ? o.appvm[o.idPlantilla].prefilleddata()[o.appvm[idwiz].plantillaabrir()] : o.appvm[o.idPlantilla].prefilleddata()[plantid];
                if (configplant && !!configplant.idplantilla) {
                    var getURLParams = function (url) {
                        url = DecriptURL(url);
                        var params = url.toString().split("?")[1], search_params = {};
                        _.forEach(params.toString().split("&"), function (l) { search_params[l.toString().split('=')[0].toLowerCase()] = l.split('=')[1]; });
                        return search_params;
                    }, urlParamsToString = function (url, params) {
                        var root = url.toString().split("?")[0] + "?";
                        _.forEach(_.keys(params), function (n) { root += n + "=" + params[n] + "&"; });
                        return root.substring(0, root.length - 1);
                    }, url = window.location.href, search_params = getURLParams(url), senddata = [];
                    search_params['expid'] = configplant.idplantilla.toString().split("_")[0]; delete search_params['D'], delete search_params['d'], delete search_params['G'], delete search_params['g']; //por si vienen en minusculas
                    for (var el in configplant.mapeo) {
                        var elmpre = configplant.mapeo[el], tablepre = [], rowtoimp, camefromrow = !1, jsonmap;
                        if (elmpre.tipoRel === "istable") {
                            jsonmap = o.appvm[elmpre.idelem].valorjson();
                            if (o.appvm[elmpre.idelem] && o.appvm[elmpre.idelem].valorjson) {
                                if (!!idwiz && o.appvm[o.appvm[idwiz].elementopadre()].tipo() === o.TE.Tabla && o.appvm[elmpre.idelem].elementopadre() === o.appvm[idwiz].elementopadre()) {
                                    if (o.appvm[o.appvm[idwiz].elementopadre()].clickedrow() > -1)
                                        jsonmap = [_.find(o.appvm[o.appvm[idwiz].elementopadre()].valorjson(), function (vel) { return vel.Acciones.id() === o.appvm[o.appvm[idwiz].elementopadre()].clickedrow(); })];
                                }
                                var mapeodatos = _.groupBy(elmpre.mapeoHijos, 'idelem');
                                _.forEach(jsonmap, function (rowtable) {
                                    var tableprerow = {}, destintablemap;
                                    _.forEach(_.keys(rowtable), function (celltable) {
                                        mapeodatos[celltable] && (
                                            destintablemap = mapeodatos[celltable][0].destination instanceof Array ? mapeodatos[celltable][0].destination : [mapeodatos[celltable][0].destination],
                                            _.forEach(destintablemap, function (dest) { tableprerow[dest] = ko.mapping.toJS(rowtable[celltable]); }));
                                    });
                                    tablepre.push(tableprerow);
                                });
                            }
                            senddata.push({ elementodestino: elmpre.destination, valorestabla: tablepre });
                        }
                        else {
                            for (var elhijo in elmpre.mapeoHijos) {
                                var elmprehijo = elmpre.mapeoHijos[elhijo], destin = elmprehijo.destination instanceof Array ? elmprehijo.destination.join(",") : elmprehijo.destination,
                                    elmmap = o.appvm[elmprehijo.idelem];
                                if (!!idwiz && o.appvm[o.appvm[idwiz].elementopadre()].tipo() === o.TE.Tabla && o.appvm[elmprehijo.idelem].elementopadre() === o.appvm[idwiz].elementopadre()) {
                                    if (o.appvm[o.appvm[idwiz].elementopadre()].clickedrow() > -1) {
                                        rowtoimp = _.find(o.appvm[o.appvm[idwiz].elementopadre()].valorjson(), function (vel) { return vel.Acciones.id() === o.appvm[o.appvm[idwiz].elementopadre()].clickedrow(); });
                                        elmmap = rowtoimp[elmprehijo.idelem], camefromrow = !0;
                                    }
                                }
                                if (elmmap && o.appvm[elmprehijo.idelem]) {
                                    switch (o.appvm[elmprehijo.idelem].tipo()) {
                                        case o.TE.Lista:
                                            var tl = o.appvm[elmprehijo.idelem].tipolista(), ta = o.appvm[elmprehijo.idelem].tipoasociacion(), valmet = o.appvm[elmprehijo.idelem].valormetadato(),
                                                typemet = ta === "idid" || ta === "iddesc" ? "Valor" : "Nombre", catori = o.datatags.allitemscatalogs[o.appvm[elmprehijo.idelem].fuentedatos() + "|" + o.appvm[elmprehijo.idelem].catalogoorigen()],
                                                chosenitems = _.filter(catori, function (v) { return _.includes(_.map(valmet.toString().split(","), function (vmd) { return vmd.trim(); }), v[typemet]); });
                                            tl !== "checkbox" && (chosenitems = [_.head(chosenitems)]);

                                            camefromrow ? senddata.push({ elementodestino: destin, valor: elmmap.valor(), metadato: elmmap.valormetadato() }) : senddata.push({
                                                elementodestino: destin, valor: _.map(chosenitems, 'Nombre').join(), chosenitems: chosenitems
                                            });
                                            break;
                                        case o.TE.CodigoBarras: case o.TE.Texto: case o.TE.TextArea: case o.TE.Numero: case o.TE.Logico: case o.TE.Fecha: case o.TE.Moneda: case o.TE.Hora: case o.TE.Deslizante: case o.TE.ComboDinamico:
                                            senddata.push({ elementodestino: destin, valor: !elmmap.valor() ? elmmap.valormetadato() : elmmap.valor(), metadato: elmmap.valormetadato() }); break;
                                        case o.TE.RangoFechas: senddata.push({ elementodestino: destin, valor: elmmap.valormetadatorango() }); break;
                                    }
                                }
                            }
                        }
                    }
                    if (!configplant.isLocal) {
                        if (senddata)
                            $.ajax({
                                url: o.datasend.urlGlobal + 'FECapturador.aspx/GuardaDatosFormatoPrevio',
                                data: JSON.stringify({ prefilled: JSON.stringify(senddata) }),
                                type: "POST", async: false, contentType: "application/json; charset=utf-8", dataType: "json",
                                success: function (data) {
                                    delete search_params['dataprevform']; //al parecer algo minimiza la url y es para evitar tener doble url
                                    search_params['DataPrevForm'] = data.d.ReturnedObject.guiddoc;
                                }
                            });
                        configplant.fullscreenformat && (search_params['fsia'] = 1);
                        url = urlParamsToString(url, search_params);
                        url = EncriptaUrl(url);
                        if (configplant.newwindow === !0) return { avoidredirect: !1, func: function () { window.open(url); } };
                        else return { avoidredirect: !0, func: function () { window.location = url; } };
                    }
                    else o.datasend.prevData = senddata, prefilldata(o, o.datasend.prevData);
                }
                return false;
            }
        }
        function callbackGuardar(j) {
            var o = getOpts();
            doCustomPostGuardar(o, j);
            o.wizardtopublish.length > 0 && (o.appvm[o.wizardtopublish]["isafterfinish"](!0), evaluateConditions(o, o.wizardtopublish), o.appvm[o.wizardtopublish]["isafterfinish"](!1));
            setTimeout(function () { showHideLoading(o, false); }, 1000);
        }
        function doCustomPostGuardar(o, j) {
            if (j.Success) {
                o.datasend.docId = j.ReturnedObject.DocID;
                o.datasend.guid = j.ReturnedObject.Guid;
            }
            updateOpts(o, true);
            o.postGuardar && o.postGuardar(j, o.datasend, o.wizardtopublish, o);
        }
        function drawMetadata(o, id, ele, vm) {
            var metadataorig = _.filter(o.datatags.metadatoshijos, { TipoDoc: Number(o.appvm[id].tipodocjson()[vm.guidanexo]) }),
                metadatabase = !o.appvm[id].metadatostipodocjson()[vm.guidanexo] ? {} : o.appvm[id].metadatostipodocjson()[vm.guidanexo]
            $(ele).children().remove(), _.forEach(metadataorig, function (keyme) {
                var inputmeta = $("<tr><td class='position-relative'>" + (keyme.Obligatorio ? "<i class='fas fa-asterisk text-red position-absolute' style='font-size:0.6em;right:calc(5%);'></i>" : "") + keyme.NombreCampo + ":<div class='fieldorig'></div></td></tr>");
                var origval = !metadatabase[keyme.Nombre] ? "" : metadatabase[keyme.Nombre];
                switch (keyme.TipoDatoId) {
                    case 11: //bool
                        inputmeta.find(".fieldorig").append("<input disabled type='checkbox' " + (origval ? "checked" : "") + ">"); break;
                    case 12: //cat
                        var desc = !metadatabase[keyme.Nombre + "_Desc"] ? origval : metadatabase[keyme.Nombre + "_Desc"];
                        inputmeta.find(".fieldorig").append('<input disabled class="form-control input-sm" value="' + desc + '">'); break;
                    default: inputmeta.find(".fieldorig").append('<input disabled class="form-control input-sm" value="' + origval + '">'); break;
                }
                $(ele).append(inputmeta);
            });
            if (metadataorig.length) $(ele).parent().removeClass("hidden");
            else $(ele).parent().addClass("hidden");
        }
        function autoSaveForm() {
            var o = getOpts();
            o.datasend.xml = getXml();
            if (o.datasend.xml) {
                o.datasend.estadoapp = 1, o.datasend.piidtarea = ""; //normal
                var progressattach = $('<div id="pgattach" style="position: fixed; bottom: 0; right: 0; font-size:1.1rem;" class="border p-2 rounded alert-success">\
                                        <span class="mr-2">Guardando borrador...</span><div class="spinner-border text-warning" style="height: 1rem;width: 1rem;" role="status"></div></div>');

                !!o.allattachmentsuploaded && clearInterval(o.allattachmentsuploaded);

                if (_.isEmpty(o.uploadingAttachments)) {
                    o.datasend.guidpdf = o.appvm[o.idPlantilla].mapeopdfligar();
                    o.datasend.anexos = JSON.stringify(o.appvm.listAnexos());
                    o.datasend.tareatransito = "";
                    o.datasend.estadistica = [];
                    $("body").append(progressattach);
                    progressattach.show("slide", { direction: "right" });
                    $.ajax({
                        url: o.datasend.urlGlobal + 'FECapturador.aspx/GuardaFormato', data: JSON.stringify(o.datasend), type: "POST", contentType: "application/json; charset=utf-8",
                        beforeSend: function () { },
                        success: function (j) {
                            j = j.d;
                            if (j.Success)
                                o.datasend.docId = j.ReturnedObject.DocID, o.datasend.guid = j.ReturnedObject.Guid;
                            else {
                                if (j.Mensaje === "nosession") resetSession(o);
                                else toasty('', j.Mensaje, 'error');
                            }
                        }
                    }).done(function () {
                        setTimeout(function () { progressattach.hide("slide", { direction: "right" }, function () { progressattach.remove(); }); }, 2000);
                    });
                }
                else {
                    o.allattachmentsuploaded = setInterval(function () {
                        if (_.isEmpty(o.uploadingAttachments)) {
                            clearInterval(o.allattachmentsuploaded), autoSaveForm();
                        }
                    }, 5000);
                }
            }
        }
        function goPublish(estadoapp) {
            var o = getOpts();
            if (o.cancelsave === true) { o.cancelsave = !1; return; }//por si una regla lo cancelo antes
            o.isSaving = !0, evaluateConditions(o, o.idPlantilla), o.isSaving = !1;
            if (o.cancelsave === !0) { o.cancelsave = !1; return; }//por si al evaluarse se cancela
            o.datasend.xml = getXml(), showHideLoading(o), o.datasend.estadistica = [];
            if (o.appvm[o.idPlantilla].permisoestadisticas() === !0) {
                //nuevo parche de asignacion de nuevas estadisticas a las viejas estadisticas
                _.forEach(o.FEReporteEstadistico.Estadisticas, (v1) => {
                    var idpadre = o.appvm[v1.IdElemento].elementopadre();
                    var seccion = getElementByTypeByParents(o, idpadre, o.TE.Seccion);
                    var pagina = getElementByTypeByParents(o, idpadre, o.TE.Pagina);
                    o.datasend.estadistica.push({
                        Campo: o.appvm[v1.IdElemento].titulo(),
                        CapturaAyuda: false,
                        CapturaError: false,
                        CapturaOk: true,
                        Dispositivo: Environment.os + '-' + Environment.osVersion + '-' + Environment.browser + '-' + Environment.browserVersion,
                        FechaEntrada: moment().format("YYYY/MM/DD HH:mm:ss.SSS"),
                        FechaSalida: moment().format("YYYY/MM/DD HH:mm:ss.SSS"),
                        KeyStroke: v1.Cambios,
                        Latitud: o.coordenadas.lat,
                        Longitud: o.coordenadas.lon,
                        NombrePagina: pagina ? o.appvm[pagina].titulo() : "",
                        NombrePlantilla: o.appvm[o.appvm.idPlantilla()].titulo(),
                        NombreSeccion: seccion ? o.appvm[seccion].titulo() : "",
                        OrdenCampo: o.appvm[v1.IdElemento].ordencampo ? o.appvm[v1.IdElemento].ordencampo() : 0,
                        Resultado: v1.ValorFinal,
                        TipoDispositivo: 5,
                        Usuario: o.datasend.userName,
                        elementoid: v1.IdElemento,
                        Sesion: o.datasend.guid,
                        PlantillaID: 0,
                        PaginaID: pagina ? parseInt(pagina.match(/\d+/g)) : 0,
                        SeccionID: seccion ? parseInt(seccion.match(/\d+/g)) : 0,
                        CampoID: parseInt(v1.IdElemento.match(/\d+/g))
                    });
                });
            }

            if (o.datasend.xml) {
                if (o.wizardtopublish.length && o.appvm[o.wizardtopublish].tipoguardado) {
                    o.datasend.usuarioAsignar = o.appvm[o.wizardtopublish].usuarioasignar(), o.datasend.tipoguardado = o.appvm[o.wizardtopublish].tipoguardado(), o.datasend.piidtarea = o.appvm[o.wizardtopublish].tareafinalizar();
                    switch (o.datasend.tipoguardado) {
                        case "metadatos": case "publicacion": case "remplazametadatosehijos": o.datasend.estadoapp = 2; break;
                        case "borrador": o.datasend.estadoapp = 1; break;
                        default: o.datasend.estadoapp = estadoapp; break;
                    }
                }
                else o.datasend.usuarioAsignar = "", o.datasend.estadoapp = estadoapp, o.datasend.piidtarea = ""; //normal
                saveFormato(o);
            }
        }
        function previewAll(o) {
            if (!o) o = getOpts();
            o.plantilla.empty(), o.tabberpage.empty();
            getScripts(o, function () {
                //se agrega la plantilla al modelo
                createElementToView(o, o.jobj.elemento, {}, !0);

                //Se recorren las paginas para obtener el modelo completo antes del mapping
                var element = {};
                if (o.jobj.elemento.elementos && o.jobj.elemento.elementos.elemento)
                    for (var j = 0; j < o.jobj.elemento.elementos.elemento.length; j++) element = recursiveElementToModel(o.jobj.elemento.elementos.elemento[j], o, element);

                //Se extrae por cada element los diccionarios
                var dicts = {}, ee;
                for (ee in element) {
                    dicts[ee] = { reevaldictionary: element[ee]["reevaldictionary"], dictionarydata: element[ee]["dictionarydata"] };
                    delete element[ee]["reevaldictionary"];
                    delete element[ee]["dictionarydata"];
                }

                ko.mapping.fromJS(element, o.appvm);

                for (ee in dicts) {
                    reevaluateDictionaryData(o, dicts[ee]["reevaldictionary"], dicts[ee]["dictionarydata"], ee);
                    !o.appvm.isEditor() && (initializeAttrByElems(o, ee), checkRuleForElement(o));
                    setCustomSubscribes(o, ee);
                }

                if (o.jobj.elemento.elementos && o.jobj.elemento.elementos.elemento)
                    for (var j = 0; j < o.jobj.elemento.elementos.elemento.length; j++) previewHtml(o.jobj.elemento.elementos.elemento[j], o);

                insertRule([".preview"], "max-width: " + (o.jobj.elemento.atributos.anchocapturador || 80) + "%; margin: auto;");
                insertRule(["div.docelem input.textbox-text"], "font-family: " + o.jobj.elemento.atributos.tipofuente + "; font-size: 1rem; height: 31px; padding: 0px .75rem");
                insertRule([".combobox-item"], "font-family: " + o.jobj.elemento.atributos.tipofuente + "; font-size: 1rem;  padding: 0px .75rem");
                o.jobj.elemento.atributos.pedircoordenadasalcargar === true && obtenerCoordenadas(o);
                plantillaIsLoaded(o);
                o.FEReporteEstadistico.FechaComienzo = getTicksOfTime(new Date());
            });
        }
        function previewHtml(jelem, o) {
            var elemid = jelem["@idelemento"], elemDom = $("<!-- ko --><!-- /ko -->");
            var parent = findMethodByElementType(o, jelem, o.methodType.getParent, []);
            findMethodByElementType(o, jelem, o.methodType.drawHtml, [parent, elemDom, elemid, true]);
        }
        function saveFormato(o) {
            var progressattach = $('<div id="pgattach" style="bottom:0; right:0;font-size:1.1em" class="bg-white border p-2 position-fixed rounded">\
                                        <span class="mr-3">Cargando anexos...</span>\
                                        <div class="spinner-grow text-danger" role="status" style="width:1.1rem;height:1.1rem;"><span class="sr-only">Cargando...</span></div>\
                                        <div class="spinner-grow text-warning" role="status" style="width:1.1rem;height:1.1rem;"><span class="sr-only">Cargando...</span></div>\
                                        <div class="spinner-grow text-info" role="status" style="width:1.1rem;height:1.1rem;"><span class="sr-only">Cargando...</span></div></div>');
            !!o.allattachmentsuploaded && clearInterval(o.allattachmentsuploaded);
            progressattach.remove();
            if (_.isEmpty(o.uploadingAttachments)) {
                o.preGuardar && o.preGuardar(o.datasend, o.appvm);
                if (o.preGuardar) o.datasend.xml = getXml();
                if (!!o.metadatamissing && o.metadatamissing.length > 0) {
                    toasty('', 'Verifique los elementos "' + o.metadatamissing.join(', ') + '" tienen metadatos obligatorios faltantes.'), showHideLoading(o, !1);
                    return;
                }
                o.datasend.guidpdf = o.appvm[o.idPlantilla].mapeopdfligar();
                o.datasend.anexos = JSON.stringify(o.appvm.listAnexos());
                o.FEReporteEstadistico.FechaTermino = getTicksOfTime(new Date());
                o.FEReporteEstadistico.FechaPlantilla = o.appvm[o.idPlantilla].lastupdate();
                o.FEReporteEstadistico.VersionPlantilla = o.version;
                o.datasend.tareatransito = JSON.stringify(o.FEReporteEstadistico);
                showHideLoading(o, !0, "Enviando el Formato al servidor, por favor espere...");
                $.ajax({
                    url: o.datasend.urlGlobal + 'FECapturador.aspx/GuardaFormato', data: JSON.stringify(o.datasend), type: "POST", contentType: "application/json; charset=utf-8",
                    success: function (j) {
                        showHideLoading(o, !1);
                        j = j.d;
                        if (!j.Success && j.Mensaje === "nosession") resetSession(o);
                        else callbackGuardar(j);
                    },
                    error: function (e) { errorFormElec(o, e), showHideLoading(o, !1); }
                });
            }
            else {
                toasty('', 'Espere un momento mientras los anexos se cargan para guardar el formato.', 'info');
                $("body").append(progressattach);
                o.allattachmentsuploaded = setInterval(function () {
                    if (_.isEmpty(o.uploadingAttachments)) {
                        clearInterval(o.allattachmentsuploaded);
                        $("body #pgattach").remove();
                        toasty('', 'Todos los anexos han sido cargados. Puede continuar con el guardado del formato', 'exito');
                    }
                }, 5000);
                showHideLoading(o, !1);
            }
        }
        function dateToUniversal(o, id, text) {
            if (!text || !text.length) return "";
            var sep = o.appvm[id].separador();
            sep = sep.length ? sep === "." ? "\\." : sep : "/"; //en caso de que el separador sea en blanco
            text = text.replace(new RegExp(sep + "+", "g"), "/");
            var textsplit = text.split("/"); if (textsplit.length !== 3) return text;
            var origfoma = o.appvm[id].formatoObject.Nombre().split("/");
            textsplit[0] = textsplit[0].length === 1 ? "0" + textsplit[0] : textsplit[0];
            textsplit[1] = textsplit[1].length === 1 ? "0" + textsplit[1] : textsplit[1];
            textsplit[2] = textsplit[2].length === 1 ? "0" + textsplit[2] : textsplit[2];
            return (origfoma[0].toLowerCase().indexOf("y") !== -1 ? textsplit[0] : origfoma[1].toLowerCase().indexOf("y") !== -1 ? textsplit[1] : textsplit[2]) +
                (origfoma[0].toLowerCase().indexOf("m") !== -1 ? textsplit[0] : origfoma[1].toLowerCase().indexOf("m") !== -1 ? textsplit[1] : textsplit[2]) +
                (origfoma[0].toLowerCase().indexOf("d") !== -1 ? textsplit[0] : origfoma[1].toLowerCase().indexOf("d") !== -1 ? textsplit[1] : textsplit[2]);
        }
        function timeToUniversal(o, id, text) {
            if (!text || !text.length) return "";
            var time = o.appvm[id].horaObject.Valor();
            if (time === "h:i a" || time === "h:i p") {
                var h = text.split(":");
                if (h[0]) {
                    var hh = parseInt(h[0]);
                    var mm = parseInt(h[1].match(/\d+/g));
                    var am = text.toLowerCase().indexOf("p") > 0 ? "pm" : "am";
                    text = moment("20000101 " + hh + ":" + mm + am, "YYYYMMDD h:mm a").format("HH:mm");
                }
            }
            return text;
        }
        function showElementLoading(o, s, id, text) {
            $(`#loader${id}`).remove();
            if (s === !0) //mostrar loading especifico en cada elemento
                $("#" + id).append(`<div id="loader${id}" class="in text-center row" style="z-index: 60; position: absolute; height: 100%; width: 100%; top: 0; left: 0; opacity: 0.7; background: #ddd; justify-content: center; align-items: center;">
                   <div class="col-12">
                        <i class="fas fa-cog fa-spin" style="font-size: 2rem; color: #000;"></i>
                        <p style="font-size: 1.4rem; color: #000;">${text}</p>
                   </div>
                </div>`), o.appvm[id].finishloading(!1);
            else o.appvm[id].finishloading(!0);
        }
        function showElementsLogs() {
            if (window.countclickConsolaFE && window.countclickConsolaFE >= 10) {
                window.countclickConsolaFE = 0;
                var o = getOpts();
                var string = JSON.stringify(o.changeLogs), blob = new Blob([string], { type: "text/plain;charset=utf-8" }), dat = new Date();
                saveAs(blob, "ConsolaFE" + dat.getFullYear() + (dat.getMonth() + 1).toString().padStart(2, '0') + dat.getDate().toString().padStart(2, '0') + dat.getHours().toString().padStart(2, '0') + dat.getHours().toString().padStart(2, '0') + dat.getMinutes().toString().padStart(2, '0') + dat.getSeconds().toString().padStart(2, '0') + ".json");
            }
            else {
                if (!window.countclickConsolaFE) window.countclickConsolaFE = 1;
                else window.countclickConsolaFE++;
            }
        }
        function subscribeTemporalOnFinishLoad(o, id, callback) {
            var temps = () => { };
            temps = o.appvm[id].finishloading.subscribe((nv) => { if (nv === !0) callback && (callback(), temps.dispose()); });
        }
        function universalToDate(o, id, text) {
            if (!text || !text.length) return "";
            if (text.length !== 8) return text;
            var sep = o.appvm[id].separador(), textsplit = [], origfoma = o.appvm[id].formatoObject.Nombre().split("/");
            sep = sep.length ? sep : "/"; //en caso de que el separador sea en blanco
            textsplit[0] = text.substring(0, 4), textsplit[1] = text.substring(4, 6), textsplit[2] = text.substring(6, 8);
            return (origfoma[0].toLowerCase().indexOf("y") !== -1 ? textsplit[0] : origfoma[1].toLowerCase().indexOf("y") !== -1 ? textsplit[1] : textsplit[2]) + sep +
                (origfoma[0].toLowerCase().indexOf("m") !== -1 ? textsplit[0] : origfoma[1].toLowerCase().indexOf("m") !== -1 ? textsplit[1] : textsplit[2]) + sep +
                (origfoma[0].toLowerCase().indexOf("d") !== -1 ? textsplit[0] : origfoma[1].toLowerCase().indexOf("d") !== -1 ? textsplit[1] : textsplit[2]);
        }
        function uploadAnexoAndSaveBorrador(o, id, cancelreplacement, quantupload, ival, docidanexoreplace) {
            var filteredlist = [];
            if (cancelreplacement) {
                var elemAnexR = _.filter(o.appvm.listAnexos(), { ElementoId: id, Reemplazado: !0 }), elemAnexId = _.filter(o.appvm.listAnexos(), { ElementoId: id });
                for (var elemAnex = 0; elemAnex < elemAnexR.length; elemAnex++) {
                    var fel = _.find(elemAnexId, function (vel) { return vel.FileName.indexOf(elemAnexR[elemAnex].Guid + "_" + id + "R" + elemAnexR[elemAnex].DocID) === 0; });
                    if (!fel)
                        filteredlist.push(elemAnexR[elemAnex]);
                }
            }
            else filteredlist = _.filter(o.appvm.listAnexos(), function (elmanex) { return elmanex.ElementoId === id && elmanex.Completado === undefined; });
            quantupload = quantupload || filteredlist.length, ival = ival ? ival + 1 : 1;
            var filteredelem = _.first(filteredlist);
            if (filteredelem) {
                console.log("subiendo anexo " + filteredelem.FileName);
                showElementLoading(o, !0, id, "Cargando archivo " + ival + " de " + quantupload + " ...");
                o.datasend.xml = getXml(), o.datasend.estadoapp = 1, o.datasend.guidpdf = o.appvm[o.idPlantilla].mapeopdfligar();
                o.uploadingAttachments[id] = true;
                //se busca reemplazo
                if (cancelreplacement)
                    filteredelem.Reemplazado = !1, o.datasend.anexos = JSON.stringify([filteredelem]);
                if (o.appvm[id].tipo() !== o.TE.Documento && o.appvm[id].tipo() !== o.TE.FirmaFAD) {
                    if (!cancelreplacement)
                        o.datasend.anexos = JSON.stringify(_.filter(o.appvm.listAnexos(), function (elmanex) { return elmanex.ElementoId === id && (elmanex.Completado === undefined || elmanex.Reemplazado === !0); }));
                }
                else {
                    if (docidanexoreplace)
                        o.datasend.anexos = JSON.stringify(_.filter(o.appvm.listAnexos(), function (elmanex) { return elmanex.ElementoId === id && (elmanex.Completado === undefined || elmanex.Reemplazado === !0 || elmanex.DocID === docidanexoreplace); }));
                    else o.datasend.anexos = JSON.stringify([filteredelem]);
                }
                //Se envia formato para generar estadisticas con cada anexo
                o.FEReporteEstadistico.FechaTermino = getTicksOfTime(new Date());
                o.FEReporteEstadistico.FechaPlantilla = o.appvm[o.idPlantilla].lastupdate();
                o.FEReporteEstadistico.VersionPlantilla = o.version;
                o.datasend.tareatransito = JSON.stringify(o.FEReporteEstadistico);
                o.datasend.estadistica = [];
                $.ajax({
                    url: o.datasend.urlGlobal + 'FECapturador.aspx/GuardaFormato', data: JSON.stringify(o.datasend), type: "POST", contentType: "application/json; charset=utf-8",
                    beforeSend: function () { },
                    success: function (j) {
                        j = j.d;
                        if (j.Success) {
                            for (var k = 0; k < j.ReturnedObject.Anexos.length; k++)
                                for (var i = 0; i < o.appvm.listAnexos().length; i++) {
                                    if (o.appvm.listAnexos()[i].FileName === j.ReturnedObject.Anexos[k].FileName) {
                                        var notexists = o.appvm.listAnexos()[i].GuidAnexo === undefined, //si aun no conoce guidanexo, significa que apenas fue guardado
                                            thumbs = _.includes(["pdf", ".pdf", "PDF", ".PDF"], o.appvm.listAnexos()[i].Extension) && j.ReturnedObject.thumbs[o.appvm.listAnexos()[i].FileName] ? j.ReturnedObject.thumbs[o.appvm.listAnexos()[i].FileName] : o.appvm.listAnexos()[i].Datos;
                                        o.appvm.listAnexos()[i] = j.ReturnedObject.Anexos[k];
                                        (notexists || cancelreplacement) && updateAnexo(o, j.ReturnedObject.Anexos[k], !1, thumbs, docidanexoreplace);
                                    }
                                }
                            toasty('', 'Archivo importado', 'exito'), o.datasend.anexos = null, updateOpts(o, true);
                        } else {
                            if (j.Mensaje === "nosession") resetSession(o);
                            else toasty('', j.Mensaje, 'error');
                        }
                        delete o.uploadingAttachments[id];
                    },
                    error: function (j) {
                        console.error(JSON.stringify(j)), delete o.uploadingAttachments[id],
                            _.remove(o.appvm.listAnexos(), function (erratt) { return erratt.ElementoId === id && erratt.Datos !== ""; });
                    }
                }).done(function (j) { showElementLoading(o, !1, id), quantupload >= ival && uploadAnexoAndSaveBorrador(o, id, cancelreplacement, quantupload, ival, docidanexoreplace); });
            }
        }
        function validateAllTabs() {
            var o = getOpts();
            o.allvalid = !0, o.needValidate = !0, o.tabToValidate = 0, updateOpts(o, !0);
            if (o.cancelvalidate === !0) { o.cancelvalidate = !1, o.allvalid = !1, o.needValidate = !1, updateOpts(o, !0), goPublish(2); return; }//por si una regla lo cancelo antes
            validateNextTab(o);
        }
        function validateNextTab(o) {
            if (o.wizardtopublish.length && o.appvm[o.wizardtopublish].elementoavalidar && !_.isEmpty(o.appvm[o.wizardtopublish].elementoavalidar())) {
                //validacion por un solo elemento
                if (validateCustomElements(o, o.appvm[o.wizardtopublish].elementoavalidar()) === !0)
                    o.allvalid = !1, o.needValidate = !1, updateOpts(o, !0), goPublish(2);
                else
                    o.allvalid = !1, o.needValidate = !1, o.tabToValidate = 0, o.cancelvalidate = !1, o.cancelsave = !1, updateOpts(o, !0);
            } else { //ya no existe la validacion de todas las paginas y simplemente se manda a publicar
                o.allvalid = !1, o.needValidate = !1, updateOpts(o, !0), goPublish(2);
            }
        }
        function validateCustomElements(o, pag, istable, withoutlabel) {
            var res = !0;
            for (var elem in o.appvm)
                if (elem.indexOf("formElec_element") >= 0 && (istable || o.appvm[elem].elementopadre().length && o.appvm[o.appvm[elem].elementopadre()].tipo !== o.TE.Tabla) &&
                    (o.appvm[elem].elementopadre() === pag || getElementByTypeByParents(o, elem, o.TE.Pagina) === pag))
                    validateControl(o, elem, !1, withoutlabel) === !1 && (res = !1);//solo apagar
            if (!res) toasty("Favor de reviar los campos obligatorios");
            return res;
        }
        function validateControl(o, id, override, withoutlabel) {
            var res = !0, error = "", max, min, regex, regerror, re, lmax, lmin, valor;
            o.appvm[id].validationerror("");
            if (override || !o.appvm.isEditor() && $("div#" + id).is(":visible")) {
                switch (o.appvm[id].tipo()) {
                    case o.TE.CodigoQR: case o.TE.CodigoBarras: case o.TE.Password: case o.TE.TextArea: case o.TE.Texto: case o.TE.Fecha: case o.TE.RangoFechas: case o.TE.Hora:
                        if (o.appvm[id].expresionregular && o.appvm[id].expresionregular().length)
                            try {
                                regex = o.appvm[id].expresionregular() === "*" ? "\\w" : o.appvm[id].expresionregular(), re = new RegExp(regex),
                                    regerror = o.appvm[id].regexrerrormsg().length ? o.appvm[id].regexrerrormsg() : "Debe cumplir con lo siguiente: " + o.appvm[id].mascara();
                            } catch (r) {
                                regerror = "La expresion regular " + regex + " no es valida del elemento " + o.appvm[id].titulo(), console.log(regerror);
                            }
                        lmax = o.appvm[id].longitudmaxima ? _.toNumber(o.appvm[id].longitudmaxima()) || 0 : 0,
                            lmin = o.appvm[id].longitudminima ? _.toNumber(o.appvm[id].longitudminima()) || 0 : 0,
                            valor = o.appvm[id].valor ? o.appvm[id].valor() : o.appvm[id].valormetadatorango(), valor = valor === undefined || valor === null ? "" : valor.toString();
                        !_.isEmpty(valor) && re && !re.test(valor) && (res = !1, error = regerror);
                        o.appvm[id].requerido() === !0 && (valor === "" ? (res = !1, error = "El campo es requerido") :
                            (lmin > 0 && valor.length < lmin && (res = !1, error = "El m&iacute;nimo de caracteres es: " + lmin),
                                lmax > 0 && valor.length > lmax && (res = !1, error = error.length ? error + " y el " : "El ", error = "m&aacute;ximo de caracteres es: " + lmax)));
                        break;
                    case o.TE.Lista:
                        switch (o.appvm[id].tipolista()) {
                            case "radio":
                                o.appvm[id].requerido() === !0 && _.isEmpty(o.appvm[id].chosenitems()) && (res = !1, error = "El campo es requerido");
                                break;
                            case "combo":
                                o.appvm[id].requerido() === !0 && (o.appvm[id].optionselected() === undefined || o.appvm[id].optionselected() === "") && (res = !1, error = "El campo es requerido");
                                break;
                            case "checkbox":
                                var cantcat = o.appvm[id].catalogodestino().length;
                                o.appvm[id].requerido() === !0 &&
                                    (max = o.appvm[id].todasopcionesrequeridas() ? cantcat : _.toNumber(o.appvm[id].maxopcionesseleccionar()) || 0,
                                        min = o.appvm[id].todasopcionesrequeridas() ? cantcat : _.toNumber(o.appvm[id].minopcionesseleccionar()) || 0,
                                        min > 0 && o.appvm[id].chosenitems().length < min && (res = !1, error = "El m&iacute;nimo de opciones es: " + min),
                                        max > 0 && o.appvm[id].chosenitems().length > max && (res = !1, error = error.length ? error + " y el " : "El ", error = "m&aacute;ximo de opciones es: " + max));
                                break;
                        }
                        break;
                    case o.TE.Logico:
                        o.appvm[id].requerido() === !0 && o.appvm[id].valor() === !1 && (res = !1, error = "El campo es requerido");
                        break;
                    case o.TE.Moneda: case o.TE.Numero: case o.TE.Deslizante:
                        max = _.toNumber(o.appvm[id].numeromaximo()) || 0, min = _.toNumber(o.appvm[id].numerominimo()) || 0,
                            (o.appvm[id].requerido() === !0 || o.appvm[id].valor() !== "") && (o.appvm[id].valor() === "" ? (res = !1, error = "El campo es requerido") :
                                (min > 0 && o.appvm[id].valormetadato() < min && (res = !1, error = "El n&uacute;mero m&iacute;nimo es: " + min),
                                    max > 0 && o.appvm[id].valormetadato() > max && (res = !1, error = error.length ? error + " y el " : "El ", error = "n&uacute;mero m&aacute;ximo es: " + max)));
                        break;
                    case o.TE.Tabla:
                        for (var f = 0; f < o.appvm[id].valorjson().length; f++)
                            for (var sub in o.appvm[id].valorjson()[f])
                                sub.indexOf("formElec_element") >= 0 && o.appvm[id].valorjson()[f][sub].haserror() && (res = !1, error = "Revise los registros marcados");
                        o.appvm[id].requerido() === !0 && (max = _.toNumber(o.appvm[id].filasmax()) || 0, min = _.toNumber(o.appvm[id].filasmin()) || 0,
                            min > 0 && o.appvm[id].valorjson().length < min && (res = !1, error = "El m&iacute;nimo de filas es: " + min),
                            max > 0 && o.appvm[id].valorjson().length > max && (res = !1, error = error.length ? error + " y el " : "El ", error = "m&iacute;nimo de filas es: " + min));
                        break;
                    case o.TE.Audio: case o.TE.FirmaFAD: case o.TE.Imagen: case o.TE.Video: case o.TE.Mapa:
                        o.appvm[id].requerido() === !0 && o.appvm[id].nombrearchivo() === "" && (res = !1, error = "El campo es requerido");
                        break;
                    case o.TE.Documento:
                        if (o.appvm[id].requerido() === !0) {
                            o.appvm[id].anexo().length === 0 && (res = !1, error = "El campo es requerido"),
                                o.appvm[id].minimodocumentos() > o.appvm[id].anexo().length && (res = !1, error = "Debe subir por lo menos " + o.appvm[id].minimodocumentos() + " documentos.");
                            var keymaxmin = _.keys(o.appvm[id].tipificacionpermitida()), keysupload = _.groupBy(o.appvm[id].tipodocjson()), i = 0;
                            while (res && i <= keymaxmin.length - 1) {
                                var tipodoc = _.find(o.datatags.tipodochijos, function (elm) { return elm.Valor.toString() === keymaxmin[i].toString().split("tipodoc_")[1].toString(); });
                                var configtipo = o.appvm[id].tipificacionpermitida()[keymaxmin[i]], elemupload = keysupload[keymaxmin[i].toString().split("tipodoc_")[1]];
                                elemupload = elemupload || [];
                                !configtipo.enabled && elemupload.length > 0 && (res = !1, error = "No tiene permiso para tipificar tipos de documento " + tipodoc.Nombre + ".");
                                configtipo.enabled && configtipo.max > 0 && elemupload.length > configtipo.max && (res = !1, error = "El m&aacute;ximo de documentos de tipo " + tipodoc.Nombre + " es de " + configtipo.max + ".");
                                configtipo.enabled && elemupload.length < configtipo.min && (res = !1, error = "El m&iacute;nimo de documentos de tipo " + tipodoc.Nombre + " es de " + configtipo.min + ".");
                                i++;
                            }
                        }
                        //validacion de metadatos por cada anexo
                        o.appvm[id].errormetadatos("");
                        _.forEach(o.appvm[id].anexo(), function (ane) {
                            var metadataorig = _.filter(o.datatags.metadatoshijos, { TipoDoc: Number(o.appvm[id].tipodocjson()[ane.guidanexo]) }),
                                metadatabase = !o.appvm[id].metadatostipodocjson()[ane.guidanexo] ? {} : o.appvm[id].metadatostipodocjson()[ane.guidanexo];
                            if (metadataorig.length > 0)//Si hay metadatos
                            {
                                _.forEach(metadataorig, function (met, ind) {
                                    if (met.Obligatorio === !0)//Solo interesa los obligatorios
                                    {
                                        var origval = !metadatabase[met.Nombre] ? "" : metadatabase[met.Nombre];
                                        if (_.isEmpty(origval)) //se agrega mensaje al elemento documento para resaltar error
                                        {
                                            var msj = "";
                                            if (!_.isEmpty(o.appvm[id].errormetadatos())) msj += "<br/>";
                                            msj += "El documento " + ane.origname + " tiene el campo " + met.Nombre + " como obligatorio y no se capturo.";
                                            o.appvm[id].errormetadatos(o.appvm[id].errormetadatos() + msj), res = !1;
                                        }
                                    }
                                });
                            }
                        });
                        break;
                    case o.TE.HuellaDigital:
                        var numhu = parseInt(o.appvm[id].cantidadhuellas()); numhu = isNaN(numhu) ? 0 : numhu;
                        o.appvm[id].requerido() === !0 && numhu <= 0 && (res = !1, error = "Es necesario capturar alguna huella");
                        break;
                    case o.TE.Georeferencia:
                        o.appvm[id].requerido() === !0 && o.appvm[id].valor() === "" && (res = !1, error = "Es necesario obtener sus coordenadas");
                        break;
                    case o.TE.ComboDinamico:
                        o.appvm[id].requerido() && !o.appvm[id].valormetadato() && (res = !1, error = "Es necesario seleccionar un valor");
                        break;
                    case o.TE.MarcadoDocumentos:
                        if (o.appvm[id].requerido()) {
                            var data = _.filter(o.appvm[id].catalogodestino(), { EsRequerido: !0 });
                            var chosen = o.appvm[id].chosenitems();
                            var notUp = _.filter(data, function (dc) { return _.filter(chosen, { Valor: dc.Valor }).length === 0; });
                            notUp.length > 0 && (res = !1, error = "Existen archivos obligatorios sin subir");
                        }
                        break;
                    case o.TE.Wizard:
                        o.appvm[id].requerido() && !o.appvm[id].clicked() && (res = !1, error = "Es necesario dar clic en " + o.appvm[id].textofinalizar());
                        break;
                }
            }
            !withoutlabel && o.appvm[id].validationerror(error), o.appvm[id].haserror(!res);
            return res;
        }
        function verJsonElemento(o, id) {
            o = o || getOpts(), id = id || o.elementoatributosdibujar || "";
            !_.isEmpty(id) && Alerta(o.appvm[id].titulo(), '<textarea rows="16" style="width: 100%; border: 0px;">' + JSON.stringify(ko.mapping.toJS(o.appvm[id]), null, '\t') + '</textarea>');
        }
        function xmlToJson(o) {
            var json = {};
            o.metadatamissing = [];
            for (var id in o.appvm)
                if (id.indexOf("formElec_element") > -1) {
                    var tipo = o.appvm[id].tipo();
                    if (_.includes([o.TE.Pagina, o.TE.Seccion, o.TE.Tabber, o.TE.Boton, o.TE.Leyenda], tipo)) continue;
                    if (tipo === o.TE.Plantilla) {
                        let mappingFiles = [];
                        if (o.appvm[id].pdfmapping()) {
                            _.forEach(_.keys(o.appvm[id].pdfmapping()), function (idmap) {
                                o.appvm[id].pdfmapping()[idmap].enabled && mappingFiles.push(idmap);
                            });
                            json["mappingfiles"] = { k: mappingFiles.join(",") };
                        }
                    }
                    else if (_.includes([o.TE.Moneda, o.TE.Fecha, o.TE.Hora, o.TE.Lista], tipo))
                        json[id] = { valormetadato: o.appvm[id].valormetadato(), valor: !o.appvm[id].valor() ? "" : o.appvm[id].valor() };
                    else if (tipo === o.TE.RangoFechas)
                        json[id] = {
                            valormetadatoinicial: dateToUniversal(o, id, o.appvm[id].valorinicial()), valorinicial: o.appvm[id].valorinicial(),
                            valormetadatofinal: dateToUniversal(o, id, o.appvm[id].valorfinal()), valorfinal: o.appvm[id].valorfinal(),
                            valormetadatorango: o.appvm[id].valormetadatorango()
                        };
                    else if (tipo === o.TE.Logico)
                        json[id] = { valormetadato: o.appvm[id].valor() === true ? "1" : "0", valor: o.appvm[id].valor() };
                    else if (tipo === o.TE.Tabla)
                        json[id] = { valormetadato: o.appvm[id].valor(), valor: o.appvm[id].valor() };
                    else if (_.includes([o.TE.Video, o.TE.Imagen, o.TE.Audio, o.TE.HuellaDigital, o.TE.PDFOCR], tipo))
                        json[id] = { tipodoc: o.appvm[id].tipodoc() };
                    else if (_.includes([o.TE.FirmaFAD], tipo))
                        json[id] = {
                            tipodoc: o.appvm[id].tipodoc(), georeferencia: o.appvm[id].georeferencia(),
                            dispositivo: o.appvm[id].dispositivo(), nombrefirmante: o.appvm[id].nombrefirmante(),
                            acuerdofirma: o.appvm[id].acuerdofirma(), fecha: o.appvm[id].fecha(),
                            hash: o.appvm[id].hash(), valormetadato: o.appvm[id].valormetadato(),
                            guidtimestamp: o.appvm[id].guidtimestamp()
                        };
                    else if (tipo === o.TE.Georeferencia)
                        json[id] = { tipodoc: o.appvm[id].tipodoc(), valormetadato: o.appvm[id].valormetadato(), valor: o.appvm[id].valor() };
                    else if (tipo === o.TE.Documento) {
                        _.forEach(o.appvm[id].anexo(), function (anex) { anex.metadataisrequired && !_.find(o.metadatamissing, o.appvm[id].titulo()) && o.metadatamissing.push(o.appvm[id].titulo()); });
                        json[id] = { tipodoc: o.appvm[id].tipodoc(), metadatostipodoc: o.appvm[id].metadatostipodoc(), nombrearchivo: o.appvm[id].nombrearchivo() };
                    }
                    else if (tipo === o.TE.ComboBoxTemporal)
                        json[id] = { valormetadato: o.appvm[id].valormetadato(), valor: o.appvm[id].valor(), catalogodestino: JSON.stringify(o.appvm[id].catalogodestino()) };
                    else if (_.includes([o.TE.Texto, o.TE.ComboDinamico], tipo))
                        json[id] = { valormetadato: o.appvm[id].valormetadato(), valor: o.appvm[id].valor() };
                    else if (tipo === o.TE.Wizard)
                        json[id] = { clicked: o.appvm[id].clicked(), usuarioasignar: o.appvm[id].usuarioasignar() };
                    else
                        o.appvm[id].valor && o.appvm[o.appvm[id].elementopadre()].tipo() !== o.TE.Tabla && (json[id] = { valormetadato: o.appvm[id].valor(), valor: o.appvm[id].valor() });
                }
            return JSON.stringify(json);
        }



        //Ejecucion de ServicioGenericoString con servicios V2
        function sendServiceRequest2(o, oriObj, sbObj) {
            if (!!oriObj.response.zexecutekey && !!oriObj.response.zexecutetimenumber && !!oriObj.response.zexecutetimetype
                && oriObj.response.zexecutekey > 0 && oriObj.response.zexecutetimenumber > 0) {
                if (!oriObj.response.execopts) oriObj.response.execopts = { datettimeexecution: new Date(), numberexecution: 1 };
                else {
                    var mins = oriObj.response.zexecutetimetype.indexOf("min") >= 0 ? 1 : oriObj.response.zexecutetimetype.indexOf("hrs") >= 0 ? 60 : 1440,
                        totalmins = mins * oriObj.response.zexecutetimenumber, exetime = new Date(oriObj.response.execopts.datettimeexecution),
                        execmins = Math.abs(new Date() - exetime) / 60000;
                    execmins >= totalmins ? oriObj.response.execopts = { datettimeexecution: new Date(), numberexecution: 1 } : oriObj.response.execopts.numberexecution += 1;
                    if (oriObj.response.execopts.numberexecution > oriObj.response.zexecutekey) {
                        toasty('', 'Se ha llegado al l&iacute;mite de ejecuci&oacute;n del servicio: ' + oriObj.customname, 'error');
                        return;
                    }
                }
            }
            var clonedata = _.clone(o.datasend);
            clonedata["xml"] && delete clonedata["xml"];
            clonedata["estadistica"] && delete clonedata["estadistica"];
            clonedata["prevData"] && delete clonedata["prevData"];
            delete sbObj.response; //se borra el response ya que el servicio llena el response
            $.ajax({
                url: o.datasend.urlGlobal + "FECapturador.aspx/EjecutaServicio",
                data: JSON.stringify({ json: JSON.stringify(sbObj), datasend: JSON.stringify(clonedata) }),
                start_time: new Date().getTime(),
                success: function (j) {
                    var exeRes = function () {
                        j = j.d, o = getOpts();
                        let mesj = `${(sbObj.customname || oriObj.initialmethod)} ${(j.response.servicesuccess === !0 ? (_.isEmpty(j.response.servicemessage) ? "terminó exitosamente" : j.response.servicemessage) : (_.isEmpty(j.response.servicemessage) ? "fallo al ejecutar" : j.response.servicemessage))}`;
                        console.log(mesj);
                        addHistoriaReporteEstadistico(o, mesj, o.CategoriaReporteEstadistico.Servicio);
                        terminaServicio2(oriObj, j, o), updateOpts(o, true);
                    };
                    var resTime = 1050 - (new Date().getTime() - this.start_time);
                    console.log("Service LTime:" + resTime);
                    setTimeout(function (s) { exeRes(); }, Math.max(resTime, 0));
                }
            });
        }
        function parseJsonParameters(o, id, tipoparam) {
            return ko.utils.parseJson(o.appvm[id][tipoparam]()) || {};
        }
        function terminaServicio2(oriObj, j, o) {
            if (j.response.success) {
                var ruletype = j.response.servicesuccess ? "rulesuccess" : "ruleerror";

                if (j.response.servicesuccess) {
                    if (j.pout.length) {
                        for (var w = 0; w < j.pout.length; w++) {
                            var ide = oriObj.pout["order_" + j.pout[w].order].idelem || "";
                            if (o.appvm[ide]) {
                                if (o.appvm[ide].tipo() === o.TE.ComboBoxTemporal) o.appvm[ide].catalogotemp(j.pout[w].value);
                                else if (o.appvm[ide].tipo() === o.TE.Lista) {
                                    var idselem = !j.pout[w].value ? [] : j.pout[w].value.toString().split(","), selopts = [];
                                    idselem.length > 0 && (selopts = _.filter(o.datatags.allitemscatalogs[o.appvm[ide].fuentedatos() + "|" + o.appvm[ide].catalogoorigen()], function (elm) {
                                        return _.includes(idselem, elm.Valor);
                                    }));
                                    o.appvm[ide].chosenitemsRule(o.appvm[ide].tipolista() === "checkbox" ? selopts : selopts[0]);
                                    if (o.appvm[ide].tipolista() === "combo" && !!selopts[0]) o.appvm[ide].optionselectedRule(selopts[0].Valor);
                                }
                                else if (o.appvm[ide].tipo() === o.TE.Tabla) {
                                    var mat = !_.isEmpty(j.pout[w].value) ? JSON.parse(j.pout[w].value) : [];
                                    actionRowTable(ide, ['serviceimport', mat]);
                                }
                                else if (o.appvm[ide].tipo() === o.TE.Texto) o.appvm[ide].valormetadato(j.pout[w].value);
                                else o.appvm[ide].valor && o.appvm[ide].valor(j.pout[w].value);
                            }
                        }
                    }
                    if (j.data) {
                        extractOutterDataForService2(j, o);
                    }
                }
                setTimeout(function () {
                    globalThis.console.log("Desface terminado"), evaluateOneRule(o, oriObj.response[ruletype], oriObj.response.evaluaterules);
                }, oriObj.response.waittofinish);
                if (oriObj.response.showmessage && j.response.servicemessage && j.response.servicemessage.length > 0) {
                    oriObj.response.messagetype.indexOf("popup") >= 0 ? Modal("", j.response.servicemessage, "", j.response.servicesuccess ? 'exito' : 'error') :
                        toasty('', j.response.servicemessage, j.response.servicesuccess ? 'exito' : 'error');
                }
            }
            else toasty('Ocurrio un problema', j.response.servicemessage, 'error'), evaluateOneRule(o, oriObj.response.ruleerror, oriObj.response.evaluaterules);
        }



        //Acciones de las reglas
        function showSectionAsModal(id, hide) {
            var o = getOpts();
            if (hide) {
                $('#modalsection').remove(), o.appvm.modalIsShown(!1), !o.appvm[id].visible() && (o.appvm[id].visible(o.appvm[id].visible()), $('#' + id).show());
                return;
            }
            var intervalsection = setInterval(function () {
                if (o.appvm[id].elementrendered()) {
                    clearInterval(intervalsection);
                    var visiblebase = o.appvm[id].visible(), clone, appendclone = function appendclone(idel) {
                        if (o.appvm[idel])
                            if (o.appvm[idel].tipo() === o.TE.Seccion)
                                _.forEach(o.plantilla.find('div [id="' + idel + '"]').children().contents(), function (v) {
                                    v.nodeType === 8 && (clone = $("<!-- " + v.nodeValue + " --><!-- /ko -->"),
                                        $('#modalsection div [id="' + idel + '"]').find('.section-body').append(clone), ko.applyBindings(o.appvm, clone[0]),
                                        v.nextSibling && appendclone(v.nextSibling.id));
                                });
                            else if (o.appvm[idel].tipo() === o.TE.Mapa) {
                                var map = o.plantilla.find('div [id="' + idel + '"]').find('.map').children();
                                !!map && $('#modalsection div [id="' + idel + '"]').find('.map').append(map);
                            }
                            else if (o.appvm[idel].tipo() === o.TE.Documento)
                                $('#modalsection div[id="' + idel + 'carousel"]').attr("id", idel + "carouselcopy"),
                                    $('#modalsection a[href="#' + idel + 'carousel"]').attr("href", "#" + idel + "carouselcopy");
                            else return;
                    };
                    o.appvm.modalIsShown(!0);
                    !visiblebase && (o.appvm[id].visible(!visiblebase), $('#' + id).hide());
                    o.modalsection = '<div class="modal" id="modalsection" style="display:block">\
                                            <div class="modal-dialog modal-lg modal-dialog-centered">\
                                                <div class="modal-content rounded bg-transparent">\
                                                    <div class="modal-header no-padding bg-transparent flex-row-reverse">\
                                                        <i class="fas fa-times text-white p-1" style="cursor:pointer;font-size:20px;"></i>\
                                                    </div>\
                                                    <div id="modalB" style="max-height:80vh; overflow:auto;"></div>\
                                                </div>\
                                            </div>\
                                         </div>';
                    $(o.modalsection).appendTo($("body"));
                    _.forEach(o.plantilla.find('div [id="' + id + '"]').parent().contents(), function (vo) {
                        vo.nodeType === 8 && vo.nodeValue.indexOf(id) >= 0 && (clone = $("<!-- " + vo.nodeValue + " --><!-- /ko -->"),
                            $('#modalsection div#modalB').append(clone), ko.applyBindings(o.appvm, clone[0]),
                            $('#modalsection div#modalB div[id="' + id + '"]').css({ width: "100%", maxWidth: "100%" }), appendclone(vo.nextSibling.id));
                    });
                    $('#modalsection i.fa-times').on("click", function () {
                        $('#modalsection').remove(); o.appvm.modalIsShown(!1); !visiblebase && (o.appvm[id].visible(visiblebase), $('#' + id).show());
                    });
                }
            }, 5);
        }
        function downloadFE(showNewPage, ekey, modo) {
            var o = getOpts();
            ekey = ekey || o.appvm[o.idPlantilla].mapeopdfligar();
            if (o.appvm[o.idPlantilla].pdfmapping()[ekey])
                $.ajax({
                    url: o.datasend.urlGlobal + "FEConfigurador.aspx/GeneraArchivo",
                    data: JSON.stringify({ idplantilla: o.datasend.idPlantilla, guidpdf: ekey, proyid: o.datasend.proyid, expId: o.datasend.expId, tipoDocId: o.datasend.tipoDocId, xml: xmlToJson(o), modo: modo, guidF: o.datasend.guid }),
                    success: function (j) {
                        j = j.d;
                        if (j.Success) {
                            var byteCharacters = window.atob(j.ReturnedObject), byteArrays = [], sliceSize = 512, fl = o.appvm[o.idPlantilla].pdfmapping()[ekey];
                            for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                                var slice = byteCharacters.slice(offset, offset + sliceSize), byteNumbers = new Array(slice.length);
                                for (var i = 0; i < slice.length; i++) byteNumbers[i] = slice.charCodeAt(i);
                                var byteArray = new Uint8Array(byteNumbers);
                                byteArrays.push(byteArray);
                            }
                            var ext = modo === 3 || fl.downloadtype.toLowerCase() === "pdf" ? "pdf" : fl.filename.substring(fl.filename.lastIndexOf(".") + 1);
                            var filenameNoExt = !(ekey && !!fl.filename) ? "PlantillaArchivo." : fl.filename.substring(0, fl.filename.lastIndexOf(".") + 1);
                            var blobdata = new Blob(byteArrays, { type: "application/" + ext });
                            var titulo = filenameNoExt + ext;
                            if (window.navigator.msSaveOrOpenBlob) window.navigator.msSaveOrOpenBlob(blobdata, titulo);
                            else {
                                var elem = window.document.createElement("a");
                                elem.href = window.URL.createObjectURL(blobdata);
                                elem.download = titulo;
                                document.body.appendChild(elem);
                                if (showNewPage && ext === "pdf") window.open(elem.href);
                                else elem.click();
                                document.body.removeChild(elem);
                            }
                        } else Error(j.Titulo, j.Mensaje);
                    },
                    error: function (e) { o = getOpts(); errorFormElec(o, e); }
                });
            else
                toasty("", "No existe un archivo asociado.");
        }
        function makeQR(o, id) {
            if (o.appvm[id].visible()) {
                if (typeof QRCode === "undefined") {
                    var timesToTry = 0;
                    var verifyQrCode = setInterval(function () {
                        if (typeof QRCode === "undefined") {
                            timesToTry++;
                            if (timesToTry === 20) {
                                clearInterval(verifyQrCode);
                                toasty("QRcode", "No se ha logrado inicializar. Revise script.", "Error");
                            }
                        }
                        else clearInterval(verifyQrCode), makeQR(o, id);
                    }, 100);
                }
                else {
                    if (o.appvm[id].tipo() === o.TE.CodigoQR) {
                        if ($('#' + id + 'qrcodeelem')[0]) {
                            $('#' + id + 'qrcodeelem').children().remove();
                            var qrcode = new QRCode(id + "qrcodeelem", {
                                width: o.appvm[id].lado(), height: o.appvm[id].lado(), colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H
                            });
                            if (o.appvm[id].valor()) {
                                var json = JSON.stringify(o.appvm[id].valor());
                                if (json.length < 218 && json.length > 191) {
                                    json = json.substring(0, json.length - 1);
                                    var workaround = " ";
                                    workaround = workaround.substring(0, 218 - json.length);
                                    json += workaround, json += "}";
                                }
                                qrcode.makeCode(json);
                            }
                        }
                    }
                }
            }
        }
        function habilitarSeccion(id, habilitar) {
            var o = getOpts();
            var secc = searchElementInJson(o, id);
            if (secc && secc.elementos && secc.elementos.elemento)
                _.forEach(secc.elementos.elemento, function (sechijo) {
                    o.appvm[sechijo["@idelemento"]] && o.appvm[sechijo["@idelemento"]].habilitado && o.appvm[sechijo["@idelemento"]].habilitado(habilitar);
                });
        }



        //Configurador de Tabla
        function verifyAttrsPerRow(o, id) {
            var attrPerAction = { checked: !1, id: 1, allowedit: !0, allowselect: !0, allowdelete: !0, exerule: !1, visible: !0, guidanexo: moment(new Date()).format("YYYYMMDDHHSSsss") };
            var attrPerCol = { haserror: !1, colvisible: !0, titulo: '', valor: '', valormetadato: '' };

            //En caso de que se ejecute una regla y aún no esté renderizada la tabla
            if (o.appvm[id].valorjson() && o.appvm[id].valorjson().length > 0 && _.keys(o.appvm[id].valorjson()[0].Acciones).length < _.keys(attrPerAction).length) {
                var jsr = ko.mapping.toJS(o.appvm[id].valorjson()), jsr2 = [], actkeys = _.keys(attrPerAction), colkeys = _.keys(attrPerCol);
                for (var eljs = 0; eljs < jsr.length; eljs++) {
                    var eljscol = _.keys(jsr[eljs]);
                    for (var ieljs = 0; ieljs < eljscol.length; ieljs++) {
                        if (eljscol[ieljs].toLowerCase().indexOf("accion") >= 0 && _.keys(jsr[eljs][eljscol[ieljs]]).length < actkeys.length) {
                            for (var attrAc = 0; attrAc < actkeys.length; attrAc++)
                                jsr[eljs][eljscol[ieljs]][actkeys[attrAc]] === undefined && (jsr[eljs][eljscol[ieljs]][actkeys[attrAc]] = attrPerAction[actkeys[attrAc]]);
                        }
                        else if (_.keys(jsr[eljs][eljscol[ieljs]]).length < colkeys.length) {
                            for (var attrCol = 0; attrCol < colkeys.length; attrCol++)
                                jsr[eljs][eljscol[ieljs]][colkeys[attrCol]] === undefined && (jsr[eljs][eljscol[ieljs]][colkeys[attrCol]] = attrPerAction[colkeys[attrCol]]);
                        }
                        else break;
                    }
                    jsr2.push(ko.mapping.fromJS(jsr[eljs]));
                }

                o.appvm[id].valorjson.silentUpdate(jsr2), o.appvm[id].valor.silentUpdate(JSON.stringify(ko.mapping.toJS(jsr2)));
            }
        }
        function actionRowTable(id, params) {
            var o = getOpts(), k, nombrecolumnas, row = {}, ordtab = "", currevent = params[0], m, rowimpcomp;
            var tabla = searchElementInJson(o, id);
            if (currevent === "tableshowadd,editing,multi") currevent = "tableshowadd";//viejos usos de esta regla se cambian a solo tableshowadd
            switch (params[0]) {
                case "editing": case "multi": currevent = "editing,multi"; break;
                case "tableadd": case "addclear": currevent = "tableadd,addclear"; break;
                default: currevent = params[0];
            }
            o["istb" + currevent + id] = !0;
            if (!(o.appvm[id].valorjson() instanceof Array)) o.appvm[id].valorjson([]);
            nombrecolumnas = o.appvm[id].nombrecolumnas() || [], o.appvm[id].validationerror(""), o.appvm[id].haserror(!1);
            var getAcciones = function () {
                return { "Acciones": { "id": o.appvm[id].lastrownumber(), checked: false, allowedit: true, allowselect: true, allowdelete: true, exerule: false, visible: true, guidanexo: moment(new Date()).format("YYYYMMDDHHSSsss") } };
            };

            verifyAttrsPerRow(o, id);

            if (!nombrecolumnas.length) {
                nombrecolumnas.push({ parent: "", id: "Acciones" });
                nombrecolumnas = recursiveGetNameColumns(tabla.elementos.elemento, nombrecolumnas, "");
                o.appvm[id].nombrecolumnas(nombrecolumnas);
            }
            if (params[0] === "importTable") importTable(id, params);
            if (params[0] === "tableadd" || params[0] === "addclear") {
                var rowcomp;
                if (o.appvm[id].filasmax() > 0 && o.appvm[id].valorjson().length >= o.appvm[id].filasmax()) {
                    o.appvm[id].validationerror("Se alcanz&oacute; el n&uacute;mero m&aacute;ximo de filas que es " + o.appvm[id].filasmax()), o.appvm[id].haserror(!0);
                }
                else {
                    if (tabla.elementos.elemento.length > 0) {
                        if (validateCustomElements(o, id, !0) === !0) {
                            o.appvm[id].lastrownumber() === 0 && o.appvm[id].valorjson().length > 0 && o.appvm[id].lastrownumber(_.max(_.map(o.appvm[id].valorjson(), function (ve) { return ve.Acciones.id(); }))),
                                o.appvm[id].lastrownumber(o.appvm[id].lastrownumber() + 1), row = getAcciones(),
                                rowcomp = recursiveAddTablaChilds(tabla.elementos.elemento, row, o),
                                !verifyRowDuplicate(o, id, rowcomp) && (o.appvm[id].valorjson().push(rowcomp),
                                    ordtab = _.map(_.orderBy(_.map(o.appvm[id].valorjson(), function (va) {
                                        return { ord: va.Acciones.id(), el: va };
                                    }), "ord", o.appvm[id].ordenamiento()), "el"),
                                    o.appvm[id].valorjson(ordtab), o.appvm[id].valor(JSON.stringify(ko.mapping.toJS(ordtab, o.ignmap))));
                        }
                        else { o.appvm[id].validationerror("Revise los campos obligatorios"), o.appvm[id].haserror(!0); return; }
                    }
                }
                evaluateConditions(o, id);
            }
            if (params[0] === "edit") {
                if (validateCustomElements(o, id, !0)) {
                    for (k = 0; k < o.appvm[id].valorjson().length; k++) {
                        if (o.appvm[id].valorjson()[k].Acciones.id() === o.appvm[id].rowediting()) {
                            var roweditcomp = recursiveAddTablaChilds(tabla.elementos.elemento, ko.mapping.toJS(o.appvm[id].valorjson()[k]), o);
                            !verifyRowDuplicate(o, id, roweditcomp) && (o.appvm[id].valorjson()[k] = roweditcomp);
                            o.appvm[id].valor(JSON.stringify(ko.mapping.toJS(o.appvm[id].valorjson(), o.ignmap)));
                            var temp = o.appvm[id].valorjson();
                            o.appvm[id].valorjson.silentUpdate([]), o.appvm[id].valorjson(temp);//update forced
                            o.appvm[id].rowediting("");
                            break;
                        }
                    }
                }
                else {
                    o.appvm[id].validationerror("Revise los campos obligatorios"), o.appvm[id].haserror(!0);
                    delete o["istb" + currevent + id];
                    return;
                }
                evaluateConditions(o, id);
            }
            if (params[0] === "clear" || params[0] === "addclear" || params[0] === "closeclear" || params[0] === "edit")
                recursiveClearTablaChilds(tabla.elementos.elemento, o);
            if (params[0] === "addclear" || params[0] === "closeclear" || params[0] === "edit")
                o.appvm[id].addrow(false), o.appvm[id].modeedit(false), o.appvm[id].rowediting(""), evaluateConditions(o, id);
            if (params[0] === "remove") {
                for (var i = 0; i < o.appvm[id].valorjson().length; i++) {
                    if (o.appvm[id].valorjson()[i].Acciones.id() === params[1]) {
                        var ane = _.find(o.appvm.listAnexos(), { GuidAnexo: o.appvm[id].valorjson()[i].Acciones.guidanexo() });
                        if (ane) {
                            ane.BorrarMetadatos = !0;
                            $.ajax({
                                url: o.datasend.urlGlobal + 'FECapturador.aspx/InvokeMethodWcf', type: "POST", contentType: "application/json; charset=utf-8",
                                data: JSON.stringify({ method: "BorraAnexo", consulta: JSON.stringify({ guid: o.datasend.guid, anexos: [ane], proyid: o.datasend.proyid }), proyid: o.datasend.proyid }),
                                beforeSend: function () { },
                                success: function (j) {
                                    j = j.d;
                                    if (j.Success) {
                                        for (var i = 0; i < o.appvm.listAnexos().length; i++)
                                            if (o.appvm.listAnexos()[i].GuidAnexo === ane.GuidAnexo) o.appvm.listAnexos.splice(i, 1);
                                    }
                                    else toasty('', j.Mensaje, 'error');
                                }
                            });
                        }
                        o.appvm[id].valorjson.splice(i, 1);
                        break;
                    }
                }
                o.appvm[id].valor(JSON.stringify(ko.mapping.toJS(o.appvm[id].valorjson(), o.ignmap)));
                o.appvm[id].modeedit(false);
                o.appvm[id].addrow(false);
                recursiveClearTablaChilds(tabla.elementos.elemento, o);
                evaluateConditions(o, id);
            }
            if (params[0] === "editing" || params[0] === "tableshowadd") {
                var withoutlabel;
                recursiveClearTablaChilds(tabla.elementos.elemento, o);//para asegurar limpieza de los campos antes de una captura, ya sea edicion o nuevo
                $("body").resize(); //para render de elementos easyui
                if (params[0].indexOf('tableshow') >= 0)
                    o.appvm[id].addrow(!0), o.appvm[id].modeedit(params[0].indexOf('edit') >= 0), withoutlabel = !0;
                else {
                    for (k = 0; k < o.appvm[id].valorjson().length; k++) {
                        if (o.appvm[id].valorjson()[k].Acciones.id() === params[1]) {
                            o.appvm[id].addrow(!0), o.appvm[id].modeedit(!0), o.appvm[id].rowediting(params[1]);

                            var objrow = ko.mapping.toJS(o.appvm[id].valorjson()[k], o.ignmap);
                            for (var elem in objrow) {
                                if (o.appvm[elem]) {
                                    if (elem !== "Acciones") {
                                        for (var attr in objrow[elem]) {
                                            if (o.appvm[elem][attr]) {
                                                if (o.appvm[elem].tipo() === o.TE.Lista && attr === "valormetadato") asignaChosenItemsPorValor(objrow[elem][attr], elem, o);
                                                else if (o.appvm[elem].tipo() === o.TE.ComboBoxTemporal) { //el orden de la asignacion es importante en un combobox
                                                    if (objrow[elem]["valormetadato"]) //este if es para versiones viejas donde no exista valormetadato en el json de una tabla
                                                        o.appvm[elem].valormetadato(objrow[elem]["valormetadato"]);//se asigna silencioso para evitar doble ejecucion de reglas
                                                    if (objrow[elem]["catalogodestino"]) {//este if es para versiones viejas donde no exista catalogodestino en el json de una tabla
                                                        var catd = objrow[elem]["catalogodestino"];
                                                        o.appvm[elem].catalogotemp(catd ? JSON.parse(catd) : []);
                                                    }
                                                    break; //este break es para saltarse la asignacion de combobox ya que fue manual
                                                }
                                                else {
                                                    if (o.appvm[elem].tipo() !== o.TE.Boton) { // no se edita el valor del boton original
                                                        o.appvm[elem][attr](objrow[elem][attr]);
                                                        if (objrow[elem][attr] === "false" || objrow[elem][attr] === "true")
                                                            objrow[elem][attr] = objrow[elem][attr] === "true";
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            break;
                        }
                    }
                }
                validateCustomElements(o, id, !0, withoutlabel), evaluateConditions(o, id);
            }
            if (params[0] === "checkall")
                for (k = 0; k < o.appvm[id].valorjson().length; k++) o.appvm[id].valorjson()[k].Acciones.checked(params[1] === true);
            if (params[0] === "check") {
                for (k = 0; k < o.appvm[id].valorjson().length; k++)
                    if (o.appvm[id].valorjson()[k].Acciones.id() === params[2]) {
                        o.appvm[id].valorjson()[k].Acciones.checked(params[1] === true);
                        break;
                    }
                evaluateConditions(o, id);
            }
            if (params[0] === "multi") {
                recursiveClearTablaChilds(tabla.elementos.elemento, o), o.appvm[id].addrow(!1), o.appvm[id].modeedit(!1);
                var filas = _.filter(o.appvm[id].valorjson(), function (f) { return f.Acciones.checked(); }),
                    edited = !1, changecolumn, modalmulti = $('<div class="modal">\
                    <div class="modal-dialog">\
                        <div class="modal-content">\
                            <div class="modal-header">\
                                <h3 class="modal-title">Multi-Edici&oacute;n:&nbsp;\
                                    <strong>' + filas.length + ' fila(s) a editar</strong>\
                                </h3>\
                            </div>\
                            <div class="modal-body">\
                                <div class="row">\
                                    <div class="col-sm-4 col-4">\
                                        <strong class="text-right lead">Campo a editar: </strong>\
                                    </div>\
                                    <div class="col-sm-8 col-8">\
                                        <select class="selectcolumnas form-control"></select>\
                                    </div>\
                                </div>\
                                <div class="row">\
                                    <div class="col-sm-4 col-4">\
                                        <strong class="text-right lead">Asigna un valor: </strong>\
                                    </div>\
                                    <div class="col-sm-8 col-8 holdercontrol"></div>\
                                </div>\
                                <div class="row">\
                                    <div class="col-sm-4 col-4">\
                                        <strong class="text-right lead">Log: </strong>\
                                    </div>\
                                    <div class="col-sm-8 col-8">\
                                        <div class="well well-sm multilog" style="min-height: 100px; overflow: auto;"></div>\
                                    </div>\
                                </div>\
                            </div>\
                            <div class="modal-footer">\
                                <div class="modalclose btn btn-danger">Cerrar</div>\
                                <div class="modalupdate btn btn-light">Actualizar</div>\
                                <div class="modalupdateclose btn btn-primary">Actualizar y Cerrar</div>\
                            </div>\
                        </div>\
                    </div>\
                </div>');
                modalmulti.find(".selectcolumnas").append(_.map(_.keys(_.omitBy(o.appvm[id].columnasmultieditar(), function (w, z) { return w ? "" : z; })), function (f) { return '<option value="' + f + '">' + o.appvm[f].titulo() + '</option>'; }).join(' ')),
                    $("body").append(modalmulti), (changecolumn = function () {
                        var ee = modalmulti.find(".selectcolumnas").val();
                        o = getOpts(), modalmulti.find(".holdercontrol").contents().remove(),
                            o.plantilla.find("div.element[id='" + ee + "']").parent().contents().filter(function () {
                                var clone;
                                if (this.nodeType === 8 && this.nodeValue.indexOf('"' + ee + '"') !== -1)
                                    return o.appvm[ee].visible(!0), o.appvm[ee].habilitado(!0), clone = $("<!-- " + this.nodeValue + " --><!-- /ko -->"),
                                        modalmulti.find(".holdercontrol").append(clone), ko.applyBindings(o.appvm, clone[0]),
                                        setTimeout(function () { $(".holdercontrol div[id^=formElec]").css({ width: "100%" }); }, 1);
                            });
                    })();
                var updatecolumn = function () {
                    var val = modalmulti.find(".selectcolumnas").val(), desc = modalmulti.find(".selectcolumnas option:selected").text(),
                        log = "<p>Se edit&oacute; la columna " + desc + " </p>", newrow;
                    if (validateControl(o, val, !0)) {
                        for (o = getOpts(), k = 0; k < o.appvm[id].valorjson().length; k++) {
                            if (o.appvm[id].valorjson()[k].Acciones.checked() === !0)
                                for (var elem in o.appvm[id].valorjson()[k])
                                    if (elem === val) {
                                        newrow = writeRowByAttr({}, elem, o)[val];
                                        for (var attr in newrow) o.appvm[id].valorjson()[k][val][attr] && o.appvm[id].valorjson()[k][val][attr](newrow[attr]);
                                    }
                                    else if (elem !== "Acciones" && o.appvm[id].valorjson()[k][elem]["haserror"]) o.appvm[id].valorjson()[k][elem]["haserror"](!1);
                        }
                        modalmulti.find(".multilog").html(modalmulti.find(".multilog").html() + log), edited = !0;
                    }
                    else edited = !1;
                };
                var closemulti = function () {
                    if (edited) {
                        var temp = o.appvm[id].valorjson();
                        o.appvm[id].valor(JSON.stringify(ko.mapping.toJS(o.appvm[id].valorjson(), o.ignmap))), o.appvm[id].rowediting("multi"),
                            o.appvm[id].valorjson([]), o.appvm[id].valorjson(temp), o.appvm[id].rowediting("");
                    }
                    modalmulti.modal("hide"); modalmulti.remove();
                };
                modalmulti.find(".selectcolumnas").on("change", changecolumn), modalmulti.find(".modalclose").on("click", closemulti),
                    modalmulti.find(".modalupdate").on("click", updatecolumn), modalmulti.find(".modalupdateclose").on("click", function () { updatecolumn(); closemulti(); }),
                    modalmulti.modal({ keyboard: false, backdrop: "static", show: true }), modalmulti.find(".modal-content").css({ "margin-bottom": modalmulti.find(".eventscontent").outerHeight() });
                evaluateConditions(o, id);
            }
            if (params[0] === 'import') {
                let tableMatrix = params[1], configCols = o.appvm[id].configuracioncargatabla()["mapeo"];

                for (m = 1; m < tableMatrix.length; m++) {
                    if (o.appvm[id].filasmax() > 0 && o.appvm[id].valorjson().length >= o.appvm[id].filasmax()) {
                        o.appvm[id].validationerror("Ya se alcanz&oacute; el numero m&aacute;ximo de filas que es " + o.appvm[id].filasmax()), o.appvm[id].haserror(!0);
                        return;
                    } else {
                        o.appvm[id].lastrownumber(o.appvm[id].lastrownumber() + 1), row = getAcciones();
                        var rowimpcomp1 = recursiveAddTablaChilds(tabla.elementos.elemento, row, o, [configCols, tableMatrix[m]]);
                        !verifyRowDuplicate(o, id, rowimpcomp1) && o.appvm[id].valorjson.push(rowimpcomp1);
                        o.appvm[id].valor(JSON.stringify(ko.mapping.toJS(o.appvm[id].valorjson(), o.ignmap)));
                    }
                }
            }
            if (params[0] === 'serviceimport') {
                o.appvm[id].valor.silentUpdate('[]'), o.appvm[id].valorjson.silentUpdate([]), o.appvm[id].lastrownumber(0); //se limpia la tabla porque al importarse de servicio, no es necesario mantener lo que existe
                let tableMatrix = params[1], configCols = tableMatrix.length ? _.keys(tableMatrix[0]) : [], allrows = [];

                for (m = 0; m < tableMatrix.length; m++) {
                    if (o.appvm[id].filasmax() > 0 && o.appvm[id].valorjson().length >= o.appvm[id].filasmax()) {
                        o.appvm[id].validationerror("Ya se alcanz&oacute; el numero m&aacute;ximo de filas que es " + o.appvm[id].filasmax()), o.appvm[id].haserror(!0);
                        return;
                    } else {
                        o.appvm[id].lastrownumber(o.appvm[id].lastrownumber() + 1), row = getAcciones();
                        rowimpcomp = recursiveAddTablaChilds(tabla.elementos.elemento, row, o, [configCols, tableMatrix[m], !0]);
                        !verifyRowDuplicate(o, id, rowimpcomp) && allrows.push(rowimpcomp);
                    }
                }
                //se agregan al final para evitar revision recursiva de las reglas y mejor performance
                o.appvm[id].valorjson(allrows);
                o.appvm[id].valor(JSON.stringify(ko.mapping.toJS(o.appvm[id].valorjson(), o.ignmap)));
            }
            if (params[0] === 'clearall') {
                o.appvm[id].valorjson([]), o.appvm[id].lastrownumber(0);
            }
            for (k = 0; k < o.appvm[id].valorjson().length; k++) o.appvm[id].valorjson()[k].Acciones.exerule(false);
            o.appvm[id].rowonfocus(-1);
            delete o["istb" + currevent + id];
        }
        function recursiveAddTablaChilds(childs, row, o, importdata) {//importdata: 0 = configcolumns, 1 = matrix, 2 = isserviceimport
            var child;
            for (var j = 0; j < childs.length; j++) {
                child = childs[j]["@idelemento"], row = writeRowByAttr(row, child, o);
                if (importdata !== undefined) {
                    if (importdata[2] !== undefined && importdata[2] === !0) { //importado por servicio
                        var nidu = o.appvm[child].idunico().toString(); //intento solo con idunico
                        if (importdata[1][nidu] !== undefined && importdata[1][nidu] !== null)
                            row[child].valor = importdata[1][nidu], row = setImportedDataToElement(row, o, row[child].valor, child);
                        else {
                            //se intenta quitando el primer _ por si tiene prefijo
                            if (nidu.indexOf("_") >= 0) {
                                nidu = nidu.replace(nidu.split("_")[0] + "_", "");
                                if (importdata[1][nidu] !== undefined && importdata[1][nidu] !== null)
                                    row[child].valor = importdata[1][nidu], row = setImportedDataToElement(row, o, row[child].valor, child);
                            }
                        }
                    } else if (importdata[0][child])
                        row[child].valor = importdata[1][importdata[0][child]], row = setImportedDataToElement(row, o, row[child].valor.toLowerCase(), child);
                }
                childs[j].elementos && (row = recursiveAddTablaChilds(childs[j].elementos.elemento, row, o));
            }
            return ko.mapping.fromJS(row);
        }
        function verifyRowDuplicate(o, id, row) {
            //bandera de respuesta
            var rowisduplicated = !1;
            //ver si requiere revisar duplicidad
            if (o.appvm[id].evitarduplicado()) {
                //se revisa si el elemento tabla tiene la propiedad valor (esto es por versiones viejas de FE donde aun no se inventaba esto. Asi que esta validacion esta de más)
                if (o.appvm[id].valor()) {
                    //se obtiene json de la tabla
                    var jsonorig = JSON.parse(o.appvm[id].valor());
                    //se recorre cada fila
                    _.forEach(jsonorig, function (origelem) {
                        if (!rowisduplicated) {
                            //Cantidad de columnas duplicadas
                            var cantduplicated = 0;
                            //se recorren las columnas de la fila
                            _.forEach(_.keys(origelem), function (keycol) {
                                //Se excluye columna de acciones (se afirma que existe la fila)
                                if (keycol.toLowerCase().indexOf("acciones") === -1 && row[keycol]) {
                                    //Si existe el elemento y no es boton o wizard
                                    if (o.appvm[keycol] && !_.includes([o.TE.Boton, o.TE.Wizard], o.appvm[keycol].tipo())) {
                                        //asegurarme que existe en el json la propiedad valormetadato, asi como en el que van a insertar y los comparo
                                        if (origelem[keycol].hasOwnProperty("valormetadato") && row[keycol].valormetadato &&
                                            _.isEqual(origelem[keycol].valormetadato, row[keycol].valormetadato()))//se valida contenido de valormetadato
                                            cantduplicated += 1;
                                        //asegurarme que existe en el json la propiedad valormetadatorango, asi como en el que van a insertar y los comparo
                                        else if (origelem[keycol].hasOwnProperty("valormetadatorango") && row[keycol].valormetadatorango &&
                                            _.isEqual(origelem[keycol].valormetadatorango, row[keycol].valormetadatorango()))//se valida contenido de valormetadatorango
                                            cantduplicated += 1;
                                    }
                                }
                            });
                            //si la cantidad de columnas duplicadas es igual al tamaño de columnas existentes (Al parecer se involucra tambien las de tipo boton) entonces se prende bandera global
                            if (cantduplicated === _.keys(origelem).length - 1) rowisduplicated = !0;
                        } else if (rowisduplicated === !0) return; //si la bandera ya esta prendida se rompe loop
                    });
                    //esta valudacion es interna de web, no sirve en movilidad
                    !rowisduplicated && o.appvm[id].rowonfocus(row.Acciones.id());
                }
            }
            //Si la bandera esta prendida se manda mensaje
            rowisduplicated && toasty("Registro duplicado", "No se puede insertar");
            return rowisduplicated;
        }
        function setImportedDataToElement(row, o, valor, child) {
            var tipoElem = o.appvm[child].tipo(), metadato = "";
            valor = _.toString(valor);//se evita que valor venga null
            switch (tipoElem) {
                case o.TE.Lista:
                    var ta = o.appvm[child].tipoasociacion(), valmet = ta === "idid" || ta === "iddesc" ? "Valor" : "Nombre",
                        valval = ta === "descid" || ta === "idid" ? "Valor" : "Nombre";
                    var elemItem = _.find(o.datatags.allitemscatalogs["catalogos|" + o.appvm[child].catalogoorigen()], function (c) { return c[valval].toLowerCase() === valor; });
                    elemItem && (metadato = elemItem[valmet]);
                    break;
                default:
                    metadato = valor;
            }
            row[child].valormetadato = metadato;
            return row;
        }
        function recursiveClearTablaChilds(childs, o) {
            for (var i = 0; i < childs.length; i++) {
                var child = childs[i]["@idelemento"], tl, tipo;
                o.appvm[child] && (tipo = o.appvm[child].tipo(), tipo === o.TE.RangoFechas ?
                    (o.appvm[child].valorinicial(""), o.appvm[child].valormetadatoinicial(""), o.appvm[child].valorfinal(""), o.appvm[child].valormetadatofinal("")) :
                    tipo === o.TE.Lista ?
                        (tl = o.appvm[child].tipolista(), tl === "combo" ? o.appvm[child].optionselectedRule(undefined) : o.appvm[child].chosenitemsRule([])) :
                        tipo === o.TE.ComboBoxTemporal ?
                            o.appvm[child].catalogotemp([]) :
                            tipo === o.TE.Logico ?
                                o.appvm[child].valor(false) :
                                tipo === o.TE.ComboDinamico ?
                                    o.appvm[child].optionselected("") :
                                    !_.includes([o.TE.Boton, o.TE.Leyenda, o.TE.Wizard], tipo) && (o.appvm[child].valor && o.appvm[child].valor(""), o.appvm[child].valormetadato && o.appvm[child].valormetadato("")));

                childs[i].elementos && recursiveClearTablaChilds(childs[i].elementos.elemento, o);
            }
        }
        function recursiveGetNameColumns(childs, nc, p) {
            var idelem, tipo, o = getOpts();
            for (var i = 0; i < childs.length; i++)
                idelem = childs[i]["@idelemento"], tipo = childs[i]["@tipoelemento"],
                    childs[i].elementos ? nc = recursiveGetNameColumns(childs[i].elementos.elemento, nc, idelem) :
                        !_.includes([o.TE.Audio, o.TE.CodigoQR, o.TE.Documento, o.TE.FirmaFAD, o.TE.Georeferencia, o.TE.HuellaDigital, o.TE.Imagen,
                        o.TE.Leyenda, o.TE.Logo, o.TE.Seccion, o.TE.Video, o.TE.Tabber], tipo) && nc.push({ parent: p, id: idelem });
            return nc;
        }
        function writeRowByAttr(row, elemid, o) {
            var tipo = o.appvm[elemid].tipo();
            if (!_.includes([o.TE.Audio, o.TE.CodigoQR, o.TE.Documento, o.TE.FirmaFAD, o.TE.Georeferencia, o.TE.HuellaDigital, o.TE.Imagen,
            o.TE.Leyenda, o.TE.Logo, o.TE.Seccion, o.TE.Video, o.TE.Tabber], tipo)) {
                row[elemid] = {},
                    _.includes([o.TE.Moneda, o.TE.Fecha, o.TE.Hora, o.TE.Lista], tipo) ?
                        row[elemid] = { valormetadato: o.appvm[elemid].valormetadato(), valor: o.appvm[elemid].valor(), idunico: o.appvm[elemid].idunico() } :
                        tipo === o.TE.RangoFechas ?
                            row[elemid] = {
                                valormetadatoinicial: dateToUniversal(o, elemid, o.appvm[elemid].valorinicial()), valorinicial: o.appvm[elemid].valorinicial(),
                                valormetadatofinal: dateToUniversal(o, elemid, o.appvm[elemid].valorfinal()), valorfinal: o.appvm[elemid].valorfinal(),
                                valormetadatorango: o.appvm[elemid].valormetadatorango(), idunico: o.appvm[elemid].idunico()
                            } :
                            tipo === o.TE.Logico ?
                                row[elemid] = { valormetadato: o.appvm[elemid].valor() === true ? "1" : "0", valor: o.appvm[elemid].valor(), idunico: o.appvm[elemid].idunico() } :
                                _.includes([o.TE.Leyenda, o.TE.Seccion, o.TE.Boton, o.TE.Wizard], tipo) ?
                                    row[elemid] = {} : tipo === o.TE.ComboBoxTemporal ? row[elemid] = { valormetadato: o.appvm[elemid].valormetadato(), valor: o.appvm[elemid].valor(), catalogodestino: JSON.stringify(o.appvm[elemid].catalogodestino()), idunico: o.appvm[elemid].idunico() } :
                                        o.appvm[elemid].valor && (row[elemid] = { valormetadato: o.appvm[elemid].valormetadato(), valor: o.appvm[elemid].valor(), idunico: o.appvm[elemid].idunico() }),
                    row[elemid]["haserror"] = !1, row[elemid]["colvisible"] = !0;
            }
            return row;
        }
        function columnSummatory(o, id) {
            var summ = {};
            o.appvm[id].valorjson().forEach(row => {
                _.keys(row).forEach(k => {
                    if (k.indexOf("formElec") >= 0 && o.appvm[id].columnastotalizar()[k] !== !1) {
                        if (summ[k] === undefined)
                            summ[k] = !row[k].valormetadato() ? 0 : Number(row[k].valormetadato());
                        else {
                            if (_.includes(["suma", "promedio"], o.appvm[id].operaciontotal()))
                                summ[k] += !row[k].valormetadato() ? 0 : Number(row[k].valormetadato());
                            else if (o.appvm[id].operaciontotal() === "resta")
                                summ[k] -= !row[k].valormetadato() ? 0 : Number(row[k].valormetadato());
                        }
                    }
                });
            });
            for (var elm in summ) {
                if (o.appvm[id].operaciontotal() === "promedio") summ[elm] = summ[elm] / o.appvm[id].valorjson().length;
                if (o.appvm[elm] && o.appvm[elm].tipo() === o.TE.Moneda) {
                    var fmnumber = summ[elm] ? summ[elm].toString().match(/[-]?[0-9]+(\.[0-9]+){0,1}/g) : undefined, isnumber = !!fmnumber && fmnumber.length > 0;
                    if (isnumber && summ[elm]) {
                        fmnumber = fmnumber.join('');
                        var cultura = o.appvm[elm].cultura(), curr, formatter;
                        switch (cultura) {
                            case "es": curr = "MXN"; break;
                            case "en": curr = "USD"; break;
                            case "ja": curr = "JPY"; break;
                            case "cs": curr = "CZK"; break;
                            case "en-gb": curr = "GBP"; break;
                            case "fr": curr = "EUR"; break;
                            case "th": curr = "THB"; break;
                            case "pt-br": curr = "BRL"; break;
                            case "ru": curr = "RUB"; break;
                        }
                        formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: curr, maximumFractionDigits: 2 });
                        summ[elm] = formatter.format(fmnumber);
                    }
                }
                else if (isNaN(summ[elm])) summ[elm] = "";
            }
            o.appvm[id].sumatoriacolumnas(summ);

            o.appvm[id].valorjson().forEach(row => {
                _.keys(row).forEach(k => {
                    if (k.indexOf("formElec") >= 0 && o.appvm[id].columnastotalizar()[k] !== !1) {
                        if (!!o.currentoperations && !!o.currentoperations[k])
                            for (let op = 0; op < o.currentoperations[k].length; op++) {
                                var oper = o.clonedoperacionesmatematicas[o.currentoperations[k][op].oke];
                                !oper.inexecution && oper.enabled && assignValueToElem(oper, oper.formula, oper.identifiers, k);
                            }
                    }
                });
            });

        }



        //Configurador para importar tabla (Elemento Tabla)
        function configureColumnsImport(o, id, data) {
            var sepId = "sepidconf", relationTab = "relationTab", headers, relColumns;
            data && (o.appvm[id].configuracioncargatabla()["separador"] = data.separator,
                o.appvm[id].configuracioncargatabla()["importcols"] = data.inf.toString().split(data.escapesequence)[0]);
            if (o.appvm[id].configuracioncargatabla()["separador"] && o.appvm[id].configuracioncargatabla()["importcols"]) {
                o.configTableColumns = '<div class="modal" id="configTableColumns" style="display:block">\
                <div class="modal-dialog modal-lg">\
                    <div class="modal-content" style="border-radius: 10px;">\
                        <div class="modal-header" style="border-radius: 10px 10px 0px 0px; background-image: linear-gradient(to right, #c7c1bc, #f6dca7)">\
                            <h5 class="modal-title">Configurador de Importaci&oacute;n&nbsp;<span class="text-primary"></span></h5>\
                            <span id="configTableClose" class="btn btn-light border btn-sm"><i style="font-size:16px" class="fas fa-times"></i></span>\
                        </div>\
                        <div class="modal-body">\
                            <span style="display:inline-flex"><strong style="font-size: 14px">Separador:&nbsp;&nbsp;</strong><input id="' + sepId + '" type="text" class="col-sm-2 form-control" style="height:25px"></span>\
                            <span id="saveUploadConfiguration" class="btn float-right btn-light border" data-toggle="tooltip" title="Guardar"><i style="font-size:23px" class="fas fa-save"></i></span>\
                            <div style="border-bottom: 2px solid lightgrey;margin: 15px 0px;width:85%;opacity:0.4;"></div>\
                            <table id="' + relationTab + '" class="table-striped table-condensed table table-sm table-hover"></table>\
                        </div>\
                    </div>\
                </div>\
            </div>';
                $(o.configTableColumns).appendTo($("body"));
                var relColumn = function (elem) {
                    let id = elem.id.substring(elem.id.indexOf("relcol") + 6); relColumns[id] = elem.options[elem.selectedIndex].value;
                }, reorderPrevTable = function (newVal) {
                    o.appvm[id].configuracioncargatabla()["separador"] = newVal.trim() === "" ? "&nbsp;" : newVal;
                    let rg = new RegExp(o.appvm[id].configuracioncargatabla()["separador"] + '?[\\"][\\s\\w,]*[\\"]', 'g'),
                        colsap = _.filter(o.appvm[id].configuracioncargatabla()["importcols"].replace(rg, '').split(o.appvm[id].configuracioncargatabla()["separador"]), function (v) { return v !== ""; });
                    o.appvm[id].configuracioncargatabla()["separador"].split(o.appvm[id].configuracioncargatabla()["separador"]);
                    $('#' + sepId).val(newVal);
                    headers = '<option value="" disabled selected>Seleccione</option>';
                    for (var v = 0; v < colsap.length; v++)
                        headers += "<option value='" + colsap[v].trim() + "-" + v + "'>" + colsap[v] + "</option>";
                }, reorderTableColumns = function () {
                    let mapped = o.appvm[id].configuracioncargatabla().mapeo, copyheaders, selectedValue,
                        relTable = "<thead><tr><th>Columna tabla</th><th>Columna importada</th></tr></thead>",
                        originalCols = _.keys(o.appvm[id].columnasmultieditar()); relColumns = mapped ? mapped : {};
                    for (var i = 0; i < originalCols.length; i++) {
                        copyheaders = "", selectedValue = false;
                        o.appvm[originalCols[i]] && (_.eachRight($(headers), function (eh) {
                            (relColumns[originalCols[i]] === eh.value.trim() || eh.value.trim() === "") && !selectedValue ? (eh.setAttribute("selected", ""), selectedValue = !0) : eh.removeAttribute("selected");
                            copyheaders += eh.outerHTML;
                        }),
                            relTable += '<tr><td>' + o.appvm[originalCols[i]].titulo() + '</td>\
                                 <td><select id="relcol' + originalCols[i] + '" class="form-control">' + copyheaders + '</select></td></tr>');
                    }
                    $('#' + relationTab).html(relTable);
                    $('[id^="relcol"]').on("change", function () { relColumn($(this)[0]); });
                };
                reorderPrevTable(o.appvm[id].configuracioncargatabla()["separador"]);
                reorderTableColumns();
                $('#' + sepId).on("keyup", function (e) { reorderPrevTable(e.target.value); reorderTableColumns(); });
                $('#saveUploadConfiguration').on("click", function () {
                    _.keys(relColumns).length > 0 ? (o.appvm[id].configuracioncargatabla()["mapeo"] = relColumns,
                        toasty("", "Configuraci&oacute;n guardada exitosamente", "exito")) :
                        toasty("", "Es necesario relacionar al menos una columna para guardar la configuraci&oacute;n");
                });
                $('#configTableClose').on("click", function () { $("#configTableColumns").remove(); });
            } else toasty("", "Es necesario cargar un template", "error");
        }
        function uploadTableData(o, id, data) {
            if (o.appvm[id].configuracioncargatabla()["mapeo"] && o.appvm[id].configuracioncargatabla()["separador"]) {
                let configcolumns = o.appvm[id].configuracioncargatabla()["mapeo"], separator = o.appvm[id].configuracioncargatabla()["separador"],
                    rows = data.inf.split(data.escapesequence), headers = [], tableMatrix = [];
                for (let n = 0; n < rows.length - 1; n++) {
                    let cols = rows[n].split(separator), s0 = 0;
                    if (n === 0)
                        for (var s in configcolumns) {
                            s0 = 0; _.forEach(cols, function (cv) { cols[s0].trim() + "-" + s0 === configcolumns[s] && (headers = cols); s0++; });
                        }
                    else {
                        if (headers.length === 0) break; tableMatrix[n] = [];
                        for (var m = 0; m < cols.length; m++)
                            headers[m] && (tableMatrix[n][headers[m].trim() + "-" + m] = cols[m]);
                    }
                }
                headers.length === 0 ? toasty("", "El archivo subido no corresponde con el template.") :
                    actionRowTable(id, ['import', tableMatrix]); unloadFile(id, false);
            } else
                toasty("", "Es necesario que configure las columnas a partir de un template.");
        }
        function unloadFile(id, removeconfig) {
            var o = getOpts();
            $("#atrimptable").val("");
            removeconfig && (o.appvm[id].nombretemplatecarga(""), o.appvm[id].configuracioncargatabla({}));
        }
        function importTable(id, data) {
            let o = getOpts();
            if (data[0] === 'openconfig')
                configureColumnsImport(o, id);
            else {
                let execFunc, ext, reader, file = data[1].files.length > 0 ? data[1].files[0] : undefined;
                file !== undefined && (ext = file.name.match(/\.[A-Za-z]{3}$/g), data[0] === 'config' ?
                    (o.appvm[id].nombretemplatecarga(file.name), execFunc = configureColumnsImport) : data[0].indexOf('import') >= 0 &&
                    (execFunc = uploadTableData), ext[0] === '.csv' ? (reader = new FileReader(), reader.addEventListener("load", function () {
                        $.ajax({
                            url: o.datasend.urlGlobal + "FEConfigurador.aspx/ImportarTabla",
                            data: JSON.stringify({ archivo: reader.result }),
                            contentType: 'application/json; charset=UTF-8',
                            type: 'POST',
                            success: function (result) {
                                result = result.d;
                                result.Success && execFunc(o, id, result.ReturnedObject);
                            }
                        });
                    }, false),
                        file && reader.readAsDataURL(file)) : toasty("", "Solo se permiten archivos csv.", "error"));
            }
        }



        //Configurador para relacionar listas cascada (Elemento Lista)
        function bindSonColumns(idparent) {
            var o = getOpts();
            if (!o.appvm[idparent].cascadahijo().length)
                toasty('', 'Seleccione un elemento hijo.');
            else if (!o.appvm[o.appvm[idparent].cascadahijo()].catalogoorigen().toString().length > 0)
                toasty('', 'Configure un cat&aacute;logo para el elemento hijo.');
            else {
                let dicconfigdata = {};
                _.forEach(o.appvm[idparent].configuracioncascada().split(';'), function (v) {
                    let sval = v.split(':'); sval.length > 1 && (dicconfigdata[sval[0]] = sval[1]);
                });
                o.configParentSonColumns = '<div class="modal" id="linkColumns" style="display:block">\
                <div class="modal-dialog modal-lg modal-dialog-centered">\
                    <div class="modal-content rounded">\
                        <div class="modal-header border-bottom py-2">\
                            <h5 class="w-100 m-0">Relacione las opciones de esta lista con la lista en cascada\
                                <div id="configTableClose" title="Cerrar" class="btn fas fa-times float-right border btn-sm"></div>\
                            </h5>\
                        </div>\
                        <div class="modal-body p-2" style="max-height:80vh; overflow:auto">\
                            <p>\
                                Puede utilizar la relación en cascada que existe en el Configurador de Catalogos o crear su propia relacion<br/>\
                                Por cada opcion de la lista debe especificar que opciones se mostraran de la lista en cascada <strong>' + o.appvm[o.appvm[idparent].cascadahijo()].titulo() + '</strong>\
                            </p>\
                            <p><div class="noticeCat"></div><span class="pl-2">Tomar en cuenta catálogos dependientes</span></p>\
                            <div class="easyui-datalist-catdest" style="width:90%"></div>\
                        </div>\
                    </div>\
                </div>\
            </div>';
                $(o.configParentSonColumns).appendTo($("body"));

                var checkParent = function (i, parentVal) {
                    var cbele = $('#linkColumns').find('[datagrid-row-index=' + i + ']').find('.textbox.combo');
                    cbele[0] ? cbele.css('display', '') :
                        $('#linkColumns').find('[datagrid-row-index=' + i + ']').find('[field=Catalogoprueba] div').combobox({
                            data: o.datatags.allitemscatalogs["catalogos|" + o.appvm[o.appvm[idparent].cascadahijo()].catalogoorigen()], multiple: !0, prompt: 'Seleccione...',
                            valueField: 'Valor', textField: 'Nombre', idField: 'Valor', limitToList: !0,
                            onSelect: function (rec) {
                                setTimeout(function () {
                                    dicconfigdata[parentVal] = $('#linkColumns').find('[datagrid-row-index=' + i + ']').find('[field=Catalogoprueba] div').combobox('getValues').join(',');
                                }, 1);
                            }, onUnselect: function (rec) {
                                setTimeout(function () {
                                    dicconfigdata[parentVal] = $('#linkColumns').find('[datagrid-row-index=' + i + ']').find('[field=Catalogoprueba] div').combobox('getValues').join(',');
                                }, 1);
                            }
                        });
                    dicconfigdata[parentVal] && $('#linkColumns').find('[datagrid-row-index=' + i + ']').find('[field=Catalogoprueba] div').combobox('setValues', dicconfigdata[parentVal]);
                };

                var unCheckParent = function (i, parentVal) {
                    delete dicconfigdata[parentVal];
                    var cbele = $('#linkColumns').find('[datagrid-row-index=' + i + ']').find('.textbox.combo');
                    cbele[0] && (cbele.css('display', 'none'), $('#linkColumns').find('[datagrid-row-index=' + i + ']').
                        find('[field=Catalogoprueba] div').combobox('clear'));
                };

                $('#linkColumns').find('.easyui-datalist-catdest').datagrid({
                    data: o.appvm[idparent].catalogodestino(), striped: !0, checkOnSelect: !1, idField: 'Valor', height: "auto",
                    columns: [[{ field: 'Valor', checkbox: !0 }, { field: 'Nombre', title: 'Columnas padre', width: "45%" },
                    { field: 'Catalogoprueba', title: 'Columnas hijo', width: "45%" }]],
                    onCheck: function (i, r) { r && checkParent(i, r.Valor); }, onUncheck: function (i, r) { r && unCheckParent(i, r.Valor); }, onCheckAll: function (rows) {
                        for (var mo = 0; mo < rows.length; mo++) { rows[mo].Valor && checkParent(mo, rows[mo].Valor); }
                    },
                    onUncheckAll: function (rows) {
                        for (var mo = 0; mo < rows.length; mo++) { rows[mo].Valor && unCheckParent(mo, rows[mo].Valor); }
                    },
                    onSelect: function () { $('#linkColumns').find(".datagrid-row-selected").removeClass("datagrid-row-selected"); }
                });
                $(".noticeCat").switchbutton({ checked: o.appvm[idparent].cascadapadre(), onChange: function (checked) { o.appvm[idparent].cascadapadre(checked); }, onText: 'S&iacute;', offText: 'No' });
                _.forEach(_.keys(dicconfigdata), function (n) {
                    $('#linkColumns').find('.easyui-datalist-catdest').datalist("checkRow",
                        $('#linkColumns').find('.easyui-datalist-catdest').datalist("getRowIndex", n));
                });

                $('#configTableClose').on("click", function () {
                    let stringdicconfig = ""; $("#linkColumns").remove(); _.forEach(_.keys(dicconfigdata),
                        function (v) { stringdicconfig += v + ':' + dicconfigdata[v] + ';'; });
                    o.appvm[idparent].configuracioncascada(stringdicconfig);
                });
            }
        }



        //Configurador de Esquemas (Elemento Lista)
        function configuradorEsquemaListas(id) {
            var o = getOpts();
            o.modalParameterEditor = $(
                '<div class="modal">\
                    <div class="modal-dialog modal-lg">\
                        <div class="modal-content rounded">\
                            <div class="modal-header p-0 px-2">\
                                <h5 class="col-12 py-2 px-0 border-bottom m-0">Configurador de esquema del elemento:<span class="ml-2">' + o.appvm[id].titulo() + '</span></h5>\
                            </div>\
                            <div class="modal-body p-2">\
                                <p>Configure las columnas requeridas, en caso de no visualizar ningún campo, es debido a que no se ha asociado ningún esquema al cat&aacute;logo.</p>\
                                <div class="parameterssection d-inline-flex w-100 flex-wrap"></div>\
                            </div>\
                            <div class="modal-footer p-1">\
                                <button type="button" id="modalRulesClose" class="btn btn-light border btn-sm">Cerrar</button>\
                            </div>\
                        </div>\
                    </div>\
                </div>');
            $("body").append(o.modalParameterEditor);

            var dataTexto = _.filter(_.keys(o.appvm), function (ekey) { return ekey.indexOf("formElec_element") >= 0 && _.includes([o.TE.Texto, o.TE.TextArea, o.TE.Moneda, o.TE.Fecha, o.TE.Numero], o.appvm[ekey].tipo()); })
                .map(function (ekey) { return { Nombre: o.appvm[ekey].titulo(), Valor: ekey }; });

            var esquema = [], configjson = {}, j = parseJsonParameters(o, id, "configjson"),
                catalogobusqueda = o.appvm[id].tipo() === o.TE.Lista ? o.datatags.catalogos : o.datatags.catalogosdocumento,
                catoriid = o.appvm[id][o.appvm[id].tipo() === o.TE.Lista ? "catalogoorigen" : "catalogofuente"]().toString(),
                catori = _.filter(catalogobusqueda, function (it) { return it.Valor.toString() === catoriid; });

            if (catori[0] && catori[0].Esquema && catori[0].Esquema.length) esquema = ko.utils.parseJson(catori[0].Esquema) || {};

            _.forEach(esquema, function (campoEsquema) {
                //migrar versión anterior de esquemas
                j[campoEsquema.Campo] && (j[campoEsquema.Campo] = j[campoEsquema.Campo].match(/formElec_element[0-9]+/)[0]);

                var campoEsquemaHtml = $("<div class='p-2 border-right rounded col-sm-4 col-12'><span class='font-weight-bold font-italic'>" + campoEsquema.Campo + "</span><div class='mt-2'><div class='comboEsquema'></div></div></div>");
                o.modalParameterEditor.find(".parameterssection").append(campoEsquemaHtml);
                campoEsquemaHtml.find(".comboEsquema").combobox({
                    data: dataTexto, valueField: "Valor", idField: "Valor", textField: "Nombre", limitToList: !0,
                    value: j[campoEsquema.Campo], prompt: "Seleccione...", panelHeight: "auto", panelMaxHeight: 200,
                    onSelect: function (sel) { configjson[campoEsquema.Campo] = sel.Valor; },
                    onUnselect: function () { delete configjson[campoEsquema.Campo]; }
                });
            });

            o.modalParameterEditor.find("#modalRulesClose").on("click", function () {
                o.appvm[id].configjson(JSON.stringify(configjson)), o.modalParameterEditor.modal("hide"); o.modalParameterEditor.remove();
            });
            o.modalParameterEditor.modal({ keyboard: false, backdrop: "static", show: true });
            updateOpts(o, true);
        }
        function seleccionaEsquema(o, id) {
            var configjson = verifyJsonString(o.appvm[id].configjson()) ? JSON.parse(o.appvm[id].configjson()) : {};
            if (o.appvm[id].seleccionaresquema()) {
                var pjs = {}, dataattr = o.appvm[id].tipo() === o.TE.ComboDinamico ? "DataObj" : "Esquema";

                if (o.appvm[id].chosenitems() && o.appvm[id].chosenitems()[dataattr] && verifyJsonString(o.appvm[id].chosenitems()[dataattr]))
                    pjs = JSON.parse(o.appvm[id].chosenitems()[dataattr]);

                _.forEach(_.keys(configjson), function (ekey) {
                    //migrar versión anterior de esquemas
                    configjson[ekey] && (configjson[ekey] = configjson[ekey].match(/formElec_element[0-9]+/)[0]);
                    var valuetoset = "";
                    if (o.appvm[id].tipo() === o.TE.ComboDinamico)
                        valuetoset = pjs.hasOwnProperty(ekey) ? pjs[ekey] : "";
                    else {
                        var selection = _.find(pjs, { Campo: ekey });
                        if (!!selection && !!selection.Valor) valuetoset = selection.Valor;
                    }
                    !!o.appvm[configjson[ekey]] && (o.appvm[configjson[ekey]].tipo() === o.TE.Texto ?
                        o.appvm[configjson[ekey]].valormetadato(valuetoset) : o.appvm[configjson[ekey]].valor(valuetoset));
                });
            }
            o.appvm[id].seleccionaresquema(!0);
        }



        //Configurador de tabber
        function redrawSectionsOnTabber(o, jelemid, jparent) {
            if (!jparent)
                jparent = searchElementInJson(o, o.appvm[jelemid].elementopadre());

            o.appvm[jparent["@idelemento"]].tabids([]);
            var showed = false;
            for (var i = 0; i < jparent.elementos.elemento.length; i++) {
                var idchild = jparent.elementos.elemento[i]["@idelemento"];
                o.appvm[idchild].mostrar(false);
                if (!showed && o.appvm[idchild].habilitado()) {
                    o.appvm[idchild].mostrar(true);//para mostrar el primer tab habilitado disponible
                    showed = true;
                }
                o.appvm[idchild].modotab(true);
                o.appvm[idchild].campo("big");//para que aparezca tamaño completo como una pagina
                o.appvm[jparent["@idelemento"]].tabids.push(idchild);
            }
        }
        function removeSectionFromTabber(o, idremove) {
            o.appvm[idremove].modotab(false);
        }



        //Configurador genérico
        function configInterface(attr, idoftype, oriidelem) {
            var o = getOpts(), ekeys = _.keys(o.appvm[o.idPlantilla][attr]()), looktime,
                attrDescr = getDescriptionByAttr(attr);
            showHideLoading(o), initializeDataByAttr(o, attr), showHideLoading(o, false);
            o.configModal = $('<div class="modal">\
                <div class="modal-dialog modal-xl" style="width: 95%; max-width: 95%;">\
                    <div class="modal-content rounded">\
                        <div class="modal-body no-padding row">\
                            <div class="col-md-4 col-sm-12 no-padding">\
                                <div class="col-sm-12 col-12 p-2 d-flex searcherTab">\
                                    <input class="col-sm-12 col-12 rounded-pill border" id="searcherList" placeholder="Buscar...">\
                                    <div class="fas fa-search position-absolute" id="searcherIconList" style="right:6%;cursor:pointer;bottom:30%"></div>\
                                </div>\
                                <div class="py-5 text-center text-muted border-top noconfiglist">No existen configuraciones</div>\
                                <ul class="configlist p-0" style="max-height:75vh; overflow:auto"></ul>\
                            </div>\
                            <div class="col-md-8 col-sm-12">\
                                <h5 class="col-12 py-2 px-0 border-bottom">' + attrDescr.tit + '</h5>'
                + (!attrDescr.desc ? '' : '<div class="pt-2" style="position: absolute; top: 0; right: 0; z-index: 10;">\
                                        <div class="d-inline-flex justify-content-center pr-2" style="float: right;">\
                                            <i class="infobutton far fa-question-circle" style="cursor:pointer; height:fit-content;font-size:2.5rem; color: #28699f"></i></div>\
                                 <div class="rounded p-2 infotext border text-muted" style="background-color: #f6f8fa; margin: 30px 10px 10px 10px; display: none;">' + attrDescr.desc + '</div></div>') +
                '<div class="card collectionelements mt-3" style="min-height: 50vh;"><div class="p-2" style="min-height:50vh"></div></div>\
                            </div>\
                        </div>\
                        <div class="modal-footer p-2 justify-content-between no-border">\
                            <div class="modalnew btn btn-primary btn-sm"><i class="fas fa-plus mr-2"></i>Agregar</div>\
                            <div class="modalclose btn btn-light border ml-2 btn-sm">Cerrar</div>\
                        </div>\
                    </div>\
                </div>\
            </div>');
            $("body").append(o.configModal), o.configModal.modal({ keyboard: !1, backdrop: "static", show: !0 }), modalIsEmpty(o, attr);
            o.configModal.find(".modalclose").on("click", function () {
                o.initializedData = [], o.configModal.modal("hide"), o.configModal.remove(), clearInterval(looktime);
                $("body .panel.combo-p:not('visible')").remove(); //se quitan todos los combos de easyui escondidos que generan alentamiento en la pagina
                if (idoftype)  //se abre de nuevo el editor universal con los posibles cambios
                    infoModElements(oriidelem);
            });
            o.configModal.find(".modalnew").on("click", function () { o.infodataisact = !1, drawElementInList(void 0, attr, !0), modalIsEmpty(o, attr); });
            o.configModal.find("#searcherList").on("keyup", function (e) {
                clearInterval(looktime);
                if (e.keyCode === 13) filterElementList(o, e.target.value, attr);
                else looktime = setInterval(function () { filterElementList(o, e.target.value, attr), clearInterval(looktime); }, 1000);
            });
            o.configModal.find("#searcherIconList").on("click", function (e) {
                clearInterval(looktime), filterElementList(o, e.target.value, attr);
            });
            o.configModal.find(".infobutton").on("click", function (e) { o.configModal.find(".infotext").slideToggle("fast"); });
            o.configModal.find(".infobutton").effect("pulsate", 2000).effect("highlight", 1000);
            if (!idoftype) //id de type para prebusqueda
                _.forEach(ekeys, function (v) { drawElementInList(v, attr); });
            else
                drawElementInList(idoftype, attr, true);
        }
        function drawElementInList(eKey, attr, checkandshow, isinfoelem, isFilter) {
            var o = getOpts(), mo;
            if (isinfoelem) mo = $("<div class='clistrow elem" + eKey + "'><span class='elelistname w-100 d-inline-block text-break'>" + o.appvm[eKey].titulo() + " (" + o.appvm[eKey].tipo() + ")" + "</span></div>");
            else {
                var cbDelete = function () {
                    o.infodataisact = !1, mo.remove(), o.configModal.find("div.collectionelements div[id='elem" + eKey + "']").remove(), delete o.appvm[o.idPlantilla][attr]()[eKey], modalIsEmpty(o, attr);
                    attr === "pdfmapping" && crudFilePlant(o, eKey, 4);
                };
                eKey ? o.appvm[o.idPlantilla][attr]()[eKey] = getObjectByAttr(attr, o.appvm[o.idPlantilla][attr]()[eKey]) : (eKey = getGuidForElem(o, attr, ""), o.appvm[o.idPlantilla][attr]()[eKey] = getObjectByAttr(attr));
                var nameele = o.appvm[o.idPlantilla][attr]()[eKey].customname ? "customname" : "name",
                    enabledclass = o.appvm[o.idPlantilla][attr]()[eKey].enabled !== undefined ? o.appvm[o.idPlantilla][attr]()[eKey].enabled ? "class='no-margin cenabled enablecircle ruleenabled" + eKey + "' title='Activa' "
                        : "class='no-margin cdisabled enablecircle ruleenabled" + eKey + "' title='Inactiva'" : "";
                mo = $(`<li class='clistrow elem${eKey}' idtag='${eKey}'>
                    <span class='elelistname w-50 d-inline-block'>${o.appvm[o.idPlantilla][attr]()[eKey][nameele]}</span>
                    <span style='float: right;'>
                        <div ${enabledclass}></div>
                        ${(!isFilter ? "<i class='rulemove float-right fas fa-arrows-alt pl-1' title='Mover'></i>" : "")}
                        <i class='ruledelete far fa-trash-alt pl-1' title='Eliminar'></i>
                        <i class='ruleedit float-right fas fa-pencil-alt pl-1' title='Editar nombre'></i>
                        <i class='rulecopy float-right far fa-copy pl-1' title='Copiar y pegar al final'></i>
                    </span>
                </li>`);
                mo.find(".ruledelete").on("click", function (e) {
                    e.stopPropagation(), Confirmacion('¿Seguro desea eliminar: ' + o.appvm[o.idPlantilla][attr]()[eKey][nameele] + '?', cbDelete);
                });
                mo.find(".rulecopy").on("click", function (e) {
                    e.stopPropagation();
                    var copyElemList = _.cloneDeep(o.appvm[o.idPlantilla][attr]()[eKey]), nKey = getGuidForElem(o, attr, "");
                    copyElemList[nameele] = copyElemList[nameele] + " - copia", o.appvm[o.idPlantilla][attr]()[nKey] = copyElemList, drawElementInList(nKey, attr);
                });
                mo.find(".ruletags").on("click", function (e) {
                    e.stopPropagation();
                });
                var memopen = mo.find(".ruleedit");
                memopen.on("click", function (e) {
                    e.stopPropagation();
                    var espan, einput, newname = "";
                    if (memopen.is(":visible")) {
                        espan = mo.find('span.elelistname'), newname = espan.text(), einput = $('<input style="width:60%"/>').val(newname);
                        espan.replaceWith(einput), memopen.attr("hidden", "").css({ pointerEvents: "none" }), mo.find("input").focus();
                    } else {
                        o.infodataisact = !1, einput = mo.find('input'), newname = einput.val(), espan = $('<span class="elelistname w-50 d-inline-block"></span>').text(newname);
                        einput.replaceWith(espan), memopen.removeAttr("hidden").css({ pointerEvents: "auto" });
                    }
                    o.appvm[o.idPlantilla][attr]()[eKey][nameele] = newname, mo.find("input").on("click", function (e) { e.stopPropagation(); });
                    mo.find("input").on("keyup blur", function (e) { (e.keyCode === 13 || !e.keyCode) && memopen.click(); });
                });
                mo.find('.ruleenabled' + eKey).on("click", function (e) {
                    e.stopPropagation();
                    mo.find('.ruleenabled' + eKey).hasClass('cenabled') ?
                        (o.appvm[o.idPlantilla][attr]()[eKey].enabled = !1, mo.find('.ruleenabled' + eKey).removeClass('cenabled').addClass('cdisabled'), mo.find('.ruleenabled' + eKey).attr('title', 'Inactiva'))
                        : (o.appvm[o.idPlantilla][attr]()[eKey].enabled = !0, mo.find('.ruleenabled' + eKey).removeClass('cdisabled').addClass('cenabled'), mo.find('.ruleenabled' + eKey).attr('title', 'Activa'));
                });
                $(".configlist").sortable({
                    revert: true, placeholder: "clistrow-highlight",
                    start: (ev, ui) => { ui.placeholder.height(ui.item.outerHeight()); },
                    handle: ".fa-arrows-alt",
                    stop: function (ev, ui) {
                        if (!$("#searcherList").val()) {
                            var copyattr = {}, attrcop = "";
                            _.forEach($(".configlist").children(".clistrow"), function (domelem) {
                                attrcop = domelem.getAttribute("idtag");
                                if (o.appvm[o.idPlantilla][attr]()[attrcop]) copyattr[attrcop] = o.appvm[o.idPlantilla][attr]()[attrcop];
                            });
                            o.appvm[o.idPlantilla][attr](copyattr);
                        }
                        else $(this).sortable("cancel"), toasty('', 'Elimine el filtro de búsqueda para poder mover un registro', 'info');
                    }
                });
            }
            mo.on("click", function () {
                o.configModal.find(".clistrow.selected").removeClass("selected"), mo.addClass("selected"), drawElementByAttr(eKey, attr);
            });
            o.configModal.find(".configlist").append(mo[0]), !!checkandshow && mo.click();
        }
        function getGuidForElem(o, attr, idelem, type, idparentelem, idpelem) {
            var elem = _.includes(["conditions", "actions", "identifiers", "steps"], type) ? o.appvm[o.idPlantilla][attr]()[idparentelem][type]
                : type === "consubj" ? o.appvm[o.idPlantilla].reglas()[idparentelem].conditions[idpelem].subject : o.appvm[o.idPlantilla][attr]();
            idelem = guid().replace(/[-\d]/g, "") + guid().replace(/[-\d]/g, "");
            return elem[idelem] ? getGuidForElem(o, attr, idelem, type, idparentelem, idpelem) : idelem;
        }
        function modalIsEmpty(o, attr) {
            var ekeys = attr === "elementosplantilla" ? _.filter(_.keys(o.appvm), function (vel) { return vel.indexOf("formElec_element") >= 0; }) : _.keys(o.appvm[o.idPlantilla][attr]());
            o.configModal.find(".noconfiglist").attr("hidden", !_.isEmpty(ekeys));
        }
        function filterElementList(o, word, attr) {
            o.configModal.find("div.collectionelements div[id^='elem']").remove();
            var elm, filter = !1, eobjs = attr === "elementosplantilla" ? o.appvm : o.appvm[o.idPlantilla][attr](),
                ekeys = attr === "elementosplantilla" ? _.filter(_.keys(eobjs), function (elm) { return elm.indexOf("formElec_element") >= 0; }) : _.keys(eobjs);
            !!word && (filter = !0); o.configModal.find(".clistrow").remove();
            _.forEach(ekeys, function (v) { elm = eobjs[v].customname || eobjs[v].name || eobjs[v].titulo() || ""; (!filter || elm.toLowerCase().indexOf(word.toLowerCase()) >= 0) && (attr === "elementosplantilla" ? drawElementInList(v, "elementosplantilla", undefined, !0, !0) : drawElementInList(v, attr, !1, !1, !0)); });
        }
        function drawElementByAttr(eKey, attr) {
            var o = getOpts(), obelem;
            o.configModal.find("div.collectionelements div[id^='elem']").remove(), o.appvm[o.idPlantilla][attr] && (obelem = o.appvm[o.idPlantilla][attr]()[eKey]);
            o.configModal.find("div.collectionelements div").append("<div id='elem" + eKey + "' class='h-100'></div>");
            switch (attr) {
                case "servicios": drawNewRowJSON(o, eKey, obelem, "servicios", o.datatags.servicesList); break;
                case "operacionesmatematicas": drawOperation(o, eKey); break;
                case "reglas": drawRule(o, eKey); break;
                case "components": drawNewRowJSON(o, eKey, obelem, "components", o.datatags.componentsList); break;
                case "prefilleddata": drawNewRowPrefill(o, eKey); break;
                case "elementosplantilla": drawNewRowInfoElem(o, eKey); break;
                case "pdfmapping": drawNewRowFileMapping(o, eKey); break;
                case "metadatamapping": drawNewRowMetadataMapping(o, eKey); break;
                case "macros": drawMacro(o, eKey); break;
            }
        }
        function getObjectByAttr(attr, curobj) {
            var elemObj;
            switch (attr) {
                case "servicios": case "components": elemObj = {
                    customname: !curobj || !curobj.customname ? attr === "servicios" ? "Servicio" : "Componente" : curobj.customname,
                    id: !curobj || !curobj.id ? "" : curobj.id, pin: !curobj || !curobj.pin ? {} : curobj.pin,
                    pout: !curobj || !curobj.pout ? {} : curobj.pout, response: !curobj || !curobj.response ? {} : curobj.response,
                    initialmethod: !curobj || !curobj.initialmethod ? "" : curobj.initialmethod,
                    assemblypath: !curobj || !curobj.assemblypath ? "" : curobj.assemblypath,
                    prefijoentrada: !curobj || !curobj.prefijoentrada ? "" : curobj.prefijoentrada,
                    prefijosalida: !curobj || !curobj.prefijosalida ? "" : curobj.prefijosalida,
                    data: {}, //siempre esta vacio ya que se llena al enviarse al servicio
                    enabled: !curobj || curobj.enabled === undefined ? !0 : curobj.enabled
                }; break;
                case "operacionesmatematicas": elemObj = {
                    customname: !curobj || !curobj.customname ? "Operaci&oacute;n" : curobj.customname,
                    identifiers: !curobj || !curobj.identifiers ? {} : curobj.identifiers,
                    formula: !curobj || !curobj.formula ? "" : curobj.formula,
                    enabled: !curobj || curobj.enabled === undefined ? !0 : curobj.enabled,
                    stringConcat: !curobj || curobj.stringConcat === undefined ? !1 : curobj.stringConcat
                }; break;
                case "reglas": elemObj = {
                    name: !curobj || !curobj.name ? "Regla" : curobj.name,
                    logic: !curobj || !curobj.logic ? "all" : curobj.logic,
                    conditions: !curobj || !curobj.conditions ? {} : curobj.conditions,
                    actions: !curobj || !curobj.actions ? {} : curobj.actions,
                    enabled: !curobj || curobj.enabled === undefined ? !0 : curobj.enabled
                }; break;
                case "prefilleddata": elemObj = {
                    idplantilla: !curobj || !curobj.idplantilla ? "" : curobj.idplantilla,
                    fullscreenformat: !curobj || curobj.fullscreenformat === undefined ? !1 : curobj.fullscreenformat,
                    newwindow: !curobj || curobj.newwindow === undefined ? !1 : curobj.newwindow,
                    mapeo: !curobj || !curobj.mapeo ? {} : curobj.mapeo,
                    name: !curobj || !curobj.name ? "Prellenado" : curobj.name,
                    isLocal: !curobj || curobj.isLocal === undefined ? !1 : curobj.isLocal,
                    guidtoopen: !curobj || curobj.guidtoopen === undefined ? "" : curobj.guidtoopen
                }; break;
                case "pdfmapping":
                    elemObj = {
                        customname: !curobj || !curobj.customname ? "Archivo" : curobj.customname,
                        mapeo: !curobj || !curobj.mapeo ? {} : curobj.mapeo,
                        filename: !curobj || !curobj.filename ? "" : curobj.filename,
                        tipodochijo: !curobj || !curobj.tipodochijo ? "" : curobj.tipodochijo,
                        enabled: !curobj || curobj.enabled === undefined ? !1 : curobj.enabled,
                        downloadtype: !curobj || !curobj.downloadtype ? "PDF" : curobj.downloadtype
                    }; break;
                case "metadatamapping": elemObj = {
                    filemapping: !curobj || !curobj.filemapping ? "" : curobj.filemapping,
                    mapeo: !curobj || !curobj.mapeo ? {} : curobj.mapeo,
                    name: !curobj || !curobj.name ? "Metadatos" : curobj.name
                }; break;
                case "macros": elemObj = {
                    name: !curobj || !curobj.name ? "Nueva macro" : curobj.name,
                    steps: !curobj || !curobj.steps ? {} : curobj.steps
                }; break;
            }
            return elemObj;
        }
        function initializeDataByAttr(o, attr) {
            var pag, tabl; o.initializedData = {};
            switch (attr) {
                case "servicios": case "components":
                    o.initializedData.aggroupeddata = [], o.initializedData.aggroupedrules = [];
                    _.forEach(_.keys(o.appvm), function (v) {
                        v.indexOf("formElec_element") === 0 &&
                            o.initializedData.aggroupeddata.push({ id: v, nombre: o.appvm[v].tipo() + "-" + o.appvm[v].titulo() + (_.isEmpty(o.appvm[v].idunico()) ? "" : " (" + o.appvm[v].idunico() + ")"), grupo: o.appvm[v].tipo(), parentpage: o.appvm[v].elementopadre() ? o.appvm[o.appvm[v].elementopadre()].titulo() : "", tipolista: o.appvm[v].tipo() === o.TE.Lista ? o.appvm[v].tipolista() : "" });
                    });
                    o.initializedData.aggroupedrules = _.map(_.keys(o.appvm[o.idPlantilla].reglas()), function (f) { return { nombre: o.appvm[o.idPlantilla].reglas()[f].name, id: f }; });
                    o.initializedData.aggroupeddata = _.groupBy(o.initializedData.aggroupeddata, 'grupo');
                    break;
                case "operacionesmatematicas":
                    o.initializedData.numberElem = [], o.initializedData.numberStringElem = [];
                    _.forEach(_.keys(o.appvm), function (v) {
                        v.indexOf("formElec_element") === 0 && _.includes([o.TE.Numero, o.TE.Moneda, o.TE.Deslizante, o.TE.Texto, o.TE.TextArea, o.TE.ComboDinamico], o.appvm[v].tipo()) &&
                            (o.initializedData.numberElem.push({ id: v, nombre: o.appvm[v].tipo() + "-" + o.appvm[v].titulo() + (_.isEmpty(o.appvm[v].idunico()) ? "" : " (" + o.appvm[v].idunico() + ")"), grupo: o.appvm[v].tipo(), parent: o.appvm[o.appvm[v].elementopadre()].titulo() }),
                                o.initializedData.numberStringElem.push({ id: v, nombre: o.appvm[v].titulo(), grupo: o.appvm[v].tipo(), parent: o.appvm[o.appvm[v].elementopadre()].titulo() }));
                    });
                    _.forEach(o.datatags.reglasInfoDocUsr, function (v) {
                        o.initializedData.numberStringElem.push({ id: v.Valor, nombre: v.Nombre, grupo: "", parent: v.Grupo });
                    });
                    break;
                case "reglas":
                    o.initializedData.elemsforRules = [];
                    for (var elem in o.appvm)
                        elem.indexOf("formElec_element") >= 0 && (tabl = getElementByTypeByParents(o, o.appvm[elem].elementopadre(), o.TE.Tabla),
                            pag = getElementByTypeByParents(o, o.appvm[elem].elementopadre(), o.TE.Pagina), o.initializedData.elemsforRules.push({
                                id: elem,
                                nom: (o.idPlantilla === elem ? "Formato" : _.capitalize(o.appvm[elem].tipo())) + "-" + o.appvm[elem].titulo() + (_.isEmpty(o.appvm[elem].idunico()) ? "" : " (" + o.appvm[elem].idunico() + ")"),
                                tipo: o.appvm[elem].tipo(),
                                tabla: tabl,
                                group: o.idPlantilla === elem ? "Formato" :
                                    o.appvm[elem].tipo() === o.TE.Pagina ? "Paginas" :
                                        tabl !== "" ? "Tabla-" + o.appvm[tabl].titulo() : "Pagina-" + o.appvm[pag].titulo()
                            }));
                    o.initializedData.elemsforRules = _.sortBy(o.initializedData.elemsforRules, ["group"]);
                    break;
                case "prefilleddata":
                    o.initializedData.elemscurrtemplate = [];
                    _.forEach(_.keys(o.appvm), function (v) {
                        v.indexOf("formElec_element") === 0 && (_.includes(o.flexibleelement, o.appvm[v].tipo()) || o.appvm[v].tipo() === o.TE.Tabla) && o.initializedData.elemscurrtemplate.push({ id: v, nombre: o.appvm[v].tipo() + "-" + o.appvm[v].titulo() + (_.isEmpty(o.appvm[v].idunico()) ? "" : " (" + o.appvm[v].idunico() + ")"), grupo: o.appvm[v].tipo(), padre: o.appvm[o.appvm[v].elementopadre()].titulo(), idpadre: o.appvm[v].elementopadre() });
                    });
                    break;
                case "metadatamapping":
                    o.initializedData.elemscurrtemplate = [], o.initializedData.elemsfilemapping = [];
                    _.forEach(_.keys(o.appvm), function (v) {
                        v.indexOf("formElec_element") === 0 && _.includes(o.flexibleelement, o.appvm[v].tipo()) && o.appvm[o.appvm[v].elementopadre()].tipo() === o.TE.Tabla && o.initializedData.elemscurrtemplate.push({ id: v, nombre: o.appvm[v].tipo() + " - " + o.appvm[v].titulo() + (_.isEmpty(o.appvm[v].idunico()) ? "" : " (" + o.appvm[v].idunico() + ")"), grupo: o.appvm[v].tipo(), padre: o.appvm[o.appvm[v].elementopadre()].titulo(), idpadre: o.appvm[v].elementopadre() });
                    });
                    _.forEach(_.keys(o.appvm[o.idPlantilla].pdfmapping()), function (v) {
                        o.initializedData.elemsfilemapping.push({ Valor: v, Nombre: o.appvm[o.idPlantilla].pdfmapping()[v].customname });
                    });
                    break;
                case "pdfmapping":
                    o.initializedData.elmsmapping = [], o.initializedData.imgsNames = [];
                    _.forEach(_.keys(o.appvm), function (v) {
                        if (v.indexOf("formElec_element") === 0 && (_.includes(o.flexibleelement, o.appvm[v].tipo()) || _.includes([o.TE.Logo, o.TE.Leyenda, o.TE.Georeferencia, o.TE.Mapa, o.TE.FirmaFAD, o.TE.Imagen], o.appvm[v].tipo()))) {
                            if (_.includes([o.TE.CodigoBarras, o.TE.CodigoQR, o.TE.Georeferencia, o.TE.Mapa], o.appvm[v].tipo())) {
                                o.initializedData.elmsmapping.push({ id: v, nombre: o.appvm[v].titulo() + " ({0})".format(o.appvm[v].tipo()), grupo: o.appvm[v].tipo(), padre: o.appvm[o.appvm[v].elementopadre()].titulo(), idpadre: o.appvm[v].elementopadre(), isattach: !1 });
                                o.initializedData.elmsmapping.push({ id: v + "_a", nombre: o.appvm[v].titulo() + " (anexo)".format(o.appvm[v].tipo()), grupo: o.appvm[v].tipo(), padre: o.appvm[o.appvm[v].elementopadre()].titulo(), idpadre: o.appvm[v].elementopadre(), isattach: !0 });
                            }
                            else if (_.includes([o.TE.Imagen], o.appvm[v].tipo()))
                                o.initializedData.elmsmapping.push({ id: v + "_a", nombre: o.appvm[v].titulo() + " (anexo)".format(o.appvm[v].tipo()), grupo: o.appvm[v].tipo(), padre: o.appvm[o.appvm[v].elementopadre()].titulo(), idpadre: o.appvm[v].elementopadre(), isattach: !0 });
                            else if (_.includes([o.TE.FirmaFAD], o.appvm[v].tipo())) {
                                o.initializedData.elmsmapping.push({ id: v, nombre: o.appvm[v].titulo() + " ({0})".format(o.appvm[v].tipo()), grupo: o.appvm[v].tipo(), padre: o.appvm[o.appvm[v].elementopadre()].titulo(), idpadre: o.appvm[v].elementopadre(), isattach: !1 });
                                o.initializedData.elmsmapping.push({ id: v + "_a", nombre: o.appvm[v].titulo() + " (anexo)".format(o.appvm[v].tipo()), grupo: o.appvm[v].tipo(), padre: o.appvm[o.appvm[v].elementopadre()].titulo(), idpadre: o.appvm[v].elementopadre(), isattach: !0 });
                            }
                            else o.initializedData.elmsmapping.push({ id: v, nombre: o.appvm[v].titulo() + " ({0})".format(o.appvm[v].tipo()), grupo: o.appvm[v].tipo(), padre: o.appvm[o.appvm[v].elementopadre()].titulo(), idpadre: o.appvm[v].elementopadre(), isattach: !1 });
                        }
                    });
                    $.ajax({
                        url: o.datasend.urlGlobal + 'FEConfigurador.aspx/CrudImages',
                        data: JSON.stringify({ expid: o.datasend.expId, tipodocid: o.datasend.tipoDocId, id: "", filename: "", datos: "", modo: 4 }),
                        type: "POST", contentType: "application/json; charset=utf-8",
                        success: function (j) {
                            j = j.d;
                            if (j.Success)
                                for (var i = 0; i < j.ReturnedObject.length; i++)
                                    o.initializedData.imgsNames.push({ id: j.ReturnedObject[i][0], fn: j.ReturnedObject[i][1] });
                        }
                    });
                    break;
                case "elementosplantilla":
                    o.infodata.byrulescond = {}, o.infodata.byrulesact = {}, o.infodata.byservices = {},
                        o.infodata.bycomponents = {}, o.infodata.bycalcs = {}, o.infodata.byprefill = {}, o.infodata.byservicesidunicos = {};
                    _.forEach(_.keys(o.appvm[o.idPlantilla].reglas()), function (elmkey) {
                        _.forEach(_.keys(o.appvm[o.idPlantilla].reglas()[elmkey].actions), function (elmkeyact) {
                            _.forEach(_.keys(o.appvm[o.idPlantilla].reglas()[elmkey].actions[elmkeyact].subject), function (elmkeyactsub) {
                                !!elmkeyactsub && _.forEach(elmkeyactsub.split(","), function (subjsp) {
                                    !o.infodata.byrulesact[subjsp] && (o.infodata.byrulesact[subjsp] = []);
                                    !_.find(o.infodata.byrulesact[subjsp], { rul: elmkey }) && o.infodata.byrulesact[subjsp].push({ rul: elmkey, id: elmkeyact, desc: getDescForUniversal(o, "act", o.appvm[o.idPlantilla].reglas()[elmkey].actions[elmkeyact]) });
                                });
                            });
                        });
                        _.forEach(_.keys(o.appvm[o.idPlantilla].reglas()[elmkey].conditions), function (elmkeycond) {
                            _.forEach(_.keys(o.appvm[o.idPlantilla].reglas()[elmkey].conditions[elmkeycond].subject), function (elmkeycondsub) {
                                var subjt = o.appvm[o.idPlantilla].reglas()[elmkey].conditions[elmkeycond].subject[elmkeycondsub].subject;
                                !!subjt && _.forEach(subjt.split(","), function (subjsp) {
                                    !o.infodata.byrulescond[subjsp] && (o.infodata.byrulescond[subjsp] = []);
                                    !_.find(o.infodata.byrulescond[subjsp], { rul: elmkey }) && o.infodata.byrulescond[subjsp].push({ rul: elmkey, id: elmkeycond, desc: getDescForUniversal(o, "cond", o.appvm[o.idPlantilla].reglas()[elmkey].conditions[elmkeycond].subject[elmkeycondsub]) });
                                });
                            });
                        });
                    });
                    _.forEach(_.keys(o.appvm[o.idPlantilla].servicios()), function (elmkey) {
                        //se obtienen los dos prefijos de cada servicio que tenga initialmethod
                        if (!_.isEmpty(o.appvm[o.idPlantilla].servicios()[elmkey].prefijoentrada) && !_.isEmpty(o.appvm[o.idPlantilla].servicios()[elmkey].prefijosalida))
                            o.infodata.byservicesidunicos[elmkey] = { pe: o.appvm[o.idPlantilla].servicios()[elmkey].prefijoentrada, ps: o.appvm[o.idPlantilla].servicios()[elmkey].prefijosalida };
                    });
                    _.forEach(_.keys(o.appvm[o.idPlantilla].components()), function (elmkey) {
                        _.forEach(_.keys(o.appvm[o.idPlantilla].components()[elmkey].pin), function (elmkeypinsub) {
                            var subjt = o.appvm[o.idPlantilla].components()[elmkey].pin[elmkeypinsub].idelem;
                            !!subjt && _.forEach(subjt.split(","), function (subjsp) {
                                !o.infodata.bycomponents[subjsp] && (o.infodata.bycomponents[subjsp] = []);
                                !_.includes(o.infodata.bycomponents[subjsp], elmkey) && o.infodata.bycomponents[subjsp].push(elmkey);
                            });
                        });
                    });
                    _.forEach(_.keys(o.appvm[o.idPlantilla].prefilleddata()), function (elmkey) {
                        var mapparelem = o.appvm[o.idPlantilla].prefilleddata()[elmkey].mapeo;
                        _.forEach(_.keys(mapparelem), function (mapsonkey) {
                            var mapsonelem = mapparelem[mapsonkey];
                            if (mapsonelem.tipoRel === "istable") {
                                !o.infodata.byprefill[mapsonelem.idelem] && (o.infodata.byprefill[mapsonelem.idelem] = []);
                                !_.includes(o.infodata.byprefill[mapsonelem.idelem], elmkey) && o.infodata.byprefill[mapsonelem.idelem].push(elmkey);
                            }
                            _.forEach(_.keys(mapsonelem.mapeoHijos), function (mapsonsonelem) {
                                var elemidmat = mapsonelem.mapeoHijos[mapsonsonelem].idelem;
                                !o.infodata.byprefill[elemidmat] && (o.infodata.byprefill[elemidmat] = []);
                                !_.includes(o.infodata.byprefill[elemidmat], elmkey) && o.infodata.byprefill[elemidmat].push(elmkey);
                            });
                        });
                    });
                    _.forEach(_.keys(o.appvm[o.idPlantilla].operacionesmatematicas()), function (elmkey) {
                        var idmat = o.appvm[o.idPlantilla].operacionesmatematicas()[elmkey].identifiers;
                        _.forEach(_.keys(idmat), function (keyidmat) {
                            var elemidmat = idmat[keyidmat].idelem;
                            !o.infodata.bycalcs[elemidmat] && (o.infodata.bycalcs[elemidmat] = []);
                            !_.includes(o.infodata.bycalcs[elemidmat], elmkey) && o.infodata.bycalcs[elemidmat].push(elmkey);
                        });
                    });
                    o.infodataisact = !0;
                    break;
                case "macros":
                    o.initializedData.elemsforSteps = [];
                    for (let elem in o.appvm)
                        elem.indexOf("formElec_element") >= 0 && !_.includes([o.TE.OCR], o.appvm[elem].tipo()) && (tabl = getElementByTypeByParents(o, o.appvm[elem].elementopadre(), o.TE.Tabla),
                            pag = getElementByTypeByParents(o, o.appvm[elem].elementopadre(), o.TE.Pagina), o.initializedData.elemsforSteps.push({
                                id: elem,
                                nom: (o.idPlantilla === elem ? "Formato" : _.capitalize(o.appvm[elem].tipo())) + "-" + o.appvm[elem].titulo() + (_.isEmpty(o.appvm[elem].idunico()) ? "" : " (" + o.appvm[elem].idunico() + ")"),
                                tipo: o.appvm[elem].tipo(),
                                tabla: tabl,
                                group: o.idPlantilla === elem ? "Formato" :
                                    o.appvm[elem].tipo() === o.TE.Pagina ? "Paginas" :
                                        tabl !== "" ? "Tabla-" + o.appvm[tabl].titulo() : "Pagina-" + o.appvm[pag].titulo()
                            }));
                    o.initializedData.elemsforSteps = _.sortBy(o.initializedData.elemsforSteps, ["group"]);
                    break;
            }
        }
        function getDescriptionByAttr(attr) {
            var ob = { desc: "", tit: "" };
            switch (attr) {
                case "reglas":
                    ob.desc = "Puede crear diversas reglas de negocio para cada elemento, ya sea alterando en cada elemento sus propiedades o categorizando las reglas en este modulo.";
                    ob.tit = 'Reglas'; break;
                case "operacionesmatematicas":
                    ob.desc = `Las operaciones matemáticas sirven para realizar calculos basicos que no se pueden realizar por medio de "Reglas".<br/>
                    Lo primero que debe de hacer es agregar identificadores. Los identificadores son los involucrados en su operacion y deben de contener un nombre único.<br/>
                    <strong>Es recomendable que contengan al menos UNA LETRA Y UN NÚMERO. Evite repetir los identificadores. No deje espacio en el nombre del identificador. No se permiten símbolos.</strong><br/>
                    Ejemplo de Identificadores<br/>
                    <ul>
                        <li>
                            Si el campo se llama "Cantidad" se recomienda usar un identificador como "Cant" ó "Cantidad"
                        </li>
                        <li>
                            Si el campo se llama "Nombre de la persona" se recomienda usar un identificador como "Nom" ó "Nombre".
                        </li>
                        <li>
                            Si el campo se llama "Observaciones (Opcional)" se recomienda usar un identificador como "Obs" ú "Observaciones".
                        </li>
                    </ul>
                    Para crear formulas de operaciones se debe tener lo siguiente en consideración.
                    <ul>
                        <li>
                            Todas las formulas deben de tener un simbolo de IGUAL (=)
                        </li>
                        <li>
                            Puede haber espacios en la formula pero no en los identificadores. Ej: total = cant * <strong style="color: red;">precio producto</strong>
                        </li>
                        <li>
                            Por cada identificador debe haber un simbolo de operación. Ej: total = cant * (precio + iva)
                        </li>
                    </ul>
                    Ejemplo de como configurar sus operaciones.<br/>
                    <ul>
                        <li>
                            <strong>Suma, Resta, División, Multiplicación</strong><br/>
                            total = precio1 + precio2 - precio3 * precio4 / precio5
                        </li>
                        <li>
                            <strong>entero, log, ln y redondear</strong><br/>
                            Puede usar entero, log, ln, redondear seguido de parentesis encerrando un solo número que desea calcular.<br/>
                            La palabra entero es equivalente a truncar un número.<br/>
                            La palabra log es equivalente a el Logaritmo de un número.<br/>
                            La palabra ln es equivalente a el Logaritmo Natural un número.<br/>
                            La palabra redondear es equivalente a redondear hacia arriba o hacia abajo un número.<br/>
                            total = entero(precio1) + log(precio2) - ln(precio3) * redondear(precio4 / precio5)
                        </li>
                        <li>
                            <strong>max, min, promedio</strong><br/>
                            Puede usar máximo, mínimo y promedio seguido de parentesis encerrando todos los números que desea calcular cada uno separado por coma.<br/>
                            total = max(precio1 + precio2) - min(precio3, precio4, precio5)
                        </li>
                        <li>
                            <strong>Totales dentro de tablas</strong><br/>
                            Para esta fórmula considere lo siguiente:

                            <ul>
                                <li>Utilizar el prefijo <strong>tc_</strong></li>
                                <li>El identificador que se usara con el prefijo DEBE ser hijo de alguna tabla</li>
                                <li>El identificador que se usara con el prefijo DEBE estar configurado como "Campo utilizado para totalizar"</li>
                            </ul>

                            total = tc_subtotal
                        </li>
                        <li>
                            <strong>Palabras reservadas</strong><br/>
                            Puede utilizar palabras reservadas que ayudan a ciertas funcionalidades.

                            <ul>
                                <li><strong>_space_</strong> Sirve para dar salto de linea cuando quiere concatenar.</li>
                            </ul>

                            total = tc_subtotal
                        </li>
                    </ul>`;
                    ob.tit = "Operaciones Matemáticas"; break;
                case "pdfmapping":
                    ob.desc = "<ul class='pl-3 mb-0 text-justify'><li class='pb-1'>Permite la carga de múltiples archivos para relacionarlos con el tipo de documento de la plantilla actual y/o a algún documento hijo.</li>\
                        <li class='pb-1'>Para relacionar el archivo a la plantilla solo se necesita seleccionar la configuración\
                            dentro de propiedades de la plantilla (<span class='font-italic font-weight-bold'>Configuración de mapeo de archivo</span>).</li>\
                        <li class='pb-1'>Para publicar, debe estar activado (semaforo verde) y seleccionar un <span class='font-italic font-weight-bold'>Tipo de documento hijo</span>.</li>\
                        <li class='pb-1'>La opción ¿Descargar como PDF? solo funciona para la acción 'Descarga archivo actual FE' dentro de las reglas. Los documentos hijos siempre se publicarán como PDF.</li>\
                        <li>La columna <strong>Imagen por defecto</strong> proviene de las imagenes cargadas en el módulo de Almacén de imágenes. Si el elemento que se está relacionando al campo/s dentro del archivo no trae un valor \
                            asociado, se colocará la imagén seleccionada, en caso contrario, se dejará el valor/anexo cargado.</li>\
                        <li>El Excel solo funciona con la primer hoja de excel, si tiene mas de una hoja de excel exporte su excel a diferentes exceles por hoja.</li>\
                    </ul>";
                    ob.tit = "Mapeo de Archivos a publicar"; break;
                case "metadatamapping":
                    ob.desc = "Mapea los metadatos de la DOC hija correspondiente. Usar en conjunto con el módulo de mapeo de archivos.";
                    ob.tit = "Mapeo de metadatos hijos"; break;
                case "imagesUploader": ob.desc = "Permite la carga y eliminación de imagenes en formato jpg, jpeg y png.<br/>Actuales usos de las imágenes almacenadas:\
                                                <ul class='mb-1'><li>Imagen por defecto en el mapeo de elementos a archivos, en caso de que no se coloque un valor/anexo en el elemento. (Véase el módulo de <strong>Mapeo Archivo</strong> para más información de cómo usarse).</li></ul>";
                    ob.tit = "Imagen por default para publicar"; break;
                case "prefilleddata": ob.desc = ""; ob.tit = "Prellenado de plantillas"; break;
                case "servicios": ob.desc = "Estos servicios son fabricados especificamente para una funcion en particular. Su uso es unico y no debe usarse para otro proposito."; ob.tit = "Servicios Genericos"; break;
                case "components": ob.desc = ""; ob.tit = "Componentes"; break;
                case "macros": ob.desc = ""; ob.tit = "Macros"; break;
            }
            ob.desc = ob.desc.replace(/á/g, '&aacute;').replace(/é/g, '&eacute;').replace(/í/g, '&iacute;').replace(/ó/g, '&oacute;').replace(/ú/g, '&uacute;');
            return ob;
        }
        function nameElemSummary(o, id) {
            var nameelem = "";
            var padr = o.appvm[o.appvm[id].elementopadre()] ? o.appvm[o.appvm[id].elementopadre()].titulo() : "";
            o.appvm[id] && (nameelem = "{0} ({1}-{2}-{3}, padre: {4}-{5})".format(o.appvm[id].titulo(),
                o.appvm[id].tipo(),
                o.appvm[id].idunico(),
                id,
                padr,
                o.appvm[id].elementopadre()));
            return nameelem;
        }
        function elemsExist(basearray, selected, id) {
            !(selected instanceof Array) && (selected = [selected]);
            var elm = _.filter(basearray, function (sub) { return _.includes(selected, sub[id]); });
            !!elm && !(elm instanceof Array) && (elm = [elm]);
            elm = elm ? _.map(elm, id) : [];
            return _.intersection(selected, elm);
        }



        //Editor universal
        function drawNewRowInfoElem(o, eKey, fromremove) {
            var canremove = !0;
            var optsmods = ["byrulescond", "byrulesact", "byservices", "bycomponents", "bycalcs", "byprefill", "byservicesidunicos"];
            var acti = $('<div class="card p-2 my-1">\
                <h5 class="border-bottom pb-1">Jerarquia del elemento \
                    <span style="font-size: .7rem; color: #ef6a1b;"><i id="propuniv" style="cursor: pointer;" class="fas fa-bars"> Editar propiedades</i></span>&nbsp;&nbsp;\
                    <strong style="color: red; font-size: .7rem;">'+ (fromremove === !0 ? 'Compruebe si desea borrar el elemento.&nbsp;&nbsp;' : '') + '\
                    <i id="removeuniv" style="cursor: pointer;" class="fas fa-trash-alt"> Borrar</i></strong>\
                </h5>' + drawFamilyTreeElement(o, eKey) + '\
            </div>\
            <div class="card p-2 my-1">\
                <h5 class="border-bottom pb-1">Reglas</h5>\
                <strong>Por condici&oacute;n</strong>\
                <ul hidden id="byrulescond"></ul>\
                <div class="text-muted pb-2" id="byrulescondno">No existe informaci&oacute;n</div>\
                <strong>Por acci&oacute;n</strong>\
                <ul hidden id="byrulesact"></ul>\
                <div class="text-muted pb-2" id="byrulesactno">No existe informaci&oacute;n</div>\
            </div>\
            <div class="card p-2 my-1">\
                <h5 class="border-bottom pb-1">Asignacion de eventos por propiedad <strong style="color: red; font-size: .7rem;">Nueva forma de asignar reglas</strong></h5>\
                <div id="newdrawrules" class="row">\
                    <div class="col-md-6 col-sm-12">\
                        <strong>Asignarle valor</strong>\
                        <ul id="accionvalor"></ul>\
                    </div>\
                    <div class="col-md-6 col-sm-12">\
                        <strong>Visibilidad</strong>\
                        <ul id="accionvisible"></ul>\
                    </div>\
                </div>\
            </div>\
            <div class="card p-2 my-1">\
                <h5 class="border-bottom pb-1">Servicios V2 <strong style="color: red; font-size: .7rem;">Se recomienda longitud infinita con elementos relacionados a servicios.</strong></h5>\
                <ul hidden id="byservices"></ul>\
                <div class="text-muted pb-2" id="byservicesno">No existe informaci&oacute;n</div>\
            </div>\
            <div class="card p-2 my-1"><h5 class="border-bottom pb-1">Componentes</h5><ul hidden id="bycomponents"></ul><div class="text-muted pb-2" id="bycomponentsno">No existe informaci&oacute;n</div></div>\
            <div class="card p-2 my-1"><h5 class="border-bottom pb-1">Calculadora</h5><ul hidden id="bycalcs"></ul><div class="text-muted pb-2" id="bycalcsno">No existe informaci&oacute;n</div></div>\
            <div class="card p-2 my-1"><h5 class="border-bottom pb-1">Prellenado</h5><ul hidden id="byprefill"></ul><div class="text-muted pb-2" id="byprefillno">No existe informaci&oacute;n</div></div>');
            _.forEach(optsmods, function (optmod) {
                var optdatamod, appline = "";
                if (optmod === "byservicesidunicos") {
                    _.forEach(_.keys(o.infodata.byservicesidunicos), function (serv) {
                        if (o.appvm[eKey].idunico && !_.isEmpty(o.appvm[eKey].idunico())) {
                            var edit = "<i data-id='" + serv + "' style='color: #e26acf; cursor: pointer;' class='fas fa-marker'></i>";
                            if (_.startsWith(o.appvm[eKey].idunico(), o.infodata.byservicesidunicos[serv].pe))
                                appline += "<li>" + o.appvm[o.idPlantilla].servicios()[serv].customname + " (Entrada) " + edit + "</li>";
                            if (_.startsWith(o.appvm[eKey].idunico(), o.infodata.byservicesidunicos[serv].ps))
                                appline += "<li>" + o.appvm[o.idPlantilla].servicios()[serv].customname + "(Salida) " + edit + "</li>";
                        }
                    });
                    if (!_.isEmpty(appline)) canremove = !1;
                    acti.find("#byservices").append(appline);
                    acti.find("#byservices").find("li > i").each(function () {
                        $(this).on("click", function () {
                            configInterface('servicios', $(this).data("id"), eKey);
                            o.editoruniversal.find(".modalclose").click(); // se cierra para dibujar de nuevo con los cambios realizados
                        });
                    });
                }
                else {
                    o.infodata[optmod] && (optdatamod = o.infodata[optmod][eKey]);
                    if (optdatamod) {
                        _.forEach(optdatamod, function (eopt) {
                            switch (optmod) {
                                case "byrulescond": case "byrulesact": appline += "<li><strong>Regla:</strong> " + o.appvm[o.idPlantilla].reglas()[eopt.rul].name + " - " + eopt.desc + " <i data-id='" + eopt.rul + "' style='color: #e26acf; cursor: pointer;' class='fas fa-marker'></i></li>"; break;
                                case "bycomponents": appline += "<li>" + o.appvm[o.idPlantilla].components()[eopt].customname + " <i data-id='" + eopt + "' style='color: #e26acf; cursor: pointer;' class='fas fa-marker'></i></li>"; break;
                                case "bycalcs": appline += "<li>" + o.appvm[o.idPlantilla].operacionesmatematicas()[eopt].customname + " <i data-id='" + eopt + "' style='color: #e26acf; cursor: pointer;' class='fas fa-marker'></i></li>"; break;
                                case "byprefill": appline += "<li>" + o.appvm[o.idPlantilla].prefilleddata()[eopt].name + " <i data-id='" + eopt + "' style='color: #e26acf; cursor: pointer;' class='fas fa-marker'></i></li>"; break;
                            }
                        });
                        if (!_.isEmpty(appline)) canremove = !1;
                        acti.find("#" + optmod).append(appline);
                        var typeclick = "";
                        if (optmod === "byrulescond" || optmod === "byrulesact") typeclick = "reglas";
                        if (optmod === "bycomponents") typeclick = "components";
                        if (optmod === "bycalcs") typeclick = "operacionesmatematicas";
                        if (optmod === "byprefill") typeclick = "prefilleddata";
                        acti.find("#" + optmod).find("li > i").each(function () {
                            $(this).on("click", function () {
                                configInterface(typeclick, $(this).data("id"), eKey);
                                o.editoruniversal.find(".modalclose").click(); // se cierra para dibujar de nuevo con los cambios realizados
                            });
                        });
                    }
                }
                acti.find("#" + optmod + "no").hide(), acti.find("#" + optmod).removeAttr("hidden");
            });
            //nuevo dibujado y creacion de reglas
            var actions = o.infodata["byrulesact"][eKey];
            _.forEach(actions, function (eopt) {
                if (o.appvm[o.idPlantilla].reglas()[eopt.rul].actions[eopt.id].verb === "value") {
                    var pred = o.appvm[o.idPlantilla].reglas()[eopt.rul].actions[eopt.id].predicate, por = "", que = "";
                    por = pred.mode === "words" ? "Las palabras" : pred === "element" ? "Del elemento" : "De la variable";
                    que = pred.mode === "words" ? pred.value : pred === "element" ? (o.appvm[pred.value].titulo() + "-" + pred.value) : pred.value;
                    acti.find("#accionvalor").append("<li><strong>" + por + " :</strong> " + que + " <i data-id='" + eopt.rul + "' data-act='" + eopt.id + "' style='color: #e26acf; cursor: pointer;' class='fas fa-marker'></i></li>");
                }
            });
            acti.find("#newdrawrules").find("li > i").each(function () {
                $(this).on("click", function () {
                    nuevasReglasInterface($(this).data("id"), $(this).data("act"), eKey);
                    o.editoruniversal.find(".modalclose").click(); // se cierra para dibujar de nuevo con los cambios realizados
                });
            });
            acti.find("#propuniv").on("click", function () {
                drawAttributes(eKey);
                o.modalprops = $('<div class="modal">\
                    <div class="modal-dialog modal-xl" style="width: 95%; max-width: 95%;">\
                        <div class="modal-content rounded">\
                            <div class="modal-header no-padding row"><h4>Propiedades</h4></div>\
                            <div class="modal-body no-padding row"></div>\
                            <div class="modal-footer p-2 no-border">\
                                <div class="modalclose btn btn-light border">Cerrar</div>\
                            </div>\
                        </div>\
                    </div>\
                </div>');
                $("body").append(o.modalprops), o.modalprops.modal({ keyboard: !1, backdrop: "static", show: !0 });
                o.modalprops.find(".modal-body").append($("#nav-formElec_props"));
                o.modalprops.find(".modalclose").on("click", function () {
                    $("#nav-tabContent").append($("#nav-formElec_props")), $("#nav-tab a#nav-" + o.id + "file-tab").tab('show'), $("#nav-tab a#nav-" + o.id + "props-tab").attr("hidden", "true");
                    o.modalprops.modal("hide"), o.modalprops.remove(), $('.panel.combo-p').remove();
                });
            });
            acti.find("#removeuniv").on("click", function () {
                if (canremove === false)
                    toasty("No es posible borrar", "Este elemento no es posible borrarse ya que tiene reglas, componentes, servicios o algo que evita poderse borrar, favor de revisar en el editor universal que esta ligado a este elemento y quitarlo para poderlo eliminar");
                else removeElement(eKey), o.editoruniversal.find(".modalclose").click();
            });
            o.editoruniversal.find("div.collectionelements div#elem" + eKey).append(acti);
        }
        function drawElementInListInfo(eKey, autoclick, fromremove) {
            var o = getOpts();
            var mo = $("<div class='clistrow elem" + eKey + "'>\
                <span class='elelistname w-100 d-inline-block text-break'><strong>Titulo: </strong>" + o.appvm[eKey].titulo() + " <strong>Tipo: </strong> " + o.appvm[eKey].tipo() + " <strong>Metadato: </strong> " + (o.appvm[eKey].metadato ? o.appvm[eKey].metadato() : "") + " <strong>IdUnico: </strong> " + (o.appvm[eKey].idunico ? o.appvm[eKey].idunico() : "") + " <strong>Id: </strong> " + eKey + "</span>\
            </div>");
            mo.on("click", function () {
                o.editoruniversal.find(".clistrow.selected").removeClass("selected"), mo.addClass("selected");
                o.editoruniversal.find("div.collectionelements div[id^='elem']").remove();
                o.editoruniversal.find("div.collectionelements div").append("<div id='elem" + eKey + "' class='h-100'></div>");
                drawNewRowInfoElem(o, eKey, fromremove);
            });
            o.editoruniversal.find(".configlistInfo").append(mo[0]);
            autoclick === !0 && (mo.click());
        }
        function drawFamilyTreeElement(o, id) {
            return "<span>" + recursiveGetFamilyParentTree(o, o.appvm[id].elementopadre()) + "<strong>" + o.appvm[id].titulo() + " {" + o.appvm[id].idunico() + "} (" + o.appvm[id].tipo() + ") [" + id + "]</strong></span>";
        }
        function filterElementListinfo(o, word, autoclick, fromremove) {
            o.editoruniversal.find("div.collectionelements div[id^='elem']").remove();
            var ekeys = _.filter(_.keys(o.appvm), function (elm) { return elm.indexOf("formElec_element") >= 0; });
            o.editoruniversal.find(".clistrow").remove();
            if (_.isEmpty(word)) return;
            if (autoclick === !0) drawElementInListInfo(word, autoclick, fromremove);
            else {
                word = word.normalize('NFD').replace(/[\u0300-\u036f]/g, "");
                _.forEach(ekeys, function (v) {
                    if ((o.appvm[v].titulo && o.appvm[v].titulo().toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").indexOf(word.toLowerCase()) >= 0) ||
                        (o.appvm[v].idunico && o.appvm[v].idunico().toString().toLowerCase().indexOf(word.toLowerCase()) >= 0) ||
                        (o.appvm[v].metadato && o.appvm[v].metadato().toString().toLowerCase().indexOf(word.toLowerCase()) >= 0) ||
                        (o.appvm[v].tipo && o.appvm[v].tipo().toString().toLowerCase().indexOf(word.toLowerCase()) >= 0) ||
                        v.toLowerCase().indexOf(word.toLowerCase()) >= 0) drawElementInListInfo(v, autoclick);
                });
            }
        }
        function getDescForUniversal(o, typ, obj, r) {
            var fdesc = "", desc;
            switch (typ) {
                case "cond":
                    if (!obj.verb) //condicion sin verbo
                        obj.desc = "N/A";
                    desc = _.find(o.datatags.condicionesReglas, ['Valor', obj.verb]);
                    if (desc) fdesc = "<strong>Verbo:</strong> " + desc.Nombre;
                    break;
                case "act":
                    var neg = obj.negation === "not" ? "No " : "";
                    desc = _.find(o.datatags.accionesreglas, ['Valor', obj.verb]);
                    if (desc) fdesc = "<strong>Verbo:</strong> " + neg + desc.Nombre;
                    break;
            }
            return fdesc;
        }
        function getDescVerbToChange(o, rule, action, idelem) {
            var desc = '';
            switch (o.appvm[o.idPlantilla].reglas()[rule].actions[action].verb) {
                case "value":
                    desc = 'Asignación de valor al elemento ' + o.appvm[idelem].titulo(); break;
                default: break;
            }
            return desc;
        }
        function infoModElements(openid, fromremove) {
            var o = getOpts(), looktime;
            initializeDataByAttr(o, "elementosplantilla");
            o.editoruniversal = $('<div class="modal">\
                <div class="modal-dialog modal-xl" style="width: 95%; max-width: 95%;">\
                    <div class="modal-content rounded">\
                        <div class="modal-body no-padding row">\
                            <div class="col-md-4 col-sm-12 no-padding">\
                                <div class="col-sm-12 col-12 p-2 d-flex searcherTab">\
                                    <input class="col-sm-12 col-12 rounded-pill border" id="searcherListInfo" placeholder="tipo, titulo, idunico, idelemento o metadato">\
                                    <div class="fas fa-search position-absolute" id="searcherIconListInfo" style="right:6%;cursor:pointer;bottom:30%"></div>\
                                </div>\
                                <ul class="configlistInfo p-0" style="max-height:75vh; overflow:auto"></ul>\
                            </div>\
                            <div class="col-md-8 col-sm-12 collectionelements">\
                                <h5 class="col-12 py-2 px-0 border-bottom">Aqui puede visualizar todo lo que afecta a un elemento</h5>\
                                <div style="min-height: 50vh; overflow:auto; max-height:70vh;"></div>\
                            </div>\
                        </div>\
                        <div class="modal-footer p-2 no-border">\
                            <div class="newreglas btn btn-light border" style="background-color: #98eeff;">Reglas</div>\
                            <div class="newservicios btn btn-light border" style="background-color: #98eeff;">Servicios</div>\
                            <div class="newcomponentes btn btn-light border" style="background-color: #98eeff;">Componentes</div>\
                            <div class="modalclose btn btn-light border">Cerrar</div>\
                        </div>\
                    </div>\
                </div>\
            </div>');
            $("body").append(o.editoruniversal), o.editoruniversal.modal({ keyboard: !1, backdrop: "static", show: !0 });
            o.editoruniversal.find(".modalclose").on("click", function () { o.editoruniversal.modal("hide"), o.editoruniversal.remove(), clearInterval(looktime); });
            o.editoruniversal.find(".newreglas").on("click", function () { configInterface('reglas'); });
            o.editoruniversal.find(".newservicios").on("click", function () { configInterface('servicios'); });
            o.editoruniversal.find(".newcomponentes").on("click", function () { configInterface('components'); });
            o.editoruniversal.find("#searcherListInfo").on("keyup", function (e) {
                clearInterval(looktime);
                if (e.keyCode === 13) clearInterval(looktime), filterElementListinfo(o, e.target.value);
                else looktime = setInterval(function () {
                    clearInterval(looktime), filterElementListinfo(o, e.target.value);
                }, 1000);
            });
            o.editoruniversal.find("#searcherIconListInfo").on("click", function (e) {
                clearInterval(looktime), filterElementListinfo(o, e.target.value);
            });
            openid && (filterElementListinfo(o, openid, !0, fromremove));
        }
        function nuevasReglasInterface(rule, action, idelem) {
            var o = getOpts(); initializeDataByAttr(o, "reglas");
            o.configModal = $('<div class="modal">\
                <div class="modal-dialog modal-xl" style="width: 95%; max-width: 95%;">\
                    <div class="modal-content rounded">\
                        <div class="modal-body no-padding row">\
                            <div class="col-md-12 col-sm-12">\
                                <h5 class="col-12 py-2 px-0 border-bottom">'+ getDescVerbToChange(o, rule, action, idelem) + '</h5>\
                                <div class="pt-2" style="position: absolute; top: 0; right: 0; z-index: 10;">\
                                    <div class="d-inline-flex justify-content-center pr-2" style="float: right;">\
                                        <i class="infobutton far fa-question-circle" style="cursor:pointer; height:fit-content;font-size:2.5rem; color: #28699f"></i>\
                                    </div>\
                                    <div class="rounded p-2 infotext border text-muted" style="background-color: #f6f8fa; margin: 30px 10px 10px 10px; display: none;">En este estilo de asignación de reglas, solo necesita especificar que cambio tendra el elemento y las condiciones. Ya no es necesario recordar reglas o armar logicas complicadas que son dificiles de recordar.</div>\
                                </div>\
                                <div class="card collectionelements mt-3" style="min-height: 50vh;">\
                                    <div class="p-2" style="min-height:50vh"></div>\
                                </div>\
                            </div>\
                        </div>\
                        <div class="modal-footer p-2 justify-content-between no-border">\
                            <div class="modalclose btn btn-light border ml-2 btn-sm">Cerrar</div>\
                        </div>\
                    </div>\
                </div>\
            </div>');
            $("body").append(o.configModal), o.configModal.modal({ keyboard: !1, backdrop: "static", show: !0 });
            o.configModal.find(".modalclose").on("click", function () {
                o.configModal.modal("hide"), o.configModal.remove();
                $("body .panel.combo-p:not('visible')").remove(); //se quitan todos los combos de easyui escondidos que generan alentamiento en la pagina
                if (rule)  //se abre de nuevo el editor universal con los posibles cambios
                    infoModElements(idelem);
            });
            o.configModal.find(".infobutton").on("click", function (e) { o.configModal.find(".infotext").slideToggle("fast"); });
            o.configModal.find(".infobutton").effect("pulsate", 2000).effect("highlight", 1000);
            o.configModal.find("div.collectionelements div").append("<div id='elem" + rule + "' class='h-100'></div>");
            drawRule(o, rule, !0);
        }
        function recursiveGetFamilyParentTree(o, parent) {
            if (_.isEmpty(parent)) return "";//plantilla
            if (parent === o.idPlantilla) return "";//pagina, no es necesario mencionar que es hijo de plantilla
            return recursiveGetFamilyParentTree(o, o.appvm[parent].elementopadre()) + o.appvm[parent].titulo() + " (" + o.appvm[parent].tipo() + ") [" + parent + "] <strong>=></strong> ";//cualquier hijo
        }



        //Configurador de imagenes
        function imagesUploader() {
            var o = getOpts(), attrDescr = getDescriptionByAttr("imagesUploader");
            o.configModal = $('<div class="modal">\
                <div class="modal-dialog modal-md">\
                    <div class="modal-content rounded">\
                        <div class="modal-body p-2">\
                                <h5 class="col-12 py-2 px-0 border-bottom">'+ attrDescr.tit + '</h5>'
                + (!attrDescr.desc ? '' : '<div class="w-100 justify-content-end d-inline-flex">\
                                    <div class="rounded p-2 infotext border text-muted w-100" style="background-color: #f6f8fa;">' + attrDescr.desc + '</div>\
                                            <i class="infobutton far fa-question-circle ml-2" style="cursor:pointer; height:fit-content;font-size:2.5rem; color: #28699f"></i></div>') +
                '<div class="card mt-3 p-2 imagesContainer row" style="height: 50vh; overflow: auto; flex-direction:row"><span class="noUploadedImages text-center text-muted w-100" style="padding-top:20vh">Suba su primer imagen para visualizarla aquí</span></div></div>\
                        <div class="modal-footer p-2 justify-content-between no-border">\
                            <span class="btn btn-file btn-primary btn-sm"><i class="fas fa-plus mr-2"></i>Agregar<input type="file" multiple accept=".png, .jpeg, .jpg"></span>\
                            <div class="modalclose btn btn-light border ml-2 btn-sm">Cerrar</div>\
                        </div>\
                    </div>\
                </div>\
            </div>');
            $("body").append(o.configModal), o.configModal.modal({ keyboard: !1, backdrop: "static", show: !0 });
            o.configModal.find(".modalclose").on("click", function () { o.configModal.modal("hide"), o.configModal.remove(); });
            o.configModal.find(".infobutton").on("click", function (e) { o.configModal.find(".infotext").slideToggle("fast"); });
            o.configModal.find(".infobutton").effect("pulsate", 2000).effect("highlight", 1000);
            o.configModal.find(".btn-file input").on("change", function (e) {
                var filesInput = $(this).get(0), uploadedFile = 0;
                for (var i = 0; i < filesInput.files.length; i++) {
                    var reader = new FileReader();
                    reader.addEventListener("load", function (ri) {
                        if (ri.currentTarget.result.indexOf("image/png") >= 0 || ri.currentTarget.result.indexOf("image/jpg") >= 0 || ri.currentTarget.result.indexOf("image/jpeg") >= 0) {
                            $.ajax({
                                url: o.datasend.urlGlobal + 'FEConfigurador.aspx/CrudImages',
                                data: JSON.stringify({ expid: o.datasend.expId, tipodocid: o.datasend.tipoDocId, id: "", filename: filesInput.files[uploadedFile].name, datos: ri.currentTarget.result, modo: 2 }),
                                type: "POST", contentType: "application/json; charset=utf-8",
                                success: function (j) {
                                    j = j.d;
                                    if (j.Success) {
                                        j.ReturnedObject[2] && o.appvm[o.idPlantilla].rutaportal(j.ReturnedObject[2]);
                                        !!j.Mensaje && toasty("", j.Mensaje, "exito"), addImageToViewer(o, { id: j.ReturnedObject[0], filename: j.ReturnedObject[1], datos: ri.currentTarget.result }), noImagesUploaded(o);
                                    }
                                    else !!j.Mensaje && toasty("", j.Mensaje, "error");
                                }
                            });
                        }
                        else toasty("", "No se ha subido archivo " + filesInput.files[uploadedFile].name + " por no ser una imagen válida.");
                        uploadedFile++;
                    });
                    reader.readAsDataURL(filesInput.files[i]);
                }
            });
            loadViewer(o);
        }
        function noImagesUploaded(o) {
            var imgs = o.configModal.find(".imagesContainer img");
            o.configModal.find(".noUploadedImages").attr("hidden", !(!imgs || imgs.length === 0));
        }
        function loadViewer(o) {
            $.ajax({
                url: o.datasend.urlGlobal + 'FEConfigurador.aspx/CrudImages',
                data: JSON.stringify({ expid: o.datasend.expId, tipodocid: o.datasend.tipoDocId, id: "", filename: "", datos: "", modo: 1 }),
                type: "POST", contentType: "application/json; charset=utf-8",
                success: function (j) {
                    j = j.d;
                    if (j.Success) {
                        !!j.Mensaje && toasty("", j.Mensaje, "exito");
                        for (var i = 0; i < j.ReturnedObject.length; i++) {
                            addImageToViewer(o, { id: j.ReturnedObject[i][0], filename: j.ReturnedObject[i][1], datos: "data:image/png;base64," + j.ReturnedObject[i][2] });
                        }
                        noImagesUploaded(o);
                    }
                    else !!j.Mensaje && toasty("", j.Mensaje, "error");
                }
            });
        }
        function addImageToViewer(o, img) {
            var imgCard = "<div class='col-4 p-1' id='" + img.id + "'><img class='border w-100' style='height:100px' src='" + img.datos + "' alt='" + img.filename + "'><div class='p-2 text-gray position-absolute' style='top:0; right: 0;'><i class='fas fa-trash-alt' style='cursor: pointer;'></i></div><div class='border rounded-bottom text-center font-italic text-muted p-1'>" + img.filename + "</div></div>";
            o.configModal.find(".imagesContainer").append(imgCard);
            o.configModal.find("div[id='" + img.id + "'] i.fa-trash-alt").on("click", function () { deleteImage(this.parentElement.parentElement.id); });
        }
        function deleteImage(id) {
            var o = getOpts();
            $.ajax({
                url: o.datasend.urlGlobal + 'FEConfigurador.aspx/CrudImages',
                data: JSON.stringify({ expid: o.datasend.expId, tipodocid: o.datasend.tipoDocId, id: id, filename: "", datos: "", modo: 3 }),
                type: "POST", contentType: "application/json; charset=utf-8",
                success: function (j) {
                    j = j.d;
                    if (j.Success) {
                        !!j.Mensaje && toasty("", j.Mensaje, "exito"), o.configModal.find("div[id='" + id + "']").remove(), noImagesUploaded(o);
                    }
                    else !!j.Mensaje && toasty("", j.Mensaje, "error");
                }
            });
        }



        //Configurador de metadatos
        function drawNewRowMetadataMapping(o, eKey) {
            var acti = $('<div class="col-sm-12 col-12 no-padding"><div class="border-bottom"><div>\
                                <div class="btn btn-light btn-sm border addrel my-2 float-right" ' + (!o.appvm[o.idPlantilla].metadatamapping()[eKey].filemapping ? 'hidden' : '') + '>Agregar relación</div>\
                                <div class="tipodochijo pb-3"><span class="mr-2">Configuración asociada:</span><div class="cbtipodochijo"></div></div>\
                            </div></div>\
                                <div class="col-sm-12 col-12 p-0 pt-2 tablerel" ' + (!o.appvm[o.idPlantilla].metadatamapping()[eKey].filemapping ? 'hidden' : '') + '>\
                                    <table class="table table-condensed table-striped mb-0">\
                                        <thead class="text-white rounded-top" style="display: block; background-color: #9ea7ac"><th class="border-bottom w-50">Elemento plantilla</th><th class="border-bottom w-50">Campo metadato</th><th class="border-bottom"></th></thead>\
                                        <tbody class="w-100" style="display:block;max-height:40vh;overflow:auto;"></tbody>\
                                    </table>\
                                <div class="text-center py-2 text-muted border-bottom norelations" ' + (!_.isEmpty(o.appvm[o.idPlantilla].metadatamapping()[eKey].mapeo) ? 'hidden' : '') + '> No existen relaciones</div>\
                            </div>\
                        </div>');
            o.configModal.find("div.collectionelements div#elem" + eKey).append(acti);

            acti.find(".cbtipodochijo").combobox({
                data: o.initializedData.elemsfilemapping, valueField: "Valor", idField: "Valor", textField: "Nombre", limitToList: !0,
                value: o.appvm[o.idPlantilla].metadatamapping()[eKey].filemapping, prompt: "Seleccione...", panelHeight: "auto", panelMaxHeight: 200,
                onChange: function (item) {
                    var fi = _.find(o.initializedData.elemsfilemapping, { Valor: item });
                    o.appvm[o.idPlantilla].metadatamapping()[eKey].filemapping = !fi ? "" : item, o.appvm[o.idPlantilla].metadatamapping()[eKey].mapeo = {};
                    o.configModal.find(".addrel, .tablerel").attr("hidden", !fi), o.configModal.find(".norelations").attr("hidden", !1), $(".tablerel table tbody").children().empty();
                }
            });
            acti.find(".addrel").on("click", function (e) { addMetadataMappingRelation(eKey, acti), o.configModal.find(".norelations").attr("hidden", !_.isEmpty(o.appvm[o.idPlantilla].metadatamapping()[eKey].mapeo)); });
            _.forEach(_.keys(o.appvm[o.idPlantilla].metadatamapping()[eKey].mapeo), function (v) { addMetadataMappingRelation(eKey, acti, v); });
        }
        function addMetadataMappingRelation(eKey, elem, idelem) {
            var o = getOpts(), currentrow = $("<tr><td class='border-bottom w-50'><div class='elemfield'></div></td><td class='border-bottom w-50'><div class='metadatafield'></div></td><td class='border-bottom align-middle'><i class='far fa-trash-alt text-red pr-2' title='Borrar' style='cursor:pointer'></i></td></tr>");
            idelem = idelem ? idelem : getGuidForElem(o, "metadatamapping", idelem, "mapeo", eKey);
            !!o.appvm[o.idPlantilla].metadatamapping()[eKey].mapeo || (o.appvm[o.idPlantilla].metadatamapping()[eKey].mapeo = {});
            !!o.appvm[o.idPlantilla].metadatamapping()[eKey].mapeo[idelem] || (o.appvm[o.idPlantilla].metadatamapping()[eKey].mapeo[idelem] = { idelem: "", metadata: "" });
            elem.find("table").append(currentrow);
            currentrow.find('.elemfield').css({ width: "90%" }).combobox({
                data: o.initializedData.elemscurrtemplate, valueField: 'id', textField: 'nombre', idField: "id", prompt: 'Seleccione...', limitToList: !0,
                groupField: "padre", groupPosition: "sticky", panelHeight: "auto", panelMaxHeight: 200,
                value: o.appvm[o.idPlantilla].metadatamapping()[eKey].mapeo[idelem].idelem,
                onChange: function (item) {
                    var idelemmeta = _.find(o.appvm[o.idPlantilla].metadatamapping()[eKey].mapeo, { idelem: item });
                    if (!idelemmeta) o.appvm[o.idPlantilla].metadatamapping()[eKey].mapeo[idelem].idelem = item;
                    else toasty('', 'No se pueden duplicar elementos.'), $(this).combobox("clear");
                }
            });
            var metadatoshijos = _.filter(o.datatags.metadatoshijos, { TipoDoc: Number(o.appvm[o.idPlantilla].pdfmapping()[o.appvm[o.idPlantilla].metadatamapping()[eKey].filemapping].tipodochijo) });
            currentrow.find('.metadatafield').css({ width: "90%" }).combobox({
                data: metadatoshijos, valueField: 'IdMetadatoHijo', textField: 'Nombre', idField: "IdMetadatoHijo", prompt: 'Seleccione...', limitToList: !0, panelHeight: "auto", panelMaxHeight: 200,
                value: o.appvm[o.idPlantilla].metadatamapping()[eKey].mapeo[idelem].metadata,
                onChange: function (item) {
                    var idelemmeta = _.find(o.appvm[o.idPlantilla].metadatamapping()[eKey].mapeo, { metadata: item });
                    if (!idelemmeta) o.appvm[o.idPlantilla].metadatamapping()[eKey].mapeo[idelem].metadata = item;
                    else toasty('', 'No se pueden duplicar metadatos.'), $(this).combobox("clear");
                }
            });
            currentrow.find(".fa-trash-alt").on("click", function (e) {
                currentrow.remove(); delete o.appvm[o.idPlantilla].metadatamapping()[eKey].mapeo[idelem];
                o.configModal.find(".norelations").attr("hidden", !_.isEmpty(o.appvm[o.idPlantilla].metadatamapping()[eKey].mapeo));
            });
        }



        //Configurador genérico: mapeo de archivos
        function drawNewRowFileMapping(o, eKey) {
            //<div class="btn btn-light btn-file border uploadfile"><span>Examinar...</span><input class="fileupload" type="file" accept=".doc,.docx,.pdf"></div>\
            var acti = $('<div class="col-sm-12 col-12 no-padding">\
                <div class="border-bottom">\
                    <div class="pb-3">\
                        <span class="text-red pb-2 text-bold nofileuploaded float-right" hidden>Necesita cargar un archivo de tipo PDF, Word o Excel</span>\
                        <div class="d-flex align-items-center w-100">\
                            Seleccione archivo (PDF, Word o Excel):<input type="text" style="font-size:1em" class="fileinuse form-control rounded w-50 ml-2" />\
                            <div class="btn btn-light text-green border uploadfile btn-file" title="Subir template">\
                                <i class="fas fa-file-upload"></i>\
                                <input class="fileupload" type="file" accept=".docx,.pdf,.xlsx" />\
                            </div>\
                            <div class="btn btn-light text-blue border downlfile" hidden title="Descargar template"><i class="fas fa-file-download"></i></div>\
                            <div class="btn btn-light text-orange border tryfile" hidden title="Probar template"><i class="far fa-file"></i></div>\
                        </div>\
                    </div >\
                    <div class="btn btn-light btn-sm border addrel my-2 float-right" hidden>Agregar relación</div>\
                    <div class="tipodochijo pb-3">\
                        <span class="mr-2">Tipo de documento hijo:</span>\
                        <div class="cbtipodochijo"></div>\
                    </div>\
                    <div class="pb-1"><input type="checkbox" class="mr-1 downloadtype align-middle"/><span class="text-muted">¿Descargar como PDF?</span></div>\
                </div>\
                <div class="col-sm-12 col-12 p-0 pt-2 tablerel" hidden>\
                    <div class="w-100" style="overflow: auto; max-height: 50vh;">\
                        <table class="table table-condensed mb-0">\
                            <thead>\
                                <tr>\
                                    <th style="width:33%">Elemento plantilla</th>\
                                    <th style="width:33%">Campo archivo</th>\
                                    <th style="width:33%">Imagen por defecto</th>\
                                    <th></th>\
                                </tr>\
                            </thead>\
                            <tbody class="w-100"></tbody>\
                        </table>\
                    </div>\
                    <div class="text-center py-2 text-muted border-bottom norelations" ' + (!_.isEmpty(o.appvm[o.idPlantilla].pdfmapping()[eKey].mapeo) ? 'hidden' : '') + '> No existen relaciones</div>\
                </div>\
            </div>'), fileuploaded = o.datatags.fieldsbypdf[eKey];
            o.configModal.find("div.collectionelements div#elem" + eKey).append(acti);
            acti.find(".fileupload").on("change", function (e) { loadFile(e.target, eKey, 1, function () { drawElementByAttr(eKey, "pdfmapping"); }); });
            acti.find(".downlfile").on("click", function (e) { crudFilePlant(o, eKey, 2); });
            acti.find(".tryfile").on("click", function (e) { tryDemoFile(o, eKey); });
            acti.find(".addrel").on("click", function (e) { addFileMappingRelation(eKey, acti), o.configModal.find(".norelations").attr("hidden", !_.isEmpty(o.appvm[o.idPlantilla].pdfmapping()[eKey].mapeo)); });
            acti.find(".fileinuse").val(fileuploaded ? fileuploaded.filename === eKey ? o.appvm[o.idPlantilla].pdfmapping()[eKey].filename : fileuploaded.filename : "");
            acti.find(".cbtipodochijo").combobox({
                data: o.datatags.tipodochijos, valueField: "Valor", idField: "Valor", textField: "Nombre", limitToList: !0, panelMaxHeight: 200,
                value: o.appvm[o.idPlantilla].pdfmapping()[eKey].tipodochijo, prompt: "Seleccione...", panelHeight: "auto",
                onChange: function (itemval) { o.appvm[o.idPlantilla].pdfmapping()[eKey].tipodochijo = itemval; }
            });
            acti.find(".downloadtype").on('change', function (e) {
                o.appvm[o.idPlantilla].pdfmapping()[eKey].downloadtype = e.currentTarget.checked ? "pdf" : o.appvm[o.idPlantilla].pdfmapping()[eKey].filename.substring(o.appvm[o.idPlantilla].pdfmapping()[eKey].filename.lastIndexOf(".") + 1);
            });
            o.appvm[o.idPlantilla].pdfmapping()[eKey].downloadtype.toLowerCase() === "pdf" && acti.find(".downloadtype").click();
            if (fileuploaded && fileuploaded.pdfexists) acti.find(".downlfile,.tryfile,.tablerel,.addrel").removeAttr("hidden");
            else if (!_.isEmpty(o.appvm[o.idPlantilla].pdfmapping()[eKey].mapeo)) acti.find(".tablerel,.nofileuploaded,.addrel").removeAttr("hidden");
            _.forEach(_.keys(o.appvm[o.idPlantilla].pdfmapping()[eKey].mapeo), function (v) { addFileMappingRelation(eKey, acti, v); });
        }
        function addFileMappingRelation(eKey, elem, idelem) {
            var o = getOpts(), currentrow = $("<tr><td class='border-bottom'><div class='elemfield'></div></td><td class='border-bottom'><div class='pdffield'></div></td><td><div class='imgfield'></div></td><td class='border-bottom align-middle text-center'><i class='far fa-trash-alt text-red pr-2' title='Borrar' style='cursor:pointer;'></i></td></tr>");
            idelem = idelem ? idelem : getGuidForElem(o, "pdfmapping", idelem, "mapeo", eKey);
            !!o.appvm[o.idPlantilla].pdfmapping()[eKey].mapeo || (o.appvm[o.idPlantilla].pdfmapping()[eKey].mapeo = {});
            !!o.appvm[o.idPlantilla].pdfmapping()[eKey].mapeo[idelem] || (o.appvm[o.idPlantilla].pdfmapping()[eKey].mapeo[idelem] = { idelem: "", pdf: "", takeattach: !1, defImg: "" });
            elem.find("table").append(currentrow);
            currentrow.find('.elemfield').css({ width: "80%" }).combobox({
                data: o.initializedData.elmsmapping, valueField: 'id', textField: 'nombre', idField: "id", prompt: 'Seleccione...', limitToList: !0, panelHeight: "auto", panelMaxHeight: 200,
                groupField: "padre", groupPosition: "sticky", value: elemsExist(o.initializedData.elmsmapping, o.appvm[o.idPlantilla].pdfmapping()[eKey].mapeo[idelem].idelem, 'id'),
                onSelect: function (nv) {
                    o.appvm[o.idPlantilla].pdfmapping()[eKey].mapeo[idelem].takeattach = nv.isattach,
                        o.appvm[o.idPlantilla].pdfmapping()[eKey].mapeo[idelem].idelem = nv.id;
                }, onUnselect: function () {
                    o.appvm[o.idPlantilla].pdfmapping()[eKey].mapeo[idelem].takeattach = !1,
                        o.appvm[o.idPlantilla].pdfmapping()[eKey].mapeo[idelem].idelem = "";
                }
            });
            var pdffields = !o.datatags.fieldsbypdf[eKey] ? [] : o.datatags.fieldsbypdf[eKey].pdffields;
            currentrow.find('.pdffield').css({ width: "80%" }).combobox({
                data: pdffields, valueField: 'Nombre', textField: 'Nombre', idField: "Nombre", prompt: 'Seleccione...', limitToList: !0, panelHeight: "auto", panelMaxHeight: 200,
                groupField: "Pagina", groupPosition: "sticky", value: elemsExist(pdffields, o.appvm[o.idPlantilla].pdfmapping()[eKey].mapeo[idelem].pdf.toString().split(','), 'Nombre'),
                groupFormatter: function (value) { return "Pagina " + value; }, multiple: !0, onChange: function (nv, ov) {
                    o.appvm[o.idPlantilla].pdfmapping()[eKey].mapeo[idelem].pdf = nv.join(',');
                }
            });
            currentrow.find('.imgfield').css({ width: "80%" }).combobox({
                data: o.initializedData.imgsNames, valueField: 'id', textField: 'fn', idField: "id", prompt: 'Seleccione...', limitToList: !0, panelHeight: "auto", panelMaxHeight: 200,
                value: elemsExist(o.initializedData.imgsNames, o.appvm[o.idPlantilla].pdfmapping()[eKey].mapeo[idelem].defImg, 'id'),
                onChange: function (nv, ov) {
                    o.appvm[o.idPlantilla].pdfmapping()[eKey].mapeo[idelem].defImg = nv;
                }
            });
            currentrow.find(".fa-trash-alt").on("click", function (e) {
                currentrow.remove(); delete o.appvm[o.idPlantilla].pdfmapping()[eKey].mapeo[idelem];
                o.configModal.find(".norelations").attr("hidden", !_.isEmpty(o.appvm[o.idPlantilla].pdfmapping()[eKey].mapeo));
            });
        }
        function loadFile(input, key, crud, cb) {
            var o = getOpts(), file = $(input).get(0).files[0];
            if (file.name.toLowerCase().indexOf(".pdf") < 0 &&
                file.name.toLowerCase().indexOf(".docx") < 0 &&
                file.name.toLowerCase().indexOf(".xlsx") < 0) toasty("Solo se permiten archivos PDF, Word o Excel");
            else {
                var reader = new FileReader();
                reader.addEventListener("load", function () {
                    o.datatags.fieldsbypdf[key] = { filename: file.name, guidpdf: key, blobdata: reader.result.substring(reader.result.indexOf("base64,") + 7), pdffields: [] };
                    o.appvm[o.idPlantilla].pdfmapping()[key].filename = file.name;
                    crudFilePlant(o, key, crud, cb);
                }, false);
                file && reader.readAsDataURL(file);
            }
        }
        function crudFilePlant(o, ekey, crud, cb) {
            if (o.datatags.fieldsbypdf[ekey] || _.includes([1, 2, 3], crud)) {
                //CRUD: 1 create/update, 2 read, 4 delete.
                o.datasend.pdf = {}, o.datasend.guidpdf = ekey, o.datasend.accion = crud,
                    _.forEach(_.keys(o.datatags.fieldsbypdf), function (elm) {
                        var fn = o.datatags.fieldsbypdf[elm].filename;
                        o.datatags.fieldsbypdf[elm].blobdata && o.datatags.fieldsbypdf[elm].blobdata.length > 0 && (o.datasend.pdf[elm] = { nombrePdf: fn, pdfData: o.datatags.fieldsbypdf[elm].blobdata, filetype: fn === elm ? "pdf" : fn.substring(fn.indexOf(".") + 1) });
                    });
                o.datasend.pdf = JSON.stringify(o.datasend.pdf);
                $.ajax({
                    url: o.datasend.urlGlobal + 'FEConfigurador.aspx/CrudFile',
                    data: JSON.stringify(o.datasend),
                    success: function (j) {
                        showHideLoading(o, false);
                        j = j.d;
                        if (j.Success) {
                            switch (crud) {
                                case 1:
                                    o.datatags.fieldsbypdf[ekey].pdfexists = j.ReturnedObject.pdfexists, o.datatags.fieldsbypdf[ekey].blobdata = "",
                                        o.datatags.fieldsbypdf[ekey].pdffields = j.ReturnedObject.pdffields,
                                        toasty('', 'Archivo cargado exitosamente', 'exito');
                                    break;
                                case 2:
                                    if (o.datatags.fieldsbypdf[ekey]) {
                                        var byteCharacters = window.atob(j.ReturnedObject), byteArrays = [], sliceSize = 512;
                                        for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                                            var slice = byteCharacters.slice(offset, offset + sliceSize), byteNumbers = new Array(slice.length);
                                            for (var i = 0; i < slice.length; i++) byteNumbers[i] = slice.charCodeAt(i);
                                            var byteArray = new Uint8Array(byteNumbers);
                                            byteArrays.push(byteArray);
                                        }
                                        var ext = o.datatags.fieldsbypdf[ekey].filename !== ekey ? o.datatags.fieldsbypdf[ekey].filename.substring(o.datatags.fieldsbypdf[ekey].filename.indexOf("." + 1)) : "pdf";
                                        var blobdata = new Blob(byteArrays, { type: "application/" + ext });
                                        var titulo = !o.appvm[o.idPlantilla].pdfmapping()[ekey].filename ? "PlantillaArchivo." + ext : o.appvm[o.idPlantilla].pdfmapping()[ekey].filename;
                                        if (window.navigator.msSaveOrOpenBlob) window.navigator.msSaveOrOpenBlob(blobdata, titulo);
                                        else {
                                            var elem = window.document.createElement("a");
                                            elem.href = window.URL.createObjectURL(blobdata);
                                            elem.download = titulo;
                                            document.body.appendChild(elem), elem.click(), document.body.removeChild(elem);
                                        }
                                    }
                                    else toasty('', 'Se encontr&oacute; un problema al descargar el archivo', 'error');
                                    break;
                                case 4:
                                    delete o.appvm[o.idPlantilla].pdfmapping()[ekey],
                                        o.datatags.fieldsbypdf[ekey] && (delete o.datatags.fieldsbypdf[ekey], o.datasend.xml = getXml(), !o.mensajeGuardaPlantilla.length && savePlantilla(o));
                                    break;
                            }
                            !cb || cb();
                        }
                        else Error(j.Titulo, j.Mensaje);
                    },
                    error: function (e) { errorFormElec(o, e), showHideLoading(o, !1); }
                });
            }
        }
        function tryDemoFile(o, ekey) {
            var pdfdown = o.datatags.fieldsbypdf[ekey];
            if (!pdfdown) toasty("", "Es necesario subir una plantilla para realizar la prueba.", "error");
            else {
                if (pdfdown.guidpdf.length && Modernizr.atobbtoa) {
                    $.ajax({
                        url: o.datasend.urlGlobal + "FEConfigurador.aspx/GeneraArchivo",
                        data: JSON.stringify({ idplantilla: o.datasend.idPlantilla, guidpdf: ekey, proyid: o.datasend.proyid, expId: o.datasend.expId, tipoDocId: o.datasend.tipoDocId, xml: xmlToString(o), modo: 1, guidF: o.datasend.guid }),
                        success: function (j) {
                            j = j.d;
                            if (j.Success) {
                                var byteCharacters = window.atob(j.ReturnedObject), byteArrays = [], sliceSize = 512;
                                for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                                    var slice = byteCharacters.slice(offset, offset + sliceSize), byteNumbers = new Array(slice.length);
                                    for (var i = 0; i < slice.length; i++) byteNumbers[i] = slice.charCodeAt(i);
                                    var byteArray = new Uint8Array(byteNumbers);
                                    byteArrays.push(byteArray);
                                }

                                var ext = pdfdown.filename !== ekey && o.appvm[o.idPlantilla].pdfmapping()[ekey].downloadtype.toLowerCase() !== "pdf"
                                    ? pdfdown.filename.substring(pdfdown.filename.indexOf(".") + 1) : "pdf";
                                var filenameNoExt = !(ekey && !!o.appvm[o.idPlantilla].pdfmapping()[ekey].filename) ? "PlantillaArchivo." :
                                    o.appvm[o.idPlantilla].pdfmapping()[ekey].filename.substring(0, o.appvm[o.idPlantilla].pdfmapping()[ekey].filename.indexOf(".") + 1);
                                var blobdata = new Blob(byteArrays, { type: "application/" + ext });
                                var titulo = filenameNoExt + ext;
                                if (window.navigator.msSaveOrOpenBlob) window.navigator.msSaveOrOpenBlob(blobdata, titulo);
                                else {
                                    var elem = window.document.createElement("a");
                                    elem.href = window.URL.createObjectURL(blobdata);
                                    elem.download = titulo;
                                    document.body.appendChild(elem), elem.click(), document.body.removeChild(elem);
                                }
                            } else Error(j.Titulo, j.Mensaje);
                        },
                        error: function (e) { o = getOpts(); errorFormElec(o, e); }
                    });
                }
            }
        }



        //Configurador genérico: prellenado
        function drawNewRowPrefill(o, eKey) {
            o.appvm[o.idPlantilla].prefilleddata()[eKey].guidtoopen || (o.appvm[o.idPlantilla].prefilleddata()[eKey].guidtoopen = "");
            var acti = $(`<h5>
                    Configuraci&oacute;n<a tabindex="0" class="far fa-question-circle float-right configinfo" style="font-size: 1rem;"></a>
                </h5>
                <div class="row">
                    <div class="col-sm-4 col-4">
                        <input type="checkbox" id="localprefill" />&nbsp;&nbsp;Prellenado local
                    </div>
                    <div class="col-sm-4 col-4">
                        Seleccione plantilla:&nbsp;&nbsp;<span class="templateinuse"></span>
                    </div>
                    <div class="col-sm-4 col-4">
                        Abrir formato en nueva p&aacute;gina:&nbsp;&nbsp;<input id="letpageopen">
                    </div>
                    <div class="col-sm-4 col-4">
                        Abrir formato en pantalla completa:&nbsp;&nbsp;<input id="letfullscreen">
                    </div>
                    <div class="col-sm-4 col-4">
                        GUID de formato a abrir:&nbsp;&nbsp;<span class="guidtoopen"></span>
                    </div>
                </div>
                <h5>
                    Mapeo
                    <a tabindex="0" class="far fa-question-circle float-right formulainfo" style="font-size: 1rem;"></a>
                    <i hidden class="fas fa-plus-circle float-right text-green mr-1" style="font-size: 1rem;cursor: pointer;" title="Agregar relaci&oacute;n"></i>
                </h5>
                <div class="row">
                    <div class="col-sm-12 col-12 no-padding" style="overflow:auto; max-height: 50vh;">
                        <table hidden class="table table-condensed table-striped">
                            <thead>
                                <tr>
                                    <th class="w-25 border-bottom">Tipo relaci&oacute;n</th>
                                    <th class="border-bottom" style="width:35%">Elemento plantilla origen</th>
                                    <th class="border-bottom" style="width:35%">Elemento plantilla destino</th>
                                    <th class="border-bottom"></th><th class="border-bottom"></th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>`), elminexistence = elemsExist(o.datatags.plantillas, o.appvm[o.idPlantilla].prefilleddata()[eKey].idplantilla, 'Valor')[0],
                guidtoopen = o.appvm[o.idPlantilla].prefilleddata()[eKey].guidtoopen;
            o.configModal.find("div.collectionelements div#elem" + eKey).append(acti);
            acti.find(".templateinuse").combobox({
                data: o.datatags.plantillas, valueField: 'Valor', textField: 'Nombre', idField: "Valor", prompt: 'Seleccione...', value: elminexistence, limitToList: !0,
                onSelect: function (val) { o.appvm[o.idPlantilla].prefilleddata()[eKey].idplantilla = val.Valor, acti.find("[hidden]").removeAttr("hidden"), !o.datatags.elementosPlantillas[o.appvm[o.idPlantilla].prefilleddata()[eKey].idplantilla] && getElementsPlantilla(val.Valor); },
                onUnselect: function () { acti.find("table").attr("hidden", "true"), acti.find(".fa-plus-circle").attr("hidden", "true"), o.appvm[o.idPlantilla].prefilleddata()[eKey].mapeo = {}, acti.find('.rowelm').remove(); }
            });
            acti.find(".guidtoopen").combobox({
                data: o.initializedData.elemscurrtemplate, valueField: 'id', textField: 'nombre', idField: "id", prompt: 'Seleccione...', value: guidtoopen, limitToList: !0, groupField: "padre", groupPosition: "sticky",
                onSelect: function (val) { o.appvm[o.idPlantilla].prefilleddata()[eKey].guidtoopen = val.id; },
                onUnselect: function () { o.appvm[o.idPlantilla].prefilleddata()[eKey].guidtoopen = ""; }
            });
            acti.find("#letpageopen").switchbutton({ checked: o.appvm[o.idPlantilla].prefilleddata()[eKey].newwindow, onChange: function (checked) { o.appvm[o.idPlantilla].prefilleddata()[eKey].newwindow = checked; }, onText: 'S&iacute;', offText: 'No' });
            acti.find("#letfullscreen").switchbutton({ checked: o.appvm[o.idPlantilla].prefilleddata()[eKey].fullscreenformat, onChange: function (checked) { o.appvm[o.idPlantilla].prefilleddata()[eKey].fullscreenformat = checked; }, onText: 'S&iacute;', offText: 'No' });
            acti.find("#localprefill").on('change', function (e) {
                var o = getOpts();
                o.appvm[o.idPlantilla].prefilleddata()[eKey].isLocal = e.currentTarget.checked;
                if (e.currentTarget.checked) {
                    o.appvm[o.idPlantilla].prefilleddata()[eKey].idplantilla === o.datasend.expId + "_" + o.datasend.tipoDocId || (o.appvm[o.idPlantilla].prefilleddata()[eKey].mapeo = {});
                    acti.find(".templateinuse").combobox("disable"), acti.find("#letpageopen").switchbutton('disable'), acti.find("#letfullscreen").switchbutton('disable'),
                        acti.find(".templateinuse").combobox("setValue", o.datasend.expId + "_" + o.datasend.tipoDocId);
                }
                else acti.find(".templateinuse").combobox("enable"), acti.find("#letpageopen").switchbutton('enable'), acti.find("#letfullscreen").switchbutton('enable');
            });
            acti.find(".formulainfo").popover({ html: true, content: "Todos los elementos son compatibles entre s&iacute; mismos, los elementos texto y texto multil&iacute;neas. Adem&aacute;s, los elementos n&uacute;mero y moneda son compatibles entre s&iacute;.", trigger: "focus" });
            acti.find(".configinfo").popover({ html: true, content: "Cuando el wizard al que se le asigne la plantilla sea parte de una tabla, se considera que la informaci&oacute;n de prellenado de esa tabla ser&aacute; enviada por fila del wizard seleccionado. <br/>El GUID de un formato sirve para abrir un formato previamente capturado y abrirlo para editar. Para conseguir el GUID de un formato existen dos formas: <br/> &nbsp;&nbsp;&nbsp;1) Cuando se abre un nuevo formato el wizard que lo abre puede generar el GUID que el hijo tendra para asignarlo al campo oculto del prellenado. <br /> &nbsp;&nbsp;&nbsp;2) Dinamicamente por medio de alguna regla o servicio que consiga el GUID y lo asigne al campo oculto del prellenado", trigger: "focus" });
            acti.find(".fa-plus-circle").on("click", function (e) { addRelation(eKey, acti.find("table"), undefined, undefined, !0); });
            o.appvm[o.idPlantilla].prefilleddata()[eKey].isLocal && acti.find("#localprefill").click();
            !!o.appvm[o.idPlantilla].prefilleddata()[eKey].idplantilla && acti.find("[hidden]").removeAttr("hidden");
            !!elminexistence && !o.datatags.elementosPlantillas[o.appvm[o.idPlantilla].prefilleddata()[eKey].idplantilla] && getElementsPlantilla(o.appvm[o.idPlantilla].prefilleddata()[eKey].idplantilla);
            var loadcat = setInterval(function () {
                if (!!elminexistence && o.datatags.elementosPlantillas[o.appvm[o.idPlantilla].prefilleddata()[eKey].idplantilla]) {
                    clearInterval(loadcat);
                    _.forEach(_.keys(o.appvm[o.idPlantilla].prefilleddata()[eKey].mapeo), function (v) {
                        addRelation(eKey, acti.find("table"), undefined, v, !0);
                    });
                }
            }, 5);
        }
        function addRelation(eKey, elem, idelemp, idelem, isParent, dataorig, datadest) {
            var o = getOpts(), currentrow = $("<tr class='rowelm " + idelemp + "'><td><div class='tiporel'><div></div></div></td><td class='border-bottom'><div class='elemorig'><div></div></div></td><td class='border-bottom'><div class='elemdest'><div></div></div></td><td class='border-bottom'><i class='fas fa-plus text-green py-2' hidden title='Agregar' style='cursor:pointer'></i></td><td class='border-bottom'><i class='far fa-trash-alt text-red py-2' title='Borrar' style='cursor:pointer'></i></td></tr>"),
                currelem = isParent ? o.appvm[o.idPlantilla].prefilleddata()[eKey].mapeo : o.appvm[o.idPlantilla].prefilleddata()[eKey].mapeo[idelemp].mapeoHijos, hr = [];

            idelem = idelem ? idelem : getGuidForElem(o, "prefilleddata", idelem, "mapeo", eKey);
            datadest = !datadest ? isParent && o.appvm[o.idPlantilla].prefilleddata()[eKey].idplantilla === o.datasend.expId + "_" + o.datasend.tipoDocId ? _.map(o.initializedData.elemscurrtemplate, function (vel) { return { Nombre: vel.nombre, Valor: vel.id, Grupo: vel.grupo, Esquema: vel.idpadre, CveCatalogo: vel.padre }; }) : o.datatags.elementosPlantillas[o.appvm[o.idPlantilla].prefilleddata()[eKey].idplantilla] : datadest;
            datadest = _.filter(datadest, function (vel) { return _.includes(o.flexibleelement, vel.Grupo) || vel.Grupo === o.TE.Tabla; });
            dataorig = !dataorig ? o.initializedData.elemscurrtemplate : dataorig;
            typeof currelem === "string" && (currelem = {});
            isParent ? (!!currelem[idelem] || (currelem[idelem] = { idelem: "", destination: "", tipoRel: '', mapeoHijos: {} }), elem.append(currentrow)) :
                (!!currelem[idelem] || (currelem[idelem] = { idelem: "", destination: "" }), elem.after(currentrow[0]));

            currentrow.find('.elemorig div').css({ width: "90%" }).combobox({
                data: _.filter(dataorig, function (vel) { return vel.grupo !== o.TE.Tabla; }), valueField: 'id', textField: 'nombre', idField: "id", prompt: 'Seleccione...', limitToList: !0,
                groupField: "padre", groupPosition: "sticky", onChange: function (nv, ov) {
                    var o = getOpts(); currelem[idelem].idelem = nv;
                    _.filter(_.map(currelem, 'idelem'), function (vel) { return vel === nv; }).length > 1 ? (currelem[idelem].idelem = "", toasty('', 'Elemento previamente seleccionado', 'error'), $(this).combobox('clear'))
                        : nv !== "" && (currentrow.find('.elemdest div').combobox("enable"), currentrow.find('.elemdest div').combobox("loadData", _.filter(datadest, function (vel) { if (o.appvm[nv] && o.appvm[nv].tipo) return o.appvm[nv].tipo() === o.TE.Tabla ? vel.Grupo === o.TE.Tabla : _.includes([o.TE.TextArea, o.TE.Texto, o.appvm[nv].tipo().toLowerCase()], vel.Grupo) || _.includes([o.TE.Moneda, o.TE.Numero], o.appvm[nv].tipo().toLowerCase()) && _.includes([o.TE.Moneda, o.TE.Numero], vel.Grupo); })));
                    currelem[idelem].idelem === "" && (currentrow.find('.elemdest div').combobox("disable"), currentrow.find('.elemdest div').combobox("clear"));
                }
            });
            currentrow.find('.elemdest div').css({ width: "90%" }).combobox({
                data: [], valueField: 'Valor', textField: 'Nombre', idField: "Valor", prompt: 'Seleccione...', multiple: !0, disabled: true, limitToList: !0,
                groupField: "CveCatalogo", groupPosition: "sticky", onChange: function (nv, ov) { currelem[idelem].destination = $(this).combobox('getValues'); }
            });
            currentrow.find('.tiporel div').css({ width: "90%" }).combobox({
                data: [{ id: "istable", nombre: "Tabla" }, { id: "iselem", nombre: "Elemento" }], valueField: 'id', textField: 'nombre', idField: "id", prompt: 'Seleccione...', limitToList: !0,
                onChange: function (nv, ov) {
                    currelem[idelem].tipoRel = nv;
                    nv === "istable" ? (currentrow.find('.elemorig').removeAttr("hidden"), currentrow.find('.elemdest').removeAttr("hidden"),
                        currentrow.find('.elemorig div').combobox("loadData", _.filter(dataorig, { grupo: o.TE.Tabla })), currentrow.find('.elemdest div').combobox({ multiple: false }))
                        : (currentrow.find('.elemorig').attr("hidden", ""), currentrow.find('.elemdest').attr("hidden", ""));
                    currelem[idelem].tipoRel ? (currentrow.find(".fa-plus").removeAttr("hidden"), currentrow.find('.tiporel div').combobox("disable")) : currentrow.find(".fa-plus").attr("hidden", "");
                }
            });
            currentrow.find(".fa-trash-alt").on("click", function (e) { _.forEach(hr, function (velh) { velh.remove(); }), currentrow.remove(), delete currelem[idelem]; });
            currentrow.find(".fa-plus").on("click", function (e) {
                var closestelem = !$(this).closest('table').find('tr.' + idelem).last()[0] ? $(this).closest('tr') : $(this).closest('table').find('tr.' + idelem).last();
                if (currelem[idelem].tipoRel === "istable")
                    if (!currelem[idelem].idelem) { toasty('', 'Seleccione una tabla origen', 'error'); return; }
                    else if (!currelem[idelem].destination) { toasty('', 'Seleccione una tabla destino', 'error'); return; }
                    else hr.push(addRelation(eKey, closestelem, idelem, undefined, !1, _.filter(dataorig, { idpadre: currelem[idelem].idelem }), _.filter(datadest, { Esquema: currelem[idelem].destination[0] })));
                else hr.push(addRelation(eKey, closestelem, idelem, undefined, !1, dataorig, datadest));
            });

            isParent ? (currentrow.find('.elemorig').attr("hidden", ""), currentrow.find('.elemdest').attr("hidden", ""),
                _.forEach(_.keys(currelem[idelem].mapeoHijos), function (vel) {
                    var closestelem = !currentrow.closest('table').find('tr.' + idelem).last()[0] ? currentrow : currentrow.closest('table').find('tr.' + idelem).last();
                    if (currelem[idelem].tipoRel === "istable")
                        hr.push(addRelation(eKey, closestelem, idelem, vel, !1, _.filter(dataorig, { idpadre: currelem[idelem].idelem }), _.filter(datadest, { Esquema: currelem[idelem].destination[0] })));
                    else hr.push(addRelation(eKey, closestelem, idelem, vel, !1, dataorig, datadest));
                })) : currentrow.find('.tiporel').attr("hidden", "");
            currelem[idelem].tipoRel ? (currentrow.find('.tiporel div').combobox("setValue", currelem[idelem].tipoRel),
                currentrow.find('.elemdest div').combobox("setValue", elemsExist(datadest, currelem[idelem].destination, 'Valor'))) :
                currentrow.find('.elemdest div').combobox("setValues", elemsExist(datadest, currelem[idelem].destination, 'Valor'));
            currentrow.find('.elemorig div').combobox("setValue", elemsExist(dataorig, currelem[idelem].idelem, 'id')[0]);
            isParent ? o.appvm[o.idPlantilla].prefilleddata()[eKey].mapeo = currelem : o.appvm[o.idPlantilla].prefilleddata()[eKey].mapeo[idelemp].mapeoHijos = currelem;
            return currentrow;
        }



        //Configurador genérico: operaciones
        function formatOperation(operation, identifiers, decimals, numberwithCommas) {
            operation = calculateOperation(operation, identifiers, !1);
            decimals && (operation = parseFloat(operation).toFixed(decimals));
            numberwithCommas === !0 && (operation = parseFloat(operation).toLocaleString("en"));
            return operation;

        }
        function calculateOperation(operation, identifiers, isconcat) {
            var origop = operation;
            !isconcat && (operation = operation.replace(/\s/g, ''));
            var opinloop = "";
            var basicnum = '[\\-]?[0-9]+(\\.[0-9]+){0,1}';
            var hierarchyOps = {
                1: { op: '^', rgx: new RegExp(basicnum + '[\\^]' + basicnum, 'g') },
                2: { op: '*', rgx: new RegExp(basicnum + '[\\*]' + basicnum, 'g') },
                3: { op: '/', rgx: new RegExp(basicnum + '[\\/]' + basicnum, 'g') },
                4: { op: '+', rgx: new RegExp(basicnum + '[\\+]' + basicnum, 'g') },
                5: { op: '-', rgx: new RegExp(basicnum + '[\\-]' + basicnum, 'g') }
            };
            var rgxNan = new RegExp('NaN', 'g');
            var rgxbasicnum = new RegExp(basicnum, 'g');
            var rgxnumcommas = new RegExp('(' + basicnum + '\\,)*(' + basicnum + ')+', 'g');
            var rgxParnt = new RegExp('\\(' + basicnum + '([\\+|\\-|\\*|\\/|\\^]' + basicnum + ')*\\)', 'g');
            var rgxParntNum = new RegExp('\\(' + basicnum + '\\)', 'g');
            var rgxLog = new RegExp('(log|entero|redondear|ln)' + basicnum, 'g');
            var rgxcommas = new RegExp('(max|min|promedio|root)\\((' + basicnum + '\\,)*(' + basicnum + ')+\\)', 'g');
            var o = getOpts(), i, opids = _.uniq(operation.match(/(tc_)?[a-z{}]+[0-9]*/g));
            for (i = 0; i < opids.length; i++) {
                if (!_.includes(o.reservedwords, opids[i])) {
                    if (opids[i].indexOf("tc_") === 0) {
                        var tcin = identifiers[opids[i].replace("tc_", '')];
                        if (o.appvm[tcin] && o.appvm[o.appvm[tcin].elementopadre()] && o.appvm[o.appvm[tcin].elementopadre()].tipo() === o.TE.Tabla && o.appvm[o.appvm[tcin].elementopadre()].sumatoriacolumnas()[tcin])
                            operation = operation.replace(new RegExp(opids[i], 'g'), Number(o.appvm[o.appvm[tcin].elementopadre()].sumatoriacolumnas()[tcin].toString().match(rgxbasicnum).join('')));
                        else operation = operation.replace(new RegExp(opids[i], 'g'), 0);
                    }
                    else {
                        var attrval = "";
                        if (typeof identifiers === "string") attrval = o.appvm[identifiers][opids[i]];
                        else {
                            if (o.appvm[identifiers[opids[i]]])
                                if (_.includes([o.TE.Texto, o.TE.TextArea], o.appvm[identifiers[opids[i]]].tipo()))
                                    attrval = o.appvm[identifiers[opids[i]]].valor;
                                else attrval = o.appvm[identifiers[opids[i]]].valormetadato;
                            else if (isconcat) {
                                var isvarusr = _.find(o.datatags.reglasInfoDocUsr, { Valor: identifiers[opids[i]] });
                                if (isvarusr) attrval = isvarusr.Esquema;
                                else {
                                    if (opids[i] === "{line}") attrval = '\r\n';
                                    else attrval = opids[i];
                                }
                            }
                        }
                        if (attrval) {
                            var valdata = !isconcat ? !attrval() || _.isEmpty(attrval().toString()) ? [0] : attrval().toString().replace(/,/g, '').match(rgxbasicnum) :
                                typeof attrval === "string" ? attrval : attrval();
                            if (valdata && !isconcat || isconcat)
                                operation = operation.replace(new RegExp(opids[i], 'g'), isconcat ? valdata : Number(valdata));
                            else {
                                toasty('Verifique elemento', 'El valor del id ' + opids[i] + ' no es num&eacute;rico.', 'error');
                                return;
                            }
                        }
                        else {
                            toasty('Verfique su f&oacute;rmula', 'No se localiz&oacute; el identificador ' + opids[i] + " en la f&oacute;rmula:" + origop, "error");
                            return 0;
                        }
                    }
                }
            }
            operation = "(" + operation + ")";
            while (operation.indexOf("(") >= 0) {
                if (operation === opinloop) {
                    toasty('Operaci&oacute;n no v&aacute;lida', 'Revise su f&oacute;rmula y variables.');
                    return 0;
                }
                opinloop = operation;
                if (isconcat)
                    operation = operation.replace(/^\(|\)$/g, '').replace(/\+/g, '');
                else {
                    var elmnan = operation.match(rgxNan);
                    if (elmnan) {
                        toasty("", "No se puede resolver la operaci&oacute;n:" + operation, "error");
                        return 0;
                    }
                    var elmlog = operation.match(rgxLog);
                    if (elmlog) {
                        for (i = 0; i < elmlog.length; i++) {
                            var type = elmlog[i].match(/[a-z]+/g);
                            var num = elmlog[i].match(rgxbasicnum);
                            switch (type[0]) {
                                case "log": case "ln":
                                    var logtype = type[0] === "ln" ? "log" : "log10";
                                    var numlog = Math[logtype](Number(num[0]));
                                    if (_.isNaN(numlog)) {
                                        toasty('', 'Logaritmo fuera de rango.', 'error');
                                        return 0;
                                    }
                                    else
                                        operation = operation.replace(elmlog[i], numlog);
                                    break;
                                case "entero":
                                    operation = operation.replace(elmlog[i], Math.trunc(Number(num[0])));
                                    break;
                                case "redondear":
                                    operation = operation.replace(elmlog[i], Math.round(Number(num[0])));
                                    break;
                            }
                        }
                        continue;
                    }
                    var elmcommas = operation.match(rgxcommas);
                    if (elmcommas) {
                        for (i = 0; i < elmcommas.length; i++) {
                            var typecomm = elmcommas[i].match(/[a-z]+/g), numcomm = elmcommas[i].match(rgxnumcommas), nums = numcomm[0].split(','), finalres = 0, ih, recnum;
                            switch (typecomm[0]) {
                                case "promedio":
                                    var sumtotal = 0;
                                    for (ih = 0; ih < nums.length; ih++) sumtotal += Number(nums[ih]);
                                    finalres = nums.length > 0 ? sumtotal / nums.length : 0;
                                    operation = operation.replace(elmcommas[i], finalres);
                                    break;
                                case "max":
                                    for (ih = 0; ih < nums.length; ih++) {
                                        recnum = Number(nums[ih]);
                                        ih === 0 && (finalres = recnum);
                                        recnum > finalres && (finalres = recnum);
                                    }
                                    operation = operation.replace(elmcommas[i], finalres);
                                    break;
                                case "min":
                                    for (ih = 0; ih < nums.length; ih++) {
                                        recnum = Number(nums[ih]);
                                        ih === 0 && (finalres = recnum);
                                        recnum < finalres && (finalres = recnum);
                                    }
                                    operation = operation.replace(elmcommas[i], finalres);
                                    break;
                                //case "root":
                                //    var numToRoot = nums[0], root = nums[1];
                                //    if (numToRoot && root) operation = operation.replace(elmcommas[i], Math.pow(numToRoot, 1 / root));
                                //    else operation = operation.replace(elmcommas[i], 0);
                                //    break;
                            }
                        }
                        continue;
                    }
                    var elempar = operation.match(rgxParnt);
                    if (elempar) {
                        for (i = 0; i < elempar.length; i++) {
                            var origelempar = _.clone(elempar[i]);
                            var elmparnum = elempar[i].match(rgxParntNum);
                            if (elmparnum) {
                                operation = operation.replace(elmparnum[0], elmparnum[0].replace(/[\\(\\)]/g, ''));
                                continue;
                            }
                            for (var hierop in hierarchyOps) {
                                var elemparin = elempar[i].match(hierarchyOps[hierop].rgx);
                                if (elemparin) {
                                    for (var m = 0; m < elemparin.length; m++) {
                                        var pr = elemparin[m].split(hierarchyOps[hierop].op);
                                        var opleft = isconcat ? pr[0] : pr[0] === "" && Number(pr[1]) ? -Number(pr[1]) : Number(pr[0]),
                                            opright = isconcat ? pr[1] : pr[1] === "" && Number(pr[2]) ? -Number(pr[2]) : pr[2] === "" && Number(pr[3]) ? -Number(pr[3]) : Number(pr[1]);
                                        var elmregex = elemparin.length > 1 && m > 0 ? hierarchyOps[hierop].op + elemparin[m] : elemparin[m];
                                        var replaceval;
                                        switch (hierarchyOps[hierop].op) {
                                            case "^":
                                                replaceval = elemparin.length > 1 && m > 0 ? hierarchyOps[hierop].op + Math.pow(opleft, opright) : Math.pow(opleft, opright);
                                                elempar[i] = elempar[i].replace(elmregex, replaceval);
                                                break;
                                            case "*":
                                                replaceval = elemparin.length > 1 && m > 0 ? hierarchyOps[hierop].op + opleft * opright : opleft * opright;
                                                elempar[i] = elempar[i].replace(elmregex, replaceval);
                                                break;
                                            case "/":
                                                if (opright === 0) {
                                                    toasty('', 'Imposible realizar divisi&oacute;n entre cero.', 'error');
                                                    return 0;
                                                }
                                                else {
                                                    replaceval = elemparin.length > 1 && m > 0 ? hierarchyOps[hierop].op + opleft / opright : opleft / opright;
                                                    elempar[i] = elempar[i].replace(elmregex, replaceval);
                                                }
                                                break;
                                            case "+":
                                                replaceval = elemparin.length > 1 && m > 0 ? hierarchyOps[hierop].op + (opleft + opright) : opleft + opright;
                                                elempar[i] = elempar[i].replace(elmregex, replaceval);
                                                break;
                                            case "-":
                                                replaceval = elemparin.length > 1 && m > 0 ? hierarchyOps[hierop].op + (opleft - opright) : opleft - opright;
                                                elempar[i] = elempar[i].replace(elmregex, replaceval);
                                                break;
                                        }
                                    }
                                }
                            }

                            operation = operation.replace(origelempar, elempar[i]);
                        }
                    }
                }
            }
            return isconcat ? operation : _.isNaN(operation) ? 0 : parseFloat(operation);
        }
        function assignValueToElem(opelem, operation, identifiers, id) {
            opelem.inexecution = !0;
            console.log(`Ejecutando operacion ${opelem.customname} por el elemento ${id}`);
            var operands = operation.split('='), res = 0, o = getOpts();
            operands.length < 2 ? toasty(opelem.customname, 'Debe asignarse un operando de retorno', 'error') : operands.length > 2 ?
                toasty('', 'Operaci&oacute;n debe tener solo un igual', 'error') : (res = calculateOperation(operands[1], identifiers, opelem.isconcat),
                    o.appvm[identifiers[operands[0]]] ? o.appvm[identifiers[operands[0]]].valor(res) : toasty(opelem.customname, 'Error en variable de asignaci&oacute;n'));
            opelem.inexecution = !1;
        }
        function drawOperation(o, eKey) {
            var acti = $('<div class="col-sm-4 col-12 float-right h-100">\
                            <h5>F&oacute;rmula</h5><textarea class="col-sm-12 col-12"></textarea></div>\
                        <div class="col-sm-8 col-12 float-right border-right" style="max-height:50vh; overflow: auto;"><h5>Identificadores<i class="fas fa-plus-circle float-right text-green" style="font-size: 1rem;cursor: pointer;" title="Agregar identificador"></i></h5>\
                            <input type="checkbox" class="mr-1 concatvals"/><span class="text-muted">Es concatenaci&oacute;n</span>\
                            <div class="col-sm-12 col-12 no-padding"><table class="table table-condensed table-striped"><thead><tr><th class="w-50 border-bottom">Elemento</th><th class="w-50 border-bottom">Identificador</th><th class="w-50 border-bottom"></th></tr></thead></table></div>\
                        </div>');
            o.configModal.find("div.collectionelements div#elem" + eKey).append(acti);
            acti.find("textarea").on("keyup", function (e) { o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].formula = e.target.value; });
            acti.find(".fa-plus-circle").on("click", function (e) { addIdentifier(eKey, acti); });
            acti.find(".concatvals").on('change', function (e) {
                acti.find("textarea").val("");
                acti.find("tbody tr").remove();
                o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].stringConcat = e.currentTarget.checked;
                _.forEach(_.keys(o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].identifiers), function (v) { addIdentifier(eKey, acti, v); });
            });
            o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].stringConcat ? acti.find(".concatvals").click()
                : _.forEach(_.keys(o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].identifiers), function (v) { addIdentifier(eKey, acti, v); });
            acti.find("textarea").val(o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].formula);
        }
        function addIdentifier(eKey, elem, idelem) {
            var o = getOpts(), currentrow = $("<tr><td class='border-bottom'><div class='elemnum'></div></td><td class='border-bottom'><input class='col-sm-10 col-10 identifelem'></td><td class='border-bottom align-middle'><i class='far fa-trash-alt text-red pr-2' title='Borrar' style='cursor:pointer'></i></td></tr>"),
                joineddata = o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].stringConcat ? o.initializedData.numberStringElem : o.initializedData.numberElem;
            idelem = idelem ? idelem : getGuidForElem(o, "operacionesmatematicas", idelem, "identifiers", eKey);
            !!o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].identifiers || (o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].identifiers = {});
            !!o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].identifiers[idelem] || (o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].identifiers[idelem] = { idelem: "", identif: "" });
            elem.find("table").append(currentrow);
            o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].identifiers[idelem].idelem = elemsExist(joineddata, o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].identifiers[idelem].idelem, 'id');
            currentrow.find('.elemnum').combobox({
                data: joineddata, valueField: 'id', textField: 'nombre', idField: "id", prompt: 'Seleccione...', limitToList: !0,
                groupField: "parent", groupPosition: "sticky", value: o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].identifiers[idelem].idelem,
                onChange: function (nv, ov) {
                    o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].identifiers[idelem].idelem = nv;
                    _.filter(_.map(o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].identifiers, 'idelem'), function (vel) { return vel === nv; }).length > 1 &&
                        (o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].identifiers[idelem].idelem = "",
                            toasty('', 'No se pueden asignar varios identificadores a un mismo elemento', 'error'), $(this).combobox('clear'));
                }
            });
            currentrow.find(".fa-trash-alt").on("click", function (e) {
                currentrow.remove(); delete o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].identifiers[idelem];
            });
            currentrow.find(".identifelem").on("change", function (e) {
                e.target.value.match(/^[a-z]+[0-9]*$/g) ?
                    (o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].identifiers[idelem].identif = e.target.value,
                        _.includes(o.reservedwords, e.target.value) ? (o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].identifiers[idelem].identif = "",
                            toasty('', 'No se pueden utilizar palabras reservadas como identificadores', 'error'), e.target.value = "") :
                            _.filter(_.map(o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].identifiers, 'identif'), function (vel) { return vel === e.target.value; }).length > 1 &&
                            (o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].identifiers[idelem].identif = "",
                                toasty('', 'No se pueden asignar el mismo identificador a distintos elementos', 'error'), e.target.value = "")
                    ) : (toasty('', 'Identificador no v&aacute;lido', 'error'), e.target.value = "");
            });
            currentrow.find(".identifelem").val(o.appvm[o.idPlantilla].operacionesmatematicas()[eKey].identifiers[idelem].identif);
        }



        //Configurador genérico: servicios/componentes
        function drawNewRowJSON(o, s, os, attr, datainfo) {
            o = o || getOpts();
            if (!_.includes(["servicios", "components"], attr) && !o.appvm[o.idPlantilla][attr]) return;
            var acti = $('<div class="rowservice' + s + ' align-top row" style="height:70vh; overflow:auto;">\
                <div class="serviceverb'+ s + ' border-right w-25">\
                    <div class="col-sm-12 col-12 pl-0">\
                        <div class="selserv"></div>\
                    </div>' + (attr === "servicios" ?
                    '<div class="col-sm-12 col-12 pl-0 pt-2">\
                        <strong style="color: red;">Lo de arriba ya es OBSOLETO, debe migrar sus servicios a la parte de abajo o seran borrados en futuras versiones.</strong><br/><br/>\
                        <p>Lista de servicios disponibles (Si no encuentra un servicio, contacte con su proveedor del servicio)<div class="selserv2"></div></p>\
                        <p>Nombre del metodo del servicio (Si no sabe que poner contacte con su proveedor del servicio)<textarea rows="3" class="form-control" id="serviciosv2namespace"></textarea></p>\
                        <p>Ruta de la dll que ejecutará el servicio<textarea rows="3" class="form-control" id="serviciosv2path"></textarea></p>\
                        <p>Prefijo que se utilizara para identificar los campos de entrada<input type="text" class="form-control" id="serviciosv2prein" /></p>\
                        <p>Prefijo que se utilizara para identificar los campos de salida<input type="text" class="form-control" id="serviciosv2preout" /></p>\
                    </div>' : "") +
                '</div>\
                <div class="servicepin'+ s + ' border-right w-25"></div>\
                <div class="servicepout'+ s + ' border-right w-25"></div>\
                <div class="serviceresponse'+ s + ' w-25"></div>\
            </div>'), idname = "id", textname = "name";
            o.configModal.find("div.collectionelements div#elem" + s).append(acti[0]), acti.find(".selserv").css({ width: "100%" }).combobox({
                data: datainfo, value: elemsExist(datainfo, os.id, idname), valueField: idname, textField: textname, idField: idname, prompt: 'Seleccione...', limitToList: !0,
                onSelect: function (item) { o.appvm[o.idPlantilla][attr]()[s].id = item[idname], changeparamsJSON(s, item, attr); }, height: 80, multiline: true, disabled: attr === "servicios",
                onUnselect: function () {
                    o.appvm[o.idPlantilla][attr]()[s].pin = {}, o.appvm[o.idPlantilla][attr]()[s].pout = {}, o.appvm[o.idPlantilla][attr]()[s].response = {}, o.appvm[o.idPlantilla][attr]()[s].id = "";
                    o.configModal.find('.servicepin' + s + ',.servicepout' + s + ',.serviceresponse' + s).contents().remove();
                }
            });
            if (attr === "servicios") {
                var v2data = [
                    {
                        id: "FolioAutomatico", name: "Generador de folio automático (Sirve para generar un folio previamente configurado)",
                        initialmethod: "ServiciosDigipro.ServicioFolioAutomatico.FolioAutomatico", assemblypath: "..\\..\\wcfservicios\\bin\\ServiciosDigipro.dll",
                        descentrada: "Los parametros de entrada son:<br/>\
                            <ol>\
                                <li>\
                                    <strong>Tipo de Folio: <em>prefijo_</em>provedor</strong>\
                                    <ul><li>DIGIPRO</li><li>AMEX</li></ul>\
                                </li>\
                            </ol>",
                        descsalida: "Los parametros de salida son:<br/>\
                            <ol>\
                                <li>\
                                    <strong>Folio generado: <em>prefijo_</em>Folio</strong>\
                                </li>\
                            </ol>"
                    },
                    {
                        id: "TokenVeridas", name: "Generador de token para uso de servicio Veridas (Sirve para generar una token para el uso de los servicios y componentes de veridas)",
                        initialmethod: "ServiciosDigipro.ServicioVeridas.GetToken", assemblypath: "..\\..\\wcfservicios\\bin\\ServiciosDigipro.dll",
                        descentrada: "Los parametros de entrada son:<br/>\
                            <ol>\
                                <li>\
                                    <strong>ESTE SERVICIO NO CUENTA CON PARAMETRO DE ENTRADA <em></em></strong>\
                                    <ul><li></li>\
                                </li>\
                            </ol>",
                        descsalida: "Los parametros de salida son:<br/>\
                            <ol>\
                                <li>\
                                    <strong>Token Veridas: <em>veridas_</em>tokenid</strong>\
                                </li>\
                            </ol>"
                    },
                    {
                        id: "SubirDocumentosVeridas", name: "Sube las imagenes al servidor y al proveedor (Sirve para realizar una peticion al servidor y poder subir las imagenes al proveedor de Veridas)",
                        initialmethod: "ServiciosDigipro.ServicioVeridas.UploadDocuments", assemblypath: "..\\..\\wcfservicios\\bin\\ServiciosDigipro.dll",
                        descentrada: "Los parametros de entrada son:<br/>\
                            <ol>\
                                <li>\
                                    <strong>INE Anverso Base64: <em>veridas_</em>base64anverso</strong>\
                                    <strong>INE Reverso Base64: <em>veridas_</em>base64reverso</strong>\
                                    <ul><li></li>\
                                </li>\
                            </ol>",
                        descsalida: "Los parametros de salida son:<br/>\
                            <ol>\
                                <li>\
                                    <strong><em>Veridas_</em></strong>\
                                </li>\
                            </ol>"
                    },
                    {
                        id: "FirmaCursiva", name: "Generador de firma cursiva (Sirve para generar una firma cursiva mediante un elemento texto)",
                        initialmethod: "ServiciosDigipro.ServicioFirmaCursiva.ObtenFirmaCursiva", assemblypath: "..\\..\\wcfservicios\\bin\\ServiciosDigipro.dll",
                        descentrada: "Los parametros de entrada son:<br/>\
                            <ol>\
                                <li>\
                                    <strong>Nombre en firma: <em>prefijo_</em>name</strong>\
                                    <ul><li>NOMBRE DE USUARIO</li>\
                                </li>\
                            </ol>",
                        descsalida: "Los parametros de salida son:<br/>\
                            <ol>\
                                <li>\
                                    <strong>Firma generado: <em>prefijo_</em>Firma</strong>\
                                </li>\
                            </ol>"
                    },
                    {
                        id: "ConsultaOTPSMS", name: "Genera la consulta de OTP enviado por SMS (Sirve para generar una consulta de OTP por SMS)",
                        initialmethod: "ServiciosDigipro.ServicioSms.ConsultaOTP", assemblypath: "..\\..\\wcfservicios\\bin\\ServiciosDigipro.dll",
                        descentrada: "Los parametros de entrada son:<br/>\
                            <ol>\
                                <li>\
                                    <strong>Número Telefónico: <em>prefijo_</em>name</strong>\
                                    <ul><li>NOMBRE DE USUARIO</li>\
                                </li>\
                            </ol>",
                        descsalida: "Los parametros de salida son:<br/>\
                            <ol>\
                                <li>\
                                    <strong>Firma generado: <em>prefijo_</em>Firma</strong>\
                                </li>\
                            </ol>"
                    }
                ];
                acti.find(".selserv2").css({ width: "100%" }).combobox({
                    data: v2data, value: elemsExist(v2data, os.id, idname), valueField: idname, textField: textname, idField: idname, prompt: 'Seleccione...', limitToList: !0,
                    onSelect: function (item) {
                        //limpiado del combo anterior y datos viejos
                        o.appvm[o.idPlantilla][attr]()[s].pin = {}, o.appvm[o.idPlantilla][attr]()[s].pout = {}, o.appvm[o.idPlantilla][attr]()[s].response = {}, o.appvm[o.idPlantilla][attr]()[s].id = "";
                        o.configModal.find('.servicepin' + s + ',.servicepout' + s + ',.serviceresponse' + s).contents().remove();

                        o.appvm[o.idPlantilla][attr]()[s].id = item[idname];
                        o.appvm[o.idPlantilla][attr]()[s].initialmethod = item.initialmethod;
                        o.appvm[o.idPlantilla][attr]()[s].assemblypath = item.assemblypath;
                        acti.find("#serviciosv2namespace").val(item.initialmethod);
                        acti.find("#serviciosv2path").val(item.assemblypath);
                        o.configModal.find('.servicepin' + s).append(item.descentrada);
                        o.configModal.find('.servicepout' + s).append(item.descsalida);
                    }, height: 80, multiline: true, onUnselect: function () {
                        o.appvm[o.idPlantilla][attr]()[s].response = {};
                        o.configModal.find('.servicepin' + s + ',.servicepout' + s + ',.serviceresponse' + s).contents().remove();
                    }
                });
                acti.find("#serviciosv2namespace").on("change", function (e) { o.appvm[o.idPlantilla][attr]()[s].initialmethod = e.target.value; }).val(o.appvm[o.idPlantilla][attr]()[s].initialmethod);
                acti.find("#serviciosv2path").on("change", function (e) { o.appvm[o.idPlantilla][attr]()[s].assemblypath = e.target.value; }).val(o.appvm[o.idPlantilla][attr]()[s].assemblypath);
                acti.find("#serviciosv2prein").on("change", function (e) { o.appvm[o.idPlantilla][attr]()[s].prefijoentrada = e.target.value; }).val(o.appvm[o.idPlantilla][attr]()[s].prefijoentrada);
                acti.find("#serviciosv2preout").on("change", function (e) { o.appvm[o.idPlantilla][attr]()[s].prefijosalida = e.target.value; }).val(o.appvm[o.idPlantilla][attr]()[s].prefijosalida);
                _.forEach(_.keys(o.servResponseBase), function (v) { determineResponseParamsJSON(o, v, s, attr); }); //se dibuja desde el principio con servicios v2
            }
            updateOpts(o, !0);
        }
        function changeparamsJSON(s, jsonobj, attr) {
            var o = getOpts();
            o.configModal.find('.servicepin' + s + ',.servicepout' + s + ',.serviceresponse' + s).contents().remove();
            var keypin = _.keys(_.orderBy(jsonobj.pin.method, ["order"], ["asc"]));
            _.forEach(keypin, function (v) { determineInOutParamsJSON(o, 'pin', v, s, jsonobj.pin.method, attr); });
            //ya que se pinto todo lo que tiene el json, se quita el sobrante por si se paso de un json con mas parametros de los que tiene el nuevo
            for (var k in o.appvm[o.idPlantilla][attr]()[s]["pin"]) {
                var found = !1;
                for (var i in keypin) if (k === "order_" + jsonobj.pin.method[i].order) { found = !0; break; }
                if (!found) delete o.appvm[o.idPlantilla][attr]()[s]["pin"][k];
            }
            var keypout = _.keys(_.orderBy(jsonobj.pout, ["order"], ["asc"]));
            _.forEach(keypout, function (v) { determineInOutParamsJSON(o, 'pout', v, s, jsonobj.pout, attr); });
            //ya que se pinto todo lo que tiene el json, se quita el sobrante por si se paso de un json con mas parametros de los que tiene el nuevo
            for (var k1 in o.appvm[o.idPlantilla][attr]()[s]["pout"]) {
                var found1 = !1;
                for (var i1 in keypout) if (k1 === "order_" + jsonobj.pout[i1].order) { found1 = !0; break; }
                if (!found1) delete o.appvm[o.idPlantilla][attr]()[s]["pout"][k1];
            }
            _.forEach(_.keys(o.servResponseBase), function (v) { determineResponseParamsJSON(o, v, s, attr); }); //se redibuja por ser servicio v1
        }
        function determineInOutParamsJSON(o, inout, odkey, s, oriObj, attr) {
            var copyServ = undefined;
            var paramid = "order_" + oriObj[odkey].order,
                oriServ = oriObj[odkey], data, odh = $('<div class="col-sm-12 d-flex flex-column pb-2">\
                    <span class="font-italic">' + oriServ.name + '  <i style="cursor: pointer;" class="fas fa-question-circle"></i></span>\
                    <div class="' + paramid + '"></div>\
                </div>');
            copyServ = o.appvm[o.idPlantilla][attr]()[s][inout][paramid];
            !o.appvm[o.idPlantilla][attr]()[s][inout] && (o.appvm[o.idPlantilla][attr]()[s][inout] = oriObj);
            if (!copyServ)
                copyServ = o.appvm[o.idPlantilla][attr]()[s][inout][paramid] = { idelem: oriObj[odkey].idelem, name: oriObj[odkey].name, value: oriObj[odkey].value };
            if (!copyServ.hasOwnProperty("idelem"))
                o.appvm[o.idPlantilla][attr]()[s][inout][paramid].idelem = oriObj[odkey].idelem;
            if (!copyServ.hasOwnProperty("name"))
                o.appvm[o.idPlantilla][attr]()[s][inout][paramid].name = oriObj[odkey].name;
            if (!copyServ.hasOwnProperty("value"))
                o.appvm[o.idPlantilla][attr]()[s][inout][paramid].value = oriObj[odkey].value;
            copyServ = o.appvm[o.idPlantilla][attr]()[s][inout][paramid];
            if (!oriServ.controltype) {
                if (oriServ.options && oriServ.options.length) oriServ.controltype = "elem";
                else oriServ.controltype = "";
            }
            switch (oriServ.controltype) {
                case "elem":
                    data = [];
                    _.forEach(oriServ.options, function (vol) {
                        var newdata = [], sp;
                        newdata = vol.indexOf("lista-") >= 0 ? (sp = vol.split("-"), sp[1] ?
                            _.filter(o.initializedData.aggroupeddata[sp[0]], { tipolista: sp[1] }) : [])
                            : o.initializedData.aggroupeddata[vol];
                        data = _.union(data, newdata);
                    });
                    odh.find('.' + paramid).combobox({
                        data: _.sortBy(data, ["parentpage"]),
                        valueField: 'id', textField: 'nombre', prompt: 'Seleccione...', groupField: "parentpage", groupPosition: "sticky",
                        value: elemsExist(data, copyServ.idelem, 'id'), limitToList: !0,
                        onSelect: function (sv) { o.appvm[o.idPlantilla][attr]()[s][inout][paramid].idelem = sv.id; },
                        onUnselect: function (sv) { o.appvm[o.idPlantilla][attr]()[s][inout][paramid].idelem = ""; }
                    });
                    break;
                case "selector":
                    data = "";
                    _.forEach(_.keys(oriServ.options), function (vol) { data += '<option value="' + vol + '">' + oriServ.options[vol] + '</option>'; });
                    odh.find('.' + paramid).append('<select class="form-control">' + data + '</select>');
                    odh.find('.' + paramid).find('select').on('change', function (sv) { o.appvm[o.idPlantilla][attr]()[s][inout][paramid].value = sv.target.value; });
                    odh.find('.' + paramid).find('select').find("option[value='" + copyServ.value + "']").prop('selected', !0).end().trigger("change");
                    break;
                case "textarea":
                    data = copyServ.value === undefined ? "" : copyServ.value.toString();
                    odh.find('.' + paramid).append($('<textarea class="form-control form-control-sm" rows="4">' + data + '</textarea>').on("change", function (sv) { o.appvm[o.idPlantilla][attr]()[s][inout][paramid].value = sv.target.value; }));
                    break;
                default:
                    data = copyServ.value === undefined ? "" : copyServ.value.toString();
                    odh.find('.' + paramid).append($('<input class="form-control form-control-sm" type="text" value="' + data + '" />').on("change", function (sv) { o.appvm[o.idPlantilla][attr]()[s][inout][paramid].value = sv.target.value; }));
                    break;
            }
            if (oriServ.descesquema && oriServ.descesquema.length) {
                var content = "<div>" + oriServ.descesquema + "</div><div><code>" + JSON.stringify(oriServ.esquema) + "</code></div>";
                odh.find("i.fa-question-circle").popover({ content: content, html: true, placement: "bottom", trigger: "click" });
            }
            else odh.find("i.fa-question-circle").hide();
            o.configModal.find('.service' + inout + s).append(odh);
        }
        function determineResponseParamsJSON(o, v, id, attr) {
            !o.appvm[o.idPlantilla][attr]()[id].response && (o.appvm[o.idPlantilla][attr]()[id].response = {});
            var mt;
            switch (v) {
                case "rulesuccess": case "ruleerror": case "messagetype": case "showmessage": case "zexecutekey":
                case "zexecutetimenumber": case "zexecutetimetype": case "waittofinish": case "evaluaterules":
                    var odh = $('<div class="col-sm-12 d-flex flex-column pb-2"><span class="font-italic"></span><div class="' + v + '"></div></div>'),
                        resp = o.appvm[o.idPlantilla][attr]()[id].response; resp[v] === undefined && (resp[v] = o.servResponseBase[v]);
                    switch (v) {
                        case "rulesuccess": case "ruleerror":
                            odh.find('span').text(v === "rulesuccess" ? he.decode("Regla a ejecutar al terminar el componente") : "Regla a ejecutar si ocurre un error");
                            odh.find('span').append('<a tabindex="0" class="far fa-question-circle ml-2"></a>');
                            odh.find('a').popover({ html: true, content: "No es necesario configurar las condiciones, solamente las acciones.", trigger: "focus" });
                            var stillexists = elemsExist(o.initializedData.aggroupedrules, (typeof resp[v] === 'object') ? _.keys(resp[v]) : resp[v], 'id');
                            resp[v] = {};
                            _.forEach(stillexists, (r) => { resp[v][r] = ''; });
                            odh.find('.' + v).combobox({
                                data: o.initializedData.aggroupedrules, valueField: 'id', textField: 'nombre', prompt: 'Seleccione...',
                                value: stillexists, limitToList: !0, multiple: !0, height: 80, multiline: true,
                                onSelect: function (sv) { if (typeof resp[v] !== 'object') resp[v] = {}; resp[v][sv.id] = ''; },
                                onUnselect: function (sv) { if (typeof resp[v] !== 'object') resp[v] = {}; delete resp[v][sv.id]; }
                            });
                            break;
                        case "messagetype":
                            odh.find('span').text("Tipo de mensaje");
                            mt = $('<select class="form-control"></select>');
                            mt.append('<option value="notif">Notificación</option>');
                            mt.append('<option value="popup">Pop up</option>');
                            mt.on("change", function () { resp[v] = $(this).val(); });
                            odh.find('.' + v).append(mt);
                            break;
                        case "showmessage":
                            odh.find('span').text("¿Desea ver el mensaje cuando terminá el componente?");
                            odh.find('.' + v).switchbutton({
                                checked: resp[v], onChange: function (checked) { resp[v] = checked; }
                            });
                            break;
                        case "zexecutekey": case "zexecutetimenumber":
                            v.indexOf("number") >= 0 ? odh.find('span').text(he.decode("Tiempo de espera para volver a ejecutar despues de exceder el limite")) : odh.find('span').text("Número de veces que se permite ejecutar durante la captura (0 es infinitamente)");
                            odh.find('.' + v).append("<input type='number'/>");
                            odh.find('input').on("change", function (e) { e.target.value.toString().match(/^[0-9]+$/g) ? resp[v] = e.target.value : e.target.value = ""; });
                            odh.find('input').val(resp[v]);
                            break;
                        case "zexecutetimetype":
                            odh.find('span').text("Unidad de tiempo");
                            mt = $('<select class="form-control"></select>');
                            mt.append('<option value="min">Minutos</option>');
                            mt.append('<option value="hrs">Horas</option>');
                            mt.append('<option value="days">D&iacute;as</option>');
                            mt.on("change", function () { resp[v] = $(this).val(); });
                            odh.find('.' + v).append(mt);
                            break;
                        case "evaluaterules":
                            odh.find('span').text("¿Evaluar las condiciones de las reglas?");
                            odh.find('.' + v).switchbutton({
                                checked: resp[v], onChange: function (checked) { resp[v] = checked; }
                            });
                            break;
                        case "waittofinish":
                            odh.find('span').text(he.decode("Tiempo de espera para ejecutar las reglas (milisegundos)"));
                            odh.find('.' + v).append("<input type='number'/>");
                            odh.find('input').on("change", function (e) { e.target.value.toString().match(/^[0-9]+$/g) ? resp[v] = e.target.value : e.target.value = ""; });
                            odh.find('input').val(resp[v]);
                            break;
                    }
                    o.configModal.find('.serviceresponse' + id).append(odh);
                    break;
            }
        }



        //Configurador genérico: reglas
        function addRowCondition(o, r, co) {
            var c = r + '_' + co, condition = $('<div class="rowcondition' + c + '" style="border-bottom: 1px solid #d4d3d3;">\
                <div class="w-100 pt-2">\
                        <div class="row py-2">\
                            <div class="btn btn-sm far fa-trash-alt removecondition text-red" title="Eliminar condici&oacute;n"></div>\
                            <div class="pr-2 pt-1" for="logicrule'+ c + '">Categor&iacute;a:</div>\
                            <div class="categorysubject' + c + '"></div>\
                        </div>\
                    <table class="mb-2 table table-bordered table-condensed table-sm conditiontablerow'+ c + '"></table>\
                </div>\
            </div>');
            o.configModal.find(".conditionsrules" + r).append(condition),
                !o.appvm[o.idPlantilla].reglas()[r].conditions[co].category && changecategorysubject(r, co, "elementid"),
                o.configModal.find(".categorysubject" + c).css({ width: "70%" }).combobox({
                    data: [{ value: "elementid", desc: "Elementos" },
                    { value: "document", desc: "Flujos" },
                    { value: "permissions", desc: "Permisos" },
                    { value: "table", desc: "Tablas por columna" },
                    { value: "bytable", desc: "Tablas por filas" },
                    { value: "withoutcondition", desc: "Sin Condiciones (Usada para servicios o ejecucion de reglas)" }],
                    valueField: "value", textField: "desc", panelHeight: "auto", editable: !1,
                    prompt: "Seleccione...", limitToList: !0, value: o.appvm[o.idPlantilla].reglas()[r].conditions[co].category,
                    onChange: function (item) { changecategorysubject(r, co, item); }
                }), changecategorysubject(r, co, o.appvm[o.idPlantilla].reglas()[r].conditions[co].category),
                condition.find(".removecondition").on("click", function () { removeRuleType(r, co, "", "condi"); }),
                _.size(o.appvm[o.idPlantilla].reglas()[r].conditions) === 1 ? o.configModal.find(".bodyrule" + r + " .removecondition").hide() : o.configModal.find(".bodyrule" + r + " .removecondition").show();
        }
        function addRowAction(o, r, ac, isnewdraw) {
            var cont = '', c = r + '_' + ac, data = o.datatags.accionesreglas;
            if (isnewdraw) cont = '<div class="actionpredicate' + c + '"></div>';
            else cont = '<tr class="rowaction' + c + '" style="border-bottom: 1px solid #d4d3d3;">\
                <td class="text-center align-middle removeaction"><i style="cursor: pointer;" class="far fa-trash-alt text-red" title="Eliminar acci&oacute;n"></i></td>\
                <td style="font-size: 0.9rem;" class="align-middle border-right">\
                    <div class="align-items-center flex-column d-flex px-2"><i style="cursor: pointer" class="fas fa-angle-up moveup" hidden></i><i style="cursor: pointer" class="fas fa-angle-down movedown" hidden></i></div>\
                </td>\
                <td class="align-middle"><div class="actord px-2"></div></td>\
                <td class="align-middle border-right actionverb'+ c + '" style="width:30%">\
                    <div class="col-sm-12 col-12" style="padding-left: 0;">\
                        <div class="selectactionverb'+ c + '"></div>\
                        <p class="text-muted no-margin"></p>\
                        <div class="negact pt-1 align-items-center" style="display:inline-flex" hidden><input type="checkbox"><span class="pl-2">Negaci&oacute;n</span></div>\
                    </div>\
                </td>\
                <td class="align-middle border-right actionsubject'+ c + '" style="width:30%"></td>\
                <td class="align-middle actionpredicate'+ c + '" style="width:30%"></td>\
            </tr>';
            var acti = $(cont), valsel = _.find(data, function (vol) { return vol.Valor === o.appvm[o.idPlantilla].reglas()[r].actions[ac].verb; });
            o.configModal.find(".actionsrules" + r).append(acti), acti.find(".selectactionverb" + c).css({ width: "100%" }).combobox({
                data: _.sortBy(data, ["Grupo"]), value: valsel ? valsel.Valor : "", limitToList: !0,
                valueField: 'Valor', textField: 'Nombre', groupField: "Grupo", idField: "Valor", groupPosition: "sticky", prompt: 'Seleccione...',
                onSelect: function (item) {
                    acti.find('p').text(item.Esquema),
                        item.TieneEsquema ? acti.find('.negact').removeAttr("hidden") : acti.find('.negact').attr("hidden", ""), changeactionverb(r, ac, item.Valor, item.Grupo);
                }
            }), acti.find(".removeaction i").on("click", function () { removeRuleType(r, ac, "", "acti"); }),
                acti.find(".moveup").on("click", function () { moveupdownaction(r, ac, !0); }),
                acti.find(".movedown").on("click", function () { moveupdownaction(r, ac, !1); }),
                acti.find(".actord").text(o.appvm[o.idPlantilla].reglas()[r].actions[ac].order),
                acti.find('.negact input').on("change", function (e) {
                    o.appvm[o.idPlantilla].reglas()[r].actions[ac].negation = e.target.checked;
                });
            !!o.appvm[o.idPlantilla].reglas()[r].actions[ac].negation && o.appvm[o.idPlantilla].reglas()[r].actions[ac].negation && acti.find('.negact input').attr("checked", "checked");
            reorderActionAngles(o, r);
            _.size(o.appvm[o.idPlantilla].reglas()[r].actions) === 1 ? o.configModal.find(".bodyrule" + r + " .removeaction i").attr("hidden", "") :
                o.configModal.find(".removeaction i").removeAttr("hidden");
        }
        function assignCondition(o, r, co) {
            var cat = o.jobj.elemento.atributos.reglas[r].conditions[co].category, s, subj,
                rn = o.jobj.elemento.atributos.reglas[r].name, l = o.jobj.elemento.atributos.reglas[r].logic;
            o.conditions || (o.conditions = {}), o.conditions[r] || (o.conditions[r] = { executeonerulebytime: true }), o.conditions[r][co] || (o.conditions[r][co] = {});
            switch (cat) {
                case "elementid":
                    for (s in o.jobj.elemento.atributos.reglas[r].conditions[co].subject) {
                        subj = o.jobj.elemento.atributos.reglas[r].conditions[co].subject[s].subject;
                        o.conditions[r][co][subj] || (o.conditions[r][co][subj] = {}),
                            o.conditions[r][co][subj] = assignConditionFunction(o, rn, cat, l, o.jobj.elemento.atributos.reglas[r].conditions[co].subject[s].verb, subj, o.jobj.elemento.atributos.reglas[r].conditions[co].subject[s].predicate);
                    }
                    break;
                case "bytable":
                    var cond = o.jobj.elemento.atributos.reglas[r].conditions[co], idtablecond = cond.tableidelem;
                    o.conditions[r][co][idtablecond] || (o.conditions[r][co][idtablecond] = {}),
                        o.conditions[r][co][idtablecond] = function () { return resolveConditionByRow(o, cat, cond); };
                    break;
                case "table":
                    var tbls = [];
                    for (s in o.jobj.elemento.atributos.reglas[r].conditions[co].subject)
                        subj = o.jobj.elemento.atributos.reglas[r].conditions[co].subject[s].subject, o.appvm[subj] && tbls.push(o.appvm[subj].elementopadre());
                    tbls = _.intersection(tbls);
                    for (var t = 0; t < tbls.length; t++) {
                        o.conditions[r][co][tbls[t]] || (o.conditions[r][co][tbls[t]] = {}), o.conditions[r][co][tbls[t]] = function () {
                            var subj2, verb2, pred2, arrayres = [], finalres = [], res, colserror, everyres, l = o.jobj.elemento.atributos.reglas[r].logic;
                            //mejorar algoritmo para soportar bien multiples tablas, por el momento amarrado a una tabla
                            for (var t2 in tbls) {
                                colserror = [];
                                if (!(o.appvm[tbls[t2]].valorjson() instanceof Array)) o.appvm[tbls[t2]].valorjson([]);
                                for (var f = 0; f < o.appvm[tbls[t2]].valorjson().length; f++) {
                                    for (var s2 in o.jobj.elemento.atributos.reglas[r].conditions[co].subject) {
                                        subj2 = o.jobj.elemento.atributos.reglas[r].conditions[co].subject[s2].subject;
                                        verb2 = o.jobj.elemento.atributos.reglas[r].conditions[co].subject[s2].verb;
                                        pred2 = o.jobj.elemento.atributos.reglas[r].conditions[co].subject[s2].predicate;
                                        if (o.appvm[tbls[t2]].valorjson()[f][subj2])
                                            res = resolveConditionByRowTable(o, rn, cat, subj2, verb2, pred2, o.appvm[tbls[t2]].valorjson()[f][subj2]),
                                                console.log("Resultado de subcondicion: sujeto:" + subj2 + "-verbo:" + verb2 + "-" + (res ? "SI" : "NO")), res && colserror.push({ r: f, s: subj2 }), arrayres.push(res);
                                    }
                                    everyres = _.every(arrayres, function (v) { return v; });
                                    o.errortable[r] ? !_.find(o.errortable[r], function (vol) { return vol === tbls[t2]; }) && (o.errortable[r].push(tbls[t2]), o.appvm[tbls[t2]].errorjson({}))
                                        : o.errortable[r] = [];
                                    if (everyres) for (var w = 0; w < colserror.length; w++) {
                                        !o.appvm[tbls[t2]].errorjson()[colserror[w].r] && (o.appvm[tbls[t2]].errorjson()[colserror[w].r] = {});
                                        o.appvm[tbls[t2]].errorjson()[colserror[w].r][colserror[w].s] = !0;
                                    }

                                    finalres.push(everyres), arrayres = [], colserror = [];
                                }
                            }
                            return finalres.length ? _.some(finalres, function (v) { return v; }) : !1;
                        }, o.appvm[tbls[t]].bindcondition(true);
                    }
                    break;
                case "document": case "permissions":
                    o.conditions[r][co][o.idPlantilla] || (o.conditions[r][co][o.idPlantilla] = {}), o.conditions[r][co][o.idPlantilla] = function () {
                        var subj2;
                        for (var s2 in o.jobj.elemento.atributos.reglas[r].conditions[co].subject) {
                            subj2 = o.jobj.elemento.atributos.reglas[r].conditions[co].subject[s2].subject;
                            return _.find(o.datatags.reglasInfoDocUsr, function (v) { return v.Valor + "_" + v.Esquema === subj2; }) !== undefined;
                        }
                    };
                    break;
            }
        }
        function assignConditionFunction(o, rn, cat, l, v, s, p) {
            if (o.appvm[s]) {
                o.appvm[s].bindcondition(true);
                switch (v) {
                    case "deviceinuse": return assignCustomFunction(o, rn, cat, l, v, s, p, function () {
                        var result = p.value === "isios" || p.value === "isandroid" ? false :
                            p.value === "iswebmov" ? (Modernizr.mobile || Modernizr.tablet) : Modernizr.desktop === !0;
                        return result;
                    });
                    case "loaded": return assignCustomFunction(o, rn, cat, l, v, s, p, function () { return o.finishload === !0; });
                    case "save": return assignCustomFunction(o, rn, cat, l, v, s, p, function () { return o.isSaving === !0; });
                    case "contains": case "notcontains": case "equals": case "notequals":
                        return assignCustomFunction(o, rn, cat, l, v, s, p, function () {
                            var ta, valcomp = "", valorig = "", b, tipovalorcomp, isequals = v.indexOf("equals") >= 0,
                                tipovalororig = _.includes([o.TE.Fecha, o.TE.Lista, o.TE.MarcadoDocumentos, o.TE.ComboDinamico], o.appvm[s].tipo()) ? "valormetadato" : o.appvm[s].tipo() === o.TE.RangoFechas ? "valormetadatorango" : "valor";
                            if (_.includes([o.TE.Lista, o.TE.MarcadoDocumentos], o.appvm[s].tipo())) {
                                var tap = o.appvm[s].tipoasociacion(), chosenitems = [],
                                    lc = tap.indexOf("id") === 0 ? "valormetadato" : "valor";
                                var idschosen = o.appvm[s][lc]().toString().split(",");
                                chosenitems = _.filter(o.datatags.allitemscatalogs[o.appvm[s].fuentedatos() + "|" + o.appvm[s].catalogoorigen()], function (idch) {
                                    return _.includes(idschosen, idch[tap === "descdesc" ? "Nombre" : "Valor"]);
                                });
                                valorig = _.map(chosenitems, 'Valor');
                            }
                            else valorig = o.appvm[s][tipovalororig]();
                            if (p.mode === "element" && o.appvm[p.value]) {
                                tipovalorcomp = _.includes([o.TE.Fecha, o.TE.Lista, o.TE.MarcadoDocumentos], o.appvm[p.value].tipo()) ? "valormetadato" : o.appvm[p.value].tipo() === o.TE.RangoFechas ? "valormetadatorango" : "valor";
                                if (_.includes([o.TE.Lista, o.TE.MarcadoDocumentos], o.appvm[p.value].tipo())) {
                                    ta = o.appvm[p.value].tipoasociacion().indexOf("id") === 0 ? "Valor" : "Nombre";
                                    if (o.appvm[p.value].tipolista() === "radio" || o.appvm[p.value].tipolista() === "combo")
                                        valcomp = _.map(_.filter(o.datatags.allitemscatalogs[o.appvm[p.value].fuentedatos() + "|" + o.appvm[p.value].catalogoorigen()], function (vaele) { return vaele[ta] === o.appvm[p.value][tipovalorcomp](); }), 'Valor');
                                    else if (o.appvm[p.value].tipolista() === "checkbox")
                                        valcomp = _.map(_.filter(o.datatags.allitemscatalogs[o.appvm[p.value].fuentedatos() + "|" + o.appvm[p.value].catalogoorigen()], function (elem) { return _.intersection([elem[ta].replace(/\s/g, '')], o.appvm[p.value][tipovalorcomp]().replace(/\s/g, '').split(',')).length > 0; }), 'Valor');
                                    valorig = typeof valorig === "string" || typeof valorig === "number" ? [valorig] : valorig;
                                    valcomp = typeof valcomp === "string" || typeof valcomp === "number" ? [valcomp] : valcomp;
                                    b = _.intersection(valorig, valcomp).length > 0;
                                }
                                else valcomp = o.appvm[p.value][tipovalorcomp](), b = isequals ? valorig.toString().toLowerCase() === valcomp.toString().toLowerCase() : valcomp !== "" ? valorig.toString().toLowerCase().indexOf(valcomp.toString().toLowerCase()) >= 0 : false;
                            }
                            else if (p.mode === "varusr") {
                                p.value = _.uniq(typeof p.value === "string" || typeof p.value === "number" ? [p.value] : p.value);
                                _.forEach(p.value, function (vel) {
                                    if (vel.toLowerCase() === "today") valcomp = moment(new Date()).format('YYYYMMDD');
                                    else if (vel.toLowerCase() === "now") valcomp = moment(new Date()).format('HH:mm');
                                    else {
                                        var mo = _.find(o.datatags.reglasInfoDocUsr, function (v) { return v.Valor === vel; });
                                        mo !== undefined && (valcomp += mo.Esquema + " ");
                                    }
                                });
                                b = isequals ? valorig.trim().toString().toLowerCase() === valcomp.trim().toString().toLowerCase() : valcomp !== "" ? valorig.trim().toString().toLowerCase().indexOf(valcomp.trim().toString().toLowerCase()) >= 0 : false;
                            }
                            else if (p.mode === "words") {
                                if (o.appvm[s].tipo() === o.TE.Fecha)
                                    p.value = p.value.indexOf(o.appvm[s].separador()) >= 0 ? dateToUniversal(o, s, p.value) : p.value;
                                if (_.includes([o.TE.Lista, o.TE.MarcadoDocumentos], o.appvm[s].tipo())) {
                                    valcomp = typeof p.value === "string" || typeof p.value === "number" ? [p.value] : p.value;
                                    valorig = typeof valorig === "string" || typeof valorig === "number" ? [valorig] : valorig;
                                    valcomp = _.map(valcomp, function (valele) { return valele.toString(); });
                                    b = _.intersection(valorig, valcomp).length > 0;
                                }
                                else
                                    b = isequals ? valorig.toString().toLowerCase() === p.value.toString().toLowerCase() : p.value && !_.isEmpty(p.value.toString()) ? valorig.toString().toLowerCase().indexOf(p.value.toString().toLowerCase()) >= 0 : false;
                            }
                            return v.indexOf("not") >= 0 ? !b : b;
                        });
                    case "empty": case "notempty":
                        return assignCustomFunction(o, rn, cat, l, v, s, p, function () {
                            var b;
                            if (o.appvm[s].tipo() === o.TE.Documento) b = _.isEmpty(o.appvm[s].anexo());
                            else if (o.appvm[s].tipo() === o.TE.Georeferencia) b = !o.appvm[s].valormetadato();
                            else if (o.appvm[s].nombrearchivo) b = !o.appvm[s].nombrearchivo();
                            else if (o.appvm[s].valormetadatorango) b = !o.appvm[s].valormetadatorango();
                            else if (o.appvm[s].valor) b = _.isNumber(o.appvm[s].valor()) ? _.isEmpty(o.appvm[s].valor().toString()) : _.isEmpty(o.appvm[s].valor());
                            return v.indexOf("not") >= 0 ? !b : b;
                        });
                    case "selected": case "notselected":
                        return assignCustomFunction(o, rn, cat, l, v, s, p, function () {
                            var b = !!o.appvm[s].valor(); return v.indexOf("not") >= 0 ? b === !1 : b === !0;
                        });
                    case "showpage":
                        return assignCustomFunction(o, rn, cat, l, v, s, p, function () { return o["pageisshowing" + s] === !0; });
                    case "pageactive":
                        return assignCustomFunction(o, rn, cat, l, v, s, p, function () { return o.plantilla.find(".page[id='" + s + "']").is(":visible"); });
                    case "browsersnotsupported":
                        return assignCustomFunction(o, rn, cat, l, v, s, p, function () { return !(Modernizr.chrome || Modernizr.firefox || Modernizr.safari); });
                    case "backward": case "forward": case "beforefinish": case "afterfinish": case "click": case "closemodal": case "closeclear":
                        return assignCustomFunction(o, rn, cat, l, v, s, p, function () { return o.appvm[s]["is" + v] && o.appvm[s]["is" + v]() === !0; });
                    case "tableshowadd,editing,multi": case "tableshowadd": case "editing,multi": case "tableadd,addclear": case "edit": case "remove":
                        return assignCustomFunction(o, rn, cat, l, v, s, p, function () { return o["istb" + v + s] === !0; });
                    case "visible": case "notvisible": case "enabled": case "notenabled":
                        return assignCustomFunction(o, rn, cat, l, v, s, p, function () {
                            var b = v.indexOf('not') < 0, vn = v.replace('not', ''); vn = vn === "enabled" ? "habilitado" : vn;
                            vn = o.appvm[s].tipo() === o.TE.Seccion && vn === "visible" && o.appvm[s].modotab() ? "mostrar" : vn;
                            return o.appvm[s][vn]() === b;
                        });
                    case "change":
                        return assignCustomFunction(o, rn, cat, l, v, s, p, function () { return o.appvm[s]["isaction" + v] === !0; });
                    case "addanexo": case "removeanexo": case "replaceanexo": case "typifyattach": case "untypifyattach":
                        return assignCustomFunction(o, rn, cat, l, v, s, p, function () { return o[v + s] === !0; });
                    case "mayorequal": case "menorequal": case "may": case "men":
                        return assignCustomFunction(o, rn, cat, l, v, s, p, function () {
                            var res = !1, valnum = Number(o.appvm[s].valormetadato()), valcomp;
                            if (p.mode === "element") {
                                if (o.appvm[p.value] && o.appvm[p.value].chosenitems && !!o.appvm[p.value].chosenitems())
                                    valcomp = o.appvm[p.value].chosenitems().length;
                                else if (o.appvm[p.value] && o.appvm[p.value].valor) valcomp = Number(o.appvm[p.value].valormetadato());
                            }
                            else if (p.mode === "words") valcomp = Number(p.value);
                            if (_.isNumber(valnum))
                                if (v === "mayorequal") res = valnum >= valcomp;
                                else if (v === "menorequal") res = valnum <= valcomp;
                                else if (v === "may") res = valnum > valcomp;
                                else if (v === "men") res = valnum < valcomp;
                            return res;
                        });
                    case "isvalidatedelement":
                        return assignCustomFunction(o, rn, cat, l, v, s, p, function () {
                            return validateCustomElements(o, s);
                        });

                        break;
                    default: console.log('No se ha implementado la condici&oacute;n ' + v + ' de la regla ' + rn); return false;
                }
            }
        }
        function assignCustomFunction(o, rn, cat, l, v, s, p, fnc) {
            return function () {
                return fnc();
            };
        }
        function changecategorysubject(idrule, row, categ) {
            var o = getOpts(), data = [], c = idrule + '_' + row, val, value, i, rowsubj,
                oldcateg = o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].category;
            o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].category = categ,
                oldcateg !== categ && (o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject = {},
                    delete o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].tableidelem, delete o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].rowtype,
                    rowsubj = getGuidForElem(o, "reglas", rowsubj, "consubj", idrule, row), o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject[rowsubj] = {}),
                o.configModal.find(".conditiontablerow" + c).contents().remove();
            switch (categ) {
                case "elementid":
                    for (i = 0; i < o.initializedData.elemsforRules.length; i++)
                        data.push({ Valor: o.initializedData.elemsforRules[i].id, Nombre: o.initializedData.elemsforRules[i].nom, Group: o.initializedData.elemsforRules[i].group });
                    rowsubj = _.head(_.keys(o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject)),
                        value = o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject[rowsubj].subject || "",
                        value = value && o.appvm[value] ? value : "";
                    drawConditionSubjects(idrule, row, rowsubj, data, value, c, o, !1);
                    break;
                case "document":
                    for (i = 0; i < o.datatags.flujosR.length; i++)
                        val = o.datatags.flujosR[i].CveCatalogo + "_" + o.datatags.flujosR[i].Valor, data.push({ Valor: val, Nombre: o.datatags.flujosR[i].Nombre, Group: o.datatags.flujosR[i].Grupo });
                    rowsubj = _.head(_.keys(o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject)),
                        value = o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject[rowsubj].subject || "",
                        value = value && _.some(data, ['Valor', value]) ? value : "";
                    drawConditionSubjects(idrule, row, rowsubj, data, value, c, o, !1);
                    break;
                case "permissions":
                    for (i = 0; i < o.datatags.permisos.length; i++)
                        val = o.datatags.permisos[i].CveCatalogo + "_" + o.datatags.permisos[i].Valor, data.push({ Valor: val, Nombre: o.datatags.permisos[i].Nombre, Group: o.datatags.permisos[i].Grupo });
                    rowsubj = _.head(_.keys(o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject)),
                        value = o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject[rowsubj].subject || "",
                        value = value && _.some(data, ['Valor', value]) ? value : "";
                    drawConditionSubjects(idrule, row, rowsubj, data, value, c, o, !1);
                    break;
                case "bytable":
                    var infotable = $('<tr><td style="width:33%"><span class="d-block text-bold">Tabla:</span><div class="tablenameelm"></div></td><td style="width:33%" class="border-left"><span class="d-block text-bold">Filas:</span><div class="typetableelem"></div></td><td style="width:33%" class="border-left"></td></tr>'),
                        categorytable = [{ id: 'bynewrow', nombre: 'Fila a agregar' }, { id: 'byeditrow', nombre: 'Fila a editar' }, { id: 'byallrows', nombre: 'Solo si todas las filas cumplen las condiciones' },
                        { id: 'byatleastonerow', nombre: 'Solo las filas que cumplan las condiciones' }];
                    o.configModal.find(".conditiontablerow" + c).append(infotable);
                    infotable.find(".tablenameelm").css({ width: "80%" }).combobox({
                        data: _.filter(o.initializedData.elemsforRules, { tipo: o.TE.Tabla }), idField: 'id', valueField: 'id', textField: 'nom', limitToList: !0,
                        groupBy: 'group', groupPosition: 'sticky', prompt: 'Seleccione...',
                        value: elemsExist(o.initializedData.elemsforRules, o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].tableidelem, 'id'),
                        onSelect: function (itemval) {
                            o.configModal.find(".trcondsubj" + idrule + '_' + row + '_' + rowsubj).contents().remove();
                            o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].tableidelem = itemval.id;
                            data = _.map(_.filter(o.initializedData.elemsforRules, { tabla: itemval.id }), function (elm) {
                                return { Valor: elm.id, Nombre: elm.nom, Group: elm.group };
                            });
                            for (rowsubj in o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject)
                                value = o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject[rowsubj].subject || "",
                                    value = value && o.appvm[value] ? value : "", drawConditionSubjects(idrule, row, rowsubj, data, value, c, o, !0);
                        },
                        onUnselect: function () {
                            o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject = {}, delete o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].tableidelem;
                        }
                    });
                    infotable.find(".typetableelem").css({ width: "80%" }).combobox({
                        data: categorytable, idField: 'id', textField: 'nombre', valueField: 'id', prompt: 'Seleccione...', limitToList: !0,
                        value: elemsExist(categorytable, o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].rowtype, 'id'),
                        onSelect: function (itemval) { o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].rowtype = itemval.id; },
                        onUnselect: function (itemval) { delete o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].rowtype; }
                    });
                    break;
                case "table":
                    for (i = 0; i < o.initializedData.elemsforRules.length; i++)
                        if (o.initializedData.elemsforRules[i].tipo === o.TE.Tabla)
                            for (var h = 0; h < o.initializedData.elemsforRules.length; h++)
                                o.initializedData.elemsforRules[h].tabla === o.initializedData.elemsforRules[i].id && data.push({
                                    Valor: o.initializedData.elemsforRules[h].id, Nombre: o.initializedData.elemsforRules[h].nom, Group: o.initializedData.elemsforRules[h].group
                                });
                    for (rowsubj in o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject)
                        value = o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject[rowsubj].subject || "",
                            value = value && o.appvm[value] ? value : "", drawConditionSubjects(idrule, row, rowsubj, data, value, c, o, !0);
                    break;
                case "withoutcondition":
                    o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject = [];
                    break;
            }
            updateOpts(o, !0);
        }
        function changeconditionsubject(idrule, row, rowsubj, subj) {
            var o = getOpts(), rrr = idrule + '_' + row + '_' + rowsubj, categ = o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].category,
                chsubj = o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject[rowsubj].subject !== subj;
            o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject[rowsubj] || (o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject[rowsubj] = {}),
                o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject[rowsubj].subject = subj, chsubj && (o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject[rowsubj].predicate = { value: "", mode: "" });

            switch (categ) {
                case "document": case "permissions": break;
                case "elementid": case "table": case "bytable":
                    o.configModal.find(".divcondverb" + rrr).contents().remove(), o.configModal.find(".divcondpred" + rrr).contents().remove(), drawConditionVerbs(idrule, row, rowsubj, subj, rrr, o); break;
            }

            updateOpts(o, !0);
        }
        function changeconditionverb(idrule, row, rowsubj, subj, verb) {
            var o = getOpts(), data = [], c = idrule + '_' + row, idpagina, rrr = idrule + '_' + row + '_' + rowsubj, i;
            o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject[rowsubj].verb = verb,
                o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject[rowsubj].predicate || (o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject[rowsubj].predicate = { value: "", mode: "" }),
                o.configModal.find(".divcondpred" + rrr).contents().remove();

            switch (verb) {
                case "deviceinuse":
                    drawConditionPredicates(idrule, row, rowsubj, [], subj, verb, c, rrr, o); break;
                case "contains": case "notcontains": case "equals": case "notequals": case "mayorequal": case "menorequal": case "may": case "men":
                    switch (o.appvm[subj].tipo()) {
                        case o.TE.MarcadoDocumentos: case o.TE.Texto: case o.TE.TextArea: case o.TE.CodigoBarras: case o.TE.Password: case o.TE.Moneda: case o.TE.Numero: case o.TE.Lista: case o.TE.Deslizante: case o.TE.ComboDinamico: case o.TE.Fecha: case o.TE.RangoFechas: case o.TE.Hora:
                            for (i = 0; i < o.initializedData.elemsforRules.length; i++)
                                if (subj !== o.initializedData.elemsforRules[i].id &&
                                    (_.includes([o.TE.MarcadoDocumentos, o.TE.Lista], o.appvm[subj].tipo()) && _.includes([o.TE.MarcadoDocumentos, o.TE.Lista], o.initializedData.elemsforRules[i].tipo)
                                        || !_.includes([o.TE.MarcadoDocumentos, o.TE.Lista], o.appvm[subj].tipo()) && _.includes(o.flexibleelement, o.initializedData.elemsforRules[i].tipo)))
                                    data.push({ Valor: o.initializedData.elemsforRules[i].id, Nombre: o.initializedData.elemsforRules[i].nom, Group: o.initializedData.elemsforRules[i].group });
                            drawConditionPredicates(idrule, row, rowsubj, data, subj, verb, c, rrr, o); break;
                    }
                    break;
                default: delete o.appvm[o.idPlantilla].reglas()[idrule].conditions[row].subject[rowsubj].predicate;
                    break;
            }
            updateOpts(o, !0);
        }
        function changeactionverb(idrule, row, verb, group) {
            var o = getOpts(), c = idrule + '_' + row;
            o.configModal.find(".actionsubject" + c + ",.actionpredicate" + c).contents().remove(),
                typeof o.appvm[o.idPlantilla].reglas()[idrule].actions[row] !== "object" && (o.appvm[o.idPlantilla].reglas()[idrule].actions[row] = {}),
                o.appvm[o.idPlantilla].reglas()[idrule].actions[row].verb = verb,
                o.appvm[o.idPlantilla].reglas()[idrule].actions[row].subject || (o.appvm[o.idPlantilla].reglas()[idrule].actions[row].subject = {}),
                o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate || (o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate = {}),
                drawActionSubjects(idrule, row, verb, c, o, group), updateOpts(o, !0);
        }
        function changeactionsubject(idrule, row, subj, multiple, add, remove, draw) {
            var o = getOpts(), c = idrule + '_' + row, verb = o.appvm[o.idPlantilla].reglas()[idrule].actions[row].verb;
            add ? multiple ? o.appvm[o.idPlantilla].reglas()[idrule].actions[row].subject[subj] = "" :
                (o.appvm[o.idPlantilla].reglas()[idrule].actions[row].subject = JSON.parse("{\"" + subj + "\":\"\"}"),
                    o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate || (o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate = {})) :
                remove && multiple && delete o.appvm[o.idPlantilla].reglas()[idrule].actions[row].subject[subj],
                draw && (o.configModal.find(".actionpredicate" + c).contents().remove(), drawActionPredicates(idrule, row, verb, subj, c, o)),
                updateOpts(o, !0);
        }
        function checkRuleForElement(o) {
            if (o.drawPreviewer === !0)
                for (var r in o.jobj.elemento.atributos.reglas)
                    if (o.jobj.elemento.atributos.reglas[r].conditions && !_.isEmpty(o.jobj.elemento.atributos.reglas[r].conditions))
                        for (var co in o.jobj.elemento.atributos.reglas[r].conditions)
                            assignCondition(o, r, co);
        }
        function createComboBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, draw) {
            o.configModal.find(".actionsubject" + c).append(ass),
                o.appvm[o.idPlantilla].reglas()[idrule].actions[row].subject = _.pick(o.appvm[o.idPlantilla].reglas()[idrule].actions[row].subject, subjectsids),
                ass.find("select").css({ width: "100%" }).combobox({
                    data: data, value: _.first(_.keys(o.appvm[o.idPlantilla].reglas()[idrule].actions[row].subject)) || "", limitToList: !0,
                    formatter: function (row) { return row.Nombre; },
                    valueField: 'Valor', textField: 'Nombre', groupField: "Group", idField: "Valor", groupPosition: "sticky", prompt: 'Seleccione...', onSelect: function (item) {
                        changeactionsubject(idrule, row, item.Valor, !1, !0, !1, draw, item.Valor);
                    }
                });
        }
        function createTagBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, draw) {
            o.configModal.find(".actionsubject" + c).append(ass),
                o.appvm[o.idPlantilla].reglas()[idrule].actions[row].subject = _.pick(o.appvm[o.idPlantilla].reglas()[idrule].actions[row].subject, subjectsids),
                ass.find("select").css({ width: "100%" }).tagbox({
                    data: data, hasDownArrow: !0, limitToList: !0, multiple: !0,
                    valueField: 'Valor', textField: 'Nombre', groupField: "Group", idField: "Valor", groupPosition: "sticky", prompt: 'Seleccione...',
                    onSelect: function (item) { changeactionsubject(idrule, row, item.Valor, !0, !0, !1, draw); },
                    onUnselect: function (item) { changeactionsubject(idrule, row, item.Valor, !0, !1, !0, draw); }
                }).combobox('setValues', _.compact(_.keys(o.appvm[o.idPlantilla].reglas()[idrule].actions[row].subject)));
        }
        function createComboBoxForActionPred(o, aps, c, idrule, row, data, idval, textval) {
            !idval && (idval = "Valor");
            !textval && (textval = "Nombre");
            aps.append("<select></select>"), o.configModal.find(".actionpredicate" + c).append(aps),
                o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate = _.intersection(_.map(data, function (v) { return v[idval]; }), _.keys(o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate));
            aps.find("select").css({ width: "100%" }).combobox({
                data: data, value: o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate.join(','), limitToList: !0,
                valueField: idval, textField: textval, groupField: "Group", idField: idval, groupPosition: "sticky", prompt: 'Seleccione...',
                onSelect: function (item) { o = getOpts(), o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate = JSON.parse("{\"" + item[idval] + "\":\"\"}"), updateOpts(o, !0); }
            });
        }
        function createTagBoxForActionPred(o, aps, c, idrule, row, data, predids) {
            aps.append("<select></select>"), o.configModal.find(".actionpredicate" + c).append(aps),
                o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate = _.pick(o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate, predids),
                aps.find("select").css({ width: "100%" }).tagbox({
                    data: data, hasDownArrow: !0, limitToList: !0, multiple: !0,
                    valueField: 'Valor', textField: 'Nombre', groupField: "Group", idField: "Valor", groupPosition: "sticky", prompt: 'Seleccione...',
                    onSelect: function (item) { o = getOpts(), o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate[item.Valor] = "", updateOpts(o, !0); },
                    onUnselect: function (item) { o = getOpts(), delete o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate[item.Valor], updateOpts(o, !0); }
                }).combobox('setValues', _.compact(_.keys(o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate)));
        }
        function drawConditionSubjects(r, co, s, data, value, c, o, multiple) {
            s || (s = getGuidForElem(o, "reglas", s, "consubj", r, co)),
                o.appvm[o.idPlantilla].reglas()[r].conditions[co].subject[s] || (o.appvm[o.idPlantilla].reglas()[r].conditions[co].subject[s] = {});
            var rrr = r + '_' + co + '_' + s, tsc = $('<tr class="trcondsubj{0}" style="min-height: 60px;">\
                    <td class="divcondsubj{0}" style="vertical-align: top; padding-top: 5px; border-right: 1px solid #ccc; width: 33%;">\
                    </td>\
                    <td class="divcondverb{0}" style="vertical-align: top; padding-top: 5px; padding-left: 5px; border-right: 1px solid #ccc; width: 33%;">\
                    </td>\
                    <td class="divcondpred{0}" style="vertical-align: top; padding-top: 5px; padding-left: 5px; width: 33%;">\
                    </td>\
                </tr>'.format(rrr)), scs = multiple ? $('<div class="col-sm-8 col-8 d-flex" style="padding-left: 0;"><select></select>\
                <div class="col-sm-1 col-1 no-padding d-flex align-items-center">\
                    <i class="fas fa-user text-orange border btn p-2 ml-1 addsubjectcon" title="agregar sujeto"></i>\
                    <i class="far fa-trash-alt text-black p-2 btn ml-1 border removesubjectcon" title="quitar sujeto"></i></div>\
                </div>') : $('<div class="col-sm-12 col-12" style="padding-left: 0;"><select></select></div>');
            tsc.find(".divcondsubj" + rrr).append(scs), o.configModal.find(".conditiontablerow" + c).append(tsc),
                scs.find("select").css({ width: "100%" }).combobox({
                    data: _.sortBy(data, ["Group"]), value: value, limitToList: !0,
                    valueField: 'Valor', textField: 'Nombre', groupField: "Group", idField: "Valor", groupPosition: "sticky", prompt: 'Seleccione...',
                    onSelect: function (item) { changeconditionsubject(r, co, s, item.Valor); }, onUnselect: function () { changeconditionsubject(r, co, s, ''); }
                }), scs.find(".removesubjectcon").on("click", function () { removeRuleType(r, co, s, "consubj"); }),
                scs.find(".addsubjectcon").on("click", function () {
                    o = getOpts(), o.appvm[o.idPlantilla].reglas()[r].conditions[co].subject[s].subject && drawConditionSubjects(r, co, "", data, "", c, o, !0), updateOpts(o, !0);
                }), multiple && (_.size(o.appvm[o.idPlantilla].reglas()[r].conditions[co].subject) === 1 ?
                    o.configModal.find(".conditiontablerow" + c + " .removesubjectcon").hide() : o.configModal.find(".conditiontablerow" + c + " .removesubjectcon").show());
        }
        function drawConditionVerbs(r, co, s, subj, rrr, o) {
            if (!subj) return;
            var verbs = [], htmlverbs = [], pp = [], vcs = $('<div class="col-sm-12 col-12" style="padding-left: 0;"><select class="form-control"></select></div>'), cond = o.datatags.condicionesReglas;
            if (_.includes(["table", "bytable"], o.appvm[o.idPlantilla].reglas()[r].conditions[co].category)) {
                switch (o.appvm[subj].tipo()) {
                    case o.TE.Lista: case o.TE.Fecha: case o.TE.Hora: case o.TE.MarcadoDocumentos: case o.TE.RangoFechas: case o.TE.TextArea: case o.TE.Texto: case o.TE.Password: case o.TE.CodigoBarras: case o.TE.Moneda: case o.TE.Numero: case o.TE.ComboDinamico:
                        pp = ['contains', 'notcontains', 'empty', 'notempty', 'equals', 'notequals']; break;
                    case o.TE.Logico:
                        pp = ['selected', 'notselected']; break;
                    case o.TE.Boton:
                        pp = ['click', 'closemodal']; break;
                }
            } else {
                switch (o.appvm[subj].tipo()) {
                    case o.TE.Plantilla:
                        pp = ['loaded', 'save', 'deviceinuse', 'browsersnotsupported']; break;
                    case o.TE.Audio: case o.TE.Video: case o.TE.Imagen: case o.TE.FirmaFAD: case o.TE.HuellaDigital: case o.TE.Documento:
                        pp = ['addanexo', 'removeanexo', 'typifyattach', 'untypifyattach', 'replaceanexo', 'visible', 'notvisible', 'enabled', 'notenabled', 'empty', 'notempty']; break;
                    case o.TE.Georeferencia: case o.TE.Mapa:
                        pp = ['visible', 'notvisible', 'enabled', 'notenabled', 'empty', 'notempty']; break;
                    case o.TE.Boton:
                        pp = ['visible', 'notvisible', 'enabled', 'notenabled', 'click', 'closemodal']; break;
                    case o.TE.Texto: case o.TE.TextArea: case o.TE.Fecha: case o.TE.Hora: case o.TE.CodigoBarras: case o.TE.Password: case o.TE.RangoFechas: case o.TE.CodigoQR: case o.TE.ComboDinamico:
                        pp = ['contains', 'notcontains', 'visible', 'notvisible', 'enabled', 'notenabled', 'empty', 'notempty', 'equals', 'notequals']; break;
                    case o.TE.Moneda: case o.TE.Numero: case o.TE.Deslizante:
                        pp = ['contains', 'notcontains', 'visible', 'notvisible', 'enabled', 'notenabled', 'empty', 'notempty', 'equals', 'notequals', 'mayorequal', 'menorequal', 'may', 'men']; break;
                    case o.TE.MarcadoDocumentos: case o.TE.Lista:
                        pp = ['contains', 'notcontains', 'visible', 'notvisible', 'enabled', 'notenabled', 'empty', 'notempty', 'change']; break;
                    case o.TE.ComboBoxTemporal:
                        pp = ['visible', 'notvisible', 'enabled', 'notenabled', 'empty', 'notempty', 'change']; break;
                    case o.TE.Leyenda: case o.TE.Logo:
                        pp = ['visible', 'notvisible']; break;
                    case o.TE.Tabber:
                        pp = ['visible', 'notvisible']; break;
                    case o.TE.Logico:
                        pp = ['visible', 'notvisible', 'enabled', 'notenabled', 'selected', 'notselected']; break;
                    case o.TE.Pagina:
                        pp = ['showpage', 'pageactive', 'isvalidatedelement']; break;
                    case o.TE.Seccion:
                        pp = ['visible', 'notvisible']; break;
                    case o.TE.Tabla:
                        pp = ['visible', 'notvisible', 'tableshowadd', 'editing,multi', 'tableadd,addclear', 'edit', 'remove', 'closeclear', 'clear', 'clearall']; break;
                    case o.TE.Wizard:
                        pp = ['enabled', 'notenabled', 'backward', 'forward', 'beforefinish', 'afterfinish']; break;
                }
            }
            verbs = _.filter(cond, function (z) { return _.includes(pp, z.Valor); });
            for (var i = 0; i < verbs.length; i++) htmlverbs.push('<option value="' + verbs[i].Valor + '">' + verbs[i].Nombre + '</option>');
            o.configModal.find(".divcondverb" + rrr).append(vcs),
                vcs.find("select").append(htmlverbs).on("change", function () { changeconditionverb(r, co, s, subj, $(this).val()); })
                    .find("option[value='" + o.appvm[o.idPlantilla].reglas()[r].conditions[co].subject[s].verb + "']").prop('selected', !0).end().trigger("change");
        }
        function drawConditionPredicates(idrule, row, rowsubj, data, subj, verb, c, rrr, o, isaction) {
            var pcs, rowinput = '<div class="row form-horizontal"><div class="col-sm-12 col-12 contentpredicate' + c + '"></div></div>';
            var typeofelem = isaction === !0 ? 'actions' : 'conditions', catelem = o.appvm[o.idPlantilla].reglas()[idrule][typeofelem][row].category;
            var pred = isaction === !0 ? o.appvm[o.idPlantilla].reglas()[idrule][typeofelem][row].predicate : o.appvm[o.idPlantilla].reglas()[idrule][typeofelem][row].subject[rowsubj].predicate;
            var appendelem = isaction === !0 ? ".actionpredicate" + c : ".divcondpred" + rrr;
            switch (verb) {
                case "deviceinuse":
                    var arrtypedisp = [{ id: "iswebcomp", desc: "En computadora" }, { id: "iswebmov", desc: "En m&oacute;vil" }, { id: "isandroid", desc: "En Android" }, { id: "isios", desc: "Es iOS" }];
                    pcs = $(rowinput).find(".contentpredicate" + c).append('<div id="divselectconditionpredicate' + c + '"><select></select></div>').end();
                    o.configModal.find(appendelem).append(pcs);
                    pcs.find("#divselectconditionpredicate" + c).find("select").css({ width: "100%" }).combobox({
                        data: arrtypedisp, valueField: 'id', textField: 'desc', limitToList: !0,
                        prompt: 'Seleccione...', value: pred.value, onSelect: function (val) { pred.value = val.id; }
                    });
                    break;
                case "contains": case "notcontains": case "value": case "equals": case "notequals": case "mayorequal": case "menorequal": case "may": case "men": case "exportdatabyrow": case "multiplevalue": case "changesigntext":
                    switch (o.appvm[subj].tipo()) {
                        case o.TE.Texto: case o.TE.TextArea: case o.TE.CodigoBarras: case o.TE.Moneda: case o.TE.Password: case o.TE.Numero: case o.TE.Hora: case o.TE.Fecha: case o.TE.RangoFechas: case o.TE.Lista: case o.TE.Deslizante: case o.TE.Logico:
                        case o.TE.ComboBoxTemporal: case o.TE.Leyenda: case o.TE.ComboDinamico: case o.TE.MarcadoDocumentos: case o.TE.FirmaFAD: case o.TE.Georeferencia:
                            var typecontainele = _.includes([o.TE.Numero, o.TE.Moneda, o.TE.Deslizante], o.appvm[subj].tipo()) ? "number" : _.includes([o.TE.Logico], o.appvm[subj].tipo()) ? "checkbox" : "text",
                                appendclass = o.appvm[subj].tipo() !== o.TE.Logico ? "form-control" : "",
                                varusrdata = _.includes([o.TE.TextArea, o.TE.Texto, o.TE.Numero], o.appvm[subj].tipo()) ? _.filter(o.datatags.reglasInfoDocUsr, function (rf) { return !_.includes(["Hora", "Fecha"], rf.Grupo); })
                                    : _.filter(o.datatags.reglasInfoDocUsr, function (rf) { return rf.Grupo.toLowerCase() === o.appvm[subj].tipo(); });
                            pcs = $('<div class="row form-horizontal">\
                                    <div class="col-sm-9 col-9 modepredicate' + c + '" style="display:inline-flex; max-height:10px">\
                                        <div id="element" class="tabElementrulechoise">Elemento(s)</div>\
                                        <div id="words" class="tabElementrulechoise">Por defecto</div>\
                                        <div id= "varusr" hidden class="tabElementrulechoise">Valor usuario</div>\
                                    </div>\
                                </div>' + rowinput).find(".contentpredicate" + c).append('<div id="divinpred' + c + '"><input type="' + typecontainele + '" class="' + appendclass + '" id="inpred' + c + '" /></div>\
                                        <div id="divselectconditionpredicate' + c + '"><select id="selectconditionpredicate' + c + '"></select></div>\
                                         <div id="divusrpred' + c + '"><select id="selectdiv' + c + '"></select></div>').end(),
                                o.configModal.find(appendelem).append(pcs);
                            if (_.includes([o.TE.Texto, o.TE.TextArea, o.TE.Numero, o.TE.Fecha, o.TE.Hora], o.appvm[subj].tipo()) &&
                                !_.includes(["mayorequal", "menorequal", "may", "men"], verb) && !_.includes(["bytable", "table"], catelem))
                                pcs.find(".modepredicate" + c).find(".tabElementrulechoise").removeAttr("hidden");
                            if (pred.mode === "words") {
                                if (_.includes([o.TE.Lista, o.TE.MarcadoDocumentos], o.appvm[subj].tipo())) {
                                    (typeof pred.value === "string" || typeof pred.value === "number") && pred.value !== "" && (pred.value = pred.value.toString().split(','));
                                    pred.value = _.uniq(_.intersection(_.map(pred.value, function (mel) { return mel.toString(); }), _.map(o.datatags.allitemscatalogs[o.appvm[subj].fuentedatos() + "|" + o.appvm[subj].catalogoorigen()], function (mel) { return mel.Valor.toString(); })));
                                }
                            } else if (pred.mode === "varusr" && !_.includes(["mayorequal", "menorequal", "may", "men"], verb)) {
                                pred.value = typeof pred.value === "string" || typeof pred.value === "number" ? [pred.value.toString()] : pred.value;
                                pred.value = _.intersection(_.map(varusrdata, 'Valor'), _.uniq(pred.value));
                            }
                            else if (pred.mode === "element")
                                pred.value = o.appvm[pred.value] ? pred.value : "";
                            if (o.appvm[subj].tipo() === o.TE.Hora && pred.mode === "words") {
                                pred.value = pred.value.match(/^[0-9]+:[0-9]+$/) ? pred.value : "";
                                var optstime = {
                                    autoclose: true, startView: 1, language: 'es', minuteStep: 15, maxView: 1,
                                    format: o.appvm[subj].horaObject.Nombre().indexOf("PM") >= 0 ? "HH:ii P" : "hh:ii",
                                    showMeridian: o.appvm[subj].horaObject.Nombre().indexOf("PM") >= 0
                                };
                                pcs.find("#inpred" + c).datetimepickerfe(optstime).on("changeDate", function (ev) {
                                    pred.value = ev.date.getHours().toString() + ":" + ev.date.getMinutes().toString();
                                });
                                pcs.find("#inpred" + c).val(pred.value);
                            }
                            else if (_.includes([o.TE.Fecha, o.TE.RangoFechas], o.appvm[subj].tipo())) {
                                pred.value.toString().toLowerCase() === "today" && pred.mode === "words" && (pred.value = "");
                                var format = o.appvm[subj].formatoObject.Valor().replace(/\/+/g, o.appvm[subj].separador());
                                pcs.find("#inpred" + c).flatpickr({
                                    dateFormat: format, "locale": "es", mode: o.appvm[subj].tipo() === o.TE.RangoFechas ? "range" : "single",
                                    maxDate: o.appvm[subj].fechamax().toString() === "-9999" ? null : new Date().fp_incr(o.appvm[subj].fechamax()),
                                    minDate: o.appvm[subj].fechamin().toString() === "-9999" ? null : new Date().fp_incr(-o.appvm[subj].fechamin()),
                                    defaultDate: pred.mode === "words" ? o.appvm[subj].tipo() === o.TE.Fecha ? universalToDate(o, subj, pred.value) : pred.value : "", onChange: function (_sd, ds) { pred.value = ds; },
                                    disableMobile: true
                                });
                            }
                            else if (_.includes([o.TE.Lista, o.TE.MarcadoDocumentos], o.appvm[subj].tipo())) {
                                pcs.find("#inpred" + c).css({ width: "100%" }).combobox({
                                    data: o.datatags.allitemscatalogs[o.appvm[subj].fuentedatos() + "|" + o.appvm[subj].catalogoorigen()], valueField: 'Valor', textField: 'Nombre', multiple: true, limitToList: !0,
                                    prompt: 'Seleccione...', value: pred.mode === "words" ? elemsExist(o.datatags.allitemscatalogs[o.appvm[subj].fuentedatos() + "|" + o.appvm[subj].catalogoorigen()], pred.value, 'Valor') : "",
                                    onSelect: function (val) { !_.includes(pred.value, val.Valor.toString()) && (pred.value = _.union(pred.value, [val.Valor.toString()])); },
                                    onUnselect: function (val) { pred.value = _.filter(pred.value, function (f) { return f !== val.Valor; }); }
                                });
                            }
                            else if (o.appvm[subj].tipo() === o.TE.ComboDinamico) {
                                var camposFiltro = [];
                                pcs.find("#inpred" + c).css({ width: "100%" }).combobox({
                                    value: pred.value, panelHeight: 'auto', prompt: "Seleccione...", valueField: o.appvm[subj].valorid(), panelMaxHeight: 200,
                                    textField: "Desc_" + subj, idField: o.appvm[subj].valorid(), selectOnNavigation: !1, delay: 500, limitToList: !0,
                                    beforeSend: function () { },
                                    formatter: function (row) {
                                        var valdesc = [], vald = o.appvm[subj].valordescripcion().toString().split(",");
                                        for (var i = 0; i < vald.length; i++)
                                            row[vald[i]] && valdesc.push(row[vald[i]]);
                                        row["Desc_" + subj] = valdesc.join(" ");
                                        return row["Desc_" + subj];
                                    },
                                    loader: function (param, success, error) {
                                        if (o.appvm[subj].catalogofuente()) {
                                            $.ajax({
                                                url: 'FECapturador.aspx/CargaCatalogoRemoto',
                                                type: 'POST', beforeSend: function () { },
                                                contentType: "application/json; charset=utf-8",
                                                async: !1,
                                                data: JSON.stringify({ filtros: JSON.stringify(camposFiltro), catDocId: o.appvm[subj].catalogofuente(), proyid: o.datasend.proyid, top: o.appvm[subj].cantidadopciones() }),
                                                success: function (j) {
                                                    j = j.d;
                                                    if (j.Success) {
                                                        var table = JSON.parse(j.ReturnedObject);
                                                        table ? success(table.Table) : success([]);
                                                    }
                                                    else toasty('Error al cargar los datos de ' + o.appvm[subj].titulo(), j.Mensaje, 'error');
                                                    _.remove(o.appvm[subj].camposfiltrosjson, { ElementoId: subj });
                                                }
                                            });
                                        }
                                    },
                                    onChange: function (nv, ov) {
                                        camposFiltro = [];
                                        var valueSel = $(this).combobox("textbox").val(), selection = _.find($(this).combobox("getData"), function (itemcat) { return itemcat["Desc_" + subj] === valueSel; }), isSelection = !!selection;
                                        if (!isSelection || !nv) {
                                            camposFiltro.push({ Operador: "LIKE", Tabla: o.appvm[subj].campobusqueda(), Valor: nv, ElementoId: subj });
                                            $(this).combobox("reload");
                                        }
                                        if (isSelection || !nv)
                                            pred.value = nv, isSelection = !1;
                                    }
                                });
                            }
                            else if (_.includes([o.TE.Logico], o.appvm[subj].tipo())) {
                                pcs.find("#inpred" + c).on("change", function (e) { pred.mode === "words" && (pred.value = e.target.checked); });
                                pcs.find("#inpred" + c).prop("checked", pred.value);
                            }
                            else {
                                pcs.find("#inpred" + c).on("blur", function () { pred.mode === "words" && (pred.value = $(this).val()); });
                                pcs.find("#inpred" + c).val(pred.value);
                            }
                            var chooselement = function (elem) {
                                pcs.find(".modepredicate" + c).find(".tabElementrulechoiseSel").removeClass("tabElementrulechoiseSel");
                                pcs.find(".modepredicate" + c).find("#" + elem.attr("id")).addClass("tabElementrulechoiseSel");
                                pcs.find("#divselectconditionpredicate" + c).hide(), pcs.find("#divinpred" + c).hide(), pcs.find("#divusrpred" + c).hide();
                                switch (elem.attr("id")) {
                                    case "words":
                                        pred.mode = "words", pcs.find("#divinpred" + c).show();
                                        break;
                                    case "element":
                                        pred.mode = "element", pcs.find("#divselectconditionpredicate" + c).show();
                                        break;
                                    case "varusr":
                                        _.includes([o.TE.Texto, o.TE.TextArea, o.TE.Numero, o.TE.Fecha, o.TE.Hora], o.appvm[subj].tipo()) && !_.includes(["mayorequal", "menorequal", "may", "men"], verb) && !_.includes(["bytable", "table"], catelem) ? (pred.mode = "varusr", pcs.find("#divusrpred" + c).show()) :
                                            toasty('', 'Las variables de usuario solo son v&aacute;lidas en elementos de tipo n&uacute;mero, texto lineal y texto multil&iacute;neas');
                                        break;
                                }
                            };
                            pcs.find(".modepredicate" + c).on("click", function (e) { e.target !== undefined && chooselement($(e.target)); });
                            pcs.find("#divselectconditionpredicate" + c).find("select").css({ width: "100%" }).combobox({
                                data: data, value: pred.mode === "element" ? pred.value : "", limitToList: !0,
                                valueField: 'Valor', textField: 'Nombre', groupField: "Group", idField: "Valor", groupPosition: "sticky", prompt: 'Seleccione...',
                                onSelect: function (item) { pred.mode === "element" && (pred.value = item.Valor); }
                            });
                            pcs.find("#divusrpred" + c).find("select").css({ width: "100%" }).combobox({
                                data: varusrdata, value: pred.mode === "varusr" ? pred.value : "", limitToList: !0, selectOnNavigation: !1,
                                valueField: 'Valor', textField: 'Nombre', groupField: "Grupo", idField: "Valor", groupPosition: "sticky", prompt: 'Seleccione...',
                                multiple: !1,
                                onSelect: function (item) {
                                    if (pred.mode === "varusr") {
                                        if (typeof pred.value === "string" || typeof pred.value === "number" || !pred.value) pred.value = [];
                                        pred.value.push(item.Valor), pred.value = _.uniq(pred.value);
                                    }
                                },
                                onUnselect: function (item) {
                                    if (pred.mode === "varusr") {
                                        if (typeof pred.value === "string" || typeof pred.value === "number" || !pred.value)
                                            pred.value = [];
                                        else pred.value = _.uniq(_.remove(pred.value, item.Valor));
                                    }
                                }
                            });
                            if (pred.mode === "element") chooselement(pcs.find(".modepredicate" + c).find("#element"));
                            else if (pred.mode === "varusr" && !_.includes(["mayorequal", "menorequal", "may", "men"], verb)) chooselement(pcs.find(".modepredicate" + c).find("#varusr"));
                            else chooselement(pcs.find(".modepredicate" + c).find("#words"));
                            break;
                    }
                    break;
            }
        }
        function drawActionSubjects(idrule, row, verb, c, o, group) {
            var ass = $('<div class="col-sm-11 col-11"><select></select></div>'), data = [], subjectsids = [], i, eleSer, act = _.find(o.datatags.accionesreglas, { Valor: verb });
            switch (verb) {
                case "visible": case "notvisible": case "enabled": case "notenabled": case "required": case "notrequired":
                    var attr = verb.replace("not", "");
                    for (i = 0; attr.indexOf("enabled") >= 0 && (attr = "habilitado"), attr.indexOf("required") >= 0 && (attr = "requerido"), i < o.initializedData.elemsforRules.length; i++)
                        if (o.appvm[o.initializedData.elemsforRules[i].id][attr] && o.appvm[o.initializedData.elemsforRules[i].id].tipo() !== o.TE.Plantilla)
                            data.push({ Valor: o.initializedData.elemsforRules[i].id, Nombre: o.initializedData.elemsforRules[i].nom, Group: o.initializedData.elemsforRules[i].group }), subjectsids.push(o.initializedData.elemsforRules[i].id);
                    createTagBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, !1);
                    break;
                case "multiedit": case "asmodal": case "permisotablaeditarr": case "permisotablaimportarr": case "permisotablaeliminarr": case "permisotablaagregarr": case "permisotablaseleccionarr": case "permisotablamultiedicion": case "permisotablaagregarcerrarr": case "permisotablalimpiar": case "permisotablamostrar": case "permisotablacerrar":
                case "notpermisotablaeditarr": case "notpermisotablaimportarr": case "notpermisotablaeliminarr": case "notpermisotablaagregarr": case "notpermisotablaseleccionarr": case "notpermisotablamultiedicion": case "notpermisotablaagregarcerrarr": case "notpermisotablalimpiar": case "notpermisotablamostrar": case "notpermisotablacerrar":
                case "allowdelete": case "allowedit": case "allowselect": case "notallowdelete": case "notallowedit": case "notallowselect": case "changeformat": case "coordenadas": case "hiderow": case "changebuttonurl": case "changemapping": case "clicbutton": case "habilitarseccion": case "filterlist": case "deleterow": case "changesigntext":
                case "permisotablaeditarxfila": case "notpermisotablaeditarxfila": case "reassignuser": case "changenavigation": case "hidecolumn": case "editrow": case "showanimation": case "getfaddata":
                    for (i = 0; i < o.initializedData.elemsforRules.length; i++)
                        if (_.includes(group.toLowerCase().split("/"), o.initializedData.elemsforRules[i].tipo) || o.initializedData.elemsforRules[i].tipo === o.TE.Tabla && group.toLowerCase() === "fila tabla")
                            data.push({ Valor: o.initializedData.elemsforRules[i].id, Nombre: o.initializedData.elemsforRules[i].nom, Group: o.initializedData.elemsforRules[i].group }), subjectsids.push(o.initializedData.elemsforRules[i].id);
                    createComboBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, !0);
                    break;
                case "value": case "exportdatabyrow":
                    for (i = 0; i < o.initializedData.elemsforRules.length; i++)
                        if (_.includes(o.flexibleelement, o.initializedData.elemsforRules[i].tipo))
                            data.push({ Valor: o.initializedData.elemsforRules[i].id, Nombre: o.initializedData.elemsforRules[i].nom, Group: o.initializedData.elemsforRules[i].group }), subjectsids.push(o.initializedData.elemsforRules[i].id);
                    createComboBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, !0);
                    break;
                case "hidecolumnbyrow":
                    for (i = 0; i < o.initializedData.elemsforRules.length; i++)
                        if (_.includes(_.concat(o.flexibleelement, [o.TE.Boton]), o.initializedData.elemsforRules[i].tipo))
                            data.push({ Valor: o.initializedData.elemsforRules[i].id, Nombre: o.initializedData.elemsforRules[i].nom, Group: o.initializedData.elemsforRules[i].group }), subjectsids.push(o.initializedData.elemsforRules[i].id);
                    createTagBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, !0);
                    break;
                case "multiplevalue":
                    for (i = 0; i < o.initializedData.elemsforRules.length; i++)
                        if (_.includes([o.TE.Texto, o.TE.TextArea], o.initializedData.elemsforRules[i].tipo))
                            data.push({ Valor: o.initializedData.elemsforRules[i].id, Nombre: o.initializedData.elemsforRules[i].nom, Group: o.initializedData.elemsforRules[i].group }), subjectsids.push(o.initializedData.elemsforRules[i].id);
                    createTagBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, !0);
                    break;
                case "cancel":
                    o.configModal.find(".actionsubject" + c).append(ass);
                    data.push({ Valor: "validate", Nombre: "Validar formato", Group: "Documento" }), subjectsids.push("validate");
                    data.push({ Valor: "save", Nombre: "Salvar formato", Group: "Documento" }), subjectsids.push("save");
                    createComboBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, !1);
                    break;
                case "showmessage":
                    data.push({ Valor: "popuperror", Nombre: "Pop-up de error (rojo)" }), subjectsids.push("popuperror");
                    data.push({ Valor: "popupalert", Nombre: "Pop-up de alerta (amarillo)" }), subjectsids.push("popupalert");
                    data.push({ Valor: "popupinfo", Nombre: "Pop-up informativo (azul)" }), subjectsids.push("popupinfo");
                    data.push({ Valor: "notiferror", Nombre: "Aviso de error (rojo)" }), subjectsids.push("notiferror");
                    data.push({ Valor: "notifalert", Nombre: "Aviso de alerta (amarillo)" }), subjectsids.push("notifalert");
                    data.push({ Valor: "notifinfo", Nombre: "Aviso informativo (azul)" }), subjectsids.push("notifinfo");
                    createComboBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, !0);
                    break;
                case "validate":
                    for (i = 0; i < o.initializedData.elemsforRules.length; i++)
                        if (o.initializedData.elemsforRules[i].tabla === "" && o.initializedData.elemsforRules[i].id !== o.idPlantilla && o.appvm[o.initializedData.elemsforRules[i].id]["requerido"])
                            data.push({ Valor: o.initializedData.elemsforRules[i].id, Nombre: o.initializedData.elemsforRules[i].nom, Group: o.initializedData.elemsforRules[i].group }), subjectsids.push(o.initializedData.elemsforRules[i].id);
                    createTagBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, !0);
                    break;
                case "execute":
                    for (i = 0; i < o.initializedData.elemsforRules.length; i++)
                        if (_.includes([o.TE.Tabla, o.TE.Wizard], o.initializedData.elemsforRules[i].tipo))
                            data.push({ Valor: o.initializedData.elemsforRules[i].id, Nombre: o.initializedData.elemsforRules[i].nom, Group: o.initializedData.elemsforRules[i].group }), subjectsids.push(o.initializedData.elemsforRules[i].id);
                    createComboBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, !0);
                    break;
                case "executeservice":
                    for (eleSer in o.appvm[o.idPlantilla].servicios())
                        data.push({ Valor: eleSer, Nombre: o.appvm[o.idPlantilla].servicios()[eleSer].customname, Group: 'Servicios' }), subjectsids.push(eleSer);
                    createComboBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, !0);
                    break;
                case "executecomponent":
                    for (eleSer in o.appvm[o.idPlantilla].components())
                        data.push({ Valor: eleSer, Nombre: o.appvm[o.idPlantilla].components()[eleSer].customname, Group: 'Componentes' }), subjectsids.push(eleSer);
                    createComboBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, !0);
                    break;
                case "executerule":
                    for (eleSer in o.appvm[o.idPlantilla].reglas())
                        data.push({ Valor: eleSer, Nombre: o.appvm[o.idPlantilla].reglas()[eleSer].name, Group: 'Reglas' }), subjectsids.push(eleSer);
                    createComboBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, !0);
                    break;
                case "showpagetabber":
                    for (i = 0; i < o.initializedData.elemsforRules.length; i++)
                        if (o.initializedData.elemsforRules[i].tipo === o.TE.Pagina || o.initializedData.elemsforRules[i].tipo === o.TE.Seccion && o.appvm[o.appvm[o.initializedData.elemsforRules[i].id].elementopadre()].tipo() === o.TE.Tabber)
                            data.push({ Valor: o.initializedData.elemsforRules[i].id, Nombre: o.initializedData.elemsforRules[i].nom, Group: o.initializedData.elemsforRules[i].group }), subjectsids.push(o.initializedData.elemsforRules[i].id);
                    createComboBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, !0);
                    break;
                case "operationon": case "operationexe":
                    for (eleSer in o.appvm[o.idPlantilla].operacionesmatematicas())
                        data.push({ Valor: eleSer, Nombre: o.appvm[o.idPlantilla].operacionesmatematicas()[eleSer].customname, Group: 'Operaciones' }), subjectsids.push(eleSer);
                    createComboBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, !0);
                    break;
                case "localprefill":
                    for (eleSer in o.appvm[o.idPlantilla].prefilleddata())
                        o.appvm[o.idPlantilla].prefilleddata()[eleSer].isLocal &&
                            (data.push({ Valor: eleSer, Nombre: o.appvm[o.idPlantilla].prefilleddata()[eleSer].name, Group: 'Prellenado' }), subjectsids.push(eleSer));
                    createComboBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, !0);
                    break;
                case "downloadFE": case "previewFE": case "downloadDoc": case "mappingon":
                    for (eleSer in o.appvm[o.idPlantilla].pdfmapping())
                        data.push({ Valor: eleSer, Nombre: o.appvm[o.idPlantilla].pdfmapping()[eleSer].customname, Group: 'Mapeo Archivo' }), subjectsids.push(eleSer);
                    if (verb === "mappingon") createTagBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, !0);
                    else createComboBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, !0);
                    break;
                case "downloadanexo":
                    for (i = 0; i < o.initializedData.elemsforRules.length; i++)
                        if (_.includes([o.TE.Imagen, o.TE.Georeferencia], o.initializedData.elemsforRules[i].tipo))
                            data.push({ Valor: o.initializedData.elemsforRules[i].id, Nombre: o.initializedData.elemsforRules[i].nom, Group: o.initializedData.elemsforRules[i].group }), subjectsids.push(o.initializedData.elemsforRules[i].id);
                    createComboBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, !0);
                    break;
                case "autocamara": case "deleteanexo":
                    for (i = 0; i < o.initializedData.elemsforRules.length; i++)
                        if (_.includes([o.TE.Imagen, o.TE.Documento, o.TE.Georeferencia], o.initializedData.elemsforRules[i].tipo))
                            data.push({ Valor: o.initializedData.elemsforRules[i].id, Nombre: o.initializedData.elemsforRules[i].nom, Group: o.initializedData.elemsforRules[i].group }), subjectsids.push(o.initializedData.elemsforRules[i].id);
                    createComboBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, !0);
                    break;
                case "getguidanexo":
                    for (i = 0; i < o.initializedData.elemsforRules.length; i++)
                        if (_.includes([o.TE.Texto, o.TE.TextArea], o.initializedData.elemsforRules[i].tipo))
                            data.push({ Valor: o.initializedData.elemsforRules[i].id, Nombre: o.initializedData.elemsforRules[i].nom, Group: o.initializedData.elemsforRules[i].group }), subjectsids.push(o.initializedData.elemsforRules[i].id);
                    createComboBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, !0);
                    break;
                case "clicveridas":
                    for (i = 0; i < o.initializedData.elemsforRules.length; i++)
                        if (_.includes([o.TE.OCR], o.initializedData.elemsforRules[i].tipo))
                            data.push({ Valor: o.initializedData.elemsforRules[i].id, Nombre: o.initializedData.elemsforRules[i].nom, Group: o.initializedData.elemsforRules[i].group }), subjectsids.push(o.initializedData.elemsforRules[i].id);
                    createComboBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, !0);
                    break;
                case "selectall":
                    for (i = 0; i < o.initializedData.elemsforRules.length; i++)
                        if (_.includes([o.TE.ComboDinamico], o.initializedData.elemsforRules[i].tipo))
                            data.push({ Valor: o.initializedData.elemsforRules[i].id, Nombre: o.initializedData.elemsforRules[i].nom, Group: o.initializedData.elemsforRules[i].group }), subjectsids.push(o.initializedData.elemsforRules[i].id);
                    createComboBoxForActionSubj(o, ass, c, idrule, row, data, subjectsids, !0);
                    break;
            }
        }
        function drawActionPredicates(idrule, row, verb, subj, c, o) {
            var aps = $('<div class="col-sm-11 col-11 contpredact"></div>'), data = [], predids = [], i, pred, pcs;
            switch (verb) {
                case "multiedit":
                    for (i = 0; i < o.initializedData.elemsforRules.length; i++)
                        if (o.initializedData.elemsforRules[i].tipo === o.TE.Tabla)
                            for (var h = 0; h < o.initializedData.elemsforRules.length; h++)
                                o.initializedData.elemsforRules[h].tabla === o.initializedData.elemsforRules[i].id && data.push({
                                    Valor: o.initializedData.elemsforRules[h].id, Nombre: o.initializedData.elemsforRules[h].nom, Group: o.initializedData.elemsforRules[h].group
                                }), predids.push(o.initializedData.elemsforRules[h].id);
                    createTagBoxForActionPred(o, aps, c, idrule, row, data, predids);
                    break;
                case "changeformat":
                    data = _.map(_.keys(o.appvm[o.idPlantilla].prefilleddata()), function (vel) { return { Nombre: o.appvm[o.idPlantilla].prefilleddata()[vel].name, Valor: vel }; });
                    createComboBoxForActionPred(o, aps, c, idrule, row, data);
                    break;
                case "changemapping":
                    data = _.map(_.keys(o.appvm[o.idPlantilla].pdfmapping()), function (vel) { return { Nombre: o.appvm[o.idPlantilla].pdfmapping()[vel].customname, Valor: vel }; });
                    createComboBoxForActionPred(o, aps, c, idrule, row, data);
                    break;
                case "filterlist":
                    pcs = $('<div class="row form-horizontal"><div class="col-sm-9 col-9 modepredicate' + c + '" style="display:inline-flex; max-height:10px">\
                                    <div id="element" class="tabElementrulechoise">Por elemento texto</div>\
                                    <div id="cat" class="tabElementrulechoise">Por catálogo</div>\
                                </div></div>\
                                <div class="row form-horizontal"><div class="col-sm-12 col-12 contentpredicate' + c + '">\
                                    <div id="divcat' + c + '"><select id="selectcat' + c + '"></select></div>\
                                    <div id="divelemtext' + c + '"><select id="selecttext' + c + '"></select></div>\
                                </div>'), pred = o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate;
                    var elemdata = _.filter(o.initializedData.elemsforRules, function (v) { return v.tipo === o.TE.Texto; }),
                        actData = function () { o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate = pred; };
                    o.configModal.find(".actionpredicate" + c).append(pcs), typeof pred === "string" && (pred = { mode: "cat", value: "" });
                    !!pred.value || (pred.value = ""), actData();
                    var chooselement = function (elem) {
                        pcs.find(".modepredicate" + c).find(".tabElementrulechoiseSel").removeClass("tabElementrulechoiseSel");
                        pcs.find(".modepredicate" + c).find("#" + elem.attr("id")).addClass("tabElementrulechoiseSel");
                        pcs.find("#divcat" + c + ",#divelemtext" + c).hide();
                        switch (elem.attr("id")) {
                            case "cat": pred.mode = "cat", pcs.find("#divcat" + c).show(); break;
                            case "element": pred.mode = "element", pcs.find("#divelemtext" + c).show(); break;
                        }
                    };
                    pcs.find("#divcat" + c).find("select").css({ width: "100%" }).combobox({
                        data: o.datatags.allitemscatalogs[o.appvm[subj].fuentedatos() + "|" + o.appvm[subj].catalogoorigen()], value: pred.mode === "cat" ? pred.value.split(",") : "", multiple: !0,
                        valueField: 'Valor', textField: 'Nombre', idField: "Valor", prompt: 'Seleccione...', limitToList: !0, panelHeight: "auto", panelMaxHeight: 200,
                        onChange: function (item) { pred.mode === "cat" && (pred.value = $(this).combobox("getValues").join(",")), actData(); }
                    });
                    pcs.find("#divelemtext" + c).find("select").css({ width: "100%" }).combobox({
                        data: elemdata, value: pred.mode === "element" ? elemsExist(elemdata, pred.value, 'id') : "", limitToList: !0,
                        valueField: 'id', textField: 'nom', groupField: "group", idField: "id", groupPosition: "sticky", prompt: 'Seleccione...',
                        onSelect: function (item) { pred.mode === "element" && (pred.value = item.id); actData(); }
                    });
                    pcs.find(".modepredicate" + c).on("click", function (e) { e.target !== undefined && chooselement($(e.target)); });
                    chooselement(pcs.find(".modepredicate" + c).find(pred.mode === "element" ? "#element" : "#cat"));
                    break;
                case "showmessage": case "changebuttonurl":
                    typeof o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate !== "string" && (o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate = ""),
                        aps.append('<textarea class="form-control"></textarea>'), aps.find("textarea").val(o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate.replace(/&amp;/g, "&")).on("blur", function () {
                            o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate = $(this).val();
                        }), o.configModal.find(".actionpredicate" + c).append(aps);
                    break;
                case "value": case "multiplevalue": case "exportdatabyrow": case "changesigntext":
                    var ep = _.groupBy(o.initializedData.elemsforRules, 'tipo'), rrr = idrule + '_' + row + '_' + subj;
                    var de = ep[o.appvm[subj].tipo()];
                    _.includes([o.TE.FirmaFAD], o.appvm[subj].tipo()) &&
                        _.forEach(_.keys(ep), function (mv) { de = _.union(ep[o.TE.Texto], ep[o.TE.TextArea], ep[o.TE.Leyenda]); });
                    _.includes([o.TE.CodigoBarras, o.TE.Texto, o.TE.TextArea, o.TE.ComboDinamico, o.TE.Lista], o.appvm[subj].tipo()) &&
                        _.forEach(_.keys(ep), function (mv) { _.includes(o.flexibleelement, mv) && (de = _.union(de, ep[mv])); });
                    _.includes([o.TE.Leyenda], o.appvm[subj].tipo()) &&
                        _.forEach(_.keys(ep), function (mv) { (_.includes(o.flexibleelement, mv) || mv === o.TE.Tabla) && (de = _.union(de, ep[mv])); });
                    _.includes([o.TE.ComboBoxTemporal], o.appvm[subj].tipo()) && (de = _.union(de, ep[o.TE.CodigoBarras], ep[o.TE.Texto], ep[o.TE.TextArea]));
                    _.includes([o.TE.Numero, o.TE.Moneda], o.appvm[subj].tipo()) && (de = _.union(de, ep[o.TE.Numero], ep[o.TE.Moneda], ep[o.TE.Deslizante]));
                    _.includes(o.TE.Deslizante, o.appvm[subj].tipo()) && (de = _.union(de, ep[o.TE.Deslizante], ep[o.TE.Moneda], ep[o.TE.Numero], ep[o.TE.Texto], ep[o.TE.TextArea]));
                    _.includes(o.TE.Georeferencia, o.appvm[subj].tipo()) && (de = _.union(de, ep[o.TE.Texto]));
                    de = _.map(de, function (v) { return { Valor: v.id, Nombre: v.nom, Group: v.group }; });
                    _.includes(_.keys(o.appvm[o.idPlantilla].reglas()[idrule].actions[row].subject), subj) &&
                        o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate.mode ||
                        (o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate = { value: "", mode: "" });
                    drawConditionPredicates(idrule, row, subj, de, subj, verb, c, rrr, o, !0); break;
                case "reassignuser":
                    var gdata = _.groupBy(o.initializedData.elemsforRules, 'tipo');
                    data = _.union(gdata[o.TE.Texto], gdata[o.TE.TextArea], gdata[o.TE.ComboDinamico]);
                    createComboBoxForActionPred(o, aps, c, idrule, row, data, "id", "nom");
                    break;
                case "execute":
                    switch (o.appvm[subj].tipo()) {
                        case o.TE.Tabla:
                            data.push({ Valor: "tableshowadd", Nombre: "Abrir una nueva captura" }),
                                data.push({ Valor: "tableadd", Nombre: "Agregar un nuevo registro sin cerrar" }),
                                data.push({ Valor: "addclear", Nombre: "Agregar un nuevo registro y cerrar" }),
                                data.push({ Valor: "closeclear", Nombre: "Cerrar captura" }),
                                data.push({ Valor: "clear", Nombre: "Limpiar captura" }),
                                data.push({ Valor: "clearall", Nombre: "Limpiar tabla completa" });
                            break;
                        case o.TE.Wizard:
                            data.push({ Valor: "backward", Nombre: "Regresar" }),
                                data.push({ Valor: "forward", Nombre: "Avanzar" }),
                                data.push({ Valor: "finish", Nombre: "Finalizar" });
                            break;
                    }
                    createComboBoxForActionPred(o, aps, c, idrule, row, data);
                    break;
                case "changenavigation":
                    pred = o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate;
                    data = _.map(_.filter(o.initializedData.elemsforRules, { tipo: o.TE.Pagina }), 'id');
                    !pred.value && (pred.value = "");
                    var predvalSel = pred.value.split(","), apdata = "", valsel = "", ndata = [];
                    _.forEach(predvalSel, function (dve) { !o.appvm[dve] ? _.remove(predvalSel, dve) : ndata.push(dve); });
                    _.forEach(data, function (v) { !_.includes(ndata, v) && ndata.push(v); });
                    pcs = $('<div class="d-inline-flex flex-column w-100"><div style="max-height:70px; overflow:auto;"><table style="word-break: break-all" class="dataresumen table table-condensed table-hover no-margin table-striped border rounded"></table></div></div>');
                    o.configModal.find(".actionpredicate" + c).append(pcs);

                    var actdata = function () {
                        predvalSel = [], _.forEach(pcs.find('.dataresumen input:checked'), function (v) { predvalSel.push(v.id); });
                        pred.value = predvalSel.join(",");
                    };

                    for (var w = 0; w < ndata.length; w++)
                        valsel = _.find(predvalSel, function (dve) { return dve === ndata[w]; }),
                            apdata += '<tr><td style="display:inline-grid; padding: 0px 10px;"><i style="cursor:pointer;min-height:10px" ',
                            w > 0 && (apdata += 'class="fas fa-angle-up"'), apdata += '></i><i style="cursor:pointer;min-height:10px" ',
                            w < ndata.length - 1 && (apdata += 'class="fas fa-angle-down"'), apdata += '></i></td><td field>' +
                            o.appvm[ndata[w]].titulo() + '</td><td><input id="' + ndata[w] + '" type="checkbox" ', !valsel || (apdata += ' checked'), apdata += '></td></tr>';
                    pcs.find('.dataresumen').append(apdata);
                    pcs.find('.fa-angle-down').on('click', function (e) {
                        var em = $($(e.target).closest("tr")).find('td:not(:first-child)'); var nem = $($(e.target).closest("tr")).next().find('td:not(:first-child)');
                        nem[0] && em.last().after(nem), $($(e.target).closest("tr")).next().find('td:nth-child(1)').after(em); actdata();
                    });
                    pcs.find('.fa-angle-up').on('click', function (e) {
                        var em = $($(e.target).closest("tr")).find('td:not(:first-child)'); var nem = $($(e.target).closest("tr")).prev().find('td:not(:first-child)');
                        nem[0] && em.last().after(nem), $($(e.target).closest("tr")).prev().find('td:nth-child(1)').after(em); actdata();
                    });
                    pcs.find('input[type=checkbox]').on('click', function () { actdata(); });
                    break;
                case "hidecolumn":
                    var cnSet = _.filter(o.initializedData.elemsforRules, { tabla: subj });
                    for (var cn = 0; cn < cnSet.length; cn++)
                        data.push({ Nombre: cnSet[cn].nom, Valor: cnSet[cn].id }), predids.push(cnSet[cn].id);
                    createTagBoxForActionPred(o, aps, c, idrule, row, data, predids);
                    break;
                case "executerule":
                    aps.append('<span class="text-bold">¿Se evaluarán las condiciones?</span><input />'), o.configModal.find(".actionpredicate" + c).append(aps),
                        pred = o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate,
                        aps.find("input").switchbutton({
                            checked: pred === !0,
                            onChange: function (checked) { o = getOpts(), o.appvm[o.idPlantilla].reglas()[idrule].actions[row].predicate = checked, updateOpts(o, !0); }
                        });
                    break;
                case "getguidanexo":
                    var gdata = _.groupBy(o.initializedData.elemsforRules, 'tipo');
                    data = _.union(gdata[o.TE.Imagen], gdata[o.TE.Documento]);
                    createComboBoxForActionPred(o, aps, c, idrule, row, data, "id", "nom");
                    break;
            }
        }
        function drawRule(o, r, isnewdraw) {
            var cont = '';
            if (isnewdraw) cont = '<div class="configrule' + r + '">\
                <div class="bodyrule' + r + '">\
                    <div class="w-100" style="text-align: center;">\
                        <div class="actionsrules'+ r + '">\
                        </div>\
                    </div>\
                    <div class="p-1 font-weight-bold rounded d-inline-flex justify-content-between w-100 align-items-center" style="font-size:1.2rem; background-color:#e9e6e2"><span>Si se cumplen <div class="logicrule' + r + '"></div> las condiciones:</span>\
                        <div class="float-right btn btn-light btn-sm border addcondition' + r + '">Agregar condición</div>\
                    </div>\
                    <div class="w-100 conditionsrules' + r + '" style="max-height:25vh; overflow:auto;"></div>\
                </div>\
            </div>';
            else cont = `<div class="configrule${r}">
                <div class="bodyrule${r}">
                    <div class="p-1 font-weight-bold rounded d-inline-flex justify-content-between w-100 align-items-center" style="font-size:1.2rem; background-color:#e9e6e2">
                        <span>Si se cumplen <div class="logicrule${r}"></div> las condiciones:</span>
                        <div class="float-right btn btn-light btn-sm border addcondition${r}">Agregar condición</div>
                    </div>
                    <div class="w-100 conditionsrules${r}" style="max-height:25vh; overflow:auto;"></div>
                    <div class="p-1 font-weight-bold rounded mt-2 d-inline-flex justify-content-between w-100 align-items-center" style="font-size:1.2rem; background-color:#e9e6e2">
                        <span>Ejecutar las siguientes acciones:</span>
                        <div class="float-right btn btn-light btn-sm border addaction${r}">Agregar acción</div>
                    </div>
                    <div class="w-100" style="max-height:25vh; overflow:auto;">
                        <table class="table table-striped table-condensed actionsrules${r}">
                            <thead>
                                <tr class="text-center">
                                    <th></th>
                                    <th></th>
                                    <th></th>
                                    <th class="border-right">Acci&oacute;n</th>
                                    <th class="border-right">Al</th><th class="border-right">De</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>`;
            var acti = $(cont);

            o.configModal.find("div.collectionelements div#elem" + r).append(acti[0]), o.configModal.find(".addcondition" + r).on("click", function () { drawNewRowType(o, r, "conditions"); }),
                o.configModal.find(".addaction" + r).on("click", function () { drawNewRowType(o, r, "actions"); });

            if (_.isEmpty(o.appvm[o.idPlantilla].reglas()[r].conditions)) drawNewRowType(o, r, "conditions");
            else for (var co in o.appvm[o.idPlantilla].reglas()[r].conditions) addRowCondition(o, r, co);

            if (_.isEmpty(o.appvm[o.idPlantilla].reglas()[r].actions)) drawNewRowType(o, r, "actions");
            else {
                var acts = _.orderBy(_.map(o.appvm[o.idPlantilla].reglas()[r].actions, function (va, key) { return { ord: va.order, ke: key }; }), ["ord"]);
                for (var or = 0; or < acts.length; or++) addRowAction(o, r, acts[or].ke, isnewdraw);
            }
            o.configModal.find(".logicrule" + r).combobox({
                data: [{ value: "all", desc: "Todas" }, { value: "any", desc: "Alguna de" }], valueField: "value", textField: "desc",
                prompt: "Seleccione...", limitToList: !0, value: o.appvm[o.idPlantilla].reglas()[r].logic, editable: !1, panelHeight: "auto",
                onChange: function (item) { o.appvm[o.idPlantilla].reglas()[r].logic = item; }
            });
            o.configModal.find("#descrule" + r).on("change", function () {
                o.appvm[o.idPlantilla].reglas()[r].desc = $(this).val();
            }).val(o.appvm[o.idPlantilla].reglas()[r].desc);
        }
        function drawNewRowType(o, idrule, type) {
            o = o || getOpts();
            var row = getGuidForElem(o, "reglas", row, type, idrule), actnum = _.keys(o.appvm[o.idPlantilla].reglas()[idrule].actions).length + 1;
            type === "conditions" && (o.appvm[o.idPlantilla].reglas()[idrule].conditions[row] = {}, addRowCondition(o, idrule, row)),
                type === "actions" && (o.appvm[o.idPlantilla].reglas()[idrule].actions[row] = { order: actnum }, addRowAction(o, idrule, row));
        }
        function evaluateConditions(o, id) {
            var r, revad = !1, co, s, res, l;
            for (r in o.conditions) {
                if (o.jobj.elemento.atributos.reglas[r].enabled === !0) {
                    //check if this rule can execute after a time of 1000 miliseconds to avoid multiple executions by render or by infinite loop
                    if (o.conditions[r].executeonerulebytime === !0) {
                        var shutdownrulebytime = function (r2) {
                            o.conditions[r2].executeonerulebytime = !1; /*se apaga para evitar se ejecute de nuevo hasta dentro de 1 segundos*/
                            setTimeout(function () {
                                o.conditions[r2].executeonerulebytime = !0; /*puede volver a ejecutar reglas*/
                            }, 1000);
                        };
                        for (co in o.conditions[r]) {
                            if (co === "executeonerulebytime") continue;
                            if (revad) { revad = !1; break; } //regla evaluada completamente
                            for (s in o.conditions[r][co])
                                if (s === id) {
                                    l = o.jobj.elemento.atributos.reglas[r].logic, res = o.conditions[r][co][s]();
                                    if (l === "any" && res) {
                                        assignErrorToTable(o, r), cleanErrorTable(o, r);
                                        addHistoriaReporteEstadistico(o, r, o.CategoriaReporteEstadistico.Regla);
                                        resolveActions(o, r), revad = !0; break;
                                    }
                                    if (l === "all" && res || l === "any" && !res) {
                                        if (recursiveEvaluateConditionsOfRule(o, r, co, s, l)) {
                                            assignErrorToTable(o, r), cleanErrorTable(o, r), shutdownrulebytime(r);
                                            addHistoriaReporteEstadistico(o, r, o.CategoriaReporteEstadistico.Regla);
                                            resolveActions(o, r), revad = !0;
                                        }
                                        break;
                                    }
                                    cleanErrorTable(o, r);
                                }
                        }
                        revad && (revad = !1);
                    }
                }
            }
        }
        function evaluateOneRule(o, r, ev) {
            if (!_.isEmpty(r)) {
                if (ev === !0) { //se evaluan las condiciones de las reglas
                    if (typeof r === 'string') evaluateConditionsOFOneRule(o, r);
                    else _.keys(r).forEach((rr) => { evaluateConditionsOFOneRule(o, rr); });
                } else {
                    if (typeof r === 'string') resolveActions(o, r);
                    else _.keys(r).forEach((rr) => { resolveActions(o, rr); });
                }
            }
        }
        function evaluateConditionsOFOneRule(o, r) {
            var co, s, l, res, revad = !1;
            for (co in o.conditions[r]) {
                if (co === "executeonerulebytime") continue;
                if (revad) { revad = !1; break; } //regla evaluada completamente
                if (o.jobj.elemento.atributos.reglas[r].conditions[co].category === "withoutcondition") {
                    //como es categoria de "SIN CONDICIONES" se salta todo y va directo a las acciones
                    resolveActions(o, r);
                } else {
                    for (s in o.conditions[r][co]) {
                        if (s !== "undefined") {
                            l = o.jobj.elemento.atributos.reglas[r].logic, res = o.conditions[r][co][s]();
                            if (l === "any" && res) {
                                assignErrorToTable(o, r), cleanErrorTable(o, r);
                                resolveActions(o, r), revad = !0; break;
                            }
                            if (l === "all" && res || l === "any" && !res) {
                                if (recursiveEvaluateConditionsOfRule(o, r, co, s, l)) {
                                    assignErrorToTable(o, r), cleanErrorTable(o, r);
                                    resolveActions(o, r), revad = !0;
                                }
                                break;
                            }
                            cleanErrorTable(o, r);
                        } else {
                            //como esta vacia la regla ya no se ejecuta porque pidieron evaluar y esto se considera mala configuracion
                        }
                    }
                }
            }
        }
        function assignErrorToTable(o, r) {
            var myerrortab = o.errortable[r];
            if (myerrortab) {
                for (var mi = 0; mi < myerrortab.length; mi++) {
                    var tableid = myerrortab[mi];
                    o.appvm[tableid] && _.forEach(_.keys(o.appvm[tableid].errorjson()), function (mo) {
                        _.forEach(_.keys(o.appvm[tableid].errorjson()[mo]), function (mon) { o.appvm[tableid].valorjson()[mo][mon].haserror(!0); });
                    });
                }
            }
        }
        function cleanErrorTable(o, r) {
            var myerrortab = o.errortable[r];
            if (myerrortab) {
                for (var mi = 0; mi < myerrortab.length; mi++) o.appvm[myerrortab[mi]].errorjson({});
                myerrortab = [];
            }
        }
        function moveupdownaction(r, ac, up) {
            var o = getOpts(), isupelem = up ? "prev" : "next", ract = $(".rowaction" + r + '_' + ac), prevkey = !!ract[isupelem]()[0] && !!ract[isupelem]()[0].className ? ract[isupelem]()[0].className.split('_')[1] : '',
                prevelem = o.appvm[o.idPlantilla].reglas()[r].actions[prevkey];
            if (prevelem) {
                o.appvm[o.idPlantilla].reglas()[r].actions[ac].order += up ? -1 : 1;
                prevelem.order += up ? 1 : -1;
                up ? ract.insertBefore(ract[isupelem]()) : ract.insertAfter(ract[isupelem]());
                reorderActionAngles(o, r);
            }
        }
        function reorderActionAngles(o, r) {
            var mo = _.orderBy(o.appvm[o.idPlantilla].reglas()[r].actions, 'order');
            for (var imp = 0; imp < mo.length; imp++) mo[imp].order = imp;
            _.forEach(_.keys(o.appvm[o.idPlantilla].reglas()[r].actions), function (keyval) {
                var elemtomod = o.configModal.find(".rowaction" + r + "_" + keyval), ord = o.appvm[o.idPlantilla].reglas()[r].actions[keyval].order;
                elemtomod.find(".actord").text(ord); _.size(o.appvm[o.idPlantilla].reglas()[r].actions) === 1 ?
                    (elemtomod.find(".moveup").attr("hidden", ""), elemtomod.find(".movedown").attr("hidden", ""))
                    : (ord === 0 ? elemtomod.find(".moveup").attr("hidden", "") : elemtomod.find(".moveup").removeAttr("hidden"),
                        ord === _.size(o.appvm[o.idPlantilla].reglas()[r].actions) - 1 ? elemtomod.find(".movedown").attr("hidden", "") : elemtomod.find(".movedown").removeAttr("hidden"));
            });
        }
        function recursiveEvaluateConditionsOfRule(o, r, co, s, l) {
            var co2, s2, res, clonecond = _.clone(o.conditions[r]), arrayres = [];
            for (co2 in clonecond)
                for (s2 in clonecond[co2]) {
                    if (s2 === s && co2 === co) { delete clonecond[co2]; break; } //ya fue evaluado
                    if (clonecond[co2][s2]) {
                        res = clonecond[co2][s2](),
                            //console.log("Evaluando Regla: \"{3}\" - por condicion del elemento \"{1}\" - ({0}) - Respuesta: {2}".format(s2, o.appvm[s2] ? o.appvm[s2].titulo ? o.appvm[s2].titulo() : "" : "", res, o.jobj.elemento.atributos.reglas[r].name)), 
                            arrayres.push(res);
                        if (l === "any" && res) return true;//solo se necesita uno
                        if (l === "all" && !res) return false;//si uno falla, ya no se evalua lo demas
                    }
                }
            return l === "any" && _.some(arrayres, function (v) { return v; }) ? true :
                l === "all" && _.every(arrayres, function (v) { return v; }) ? true : false;
        }
        function resolveActions(o, r) {
            var b, v, s, p, pred, a, neg;
            var acts = _.orderBy(_.map(o.jobj.elemento.atributos.reglas[r].actions, function (va, key) {
                return { ord: va.order || 0, ke: key };
            }), ["ord"]);
            for (var or = 0; or < acts.length; or++) {
                a = acts[or].ke, v = o.jobj.elemento.atributos.reglas[r].actions[a].verb, neg = !!o.appvm[o.idPlantilla].reglas()[r].actions[a].negation,
                    s = _.keys(o.jobj.elemento.atributos.reglas[r].actions[a].subject), p = o.jobj.elemento.atributos.reglas[r].actions[a].predicate;
                console.log(`Realizando accion Regla: "${o.jobj.elemento.atributos.reglas[r].name}" - ${v} del(os) sujeto(s) ${s.join(", ")}`);
                o.changeLogs.push(`Se disparó la regla: "${o.jobj.elemento.atributos.reglas[r].name}" - por la accion ${v} del(os) sujeto(s) ${s.join(", ")}`);

                switch (v) {
                    case "visible": case "notvisible": case "notenabled": case "enabled": case "required": case "notrequired":
                        b = !(v.indexOf("not") >= 0); v = v.replace('not', ''); v.indexOf("enabled") >= 0 ? v = "habilitado" : v.indexOf("required") >= 0 && (v = "requerido");
                        _.forEach(s, function (subj) {
                            if (o.appvm[subj]) {
                                o.appvm[subj][v] && o.appvm[subj][v](b); v === "requerido" && validateControl(o, subj, true, false);
                            }
                        });
                        $("body").resize();
                        break;
                    case "value": case "multiplevalue": case "exportdatabyrow": case "changesigntext":
                        b = "";
                        //Se determina si el valor es lista a lista
                        if (v !== "exportdatabyrow" && p.mode === "element" && o.appvm[p.value] && _.includes([o.TE.Lista, o.TE.MarcadoDocumentos], o.appvm[p.value].tipo()) && o.appvm[s[0]]
                            && _.includes([o.TE.Lista, o.TE.MarcadoDocumentos], o.appvm[s[0]].tipo())) {
                            if (!!o.appvm[p.value].valor() && _.isEmpty(o.appvm[p.value].chosenitems()))
                                checkTipoListaDefaultItemAndSet(o, p.value);
                            b = o.appvm[p.value].chosenitems() ? o.appvm[p.value].tipolista() === "checkbox" ? o.appvm[p.value].chosenitems() : [o.appvm[p.value].chosenitems()] : [];
                            if (b.length === 0) o.appvm[s[0]].chosenitemsRule([]), o.appvm[s[0]].optionselectedRule("");
                            else {
                                o.appvm[s[0]].chosenitemsRule(o.appvm[s[0]].tipolista() === "checkbox" ? b : b[0]);
                                if (o.appvm[s[0]].tipolista() === "combo") o.appvm[s[0]].optionselectedRule(b[0].Valor);
                            }
                        }
                        else {
                            if (p.mode === "words") b = p.value; //Por defecto
                            else if (p.mode === "varusr" && !!p.value && p.value.toString().length > 0) { //Valor usuario
                                p.value = p.value.toString();
                                if (p.value.toLowerCase() === "today") b = moment(new Date()).format('YYYYMMDD');
                                else if (p.value.toLowerCase() === "now") b = moment(new Date()).format('HH:mm');
                                else {
                                    var mo = _.find(o.datatags.reglasInfoDocUsr, function (v) { return v.Valor === p.value; });
                                    mo !== undefined && (b += !mo.Esquema ? "" : mo.Esquema);
                                }
                            }
                            else if (p.mode === "element") { //Elemento
                                if (v === "exportdatabyrow") { //si es exportacion de fila de una tabla a elemento
                                    var tabl, co, ns; //se busca la tabla mencionada en las condiciones, se obtiene la primera que se encuentra ya que no tiene sentido una accion de exportar mencionando 2 ó más tablas
                                    for (co in o.conditions[r]) {
                                        for (ns in o.conditions[r][co]) if (o.appvm[ns].tipo() === o.TE.Tabla) { tabl = ns; break; }
                                        if (tabl) break;
                                    }
                                    if (o.appvm[p.value] && tabl && o.appvm[tabl]) {
                                        var jsonrow = {}; //se extrae el valormetadato de la fila de la tabla
                                        for (var k = 0; k < o.appvm[tabl].valorjson().length; k++) {
                                            if (o.appvm[tabl].valorjson()[k].Acciones.exerule() === !0) {
                                                jsonrow = o.appvm[tabl].valorjson()[k]; break;
                                            }
                                        }
                                        b = jsonrow[p.value] ? jsonrow[p.value]["valormetadato"]() : "";
                                    }
                                } else {
                                    if (o.appvm[p.value]) {
                                        if (_.includes([o.TE.Lista, o.TE.MarcadoDocumentos], o.appvm[p.value].tipo())) {
                                            if (!!o.appvm[p.value].valor() && _.isEmpty(o.appvm[p.value].chosenitems()))
                                                checkTipoListaDefaultItemAndSet(o, p.value);
                                            var ta = _.includes(["idid", "descid"], o.appvm[p.value].tipoasociacion()) ? "Valor" : "Nombre";
                                            o.appvm[p.value].tipolista() === "checkbox" ? b = _.map(o.appvm[p.value].chosenitems(), function (vel) { return vel[ta]; }).join(",") :
                                                !!o.appvm[p.value].chosenitems() && (b = o.appvm[p.value].chosenitems()[ta]);
                                        }
                                        else if (o.appvm[p.value].tipo() === o.TE.RangoFechas) b = o.appvm[p.value].valormetadatorango();
                                        else if (o.appvm[p.value].tipo() === o.TE.Tabla) {
                                            _.forEach(o.appvm[p.value].valorjson(), function (elemrow) {
                                                b += "<div class='card mb-1'><div class='card-body p-3'>";
                                                _.forEach(_.keys(elemrow), function (ekeyrow) {
                                                    ekeyrow.indexOf("formElec_element") >= 0 && o.appvm[ekeyrow] && (
                                                        b += "<span><strong>" + o.appvm[ekeyrow].titulo() + "</strong> " + elemrow[ekeyrow].valor() + "</span><br />");
                                                });
                                                b += "</div></div>";
                                            });
                                        }
                                        else {
                                            if (s.length > 0 && o.appvm[s[0]] && o.appvm[s[0]].tipo() === o.TE.Lista)
                                                b = o.appvm[p.value].valormetadato();
                                            else
                                                b = o.appvm[p.value].valor();
                                        }
                                    }
                                }
                            }
                            _.forEach(s, function (subj) {
                                if (o.appvm[subj]) {
                                    if (_.includes([o.TE.Lista, o.TE.MarcadoDocumentos], o.appvm[subj].tipo())) {
                                        var opsel = [{ Nombre: "Seleccione", Valor: "", CatalogoId: o.appvm[subj].catalogoorigen(), CveCatalogo: "", CatalogoPId: 0 }];
                                        if (b !== undefined) {
                                            b = typeof b === "string" || typeof b === "number" ? b.toString().split(",") : _.isArray(b) ? b : [b];
                                            if (_.isArray(b) && b.length && !b[0].Valor) b = _.toString(b).split(",");
                                            opsel = _.filter(o.datatags.allitemscatalogs[o.appvm[subj].fuentedatos() + "|" + o.appvm[subj].catalogoorigen()], function (belem) {
                                                return _.includes(b, belem.Valor) || _.includes(b.Valor, belem.Valor) && _.includes(b.Nombre, belem.Nombre);
                                            });
                                        }
                                        if (opsel !== undefined) {
                                            opsel = o.appvm[subj].tipolista() !== "checkbox" ? _.head(opsel) : opsel;
                                            if (o.appvm[subj].tipolista() === "combo") o.appvm[subj].optionselectedRule(opsel === undefined ? "" : opsel.Valor);
                                            else o.appvm[subj].chosenitemsRule(opsel);
                                        }
                                    }
                                    else if (_.includes([o.TE.Deslizante, o.TE.Numero], o.appvm[subj].tipo()) && !_.isNaN(b))
                                        o.appvm[subj].valor(b);
                                    else if (o.appvm[subj].tipo() === o.TE.RangoFechas)
                                        o.appvm[subj].valormetadatorango && o.appvm[subj].valormetadatorango(b);
                                    else if (o.appvm[subj].tipo() === o.TE.ComboDinamico) {
                                        b = _.find(o.appvm[subj].catalogodestino(), { Valor: b });
                                        o.appvm[subj].optionselected && o.appvm[subj].optionselected(_.isArray(b) ? b : [b]);
                                    }
                                    else if (_.includes([o.TE.FirmaFAD], o.appvm[subj].tipo()))
                                        o.appvm[subj].acuerdofirma(b);
                                    else if (o.appvm[subj].tipo() === o.TE.Logico)
                                        o.appvm[subj].valor(_.includes(["1", "true", 1, true], b));
                                    else o.appvm[subj].valor && o.appvm[subj].valor(b.toString());
                                }
                            });
                        }
                        break;
                    case "clicbutton": _.forEach(s, function (subj) {
                        if (o.appvm[subj]) o.appvm[subj].click();
                    }); break;
                    case "clicveridas": _.forEach(s, function (subj) {
                        if (o.appvm[subj]) customActionElement(subj, [o.appvm[subj], 'Veridas'], !0);
                    }); break;
                    case "asmodal": _.forEach(s, function (subj) {
                        if (o.appvm[subj]) showSectionAsModal(subj, neg);
                    }); break;
                    case "habilitarseccion": _.forEach(s, function (subj) {
                        if (o.appvm[subj]) habilitarSeccion(subj, !neg);
                    }); break;
                    case "coordenadas": _.forEach(s, function (subj) {
                        if (o.appvm[subj]) customClickButtonsElements(o.appvm[subj].tipo(), subj, 'gpsmap');
                    }); break;
                    case "filterlist": _.forEach(s, function (subj) {
                        if (o.appvm[subj]) {
                            if (_.includes([o.TE.Lista, o.TE.MarcadoDocumentos], o.appvm[subj].tipo())) {
                                var val = p.mode === "cat" ? p.value : "", valtemp = o.appvm[subj].valormetadato() || "";
                                if (p.mode === "element" && o.appvm[p.value] && o.appvm[p.value].valor) val = o.appvm[p.value].valor();
                                o.appvm[subj].filtrarcatalogo({ filtrar: !neg, idfiltrados: val, rangofiltrados: "" });
                                o.appvm[s[0]].tipolista() === "checkbox" ? o.appvm[s[0]].chosenitemsRule([]) : o.appvm[s[0]].chosenitemsRule({}),
                                    o.appvm[s[0]].isfreshly(!1); //esto hace que pueda recuperar su antiguo valor despues de un filtrado

                                if (o.appvm[subj].tipo() === o.TE.Lista)
                                    o.appvm[s[0]].optionselectedRule(valtemp);
                                else {
                                    !!o.appvm[subj].elementodocumento() && o.appvm[o.appvm[subj].elementodocumento()] && updateDocumentCheck(o, o.appvm[subj].elementodocumento(), subj);
                                    $("#cbOptionsDocs" + subj).combobox("loadData", o.appvm[subj].catalogodestino()), $("#cbOptionsDocs" + subj).combobox("clear");
                                }
                            }
                        }
                    }); break;
                    case "multiedit":
                        var kp = _.keys(p);
                        _.forEach(s, function (subj) {
                            if (o.appvm[subj]) {
                                if (o.appvm[subj].columnasmultieditar)
                                    for (var cm in o.appvm[subj].columnasmultieditar())
                                        o.appvm[subj].columnasmultieditar()[cm] = _.includes(kp, cm);
                            }
                        });
                        break;
                    case "cancel":
                        _.forEach(s, function (subj) {
                            switch (subj) {
                                case "save": o.cancelsave = true; break;
                                case "validate": o.cancelvalidate = true; break;
                            }
                        });
                        break;
                    case "showmessage":
                        _.forEach(s, function (subj) {
                            var ty;
                            switch (subj) {
                                case "popuperror": case "popupalert": case "popupinfo":
                                    ty = subj === "popuperror" ? "error" : subj === "popupalert" ? "alerta" : "info",
                                        Modal(o.appvm[o.idPlantilla].titulo(), p, "", ty); break;
                                case "notiferror": case "notifalert": case "notifinfo":
                                    ty = subj === "notiferror" ? "error" : subj === "notifalert" ? "alerta" : "info",
                                        toasty(o.appvm[o.idPlantilla].titulo(), p, ty); break;
                            }
                        });
                        break;
                    case "validate": _.forEach(s, function (subj) {
                        if (o.appvm[subj]) validateControl(o, subj);
                    }); break;
                    case "execute": _.forEach(s, function (subj) {
                        if (o.appvm[subj]) for (pred in p) customClickButtonsElements(o.appvm[subj].tipo(), subj, pred, !0);
                    }); break;
                    case "executeservice": _.forEach(s, function (subj) { executeJsonModule(subj, !0); }); break;
                    case "executecomponent": _.forEach(s, function (subj) { executeJsonModule(subj, !1); }); break;
                    case "executerule": _.forEach(s, function (subj) { evaluateOneRule(o, subj, p); }); break;
                    case "showpagetabber": _.forEach(s, function (subj) {
                        if (o.appvm[subj]) subj.indexOf("formElec_element") >= 0 && (o.appvm[subj].tipo() === o.TE.Pagina ? showPage(subj) : showTab(subj));
                    }); break;
                    case "operationon": _.forEach(s, function (subj) {
                        o.clonedoperacionesmatematicas[subj].enabled = !neg;
                    }); break;
                    case "operationexe": _.forEach(s, function (subj) {
                        var opelem = o.clonedoperacionesmatematicas[subj]; assignValueToElem(opelem, opelem.formula, opelem.identifiers, subj);
                    }); break;
                    case "permisotablaeditarr": case "permisotablaimportarr": case "permisotablaeliminarr": case "permisotablaagregarr": case "permisotablaseleccionarr": case "permisotablamultiedicion": case "permisotablaagregarcerrarr": case "permisotablalimpiar": case "permisotablamostrar": case "permisotablacerrar":
                    case "notpermisotablaeditarr": case "notpermisotablaimportarr": case "notpermisotablaeliminarr": case "notpermisotablaagregarr": case "notpermisotablaseleccionarr": case "notpermisotablamultiedicion": case "notpermisotablaagregarcerrarr": case "notpermisotablalimpiar": case "notpermisotablamostrar": case "notpermisotablacerrar":
                    case "permisotablaeditarxfila": case "notpermisotablaeditarxfila":
                        b = !(v.indexOf("not") >= 0); v = v.replace('not', '');
                        _.forEach(s, function (subj) {
                            if (o.appvm[subj]) o.appvm[subj][v](b);
                        }); break;
                    case "allowdelete": case "allowedit": case "allowselect": case "hiderow": case "editrow":
                        _.forEach(s, function (subj) {
                            if (o.appvm[subj]) {
                                if (v === "editrow") {
                                    _.forEach(o.appvm[subj].valorjson(), function (elmjs) {
                                        if (elmjs.Acciones.exerule())
                                            actionRowTable(subj, ["editing", elmjs.Acciones.id()]);
                                    });
                                }
                                else {
                                    verifyAttrsPerRow(o, subj);
                                    _.forEach(o.appvm[subj].valorjson(), function (elmjs) {
                                        if (elmjs.Acciones.exerule())
                                            v.indexOf("hiderow") >= 0 ? elmjs.Acciones.visible(!1) : elmjs.Acciones[v](!neg);
                                    });
                                    o.appvm[subj].valor(JSON.stringify(ko.mapping.toJS(o.appvm[subj].valorjson())));
                                }
                            }
                        }); break;
                    case "hidecolumnbyrow":
                        var tabl1, co1, ns1; //se busca la tabla mencionada en las condiciones, se obtiene la primera que se encuentra ya que no tiene sentido una accion de ocultar mencionando 2 ó más tablas
                        for (co1 in o.conditions[r]) {
                            for (ns1 in o.conditions[r][co1]) if (o.appvm[ns1].tipo() === o.TE.Tabla) { tabl1 = ns1; break; }
                            if (tabl1) break;
                        }
                        if (tabl1 && o.appvm[tabl1]) {
                            verifyAttrsPerRow(o, tabl1);
                            for (var k1 = 0; k1 < o.appvm[tabl1].valorjson().length; k1++) {
                                if (o.appvm[tabl1].valorjson()[k1].Acciones.exerule() === !0) {
                                    _.forEach(s, function (subj) {
                                        o.appvm[tabl1].valorjson()[k1][subj] && o.appvm[tabl1].valorjson()[k1][subj].colvisible(!1);
                                    });
                                }
                            }
                        }
                        break;
                    case "deleterow":
                        var tabl1, co1, ns1; //se busca la tabla mencionada en las condiciones, se obtiene la primera que se encuentra ya que no tiene sentido una accion de ocultar mencionando 2 ó más tablas
                        for (co1 in o.conditions[r]) {
                            for (ns1 in o.conditions[r][co1]) if (o.appvm[ns1].tipo() === o.TE.Tabla) { tabl1 = ns1; break; }
                            if (tabl1) break;
                        }
                        if (tabl1 && o.appvm[tabl1]) {
                            verifyAttrsPerRow(o, tabl1);
                            for (var k1 = 0; k1 < o.appvm[tabl1].valorjson().length; k1++) {
                                if (o.appvm[tabl1].valorjson()[k1].Acciones.exerule() === !0) {
                                    actionRowTable(tabl1, ['remove', o.appvm[tabl1].valorjson()[k1].Acciones.id()]);
                                }
                            }
                        } break;
                    case "changeformat":
                        o.appvm[s].plantillaabrir(_.keys(p)[0]); break;
                    case "changemapping": _.forEach(s, function (subj) {
                        if (o.appvm[subj]) o.appvm[subj].mapeopdfligar(_.keys(p)[0]);
                    }); break;
                    case "mappingon":
                        _.forEach(s, function (subj) {
                            if (o.appvm[o.idPlantilla].pdfmapping() && o.appvm[o.idPlantilla].pdfmapping()[subj]) o.appvm[o.idPlantilla].pdfmapping()[subj].enabled = !neg;
                        });
                        break;
                    case "localprefill": _.forEach(s, function (subj) {
                        console.log("Accion {1} de {0}".format(subj, v));
                        nextPageIsFormat(o, null, subj);
                    }); break;
                    case "downloadFE":
                        downloadFE(!1, !!s && typeof s !== "string" ? s[0] : "", 2); break;
                    case "previewFE":
                        downloadFE(!0, !!s && typeof s !== "string" ? s[0] : "", 2); break;
                    case "downloadDoc":
                        downloadFE(!1, !!s && typeof s !== "string" ? s[0] : "", 3); break;
                    case "changebuttonurl":
                        o.appvm[s].urllink(p); break;
                    case "changenavigation":
                        var idwiz = !!s && typeof s !== "string" ? s[0] : "";
                        o.appvm[idwiz].navegacion(p.value);
                        if (p.value) {
                            o.wizardnavigation = !o.wizardnavigation ? {} : o.wizardnavigation;
                            _.forEach(o.appvm[idwiz].navegacion().split(","), function (page) {
                                !o.wizardnavigation[page] && (o.wizardnavigation[page] = []);
                                !_.find(o.wizardnavigation[page], function (idwizp) { return idwizp === idwiz; }) && o.wizardnavigation[page].push(idwiz);
                            });
                        }
                        var actpag = "";
                        for (var i = 0; i < o.jobj.elemento.elementos.elemento.length; i++) {
                            var pageid = o.jobj.elemento.elementos.elemento[i]["@idelemento"];
                            if (o.appvm[pageid].tipo() === o.TE.Pagina && o.appvm[pageid].activo()) {
                                actpag = pageid;
                                break;
                            }
                        }
                        updateNavigationWizard(o, [idwiz], actpag);
                        break;
                    case "reassignuser":
                        var valus = _.keys(p);
                        if (valus.length > 0 && s.length > 0) {
                            o.appvm[valus[0]] && (b = o.appvm[valus[0]].valormetadato());
                            o.appvm[s[0]] && o.appvm[s[0]].tipo() === o.TE.Wizard && o.appvm[s[0]].usuarioasignar(b);
                        }
                        break;
                    case "hidecolumn":
                        var hckeys = _.keys(p);
                        if (s && s[0] && o.appvm[s[0]] && hckeys.length > 0) {
                            for (var hckey = 0; hckey < hckeys.length; hckey++)
                                o.appvm[s[0]].columnasvisualizar()[hckeys[hckey]] = neg;
                            o.appvm[s[0]].columnasvisualizar.valueHasMutated();
                        }
                        break;
                    case "downloadanexo":
                        _.forEach(s, function (subj) {
                            if (o.appvm[subj]) customActionElement(subj, [o.appvm[subj].tipo(), "downloadatt"]);
                        });
                        break;
                    case "autocamara": case "deleteanexo":
                        _.forEach(s, function (subj) {
                            if (o.appvm[subj]) //solo si tiene permiso
                                customActionElement(subj, [o.appvm[subj].tipo(), (v === "autocamara" ? "camera" : "delete")]);
                        });
                        break;
                    case "getguidanexo":
                        _.forEach(s, (subj) => {
                            var hckeys = _.keys(p);
                            _.forEach(hckeys, (p) => {
                                if (o.appvm[p]) b = o.appvm[p].anexo().guidanexo;
                                if (o.appvm[subj]) o.appvm[subj].valor(b);
                            });
                        });
                        break;
                    case "selectall":
                        _.forEach(s, (subj) => {
                            if (o.appvm[subj])
                                o.appvm[subj].optionselected && o.appvm[subj].optionselected(!neg ? o.appvm[subj].catalogodestino() : []);
                        });
                        break;
                    default:
                        toasty("", "Acción {0} de la regla {1} no válida en web".format(v, o.jobj.elemento.atributos.reglas[r].name), "error");
                }
            }
        }
        function resolveConditionByRow(o, cat, cond) {
            var result = !1, rowtovalidate, nr, i = 0, rowtov;
            if (cat === "bytable") {
                switch (cond.rowtype) {
                    case "bynewrow":
                        if (o["istb" + "tableadd,addclear" + cond.tableidelem]) {
                            rowtovalidate = _.find(o.appvm[cond.tableidelem].valorjson(), function (elm) { return elm.Acciones.id() === o.appvm[cond.tableidelem].rowonfocus(); });
                            rowtovalidate && (result = validaterow(o, cond, rowtovalidate));
                        }
                        break;
                    case "byeditrow":
                        if (o["istb" + "editing,multi" + cond.tableidelem]) {
                            rowtovalidate = _.find(o.appvm[cond.tableidelem].valorjson(), function (elm) { return elm.Acciones.id() === o.appvm[cond.tableidelem].rowediting(); });
                            rowtovalidate && (result = validaterow(o, cond, rowtovalidate));
                        }
                        break;
                    case "byallrows":
                        result = o.appvm[cond.tableidelem].valorjson().length > 0;
                        for (i = 0; i < o.appvm[cond.tableidelem].valorjson().length; i++) {
                            rowtov = o.appvm[cond.tableidelem].valorjson()[i];
                            result = result & validaterow(o, cond, rowtov, i);
                        }
                        break;
                    case "byatleastonerow":
                        for (i = 0; i < o.appvm[cond.tableidelem].valorjson().length; i++) {
                            rowtov = o.appvm[cond.tableidelem].valorjson()[i];
                            nr = validaterow(o, cond, rowtov, i), result = result || nr;
                        }
                        break;
                }
            }
            return result;
        }
        function validaterow(o, cond, rowv, rownumber) {
            var result = !_.isEmpty(cond.subject), tempres;
            for (var elm in cond.subject) {
                var condel = cond.subject[elm], cellvalue;
                result = !!o.appvm[condel.subject];
                if (condel.subject && o.appvm[condel.subject]) {
                    switch (condel.verb) {
                        case "contains": case "notcontains": case "equals": case "notequals":
                            var comparevalue = "";
                            cellvalue = o.appvm[condel.subject].tipo() === o.TE.RangoFechas ? rowv[condel.subject].valormetadatorango() : rowv[condel.subject].valormetadato();
                            cellvalue = cellvalue === undefined ? "" : cellvalue.toString();
                            switch (condel.predicate.mode) {
                                case "words":
                                    if (o.appvm[condel.subject].tipo() === o.TE.Fecha)
                                        condel.predicate.value = condel.predicate.value.indexOf(o.appvm[condel.subject].separador()) >= 0 ?
                                            dateToUniversal(o, condel.subject, condel.predicate.value) : condel.predicate.value;
                                    comparevalue = condel.predicate.value !== undefined ? condel.predicate.value.toString() : ""; break;
                                case "element":
                                    if (o.appvm[condel.predicate.value]) {
                                        var metdat = _.includes([o.TE.Fecha, o.TE.Lista, o.TE.MarcadoDocumentos], o.appvm[condel.predicate.value].tipo()) ? "valormetadato" : o.appvm[condel.predicate.value].tipo() === o.TE.RangoFechas ? "valormetadatorango" : "valor";
                                        comparevalue = o.appvm[condel.predicate.value][metdat]().toString();
                                    }
                                    break;
                            }
                            if (condel.verb.indexOf("contains") >= 0) {
                                tempres = _.isEmpty(comparevalue) || _.isEmpty(cellvalue) ? false : cellvalue.indexOf(comparevalue) >= 0;
                                tempres = condel.verb.indexOf("not") >= 0 ? !tempres : tempres;
                            } else {
                                tempres = _.isEmpty(comparevalue) || _.isEmpty(cellvalue) ? false : cellvalue === comparevalue;
                                tempres = condel.verb.indexOf("not") >= 0 ? !tempres : tempres;
                            }
                            break;
                        case "empty": case "notempty":
                            cellvalue = rowv[condel.subject].valormetadato();
                            tempres = !cellvalue ? !0 : typeof cellvalue === "number" ? !1 : _.isEmpty(cellvalue);
                            tempres = condel.verb.indexOf("not") >= 0 ? !tempres : tempres;
                            break;
                        case "selected": case "notselected":
                            cellvalue = rowv[condel.subject] ? rowv[condel.subject].valormetadato() : "";
                            tempres = cellvalue === "1" || cellvalue === !0 || cellvalue === "true";
                            tempres = condel.verb.indexOf("not") >= 0 ? !tempres : tempres;
                            break;
                        case "click":
                            tempres = o.appvm[cond.tableidelem].clickedrow() === rownumber + 1 && o.appvm[condel.subject].isclick();
                            break;
                        default: tempres = !1; break;
                    }
                    result = result && tempres;
                }
            }
            rowv.Acciones.exerule && rowv.Acciones.exerule(result);
            return result;
        }
        function resolveConditionByRowTable(o, rn, cat, s, v, p, col) {
            var b = !1, ta, it, fres;
            switch (v) {
                case "contains": case "notcontains":
                    p.value = p.value instanceof Array ? _.map(p.value, function (vel) { return vel.toString(); }) : p.value.toString();
                    if (o.appvm[s].tipo() === o.TE.Lista)
                        ta = o.appvm[s].tipoasociacion(), ta === "idid" || ta === "iddesc" ? b = _.includes(col.valormetadato(), p.value) :
                            ta === "descid" || ta === "descdesc" && (it = _.head(_.filter(o.appvm[s].catalogodestino(), function (n) { return n.Nombre === col.valormetadato(); })),
                                b = it ? _.isEmpty(p.value) ? _.isEmpty(it.Valor) : _.includes(p.value, it.Valor) : _.isEmpty(p.value) ? _.isEmpty(col.valor()) : _.includes(p.value, col.valor()));
                    else b = _.isEmpty(p.value) ? _.isEmpty(col.valor()) : _.includes(col.valor(), p.value);
                    fres = v.indexOf("not") >= 0 ? !b : b;
                    return fres;
                case "empty": case "notempty":
                    if (o.appvm[s].tipo() === o.TE.Lista)
                        ta = o.appvm[s].tipoasociacion(), ta === "idid" || ta === "iddesc" ? b = _.isEmpty(col.valormetadato()) :
                            ta === "descid" || ta === "descdesc" && (it = _.head(_.filter(o.appvm[s].catalogodestino(), function (n) { return n.Nombre === col.valormetadato(); })),
                                b = it ? _.isEmpty(it.Valor) : _.isEmpty(col.valor()));
                    else b = _.isEmpty(col.valor());
                    fres = v.indexOf("not") >= 0 ? !b : b;
                    return fres;
                case "selected": case "notselected":
                    fres = v.indexOf("not") >= 0 ? !b : b;
                    return fres;
            }
            return !1;
        }
        function removeRuleType(r, row, s, type) {
            var o = getOpts(), c = r + '_' + row, rrr = r + '_' + row + '_' + s;
            type === "condi" && _.size(o.appvm[o.idPlantilla].reglas()[r].conditions) > 1 &&
                (delete o.appvm[o.idPlantilla].reglas()[r].conditions[row], o.configModal.find(".rowcondition" + c).remove()),
                type === "acti" && _.size(o.appvm[o.idPlantilla].reglas()[r].actions) > 1 &&
                (delete o.appvm[o.idPlantilla].reglas()[r].actions[row], o.configModal.find(".rowaction" + c).remove()),
                type === "consubj" && _.size(o.appvm[o.idPlantilla].reglas()[r].conditions[row].subject) > 1 &&
                (delete o.appvm[o.idPlantilla].reglas()[r].conditions[row].subject[s],
                    o.configModal.find(".divcondsubj" + rrr).parent().remove());
            var size = _.size(o.appvm[o.idPlantilla].reglas()[r].actions);
            reorderActionAngles(o, r);
            o.configModal.find(".bodyrule" + r + " .removecondition,.bodyrule" + r + " .removeaction i").removeAttr("hidden"),
                _.size(o.appvm[o.idPlantilla].reglas()[r].conditions) === 1 && o.configModal.find(".bodyrule" + r + " .removecondition").hide(),
                size === 1 && o.configModal.find(".bodyrule" + r + " .removeaction i").attr("hidden", ""),
                s.length && (o.configModal.find(".conditiontablerow" + c + " .removesubjectcon").show(),
                    _.size(o.appvm[o.idPlantilla].reglas()[r].conditions[row].subject) === 1 && o.configModal.find(".conditiontablerow" + c + " .removesubjectcon").hide()), updateOpts(o, !0);
        }



        //Configurador genérico: componentes
        function executeComponentRequest(o, oriObj, ckey) {
            var t, loadSDKScript = (src, onloadMSG, errorMSG) => {
                let script = document.createElement('script');
                script.setAttribute('src', src);
                script.setAttribute('type', 'application/javascript');
                script.addEventListener('load', () => { onloadMSG(); });
                script.addEventListener('error', () => toasty("Error al cargar la libreria", errorMSG));
                document.head.appendChild(script);
            };
            console.log("Ejecutando componente " + oriObj.customname + " " + moment().format("DD-MM-YYYY HH:mm:ss.SSS"));
            switch (oriObj.id) {
                //Encriptar
                case 1:
                    var tenc = "";
                    o.appvm[oriObj.pin["order_1"].idelem] && (t = o.appvm[oriObj.pin["order_1"].idelem].valor());
                    switch (oriObj.pin["order_2"].value) {
                        case "SHA512": tenc = CryptoJS.SHA512(t).toString(CryptoJS.enc.Base64); break;
                    }
                    o.appvm[oriObj.pout["order_1"].idelem] && o.appvm[oriObj.pout["order_1"].idelem].valor(tenc);
                    break;
                //Datos CURP
                case 8:
                    o.appvm[oriObj.pin["order_1"].idelem] && o.appvm[oriObj.pin["order_1"].idelem].valor && (t = o.appvm[oriObj.pin["order_1"].idelem].valor());
                    if (t) {
                        if (!_.isEmpty(t.match(/^[A-Z]{4}[0-9]{2}(0[1-9]|1[0-2])(0[0-9]|[1-2][0-9]|3[0-1])(M|H)[A-Z]{5}([0-9]|[A-Z])[0-9]{1}$/g))) {
                            var fechanacimiento, genero, entidad, homoclave;
                            fechanacimiento = t.match(/[0-9]{2}(0[1-9]|1[0-2])(0[0-9]|[1-2][0-9]|3[0-1])/g), genero = t.substr(10, 1), entidad = t.substr(11, 2), homoclave = t.match(/([0-9]|[A-Z])[0-9]{1}$/g);
                            homoclave = _.isEmpty(homoclave) ? "" : homoclave[0], fechanacimiento = _.isEmpty(fechanacimiento) ? "" : fechanacimiento[0];
                            var curpdata = {
                                order_1: fechanacimiento, order_2: genero, order_3: entidad, order_4: homoclave
                            };
                            for (var ord in oriObj.pout) {
                                if (curpdata[ord] && o.appvm[oriObj.pout[ord].idelem]) {
                                    if (o.appvm[oriObj.pout[ord].idelem].tipo() === o.TE.Fecha) {
                                        var formatdate = (_.isNumber(t.substr(16, 1)) || Number(t.substr(16, 1)) === 0 ? "19" : "20") + curpdata[ord].substr(0, 2) + curpdata[ord].substr(2, 2) + curpdata[ord].substr(4, 2);
                                        o.appvm[oriObj.pout[ord].idelem].valor(formatdate);
                                    }
                                    else if (o.appvm[oriObj.pout[ord].idelem].tipo() === o.TE.Lista) {
                                        var chos = _.find(o.datatags.allitemscatalogs["catalogos|" + o.appvm[oriObj.pout[ord].idelem].catalogoorigen()], function (elm) {
                                            return elm.CveCatalogo === curpdata[ord];
                                        });
                                        if (chos)
                                            if (o.appvm[oriObj.pout[ord].idelem].tipolista() === "combo") o.appvm[oriObj.pout[ord].idelem].optionselectedRule(chos.Valor);
                                            else o.appvm[oriObj.pout[ord].idelem].chosenitemsRule(chos);
                                        else
                                            if (o.appvm[oriObj.pout[ord].idelem].tipolista() === "combo") o.appvm[oriObj.pout[ord].idelem].optionselectedRule("");
                                            else o.appvm[oriObj.pout[ord].idelem].chosenitemsRule([]);
                                    }
                                    else if (o.appvm[oriObj.pout[ord].idelem].valor) o.appvm[oriObj.pout[ord].idelem].valor(curpdata[ord]);
                                }
                            }
                        }
                        else toasty("", "CURP no v&aacutelida", "error");
                    }
                    else toasty("", "CURP vac&iacute;a", "error");
                    break;
                //Datos RFC
                case 9:
                    o.appvm[oriObj.pin["order_1"].idelem] && o.appvm[oriObj.pin["order_1"].idelem].valor && (t = o.appvm[oriObj.pin["order_1"].idelem].valor());
                    if (t) {
                        if (!_.isEmpty(t.match(/^[A-Z]{4}[0-9]{2}(0[1-9]|1[0-2])(0[0-9]|[1-2][0-9]|3[0-1])[A-Z0-9]{3}$/g))) {
                            var fechanacimientorfc, homoclaverfc;
                            fechanacimientorfc = t.match(/[0-9]{2}(0[1-9]|1[0-2])(0[0-9]|[1-2][0-9]|3[0-1])/g), homoclaverfc = t.match(/[A-Z0-9]{3}$/g);
                            homoclaverfc = _.isEmpty(homoclaverfc) ? "" : homoclaverfc[0], fechanacimientorfc = _.isEmpty(fechanacimientorfc) ? "" : fechanacimientorfc[0];
                            var rfcdata = { order_1: fechanacimientorfc, order_2: homoclaverfc };
                            for (var ordr in oriObj.pout) {
                                if (rfcdata[ordr] && o.appvm[oriObj.pout[ordr].idelem]) {
                                    if (o.appvm[oriObj.pout[ordr].idelem].tipo() === o.TE.Fecha) {
                                        var formatdater = (_.isNumber(rfcdata[ordr].substr(17, 1)) ? "20" : "19") + rfcdata[ordr].substr(0, 2) + rfcdata[ordr].substr(2, 2) + rfcdata[ordr].substr(4, 2);
                                        o.appvm[oriObj.pout[ordr].idelem].valor(formatdater);
                                    }
                                    else if (o.appvm[oriObj.pout[ordr].idelem].valor) o.appvm[oriObj.pout[ordr].idelem].valor(rfcdata[ordr]);
                                }
                            }
                        }
                        else toasty("", "RFC no v&aacutelida", "error");
                    }
                    else toasty("", "RFC vac&iacute;a", "error");
                    break;
                //Marcar documentos
                case 10:
                    if (oriObj.pin["order_1"] && oriObj.pout["order_1"]) {
                        if (oriObj.pin["order_1"].idelem && oriObj.pout["order_1"].idelem && o.appvm[oriObj.pin["order_1"].idelem] && o.appvm[oriObj.pout["order_1"].idelem]) {
                            var doc = o.appvm[oriObj.pin["order_1"].idelem], lst = o.appvm[oriObj.pout["order_1"].idelem], guidanex = [], anexdoc, selitems = [];
                            if (lst.tipolista() === "checkbox") {
                                guidanex = _.map(doc.anexo(), function (an) { return an.guidanexo; });
                                anexdoc = _.filter(_.keys(doc.tipodocjson()), function (dc) { return _.includes(guidanex, dc); });
                                _.forEach(anexdoc, function (andoc) {
                                    var selit = _.find(o.datatags[lst.fuentedatos() + "|" + lst.catalogoorigen()], { Valor: doc.tipodocjson()[andoc] });
                                    selit && selitems.push(selit);
                                });
                                lst.chosenitemsRule(selitems);
                            }
                            else toasty('', 'Tipo de lista no válido.', 'error');
                        }
                    }
                    break;
                //Relación filas de tablas con tipo de documento
                case 11:
                    if (oriObj.pin["order_1"] && oriObj.pin["order_2"] && oriObj.pin["order_2"].idelem && o.appvm[oriObj.pin["order_2"].idelem] && o.appvm[oriObj.pin["order_2"].idelem].tipo() === o.TE.Documento) {
                        var relatedtabs = oriObj.pin["order_1"].value.split(","), totaldocs = {}, docelem = o.appvm[oriObj.pin["order_2"].idelem],
                            typallowed = docelem.tipificacionpermitida();
                        _.forEach(relatedtabs, function (elm) {
                            var datal = elm.split(":");
                            if (o.appvm[datal[1]] && o.appvm[datal[1]].valorjson && !!datal[0].toString())
                                totaldocs["tipodoc_" + datal[0]] = totaldocs["tipodoc_" + datal[0]] ?
                                    parseFloat(totaldocs["tipodoc_" + datal[0]]) + o.appvm[datal[1]].valorjson().length
                                    : o.appvm[datal[1]].valorjson().length;
                        });
                        typallowed = typallowed || {};
                        _.forEach(_.keys(totaldocs), function (elm) {
                            !typallowed[elm] && (typallowed[elm] = {});
                            typallowed[elm].min = totaldocs[elm], typallowed[elm].max = totaldocs[elm], typallowed[elm].enabled = !0;
                        });
                        docelem.tipificacionpermitida(typallowed);
                    }
                    break;
                //Aumentar/disminuir fecha
                case 14:
                    var fecha;
                    o.appvm[oriObj.pin["order_1"].idelem] && (fecha = o.appvm[oriObj.pin["order_1"].idelem].valor());
                    if (fecha) {
                        fecha = dateToUniversal(o, oriObj.pin["order_1"].idelem, fecha);
                        fecha = fecha.length > 7 ? new Date(fecha.substr(0, 4), fecha.substr(4, 2) - 1, fecha.substr(6, 2))
                            : new Date(fecha.substr(0, 2), fecha.substr(2, 2) - 1, fecha.substr(4, 2));
                        if (oriObj.pin["order_2"].value === "aum") { //aumentar
                            if (oriObj.pin["order_3"].value) //años
                                fecha = new Date(fecha.setFullYear(fecha.getFullYear() + oriObj.pin["order_3"].value));
                            if (oriObj.pin["order_4"].value) //meses
                                fecha = new Date(fecha.setMonth(fecha.getMonth() + oriObj.pin["order_4"].value));
                            if (oriObj.pin["order_5"].value) //días
                                fecha = new Date(fecha.setDate(fecha.getDate() + oriObj.pin["order_5"].value));
                        }
                        else { //disminuir
                            if (oriObj.pin["order_3"].value) //años
                                fecha = new Date(fecha.setFullYear(fecha.getFullYear() - oriObj.pin["order_3"].value));
                            if (oriObj.pin["order_4"].value) //meses
                                fecha = new Date(fecha.setMonth(fecha.getMonth() - oriObj.pin["order_4"].value));
                            if (oriObj.pin["order_5"].value) //días
                                fecha = new Date(fecha.setDate(fecha.getDate() - oriObj.pin["order_5"].value));
                        }
                        if (o.appvm[oriObj.pout["order_1"].idelem]) {
                            fecha = fecha.getFullYear().toString() + ("0" + (fecha.getMonth() + 1)).slice(-2).toString() + ("0" + fecha.getDate()).slice(-2);
                            o.appvm[oriObj.pout["order_1"].idelem].valor(fecha);
                        }
                    }
                    break;
                //Validación de CURP
                case 15:
                    var curpToValidate = "", curpIsValid = 0, componentCompare = _.find(o.datatags.componentsList, { id: oriObj.id }),
                        compareNumber = 7, secondNameIsRequired = !0, curpInappropiate = !1;

                    o.appvm[oriObj.pin["order_8"].idelem] && (curpToValidate = o.appvm[oriObj.pin["order_8"].idelem].valor().toUpperCase());
                    if (componentCompare) {
                        if (curpToValidate && curpToValidate.length === 18) {
                            curpInappropiate = _.includes(["BACA", "BAKA", "BUEI", "BUEY", "CACA", "CACO", "CAGA", "CAGO", "CAKA", "CAKO", "COGE", "COGI", "COJA",
                                "COJE", "COJI", "COJO", "COLA", "CULO", "FALO", "FETO", "GETA", "GUEI", "GUEY", "JETA", "JOTO", "KACA", "KACO",
                                "KAGA", "KAGO", "KAKA", "KAKO", "KOGE", "KOGI", "KOJA", "KOJE", "KOJI", "KOJO", "KOLA", "KULO", "LILO", "LOCA",
                                "LOCO", "LOKA", "LOKO", "MAME", "MAMO", "MEAR", "MEAS", "MEON", "MIAR", "MION", "MOCO", "MOKO", "MULA", "MULO",
                                "NACA", "NACO", "PEDA", "PEDO", "PENE", "PIPI", "PITO", "POPO", "PUTA", "PUTO", "QULO", "RATA", "ROBA", "ROBE",
                                "ROBO", "RUIN", "SENO", "TETA", "VACA", "VAGA", "VAGO", "VAKA", "VUEI", "VUEY", "WUEI", "WUEY"], curpToValidate.substring(0, 4).toUpperCase());
                            if (!curpInappropiate) {
                                for (var i = 1; i < 8; i++) {
                                    var currcomp = componentCompare.pin.method[i - 1];
                                    if (o.appvm[oriObj.pin["order_" + i].idelem]) {
                                        if (i === 4 || i === 2 || o.appvm[oriObj.pin["order_" + i].idelem].valor()) {
                                            var orderIsValid = !1, currstr = o.appvm[oriObj.pin["order_" + i].idelem].valor().toUpperCase(), currStrNoPre = "";
                                            switch (i) {
                                                case 1: //Primer nombre (4: primer letra, 16: primer consonante interna)
                                                    currStrNoPre = currstr.replace(/Ñ/g, 'X').replace(/[\/\-\.]/g, 'X').replace(/[ÄÁ]/g, 'A').replace(/[ËÉ]/g, 'E')
                                                        .replace(/[ÏÍ]/g, 'I').replace(/[ÖÓ]/g, 'O').replace(/[ÜÚ]/g, 'U');
                                                    currstr = "";
                                                    _.forEach(currStrNoPre.split(' '), function (splitstr) {
                                                        currstr += splitstr.match(/^(DA|DAS|DE|DEL|DER|DI|DIE|DD|EL|LA|LOS|LAS|LE|LES|MAC|MC|VAN|VON|Y|\s)$/) ? "" : splitstr + " ";
                                                    });
                                                    currstr = currstr.split(/\s/g)[0];

                                                    secondNameIsRequired = _.includes(["MARIA", "MA", "MAX", "JOSE", "J", "JX"], currstr);
                                                    orderIsValid = !_.includes(["MARIA", "MA", "MAX", "JOSE", "J", "JX"], currstr) ? currstr[0] === curpToValidate[3] &&
                                                        (currstr.length > 2 ? currstr.substr(1, currstr.length - 1).match(/[BCDFGHJKLMNPQRSTVWXYZ]/)
                                                            ? currstr.substr(1, currstr.length - 1).match(/[BCDFGHJKLMNPQRSTVWXYZ]/)[0] === curpToValidate[15]
                                                            : "X" === curpToValidate[15] : !1) : !0;
                                                    break;
                                                case 2: //Segundo nombre (4: primer letra, 16: primer consonante interna)
                                                    currStrNoPre = currstr.replace(/Ñ/g, 'X').replace(/[\/\-\.]/g, 'X').replace(/[ÄÁ]/g, 'A').replace(/[ËÉ]/g, 'E')
                                                        .replace(/[ÏÍ]/g, 'I').replace(/[ÖÓ]/g, 'O').replace(/[ÜÚ]/g, 'U');
                                                    currstr = "";
                                                    _.forEach(currStrNoPre.split(' '), function (splitstr) {
                                                        currstr += splitstr.match(/^(DA|DAS|DE|DEL|DER|DI|DIE|DD|EL|LA|LOS|LAS|LE|LES|MAC|MC|VAN|VON|Y|\s)$/) ? "" : splitstr + " ";
                                                    });
                                                    currstr = currstr.split(/\s/g)[0];

                                                    orderIsValid = secondNameIsRequired ?
                                                        currstr[0] === curpToValidate[3] &&
                                                        (currstr.length > 2 ? currstr.substr(1, currstr.length - 1).match(/[BCDFGHJKLMNPQRSTVWXYZ]/)
                                                            ? currstr.substr(1, currstr.length - 1).match(/[BCDFGHJKLMNPQRSTVWXYZ]/)[0] === curpToValidate[15]
                                                            : "X" === curpToValidate[15] : !1) : !0;
                                                    break;
                                                case 3: //Primer apellido (1: letra inicial, 2: primer vocal interna, 14: primer consonante interna)
                                                    currStrNoPre = currstr.replace(/Ñ/g, 'X').replace(/[\/\-\.]/g, 'X').replace(/[ÄÁ]/g, 'A').replace(/[ËÉ]/g, 'E')
                                                        .replace(/[ÏÍ]/g, 'I').replace(/[ÖÓ]/g, 'O').replace(/[ÜÚ]/g, 'U');
                                                    currstr = "";
                                                    _.forEach(currStrNoPre.split(' '), function (splitstr) {
                                                        currstr += splitstr.match(/^(DA|DAS|DE|DEL|DER|DI|DIE|DD|EL|LA|LOS|LAS|LE|LES|MAC|MC|VAN|VON|Y|\s)$/) ? "" : splitstr + " ";
                                                    });
                                                    currstr = currstr.split(/\s/g)[0];

                                                    var constint = currstr.substr(1, currstr.length - 1).match(/[AEIOU]/) ? currstr.substr(1, currstr.length - 1).match(/[AEIOU]/)[0] : "X",
                                                        nombre = oriObj.pin["order_" + 1] && o.appvm[oriObj.pin["order_" + 1].idelem] ? o.appvm[oriObj.pin["order_" + 1].idelem].valor() : "",
                                                        segap = oriObj.pin["order_" + 4] && o.appvm[oriObj.pin["order_" + 4].idelem] ? o.appvm[oriObj.pin["order_" + 4].idelem].valor() : "",
                                                        curpPri = "";
                                                    !!currstr && !!nombre && segap && (curpPri = currstr[0] + constint + segap[0] + nombre[0]);
                                                    _.includes(["BACA", "BAKA", "BUEI", "BUEY", "CACA", "CACO", "CAGA", "CAGO", "CAKA", "CAKO", "COGE", "COGI", "COJA",
                                                        "COJE", "COJI", "COJO", "COLA", "CULO", "FALO", "FETO", "GETA", "GUEI", "GUEY", "JETA", "JOTO", "KACA", "KACO",
                                                        "KAGA", "KAGO", "KAKA", "KAKO", "KOGE", "KOGI", "KOJA", "KOJE", "KOJI", "KOJO", "KOLA", "KULO", "LILO", "LOCA",
                                                        "LOCO", "LOKA", "LOKO", "MAME", "MAMO", "MEAR", "MEAS", "MEON", "MIAR", "MION", "MOCO", "MOKO", "MULA", "MULO",
                                                        "NACA", "NACO", "PEDA", "PEDO", "PENE", "PIPI", "PITO", "POPO", "PUTA", "PUTO", "QULO", "RATA", "ROBA", "ROBE",
                                                        "ROBO", "RUIN", "SENO", "TETA", "VACA", "VAGA", "VAGO", "VAKA", "VUEI", "VUEY", "WUEI", "WUEY"], curpPri.toUpperCase())
                                                        && (constint = "X");
                                                    orderIsValid = currstr[0] === curpToValidate[0] && currstr.length > 2 ?
                                                        constint === curpToValidate[1] && (currstr.substr(1, currstr.length - 1).match(/[BCDFGHJKLMNPQRSTVWXYZ]/)
                                                            ? currstr.substr(1, currstr.length - 1).match(/[BCDFGHJKLMNPQRSTVWXYZ]/)[0] === curpToValidate[13]
                                                            : "X" === curpToValidate[13]) : !1;
                                                    break;
                                                case 4: //Segundo apellido (3: letra inicial, 15: primer consonante interna)
                                                    if (!currstr)
                                                        orderIsValid = "X" === curpToValidate[2] && "X" === curpToValidate[14];
                                                    else {
                                                        currStrNoPre = currstr.replace(/Ñ/g, 'X').replace(/[\/\-\.]/g, 'X').replace(/[ÄÁ]/g, 'A').replace(/[ËÉ]/g, 'E')
                                                            .replace(/[ÏÍ]/g, 'I').replace(/[ÖÓ]/g, 'O').replace(/[ÜÚ]/g, 'U');
                                                        currstr = "";
                                                        _.forEach(currStrNoPre.split(' '), function (splitstr) {
                                                            currstr += splitstr.match(/^(DA|DAS|DE|DEL|DER|DI|DIE|DD|EL|LA|LOS|LAS|LE|LES|MAC|MC|VAN|VON|Y|\s)$/) ? "" : splitstr + " ";
                                                        });
                                                        currstr = currstr.split(/\s/g)[0];

                                                        orderIsValid = currstr[0] === curpToValidate[2] &&
                                                            (currstr.length > 2 ? currstr.substr(1, currstr.length - 1).match(/[BCDFGHJKLMNPQRSTVWXYZ]/)
                                                                ? currstr.substr(1, currstr.length - 1).match(/[BCDFGHJKLMNPQRSTVWXYZ]/)[0] === curpToValidate[14]
                                                                : "X" === curpToValidate[14] : !1);
                                                    }
                                                    break;
                                                case 5: //Fecha de nacimiento (5-10: fecha en orden yymmdd, 17: homonimía y siglo)
                                                    var birthDate = dateToUniversal(o, oriObj.pin["order_" + i].idelem, currstr);
                                                    orderIsValid = birthDate.length === 6 ? birthDate === curpToValidate.substr(4, 6)
                                                        : birthDate.substr(2, birthDate.length - 2) === curpToValidate.substr(4, 6)
                                                        && Number(birthDate.substr(0, 4)) < 2000 && !!curpToValidate[16].match(/[0-9]/) ||
                                                        Number(birthDate.substr(0, 4)) >= 2000 && !!curpToValidate[16].match(/[A-Z]/);
                                                    break;
                                                case 6: //Género (11: letra)
                                                    currstr = o.appvm[oriObj.pin["order_" + i].idelem].tipo() === o.TE.Lista ?
                                                        o.appvm[oriObj.pin["order_" + i].idelem].chosenitems() ? Array.isArray(o.appvm[oriObj.pin["order_" + i].idelem].chosenitems()) ?
                                                            !!o.appvm[oriObj.pin["order_" + i].idelem].chosenitems()[0] : o.appvm[oriObj.pin["order_" + i].idelem].chosenitems() : "" : currstr;
                                                    currstr = typeof currstr === "string" ? currstr : _.includes(["FEMENINO", "MUJER", "M"], currstr.Descripcion.toUpperCase()) ? "M" : "H";
                                                    orderIsValid = currstr === curpToValidate[10];
                                                    break;
                                                case 7: //Estado de nacimiento (12:letra inicial, 13: última consonante)
                                                    currstr = o.appvm[oriObj.pin["order_" + i].idelem].tipo() === o.TE.Lista ?
                                                        o.appvm[oriObj.pin["order_" + i].idelem].chosenitems() ? Array.isArray(o.appvm[oriObj.pin["order_" + i].idelem].chosenitems()) ?
                                                            !!o.appvm[oriObj.pin["order_" + i].idelem].chosenitems()[0] : o.appvm[oriObj.pin["order_" + i].idelem].chosenitems() : "" : currstr;
                                                    currstr = typeof currstr === "string" ? currstr : currstr.Descripcion.toUpperCase();
                                                    var estacurr = "";
                                                    switch (currstr) {
                                                        case "AGUASCALIENTES": estacurr = "AS"; break;
                                                        case "BAJA CALIFORNIA": estacurr = "BC"; break;
                                                        case "BAJA CALIFORNIA SUR": estacurr = "BS"; break;
                                                        case "CAMPECHE": estacurr = "CC"; break;
                                                        case "COAHUILA": estacurr = "CL"; break;
                                                        case "COLIMA": estacurr = "CM"; break;
                                                        case "CHIAPAS": estacurr = "CS"; break;
                                                        case "CHIHUAHUA": estacurr = "CH"; break;
                                                        case "DISTRITO FEDERAL": case "CIUDAD DE MÉXICO": estacurr = "DF"; break;
                                                        case "DURANGO": estacurr = "DG"; break;
                                                        case "GUANAJUATO": estacurr = "GT"; break;
                                                        case "GUERRERO": estacurr = "GR"; break;
                                                        case "HIDALGO": estacurr = "HG"; break;
                                                        case "JALISCO": estacurr = "JC"; break;
                                                        case "ESTADO DE MÉXICO": estacurr = "MC"; break;
                                                        case "MICHOACÁN": estacurr = "MN"; break;
                                                        case "MORELOS": estacurr = "MS"; break;
                                                        case "NAYARIT": estacurr = "NT"; break;
                                                        case "NUEVO LEÓN": estacurr = "NL"; break;
                                                        case "OAXACA": estacurr = "OC"; break;
                                                        case "PUEBLA": estacurr = "PL"; break;
                                                        case "QUERÉTARO": estacurr = "QT"; break;
                                                        case "QUINTANA ROO": estacurr = "QR"; break;
                                                        case "SAN LUIS POTOSI": estacurr = "SP"; break;
                                                        case "SINALOA": estacurr = "SL"; break;
                                                        case "SONORA": estacurr = "SR"; break;
                                                        case "TABASCO": estacurr = "TC"; break;
                                                        case "TAMAULIPAS": estacurr = "TS"; break;
                                                        case "TLAXCALA": estacurr = "TL"; break;
                                                        case "VERACRUZ": estacurr = "VZ"; break;
                                                        case "YUCATÁN": estacurr = "YN"; break;
                                                        case "ZACATECAS": estacurr = "ZS"; break;
                                                        default: estacurr = "NE"; break;
                                                    }
                                                    orderIsValid = estacurr === curpToValidate.substr(11, 2);
                                                    break;
                                            }
                                            if (!orderIsValid)
                                                o.appvm[oriObj.pin["order_" + i].idelem].haserror(!0), curpIsValid--,
                                                    o.appvm[oriObj.pin["order_" + i].idelem].validationerror("No es congruente con la CURP ingresada.");
                                            else
                                                o.appvm[oriObj.pin["order_" + i].idelem].haserror(!1), o.appvm[oriObj.pin["order_" + i].idelem].validationerror(""),
                                                    curpIsValid++;
                                        }
                                        else {
                                            o.appvm[oriObj.pin["order_" + i].idelem].haserror(!0),
                                                o.appvm[oriObj.pin["order_" + i].idelem].validationerror('El campo ' + currcomp.name + ' es requerido para la validaci&oacute;n.');
                                        }
                                    }
                                    else toasty('', 'No existe ' + currcomp.name + ' con cual comparar la CURP.', 'error');
                                }
                            }
                            else
                                o.appvm[oriObj.pin["order_8"].idelem].haserror(!0), o.appvm[oriObj.pin["order_8"].idelem].validationerror("La CURP no puede llevar palabras altisonantes.");
                        }
                        else toasty('', 'No existe CURP correcta con cual validar.', 'error');
                        o.appvm[oriObj.pout["order_1"].idelem] && o.appvm[oriObj.pout["order_1"].idelem].valor && o.appvm[oriObj.pout["order_1"].idelem].valor(curpIsValid === compareNumber);
                    }
                    else toasty('', 'No existe el componente', 'error');
                    break;
                //Convertir de base64 a archivo
                case 16:
                    var nomb = "archivotemp", typ = "", ext = "";
                    o.appvm[oriObj.pin["order_1"].idelem] && (t = o.appvm[oriObj.pin["order_1"].idelem].valor());
                    o.appvm[oriObj.pin["order_3"].idelem] && (nomb = o.appvm[oriObj.pin["order_3"].idelem].valor());
                    switch (oriObj.pin["order_2"].value.replace(".", "").toLowerCase()) {
                        case "pdf": typ = "application/pdf", ext = ".pdf"; break;
                        case "xlsx": typ = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", ext = ".xlsx"; break;
                        case "xls": typ = "application/vnd.ms-excel", ext = ".xls"; break;
                        default: typ = "text/plain", ext = ".txt"; break;
                    }
                    if (_.isEmpty(t)) { toasty("No hay archivo para descargar"); return; }
                    var byteCharacters = atob(t), byteArrays = [], sliceSize = 512;
                    for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                        var slice = byteCharacters.slice(offset, offset + sliceSize), byteNumbers = new Array(slice.length);
                        for (var i1 = 0; i1 < slice.length; i1++) byteNumbers[i1] = slice.charCodeAt(i1);
                        var byteArray = new Uint8Array(byteNumbers);
                        byteArrays.push(byteArray);
                    }
                    var blobdata = new Blob(byteArrays, { type: typ });
                    var titulo = (_.isEmpty(nomb) ? "archivotemp" : nomb) + ext;
                    if (window.navigator.msSaveOrOpenBlob) window.navigator.msSaveOrOpenBlob(blobdata, titulo);
                    else {
                        var elem = window.document.createElement("a");
                        elem.href = window.URL.createObjectURL(blobdata);
                        elem.download = titulo;
                        document.body.appendChild(elem), elem.click(), document.body.removeChild(elem);
                    }
                    break;
                //Descomponer fecha
                case 17:
                    if (oriObj.pin["order_1"].idelem && o.appvm[oriObj.pin["order_1"].idelem] && !!o.appvm[oriObj.pin["order_1"].idelem].valor()) {
                        var valDia = "", valMes = "", valAnio = "", fechaAct = dateToUniversal(o, oriObj.pin["order_1"].idelem, o.appvm[oriObj.pin["order_1"].idelem].valor());
                        fechaAct.length === 6 && (fechaAct = "00" + fechaAct);
                        if (oriObj.pout["order_1"].idelem && o.appvm[oriObj.pout["order_1"].idelem]) { //Día
                            switch (oriObj.pin["order_2"].value) {
                                case "dd": valDia = fechaAct.substr(6, 2); break; //con cero
                                case "d": valDia = Number(fechaAct.substr(6, 2)); break; //sin cero
                            }
                            o.appvm[oriObj.pout["order_1"].idelem].valor(valDia);
                        }

                        if (oriObj.pout["order_2"].idelem && o.appvm[oriObj.pout["order_2"].idelem]) { //Mes
                            var meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                            var mesesAb = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
                            switch (oriObj.pin["order_3"].value) {
                                case "mm": valMes = fechaAct.substr(4, 2); break; //con cero
                                case "m": valMes = Number(fechaAct.substr(4, 2)); break; //sin cero
                                case "ss": valMes = meses[Number(fechaAct.substr(4, 2)) - 1]; break; //con letras
                                case "s": valMes = mesesAb[Number(fechaAct.substr(4, 2)) - 1]; break; //abreviado
                            }
                            o.appvm[oriObj.pout["order_2"].idelem].valor(valMes);
                        }

                        if (oriObj.pout["order_3"].idelem && o.appvm[oriObj.pout["order_3"].idelem]) { //Año
                            switch (oriObj.pin["order_4"].value) {
                                case "yy": valAnio = fechaAct.substr(0, 4); break; //cuatro dígitos
                                case "y": valAnio = fechaAct.substr(2, 2); break; //dos dígitos
                            }
                            o.appvm[oriObj.pout["order_3"].idelem].valor(valAnio);
                        }
                    }
                    else toasty('', 'Es necesario seleccionar una fecha');
                    break;
                //NetPay
                case 21:
                    var monto = "", montoreal = 0, desc = "", nombre2 = "", apellido = "", email = "", tel = "", ciudad = "", cp = "", estado = "", calle = "", folio = "",
                        trans = "", date = "";
                    oriObj.pin["order_1"].idelem && o.appvm[oriObj.pin["order_1"].idelem] && (monto = o.appvm[oriObj.pin["order_1"].idelem].valor());
                    oriObj.pin["order_1"].idelem && o.appvm[oriObj.pin["order_1"].idelem] && (montoreal = o.appvm[oriObj.pin["order_1"].idelem].valormetadato());
                    oriObj.pin["order_2"].idelem && o.appvm[oriObj.pin["order_2"].idelem] && (desc = o.appvm[oriObj.pin["order_2"].idelem].valor());
                    oriObj.pin["order_3"].idelem && o.appvm[oriObj.pin["order_3"].idelem] && (nombre2 = o.appvm[oriObj.pin["order_3"].idelem].valor());
                    oriObj.pin["order_4"].idelem && o.appvm[oriObj.pin["order_4"].idelem] && (apellido = o.appvm[oriObj.pin["order_4"].idelem].valor());
                    oriObj.pin["order_5"].idelem && o.appvm[oriObj.pin["order_5"].idelem] && (email = o.appvm[oriObj.pin["order_5"].idelem].valor());
                    oriObj.pin["order_6"].idelem && o.appvm[oriObj.pin["order_6"].idelem] && (tel = o.appvm[oriObj.pin["order_6"].idelem].valor());
                    oriObj.pin["order_7"].idelem && o.appvm[oriObj.pin["order_7"].idelem] && (ciudad = o.appvm[oriObj.pin["order_7"].idelem].valor());
                    oriObj.pin["order_8"].idelem && o.appvm[oriObj.pin["order_8"].idelem] && (cp = o.appvm[oriObj.pin["order_8"].idelem].valor());
                    oriObj.pin["order_9"].idelem && o.appvm[oriObj.pin["order_9"].idelem] && (estado = o.appvm[oriObj.pin["order_9"].idelem].valor());
                    oriObj.pin["order_10"].idelem && o.appvm[oriObj.pin["order_10"].idelem] && (calle = o.appvm[oriObj.pin["order_10"].idelem].valor());
                    oriObj.pin["order_11"].idelem && o.appvm[oriObj.pin["order_11"].idelem] && (folio = o.appvm[oriObj.pin["order_11"].idelem].valor());
                    var netpaypaso1 = $('<div class="modal">\
                        <div class="modal-dialog">\
                            <div class="modal-content rounded">\
                                <div class="modal-body no-padding row">\
                                    <div class="col-md-12 col-sm-12">\
                                        <h5 class="col-12 py-2 px-0 border-bottom">Paso 1</h5>\
                                        <div class="mx-auto" style="width: 300px; max-width: 100%;">\
                                            <h5 class="col-12 py-2 px-0 border-bottom">Resumen</h5>\
                                            <div class="row mb-2">\
                                                <label class="col-sm-4 col-form-label col-form-label-sm">Nombre</label>\
                                                <div class="col-sm-8" style="font-size: 1.3rem;">\
                                                    <p class="mt-1 mb-0">'+ nombre2 + '</p>\
                                                </div>\
                                            </div>\
                                            <div class="row mb-2">\
                                                <label class="col-sm-4 col-form-label col-form-label-sm">Apellido(s)</label>\
                                                <div class="col-sm-8" style="font-size: 1.3rem;">\
                                                    <p class="mt-1 mb-0">'+ apellido + '</p>\
                                                </div>\
                                            </div>\
                                            <div class="row mb-2">\
                                                <label class="col-sm-4 col-form-label col-form-label-sm">Calle</label>\
                                                <div class="col-sm-8" style="font-size: 1.3rem;">\
                                                    <p class="mt-1 mb-0">'+ calle + '</p>\
                                                </div>\
                                            </div>\
                                            <div class="row mb-2">\
                                                <label class="col-sm-4 col-form-label col-form-label-sm">Codigo Postal</label>\
                                                <div class="col-sm-8" style="font-size: 1.3rem;">\
                                                    <p class="mt-1 mb-0">'+ cp + '</p>\
                                                </div>\
                                            </div>\
                                            <div class="row mb-2">\
                                                <label class="col-sm-4 col-form-label col-form-label-sm">Ciudad</label>\
                                                <div class="col-sm-8" style="font-size: 1.3rem;">\
                                                    <p class="mt-1 mb-0">'+ ciudad + '</p>\
                                                </div>\
                                            </div>\
                                            <div class="row mb-2">\
                                                <label class="col-sm-4 col-form-label col-form-label-sm">Estado</label>\
                                                <div class="col-sm-8" style="font-size: 1.3rem;">\
                                                    <p class="mt-1 mb-0">'+ estado + '</p>\
                                                </div>\
                                            </div>\
                                            <div class="row mb-2">\
                                                <label class="col-sm-4 col-form-label col-form-label-sm">Correo electrónico</label>\
                                                <div class="col-sm-8" style="font-size: 1.3rem;">\
                                                    <p class="mt-1 mb-0">'+ email + '</p>\
                                                </div>\
                                            </div>\
                                            <div class="row mb-2">\
                                                <label class="col-sm-4 col-form-label col-form-label-sm">Teléfono</label>\
                                                <div class="col-sm-8" style="font-size: 1.3rem;">\
                                                    <p class="mt-1 mb-0">'+ tel + '</p>\
                                                </div>\
                                            </div>\
                                            <div class="row mb-2">\
                                                <label class="col-sm-4 col-form-label col-form-label-sm">Monto a cobrar</label>\
                                                <div class="col-sm-8" style="font-size: 1.3rem;">\
                                                    <p class="mt-1 mb-0">'+ monto + '</p>\
                                                </div>\
                                            </div>\
                                            <div class="row mb-2">\
                                                <label class="col-sm-4 col-form-label col-form-label-sm">Folio</label>\
                                                <div class="col-sm-8" style="font-size: 1.3rem;">\
                                                    <p class="mt-1 mb-0">'+ folio + '</p>\
                                                </div>\
                                            </div>\
                                            <div class="row">\
                                                <label class="col-sm-12">Si esta de acuerdo con los datos mostrados en la parte superior, favor de continuar con los datos de su tarjeta.</label>\
                                            </div>\
                                            <div class="paso1continue btn btn-lg btn-success" style="width: 300px; padding: 15px 25px; margin-top: 1rem; background-color: rgb(0, 118, 255);">Continuar</div>\
                                            <div class="paso1close btn btn-lg btn-secondary mb-2" style="width: 300px; padding: 15px 25px; margin-top: 1rem;">Cancelar</div>\
                                        </div>\
                                    </div>\
                                </div>\
                            </div>\
                        </div>\
                    </div>');
                    var netpaypaso2 = $('<div class="modal">\
                        <div class="modal-dialog">\
                            <div class="modal-content rounded">\
                                <div class="modal-body no-padding row">\
                                    <div class="col-md-12 col-sm-12">\
                                        <h5 class="col-12 py-2 px-0 border-bottom">Paso 2</h5>\
                                        <div id="netpay-form"></div>\
                                        <div class="mx-auto mt-2 mb-2" style="width: 300px; max-width: 100%;text-align: center;">\
                                            <div class="paso2close btn btn-lg btn-secondary mb-2" style="width: 260px; padding: 8px 25px;">Cancelar</div>\
                                        </div>\
                                    </div>\
                                </div>\
                            </div>\
                        </div>\
                    </div>');
                    var netpaypaso3;
                    $("body").append(netpaypaso1), netpaypaso1.modal({ keyboard: !1, backdrop: "static", show: !0 });
                    netpaypaso1.find(".paso1close").on("click", function () { netpaypaso1.modal("hide"), netpaypaso1.remove(); });
                    netpaypaso1.find(".paso1continue").on("click", function () {
                        netpaypaso1.modal("hide"), netpaypaso1.remove(), $("body").append(netpaypaso2);
                        netpaypaso2.modal({ keyboard: !1, backdrop: "static", show: !0 });
                        netpaypaso2.find(".paso2close").on("click", function () { netpaypaso2.modal("hide"), netpaypaso2.remove(); });

                        NetPay.setApiKey("pk_netpay_MjprUDidKUDpkWEYXSdJwgxul");
                        NetPay.setSandboxMode(true);

                        var tokensuccess = function (e) {
                            console.log("Token created successfully");
                            var token = JSON.parse(e.message.data);

                            var payment = {
                                "amount": montoreal,
                                "source": token.token,
                                "description": desc,
                                "paymentMethod": "card",//hardcode
                                "currency": "MXN",//hardcode
                                "billing": {
                                    "firstName": nombre2,
                                    "lastName": apellido,
                                    "email": email,//accept@netpay.com.mx;review@netpay.com.mx;reject@netpay.com.mx
                                    "phone": tel,//opcional
                                    "merchantReferenceCode": folio,//generar reference
                                    "address": {
                                        "city": ciudad,
                                        "country": "MX",//hardcode
                                        "postalCode": cp,
                                        "state": estado,//catalogo de estados definidos por netpay
                                        "street1": calle,
                                        "street2": "" //opcional
                                    }
                                },
                                "redirect3dsUri": "http://example.com/",//hardcode
                                "saveCard": false//hardcode
                            };

                            $.ajax({
                                "url": "https://gateway-154.netpaydev.com/gateway-ecommerce/v3/charges",
                                "method": "POST",
                                "timeout": 0,
                                "headers": {
                                    "Authorization": "sk_netpay_LdYRLUDBEciOBVlngtccrecsyMfWHngpnmwIuLsppSElg",
                                    "Content-Type": "application/json"
                                },
                                "data": JSON.stringify(payment),
                            }).done(function (refpayment) {
                                //"redirect3dsUri": "https://netpay.mx",
                                if (refpayment.status === "success") {
                                    trans = refpayment.transactionTokenId;
                                    oriObj.pout["order_1"].idelem && o.appvm[oriObj.pout["order_1"].idelem] && o.appvm[oriObj.pout["order_1"].idelem].valor(trans);
                                    date = moment(refpayment.createdAt);
                                    netpaypaso3 = $(`<div class="modal">
                                        <div class="modal-dialog">
                                            <div class="modal-content rounded">
                                                <div class="modal-body no-padding row">
                                                    <div class="col-md-12 col-sm-12">
                                                        <h5 class="col-12 py-2 px-0 border-bottom">Recibo de pago</h5>
                                                        <div class="mx-auto" style="width: 300px; max-width: 100%;">
                                                            <h5 class="col-12 py-2 px-0 border-bottom">Pago exitoso</h5>
                                                            <div class="row mb-2">
                                                                <label class="col-sm-4 col-form-label col-form-label-sm">Fecha de transacción</label>
                                                                <div class="col-sm-8" style="font-size: 1.3rem;">
                                                                    <p class="mt-1 mb-0">${date.format("DD [de] MMMM [del] YYYY [a las] HH:mm:ss")}</p>
                                                                </div>
                                                            </div>
                                                            <div class="row mb-2">
                                                                <label class="col-sm-4 col-form-label col-form-label-sm">Monto pagado</label>
                                                                <div class="col-sm-8" style="font-size: 1.3rem;">
                                                                    <p class="mt-1 mb-0">${monto}</p>
                                                                </div>
                                                            </div>
                                                            <div class="row mb-2">
                                                                <label class="col-sm-4 col-form-label col-form-label-sm">No. de Transacción</label>
                                                                <div class="col-sm-8" style="font-size: 1.3rem;">
                                                                    <p class="mt-1 mb-0">${trans}</p>
                                                                </div>
                                                            </div>
                                                            <div class="paso3close btn btn-lg btn-secondary mb-2" style="width: 300px; padding: 15px 25px; margin-top: 1rem;">Cerrar</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>`);
                                    $("body").append(netpaypaso3);
                                    netpaypaso3.modal({ keyboard: !1, backdrop: "static", show: !0 });
                                    netpaypaso3.find(".paso3close").on("click", function () { netpaypaso3.modal("hide"), netpaypaso3.remove(); });
                                }
                                else if (refpayment.status === "review") {
                                    trans = refpayment.transactionTokenId;
                                    oriObj.pout["order_1"].idelem && o.appvm[oriObj.pout["order_1"].idelem] && o.appvm[oriObj.pout["order_1"].idelem].valor(trans);
                                    date = moment(refpayment.createdAt);
                                    globalThis.window.open(refpayment.returnUrl, "_blank");
                                }
                                else {
                                    toasty("Pago no exitoso " + refpayment.error);
                                }
                                netpaypaso2.modal("hide"), netpaypaso2.remove();
                            }).fail(function (error) {
                                console.log(error);
                                toasty("Error " + error.status, error.responseJSON.message);
                                netpaypaso2.modal("hide"), netpaypaso2.remove(), $("body").append(netpaypaso3);
                            });
                        }

                        var tokenerror = function (e) {
                            console.log(e);
                            netpaypaso2.modal("hide"), netpaypaso2.remove(), $("body").append(netpaypaso3);
                            toasty("No fue posible validar la tarjeta con NetPay", e.message);
                        }

                        NetPay.form.generate("netpay-form", tokensuccess, tokenerror, {
                            title: "Pago con tarjeta", cardholder: nombre2 + " " + apellido
                        });
                    });
                    break;
                //Ejecutor de RegEx
                case 22:
                    var rgx = oriObj.pin["order_1"].value;
                    var toclean = "";
                    o.appvm[oriObj.pin["order_2"].idelem] && (toclean = o.appvm[oriObj.pin["order_2"].idelem].valor());
                    var cleaned = Array.from(toclean.matchAll(new RegExp(rgx, 'g')));
                    o.appvm[oriObj.pout["order_1"].idelem] && o.appvm[oriObj.pout["order_1"].idelem].valor(cleaned.join(" "));
                    break;
                default: break;
            }
            console.log("Fin componente " + oriObj.customname + " " + moment().format("DD-MM-YYYY HH:mm:ss.SSS"));
        }



        //Resumen V2
        function resumen2(id) {
            var o = getOpts();
            o.resumenv2 = $('<div class="modal">\
                <div class="modal-dialog modal-xl" style="width: 95%; max-width: 95%;">\
                    <div class="modal-content rounded">\
                        <div class="modal-header">\
                            <h4 class="border-bottom pb-1">Reglas</h4>\
                        </div>\
                        <div class="modal-body no-padding row">\
                            <div class="col-md-12 col-sm-12">\
                                <div class="card p-2 my-1">\
                                    <h5 class="border-bottom pb-1">Texto</h5>\
                                    <div style="max-height:150px; overflow:auto;"><table id="textoresumenv2" style="word-break: break-all; white-space: normal;" class="table table-sm table-hover no-margin table-striped border rounded"></table></div>\
                                    <h5 class="border-bottom pb-1">Imagenes</h5>\
                                    <div style="max-height:150px; overflow:auto;"><table id="imagenresumenv2" style="word-break: break-all; white-space: normal;" class="table table-sm table-hover no-margin table-striped border rounded"></table></div>\
                                    <h5 class="border-bottom pb-1">Tablas</h5>\
                                    <div style="max-height:150px; overflow:auto;"><table id="tablaresumenv2" style="word-break: break-all; white-space: normal;" class="table table-sm table-hover no-margin table-striped border rounded"></table></div>\
                                </div>\
                            </div>\
                        </div>\
                        <div class="modal-footer p-2 no-border">\
                            <div class="modalclose btn btn-light border">Cerrar</div>\
                        </div>\
                    </div>\
                </div>\
            </div>');
            $("body").append(o.resumenv2), o.resumenv2.modal({ keyboard: !1, backdrop: "static", show: !0 });
            o.resumenv2.find(".modalclose").on("click", function () { o.resumenv2.modal("hide"), o.resumenv2.remove(); drawAttributes(id); });
            filltextoresumen2(o, id);
            fillimagenresumen2(o, id);
            filltablaresumen2(o, id);
        }
        function filltextoresumen2(o, id) {
            var acceptsummary = [o.TE.CodigoBarras, o.TE.Fecha, o.TE.Hora, o.TE.Lista, o.TE.Moneda, o.TE.Numero, o.TE.RangoFechas, o.TE.TextArea, o.TE.Texto], apdata = "";
            var fdata = [];
            var olddata = o.appvm[id]["resumen"]();
            if (!_.isEmpty(olddata)) //se limpia resumenv1 y se migra a v2
                o.appvm[id]["resumen"]({});
            var newdata = o.appvm[id]["resumen2"]();
            newdata = _.isObject(newdata) ? newdata : {};
            if (!newdata.texto) { //si no existe aun texto, se migra lo de v1
                newdata["texto"] = {};
                o.appvm[id]["resumen2"](newdata);
            }
            if (!_.isEmpty(olddata)) {
                var count = 1;
                for (var ii in olddata) {
                    newdata.texto[ii] = count.toString();
                    count++;
                }
            }
            var checked = [];
            for (var z in o.appvm[id]["resumen2"]().texto) {
                if (!o.appvm[z]) delete o.appvm[id]["resumen2"]().texto[z];
                else checked.push(z), fdata.push(z);
            }
            _.forEach(_.keys(o.appvm), function (v) {
                v.indexOf('formElec_element') === 0 && _.includes(acceptsummary, o.appvm[v].tipo()) && !checkIfElementIsInParentsType(o, v, o.TE.Tabla)
                    && !_.includes(fdata, v) && fdata.push(v);
            });
            var actdata = function () {
                o.appvm[id]["resumen2"]().texto = {}, _.forEach(o.resumenv2.find('#textoresumenv2 input:checked'), function (v, it) {
                    o.appvm[id]["resumen2"]().texto[v.id] = (it + 1).toString();
                });
            };
            for (var w = 0; w < fdata.length; w++)
                apdata += '<tr>\
                    <td style="display:inline-grid; padding: 0px 10px;">\
                        <i style="cursor:pointer;min-height:10px" ', w > 0 && (apdata += 'class="fas fa-angle-up"'), apdata += '></i>\
                        <i style="cursor:pointer;min-height:10px" ', w < fdata.length - 1 && (apdata += 'class="fas fa-angle-down"'), apdata += '></i>\
                    </td>\
                    <td>' + o.appvm[fdata[w]].titulo() + '</td>\
                    <td><input id="' + fdata[w] + '" type="checkbox" ', _.includes(checked, fdata[w]) && (apdata += ' checked'), apdata += '></td>\
                </tr>';
            o.resumenv2.find('#textoresumenv2').append(apdata);
            o.resumenv2.find('#textoresumenv2').find('.fa-angle-down').on('click', function (e) {
                var em = $($(e.target).closest("tr")).find('td:not(:first-child)'); var nem = $($(e.target).closest("tr")).next().find('td:not(:first-child)');
                nem[0] && em.last().after(nem), $($(e.target).closest("tr")).next().find('td:nth-child(1)').after(em); actdata();
            });
            o.resumenv2.find('#textoresumenv2').find('.fa-angle-up').on('click', function (e) {
                var em = $($(e.target).closest("tr")).find('td:not(:first-child)'); var nem = $($(e.target).closest("tr")).prev().find('td:not(:first-child)');
                nem[0] && em.last().after(nem), $($(e.target).closest("tr")).prev().find('td:nth-child(1)').after(em); actdata();
            });
            o.resumenv2.find('#textoresumenv2').find('input[type=checkbox]').on('click', function () { actdata(); });
        }
        function fillimagenresumen2(o, id) {
            var acceptsummary = [o.TE.Imagen, o.TE.Documento], apdata = "";
            var fdata = [];
            var newdata = o.appvm[id]["resumen2"]();
            newdata = _.isObject(newdata) ? newdata : {};
            if (!newdata.imagen) { //si no existe aun texto, se migra lo de v1
                newdata["imagen"] = {};
                o.appvm[id]["resumen2"](newdata);
            }
            var checked = [];
            for (var z in o.appvm[id]["resumen2"]().imagen) {
                if (!o.appvm[z]) delete o.appvm[id]["resumen2"]().imagen[z];
                else checked.push(z), fdata.push(z);
            }
            _.forEach(_.keys(o.appvm), function (v) { v.indexOf('formElec_element') === 0 && _.includes(acceptsummary, o.appvm[v].tipo()) && !_.includes(fdata, v) && fdata.push(v); });
            var actdata = function () {
                o.appvm[id]["resumen2"]().imagen = {}, _.forEach(o.resumenv2.find('#imagenresumenv2 input:checked'), function (v, it) {
                    o.appvm[id]["resumen2"]().imagen[v.id] = (it + 1).toString();
                });
            };
            for (var w = 0; w < fdata.length; w++)
                apdata += '<tr>\
                    <td style="display:inline-grid; padding: 0px 10px;">\
                        <i style="cursor:pointer;min-height:10px" ', w > 0 && (apdata += 'class="fas fa-angle-up"'), apdata += '></i>\
                        <i style="cursor:pointer;min-height:10px" ', w < fdata.length - 1 && (apdata += 'class="fas fa-angle-down"'), apdata += '></i>\
                    </td>\
                    <td>' + o.appvm[fdata[w]].titulo() + '</td>\
                    <td><input id="' + fdata[w] + '" type="checkbox" ', _.includes(checked, fdata[w]) && (apdata += ' checked'), apdata += '></td>\
                </tr>';
            o.resumenv2.find('#imagenresumenv2').append(apdata);
            o.resumenv2.find('#imagenresumenv2').find('.fa-angle-down').on('click', function (e) {
                var em = $($(e.target).closest("tr")).find('td:not(:first-child)'); var nem = $($(e.target).closest("tr")).next().find('td:not(:first-child)');
                nem[0] && em.last().after(nem), $($(e.target).closest("tr")).next().find('td:nth-child(1)').after(em); actdata();
            });
            o.resumenv2.find('#imagenresumenv2').find('.fa-angle-up').on('click', function (e) {
                var em = $($(e.target).closest("tr")).find('td:not(:first-child)'); var nem = $($(e.target).closest("tr")).prev().find('td:not(:first-child)');
                nem[0] && em.last().after(nem), $($(e.target).closest("tr")).prev().find('td:nth-child(1)').after(em); actdata();
            });
            o.resumenv2.find('#imagenresumenv2').find('input[type=checkbox]').on('click', function () { actdata(); });
        }
        function filltablaresumen2(o, id) {
            var acceptsummary = [o.TE.Tabla], acceptsummary2 = [o.TE.CodigoBarras, o.TE.Fecha, o.TE.Hora, o.TE.Lista, o.TE.Moneda, o.TE.Numero, o.TE.RangoFechas, o.TE.TextArea, o.TE.Texto], apdata = "";
            var fdata = [], fdata2 = [], checked = [], checked2 = [];
            var newdata = o.appvm[id]["resumen2"]();
            newdata = _.isObject(newdata) ? newdata : {};
            if (!newdata.tabla) { //si no existe aun texto, se migra lo de v1
                newdata["tabla"] = {};
                o.appvm[id]["resumen2"](newdata);
            }
            for (var z in o.appvm[id]["resumen2"]().tabla) {
                if (!o.appvm[z]) delete o.appvm[id]["resumen2"]().tabla[z];
                else checked.push(z), fdata.push(z);
            }
            _.forEach(_.keys(o.appvm), function (v) { v.indexOf('formElec_element') === 0 && _.includes(acceptsummary, o.appvm[v].tipo()) && !_.includes(fdata, v) && fdata.push(v); });
            var actdata = function () {
                var olddata = o.appvm[id]["resumen2"]().tabla;
                o.appvm[id]["resumen2"]().tabla = {};
                _.forEach(o.resumenv2.find('#tablaresumenv2 input.childcheck:checked'), function (v) {
                    //si no existe se agrega, si ya existe se mantiene la configuracion
                    if (olddata[$(v).data("checkid")])
                        o.appvm[id]["resumen2"]().tabla[$(v).data("checkid")] = olddata[$(v).data("checkid")];
                    else o.appvm[id]["resumen2"]().tabla[$(v).data("checkid")] = {};
                });
            };
            var actdata2 = function (par, subid) {
                o.appvm[id]["resumen2"]().tabla[subid] = {};
                _.forEach(o.resumenv2.find('#' + par + ' input.subchildcheck:checked'), function (v, it) {
                    o.appvm[id]["resumen2"]().tabla[subid][$(v).data("checkid")] = (it + 1).toString();
                });
            };
            for (var w = 0; w < fdata.length; w++)
                apdata += '<tr>\
                    <td style="display:inline-grid; padding: 0px 10px;">\
                        <i style="cursor:pointer;min-height:10px" ', w > 0 && (apdata += 'class="fas fa-angle-up"'), apdata += '></i>\
                        <i style="cursor:pointer;min-height:10px" ', w < fdata.length - 1 && (apdata += 'class="fas fa-angle-down"'), apdata += '></i>\
                    </td>\
                    <td>' + o.appvm[fdata[w]].titulo() + '<br/>\
                        <table id="columnastablaresumenv2'+ fdata[w] + '" data-subid="' + fdata[w] + '" style="word-break: break-all; white-space: normal;" class="table table-sm table-hover no-margin table-striped border rounded"></table>\
                    </td>\
                    <td><input id="check' + fdata[w] + '" class="childcheck" data-checkid="' + fdata[w] + '" type="checkbox" ', _.includes(checked, fdata[w]) && (apdata += ' checked'), apdata += '></td>\
                </tr>';
            o.resumenv2.find('#tablaresumenv2').append(apdata);
            o.resumenv2.find('#tablaresumenv2').find('.fa-angle-down').on('click', function (e) {
                var em = $($(e.target).closest("tr")).find('td:not(:first-child)'); var nem = $($(e.target).closest("tr")).next().find('td:not(:first-child)');
                nem[0] && em.last().after(nem), $($(e.target).closest("tr")).next().find('td:nth-child(1)').after(em); actdata();
            });
            o.resumenv2.find('#tablaresumenv2').find('.fa-angle-up').on('click', function (e) {
                var em = $($(e.target).closest("tr")).find('td:not(:first-child)'); var nem = $($(e.target).closest("tr")).prev().find('td:not(:first-child)');
                nem[0] && em.last().after(nem), $($(e.target).closest("tr")).prev().find('td:nth-child(1)').after(em); actdata();
            });
            o.resumenv2.find('#tablaresumenv2').find('input[type=checkbox]').on('click', function () { actdata(); });
            for (var z in fdata) {
                checked2 = [], fdata2 = [];
                if (o.appvm[id]["resumen2"]().tabla[fdata[z]])
                    for (var y in o.appvm[id]["resumen2"]().tabla[fdata[z]]) {
                        if (!o.appvm[y]) delete o.appvm[id]["resumen2"]().tabla[fdata[z]][y];
                        else checked2.push(y), fdata2.push(y);
                    }
                _.forEach(_.keys(o.appvm), function (v) { v.indexOf('formElec_element') === 0 && _.includes(acceptsummary2, o.appvm[v].tipo()) && o.appvm[v].elementopadre() === fdata[z] && !_.includes(fdata2, v) && fdata2.push(v); });
                apdata = "";
                for (var w = 0; w < fdata2.length; w++)
                    apdata += '<tr>\
                    <td style="display:inline-grid; padding: 0px 10px;">\
                        <i style="cursor:pointer;min-height:10px" ', w > 0 && (apdata += 'class="fas fa-angle-up"'), apdata += '></i>\
                        <i style="cursor:pointer;min-height:10px" ', w < fdata2.length - 1 && (apdata += 'class="fas fa-angle-down"'), apdata += '></i>\
                    </td>\
                    <td>' + o.appvm[fdata2[w]].titulo() + '</td>\
                    <td><input id="check' + fdata2[w] + '" class="subchildcheck" data-checkid="' + fdata2[w] + '" type="checkbox" ', _.includes(checked2, fdata2[w]) && (apdata += ' checked'), apdata += '></td>\
                </tr>';

                o.resumenv2.find('#columnastablaresumenv2' + fdata[z]).append(apdata);
                o.resumenv2.find('#columnastablaresumenv2' + fdata[z]).find('.fa-angle-down').on('click', function (e) {
                    var em = $($(e.target).closest("tr")).find('td:not(:first-child)'); var nem = $($(e.target).closest("tr")).next().find('td:not(:first-child)');
                    nem[0] && em.last().after(nem), $($(e.target).closest("tr")).next().find('td:nth-child(1)').after(em); actdata2($(this).closest('table')[0].id, $(this).closest('table').data("subid"));
                });
                o.resumenv2.find('#columnastablaresumenv2' + fdata[z]).find('.fa-angle-up').on('click', function (e) {
                    var em = $($(e.target).closest("tr")).find('td:not(:first-child)'); var nem = $($(e.target).closest("tr")).prev().find('td:not(:first-child)');
                    nem[0] && em.last().after(nem), $($(e.target).closest("tr")).prev().find('td:nth-child(1)').after(em); actdata2($(this).closest('table')[0].id, $(this).closest('table').data("subid"));
                });
                o.resumenv2.find('#columnastablaresumenv2' + fdata[z]).find('input[type=checkbox]').on('click', function () { actdata2($(this).closest('table')[0].id, $(this).closest('table').data("subid")); });
            }
        }



        //Modulos de pruebas y macros
        function addRowStep(o, r, s) {
            var step = $(`<tr>
                <td><input class="onoffstep" /></td>
                <td class="text-center text-orange" style="position: relative;">
                    <i class="fas fa-angle-double-up upperstep" style="margin: 5px;position: absolute;left: 0; cursor: pointer;"></i>
                    <i class="fas fa-angle-up upstep" style="margin: 5px 25px;position: absolute;left: 0; cursor: pointer;"></i>
                    <i class="fas fa-angle-down downstep" style="margin: 5px 25px;position: absolute;right: 0; cursor: pointer;"></i>
                    <i class="fas fa-angle-double-down downerstep" style="margin: 5px;position: absolute;right: 0; cursor: pointer;"></i>
                </td>
                <td class="text-center text-bold">${s.order}</td>
                <td>${getDescriptionForActionStep(s.action)}</td>
                <td class="text-bold">${getValueForActionStep(o, s.action, s.who, s.what)}</td>
                <td>${o.appvm[s.who].titulo()} (${s.who})</td>
                <td class="text-center text-red" style="position: relative;">
                    <i class="fas fa-pen-fancy text-blue editstep" style="margin: 5px;position: absolute;left: 0; cursor: pointer;"></i>
                    <i class="fas fa-trash text-red deletestep" style="margin: 5px;position: absolute;right: 0; cursor: pointer;"></i>
                </td>
            </tr>`);
            o.configModal.find(".actionsstep tbody").append(step),
                step.find(".onoffstep").switchbutton({
                    checked: s.enabled, onChange: (checked) => { s.enabled = checked; }
                }),
                step.find(".upperstep").on("click", function () {
                    if (s.order > 1) {
                        s.order = 0;
                        _.orderBy(o.appvm[o.idPlantilla].macros()[r].steps, ["order"], ["asc"]).forEach((ss, ind) => {
                            ss.order = ind + 1;
                        }), updateOpts(o, !0), drawMacro(o, r, $("#scrollsteps").scrollTop());
                    }
                }),
                step.find(".upstep").on("click", function () {
                    if (s.order > 1) {
                        var ant = _.find(o.appvm[o.idPlantilla].macros()[r].steps, { "order": s.order - 1 });
                        s.order--, ant.order++, updateOpts(o, !0), drawMacro(o, r, $("#scrollsteps").scrollTop());
                    }
                }),
                step.find(".downstep").on("click", function () {
                    if (s.order < o.appvm[o.idPlantilla].macros()[r].steps.length) {
                        var ant = _.find(o.appvm[o.idPlantilla].macros()[r].steps, { "order": s.order + 1 });
                        s.order++, ant.order--, updateOpts(o, !0), drawMacro(o, r, $("#scrollsteps").scrollTop());
                    }
                }),
                step.find(".downerstep").on("click", function () {
                    if (s.order < o.appvm[o.idPlantilla].macros()[r].steps.length) {
                        s.order = 9999999;
                        _.orderBy(o.appvm[o.idPlantilla].macros()[r].steps, ["order"], ["asc"]).forEach((ss, ind) => {
                            ss.order = ind + 1;
                        }), updateOpts(o, !0), drawMacro(o, r, $("#scrollsteps").scrollTop());
                    }
                }),
                step.find(".editstep").on("click", () => { editStep(o, s.who, r, s, s.action, s.what); }),
                step.find(".deletestep").on("click", function () {
                    o.appvm[o.idPlantilla].macros()[r].steps = _.filter(o.appvm[o.idPlantilla].macros()[r].steps, (o) => { return o.order !== s.order; });
                    o.appvm[o.idPlantilla].macros()[r].steps.forEach((s, ind) => { s.order = ind + 1; });
                    updateOpts(o, !0), drawMacro(o, r, $("#scrollsteps").scrollTop());
                });
            s.order === 1 && (step.find(".upstep").hide(), step.find(".upperstep").hide());
            s.order === o.appvm[o.idPlantilla].macros()[r].steps.length && (step.find(".downstep").hide(), step.find(".downerstep").hide());
            //Solo los mencionados son posible editar
            !_.includes([o.AccionesMacro.LlenarTexto.name, o.AccionesMacro.LlenarLista.name,
            o.AccionesMacro.LlenarNumero.name, o.AccionesMacro.LlenarMoneda.name,
            o.AccionesMacro.LlenarFecha.name, o.AccionesMacro.LlenarHora.name], s.action) && step.find(".editstep").hide();
        }
        function addLogMacroRow(desc, type) {
            let col = type === "Error" ? "d90000" : type === "Warning" ? "ffbf00" : "3d9970";
            $("#timelinemacro").append(`<div class="direct-chat-msg">
                <div style="margin-left: 0; padding: 3px; background-color: #${col}; color: #fff;">${desc}</div>
            </div>`).scrollTop($("#timelinemacro").prop("scrollHeight"));
            showmacrolog();
        }
        function addeditStep(o, id, m, step, w, order) {
            if (o.appvm[o.idPlantilla].macros()[m]) {
                !o.appvm[o.idPlantilla].macros()[m].steps && (o.appvm[o.idPlantilla].macros()[m].steps = []);
                if (order > 0) {
                    var item = _.find(o.appvm[o.idPlantilla].macros()[m].steps, { "order": order });
                    item.what = w, drawMacro(o, m, $("#scrollsteps").scrollTop());
                } else {
                    o.appvm[o.idPlantilla].macros()[m].steps.push({
                        enabled: !0,
                        action: step.name,
                        who: id,
                        what: w || step.content,
                        order: o.appvm[o.idPlantilla].macros()[m].steps.length + 1
                    });
                    toasty("Accion agregada: " + step.desc, "", "info");
                    //se actualiza el contador que estan visualizando en ese momento
                    $("#countactionmacro").text(_.toNumber($("#countactionmacro").text()) + 1);
                    //$("#countusedreglas").text(_.toNumber($("#countusedreglas").text()) + 1),
                    //$("#countusedcomp").text(_.toNumber($("#countusedcomp").text()) + 1),
                    //$("#countusedserv").text(_.toNumber($("#countusedserv").text()) + 1),
                    //$("#countusedoper").text(_.toNumber($("#countusedoper").text()) + 1);
                }
                updateOpts(o, !0);
            }
        }
        function addStepToMacro(o, id, m, step) {
            _.includes([o.AccionesMacro.LlenarTexto.name, o.AccionesMacro.LlenarLista.name,
            o.AccionesMacro.LlenarNumero.name, o.AccionesMacro.LlenarMoneda.name,
            o.AccionesMacro.LlenarFecha.name, o.AccionesMacro.LlenarHora.name], step.name) ? editStep(o, id, m, step, step.name) : addeditStep(o, id, m, step);
        }
        function createNewMacroName(o, id) {
            let genmod = $(`<div class="modal">
                <div class="modal-dialog">
                    <div class="modal-content rounded">
                        <div class="modal-body">
                            <p class="text-bold mb-2">Nombre de la macro: </p>
                            <input id="macroname" placeholder="Nombre de la macro" class="form-control mb-3" />
                            <div class="modalclose btn float-right btn-danger ml-2 btn-sm">Cerrar</div>
                            <div class="modalnew btn float-right btn-primary btn-sm">Crear</div>
                        </div>
                    </div>
                </div>
            </div>`);
            genmod.find(".modalclose").on("click", function () { genmod.modal("hide"), genmod.remove(); });
            genmod.find(".modalnew").on("click", function () {
                if (_.isEmpty($("#macroname").val())) toasty("Falta agregar un nombre", "Favor de poner un nombre a su macro");
                else {
                    let key = getGuidForElem(o, "macros", "");
                    var namemacro = $("#macroname").val();
                    o.appvm[o.idPlantilla].macros()[key] = { name: namemacro, steps: [] };
                    updateOpts(o, !0), genmod.modal("hide"), genmod.remove();
                    toasty("Macro creada: " + namemacro, "", "info"), drawAttributes(id);
                }
            });
            $("body").append(genmod), genmod.modal({ keyboard: !1, backdrop: "static", show: !0 });
        }
        function drawLogMacro(o) {
            if (!_.isEmpty(o.macro) && !o.drawEditor) {
                o.logmacro = $('<div style="z-index: 20; width: 400px; position: fixed; bottom: 0; left: 50px;" class="card">\
                    <div class="card-header">\
                        <strong class="card-title">Macros</strong>\
                        <div style="top: 0; position: absolute; right: 0;" class="card-tools">\
                          <button id="btnlogmacro" type="button" class="btn btn-tool"><i class="fas fa-plus"></i></button>\
                        </div>\
                    </div>\
                    <div id="cardlogmacro" class="card-body" style="display: none; padding: .7rem;">\
                        <div id="timelinemacro" style="overflow: auto; max-height: 150px;"></div>\
                    </div>\
                </div>');
                $("body").append(o.logmacro);
                $("#btnlogmacro").on("click", function () { if ($(this).find("i").hasClass("fa-plus")) showmacrolog(); else hidemacrolog(); });
                updateOpts(o, !0);
            }
        }
        function drawMacro(o, r, lastscroll) {
            var acti = $(`<div class="configrule" style="border-color: #aaa">
                <div class="bodyrule">
                    <span style="font-size: 1.1rem;" class="text-bold">Para agregar acciones use el boton "Agregar accion" ubicado en cada elemento</span>
                    <div class="p-1 font-weight-bold rounded d-inline-flex justify-content-between w-100 align-items-center" style="font-size:1.2rem; background-color:#e9e6e2">
                        <span>Pasos</span>
                    </div>
                    <div id="scrollsteps" class="w-100" style="max-height:55vh; overflow:auto;">
                        <table class="table table-striped table-bordered table-hover table-sm actionsstep">
                            <thead class="thead-dark">
                                <tr class="text-center">
                                    <th style="width: 50px;"><i class="fas fa-traffic-light"></i></th>
                                    <th style="width: 90px;"><i class="fas fa-sort-numeric-up"></i></th>
                                    <th style="width: 50px;"><i class="fas fa-hashtag"></i></th>
                                    <th>Accion</th>
                                    <th>Contenido</th>
                                    <th>Elemento</th>
                                    <th style="width: 80px;">Editar/Borrar</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>`);

            o.configModal.find("div.collectionelements div#elem" + r).html(acti);
            o.appvm[o.idPlantilla].macros()[r].steps = _.filter(o.appvm[o.idPlantilla].macros()[r].steps, (o) => { return !_.isEmpty(o.action) });
            _.orderBy(o.appvm[o.idPlantilla].macros()[r].steps, ["order"], ["asc"]).forEach((s) => { addRowStep(o, r, s) });
            $("#scrollsteps").scrollTop(lastscroll || 0);
        }
        function editStep(o, id, m, step, action, lastval) {
            lastval = lastval || "";
            var genmod, instantval = "", close = () => { genmod.modal("hide"), genmod.remove(); },
                getval = () => {
                    var v;
                    if (action === o.AccionesMacro.LlenarLista.name) v = $("#" + action).combobox("getValues").join(",");
                    else if (_.includes([o.AccionesMacro.LlenarHora.name, o.AccionesMacro.LlenarFecha.name], action)) v = instantval;
                    else v = $("#" + action).val();
                    return v;
                },
                save = () => {
                    var val = getval();
                    if (_.isEmpty(val)) toasty("Dato vacío", "Favor de llenar el campo");
                    else addeditStep(o, id, m, step, val, step ? step.order : 0), close();
                }, custom = `<input id="${action}" type="text" placeholder="Texto a llenar", value="${lastval}" class="form-control" />`;
            genmod = $(`<div class="modal">
                <div class="modal-dialog">
                    <div class="modal-content rounded">
                        <div class="modal-body">
                            <p class="text-bold mb-2">No se esta validando nada del elemento, tengalo en cuenta para la ejecución de la macro.</p>
                            ${custom}
                            <div class="modalclose btn float-right btn-danger mt-3 ml-2 btn-sm">Cerrar</div>
                            <div class="modalnew btn float-right btn-primary mt-3 btn-sm">Guardar</div>
                        </div>
                    </div>
                </div>
            </div>`);
            genmod.find(".modalnew").on("click", save);
            genmod.find(".modalclose").on("click", close);
            $("body").append(genmod), genmod.modal({ keyboard: !1, backdrop: "static", show: !0 });
            if (action === o.AccionesMacro.LlenarLista.name) {
                $("#" + action).css({ width: "100%" }).combobox({
                    data: o.datatags.allitemscatalogs[o.appvm[id].fuentedatos() + "|" + o.appvm[id].catalogoorigen()], valueField: 'Valor',
                    textField: 'Nombre', multiple: true, limitToList: !0, prompt: 'Seleccione...'
                });
            } else if (_.includes([o.AccionesMacro.LlenarNumero.name, o.AccionesMacro.LlenarMoneda.name], action)) {
                $("#" + action).on("keydown", (e) => { return checkNumberKey(o, id, e); });
            } else if (action === o.AccionesMacro.LlenarHora.name) {
                lastval = lastval.match(/^[0-9]+:[0-9]+$/) ? lastval : "";
                var optstime = {
                    autoclose: true, startView: 1, language: 'es', minuteStep: 15, maxView: 1,
                    format: o.appvm[id].horaObject.Nombre().indexOf("PM") >= 0 ? "HH:ii P" : "hh:ii",
                    showMeridian: o.appvm[id].horaObject.Nombre().indexOf("PM") >= 0
                };
                $("#" + action).val("").datetimepickerfe(optstime).on("changeDate", function (ev) {
                    instantval = _.padStart(ev.date.getHours(), 0, "2") + ":" + _.padStart(ev.date.getMinutes(), 0, "2");
                }).val(lastval);
            } else if (action === o.AccionesMacro.LlenarFecha.name) {
                var format = o.appvm[id].formatoObject.Valor().replace(/\/+/g, o.appvm[id].separador());
                $("#" + action).flatpickr({
                    dateFormat: format, "locale": "es", mode: o.appvm[id].tipo() === o.TE.RangoFechas ? "range" : "single",
                    maxDate: o.appvm[id].fechamax().toString() === "-9999" ? null : new Date().fp_incr(o.appvm[id].fechamax()),
                    minDate: o.appvm[id].fechamin().toString() === "-9999" ? null : new Date().fp_incr(-o.appvm[id].fechamin()),
                    defaultDate: o.appvm[id].tipo() === o.TE.Fecha ? universalToDate(o, id, lastval) : lastval, onChange: function (_sd, ds) { instantval = ds; },
                    disableMobile: true
                });
            }
        }
        function generateLoremIpsumText(longmax) {
            var words = _.shuffle(["cielo", "encima", "puerto", "fue", "color", "television", "calor", "para", "canal", "fin.", "y si",
                "pasa", "más o menos", "parto;", "Yo", "tengo", "historia", "poco a poco", "diferentes personas", "por",
                "generalmente", "sucede", "ciertos casos", "primera vez", "esto", "fue", "diferente", "comparto,", "Que", "estaba",
                "diversión", "porque", "comer"]);
            var sentence = words.join(" ");
            sentence.length < longmax ? (sentence + " " + generateLoremIpsumText(longmax)) : sentence;
            return sentence.substring(0, longmax);
        }
        function getFormatTextForWord(child, msg, opt) {
            var has = msg.match(o.logMacroRegex);
            opt.children = [];
            if (has && has.length) {
                var newmsg = msg.replace(o.logMacroRegex, "###$1&&&_$2###");
                var texts = newmsg.split("###");
                for (var i = 0; i < texts.length; i++) {
                    if (!_.isEmpty(texts[i]) && texts[i].indexOf("&&&_") >= 0) { //texto especial
                        var texts2 = texts[i].split("&&&_");
                        var style = texts2[0];
                        var opt2 = { text: texts2[1] };
                        var createtext = true;
                        switch (style) {
                            case "bold": opt2.bold = true; break;
                            case "space": child.push(new docx.Paragraph(opt)); opt.children = []; break;
                            case "indent": opt.indent = { left: opt2.text }; createtext = false; break;//el indent va en el parrafo
                            case "orangebold": opt2.bold = true; opt2.color = "c45911"; break;
                            case "bluebold": opt2.bold = true; opt2.color = "1148d6"; break;
                            case "cyanbold": opt2.bold = true; opt2.color = "58cbd6"; break;
                            case "purplebold": opt2.bold = true; opt2.color = "5454CC"; break;
                            case "redbold": opt2.bold = true; opt2.color = "d65757"; break;
                        }
                        if (createtext) opt.children.push(new docx.TextRun(opt2));
                    }
                    if (!_.isEmpty(texts[i]) && texts[i].indexOf("&&&_") < 0) //texto normal
                        opt.children.push(new docx.TextRun(texts[i]));
                }
                child.push(new docx.Paragraph(opt));
            }
            else { opt.children.push(new docx.TextRun(msg)); child.push(new docx.Paragraph(opt)); }
            return child;
        }
        function getFormatTextForLog(msg) {
            var has = msg.match(o.logMacroRegex);
            if (has && has.length) {
                var newmsg = msg.replace(o.logMacroRegex, "###$1&&&_$2###");
                var texts = newmsg.split("###");
                var final = "";
                for (var i = 0; i < texts.length; i++) {
                    if (!_.isEmpty(texts[i]) && texts[i].indexOf("&&&_") >= 0) { //texto especial
                        var texts2 = texts[i].split("&&&_");
                        var style = texts2[0];
                        switch (style) {
                            case "bold": final += "<strong>" + texts2[1] + "</strong>"; break;
                            case "space": final += "<br/>"; break;
                            case "orangebold": final += "<strong style='color: #c45911;'>" + texts2[1] + "</strong>"; break;
                            case "bluebold": final += "<strong style='color: #1148d6;'>" + texts2[1] + "</strong>"; break;
                            case "cyanbold": final += "<strong style='color: #58cbd6;'>" + texts2[1] + "</strong>"; break;
                            case "redbold": final += "<strong style='color: #d65757;'>" + texts2[1] + "</strong>"; break;
                        }
                    }
                    if (!_.isEmpty(texts[i]) && texts[i].indexOf("&&&_") < 0) //texto normal
                        final += texts[i];
                }
                return final;
            } else return msg;
        }
        function getFormatRuleAccionForWord(o, r, ac) {
            var sujeto = [], accion = "", acob = o.jobj.elemento.atributos.reglas[r].actions[ac], verbo = _.find(o.datatags.accionesreglas, { Valor: acob.verb });
            for (var subj in acob.subject) {
                switch (acob.verb) {
                    case "cancel":
                        sujeto.push(subj === "validate" ? "Validar formato " : subj === "save" ? "Salvar formato " : "");
                        break;
                    case "showmessage":
                        switch (subj) {
                            case "popuperror": sujeto.push("Pop-up de error "); break;
                            case "popupalert": sujeto.push("Pop-up de alerta "); break;
                            case "popupinfo": sujeto.push("Pop-up de información "); break;
                            case "notiferror": sujeto.push("Aviso de error "); break;
                            case "notifalert": sujeto.push("Aviso de alerta "); break;
                            case "notifinfo": sujeto.push("Aviso de información "); break;
                        }
                        break;
                    case "localprefill": case "executeservice": case "executecomponent": case "operationon": case "operationexe":
                        var containerdata = acob.verb === "localprefill" ? "prefilleddata" : acob.verb === "executeservice" ? "servicios" :
                            acob.verb === "executecomponent" ? "components" : _.includes(["operationon", "operationexe"], acob.verb) ? "operacionesmatematicas" : "",
                            nameact = acob.verb === "localprefill" ? "name" : "customname";
                        o.appvm[o.idPlantilla][containerdata]()[subj] && (sujeto.push(o.appvm[o.idPlantilla][containerdata]()[subj][nameact]));
                        break;
                    default:
                        for (var ss in acob.subject)
                            sujeto.push((o.appvm[ss] ? o.appvm[ss].titulo() : "") + " (" + ss + ") ");
                        break;
                }
            }
            var descverbo = (verbo ? (acob.negation !== undefined && verbo.TieneEsquema && acob.negation ? 'no ' : '') + verbo.Nombre.toLowerCase() : "");
            var desc = "{{indent:600}}{{bold:" + o.jobj.elemento.atributos.reglas[r].name + "}} {{redbold:Accion ===> }} {{purplebold:" + descverbo + "}} {{bluebold:" + sujeto.join(", ") + "}} ";

            if (typeof acob.predicate === "string") accion += acob.predicate;
            else if (acob.predicate) {
                switch (acob.verb) {
                    case "filterlist": case "value": case "multiplevalue":
                        if (_.includes(["words", "cat"], acob.predicate.mode)) {
                            var vals = [];
                            if (acob.predicate.value)
                                for (var vv in acob.predicate.value) vals.push(acob.predicate.value[vv]);
                            accion += "por defecto: " + vals.join(", ");
                        }
                        else if (acob.predicate.mode === "varusr") {
                            var datapred = typeof acob.predicate.value === "string" ? [acob.predicate.value] : acob.predicate.value;
                            accion += "variable de usuario: ";
                            var usuarray = [];
                            for (i = 0; i < datapred.length; i++) {
                                var varusr = _.find(o.datatags.reglasInfoDocUsr, { Valor: datapred[i] });
                                varusr && (usuarray.push(varusr.Nombre));
                            }
                            accion += usuarray.join(", ");
                        }
                        else if (acob.predicate.mode === "element") accion += `del elemento: {{orangebold:${(o.appvm[acob.predicate.value] ? o.appvm[acob.predicate.value].titulo() : "")} (${acob.predicate.value})}}`;
                        break;
                    case "changemapping": case "changeformat":
                        var keypred = _.keys(acob.predicate)[0], namec = acob.verb === "changemapping" ? "customname" : "name",
                            attrdata = acob.verb === "changemapping" ? "pdfmapping" : acob.verb === "changeformat" ? "prefilleddata" : [];
                        o.appvm[o.idPlantilla][attrdata]()[keypred] && (accion += o.appvm[o.idPlantilla][attrdata]()[keypred][namec] + " ");
                        break;
                    case "multiedit":
                        for (subj in acob.predicate) accion += nameElemSummary(o, subj) + ", ";
                        break;
                    case "execute":
                        var keypredexec = _.keys(acob.predicate)[0];
                        switch (keypredexec) {
                            case "tableshowadd": accion += "Abrir una nueva captura"; break;
                            case "tableadd": accion += "Agregar un nuevo registro sin cerrar"; break;
                            case "addclear": accion += "Agregar un nuevo registro y cerrar"; break;
                            case "closeclear": accion += "Cerrar captura"; break;
                            case "clear": accion += "Limpiar captura"; break;
                            case "clearall": accion += "Limpiar tabla completa"; break;
                            case "backward": case "forward": case "finish": accion += o.MacroAcc[keypredexec]; break;
                        }
                        break;
                }
            }
            desc += accion;
            return desc;
        }
        function getFormatRuleForWord(o, r) {
            var desc = "{{bold:Regla}} {{redbold:" + o.jobj.elemento.atributos.reglas[r].name + "}} ejecutada por:";
            for (var cco in o.jobj.elemento.atributos.reglas[r].conditions) {
                switch (o.jobj.elemento.atributos.reglas[r].conditions[cco].category) {
                    case "elementid":
                        //desc += "{{space:}}{{indent:300}} Categoria: Elementos {{space:}}";
                        for (var subj in o.jobj.elemento.atributos.reglas[r].conditions[cco].subject) {
                            var scob = o.jobj.elemento.atributos.reglas[r].conditions[cco].subject[subj],
                                verb = scob.verb;
                            var natverbobj = _.find(o.datatags.condicionesReglas, { Valor: verb });
                            var verbdesc = natverbobj ? ("{{purplebold:" + natverbobj.Nombre.toLowerCase() + "}} ") : "";
                            desc += `{{indent:300}} ${verbdesc} => {{bluebold: ${(o.appvm[scob.subject] ? o.appvm[scob.subject].titulo() : "")} (${scob.subject})}} `;
                            if (typeof scob.predicate === "string") desc += scob.predicate;
                            else if (scob.predicate) {
                                var descpr = "{{orangebold:";
                                switch (verb) {
                                    case "plantilla":
                                        switch (scob.predicate.value) {
                                            case "iswebcomp": descpr += "computadora"; break;
                                            case "iswebmov": descpr += "móvil"; break;
                                            case "isandroid": descpr += "Android"; break;
                                            case "isios": descpr += "iOS"; break;
                                        }
                                        break;
                                    case "contains": case "equals": case "mayorequal": case "menorequal": case "may": case "men":
                                        switch (scob.predicate.mode) {
                                            case "words":
                                                if (o.appvm[scob.subject] && o.appvm[scob.subject].tipo() === o.TE.Lista) {
                                                    scob.predicate.value.push || (scob.predicate.value = [scob.predicate.value]);
                                                    var datasplit = _.map(scob.predicate.value, function (elms) { return elms.toString(); }),
                                                        datalist = _.map(_.filter(o.datatags.allitemscatalogs["catalogos|" + o.appvm[scob.subject].catalogoorigen()], function (elm) { return _.includes(datasplit, elm.Valor.toString()); }), 'Nombre');
                                                    descpr += "por defecto: " + datalist.join(", ");
                                                }
                                                else descpr += "por defecto: " + scob.predicate.value;
                                                break;
                                            case "varusr":
                                                datapred = !scob.predicate.value ? scob.predicate.value : "";
                                                descpr += "variable de usuario: ";
                                                varusr = _.find(o.datatags.reglasInfoDocUsr, { Valor: datapred });
                                                varusr && (descpr += varusr.Nombre);
                                                break;
                                            case "element": descpr += "elemento: " + o.appvm[scob.subject].titulo() + " (" + scob.subject + ")"; break;
                                        }
                                        break;
                                }
                                desc += descpr + "}}";
                            }
                        }
                        break;
                    case "document": case "permissions":
                        //condicion.Categoria = conditionObj.category === "document" ? "Flujo" : "Permisos";
                        //var containercat = conditionObj.category === "document" ? o.datatags.flujosR : o.datatags.permisos;
                        //for (subj in conditionObj.subject) {
                        //    var selitem = _.find(containercat, function (elm) { return elm.CveCatalogo + "_" + elm.Valor === conditionObj.subject[subj].subject; });
                        //    selitem && condicion.Subcondiciones.push(selitem.Nombre);
                        //}
                        break;
                    case "table": case "bytable":
                        //if (conditionObj.category === "table") condicion.Categoria = "Tablas";
                        //else if (conditionObj.category === "bytable") {
                        //    condicion.Categoria = "Tablas por fila ";
                        //    switch (conditionObj.rowtype) {
                        //        case "bynewrow": condicion.Categoria += "(Modo: fila a agregar) "; break;
                        //        case "byeditrow": condicion.Categoria += "(Modo: fila a editar) "; break;
                        //        case "byallrows": condicion.Categoria += "(Modo: todas las filas en la tabla deben cumplir las condiciones) "; break;
                        //        case "byatleastonerow": condicion.Categoria += "(Modo: todas las filas en la tabla que cumplan las condiciones) "; break;
                        //    }
                        //    condicion.Categoria += nameElemSummary(o, conditionObj.tableidelem);
                        //}
                        break;
                }
            }
            return desc;
        }
        function getDescriptionForActionStep(s) { return _.find(o.AccionesMacro, { "name": s }).desc; }
        function getValueForActionStep(o, act, id, val) {
            //if (act === o.AccionesMacro.LlenarLista.name) {
            //    var cat = o.datatags.allitemscatalogs[o.appvm[id].fuentedatos() + "|" + o.appvm[id].catalogoorigen()], newval = [];
            //    val = o.appvm.split(",");
            //    val.forEach((v) => { let it = _.find(cat, { "Valor": v }); newval.push(it ? it.Nombre : ""); });
            //    val = newval.join(" ");
            //}
            return val;
        }
        function getRandomValueForElement(o, id) {
            let tipo = o.appvm[id].tipo();
            var value = "";
            if (_.includes([o.TE.Texto, o.TE.TextArea], tipo)) {
                let lon = _.toNumber(o.appvm[id].longitudmaxima());
                //infinito lo convertimos a maximo 100 caracteres
                if (lon === 0) lon = 100;
                lon = _.random(1, lon);
                value = generateLoremIpsumText(lon);
            } else if (_.includes([o.TE.Numero, o.TE.Moneda], tipo)) {
                let lon = _.toNumber(o.appvm[id].numeromaximo());
                //infinito lo convertimos a maximo 99999
                if (lon === 0) lon = 99999;
                let rand = _.random(1, lon);
                let power = Math.pow(10, o.appvm[id].decimales());
                value = Math.floor(rand * power) / power;
            } else if (_.includes([o.TE.Lista], tipo)) {
                let lon = o.appvm[id].maxopcionesseleccionar();
                //infinito lo convertimos a maximo 5 y solo si es checkbox
                if (lon === 0) lon = o.appvm[id].tipolista() === "checkbox" ? _.random(1, 5) : 1;
                value = _.map(_.sampleSize(o.datatags.allitemscatalogs[o.appvm[id].fuentedatos() + "|" + o.appvm[id].catalogoorigen()], lon), (n) => { return n.Valor }).join(",");
            } else if (_.includes([o.TE.Hora], tipo)) {
                let hour = _.random(0, 23), min = _.random(0, 59);
                value = _.padStart(hour, 2, "0") + ":" + _.padStart(min, 2, "0");
            } else if (_.includes([o.TE.Fecha], tipo)) {
                let max = o.appvm[id].fechamax(), min = o.appvm[id].fechamin();
                //infinito lo convertimos a maximo 30 dias
                if (max === -9999) max = _.random(1, 30);
                if (min === -9999) min = _.random(1, 30);
                let lon = _.random(min, max);
                let upordown = _.random(0, 1);
                value = upordown === 0 ? moment().subtract(lon, 'days').format("YYYYMMDD") : moment().add(lon, 'days').format("YYYYMMDD");
            } else if (_.includes([o.TE.RangoFechas], tipo)) {
                let max = o.appvm[id].fechamax(), min = o.appvm[id].fechamin();
                //infinito lo convertimos a maximo 30 dias
                if (max === -9999) max = _.random(1, 30);
                if (min === -9999) min = _.random(1, 30);
                value = moment().subtract(_.random(min, max), 'days').format("YYYYMMDD") + " a " + moment().add(_.random(min, max), 'days').format("YYYYMMDD");
            }
            return value;
        }
        function getStepsForElement(o, id, m) {
            let tipo = o.appvm[id].tipo(), items = [], genitems = _.map([o.AccionesMacro.LimpiarCampo], (t) => { return { T: t.desc, C: () => { addStepToMacro(o, id, m, t); } }; });
            //o.AccionesMacro.Visible, o.AccionesMacro.Invisible, o.AccionesMacro.Habilitado, o.AccionesMacro.Deshabilitado
            //pagina
            if (tipo === o.TE.Pagina)
                items.push({ T: o.AccionesMacro.ClickPagina.desc, C: () => { addStepToMacro(o, id, m, o.AccionesMacro.ClickPagina); } });
            //texto y textarea
            else if (_.includes([o.TE.Texto, o.TE.TextArea], tipo))
                items.push({ T: o.AccionesMacro.LlenarTexto.desc, C: () => { addStepToMacro(o, id, m, o.AccionesMacro.LlenarTexto); } }),
                    items.push({ T: o.AccionesMacro.LlenarTextoRandom.desc, C: () => { addStepToMacro(o, id, m, o.AccionesMacro.LlenarTextoRandom); } });
            //numero
            else if (_.includes([o.TE.Numero, o.TE.Deslizante], tipo))
                items.push({ T: o.AccionesMacro.LlenarNumero.desc, C: () => { addStepToMacro(o, id, m, o.AccionesMacro.LlenarNumero); } }),
                    items.push({ T: o.AccionesMacro.LlenarNumeroRandom.desc, C: () => { addStepToMacro(o, id, m, o.AccionesMacro.LlenarNumeroRandom); } });
            //moneda
            else if (_.includes([o.TE.Moneda], tipo))
                items.push({ T: o.AccionesMacro.LlenarMoneda.desc, C: () => { addStepToMacro(o, id, m, o.AccionesMacro.LlenarMoneda); } }),
                    items.push({ T: o.AccionesMacro.LlenarMonedaRandom.desc, C: () => { addStepToMacro(o, id, m, o.AccionesMacro.LlenarMonedaRandom); } });
            //boton
            else if (tipo === o.TE.Boton)
                items.push({ T: o.AccionesMacro.ClickBoton.desc, C: () => { addStepToMacro(o, id, m, o.AccionesMacro.ClickBoton); } });
            //wizard
            else if (tipo === o.TE.Wizard)
                items.push({ T: o.AccionesMacro.ClickWizardAvanzar.desc, C: () => { addStepToMacro(o, id, m, o.AccionesMacro.ClickWizardAvanzar); } }),
                    items.push({ T: o.AccionesMacro.ClickWizardRegresar.desc, C: () => { addStepToMacro(o, id, m, o.AccionesMacro.ClickWizardRegresar); } }),
                    items.push({ T: o.AccionesMacro.ClickWizardFinalizar.desc, C: () => { addStepToMacro(o, id, m, o.AccionesMacro.ClickWizardFinalizar); } });
            //lista
            else if (_.includes([o.TE.Lista], tipo))
                items.push({ T: o.AccionesMacro.LlenarLista.desc, C: () => { addStepToMacro(o, id, m, o.AccionesMacro.LlenarLista); } }),
                    items.push({ T: o.AccionesMacro.LlenarListaRandom.desc, C: () => { addStepToMacro(o, id, m, o.AccionesMacro.LlenarListaRandom); } });
            //hora
            else if (_.includes([o.TE.Hora], tipo))
                items.push({ T: o.AccionesMacro.LlenarHora.desc, C: () => { addStepToMacro(o, id, m, o.AccionesMacro.LlenarHora); } }),
                    items.push({ T: o.AccionesMacro.LlenarHoraRandom.desc, C: () => { addStepToMacro(o, id, m, o.AccionesMacro.LlenarHoraRandom); } });
            //fecha
            else if (_.includes([o.TE.Fecha, o.TE.RangoFechas], tipo))
                items.push({ T: o.AccionesMacro.LlenarFecha.desc, C: () => { addStepToMacro(o, id, m, o.AccionesMacro.LlenarFecha); } }),
                    items.push({ T: o.AccionesMacro.LlenarFechaRandom.desc, C: () => { addStepToMacro(o, id, m, o.AccionesMacro.LlenarFechaRandom); } });
            //logico
            else if (_.includes([o.TE.Logico], tipo))
                items.push({ T: o.AccionesMacro.LlenarLogicoMarcado.desc, C: () => { addStepToMacro(o, id, m, o.AccionesMacro.LlenarLogicoMarcado); } }),
                    items.push({ T: o.AccionesMacro.LlenarLogicoDesmarcado.desc, C: () => { addStepToMacro(o, id, m, o.AccionesMacro.LlenarLogicoDesmarcado); } }),
                    items.push({ T: o.AccionesMacro.LlenarLogicoRandom.desc, C: () => { addStepToMacro(o, id, m, o.AccionesMacro.LlenarLogicoRandom); } });

            !_.includes([o.TE.Pagina, o.TE.Wizard, o.TE.Boton], tipo) && (items = items.concat(genitems));
            return items;
        }
        function hidemacrolog() {
            //esconder lo mostrado
            $("#cardlogmacro").hide(), $("#btnlogmacro > i").removeClass("fa-minus").addClass("fa-plus");
        }
        function openframetest(o, us) {
            var url = window.location.href;
            url = url.substring(0, url.lastIndexOf("/") + 1);
            window.open(url + 'FECapturador.aspx?' + (_.isEmpty(us) ? '' : 'fedemo=1&guestfe=' + us) + '&fsia=1&ExpID=' + o.datasend.expId + '&p=' + o.datasend.proyid + '&mm=' + (_.isEmpty($("#macro").val()) ? "1" : $("#macro").val()), "_blank")
        }
        async function runmacro(o) {
            if (!_.isEmpty(o.macro) && !o.drawEditor) {
                for (var mm in o.jobj.elemento.atributos.macros)
                    if (o.macro === mm) {
                        o.FEReporteEstadistico.Macro.Nombre = o.jobj.elemento.atributos.macros[mm].name;
                        !o.FEReporteEstadistico.Macro.Acciones.push && (o.FEReporteEstadistico.Macro.Acciones = []);
                        addLogMacroRow(`Ejecutando macro ${o.FEReporteEstadistico.Macro.Nombre}`);
                        await sleep(700);
                        var ordered = _.orderBy(o.jobj.elemento.atributos.macros[mm].steps, "order");
                        for (let i = 0; i < ordered.length; i++) {
                            let st = ordered[i];
                            if (st.enabled === !0) {
                                var act = runAction(o, st.action, st.who, st.what);
                                let acc = {
                                    FechaMacro: getTicksOfTime(new Date()),
                                    Paso: st.order || 0,
                                    Descripcion: getDescriptionForActionStep(st.action) || "",
                                    Ejecucion: act.ejec || "",
                                    Estatus: act.stat || "",
                                    Screenshot: "",
                                    IDElemento: st.who || "",
                                    Titulo: _.isEmpty(st.who) ? "" : o.appvm[st.who].titulo(),
                                    DatoOriginal: getValueForActionStep(o, st.action, st.who, st.what) || "",
                                    DatoFinal: act.final || ""
                                };
                                o.FEReporteEstadistico.Macro.Acciones.push(acc), updateOpts(o, !0);
                                addLogMacroRow(`${acc.Descripcion} del elemento ${acc.Titulo} con Valor: ${acc.DatoFinal}${(_.isEmpty(acc.Estatus) ? "" : (" => Estatus: " + acc.Estatus))}`, acc.Estatus);
                                if (act.stat === "Error") {
                                    //se detiene la macro y se auto guarda despues de unos segundos para registrar la matriz en las estadisticas
                                    goPublish(1);
                                    break;
                                }
                                await sleep(700);
                            }
                        }
                        break;
                    }
            }
        }
        function runAction(o, act, who, what) {
            var rep = { ejec: "", stat: "", final: "" };
            if (o.appvm[who]) {
                if (_.includes([o.AccionesMacro.LlenarTexto.name, o.AccionesMacro.LlenarTextoRandom.name,
                o.AccionesMacro.LlenarMoneda.name, o.AccionesMacro.LlenarMonedaRandom.name,
                o.AccionesMacro.LlenarNumero.name, o.AccionesMacro.LlenarNumeroRandom.name,
                o.AccionesMacro.LlenarFecha.name, o.AccionesMacro.LlenarFechaRandom.name,
                o.AccionesMacro.LlenarHora.name, o.AccionesMacro.LlenarHoraRandom.name], act)) {
                    if (act.indexOf("ran") >= 0) what = getRandomValueForElement(o, who);
                    if (o.appvm[who].visible() && o.appvm[who].habilitado() && o.appvm[who].elementrendered()) {
                        if (o.appvm[who].tipo() === o.TE.RangoFechas) o.appvm[who].valormetadatorango(what);
                        else if (o.appvm[who].valor) o.appvm[who].valor(what);
                        rep.final = (o.appvm[who].tipo() === o.TE.RangoFechas) ? o.appvm[who].valormetadatorango() : o.appvm[who].valor();
                        rep.ejec = "Texto llenado";
                        rep.stat = "OK";
                    } else {
                        if (!o.appvm[who].visible()) rep.ejec = _.upperFirst(o.appvm[who].tipo()) + " no visible";
                        else if (!o.appvm[who].visible()) rep.ejec = _.upperFirst(o.appvm[who].tipo()) + " deshabilitado";
                        else if (!o.appvm[who].elementrendered()) rep.ejec = _.upperFirst(o.appvm[who].tipo()) + " no visible, aun no se dibuja ó pertenece a otra página";
                        rep.stat = "Warning";
                    }
                }
                else if (o.AccionesMacro.ClickPagina.name === act) {
                    if (o.appvm[who].visible() && o.appvm[who].habilitado()) {
                        showPage(who, !1);
                        rep.final = what;
                        rep.ejec = "Página mostrada";
                        rep.stat = "OK";
                    } else {
                        if (!o.appvm[who].visible()) rep.ejec = "Página no visible";
                        else if (!o.appvm[who].visible()) rep.ejec = "Página deshabilitado";
                        else if (!o.appvm[who].elementrendered()) rep.ejec = "Pagina no visible, aun no se dibuja";
                        rep.stat = "Warning";
                    }
                }
                else if (o.AccionesMacro.ClickBoton.name === act) {
                    if (o.appvm[who].visible() && o.appvm[who].habilitado() && o.appvm[who].elementrendered()) {
                        o.appvm[who].click();
                        rep.final = what;
                        rep.ejec = "Botón apretado";
                        rep.stat = "OK";
                    } else {
                        if (!o.appvm[who].visible()) rep.ejec = "Botón no visible";
                        else if (!o.appvm[who].visible()) rep.ejec = "Botón deshabilitado";
                        else if (!o.appvm[who].elementrendered()) rep.ejec = "Botón no visible, aun no se dibuja ó pertenece a otra página";
                        rep.stat = "Warning";
                    }
                }
                else if (_.includes([o.AccionesMacro.LlenarLista.name, o.AccionesMacro.LlenarListaRandom.name], act)) {
                    if (act.indexOf("ran") >= 0) what = getRandomValueForElement(o, who);
                    if (o.appvm[who].visible() && o.appvm[who].habilitado() && o.appvm[who].elementrendered()) {
                        var opsel = [{ Nombre: "Seleccione", Valor: "", CatalogoId: o.appvm[who].catalogoorigen(), CveCatalogo: "", CatalogoPId: 0 }];
                        if (what) {
                            what = what.split(",");
                            what = o.appvm[who].tipolista() !== "checkbox" ? [_.head(what)] : what;
                            opsel = _.filter(o.datatags.allitemscatalogs[o.appvm[who].fuentedatos() + "|" + o.appvm[who].catalogoorigen()], function (belem) {
                                return _.includes(what, belem.Valor);
                            });
                        }
                        if (opsel) {
                            opsel = o.appvm[who].tipolista() !== "checkbox" ? _.head(opsel) : opsel;
                            if (o.appvm[who].tipolista() === "combo") o.appvm[who].optionselectedRule(opsel.Valor);
                            else o.appvm[who].chosenitemsRule(opsel);
                            rep.final = opsel.push ? _.map(opsel, (f) => { return f.Nombre }).join(", ") : opsel.Nombre;
                            rep.ejec = "Item de lista seleccionada";
                            rep.stat = "OK";
                        }
                    } else {
                        if (!o.appvm[who].visible()) rep.ejec = "Lista no visible";
                        else if (!o.appvm[who].visible()) rep.ejec = "Lista deshabilitado";
                        else if (!o.appvm[who].elementrendered()) rep.ejec = "Lista no visible, aun no se dibuja ó pertenece a otra página";
                        rep.stat = "Warning";
                    }
                }
                else if (_.includes([o.AccionesMacro.ClickWizardAvanzar.name, o.AccionesMacro.ClickWizardRegresar.name,
                o.AccionesMacro.ClickWizardFinalizar.name], act)) {
                    if (o.appvm[who].visible() && o.appvm[who].habilitado() && o.appvm[who].elementrendered()) {
                        var actwiz, namewiz;
                        if (act === o.AccionesMacro.ClickWizardAvanzar.name) actwiz = "forward", namewiz = "Avanzar";
                        else if (act === o.AccionesMacro.ClickWizardRegresar.name) actwiz = "backward", namewiz = "Regresar";
                        else if (act === o.AccionesMacro.ClickWizardFinalizar.name) actwiz = "finish", namewiz = "Finalizar";
                        customClickButtonsElements(o.appvm[who].tipo(), who, actwiz, !0);
                        rep.final = what;
                        rep.ejec = "Wizard apretado con " + namewiz;
                        rep.stat = "OK";
                    } else {
                        if (!o.appvm[who].visible()) rep.ejec = "Wizard no visible";
                        else if (!o.appvm[who].visible()) rep.ejec = "Wizard deshabilitado";
                        else if (!o.appvm[who].elementrendered()) rep.ejec = "Wizard no visible, aun no se dibuja ó pertenece a otra página";
                        rep.stat = "Error";
                    }
                }
                else if (o.AccionesMacro.LimpiarCampo.name === act) {
                    if (o.appvm[who].visible() && o.appvm[who].habilitado() && o.appvm[who].elementrendered()) {
                        if (o.appvm[who].tipo() === o.TE.RangoFechas) o.appvm[who].valormetadatorango("");
                        else if (o.appvm[who].tipo() === o.TE.Lista) {
                            if (o.appvm[who].tipolista() === "combo") o.appvm[who].optionselectedRule(opsel.Valor);
                            else o.appvm[who].chosenitemsRule(opsel);
                        }
                        else if (o.appvm[who].valor) o.appvm[who].valor("");
                        rep.final = "";
                        rep.ejec = "Botón apretado";
                        rep.stat = "OK";
                    } else {
                        if (!o.appvm[who].visible()) rep.ejec = "Botón no visible";
                        else if (!o.appvm[who].visible()) rep.ejec = "Botón deshabilitado";
                        else if (!o.appvm[who].elementrendered()) rep.ejec = "Botón no visible, aun no se dibuja ó pertenece a otra página";
                        rep.stat = "Warning";
                    }
                }
                $("#" + who)[0] && $('html,body').scrollTop($("#" + who).offset().top);
            }
            return rep;
        }
        function saveDocxLogMacro(o, mname) {
            var doc = new docx.Document({
                creator: "Macro FEV2 (Benjamin Viloria Mendoza)",
                description: "Documento descriptivo de cada paso en la Macro",
                title: mname,
            });
            var child = [];
            var step = 0;
            for (var i = 0; i < o.logMacroWord.length; i++) {
                switch (o.logMacroWord[i].type) {
                    case o.MacroTy.Macro:
                        child = getFormatTextForWord(child, o.logMacroWord[i].msg, {
                            heading: docx.HeadingLevel.HEADING_1,
                            alignment: docx.AlignmentType.CENTER,
                            spacing: { before: 200 }
                        }), child = getFormatTextForWord(child, "", {});
                        break;
                    case o.MacroTy.Paso:
                        if (step > 0) child = getFormatTextForWord(child, "", {});
                        child = getFormatTextForWord(child, o.logMacroWord[i].msg, {
                            heading: docx.HeadingLevel.HEADING_3,
                            alignment: docx.AlignmentType.LEFT,
                            spacing: { before: 200 }
                        }), child = getFormatTextForWord(child, "", {});
                        step++;
                        break;
                    case o.MacroTy.Accion:
                        child = getFormatTextForWord(child, o.logMacroWord[i].msg, {});
                        break;
                    case o.MacroTy.Rule:
                        child = getFormatTextForWord(child, o.logMacroWord[i].msg, {});
                        break;
                    case o.MacroTy.RuleAccion:
                        child = getFormatTextForWord(child, o.logMacroWord[i].msg, {});
                        break;
                }
            }
            doc.addSection({ properties: {}, children: child });

            docx.Packer.toBlob(doc).then(blob => {
                saveAs(blob, mname + ".docx");
                console.log("Log de Macro " + mname + " exportado");
            });
        }
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        function showmacrolog() {
            //mostrar lo escondido
            $("#cardlogmacro").show(), $("#btnlogmacro > i").removeClass("fa-plus").addClass("fa-minus");
        }
        function testrun(o) {
            validateAndSavePlantilla();
            if (!o.mensajeGuardaPlantilla.length) {
                var o = getOpts();
                o.testrunmodal = $('<div class="modal">\
                    <div class="modal-dialog modal-xl" style="width: 95%; max-width: 95%;">\
                        <div class="modal-content rounded">\
                            <div class="modal-header">\
                                <h4 class="modal-title">Modulo de pruebas</h4>\
                            </div>\
                            <div class="modal-body no-padding row">\
                                <div class="col-md-12 col-sm-12">\
                                    <div class="card p-2 my-1">\
                                        <h5 class="border-bottom pb-1">\
                                            Seleccione el macro que desea probar y la impersonalización.<br/>\
                                            Si no especifica un usuario se utilizara el logueado\
                                        </h5>\
                                        <div class="mb-3 row">\
                                            <div class="col-6">\
                                                <label for="usuarioimper" class="form-label">Macro</label>\
                                                <select class="form-control" id="macro"></select>\
                                            </div>\
                                            <div class="col-6">\
                                                <label for="usuarioimper" class="form-label">Usuario de impersonalización</label>\
                                                <input type="text" class="form-control" id="usuarioimper" placeholder="Usuario" />\
                                            </div>\
                                        </div>\
                                        <div class="mb-3">\
                                            <div class="btn btn-success" id="btntestrun">Probar</div>\
                                        </div>\
                                    </div>\
                                </div>\
                            </div>\
                            <div class="modal-footer p-2 no-border">\
                                <div class="modalclose btn btn-light border">Cerrar</div>\
                            </div>\
                        </div>\
                    </div>\
                </div>');
                $("body").append(o.testrunmodal), o.testrunmodal.modal({ keyboard: !1, backdrop: "static", show: !0 });
                o.testrunmodal.find(".modalclose").on("click", function () { o.testrunmodal.modal("hide"), o.testrunmodal.remove(); });
                o.testrunmodal.find("#macro").append('<option value="">--Sin macro--</option>');
                for (var r in o.appvm[o.idPlantilla].macros())
                    o.testrunmodal.find("#macro").append('<option value="' + r + '">' + o.appvm[o.idPlantilla].macros()[r].name + '</option>');
                o.testrunmodal.find("#btntestrun").on("click", function () {
                    if (_.isEmpty($("#usuarioimper").val()))
                        openframetest(o, "", $("#usuarioimper").val());
                    else $.ajax({
                        url: 'FEConfigurador.aspx/Impersonalizar',
                        data: JSON.stringify({
                            usuario: $("#usuarioimper").val(),
                            proyid: o.datasend.proyid
                        }),
                        beforeSend: function () { showHideLoading(o, !0, "Impersonalizando"); },
                        success: function (j) {
                            o.testrunmodal.find(".modalclose").click();
                            j = j.d;
                            if (j.Success) {
                                openframetest(o, j.ReturnedObject, $("#usuarioimper").val());
                            }
                            else Error("Ops lo sentimos ocurrió un error", j.Mensaje);
                        },
                        complete: function () { showHideLoading(o, !1); }
                    });
                });
            }
        }



        //log de cambios
        function addTimelineRow(o, msg, ty) {
            var tl = { date: moment().format("DD/MM/YY HH:mm:ss"), msg: msg, usr: o.datasend.userName, type: ty };
            o.logtimeline.push(tl);
            clearTimeout(o.logtimelinetimeout);
            o.logtimelinetimeout = setTimeout(function () { hidetimeline(); }, 2000);
            var coty = "";
            switch (ty) {
                case o.LogTy.Add: coty = "background-color: #567d4d; color: white;"; break;
                case o.LogTy.Remove: coty = "background-color: #974d4d; color: white;"; break;
                default: coty = "background-color: #cfcfd2; color: black;"; break;
            }
            $("#timeline").append('<div class="direct-chat-msg">\
                <div class="direct-chat-infos clearfix">\
                    <span class="direct-chat-name float-left">'+ tl.usr + '</span>\
                    <span class="direct-chat-timestamp float-right">' + tl.date + '</span>\
                </div>\
                <div style="margin-left: 0; padding: 3px; '+ coty + '">' + tl.msg + '</div>\
            </div>');
            showtimeline(), updateOpts(o, !0);
        }
        function drawlogpanel(o) {
            if (o.drawEditor) {
                o.logpanel = $('<div style="z-index: 20; width: 300px; position: fixed; bottom: 0; left: 50px;" class="card">\
                    <div class="card-header">\
                        <strong class="card-title">Log de cambios</strong>\
                        <div style="top: 0; position: absolute; right: 0;" class="card-tools">\
                          <button id="btnlogpanel" type="button" class="btn btn-tool"><i class="fas fa-plus"></i></button>\
                        </div>\
                    </div>\
                    <div id="cardlogpanel" class="card-body" style="display: none; padding: .7rem;">\
                        <div id="timeline" style="overflow: auto; max-height: 200px;"></div>\
                    </div>\
                </div>');
                $("body").append(o.logpanel);
                $("#btnlogpanel").on("click", function () {
                    if ($(this).find("i").hasClass("fa-plus")) showtimeline();
                    else hidetimeline();
                });
            }
        }
        function hidetimeline() {
            //esconder lo mostrado
            $("#cardlogpanel").hide(), $("#btnlogpanel > i").removeClass("fa-minus").addClass("fa-plus");
        }
        function showtimeline() {
            //mostrar lo escondido
            $("#cardlogpanel").show(), $("#btnlogpanel > i").removeClass("fa-plus").addClass("fa-minus");
        }



        //log ReporteEstadistico
        function addHistoriaReporteEstadistico(o, r, cat) {
            var desc = "";
            if (cat === o.CategoriaReporteEstadistico.Regla) { desc = o.jobj.elemento.atributos.reglas[r].name; }
            else if (cat === o.CategoriaReporteEstadistico.Componente) { }
            else if (cat === o.CategoriaReporteEstadistico.Servicio) { desc = r; }
            else if (cat === o.CategoriaReporteEstadistico.Operacion) { }

            if (o.FEReporteEstadistico.Historia && o.FEReporteEstadistico.Historia.push) {
                o.FEReporteEstadistico.Historia.push({
                    Descripcion: desc, Categoria: cat, FechaHistoria: getTicksOfTime(new Date()),
                });
            }
        }
        function addEstadisticaReporteEstadistico(o, id, val) {
            if (_.includes(["leyenda", "tabla"], o.appvm[id].tipo())) return;
            let idpag = getElementByTypeByParents(o, o.appvm[id].elementopadre(), o.TE.Pagina);
            if (o.FEReporteEstadistico.Estadisticas && o.FEReporteEstadistico.Estadisticas.push) {
                var est = _.find(o.FEReporteEstadistico.Estadisticas, { IdElemento: id });
                //edicion
                if (est) est.Cambios++, est.ValorFinal = val, est.FechaValorFinal = getTicksOfTime(new Date());
                else o.FEReporteEstadistico.Estadisticas.push({
                    IdElemento: id, Titulo: o.appvm[id].titulo(), ValorFinal: val, IdPagina: idpag, Cambios: 1,
                    Pagina: o.appvm[idpag].titulo(), FechaValorFinal: getTicksOfTime(new Date()),
                });
            }
        }



        /////////////OCR Recognizer
        //Descarga el base64 del pdf que ya se subio y lo envia al servicio de recognizer
        //o: el modelo
        //id: el id del elemento que lo invoco
        function ocrRecognizerAnalyze(o, id) {
            var ane = _.find(o.appvm.listAnexos(), { ElementoId: id, GuidAnexo: o.appvm[id].anexo() ? o.appvm[id].anexo().guidanexo : "" });
            if (ane) wcfFileTransferInvoke(o, id, ane, "Analizando PDF").then((tjson) => {
                var json = JSON.parse(tjson);
                wcfServicioToken(o, id).then((token) => {
                    wcfServicioGenerico(o, id, "Realizando OCR del PDF", "ServiciosDigipro.ServicioOCR.FormRecognizer",
                        { pdf: json.datos }, token).then((ocr) => {
                            o.appvm[id].hasocrdata(!0), o.appvm[id].ocrrecognizer(ocr);
                        });
                });
            });
        }
        //Muestra la ventana de resultados del OCR Recognizer
        //o: el modelo
        //id: el id del elemento que lo invoco
        function ocrRecognizerShowResults(o, id) {
            //Esqueleto del objeto OCRRecognizer, supone una coleccion de paginas
            //[{
            //    Palabras: [],
            //    Lineas: [],
            //    Numero: 0,
            //    CantidadPalabras: 0,
            //    CantidadLineas: 0
            //}];
            let ocr = o.appvm[id].ocrrecognizer(), t = o.appvm[id].anexo().thumb, showt = !_.isEmpty(t),
                elems = [], mod = customModal();

            for (let elem in o.appvm)
                elem.indexOf("formElec_element") >= 0 && _.includes([o.TE.Texto, o.TE.TextArea, o.TE.Fecha, o.TE.Numero], o.appvm[elem].tipo()) &&
                    o.appvm[elem].visible() && (elems.push({ id: elem, nom: o.appvm[elem].titulo() }));
            mod.find('.modal-body')
                .append($("<h4>", { class: 'text-center' }).text('Resultados del OCR'))
                .append($("<div>", { class: 'row' })
                    .append($("<div>", { class: 'col-md-3 col-sm-12' })
                        .append($("<img>", { class: 'realimg img-thumbnail mx-auto mb-2', src: t, style: 'display:block; cursor:pointer;' })
                            .on('click', () => { customClickButtonsElements(o.appvm[id].tipo(), id, 'view', !1); }))
                        .append($("<i>", { class: 'iconimg fas fa-download img-thumbnail text-center mb-2', style: 'font-size: 2.5em; cursor: pointer; width: 100%;' })
                            .on('click', () => {
                                customClickButtonsElements(o.appvm[id].tipo(), id, 'view', !1),
                                    mod.find('.iconimg').hide(), t = o.appvm[id].anexo().thumb, mod.find('.realimg').show().attr("src", t);
                            }))
                        .append($("<h5>").text('Palabras seleccionadas hasta el momento:'))
                        .append($("<h6>", { class: 'previewtext card card-body' }))
                        .append($("<h5>").text('Escoger un campo a asignar'))
                        .append($("<select>", { class: 'form-control elemassign' }))
                        .append($("<div>", { class: 'btn bg-purple btn-block mt-2' })
                            .text('Asignar')
                            .on('click', () => {
                                o.appvm[mod.find('.elemassign').val()].valor(mod.find('.previewtext').text());
                                toasty('', 'Palabras asignadas.', 'exito');
                                mod.find('.sopadeletras .wordsocr').removeClass('bg-info');
                                mod.find('.previewtext').text('');
                                mod.find('.elemassign').val('0');
                            })))
                    .append($("<div>", { class: 'col-md-9 col-sm-12' })
                        .append($("<div>", { class: 'sopadeletras card', style: 'width: 100%;' }))
                    ));
            mod.find('.elemassign')
                .append($("<option>", { value: '0' }).text('--Seleccione--'));
            _.orderBy(elems, ['nom'], ['asc']).forEach((v) => {
                mod.find('.elemassign')
                    .append($("<option>", { value: v.id }).text(v.nom));
            });
            showt ? mod.find('.iconimg').hide() : mod.find('.realimg').hide();

            _.forEach(ocr.OCR, (p) => {
                //optimizacion de append masivo
                let html = '';
                _.forEach(p.Palabras, (w) => {
                    html += `<div class="btn btn-default mr-1 wordsocr">${w}</div>`;
                });
                mod.find('.sopadeletras')
                    .append($("<div>", { class: 'card-header' }).text(`Pagina ${p.Numero}`))
                    .append($("<div>", { class: 'card-body' }).html(html));
            });
            mod.find('.sopadeletras .wordsocr').on('click', (e) => {
                let b = $(e.target), pt = mod.find('.previewtext'), words = pt.data('words');
                !words && (words = []);
                if (b.hasClass('bg-info'))
                    words = _.filter(words, (n) => { return n !== b.text() }), b.removeClass('bg-info');
                else
                    words.push(b.text()), b.addClass('bg-info');
                pt.data('words', words), pt.text(words.join(' '));
            });
        }



        ////////////HTML Templates
        function htmlElementoGenerico() {
            return `<div class="align-top element sortable droppedin" data-bind="{
                css: [
                    $root[p().id()].csselementoglobal(),
                    $root[p().id()].nombreestilopersonal(),
                    $root[$root.idPlantilla()].bordeelementos() ? 'sortableborderwith' : 'no-border'
                ].join(' '),
                attr: {
                    id: p().id,
                    hidden: $root.isEditor() ? false : !$root[p().id()].visible()
                },
                style: {
                    display: !_.includes(['leyenda', 'boton', 'combodinamico', 'logico'], $root[p().id()].tipo()) ? 'inline-table' : '',
                    marginRight: _.isEmpty($root[p().id()].margenderecho()) ? 0 : $root[p().id()].margenderecho(),
                    marginLeft: _.isEmpty($root[p().id()].margenizquierdo()) ? 0 : $root[p().id()].margenizquierdo()
                }
            }">
                <div data-bind="{
                    loadayuda: $root[p().id()].ayuda ? $root[p().id()].ayuda() : ''
                }"></div>
                <!-- ko component: {
                    name: p().subelement(),
                    params: {
                        id: p().id(),
                        tipo: p().tipo()
                    }
                } -->
                <!-- /ko -->
                <div class="actions no-padding text-right float-right" data-bind="{
                    attr: {
                        hidden: !$root.isEditor()
                    }
                }">
                    <!-- ko component: {
                        name: "actions",
                        params: {
                            id: p().id(),
                            tipo: p().tipo()
                        }
                    } -->
                    <!-- /ko -->
                </div>
            </div>`;
        }
        function htmlElementoAudio() {
            return `<div data-bind="{
                style: {
                    textAlign: $root[p().id()].alineadotexto,
                    fontStyle: $root[p().id()].estilotexto,
                    fontWeight: $root[p().id()].grosortexto
                },
                elementoLoaded: 1
            }">${o1.templateErrorValidation}${o1.templateAsterisk}${o1.templateLabelTitulo}${o1.templateLabelSubtitulo}
                <div data-bind="{
                    designbuttonall: {
                        t: $root[p().id()].textoagregar(),
                        ty: $root[p().id()].tipo(),
                        c: $root[p().id()].colortextoaudio(),
                        bg: $root[p().id()].coloraudio()
                    },
                    attr: {
                        hidden: !!$root[p().id()].anexo() && !!$root[p().id()].anexo().guidanexo
                    },
                    style: {
                        display: $root[p().id()].ancho() === 'completo' ? 'block' : 'inline-block'
                    }
                }">
                    <div class="btn addaudio" data-bind="{
                        css: {
                            disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(),
                            hasshadow: $root[$root.idPlantilla()].permitirsombrabotones(),
                            'btn-block': $root[p().id()].ancho() === 'completo'
                        }
                    }">
                        <span class="pretext" data-bind="{
                            style: {
                                'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                            }
                        }"></span>
                        <i data-bind="{
                            style: {
                                'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                            },
                            css: [$root[p().id()].iconoagregar()].join(' '),
                            attr: {
                                hidden: !$root[p().id()].vericonoagregar()
                            }
                        }"></i>
                        <span class="posttext" data-bind="{
                            style: {
                                'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                            }
                        }"></span>
                    </div>
                    <br />
                    <span class="externtext text-bold" data-bind="{
                        style: {
                            'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                        }
                    }"></span>
                </div>
                <div data-bind="{
                    designbuttonall: {
                        t: 'Eliminar',
                        ty: $root[p().id()].tipo(),
                        c: $root[p().id()].colortextoborrar(),
                        bg: $root[p().id()].colorborrar()
                    },
                    attr: {
                        hidden: !($root[p().id()].anexo().delete && _.isEmpty($root[p().id()].anteriornombrearchivo()))
                    },
                    style: {
                        display: $root[p().id()].ancho() === 'completo' ? 'block' : 'inline-block'
                    }
                }">
                    <div class="btn" data-bind="{
                        click: () => { clickcustom('delete') },
                        css: {
                            disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(),
                            hasshadow: $root[$root.idPlantilla()].permitirsombrabotones(),
                            'btn-block': $root[p().id()].ancho() === 'completo'
                        }
                    }">
                        <span class="pretext" data-bind="{
                            style: {
                                'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                            }
                        }"></span>
                        <i class="far fa-trash-alt" data-bind="{
                            style: {
                                'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                            },
                            attr: {
                                hidden: !$root[p().id()].vericonoagregar()
                            }
                        }"></i>
                        <span class="posttext" data-bind="{
                            style: {
                                'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                            }
                        }"></span>
                    </div>
                    <br />
                    <span class="externtext text-bold" data-bind="{
                        style: {
                            'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                        }
                    }"></span>
                </div>
                <div data-bind="{
                    designbuttonall: {
                        t: 'Reproducir',
                        ty: $root[p().id()].tipo(),
                        c: $root[p().id()].colortextovisualizar(),
                        bg: $root[p().id()].colorvisualizar()
                    },
                    attr: {
                        hidden: !($root[p().id()].anexo() && $root[p().id()].anexo().guidanexo)
                    },
                    style: {
                        display: $root[p().id()].ancho() === 'completo' ? 'block' : 'inline-block'
                    }
                }">
                    <div class="btn" data-bind="{
                        click: () => { clickcustom('view') },
                        css: {
                            disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(),
                            hasshadow: $root[$root.idPlantilla()].permitirsombrabotones(),
                            'btn-block': $root[p().id()].ancho() === 'completo'
                        }
                    }">
                        <span class="pretext" data-bind="{
                            style: {
                                'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                            }
                        }"></span>
                        <i class="fas fa-play" data-bind="{
                            style: {
                                'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                            },
                            attr: {
                                hidden: !$root[p().id()].vericonoagregar()
                            }
                        }"></i>
                        <span class="posttext" data-bind="{
                            style: {
                                'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                            }
                        }"></span>
                    </div>
                    <br />
                    <span class="externtext text-bold" data-bind="{
                        style: {
                            'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                        }
                    }"></span>
                </div>
                <div data-bind="{
                    designbuttonall: {
                        t: 'Reemplazar',
                        ty: $root[p().id()].tipo(),
                        c: $root[p().id()].colortextoreemplazar(),
                        bg: $root[p().id()].colorreemplazar()
                    },
                    attr: {
                        hidden: !($root[p().id()].anexo() && $root[p().id()].anexo().docid > 0)
                    },
                    style: {
                        display: $root[p().id()].ancho() === 'completo' ? 'block' : 'inline-block'
                    }
                }">
                    <div class="btn" data-bind="{
                        click: () => { clickcustom('replace') },
                        css: {
                            disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(),
                            hasshadow: $root[$root.idPlantilla()].permitirsombrabotones(),
                            'btn-block': $root[p().id()].ancho() === 'completo'
                        }
                    }">
                        <span class="pretext" data-bind="{
                            style: {
                                'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                            }
                        }"></span>
                        <i class="fas fa-undo" data-bind="{
                            style: { 'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem' },
                            attr: { hidden: !$root[p().id()].vericonoagregar() }
                        }"></i>
                        <span class="posttext" data-bind="{
                            style: {
                                'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                            }
                        }"></span>
                    </div>
                    <br />
                    <span class="externtext text-bold" data-bind="{
                        style: {
                            'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                        }
                    }"></span>
                </div>
                <div data-bind="{
                    designbuttonall: {
                        t: 'Cancelar Reemplazo',
                        ty: $root[p().id()].tipo(),
                        c: $root[p().id()].colortextoborrar(),
                        bg: $root[p().id()].colorborrar()
                    },
                    attr: {
                        hidden: _.isEmpty($root[p().id()].anteriornombrearchivo())
                    },
                    style: {
                        display: $root[p().id()].ancho() === 'completo' ? 'block' : 'inline-block'
                    }
                }">
                    <div class="btn" data-bind="{
                        click: () => { clickcustom('cancelreplace') },
                        css: {
                            disabled: $root.isQuery() ? true : !$root[p().id()].habilitado(),
                            hasshadow: $root[$root.idPlantilla()].permitirsombrabotones(),
                            'btn-block': $root[p().id()].ancho() === 'completo'
                        }
                    }">
                        <span class="pretext" data-bind="{
                            style: {
                                'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                            }
                        }"></span>
                        <i class="fas fa-times-circle" data-bind="{
                            style: {
                                'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                            },
                            attr: {
                                hidden: !$root[p().id()].vericonoagregar()
                            }
                        }"></i>
                        <span class="posttext" data-bind="{
                            style: {
                                'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                            }
                        }"></span>
                    </div>
                    <br />
                    <span class="externtext text-bold" data-bind="{
                        style: {
                            'font-size': ($root[$root.idPlantilla()].tamanofuente() / 10) + 'rem'
                        }
                    }"></span>
                </div>
                <div class="p-1 text-center" data-bind="{
                    attr: {
                        hidden: $root.isEditor() ? true : $root[p().id()].anexo() && $root[p().id()].anexo().docid === 0 ? !$root[p().id()].permisotipificar() : true
                    }
                }">
                    <strong class="pr-1">Tipo de documento:</strong>
                    <br />
                    <div data-bind="tipodoccombo:p().id()"></div>
                </div>
            </div>`;
        }
    };
})(jQuery);